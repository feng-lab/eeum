function require(x) { throw new Error('Cannot require ' + x) }
(()=>{var AN=Object.create;var Pu=Object.defineProperty;var IT=Object.getOwnPropertyDescriptor;var MN=Object.getOwnPropertyNames;var RN=Object.getPrototypeOf,_N=Object.prototype.hasOwnProperty;var AT=n=>Pu(n,"__esModule",{value:!0});var Ht=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),jl=(n,e)=>{AT(n);for(var t in e)Pu(n,t,{get:e[t],enumerable:!0})},VN=(n,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of MN(e))!_N.call(n,r)&&r!=="default"&&Pu(n,r,{get:()=>e[r],enumerable:!(t=IT(e,r))||t.enumerable});return n},rt=n=>VN(AT(Pu(n!=null?AN(RN(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),xt=(n,e,t,r)=>{for(var i=r>1?void 0:r?IT(e,t):e,a=n.length-1,o;a>=0;a--)(o=n[a])&&(i=(r?o(e,t,i):o(i))||i);return r&&i&&Pu(e,t,i),i};var df=Ht(($j,UT)=>{function ON(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}UT.exports=ON});var GT=Ht((jj,WT)=>{var NN=typeof window=="object"&&window&&window.Object===Object&&window;WT.exports=NN});var Ay=Ht((Jj,zT)=>{var BN=GT(),FN=typeof self=="object"&&self&&self.Object===Object&&self,UN=BN||FN||Function("return this")();zT.exports=UN});var $T=Ht((qj,HT)=>{var WN=Ay(),GN=function(){return WN.Date.now()};HT.exports=GN});var JT=Ht((Yj,jT)=>{var zN=/\s/;function HN(n){for(var e=n.length;e--&&zN.test(n.charAt(e)););return e}jT.exports=HN});var YT=Ht((Kj,qT)=>{var $N=JT(),jN=/^\s+/;function JN(n){return n&&n.slice(0,$N(n)+1).replace(jN,"")}qT.exports=JN});var My=Ht((Xj,KT)=>{var qN=Ay(),YN=qN.Symbol;KT.exports=YN});var eL=Ht((Qj,ZT)=>{var XT=My(),QT=Object.prototype,KN=QT.hasOwnProperty,XN=QT.toString,Mu=XT?XT.toStringTag:void 0;function QN(n){var e=KN.call(n,Mu),t=n[Mu];try{n[Mu]=void 0;var r=!0}catch(a){}var i=XN.call(n);return r&&(e?n[Mu]=t:delete n[Mu]),i}ZT.exports=QN});var nL=Ht((Zj,tL)=>{var ZN=Object.prototype,eB=ZN.toString;function tB(n){return eB.call(n)}tL.exports=tB});var oL=Ht((e5,aL)=>{var rL=My(),nB=eL(),rB=nL(),iB="[object Null]",aB="[object Undefined]",iL=rL?rL.toStringTag:void 0;function oB(n){return n==null?n===void 0?aB:iB:iL&&iL in Object(n)?nB(n):rB(n)}aL.exports=oB});var lL=Ht((t5,sL)=>{function sB(n){return n!=null&&typeof n=="object"}sL.exports=sB});var uL=Ht((n5,cL)=>{var lB=oL(),cB=lL(),uB="[object Symbol]";function dB(n){return typeof n=="symbol"||cB(n)&&lB(n)==uB}cL.exports=dB});var hL=Ht((r5,fL)=>{var pB=YT(),dL=df(),fB=uL(),pL=0/0,hB=/^[-+]0x[0-9a-f]+$/i,mB=/^0b[01]+$/i,gB=/^0o[0-7]+$/i,yB=parseInt;function vB(n){if(typeof n=="number")return n;if(fB(n))return pL;if(dL(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=dL(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=pB(n);var t=mB.test(n);return t||gB.test(n)?yB(n.slice(2),t?2:8):hB.test(n)?pL:+n}fL.exports=vB});var Dt=Ht((i5,gL)=>{var SB=df(),Ry=$T(),mL=hL(),bB="Expected a function",xB=Math.max,CB=Math.min;function wB(n,e,t){var r,i,a,o,l,c,d=0,p=!1,m=!1,y=!0;if(typeof n!="function")throw new TypeError(bB);e=mL(e)||0,SB(t)&&(p=!!t.leading,m="maxWait"in t,a=m?xB(mL(t.maxWait)||0,e):a,y="trailing"in t?!!t.trailing:y);function v(E){var V=r,O=i;return r=i=void 0,d=E,o=n.apply(O,V),o}function b(E){return d=E,l=setTimeout(L,e),p?v(E):o}function x(E){var V=E-c,O=E-d,B=e-V;return m?CB(B,a-O):B}function C(E){var V=E-c,O=E-d;return c===void 0||V>=e||V<0||m&&O>=a}function L(){var E=Ry();if(C(E))return A(E);l=setTimeout(L,x(E))}function A(E){return l=void 0,y&&r?v(E):(r=i=void 0,o)}function D(){l!==void 0&&clearTimeout(l),d=0,r=c=i=l=void 0}function R(){return l===void 0?o:A(Ry())}function P(){var E=Ry(),V=C(E);if(r=arguments,i=this,c=E,V){if(l===void 0)return b(c);if(m)return clearTimeout(l),l=setTimeout(L,e),v(c)}return l===void 0&&(l=setTimeout(L,e)),o}return P.cancel=D,P.flush=R,P}gL.exports=wB});var Kd=Ht((nue,iA)=>{var $6=Dt(),j6=df(),J6="Expected a function";function q6(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(J6);return j6(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),$6(n,e,{leading:r,maxWait:e,trailing:i})}iA.exports=q6});var is=Ht((nC,rC)=>{(function(n,e){typeof nC=="object"&&typeof rC!="undefined"?rC.exports=e():typeof define=="function"&&define.amd?define(e):(n=n||self,n.CodeMirror=e())})(nC,function(){"use strict";var n=navigator.userAgent,e=navigator.platform,t=/gecko\/\d/i.test(n),r=/MSIE \d/.test(n),i=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(n),a=/Edge\/(\d+)/.exec(n),o=r||i||a,l=o&&(r?document.documentMode||6:+(a||i)[1]),c=!a&&/WebKit\//.test(n),d=c&&/Qt\/\d+\.\d+/.test(n),p=!a&&/Chrome\//.test(n),m=/Opera\//.test(n),y=/Apple Computer/.test(navigator.vendor),v=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(n),b=/PhantomJS/.test(n),x=y&&(/Mobile\/\w+/.test(n)||navigator.maxTouchPoints>2),C=/Android/.test(n),L=x||C||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(n),A=x||/Mac/.test(e),D=/\bCrOS\b/.test(n),R=/win/i.test(e),P=m&&n.match(/Version\/(\d*\.\d*)/);P&&(P=Number(P[1])),P&&P>=15&&(m=!1,c=!0);var E=A&&(d||m&&(P==null||P<12.11)),V=t||o&&l>=9;function O(s){return new RegExp("(^|\\s)"+s+"(?:$|\\s)\\s*")}var B=function(s,u){var h=s.className,f=O(u).exec(h);if(f){var g=h.slice(f.index+f[0].length);s.className=h.slice(0,f.index)+(g?f[1]+g:"")}};function W(s){for(var u=s.childNodes.length;u>0;--u)s.removeChild(s.firstChild);return s}function _(s,u){return W(s).appendChild(u)}function F(s,u,h,f){var g=document.createElement(s);if(h&&(g.className=h),f&&(g.style.cssText=f),typeof u=="string")g.appendChild(document.createTextNode(u));else if(u)for(var S=0;S<u.length;++S)g.appendChild(u[S]);return g}function N(s,u,h,f){var g=F(s,u,h,f);return g.setAttribute("role","presentation"),g}var J;document.createRange?J=function(s,u,h,f){var g=document.createRange();return g.setEnd(f||s,h),g.setStart(s,u),g}:J=function(s,u,h){var f=document.body.createTextRange();try{f.moveToElementText(s.parentNode)}catch(g){return f}return f.collapse(!0),f.moveEnd("character",h),f.moveStart("character",u),f};function re(s,u){if(u.nodeType==3&&(u=u.parentNode),s.contains)return s.contains(u);do if(u.nodeType==11&&(u=u.host),u==s)return!0;while(u=u.parentNode)}function pe(){var s;try{s=document.activeElement}catch(u){s=document.body||null}for(;s&&s.shadowRoot&&s.shadowRoot.activeElement;)s=s.shadowRoot.activeElement;return s}function ye(s,u){var h=s.className;O(u).test(h)||(s.className+=(h?" ":"")+u)}function ce(s,u){for(var h=s.split(" "),f=0;f<h.length;f++)h[f]&&!O(h[f]).test(u)&&(u+=" "+h[f]);return u}var fe=function(s){s.select()};x?fe=function(s){s.selectionStart=0,s.selectionEnd=s.value.length}:o&&(fe=function(s){try{s.select()}catch(u){}});function Le(s){var u=Array.prototype.slice.call(arguments,1);return function(){return s.apply(null,u)}}function Ge(s,u,h){u||(u={});for(var f in s)s.hasOwnProperty(f)&&(h!==!1||!u.hasOwnProperty(f))&&(u[f]=s[f]);return u}function ze(s,u,h,f,g){u==null&&(u=s.search(/[^\s\u00a0]/),u==-1&&(u=s.length));for(var S=f||0,w=g||0;;){var T=s.indexOf("	",S);if(T<0||T>=u)return w+(u-S);w+=T-S,w+=h-w%h,S=T+1}}var tt=function(){this.id=null,this.f=null,this.time=0,this.handler=Le(this.onTimeout,this)};tt.prototype.onTimeout=function(s){s.id=0,s.time<=+new Date?s.f():setTimeout(s.handler,s.time-+new Date)},tt.prototype.set=function(s,u){this.f=u;var h=+new Date+s;(!this.id||h<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,s),this.time=h)};function ge(s,u){for(var h=0;h<s.length;++h)if(s[h]==u)return h;return-1}var Te=50,Fe={toString:function(){return"CodeMirror.Pass"}},He={scroll:!1},Ke={origin:"*mouse"},Pe={origin:"+move"};function at(s,u,h){for(var f=0,g=0;;){var S=s.indexOf("	",f);S==-1&&(S=s.length);var w=S-f;if(S==s.length||g+w>=u)return f+Math.min(w,u-g);if(g+=S-f,g+=h-g%h,f=S+1,g>=u)return f}}var Nn=[""];function zi(s){for(;Nn.length<=s;)Nn.push(Xe(Nn)+" ");return Nn[s]}function Xe(s){return s[s.length-1]}function Sr(s,u){for(var h=[],f=0;f<s.length;f++)h[f]=u(s[f],f);return h}function Hi(s,u,h){for(var f=0,g=h(u);f<s.length&&h(s[f])<=g;)f++;s.splice(f,0,u)}function $i(){}function ji(s,u){var h;return Object.create?h=Object.create(s):($i.prototype=s,h=new $i),u&&Ge(u,h),h}var Ji=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function Zr(s){return/\w/.test(s)||s>"\x80"&&(s.toUpperCase()!=s.toLowerCase()||Ji.test(s))}function yi(s,u){return u?u.source.indexOf("\\w")>-1&&Zr(s)?!0:u.test(s):Zr(s)}function Da(s){for(var u in s)if(s.hasOwnProperty(u)&&s[u])return!1;return!0}var uo=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function bl(s){return s.charCodeAt(0)>=768&&uo.test(s)}function po(s,u,h){for(;(h<0?u>0:u<s.length)&&bl(s.charAt(u));)u+=h;return u}function Cn(s,u,h){for(var f=u>h?-1:1;;){if(u==h)return u;var g=(u+h)/2,S=f<0?Math.ceil(g):Math.floor(g);if(S==u)return s(S)?u:h;s(S)?h=S:u=S+f}}function Jc(s,u,h,f){if(!s)return f(u,h,"ltr",0);for(var g=!1,S=0;S<s.length;++S){var w=s[S];(w.from<h&&w.to>u||u==h&&w.to==u)&&(f(Math.max(w.from,u),Math.min(w.to,h),w.level==1?"rtl":"ltr",S),g=!0)}g||f(u,h,"ltr")}var er=null;function bt(s,u,h){var f;er=null;for(var g=0;g<s.length;++g){var S=s[g];if(S.from<u&&S.to>u)return g;S.to==u&&(S.from!=S.to&&h=="before"?f=g:er=g),S.from==u&&(S.from!=S.to&&h!="before"?f=g:er=g)}return f!=null?f:er}var ds=function(){var s="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",u="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function h(I){return I<=247?s.charAt(I):1424<=I&&I<=1524?"R":1536<=I&&I<=1785?u.charAt(I-1536):1774<=I&&I<=2220?"r":8192<=I&&I<=8203?"w":I==8204?"b":"L"}var f=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,g=/[stwN]/,S=/[LRr]/,w=/[Lb1n]/,T=/[1n]/;function k(I,U,G){this.level=I,this.from=U,this.to=G}return function(I,U){var G=U=="ltr"?"L":"R";if(I.length==0||U=="ltr"&&!f.test(I))return!1;for(var Y=I.length,q=[],Q=0;Q<Y;++Q)q.push(h(I.charCodeAt(Q)));for(var te=0,ue=G;te<Y;++te){var he=q[te];he=="m"?q[te]=ue:ue=he}for(var Se=0,me=G;Se<Y;++Se){var xe=q[Se];xe=="1"&&me=="r"?q[Se]="n":S.test(xe)&&(me=xe,xe=="r"&&(q[Se]="R"))}for(var De=1,ke=q[0];De<Y-1;++De){var qe=q[De];qe=="+"&&ke=="1"&&q[De+1]=="1"?q[De]="1":qe==","&&ke==q[De+1]&&(ke=="1"||ke=="n")&&(q[De]=ke),ke=qe}for(var vt=0;vt<Y;++vt){var un=q[vt];if(un==",")q[vt]="N";else if(un=="%"){var Mt=void 0;for(Mt=vt+1;Mt<Y&&q[Mt]=="%";++Mt);for(var wr=vt&&q[vt-1]=="!"||Mt<Y&&q[Mt]=="1"?"1":"N",ar=vt;ar<Mt;++ar)q[ar]=wr;vt=Mt-1}}for(var jt=0,or=G;jt<Y;++jt){var Sn=q[jt];or=="L"&&Sn=="1"?q[jt]="L":S.test(Sn)&&(or=Sn)}for(var Qt=0;Qt<Y;++Qt)if(g.test(q[Qt])){var Jt=void 0;for(Jt=Qt+1;Jt<Y&&g.test(q[Jt]);++Jt);for(var Nt=(Qt?q[Qt-1]:G)=="L",sr=(Jt<Y?q[Jt]:G)=="L",Hl=Nt==sr?Nt?"L":"R":G,wo=Qt;wo<Jt;++wo)q[wo]=Hl;Qt=Jt-1}for(var kn=[],na,dn=0;dn<Y;)if(w.test(q[dn])){var Dy=dn;for(++dn;dn<Y&&w.test(q[dn]);++dn);kn.push(new k(0,Dy,dn))}else{var Va=dn,Cs=kn.length,ws=U=="rtl"?1:0;for(++dn;dn<Y&&q[dn]!="L";++dn);for(var Fn=Va;Fn<dn;)if(T.test(q[Fn])){Va<Fn&&(kn.splice(Cs,0,new k(1,Va,Fn)),Cs+=ws);var $l=Fn;for(++Fn;Fn<dn&&T.test(q[Fn]);++Fn);kn.splice(Cs,0,new k(2,$l,Fn)),Cs+=ws,Va=Fn}else++Fn;Va<dn&&kn.splice(Cs,0,new k(1,Va,dn))}return U=="ltr"&&(kn[0].level==1&&(na=I.match(/^\s+/))&&(kn[0].from=na[0].length,kn.unshift(new k(0,0,na[0].length))),Xe(kn).level==1&&(na=I.match(/\s+$/))&&(Xe(kn).to-=na[0].length,kn.push(new k(0,Y-na[0].length,Y)))),U=="rtl"?kn.reverse():kn}}();function br(s,u){var h=s.order;return h==null&&(h=s.order=ds(s.text,u)),h}var Pa=[],Ie=function(s,u,h){if(s.addEventListener)s.addEventListener(u,h,!1);else if(s.attachEvent)s.attachEvent("on"+u,h);else{var f=s._handlers||(s._handlers={});f[u]=(f[u]||Pa).concat(h)}};function xl(s,u){return s._handlers&&s._handlers[u]||Pa}function tr(s,u,h){if(s.removeEventListener)s.removeEventListener(u,h,!1);else if(s.detachEvent)s.detachEvent("on"+u,h);else{var f=s._handlers,g=f&&f[u];if(g){var S=ge(g,h);S>-1&&(f[u]=g.slice(0,S).concat(g.slice(S+1)))}}}function Oe(s,u){var h=xl(s,u);if(!!h.length)for(var f=Array.prototype.slice.call(arguments,2),g=0;g<h.length;++g)h[g].apply(null,f)}function $t(s,u,h){return typeof u=="string"&&(u={type:u,preventDefault:function(){this.defaultPrevented=!0}}),Oe(s,h||u.type,s,u),Mr(u)||u.codemirrorIgnore}function Cl(s){var u=s._handlers&&s._handlers.cursorActivity;if(!!u)for(var h=s.curOp.cursorActivityHandlers||(s.curOp.cursorActivityHandlers=[]),f=0;f<u.length;++f)ge(h,u[f])==-1&&h.push(u[f])}function vn(s,u){return xl(s,u).length>0}function qi(s){s.prototype.on=function(u,h){Ie(this,u,h)},s.prototype.off=function(u,h){tr(this,u,h)}}function wn(s){s.preventDefault?s.preventDefault():s.returnValue=!1}function wl(s){s.stopPropagation?s.stopPropagation():s.cancelBubble=!0}function Mr(s){return s.defaultPrevented!=null?s.defaultPrevented:s.returnValue==!1}function ps(s){wn(s),wl(s)}function fo(s){return s.target||s.srcElement}function Ip(s){var u=s.which;return u==null&&(s.button&1?u=1:s.button&2?u=3:s.button&4&&(u=2)),A&&s.ctrlKey&&u==1&&(u=3),u}var qc=function(){if(o&&l<9)return!1;var s=F("div");return"draggable"in s||"dragDrop"in s}(),nr;function Ap(s){if(nr==null){var u=F("span","\u200B");_(s,F("span",[u,document.createTextNode("x")])),s.firstChild.offsetHeight!=0&&(nr=u.offsetWidth<=1&&u.offsetHeight>2&&!(o&&l<8))}var h=nr?F("span","\u200B"):F("span","\xA0",null,"display: inline-block; width: 1px; margin-right: -1px");return h.setAttribute("cm-text",""),h}var Yc;function Yi(s){if(Yc!=null)return Yc;var u=_(s,document.createTextNode("A\u062EA")),h=J(u,0,1).getBoundingClientRect(),f=J(u,1,2).getBoundingClientRect();return W(s),!h||h.left==h.right?!1:Yc=f.right-h.right<3}var Kc=`

b`.split(/\n/).length!=3?function(s){for(var u=0,h=[],f=s.length;u<=f;){var g=s.indexOf(`
`,u);g==-1&&(g=s.length);var S=s.slice(u,s.charAt(g-1)=="\r"?g-1:g),w=S.indexOf("\r");w!=-1?(h.push(S.slice(0,w)),u+=w+1):(h.push(S),u=g+1)}return h}:function(s){return s.split(/\r\n?|\n/)},Mp=window.getSelection?function(s){try{return s.selectionStart!=s.selectionEnd}catch(u){return!1}}:function(s){var u;try{u=s.ownerDocument.selection.createRange()}catch(h){}return!u||u.parentElement()!=s?!1:u.compareEndPoints("StartToEnd",u)!=0},Rp=function(){var s=F("div");return"oncopy"in s?!0:(s.setAttribute("oncopy","return;"),typeof s.oncopy=="function")}(),Xc=null;function ho(s){if(Xc!=null)return Xc;var u=_(s,F("span","x")),h=u.getBoundingClientRect(),f=J(u,0,1).getBoundingClientRect();return Xc=Math.abs(h.left-f.left)>1}var ei={},Rr={};function _p(s,u){arguments.length>2&&(u.dependencies=Array.prototype.slice.call(arguments,2)),ei[s]=u}function Ia(s,u){Rr[s]=u}function Tl(s){if(typeof s=="string"&&Rr.hasOwnProperty(s))s=Rr[s];else if(s&&typeof s.name=="string"&&Rr.hasOwnProperty(s.name)){var u=Rr[s.name];typeof u=="string"&&(u={name:u}),s=ji(u,s),s.name=u.name}else{if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(s))return Tl("application/xml");if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(s))return Tl("application/json")}return typeof s=="string"?{name:s}:s||{name:"null"}}function Ll(s,u){u=Tl(u);var h=ei[u.name];if(!h)return Ll(s,"text/plain");var f=h(s,u);if(vi.hasOwnProperty(u.name)){var g=vi[u.name];for(var S in g)!g.hasOwnProperty(S)||(f.hasOwnProperty(S)&&(f["_"+S]=f[S]),f[S]=g[S])}if(f.name=u.name,u.helperType&&(f.helperType=u.helperType),u.modeProps)for(var w in u.modeProps)f[w]=u.modeProps[w];return f}var vi={};function Si(s,u){var h=vi.hasOwnProperty(s)?vi[s]:vi[s]={};Ge(u,h)}function _r(s,u){if(u===!0)return u;if(s.copyState)return s.copyState(u);var h={};for(var f in u){var g=u[f];g instanceof Array&&(g=g.concat([])),h[f]=g}return h}function Qc(s,u){for(var h;s.innerMode&&(h=s.innerMode(u),!(!h||h.mode==s));)u=h.state,s=h.mode;return h||{mode:s,state:u}}function Zc(s,u,h){return s.startState?s.startState(u,h):!0}var Ot=function(s,u,h){this.pos=this.start=0,this.string=s,this.tabSize=u||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=h};Ot.prototype.eol=function(){return this.pos>=this.string.length},Ot.prototype.sol=function(){return this.pos==this.lineStart},Ot.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Ot.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Ot.prototype.eat=function(s){var u=this.string.charAt(this.pos),h;if(typeof s=="string"?h=u==s:h=u&&(s.test?s.test(u):s(u)),h)return++this.pos,u},Ot.prototype.eatWhile=function(s){for(var u=this.pos;this.eat(s););return this.pos>u},Ot.prototype.eatSpace=function(){for(var s=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>s},Ot.prototype.skipToEnd=function(){this.pos=this.string.length},Ot.prototype.skipTo=function(s){var u=this.string.indexOf(s,this.pos);if(u>-1)return this.pos=u,!0},Ot.prototype.backUp=function(s){this.pos-=s},Ot.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=ze(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?ze(this.string,this.lineStart,this.tabSize):0)},Ot.prototype.indentation=function(){return ze(this.string,null,this.tabSize)-(this.lineStart?ze(this.string,this.lineStart,this.tabSize):0)},Ot.prototype.match=function(s,u,h){if(typeof s=="string"){var f=function(w){return h?w.toLowerCase():w},g=this.string.substr(this.pos,s.length);if(f(g)==f(s))return u!==!1&&(this.pos+=s.length),!0}else{var S=this.string.slice(this.pos).match(s);return S&&S.index>0?null:(S&&u!==!1&&(this.pos+=S[0].length),S)}},Ot.prototype.current=function(){return this.string.slice(this.start,this.pos)},Ot.prototype.hideFirstChars=function(s,u){this.lineStart+=s;try{return u()}finally{this.lineStart-=s}},Ot.prototype.lookAhead=function(s){var u=this.lineOracle;return u&&u.lookAhead(s)},Ot.prototype.baseToken=function(){var s=this.lineOracle;return s&&s.baseToken(this.pos)};function we(s,u){if(u-=s.first,u<0||u>=s.size)throw new Error("There is no line "+(u+s.first)+" in the document.");for(var h=s;!h.lines;)for(var f=0;;++f){var g=h.children[f],S=g.chunkSize();if(u<S){h=g;break}u-=S}return h.lines[u]}function Ki(s,u,h){var f=[],g=u.line;return s.iter(u.line,h.line+1,function(S){var w=S.text;g==h.line&&(w=w.slice(0,h.ch)),g==u.line&&(w=w.slice(u.ch)),f.push(w),++g}),f}function eu(s,u,h){var f=[];return s.iter(u,h,function(g){f.push(g.text)}),f}function xr(s,u){var h=u-s.height;if(h)for(var f=s;f;f=f.parent)f.height+=h}function st(s){if(s.parent==null)return null;for(var u=s.parent,h=ge(u.lines,s),f=u.parent;f;u=f,f=f.parent)for(var g=0;f.children[g]!=u;++g)h+=f.children[g].chunkSize();return h+u.first}function Xi(s,u){var h=s.first;e:do{for(var f=0;f<s.children.length;++f){var g=s.children[f],S=g.height;if(u<S){s=g;continue e}u-=S,h+=g.chunkSize()}return h}while(!s.lines);for(var w=0;w<s.lines.length;++w){var T=s.lines[w],k=T.height;if(u<k)break;u-=k}return h+w}function fs(s,u){return u>=s.first&&u<s.first+s.size}function tu(s,u){return String(s.lineNumberFormatter(u+s.firstLineNumber))}function oe(s,u,h){if(h===void 0&&(h=null),!(this instanceof oe))return new oe(s,u,h);this.line=s,this.ch=u,this.sticky=h}function M(s,u){return s.line-u.line||s.ch-u.ch}function H(s,u){return s.sticky==u.sticky&&M(s,u)==0}function ee(s){return oe(s.line,s.ch)}function se(s,u){return M(s,u)<0?u:s}function Ne(s,u){return M(s,u)<0?s:u}function nt(s,u){return Math.max(s.first,Math.min(u,s.first+s.size-1))}function ve(s,u){if(u.line<s.first)return oe(s.first,0);var h=s.first+s.size-1;return u.line>h?oe(h,we(s,h).text.length):Tn(u,we(s,u.line).text.length)}function Tn(s,u){var h=s.ch;return h==null||h>u?oe(s.line,u):h<0?oe(s.line,0):s}function Vr(s,u){for(var h=[],f=0;f<u.length;f++)h[f]=ve(s,u[f]);return h}var kl=function(s,u){this.state=s,this.lookAhead=u},Qi=function(s,u,h,f){this.state=u,this.doc=s,this.line=h,this.maxLookAhead=f||0,this.baseTokens=null,this.baseTokenPos=1};Qi.prototype.lookAhead=function(s){var u=this.doc.getLine(this.line+s);return u!=null&&s>this.maxLookAhead&&(this.maxLookAhead=s),u},Qi.prototype.baseToken=function(s){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=s;)this.baseTokenPos+=2;var u=this.baseTokens[this.baseTokenPos+1];return{type:u&&u.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-s}},Qi.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},Qi.fromSaved=function(s,u,h){return u instanceof kl?new Qi(s,_r(s.mode,u.state),h,u.lookAhead):new Qi(s,_r(s.mode,u),h)},Qi.prototype.save=function(s){var u=s!==!1?_r(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new kl(u,this.maxLookAhead):u};function Aw(s,u,h,f){var g=[s.state.modeGen],S={};Nw(s,u.text,s.doc.mode,h,function(I,U){return g.push(I,U)},S,f);for(var w=h.state,T=function(I){h.baseTokens=g;var U=s.state.overlays[I],G=1,Y=0;h.state=!0,Nw(s,u.text,U.mode,h,function(q,Q){for(var te=G;Y<q;){var ue=g[G];ue>q&&g.splice(G,1,q,g[G+1],ue),G+=2,Y=Math.min(q,ue)}if(!!Q)if(U.opaque)g.splice(te,G-te,q,"overlay "+Q),G=te+2;else for(;te<G;te+=2){var he=g[te+1];g[te+1]=(he?he+" ":"")+"overlay "+Q}},S),h.state=w,h.baseTokens=null,h.baseTokenPos=1},k=0;k<s.state.overlays.length;++k)T(k);return{styles:g,classes:S.bgClass||S.textClass?S:null}}function Mw(s,u,h){if(!u.styles||u.styles[0]!=s.state.modeGen){var f=nu(s,st(u)),g=u.text.length>s.options.maxHighlightLength&&_r(s.doc.mode,f.state),S=Aw(s,u,f);g&&(f.state=g),u.stateAfter=f.save(!g),u.styles=S.styles,S.classes?u.styleClasses=S.classes:u.styleClasses&&(u.styleClasses=null),h===s.doc.highlightFrontier&&(s.doc.modeFrontier=Math.max(s.doc.modeFrontier,++s.doc.highlightFrontier))}return u.styles}function nu(s,u,h){var f=s.doc,g=s.display;if(!f.mode.startState)return new Qi(f,!0,u);var S=RV(s,u,h),w=S>f.first&&we(f,S-1).stateAfter,T=w?Qi.fromSaved(f,w,S):new Qi(f,Zc(f.mode),S);return f.iter(S,u,function(k){Bg(s,k.text,T);var I=T.line;k.stateAfter=I==u-1||I%5==0||I>=g.viewFrom&&I<g.viewTo?T.save():null,T.nextLine()}),h&&(f.modeFrontier=T.line),T}function Bg(s,u,h,f){var g=s.doc.mode,S=new Ot(u,s.options.tabSize,h);for(S.start=S.pos=f||0,u==""&&Rw(g,h.state);!S.eol();)Fg(g,S,h.state),S.start=S.pos}function Rw(s,u){if(s.blankLine)return s.blankLine(u);if(!!s.innerMode){var h=Qc(s,u);if(h.mode.blankLine)return h.mode.blankLine(h.state)}}function Fg(s,u,h,f){for(var g=0;g<10;g++){f&&(f[0]=Qc(s,h).mode);var S=s.token(u,h);if(u.pos>u.start)return S}throw new Error("Mode "+s.name+" failed to advance stream.")}var _w=function(s,u,h){this.start=s.start,this.end=s.pos,this.string=s.current(),this.type=u||null,this.state=h};function Vw(s,u,h,f){var g=s.doc,S=g.mode,w;u=ve(g,u);var T=we(g,u.line),k=nu(s,u.line,h),I=new Ot(T.text,s.options.tabSize,k),U;for(f&&(U=[]);(f||I.pos<u.ch)&&!I.eol();)I.start=I.pos,w=Fg(S,I,k.state),f&&U.push(new _w(I,w,_r(g.mode,k.state)));return f?U:new _w(I,w,k.state)}function Ow(s,u){if(s)for(;;){var h=s.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!h)break;s=s.slice(0,h.index)+s.slice(h.index+h[0].length);var f=h[1]?"bgClass":"textClass";u[f]==null?u[f]=h[2]:new RegExp("(?:^|\\s)"+h[2]+"(?:$|\\s)").test(u[f])||(u[f]+=" "+h[2])}return s}function Nw(s,u,h,f,g,S,w){var T=h.flattenSpans;T==null&&(T=s.options.flattenSpans);var k=0,I=null,U=new Ot(u,s.options.tabSize,f),G,Y=s.options.addModeClass&&[null];for(u==""&&Ow(Rw(h,f.state),S);!U.eol();){if(U.pos>s.options.maxHighlightLength?(T=!1,w&&Bg(s,u,f,U.pos),U.pos=u.length,G=null):G=Ow(Fg(h,U,f.state,Y),S),Y){var q=Y[0].name;q&&(G="m-"+(G?q+" "+G:q))}if(!T||I!=G){for(;k<U.start;)k=Math.min(U.start,k+5e3),g(k,I);I=G}U.start=U.pos}for(;k<U.pos;){var Q=Math.min(U.pos,k+5e3);g(Q,I),k=Q}}function RV(s,u,h){for(var f,g,S=s.doc,w=h?-1:u-(s.doc.mode.innerMode?1e3:100),T=u;T>w;--T){if(T<=S.first)return S.first;var k=we(S,T-1),I=k.stateAfter;if(I&&(!h||T+(I instanceof kl?I.lookAhead:0)<=S.modeFrontier))return T;var U=ze(k.text,null,s.options.tabSize);(g==null||f>U)&&(g=T-1,f=U)}return g}function _V(s,u){if(s.modeFrontier=Math.min(s.modeFrontier,u),!(s.highlightFrontier<u-10)){for(var h=s.first,f=u-1;f>h;f--){var g=we(s,f).stateAfter;if(g&&(!(g instanceof kl)||f+g.lookAhead<u)){h=f+1;break}}s.highlightFrontier=Math.min(s.highlightFrontier,h)}}var Bw=!1,Aa=!1;function VV(){Bw=!0}function OV(){Aa=!0}function Vp(s,u,h){this.marker=s,this.from=u,this.to=h}function ru(s,u){if(s)for(var h=0;h<s.length;++h){var f=s[h];if(f.marker==u)return f}}function NV(s,u){for(var h,f=0;f<s.length;++f)s[f]!=u&&(h||(h=[])).push(s[f]);return h}function BV(s,u,h){var f=h&&window.WeakSet&&(h.markedSpans||(h.markedSpans=new WeakSet));f&&f.has(s.markedSpans)?s.markedSpans.push(u):(s.markedSpans=s.markedSpans?s.markedSpans.concat([u]):[u],f&&f.add(s.markedSpans)),u.marker.attachLine(s)}function FV(s,u,h){var f;if(s)for(var g=0;g<s.length;++g){var S=s[g],w=S.marker,T=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);if(T||S.from==u&&w.type=="bookmark"&&(!h||!S.marker.insertLeft)){var k=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);(f||(f=[])).push(new Vp(w,S.from,k?null:S.to))}}return f}function UV(s,u,h){var f;if(s)for(var g=0;g<s.length;++g){var S=s[g],w=S.marker,T=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);if(T||S.from==u&&w.type=="bookmark"&&(!h||S.marker.insertLeft)){var k=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);(f||(f=[])).push(new Vp(w,k?null:S.from-u,S.to==null?null:S.to-u))}}return f}function Ug(s,u){if(u.full)return null;var h=fs(s,u.from.line)&&we(s,u.from.line).markedSpans,f=fs(s,u.to.line)&&we(s,u.to.line).markedSpans;if(!h&&!f)return null;var g=u.from.ch,S=u.to.ch,w=M(u.from,u.to)==0,T=FV(h,g,w),k=UV(f,S,w),I=u.text.length==1,U=Xe(u.text).length+(I?g:0);if(T)for(var G=0;G<T.length;++G){var Y=T[G];if(Y.to==null){var q=ru(k,Y.marker);q?I&&(Y.to=q.to==null?null:q.to+U):Y.to=g}}if(k)for(var Q=0;Q<k.length;++Q){var te=k[Q];if(te.to!=null&&(te.to+=U),te.from==null){var ue=ru(T,te.marker);ue||(te.from=U,I&&(T||(T=[])).push(te))}else te.from+=U,I&&(T||(T=[])).push(te)}T&&(T=Fw(T)),k&&k!=T&&(k=Fw(k));var he=[T];if(!I){var Se=u.text.length-2,me;if(Se>0&&T)for(var xe=0;xe<T.length;++xe)T[xe].to==null&&(me||(me=[])).push(new Vp(T[xe].marker,null,null));for(var De=0;De<Se;++De)he.push(me);he.push(k)}return he}function Fw(s){for(var u=0;u<s.length;++u){var h=s[u];h.from!=null&&h.from==h.to&&h.marker.clearWhenEmpty!==!1&&s.splice(u--,1)}return s.length?s:null}function WV(s,u,h){var f=null;if(s.iter(u.line,h.line+1,function(q){if(q.markedSpans)for(var Q=0;Q<q.markedSpans.length;++Q){var te=q.markedSpans[Q].marker;te.readOnly&&(!f||ge(f,te)==-1)&&(f||(f=[])).push(te)}}),!f)return null;for(var g=[{from:u,to:h}],S=0;S<f.length;++S)for(var w=f[S],T=w.find(0),k=0;k<g.length;++k){var I=g[k];if(!(M(I.to,T.from)<0||M(I.from,T.to)>0)){var U=[k,1],G=M(I.from,T.from),Y=M(I.to,T.to);(G<0||!w.inclusiveLeft&&!G)&&U.push({from:I.from,to:T.from}),(Y>0||!w.inclusiveRight&&!Y)&&U.push({from:T.to,to:I.to}),g.splice.apply(g,U),k+=U.length-3}}return g}function Uw(s){var u=s.markedSpans;if(!!u){for(var h=0;h<u.length;++h)u[h].marker.detachLine(s);s.markedSpans=null}}function Ww(s,u){if(!!u){for(var h=0;h<u.length;++h)u[h].marker.attachLine(s);s.markedSpans=u}}function Op(s){return s.inclusiveLeft?-1:0}function Np(s){return s.inclusiveRight?1:0}function Wg(s,u){var h=s.lines.length-u.lines.length;if(h!=0)return h;var f=s.find(),g=u.find(),S=M(f.from,g.from)||Op(s)-Op(u);if(S)return-S;var w=M(f.to,g.to)||Np(s)-Np(u);return w||u.id-s.id}function Gw(s,u){var h=Aa&&s.markedSpans,f;if(h)for(var g=void 0,S=0;S<h.length;++S)g=h[S],g.marker.collapsed&&(u?g.from:g.to)==null&&(!f||Wg(f,g.marker)<0)&&(f=g.marker);return f}function zw(s){return Gw(s,!0)}function Bp(s){return Gw(s,!1)}function GV(s,u){var h=Aa&&s.markedSpans,f;if(h)for(var g=0;g<h.length;++g){var S=h[g];S.marker.collapsed&&(S.from==null||S.from<u)&&(S.to==null||S.to>u)&&(!f||Wg(f,S.marker)<0)&&(f=S.marker)}return f}function Hw(s,u,h,f,g){var S=we(s,u),w=Aa&&S.markedSpans;if(w)for(var T=0;T<w.length;++T){var k=w[T];if(!!k.marker.collapsed){var I=k.marker.find(0),U=M(I.from,h)||Op(k.marker)-Op(g),G=M(I.to,f)||Np(k.marker)-Np(g);if(!(U>=0&&G<=0||U<=0&&G>=0)&&(U<=0&&(k.marker.inclusiveRight&&g.inclusiveLeft?M(I.to,h)>=0:M(I.to,h)>0)||U>=0&&(k.marker.inclusiveRight&&g.inclusiveLeft?M(I.from,f)<=0:M(I.from,f)<0)))return!0}}}function Zi(s){for(var u;u=zw(s);)s=u.find(-1,!0).line;return s}function zV(s){for(var u;u=Bp(s);)s=u.find(1,!0).line;return s}function HV(s){for(var u,h;u=Bp(s);)s=u.find(1,!0).line,(h||(h=[])).push(s);return h}function Gg(s,u){var h=we(s,u),f=Zi(h);return h==f?u:st(f)}function $w(s,u){if(u>s.lastLine())return u;var h=we(s,u),f;if(!mo(s,h))return u;for(;f=Bp(h);)h=f.find(1,!0).line;return st(h)+1}function mo(s,u){var h=Aa&&u.markedSpans;if(h){for(var f=void 0,g=0;g<h.length;++g)if(f=h[g],!!f.marker.collapsed){if(f.from==null)return!0;if(!f.marker.widgetNode&&f.from==0&&f.marker.inclusiveLeft&&zg(s,u,f))return!0}}}function zg(s,u,h){if(h.to==null){var f=h.marker.find(1,!0);return zg(s,f.line,ru(f.line.markedSpans,h.marker))}if(h.marker.inclusiveRight&&h.to==u.text.length)return!0;for(var g=void 0,S=0;S<u.markedSpans.length;++S)if(g=u.markedSpans[S],g.marker.collapsed&&!g.marker.widgetNode&&g.from==h.to&&(g.to==null||g.to!=h.from)&&(g.marker.inclusiveLeft||h.marker.inclusiveRight)&&zg(s,u,g))return!0}function Ma(s){s=Zi(s);for(var u=0,h=s.parent,f=0;f<h.lines.length;++f){var g=h.lines[f];if(g==s)break;u+=g.height}for(var S=h.parent;S;h=S,S=h.parent)for(var w=0;w<S.children.length;++w){var T=S.children[w];if(T==h)break;u+=T.height}return u}function Fp(s){if(s.height==0)return 0;for(var u=s.text.length,h,f=s;h=zw(f);){var g=h.find(0,!0);f=g.from.line,u+=g.from.ch-g.to.ch}for(f=s;h=Bp(f);){var S=h.find(0,!0);u-=f.text.length-S.from.ch,f=S.to.line,u+=f.text.length-S.to.ch}return u}function Hg(s){var u=s.display,h=s.doc;u.maxLine=we(h,h.first),u.maxLineLength=Fp(u.maxLine),u.maxLineChanged=!0,h.iter(function(f){var g=Fp(f);g>u.maxLineLength&&(u.maxLineLength=g,u.maxLine=f)})}var El=function(s,u,h){this.text=s,Ww(this,u),this.height=h?h(this):1};El.prototype.lineNo=function(){return st(this)},qi(El);function $V(s,u,h,f){s.text=u,s.stateAfter&&(s.stateAfter=null),s.styles&&(s.styles=null),s.order!=null&&(s.order=null),Uw(s),Ww(s,h);var g=f?f(s):1;g!=s.height&&xr(s,g)}function jV(s){s.parent=null,Uw(s)}var JV={},qV={};function jw(s,u){if(!s||/^\s*$/.test(s))return null;var h=u.addModeClass?qV:JV;return h[s]||(h[s]=s.replace(/\S+/g,"cm-$&"))}function Jw(s,u){var h=N("span",null,null,c?"padding-right: .1px":null),f={pre:N("pre",[h],"CodeMirror-line"),content:h,col:0,pos:0,cm:s,trailingSpace:!1,splitSpaces:s.getOption("lineWrapping")};u.measure={};for(var g=0;g<=(u.rest?u.rest.length:0);g++){var S=g?u.rest[g-1]:u.line,w=void 0;f.pos=0,f.addToken=KV,Yi(s.display.measure)&&(w=br(S,s.doc.direction))&&(f.addToken=QV(f.addToken,w)),f.map=[];var T=u!=s.display.externalMeasured&&st(S);ZV(S,f,Mw(s,S,T)),S.styleClasses&&(S.styleClasses.bgClass&&(f.bgClass=ce(S.styleClasses.bgClass,f.bgClass||"")),S.styleClasses.textClass&&(f.textClass=ce(S.styleClasses.textClass,f.textClass||""))),f.map.length==0&&f.map.push(0,0,f.content.appendChild(Ap(s.display.measure))),g==0?(u.measure.map=f.map,u.measure.cache={}):((u.measure.maps||(u.measure.maps=[])).push(f.map),(u.measure.caches||(u.measure.caches=[])).push({}))}if(c){var k=f.content.lastChild;(/\bcm-tab\b/.test(k.className)||k.querySelector&&k.querySelector(".cm-tab"))&&(f.content.className="cm-tab-wrap-hack")}return Oe(s,"renderLine",s,u.line,f.pre),f.pre.className&&(f.textClass=ce(f.pre.className,f.textClass||"")),f}function YV(s){var u=F("span","\u2022","cm-invalidchar");return u.title="\\u"+s.charCodeAt(0).toString(16),u.setAttribute("aria-label",u.title),u}function KV(s,u,h,f,g,S,w){if(!!u){var T=s.splitSpaces?XV(u,s.trailingSpace):u,k=s.cm.state.specialChars,I=!1,U;if(!k.test(u))s.col+=u.length,U=document.createTextNode(T),s.map.push(s.pos,s.pos+u.length,U),o&&l<9&&(I=!0),s.pos+=u.length;else{U=document.createDocumentFragment();for(var G=0;;){k.lastIndex=G;var Y=k.exec(u),q=Y?Y.index-G:u.length-G;if(q){var Q=document.createTextNode(T.slice(G,G+q));o&&l<9?U.appendChild(F("span",[Q])):U.appendChild(Q),s.map.push(s.pos,s.pos+q,Q),s.col+=q,s.pos+=q}if(!Y)break;G+=q+1;var te=void 0;if(Y[0]=="	"){var ue=s.cm.options.tabSize,he=ue-s.col%ue;te=U.appendChild(F("span",zi(he),"cm-tab")),te.setAttribute("role","presentation"),te.setAttribute("cm-text","	"),s.col+=he}else Y[0]=="\r"||Y[0]==`
`?(te=U.appendChild(F("span",Y[0]=="\r"?"\u240D":"\u2424","cm-invalidchar")),te.setAttribute("cm-text",Y[0]),s.col+=1):(te=s.cm.options.specialCharPlaceholder(Y[0]),te.setAttribute("cm-text",Y[0]),o&&l<9?U.appendChild(F("span",[te])):U.appendChild(te),s.col+=1);s.map.push(s.pos,s.pos+1,te),s.pos++}}if(s.trailingSpace=T.charCodeAt(u.length-1)==32,h||f||g||I||S||w){var Se=h||"";f&&(Se+=f),g&&(Se+=g);var me=F("span",[U],Se,S);if(w)for(var xe in w)w.hasOwnProperty(xe)&&xe!="style"&&xe!="class"&&me.setAttribute(xe,w[xe]);return s.content.appendChild(me)}s.content.appendChild(U)}}function XV(s,u){if(s.length>1&&!/  /.test(s))return s;for(var h=u,f="",g=0;g<s.length;g++){var S=s.charAt(g);S==" "&&h&&(g==s.length-1||s.charCodeAt(g+1)==32)&&(S="\xA0"),f+=S,h=S==" "}return f}function QV(s,u){return function(h,f,g,S,w,T,k){g=g?g+" cm-force-border":"cm-force-border";for(var I=h.pos,U=I+f.length;;){for(var G=void 0,Y=0;Y<u.length&&(G=u[Y],!(G.to>I&&G.from<=I));Y++);if(G.to>=U)return s(h,f,g,S,w,T,k);s(h,f.slice(0,G.to-I),g,S,null,T,k),S=null,f=f.slice(G.to-I),I=G.to}}}function qw(s,u,h,f){var g=!f&&h.widgetNode;g&&s.map.push(s.pos,s.pos+u,g),!f&&s.cm.display.input.needsContentAttribute&&(g||(g=s.content.appendChild(document.createElement("span"))),g.setAttribute("cm-marker",h.id)),g&&(s.cm.display.input.setUneditable(g),s.content.appendChild(g)),s.pos+=u,s.trailingSpace=!1}function ZV(s,u,h){var f=s.markedSpans,g=s.text,S=0;if(!f){for(var w=1;w<h.length;w+=2)u.addToken(u,g.slice(S,S=h[w]),jw(h[w+1],u.cm.options));return}for(var T=g.length,k=0,I=1,U="",G,Y,q=0,Q,te,ue,he,Se;;){if(q==k){Q=te=ue=Y="",Se=null,he=null,q=Infinity;for(var me=[],xe=void 0,De=0;De<f.length;++De){var ke=f[De],qe=ke.marker;if(qe.type=="bookmark"&&ke.from==k&&qe.widgetNode)me.push(qe);else if(ke.from<=k&&(ke.to==null||ke.to>k||qe.collapsed&&ke.to==k&&ke.from==k)){if(ke.to!=null&&ke.to!=k&&q>ke.to&&(q=ke.to,te=""),qe.className&&(Q+=" "+qe.className),qe.css&&(Y=(Y?Y+";":"")+qe.css),qe.startStyle&&ke.from==k&&(ue+=" "+qe.startStyle),qe.endStyle&&ke.to==q&&(xe||(xe=[])).push(qe.endStyle,ke.to),qe.title&&((Se||(Se={})).title=qe.title),qe.attributes)for(var vt in qe.attributes)(Se||(Se={}))[vt]=qe.attributes[vt];qe.collapsed&&(!he||Wg(he.marker,qe)<0)&&(he=ke)}else ke.from>k&&q>ke.from&&(q=ke.from)}if(xe)for(var un=0;un<xe.length;un+=2)xe[un+1]==q&&(te+=" "+xe[un]);if(!he||he.from==k)for(var Mt=0;Mt<me.length;++Mt)qw(u,0,me[Mt]);if(he&&(he.from||0)==k){if(qw(u,(he.to==null?T+1:he.to)-k,he.marker,he.from==null),he.to==null)return;he.to==k&&(he=!1)}}if(k>=T)break;for(var wr=Math.min(T,q);;){if(U){var ar=k+U.length;if(!he){var jt=ar>wr?U.slice(0,wr-k):U;u.addToken(u,jt,G?G+Q:Q,ue,k+jt.length==q?te:"",Y,Se)}if(ar>=wr){U=U.slice(wr-k),k=wr;break}k=ar,ue=""}U=g.slice(S,S=h[I++]),G=jw(h[I++],u.cm.options)}}}function Yw(s,u,h){this.line=u,this.rest=HV(u),this.size=this.rest?st(Xe(this.rest))-h+1:1,this.node=this.text=null,this.hidden=mo(s,u)}function Up(s,u,h){for(var f=[],g,S=u;S<h;S=g){var w=new Yw(s.doc,we(s.doc,S),S);g=S+w.size,f.push(w)}return f}var Dl=null;function eO(s){Dl?Dl.ops.push(s):s.ownsGroup=Dl={ops:[s],delayedCallbacks:[]}}function tO(s){var u=s.delayedCallbacks,h=0;do{for(;h<u.length;h++)u[h].call(null);for(var f=0;f<s.ops.length;f++){var g=s.ops[f];if(g.cursorActivityHandlers)for(;g.cursorActivityCalled<g.cursorActivityHandlers.length;)g.cursorActivityHandlers[g.cursorActivityCalled++].call(null,g.cm)}}while(h<u.length)}function nO(s,u){var h=s.ownsGroup;if(!!h)try{tO(h)}finally{Dl=null,u(h)}}var iu=null;function sn(s,u){var h=xl(s,u);if(!!h.length){var f=Array.prototype.slice.call(arguments,2),g;Dl?g=Dl.delayedCallbacks:iu?g=iu:(g=iu=[],setTimeout(rO,0));for(var S=function(T){g.push(function(){return h[T].apply(null,f)})},w=0;w<h.length;++w)S(w)}}function rO(){var s=iu;iu=null;for(var u=0;u<s.length;++u)s[u]()}function Kw(s,u,h,f){for(var g=0;g<u.changes.length;g++){var S=u.changes[g];S=="text"?aO(s,u):S=="gutter"?Qw(s,u,h,f):S=="class"?$g(s,u):S=="widget"&&oO(s,u,f)}u.changes=null}function au(s){return s.node==s.text&&(s.node=F("div",null,null,"position: relative"),s.text.parentNode&&s.text.parentNode.replaceChild(s.node,s.text),s.node.appendChild(s.text),o&&l<8&&(s.node.style.zIndex=2)),s.node}function iO(s,u){var h=u.bgClass?u.bgClass+" "+(u.line.bgClass||""):u.line.bgClass;if(h&&(h+=" CodeMirror-linebackground"),u.background)h?u.background.className=h:(u.background.parentNode.removeChild(u.background),u.background=null);else if(h){var f=au(u);u.background=f.insertBefore(F("div",null,h),f.firstChild),s.display.input.setUneditable(u.background)}}function Xw(s,u){var h=s.display.externalMeasured;return h&&h.line==u.line?(s.display.externalMeasured=null,u.measure=h.measure,h.built):Jw(s,u)}function aO(s,u){var h=u.text.className,f=Xw(s,u);u.text==u.node&&(u.node=f.pre),u.text.parentNode.replaceChild(f.pre,u.text),u.text=f.pre,f.bgClass!=u.bgClass||f.textClass!=u.textClass?(u.bgClass=f.bgClass,u.textClass=f.textClass,$g(s,u)):h&&(u.text.className=h)}function $g(s,u){iO(s,u),u.line.wrapClass?au(u).className=u.line.wrapClass:u.node!=u.text&&(u.node.className="");var h=u.textClass?u.textClass+" "+(u.line.textClass||""):u.line.textClass;u.text.className=h||""}function Qw(s,u,h,f){if(u.gutter&&(u.node.removeChild(u.gutter),u.gutter=null),u.gutterBackground&&(u.node.removeChild(u.gutterBackground),u.gutterBackground=null),u.line.gutterClass){var g=au(u);u.gutterBackground=F("div",null,"CodeMirror-gutter-background "+u.line.gutterClass,"left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px; width: "+f.gutterTotalWidth+"px"),s.display.input.setUneditable(u.gutterBackground),g.insertBefore(u.gutterBackground,u.text)}var S=u.line.gutterMarkers;if(s.options.lineNumbers||S){var w=au(u),T=u.gutter=F("div",null,"CodeMirror-gutter-wrapper","left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px");if(T.setAttribute("aria-hidden","true"),s.display.input.setUneditable(T),w.insertBefore(T,u.text),u.line.gutterClass&&(T.className+=" "+u.line.gutterClass),s.options.lineNumbers&&(!S||!S["CodeMirror-linenumbers"])&&(u.lineNumber=T.appendChild(F("div",tu(s.options,h),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+f.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+s.display.lineNumInnerWidth+"px"))),S)for(var k=0;k<s.display.gutterSpecs.length;++k){var I=s.display.gutterSpecs[k].className,U=S.hasOwnProperty(I)&&S[I];U&&T.appendChild(F("div",[U],"CodeMirror-gutter-elt","left: "+f.gutterLeft[I]+"px; width: "+f.gutterWidth[I]+"px"))}}}function oO(s,u,h){u.alignable&&(u.alignable=null);for(var f=O("CodeMirror-linewidget"),g=u.node.firstChild,S=void 0;g;g=S)S=g.nextSibling,f.test(g.className)&&u.node.removeChild(g);Zw(s,u,h)}function sO(s,u,h,f){var g=Xw(s,u);return u.text=u.node=g.pre,g.bgClass&&(u.bgClass=g.bgClass),g.textClass&&(u.textClass=g.textClass),$g(s,u),Qw(s,u,h,f),Zw(s,u,f),u.node}function Zw(s,u,h){if(e0(s,u.line,u,h,!0),u.rest)for(var f=0;f<u.rest.length;f++)e0(s,u.rest[f],u,h,!1)}function e0(s,u,h,f,g){if(!!u.widgets)for(var S=au(h),w=0,T=u.widgets;w<T.length;++w){var k=T[w],I=F("div",[k.node],"CodeMirror-linewidget"+(k.className?" "+k.className:""));k.handleMouseEvents||I.setAttribute("cm-ignore-events","true"),lO(k,I,h,f),s.display.input.setUneditable(I),g&&k.above?S.insertBefore(I,h.gutter||h.text):S.appendChild(I),sn(k,"redraw")}}function lO(s,u,h,f){if(s.noHScroll){(h.alignable||(h.alignable=[])).push(u);var g=f.wrapperWidth;u.style.left=f.fixedPos+"px",s.coverGutter||(g-=f.gutterTotalWidth,u.style.paddingLeft=f.gutterTotalWidth+"px"),u.style.width=g+"px"}s.coverGutter&&(u.style.zIndex=5,u.style.position="relative",s.noHScroll||(u.style.marginLeft=-f.gutterTotalWidth+"px"))}function ou(s){if(s.height!=null)return s.height;var u=s.doc.cm;if(!u)return 0;if(!re(document.body,s.node)){var h="position: relative;";s.coverGutter&&(h+="margin-left: -"+u.display.gutters.offsetWidth+"px;"),s.noHScroll&&(h+="width: "+u.display.wrapper.clientWidth+"px;"),_(u.display.measure,F("div",[s.node],null,h))}return s.height=s.node.parentNode.offsetHeight}function Ra(s,u){for(var h=fo(u);h!=s.wrapper;h=h.parentNode)if(!h||h.nodeType==1&&h.getAttribute("cm-ignore-events")=="true"||h.parentNode==s.sizer&&h!=s.mover)return!0}function Wp(s){return s.lineSpace.offsetTop}function jg(s){return s.mover.offsetHeight-s.lineSpace.offsetHeight}function t0(s){if(s.cachedPaddingH)return s.cachedPaddingH;var u=_(s.measure,F("pre","x","CodeMirror-line-like")),h=window.getComputedStyle?window.getComputedStyle(u):u.currentStyle,f={left:parseInt(h.paddingLeft),right:parseInt(h.paddingRight)};return!isNaN(f.left)&&!isNaN(f.right)&&(s.cachedPaddingH=f),f}function ea(s){return Te-s.display.nativeBarWidth}function hs(s){return s.display.scroller.clientWidth-ea(s)-s.display.barWidth}function Jg(s){return s.display.scroller.clientHeight-ea(s)-s.display.barHeight}function cO(s,u,h){var f=s.options.lineWrapping,g=f&&hs(s);if(!u.measure.heights||f&&u.measure.width!=g){var S=u.measure.heights=[];if(f){u.measure.width=g;for(var w=u.text.firstChild.getClientRects(),T=0;T<w.length-1;T++){var k=w[T],I=w[T+1];Math.abs(k.bottom-I.bottom)>2&&S.push((k.bottom+I.top)/2-h.top)}}S.push(h.bottom-h.top)}}function n0(s,u,h){if(s.line==u)return{map:s.measure.map,cache:s.measure.cache};for(var f=0;f<s.rest.length;f++)if(s.rest[f]==u)return{map:s.measure.maps[f],cache:s.measure.caches[f]};for(var g=0;g<s.rest.length;g++)if(st(s.rest[g])>h)return{map:s.measure.maps[g],cache:s.measure.caches[g],before:!0}}function uO(s,u){u=Zi(u);var h=st(u),f=s.display.externalMeasured=new Yw(s.doc,u,h);f.lineN=h;var g=f.built=Jw(s,f);return f.text=g.pre,_(s.display.lineMeasure,g.pre),f}function r0(s,u,h,f){return ta(s,Pl(s,u),h,f)}function qg(s,u){if(u>=s.display.viewFrom&&u<s.display.viewTo)return s.display.view[ys(s,u)];var h=s.display.externalMeasured;if(h&&u>=h.lineN&&u<h.lineN+h.size)return h}function Pl(s,u){var h=st(u),f=qg(s,h);f&&!f.text?f=null:f&&f.changes&&(Kw(s,f,h,ey(s)),s.curOp.forceUpdate=!0),f||(f=uO(s,u));var g=n0(f,u,h);return{line:u,view:f,rect:null,map:g.map,cache:g.cache,before:g.before,hasHeights:!1}}function ta(s,u,h,f,g){u.before&&(h=-1);var S=h+(f||""),w;return u.cache.hasOwnProperty(S)?w=u.cache[S]:(u.rect||(u.rect=u.view.text.getBoundingClientRect()),u.hasHeights||(cO(s,u.view,u.rect),u.hasHeights=!0),w=pO(s,u,h,f),w.bogus||(u.cache[S]=w)),{left:w.left,right:w.right,top:g?w.rtop:w.top,bottom:g?w.rbottom:w.bottom}}var i0={left:0,right:0,top:0,bottom:0};function a0(s,u,h){for(var f,g,S,w,T,k,I=0;I<s.length;I+=3)if(T=s[I],k=s[I+1],u<T?(g=0,S=1,w="left"):u<k?(g=u-T,S=g+1):(I==s.length-3||u==k&&s[I+3]>u)&&(S=k-T,g=S-1,u>=k&&(w="right")),g!=null){if(f=s[I+2],T==k&&h==(f.insertLeft?"left":"right")&&(w=h),h=="left"&&g==0)for(;I&&s[I-2]==s[I-3]&&s[I-1].insertLeft;)f=s[(I-=3)+2],w="left";if(h=="right"&&g==k-T)for(;I<s.length-3&&s[I+3]==s[I+4]&&!s[I+5].insertLeft;)f=s[(I+=3)+2],w="right";break}return{node:f,start:g,end:S,collapse:w,coverStart:T,coverEnd:k}}function dO(s,u){var h=i0;if(u=="left")for(var f=0;f<s.length&&(h=s[f]).left==h.right;f++);else for(var g=s.length-1;g>=0&&(h=s[g]).left==h.right;g--);return h}function pO(s,u,h,f){var g=a0(u.map,h,f),S=g.node,w=g.start,T=g.end,k=g.collapse,I;if(S.nodeType==3){for(var U=0;U<4;U++){for(;w&&bl(u.line.text.charAt(g.coverStart+w));)--w;for(;g.coverStart+T<g.coverEnd&&bl(u.line.text.charAt(g.coverStart+T));)++T;if(o&&l<9&&w==0&&T==g.coverEnd-g.coverStart?I=S.parentNode.getBoundingClientRect():I=dO(J(S,w,T).getClientRects(),f),I.left||I.right||w==0)break;T=w,w=w-1,k="right"}o&&l<11&&(I=fO(s.display.measure,I))}else{w>0&&(k=f="right");var G;s.options.lineWrapping&&(G=S.getClientRects()).length>1?I=G[f=="right"?G.length-1:0]:I=S.getBoundingClientRect()}if(o&&l<9&&!w&&(!I||!I.left&&!I.right)){var Y=S.parentNode.getClientRects()[0];Y?I={left:Y.left,right:Y.left+Al(s.display),top:Y.top,bottom:Y.bottom}:I=i0}for(var q=I.top-u.rect.top,Q=I.bottom-u.rect.top,te=(q+Q)/2,ue=u.view.measure.heights,he=0;he<ue.length-1&&!(te<ue[he]);he++);var Se=he?ue[he-1]:0,me=ue[he],xe={left:(k=="right"?I.right:I.left)-u.rect.left,right:(k=="left"?I.left:I.right)-u.rect.left,top:Se,bottom:me};return!I.left&&!I.right&&(xe.bogus=!0),s.options.singleCursorHeightPerLine||(xe.rtop=q,xe.rbottom=Q),xe}function fO(s,u){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!ho(s))return u;var h=screen.logicalXDPI/screen.deviceXDPI,f=screen.logicalYDPI/screen.deviceYDPI;return{left:u.left*h,right:u.right*h,top:u.top*f,bottom:u.bottom*f}}function o0(s){if(s.measure&&(s.measure.cache={},s.measure.heights=null,s.rest))for(var u=0;u<s.rest.length;u++)s.measure.caches[u]={}}function s0(s){s.display.externalMeasure=null,W(s.display.lineMeasure);for(var u=0;u<s.display.view.length;u++)o0(s.display.view[u])}function su(s){s0(s),s.display.cachedCharWidth=s.display.cachedTextHeight=s.display.cachedPaddingH=null,s.options.lineWrapping||(s.display.maxLineChanged=!0),s.display.lineNumChars=null}function l0(){return p&&C?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function c0(){return p&&C?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function Yg(s){var u=0;if(s.widgets)for(var h=0;h<s.widgets.length;++h)s.widgets[h].above&&(u+=ou(s.widgets[h]));return u}function Gp(s,u,h,f,g){if(!g){var S=Yg(u);h.top+=S,h.bottom+=S}if(f=="line")return h;f||(f="local");var w=Ma(u);if(f=="local"?w+=Wp(s.display):w-=s.display.viewOffset,f=="page"||f=="window"){var T=s.display.lineSpace.getBoundingClientRect();w+=T.top+(f=="window"?0:c0());var k=T.left+(f=="window"?0:l0());h.left+=k,h.right+=k}return h.top+=w,h.bottom+=w,h}function u0(s,u,h){if(h=="div")return u;var f=u.left,g=u.top;if(h=="page")f-=l0(),g-=c0();else if(h=="local"||!h){var S=s.display.sizer.getBoundingClientRect();f+=S.left,g+=S.top}var w=s.display.lineSpace.getBoundingClientRect();return{left:f-w.left,top:g-w.top}}function Kg(s,u,h,f,g){return f||(f=we(s.doc,u.line)),Gp(s,f,r0(s,f,u.ch,g),h)}function bi(s,u,h,f,g,S){f=f||we(s.doc,u.line),g||(g=Pl(s,f));function w(Q,te){var ue=ta(s,g,Q,te?"right":"left",S);return te?ue.left=ue.right:ue.right=ue.left,Gp(s,f,ue,h)}var T=br(f,s.doc.direction),k=u.ch,I=u.sticky;if(k>=f.text.length?(k=f.text.length,I="before"):k<=0&&(k=0,I="after"),!T)return w(I=="before"?k-1:k,I=="before");function U(Q,te,ue){var he=T[te],Se=he.level==1;return w(ue?Q-1:Q,Se!=ue)}var G=bt(T,k,I),Y=er,q=U(k,G,I=="before");return Y!=null&&(q.other=U(k,Y,I!="before")),q}function d0(s,u){var h=0;u=ve(s.doc,u),s.options.lineWrapping||(h=Al(s.display)*u.ch);var f=we(s.doc,u.line),g=Ma(f)+Wp(s.display);return{left:h,right:h,top:g,bottom:g+f.height}}function Xg(s,u,h,f,g){var S=oe(s,u,h);return S.xRel=g,f&&(S.outside=f),S}function Qg(s,u,h){var f=s.doc;if(h+=s.display.viewOffset,h<0)return Xg(f.first,0,null,-1,-1);var g=Xi(f,h),S=f.first+f.size-1;if(g>S)return Xg(f.first+f.size-1,we(f,S).text.length,null,1,1);u<0&&(u=0);for(var w=we(f,g);;){var T=hO(s,w,g,u,h),k=GV(w,T.ch+(T.xRel>0||T.outside>0?1:0));if(!k)return T;var I=k.find(1);if(I.line==g)return I;w=we(f,g=I.line)}}function p0(s,u,h,f){f-=Yg(u);var g=u.text.length,S=Cn(function(w){return ta(s,h,w-1).bottom<=f},g,0);return g=Cn(function(w){return ta(s,h,w).top>f},S,g),{begin:S,end:g}}function f0(s,u,h,f){h||(h=Pl(s,u));var g=Gp(s,u,ta(s,h,f),"line").top;return p0(s,u,h,g)}function Zg(s,u,h,f){return s.bottom<=h?!1:s.top>h?!0:(f?s.left:s.right)>u}function hO(s,u,h,f,g){g-=Ma(u);var S=Pl(s,u),w=Yg(u),T=0,k=u.text.length,I=!0,U=br(u,s.doc.direction);if(U){var G=(s.options.lineWrapping?gO:mO)(s,u,h,S,U,f,g);I=G.level!=1,T=I?G.from:G.to-1,k=I?G.to:G.from-1}var Y=null,q=null,Q=Cn(function(De){var ke=ta(s,S,De);return ke.top+=w,ke.bottom+=w,Zg(ke,f,g,!1)?(ke.top<=g&&ke.left<=f&&(Y=De,q=ke),!0):!1},T,k),te,ue,he=!1;if(q){var Se=f-q.left<q.right-f,me=Se==I;Q=Y+(me?0:1),ue=me?"after":"before",te=Se?q.left:q.right}else{!I&&(Q==k||Q==T)&&Q++,ue=Q==0?"after":Q==u.text.length?"before":ta(s,S,Q-(I?1:0)).bottom+w<=g==I?"after":"before";var xe=bi(s,oe(h,Q,ue),"line",u,S);te=xe.left,he=g<xe.top?-1:g>=xe.bottom?1:0}return Q=po(u.text,Q,1),Xg(h,Q,ue,he,f-te)}function mO(s,u,h,f,g,S,w){var T=Cn(function(G){var Y=g[G],q=Y.level!=1;return Zg(bi(s,oe(h,q?Y.to:Y.from,q?"before":"after"),"line",u,f),S,w,!0)},0,g.length-1),k=g[T];if(T>0){var I=k.level!=1,U=bi(s,oe(h,I?k.from:k.to,I?"after":"before"),"line",u,f);Zg(U,S,w,!0)&&U.top>w&&(k=g[T-1])}return k}function gO(s,u,h,f,g,S,w){var T=p0(s,u,f,w),k=T.begin,I=T.end;/\s/.test(u.text.charAt(I-1))&&I--;for(var U=null,G=null,Y=0;Y<g.length;Y++){var q=g[Y];if(!(q.from>=I||q.to<=k)){var Q=q.level!=1,te=ta(s,f,Q?Math.min(I,q.to)-1:Math.max(k,q.from)).right,ue=te<S?S-te+1e9:te-S;(!U||G>ue)&&(U=q,G=ue)}}return U||(U=g[g.length-1]),U.from<k&&(U={from:k,to:U.to,level:U.level}),U.to>I&&(U={from:U.from,to:I,level:U.level}),U}var ms;function Il(s){if(s.cachedTextHeight!=null)return s.cachedTextHeight;if(ms==null){ms=F("pre",null,"CodeMirror-line-like");for(var u=0;u<49;++u)ms.appendChild(document.createTextNode("x")),ms.appendChild(F("br"));ms.appendChild(document.createTextNode("x"))}_(s.measure,ms);var h=ms.offsetHeight/50;return h>3&&(s.cachedTextHeight=h),W(s.measure),h||1}function Al(s){if(s.cachedCharWidth!=null)return s.cachedCharWidth;var u=F("span","xxxxxxxxxx"),h=F("pre",[u],"CodeMirror-line-like");_(s.measure,h);var f=u.getBoundingClientRect(),g=(f.right-f.left)/10;return g>2&&(s.cachedCharWidth=g),g||10}function ey(s){for(var u=s.display,h={},f={},g=u.gutters.clientLeft,S=u.gutters.firstChild,w=0;S;S=S.nextSibling,++w){var T=s.display.gutterSpecs[w].className;h[T]=S.offsetLeft+S.clientLeft+g,f[T]=S.clientWidth}return{fixedPos:ty(u),gutterTotalWidth:u.gutters.offsetWidth,gutterLeft:h,gutterWidth:f,wrapperWidth:u.wrapper.clientWidth}}function ty(s){return s.scroller.getBoundingClientRect().left-s.sizer.getBoundingClientRect().left}function h0(s){var u=Il(s.display),h=s.options.lineWrapping,f=h&&Math.max(5,s.display.scroller.clientWidth/Al(s.display)-3);return function(g){if(mo(s.doc,g))return 0;var S=0;if(g.widgets)for(var w=0;w<g.widgets.length;w++)g.widgets[w].height&&(S+=g.widgets[w].height);return h?S+(Math.ceil(g.text.length/f)||1)*u:S+u}}function ny(s){var u=s.doc,h=h0(s);u.iter(function(f){var g=h(f);g!=f.height&&xr(f,g)})}function gs(s,u,h,f){var g=s.display;if(!h&&fo(u).getAttribute("cm-not-content")=="true")return null;var S,w,T=g.lineSpace.getBoundingClientRect();try{S=u.clientX-T.left,w=u.clientY-T.top}catch(G){return null}var k=Qg(s,S,w),I;if(f&&k.xRel>0&&(I=we(s.doc,k.line).text).length==k.ch){var U=ze(I,I.length,s.options.tabSize)-I.length;k=oe(k.line,Math.max(0,Math.round((S-t0(s.display).left)/Al(s.display))-U))}return k}function ys(s,u){if(u>=s.display.viewTo||(u-=s.display.viewFrom,u<0))return null;for(var h=s.display.view,f=0;f<h.length;f++)if(u-=h[f].size,u<0)return f}function rr(s,u,h,f){u==null&&(u=s.doc.first),h==null&&(h=s.doc.first+s.doc.size),f||(f=0);var g=s.display;if(f&&h<g.viewTo&&(g.updateLineNumbers==null||g.updateLineNumbers>u)&&(g.updateLineNumbers=u),s.curOp.viewChanged=!0,u>=g.viewTo)Aa&&Gg(s.doc,u)<g.viewTo&&yo(s);else if(h<=g.viewFrom)Aa&&$w(s.doc,h+f)>g.viewFrom?yo(s):(g.viewFrom+=f,g.viewTo+=f);else if(u<=g.viewFrom&&h>=g.viewTo)yo(s);else if(u<=g.viewFrom){var S=zp(s,h,h+f,1);S?(g.view=g.view.slice(S.index),g.viewFrom=S.lineN,g.viewTo+=f):yo(s)}else if(h>=g.viewTo){var w=zp(s,u,u,-1);w?(g.view=g.view.slice(0,w.index),g.viewTo=w.lineN):yo(s)}else{var T=zp(s,u,u,-1),k=zp(s,h,h+f,1);T&&k?(g.view=g.view.slice(0,T.index).concat(Up(s,T.lineN,k.lineN)).concat(g.view.slice(k.index)),g.viewTo+=f):yo(s)}var I=g.externalMeasured;I&&(h<I.lineN?I.lineN+=f:u<I.lineN+I.size&&(g.externalMeasured=null))}function go(s,u,h){s.curOp.viewChanged=!0;var f=s.display,g=s.display.externalMeasured;if(g&&u>=g.lineN&&u<g.lineN+g.size&&(f.externalMeasured=null),!(u<f.viewFrom||u>=f.viewTo)){var S=f.view[ys(s,u)];if(S.node!=null){var w=S.changes||(S.changes=[]);ge(w,h)==-1&&w.push(h)}}}function yo(s){s.display.viewFrom=s.display.viewTo=s.doc.first,s.display.view=[],s.display.viewOffset=0}function zp(s,u,h,f){var g=ys(s,u),S,w=s.display.view;if(!Aa||h==s.doc.first+s.doc.size)return{index:g,lineN:h};for(var T=s.display.viewFrom,k=0;k<g;k++)T+=w[k].size;if(T!=u){if(f>0){if(g==w.length-1)return null;S=T+w[g].size-u,g++}else S=T-u;u+=S,h+=S}for(;Gg(s.doc,h)!=h;){if(g==(f<0?0:w.length-1))return null;h+=f*w[g-(f<0?1:0)].size,g+=f}return{index:g,lineN:h}}function yO(s,u,h){var f=s.display,g=f.view;g.length==0||u>=f.viewTo||h<=f.viewFrom?(f.view=Up(s,u,h),f.viewFrom=u):(f.viewFrom>u?f.view=Up(s,u,f.viewFrom).concat(f.view):f.viewFrom<u&&(f.view=f.view.slice(ys(s,u))),f.viewFrom=u,f.viewTo<h?f.view=f.view.concat(Up(s,f.viewTo,h)):f.viewTo>h&&(f.view=f.view.slice(0,ys(s,h)))),f.viewTo=h}function m0(s){for(var u=s.display.view,h=0,f=0;f<u.length;f++){var g=u[f];!g.hidden&&(!g.node||g.changes)&&++h}return h}function lu(s){s.display.input.showSelection(s.display.input.prepareSelection())}function g0(s,u){u===void 0&&(u=!0);for(var h=s.doc,f={},g=f.cursors=document.createDocumentFragment(),S=f.selection=document.createDocumentFragment(),w=0;w<h.sel.ranges.length;w++)if(!(!u&&w==h.sel.primIndex)){var T=h.sel.ranges[w];if(!(T.from().line>=s.display.viewTo||T.to().line<s.display.viewFrom)){var k=T.empty();(k||s.options.showCursorWhenSelecting)&&y0(s,T.head,g),k||vO(s,T,S)}}return f}function y0(s,u,h){var f=bi(s,u,"div",null,null,!s.options.singleCursorHeightPerLine),g=h.appendChild(F("div","\xA0","CodeMirror-cursor"));if(g.style.left=f.left+"px",g.style.top=f.top+"px",g.style.height=Math.max(0,f.bottom-f.top)*s.options.cursorHeight+"px",f.other){var S=h.appendChild(F("div","\xA0","CodeMirror-cursor CodeMirror-secondarycursor"));S.style.display="",S.style.left=f.other.left+"px",S.style.top=f.other.top+"px",S.style.height=(f.other.bottom-f.other.top)*.85+"px"}}function Hp(s,u){return s.top-u.top||s.left-u.left}function vO(s,u,h){var f=s.display,g=s.doc,S=document.createDocumentFragment(),w=t0(s.display),T=w.left,k=Math.max(f.sizerWidth,hs(s)-f.sizer.offsetLeft)-w.right,I=g.direction=="ltr";function U(me,xe,De,ke){xe<0&&(xe=0),xe=Math.round(xe),ke=Math.round(ke),S.appendChild(F("div",null,"CodeMirror-selected","position: absolute; left: "+me+`px;
                             top: `+xe+"px; width: "+(De==null?k-me:De)+`px;
                             height: `+(ke-xe)+"px"))}function G(me,xe,De){var ke=we(g,me),qe=ke.text.length,vt,un;function Mt(jt,or){return Kg(s,oe(me,jt),"div",ke,or)}function wr(jt,or,Sn){var Qt=f0(s,ke,null,jt),Jt=or=="ltr"==(Sn=="after")?"left":"right",Nt=Sn=="after"?Qt.begin:Qt.end-(/\s/.test(ke.text.charAt(Qt.end-1))?2:1);return Mt(Nt,Jt)[Jt]}var ar=br(ke,g.direction);return Jc(ar,xe||0,De==null?qe:De,function(jt,or,Sn,Qt){var Jt=Sn=="ltr",Nt=Mt(jt,Jt?"left":"right"),sr=Mt(or-1,Jt?"right":"left"),Hl=xe==null&&jt==0,wo=De==null&&or==qe,kn=Qt==0,na=!ar||Qt==ar.length-1;if(sr.top-Nt.top<=3){var dn=(I?Hl:wo)&&kn,Dy=(I?wo:Hl)&&na,Va=dn?T:(Jt?Nt:sr).left,Cs=Dy?k:(Jt?sr:Nt).right;U(Va,Nt.top,Cs-Va,Nt.bottom)}else{var ws,Fn,$l,Py;Jt?(ws=I&&Hl&&kn?T:Nt.left,Fn=I?k:wr(jt,Sn,"before"),$l=I?T:wr(or,Sn,"after"),Py=I&&wo&&na?k:sr.right):(ws=I?wr(jt,Sn,"before"):T,Fn=!I&&Hl&&kn?k:Nt.right,$l=!I&&wo&&na?T:sr.left,Py=I?wr(or,Sn,"after"):k),U(ws,Nt.top,Fn-ws,Nt.bottom),Nt.bottom<sr.top&&U(T,Nt.bottom,null,sr.top),U($l,sr.top,Py-$l,sr.bottom)}(!vt||Hp(Nt,vt)<0)&&(vt=Nt),Hp(sr,vt)<0&&(vt=sr),(!un||Hp(Nt,un)<0)&&(un=Nt),Hp(sr,un)<0&&(un=sr)}),{start:vt,end:un}}var Y=u.from(),q=u.to();if(Y.line==q.line)G(Y.line,Y.ch,q.ch);else{var Q=we(g,Y.line),te=we(g,q.line),ue=Zi(Q)==Zi(te),he=G(Y.line,Y.ch,ue?Q.text.length+1:null).end,Se=G(q.line,ue?0:null,q.ch).start;ue&&(he.top<Se.top-2?(U(he.right,he.top,null,he.bottom),U(T,Se.top,Se.left,Se.bottom)):U(he.right,he.top,Se.left-he.right,he.bottom)),he.bottom<Se.top&&U(T,he.bottom,null,Se.top)}h.appendChild(S)}function ry(s){if(!!s.state.focused){var u=s.display;clearInterval(u.blinker);var h=!0;u.cursorDiv.style.visibility="",s.options.cursorBlinkRate>0?u.blinker=setInterval(function(){s.hasFocus()||Ml(s),u.cursorDiv.style.visibility=(h=!h)?"":"hidden"},s.options.cursorBlinkRate):s.options.cursorBlinkRate<0&&(u.cursorDiv.style.visibility="hidden")}}function v0(s){s.hasFocus()||(s.display.input.focus(),s.state.focused||ay(s))}function iy(s){s.state.delayingBlurEvent=!0,setTimeout(function(){s.state.delayingBlurEvent&&(s.state.delayingBlurEvent=!1,s.state.focused&&Ml(s))},100)}function ay(s,u){s.state.delayingBlurEvent&&!s.state.draggingText&&(s.state.delayingBlurEvent=!1),s.options.readOnly!="nocursor"&&(s.state.focused||(Oe(s,"focus",s,u),s.state.focused=!0,ye(s.display.wrapper,"CodeMirror-focused"),!s.curOp&&s.display.selForContextMenu!=s.doc.sel&&(s.display.input.reset(),c&&setTimeout(function(){return s.display.input.reset(!0)},20)),s.display.input.receivedFocus()),ry(s))}function Ml(s,u){s.state.delayingBlurEvent||(s.state.focused&&(Oe(s,"blur",s,u),s.state.focused=!1,B(s.display.wrapper,"CodeMirror-focused")),clearInterval(s.display.blinker),setTimeout(function(){s.state.focused||(s.display.shift=!1)},150))}function $p(s){for(var u=s.display,h=u.lineDiv.offsetTop,f=0;f<u.view.length;f++){var g=u.view[f],S=s.options.lineWrapping,w=void 0,T=0;if(!g.hidden){if(o&&l<8){var k=g.node.offsetTop+g.node.offsetHeight;w=k-h,h=k}else{var I=g.node.getBoundingClientRect();w=I.bottom-I.top,!S&&g.text.firstChild&&(T=g.text.firstChild.getBoundingClientRect().right-I.left-1)}var U=g.line.height-w;if((U>.005||U<-.005)&&(xr(g.line,w),S0(g.line),g.rest))for(var G=0;G<g.rest.length;G++)S0(g.rest[G]);if(T>s.display.sizerWidth){var Y=Math.ceil(T/Al(s.display));Y>s.display.maxLineLength&&(s.display.maxLineLength=Y,s.display.maxLine=g.line,s.display.maxLineChanged=!0)}}}}function S0(s){if(s.widgets)for(var u=0;u<s.widgets.length;++u){var h=s.widgets[u],f=h.node.parentNode;f&&(h.height=f.offsetHeight)}}function jp(s,u,h){var f=h&&h.top!=null?Math.max(0,h.top):s.scroller.scrollTop;f=Math.floor(f-Wp(s));var g=h&&h.bottom!=null?h.bottom:f+s.wrapper.clientHeight,S=Xi(u,f),w=Xi(u,g);if(h&&h.ensure){var T=h.ensure.from.line,k=h.ensure.to.line;T<S?(S=T,w=Xi(u,Ma(we(u,T))+s.wrapper.clientHeight)):Math.min(k,u.lastLine())>=w&&(S=Xi(u,Ma(we(u,k))-s.wrapper.clientHeight),w=k)}return{from:S,to:Math.max(w,S+1)}}function SO(s,u){if(!$t(s,"scrollCursorIntoView")){var h=s.display,f=h.sizer.getBoundingClientRect(),g=null;if(u.top+f.top<0?g=!0:u.bottom+f.top>(window.innerHeight||document.documentElement.clientHeight)&&(g=!1),g!=null&&!b){var S=F("div","\u200B",null,`position: absolute;
                         top: `+(u.top-h.viewOffset-Wp(s.display))+`px;
                         height: `+(u.bottom-u.top+ea(s)+h.barHeight)+`px;
                         left: `+u.left+"px; width: "+Math.max(2,u.right-u.left)+"px;");s.display.lineSpace.appendChild(S),S.scrollIntoView(g),s.display.lineSpace.removeChild(S)}}}function bO(s,u,h,f){f==null&&(f=0);var g;!s.options.lineWrapping&&u==h&&(h=u.sticky=="before"?oe(u.line,u.ch+1,"before"):u,u=u.ch?oe(u.line,u.sticky=="before"?u.ch-1:u.ch,"after"):u);for(var S=0;S<5;S++){var w=!1,T=bi(s,u),k=!h||h==u?T:bi(s,h);g={left:Math.min(T.left,k.left),top:Math.min(T.top,k.top)-f,right:Math.max(T.left,k.left),bottom:Math.max(T.bottom,k.bottom)+f};var I=oy(s,g),U=s.doc.scrollTop,G=s.doc.scrollLeft;if(I.scrollTop!=null&&(uu(s,I.scrollTop),Math.abs(s.doc.scrollTop-U)>1&&(w=!0)),I.scrollLeft!=null&&(vs(s,I.scrollLeft),Math.abs(s.doc.scrollLeft-G)>1&&(w=!0)),!w)break}return g}function xO(s,u){var h=oy(s,u);h.scrollTop!=null&&uu(s,h.scrollTop),h.scrollLeft!=null&&vs(s,h.scrollLeft)}function oy(s,u){var h=s.display,f=Il(s.display);u.top<0&&(u.top=0);var g=s.curOp&&s.curOp.scrollTop!=null?s.curOp.scrollTop:h.scroller.scrollTop,S=Jg(s),w={};u.bottom-u.top>S&&(u.bottom=u.top+S);var T=s.doc.height+jg(h),k=u.top<f,I=u.bottom>T-f;if(u.top<g)w.scrollTop=k?0:u.top;else if(u.bottom>g+S){var U=Math.min(u.top,(I?T:u.bottom)-S);U!=g&&(w.scrollTop=U)}var G=s.options.fixedGutter?0:h.gutters.offsetWidth,Y=s.curOp&&s.curOp.scrollLeft!=null?s.curOp.scrollLeft:h.scroller.scrollLeft-G,q=hs(s)-h.gutters.offsetWidth,Q=u.right-u.left>q;return Q&&(u.right=u.left+q),u.left<10?w.scrollLeft=0:u.left<Y?w.scrollLeft=Math.max(0,u.left+G-(Q?0:10)):u.right>q+Y-3&&(w.scrollLeft=u.right+(Q?0:10)-q),w}function sy(s,u){u!=null&&(Jp(s),s.curOp.scrollTop=(s.curOp.scrollTop==null?s.doc.scrollTop:s.curOp.scrollTop)+u)}function Rl(s){Jp(s);var u=s.getCursor();s.curOp.scrollToPos={from:u,to:u,margin:s.options.cursorScrollMargin}}function cu(s,u,h){(u!=null||h!=null)&&Jp(s),u!=null&&(s.curOp.scrollLeft=u),h!=null&&(s.curOp.scrollTop=h)}function CO(s,u){Jp(s),s.curOp.scrollToPos=u}function Jp(s){var u=s.curOp.scrollToPos;if(u){s.curOp.scrollToPos=null;var h=d0(s,u.from),f=d0(s,u.to);b0(s,h,f,u.margin)}}function b0(s,u,h,f){var g=oy(s,{left:Math.min(u.left,h.left),top:Math.min(u.top,h.top)-f,right:Math.max(u.right,h.right),bottom:Math.max(u.bottom,h.bottom)+f});cu(s,g.scrollLeft,g.scrollTop)}function uu(s,u){Math.abs(s.doc.scrollTop-u)<2||(t||cy(s,{top:u}),x0(s,u,!0),t&&cy(s),fu(s,100))}function x0(s,u,h){u=Math.max(0,Math.min(s.display.scroller.scrollHeight-s.display.scroller.clientHeight,u)),!(s.display.scroller.scrollTop==u&&!h)&&(s.doc.scrollTop=u,s.display.scrollbars.setScrollTop(u),s.display.scroller.scrollTop!=u&&(s.display.scroller.scrollTop=u))}function vs(s,u,h,f){u=Math.max(0,Math.min(u,s.display.scroller.scrollWidth-s.display.scroller.clientWidth)),!((h?u==s.doc.scrollLeft:Math.abs(s.doc.scrollLeft-u)<2)&&!f)&&(s.doc.scrollLeft=u,k0(s),s.display.scroller.scrollLeft!=u&&(s.display.scroller.scrollLeft=u),s.display.scrollbars.setScrollLeft(u))}function du(s){var u=s.display,h=u.gutters.offsetWidth,f=Math.round(s.doc.height+jg(s.display));return{clientHeight:u.scroller.clientHeight,viewHeight:u.wrapper.clientHeight,scrollWidth:u.scroller.scrollWidth,clientWidth:u.scroller.clientWidth,viewWidth:u.wrapper.clientWidth,barLeft:s.options.fixedGutter?h:0,docHeight:f,scrollHeight:f+ea(s)+u.barHeight,nativeBarWidth:u.nativeBarWidth,gutterWidth:h}}var Ss=function(s,u,h){this.cm=h;var f=this.vert=F("div",[F("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),g=this.horiz=F("div",[F("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");f.tabIndex=g.tabIndex=-1,s(f),s(g),Ie(f,"scroll",function(){f.clientHeight&&u(f.scrollTop,"vertical")}),Ie(g,"scroll",function(){g.clientWidth&&u(g.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,o&&l<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Ss.prototype.update=function(s){var u=s.scrollWidth>s.clientWidth+1,h=s.scrollHeight>s.clientHeight+1,f=s.nativeBarWidth;if(h){this.vert.style.display="block",this.vert.style.bottom=u?f+"px":"0";var g=s.viewHeight-(u?f:0);this.vert.firstChild.style.height=Math.max(0,s.scrollHeight-s.clientHeight+g)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(u){this.horiz.style.display="block",this.horiz.style.right=h?f+"px":"0",this.horiz.style.left=s.barLeft+"px";var S=s.viewWidth-s.barLeft-(h?f:0);this.horiz.firstChild.style.width=Math.max(0,s.scrollWidth-s.clientWidth+S)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&s.clientHeight>0&&(f==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:h?f:0,bottom:u?f:0}},Ss.prototype.setScrollLeft=function(s){this.horiz.scrollLeft!=s&&(this.horiz.scrollLeft=s),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Ss.prototype.setScrollTop=function(s){this.vert.scrollTop!=s&&(this.vert.scrollTop=s),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Ss.prototype.zeroWidthHack=function(){var s=A&&!v?"12px":"18px";this.horiz.style.height=this.vert.style.width=s,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new tt,this.disableVert=new tt},Ss.prototype.enableZeroWidthBar=function(s,u,h){s.style.pointerEvents="auto";function f(){var g=s.getBoundingClientRect(),S=h=="vert"?document.elementFromPoint(g.right-1,(g.top+g.bottom)/2):document.elementFromPoint((g.right+g.left)/2,g.bottom-1);S!=s?s.style.pointerEvents="none":u.set(1e3,f)}u.set(1e3,f)},Ss.prototype.clear=function(){var s=this.horiz.parentNode;s.removeChild(this.horiz),s.removeChild(this.vert)};var pu=function(){};pu.prototype.update=function(){return{bottom:0,right:0}},pu.prototype.setScrollLeft=function(){},pu.prototype.setScrollTop=function(){},pu.prototype.clear=function(){};function _l(s,u){u||(u=du(s));var h=s.display.barWidth,f=s.display.barHeight;C0(s,u);for(var g=0;g<4&&h!=s.display.barWidth||f!=s.display.barHeight;g++)h!=s.display.barWidth&&s.options.lineWrapping&&$p(s),C0(s,du(s)),h=s.display.barWidth,f=s.display.barHeight}function C0(s,u){var h=s.display,f=h.scrollbars.update(u);h.sizer.style.paddingRight=(h.barWidth=f.right)+"px",h.sizer.style.paddingBottom=(h.barHeight=f.bottom)+"px",h.heightForcer.style.borderBottom=f.bottom+"px solid transparent",f.right&&f.bottom?(h.scrollbarFiller.style.display="block",h.scrollbarFiller.style.height=f.bottom+"px",h.scrollbarFiller.style.width=f.right+"px"):h.scrollbarFiller.style.display="",f.bottom&&s.options.coverGutterNextToScrollbar&&s.options.fixedGutter?(h.gutterFiller.style.display="block",h.gutterFiller.style.height=f.bottom+"px",h.gutterFiller.style.width=u.gutterWidth+"px"):h.gutterFiller.style.display=""}var w0={native:Ss,null:pu};function T0(s){s.display.scrollbars&&(s.display.scrollbars.clear(),s.display.scrollbars.addClass&&B(s.display.wrapper,s.display.scrollbars.addClass)),s.display.scrollbars=new w0[s.options.scrollbarStyle](function(u){s.display.wrapper.insertBefore(u,s.display.scrollbarFiller),Ie(u,"mousedown",function(){s.state.focused&&setTimeout(function(){return s.display.input.focus()},0)}),u.setAttribute("cm-not-content","true")},function(u,h){h=="horizontal"?vs(s,u):uu(s,u)},s),s.display.scrollbars.addClass&&ye(s.display.wrapper,s.display.scrollbars.addClass)}var wO=0;function bs(s){s.curOp={cm:s,viewChanged:!1,startHeight:s.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++wO,markArrays:null},eO(s.curOp)}function xs(s){var u=s.curOp;u&&nO(u,function(h){for(var f=0;f<h.ops.length;f++)h.ops[f].cm.curOp=null;TO(h)})}function TO(s){for(var u=s.ops,h=0;h<u.length;h++)LO(u[h]);for(var f=0;f<u.length;f++)kO(u[f]);for(var g=0;g<u.length;g++)EO(u[g]);for(var S=0;S<u.length;S++)DO(u[S]);for(var w=0;w<u.length;w++)PO(u[w])}function LO(s){var u=s.cm,h=u.display;AO(u),s.updateMaxLine&&Hg(u),s.mustUpdate=s.viewChanged||s.forceUpdate||s.scrollTop!=null||s.scrollToPos&&(s.scrollToPos.from.line<h.viewFrom||s.scrollToPos.to.line>=h.viewTo)||h.maxLineChanged&&u.options.lineWrapping,s.update=s.mustUpdate&&new qp(u,s.mustUpdate&&{top:s.scrollTop,ensure:s.scrollToPos},s.forceUpdate)}function kO(s){s.updatedDisplay=s.mustUpdate&&ly(s.cm,s.update)}function EO(s){var u=s.cm,h=u.display;s.updatedDisplay&&$p(u),s.barMeasure=du(u),h.maxLineChanged&&!u.options.lineWrapping&&(s.adjustWidthTo=r0(u,h.maxLine,h.maxLine.text.length).left+3,u.display.sizerWidth=s.adjustWidthTo,s.barMeasure.scrollWidth=Math.max(h.scroller.clientWidth,h.sizer.offsetLeft+s.adjustWidthTo+ea(u)+u.display.barWidth),s.maxScrollLeft=Math.max(0,h.sizer.offsetLeft+s.adjustWidthTo-hs(u))),(s.updatedDisplay||s.selectionChanged)&&(s.preparedSelection=h.input.prepareSelection())}function DO(s){var u=s.cm;s.adjustWidthTo!=null&&(u.display.sizer.style.minWidth=s.adjustWidthTo+"px",s.maxScrollLeft<u.doc.scrollLeft&&vs(u,Math.min(u.display.scroller.scrollLeft,s.maxScrollLeft),!0),u.display.maxLineChanged=!1);var h=s.focus&&s.focus==pe();s.preparedSelection&&u.display.input.showSelection(s.preparedSelection,h),(s.updatedDisplay||s.startHeight!=u.doc.height)&&_l(u,s.barMeasure),s.updatedDisplay&&dy(u,s.barMeasure),s.selectionChanged&&ry(u),u.state.focused&&s.updateInput&&u.display.input.reset(s.typing),h&&v0(s.cm)}function PO(s){var u=s.cm,h=u.display,f=u.doc;if(s.updatedDisplay&&L0(u,s.update),h.wheelStartX!=null&&(s.scrollTop!=null||s.scrollLeft!=null||s.scrollToPos)&&(h.wheelStartX=h.wheelStartY=null),s.scrollTop!=null&&x0(u,s.scrollTop,s.forceScroll),s.scrollLeft!=null&&vs(u,s.scrollLeft,!0,!0),s.scrollToPos){var g=bO(u,ve(f,s.scrollToPos.from),ve(f,s.scrollToPos.to),s.scrollToPos.margin);SO(u,g)}var S=s.maybeHiddenMarkers,w=s.maybeUnhiddenMarkers;if(S)for(var T=0;T<S.length;++T)S[T].lines.length||Oe(S[T],"hide");if(w)for(var k=0;k<w.length;++k)w[k].lines.length&&Oe(w[k],"unhide");h.wrapper.offsetHeight&&(f.scrollTop=u.display.scroller.scrollTop),s.changeObjs&&Oe(u,"changes",u,s.changeObjs),s.update&&s.update.finish()}function Cr(s,u){if(s.curOp)return u();bs(s);try{return u()}finally{xs(s)}}function ln(s,u){return function(){if(s.curOp)return u.apply(s,arguments);bs(s);try{return u.apply(s,arguments)}finally{xs(s)}}}function Bn(s){return function(){if(this.curOp)return s.apply(this,arguments);bs(this);try{return s.apply(this,arguments)}finally{xs(this)}}}function cn(s){return function(){var u=this.cm;if(!u||u.curOp)return s.apply(this,arguments);bs(u);try{return s.apply(this,arguments)}finally{xs(u)}}}function fu(s,u){s.doc.highlightFrontier<s.display.viewTo&&s.state.highlight.set(u,Le(IO,s))}function IO(s){var u=s.doc;if(!(u.highlightFrontier>=s.display.viewTo)){var h=+new Date+s.options.workTime,f=nu(s,u.highlightFrontier),g=[];u.iter(f.line,Math.min(u.first+u.size,s.display.viewTo+500),function(S){if(f.line>=s.display.viewFrom){var w=S.styles,T=S.text.length>s.options.maxHighlightLength?_r(u.mode,f.state):null,k=Aw(s,S,f,!0);T&&(f.state=T),S.styles=k.styles;var I=S.styleClasses,U=k.classes;U?S.styleClasses=U:I&&(S.styleClasses=null);for(var G=!w||w.length!=S.styles.length||I!=U&&(!I||!U||I.bgClass!=U.bgClass||I.textClass!=U.textClass),Y=0;!G&&Y<w.length;++Y)G=w[Y]!=S.styles[Y];G&&g.push(f.line),S.stateAfter=f.save(),f.nextLine()}else S.text.length<=s.options.maxHighlightLength&&Bg(s,S.text,f),S.stateAfter=f.line%5==0?f.save():null,f.nextLine();if(+new Date>h)return fu(s,s.options.workDelay),!0}),u.highlightFrontier=f.line,u.modeFrontier=Math.max(u.modeFrontier,f.line),g.length&&Cr(s,function(){for(var S=0;S<g.length;S++)go(s,g[S],"text")})}}var qp=function(s,u,h){var f=s.display;this.viewport=u,this.visible=jp(f,s.doc,u),this.editorIsHidden=!f.wrapper.offsetWidth,this.wrapperHeight=f.wrapper.clientHeight,this.wrapperWidth=f.wrapper.clientWidth,this.oldDisplayWidth=hs(s),this.force=h,this.dims=ey(s),this.events=[]};qp.prototype.signal=function(s,u){vn(s,u)&&this.events.push(arguments)},qp.prototype.finish=function(){for(var s=0;s<this.events.length;s++)Oe.apply(null,this.events[s])};function AO(s){var u=s.display;!u.scrollbarsClipped&&u.scroller.offsetWidth&&(u.nativeBarWidth=u.scroller.offsetWidth-u.scroller.clientWidth,u.heightForcer.style.height=ea(s)+"px",u.sizer.style.marginBottom=-u.nativeBarWidth+"px",u.sizer.style.borderRightWidth=ea(s)+"px",u.scrollbarsClipped=!0)}function MO(s){if(s.hasFocus())return null;var u=pe();if(!u||!re(s.display.lineDiv,u))return null;var h={activeElt:u};if(window.getSelection){var f=window.getSelection();f.anchorNode&&f.extend&&re(s.display.lineDiv,f.anchorNode)&&(h.anchorNode=f.anchorNode,h.anchorOffset=f.anchorOffset,h.focusNode=f.focusNode,h.focusOffset=f.focusOffset)}return h}function RO(s){if(!(!s||!s.activeElt||s.activeElt==pe())&&(s.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(s.activeElt.nodeName)&&s.anchorNode&&re(document.body,s.anchorNode)&&re(document.body,s.focusNode))){var u=window.getSelection(),h=document.createRange();h.setEnd(s.anchorNode,s.anchorOffset),h.collapse(!1),u.removeAllRanges(),u.addRange(h),u.extend(s.focusNode,s.focusOffset)}}function ly(s,u){var h=s.display,f=s.doc;if(u.editorIsHidden)return yo(s),!1;if(!u.force&&u.visible.from>=h.viewFrom&&u.visible.to<=h.viewTo&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo)&&h.renderedView==h.view&&m0(s)==0)return!1;E0(s)&&(yo(s),u.dims=ey(s));var g=f.first+f.size,S=Math.max(u.visible.from-s.options.viewportMargin,f.first),w=Math.min(g,u.visible.to+s.options.viewportMargin);h.viewFrom<S&&S-h.viewFrom<20&&(S=Math.max(f.first,h.viewFrom)),h.viewTo>w&&h.viewTo-w<20&&(w=Math.min(g,h.viewTo)),Aa&&(S=Gg(s.doc,S),w=$w(s.doc,w));var T=S!=h.viewFrom||w!=h.viewTo||h.lastWrapHeight!=u.wrapperHeight||h.lastWrapWidth!=u.wrapperWidth;yO(s,S,w),h.viewOffset=Ma(we(s.doc,h.viewFrom)),s.display.mover.style.top=h.viewOffset+"px";var k=m0(s);if(!T&&k==0&&!u.force&&h.renderedView==h.view&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo))return!1;var I=MO(s);return k>4&&(h.lineDiv.style.display="none"),_O(s,h.updateLineNumbers,u.dims),k>4&&(h.lineDiv.style.display=""),h.renderedView=h.view,RO(I),W(h.cursorDiv),W(h.selectionDiv),h.gutters.style.height=h.sizer.style.minHeight=0,T&&(h.lastWrapHeight=u.wrapperHeight,h.lastWrapWidth=u.wrapperWidth,fu(s,400)),h.updateLineNumbers=null,!0}function L0(s,u){for(var h=u.viewport,f=!0;;f=!1){if(!f||!s.options.lineWrapping||u.oldDisplayWidth==hs(s)){if(h&&h.top!=null&&(h={top:Math.min(s.doc.height+jg(s.display)-Jg(s),h.top)}),u.visible=jp(s.display,s.doc,h),u.visible.from>=s.display.viewFrom&&u.visible.to<=s.display.viewTo)break}else f&&(u.visible=jp(s.display,s.doc,h));if(!ly(s,u))break;$p(s);var g=du(s);lu(s),_l(s,g),dy(s,g),u.force=!1}u.signal(s,"update",s),(s.display.viewFrom!=s.display.reportedViewFrom||s.display.viewTo!=s.display.reportedViewTo)&&(u.signal(s,"viewportChange",s,s.display.viewFrom,s.display.viewTo),s.display.reportedViewFrom=s.display.viewFrom,s.display.reportedViewTo=s.display.viewTo)}function cy(s,u){var h=new qp(s,u);if(ly(s,h)){$p(s),L0(s,h);var f=du(s);lu(s),_l(s,f),dy(s,f),h.finish()}}function _O(s,u,h){var f=s.display,g=s.options.lineNumbers,S=f.lineDiv,w=S.firstChild;function T(Q){var te=Q.nextSibling;return c&&A&&s.display.currentWheelTarget==Q?Q.style.display="none":Q.parentNode.removeChild(Q),te}for(var k=f.view,I=f.viewFrom,U=0;U<k.length;U++){var G=k[U];if(!G.hidden)if(!G.node||G.node.parentNode!=S){var Y=sO(s,G,I,h);S.insertBefore(Y,w)}else{for(;w!=G.node;)w=T(w);var q=g&&u!=null&&u<=I&&G.lineNumber;G.changes&&(ge(G.changes,"gutter")>-1&&(q=!1),Kw(s,G,I,h)),q&&(W(G.lineNumber),G.lineNumber.appendChild(document.createTextNode(tu(s.options,I)))),w=G.node.nextSibling}I+=G.size}for(;w;)w=T(w)}function uy(s){var u=s.gutters.offsetWidth;s.sizer.style.marginLeft=u+"px",sn(s,"gutterChanged",s)}function dy(s,u){s.display.sizer.style.minHeight=u.docHeight+"px",s.display.heightForcer.style.top=u.docHeight+"px",s.display.gutters.style.height=u.docHeight+s.display.barHeight+ea(s)+"px"}function k0(s){var u=s.display,h=u.view;if(!(!u.alignWidgets&&(!u.gutters.firstChild||!s.options.fixedGutter))){for(var f=ty(u)-u.scroller.scrollLeft+s.doc.scrollLeft,g=u.gutters.offsetWidth,S=f+"px",w=0;w<h.length;w++)if(!h[w].hidden){s.options.fixedGutter&&(h[w].gutter&&(h[w].gutter.style.left=S),h[w].gutterBackground&&(h[w].gutterBackground.style.left=S));var T=h[w].alignable;if(T)for(var k=0;k<T.length;k++)T[k].style.left=S}s.options.fixedGutter&&(u.gutters.style.left=f+g+"px")}}function E0(s){if(!s.options.lineNumbers)return!1;var u=s.doc,h=tu(s.options,u.first+u.size-1),f=s.display;if(h.length!=f.lineNumChars){var g=f.measure.appendChild(F("div",[F("div",h)],"CodeMirror-linenumber CodeMirror-gutter-elt")),S=g.firstChild.offsetWidth,w=g.offsetWidth-S;return f.lineGutter.style.width="",f.lineNumInnerWidth=Math.max(S,f.lineGutter.offsetWidth-w)+1,f.lineNumWidth=f.lineNumInnerWidth+w,f.lineNumChars=f.lineNumInnerWidth?h.length:-1,f.lineGutter.style.width=f.lineNumWidth+"px",uy(s.display),!0}return!1}function py(s,u){for(var h=[],f=!1,g=0;g<s.length;g++){var S=s[g],w=null;if(typeof S!="string"&&(w=S.style,S=S.className),S=="CodeMirror-linenumbers")if(u)f=!0;else continue;h.push({className:S,style:w})}return u&&!f&&h.push({className:"CodeMirror-linenumbers",style:null}),h}function D0(s){var u=s.gutters,h=s.gutterSpecs;W(u),s.lineGutter=null;for(var f=0;f<h.length;++f){var g=h[f],S=g.className,w=g.style,T=u.appendChild(F("div",null,"CodeMirror-gutter "+S));w&&(T.style.cssText=w),S=="CodeMirror-linenumbers"&&(s.lineGutter=T,T.style.width=(s.lineNumWidth||1)+"px")}u.style.display=h.length?"":"none",uy(s)}function hu(s){D0(s.display),rr(s),k0(s)}function VO(s,u,h,f){var g=this;this.input=h,g.scrollbarFiller=F("div",null,"CodeMirror-scrollbar-filler"),g.scrollbarFiller.setAttribute("cm-not-content","true"),g.gutterFiller=F("div",null,"CodeMirror-gutter-filler"),g.gutterFiller.setAttribute("cm-not-content","true"),g.lineDiv=N("div",null,"CodeMirror-code"),g.selectionDiv=F("div",null,null,"position: relative; z-index: 1"),g.cursorDiv=F("div",null,"CodeMirror-cursors"),g.measure=F("div",null,"CodeMirror-measure"),g.lineMeasure=F("div",null,"CodeMirror-measure"),g.lineSpace=N("div",[g.measure,g.lineMeasure,g.selectionDiv,g.cursorDiv,g.lineDiv],null,"position: relative; outline: none");var S=N("div",[g.lineSpace],"CodeMirror-lines");g.mover=F("div",[S],null,"position: relative"),g.sizer=F("div",[g.mover],"CodeMirror-sizer"),g.sizerWidth=null,g.heightForcer=F("div",null,null,"position: absolute; height: "+Te+"px; width: 1px;"),g.gutters=F("div",null,"CodeMirror-gutters"),g.lineGutter=null,g.scroller=F("div",[g.sizer,g.heightForcer,g.gutters],"CodeMirror-scroll"),g.scroller.setAttribute("tabIndex","-1"),g.wrapper=F("div",[g.scrollbarFiller,g.gutterFiller,g.scroller],"CodeMirror"),o&&l<8&&(g.gutters.style.zIndex=-1,g.scroller.style.paddingRight=0),!c&&!(t&&L)&&(g.scroller.draggable=!0),s&&(s.appendChild?s.appendChild(g.wrapper):s(g.wrapper)),g.viewFrom=g.viewTo=u.first,g.reportedViewFrom=g.reportedViewTo=u.first,g.view=[],g.renderedView=null,g.externalMeasured=null,g.viewOffset=0,g.lastWrapHeight=g.lastWrapWidth=0,g.updateLineNumbers=null,g.nativeBarWidth=g.barHeight=g.barWidth=0,g.scrollbarsClipped=!1,g.lineNumWidth=g.lineNumInnerWidth=g.lineNumChars=null,g.alignWidgets=!1,g.cachedCharWidth=g.cachedTextHeight=g.cachedPaddingH=null,g.maxLine=null,g.maxLineLength=0,g.maxLineChanged=!1,g.wheelDX=g.wheelDY=g.wheelStartX=g.wheelStartY=null,g.shift=!1,g.selForContextMenu=null,g.activeTouch=null,g.gutterSpecs=py(f.gutters,f.lineNumbers),D0(g),h.init(g)}var Yp=0,Or=null;o?Or=-.53:t?Or=15:p?Or=-.7:y&&(Or=-1/3);function P0(s){var u=s.wheelDeltaX,h=s.wheelDeltaY;return u==null&&s.detail&&s.axis==s.HORIZONTAL_AXIS&&(u=s.detail),h==null&&s.detail&&s.axis==s.VERTICAL_AXIS?h=s.detail:h==null&&(h=s.wheelDelta),{x:u,y:h}}function OO(s){var u=P0(s);return u.x*=Or,u.y*=Or,u}function I0(s,u){var h=P0(u),f=h.x,g=h.y,S=s.display,w=S.scroller,T=w.scrollWidth>w.clientWidth,k=w.scrollHeight>w.clientHeight;if(!!(f&&T||g&&k)){if(g&&A&&c){e:for(var I=u.target,U=S.view;I!=w;I=I.parentNode)for(var G=0;G<U.length;G++)if(U[G].node==I){s.display.currentWheelTarget=I;break e}}if(f&&!t&&!m&&Or!=null){g&&k&&uu(s,Math.max(0,w.scrollTop+g*Or)),vs(s,Math.max(0,w.scrollLeft+f*Or)),(!g||g&&k)&&wn(u),S.wheelStartX=null;return}if(g&&Or!=null){var Y=g*Or,q=s.doc.scrollTop,Q=q+S.wrapper.clientHeight;Y<0?q=Math.max(0,q+Y-50):Q=Math.min(s.doc.height,Q+Y+50),cy(s,{top:q,bottom:Q})}Yp<20&&(S.wheelStartX==null?(S.wheelStartX=w.scrollLeft,S.wheelStartY=w.scrollTop,S.wheelDX=f,S.wheelDY=g,setTimeout(function(){if(S.wheelStartX!=null){var te=w.scrollLeft-S.wheelStartX,ue=w.scrollTop-S.wheelStartY,he=ue&&S.wheelDY&&ue/S.wheelDY||te&&S.wheelDX&&te/S.wheelDX;S.wheelStartX=S.wheelStartY=null,!!he&&(Or=(Or*Yp+he)/(Yp+1),++Yp)}},200)):(S.wheelDX+=f,S.wheelDY+=g))}}var Nr=function(s,u){this.ranges=s,this.primIndex=u};Nr.prototype.primary=function(){return this.ranges[this.primIndex]},Nr.prototype.equals=function(s){if(s==this)return!0;if(s.primIndex!=this.primIndex||s.ranges.length!=this.ranges.length)return!1;for(var u=0;u<this.ranges.length;u++){var h=this.ranges[u],f=s.ranges[u];if(!H(h.anchor,f.anchor)||!H(h.head,f.head))return!1}return!0},Nr.prototype.deepCopy=function(){for(var s=[],u=0;u<this.ranges.length;u++)s[u]=new lt(ee(this.ranges[u].anchor),ee(this.ranges[u].head));return new Nr(s,this.primIndex)},Nr.prototype.somethingSelected=function(){for(var s=0;s<this.ranges.length;s++)if(!this.ranges[s].empty())return!0;return!1},Nr.prototype.contains=function(s,u){u||(u=s);for(var h=0;h<this.ranges.length;h++){var f=this.ranges[h];if(M(u,f.from())>=0&&M(s,f.to())<=0)return h}return-1};var lt=function(s,u){this.anchor=s,this.head=u};lt.prototype.from=function(){return Ne(this.anchor,this.head)},lt.prototype.to=function(){return se(this.anchor,this.head)},lt.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function xi(s,u,h){var f=s&&s.options.selectionsMayTouch,g=u[h];u.sort(function(Y,q){return M(Y.from(),q.from())}),h=ge(u,g);for(var S=1;S<u.length;S++){var w=u[S],T=u[S-1],k=M(T.to(),w.from());if(f&&!w.empty()?k>0:k>=0){var I=Ne(T.from(),w.from()),U=se(T.to(),w.to()),G=T.empty()?w.from()==w.head:T.from()==T.head;S<=h&&--h,u.splice(--S,2,new lt(G?U:I,G?I:U))}}return new Nr(u,h)}function vo(s,u){return new Nr([new lt(s,u||s)],0)}function So(s){return s.text?oe(s.from.line+s.text.length-1,Xe(s.text).length+(s.text.length==1?s.from.ch:0)):s.to}function A0(s,u){if(M(s,u.from)<0)return s;if(M(s,u.to)<=0)return So(u);var h=s.line+u.text.length-(u.to.line-u.from.line)-1,f=s.ch;return s.line==u.to.line&&(f+=So(u).ch-u.to.ch),oe(h,f)}function fy(s,u){for(var h=[],f=0;f<s.sel.ranges.length;f++){var g=s.sel.ranges[f];h.push(new lt(A0(g.anchor,u),A0(g.head,u)))}return xi(s.cm,h,s.sel.primIndex)}function M0(s,u,h){return s.line==u.line?oe(h.line,s.ch-u.ch+h.ch):oe(h.line+(s.line-u.line),s.ch)}function NO(s,u,h){for(var f=[],g=oe(s.first,0),S=g,w=0;w<u.length;w++){var T=u[w],k=M0(T.from,g,S),I=M0(So(T),g,S);if(g=T.to,S=I,h=="around"){var U=s.sel.ranges[w],G=M(U.head,U.anchor)<0;f[w]=new lt(G?I:k,G?k:I)}else f[w]=new lt(k,k)}return new Nr(f,s.sel.primIndex)}function hy(s){s.doc.mode=Ll(s.options,s.doc.modeOption),mu(s)}function mu(s){s.doc.iter(function(u){u.stateAfter&&(u.stateAfter=null),u.styles&&(u.styles=null)}),s.doc.modeFrontier=s.doc.highlightFrontier=s.doc.first,fu(s,100),s.state.modeGen++,s.curOp&&rr(s)}function R0(s,u){return u.from.ch==0&&u.to.ch==0&&Xe(u.text)==""&&(!s.cm||s.cm.options.wholeLineUpdateBefore)}function my(s,u,h,f){function g(Se){return h?h[Se]:null}function S(Se,me,xe){$V(Se,me,xe,f),sn(Se,"change",Se,u)}function w(Se,me){for(var xe=[],De=Se;De<me;++De)xe.push(new El(I[De],g(De),f));return xe}var T=u.from,k=u.to,I=u.text,U=we(s,T.line),G=we(s,k.line),Y=Xe(I),q=g(I.length-1),Q=k.line-T.line;if(u.full)s.insert(0,w(0,I.length)),s.remove(I.length,s.size-I.length);else if(R0(s,u)){var te=w(0,I.length-1);S(G,G.text,q),Q&&s.remove(T.line,Q),te.length&&s.insert(T.line,te)}else if(U==G)if(I.length==1)S(U,U.text.slice(0,T.ch)+Y+U.text.slice(k.ch),q);else{var ue=w(1,I.length-1);ue.push(new El(Y+U.text.slice(k.ch),q,f)),S(U,U.text.slice(0,T.ch)+I[0],g(0)),s.insert(T.line+1,ue)}else if(I.length==1)S(U,U.text.slice(0,T.ch)+I[0]+G.text.slice(k.ch),g(0)),s.remove(T.line+1,Q);else{S(U,U.text.slice(0,T.ch)+I[0],g(0)),S(G,Y+G.text.slice(k.ch),q);var he=w(1,I.length-1);Q>1&&s.remove(T.line+1,Q-1),s.insert(T.line+1,he)}sn(s,"change",s,u)}function bo(s,u,h){function f(g,S,w){if(g.linked)for(var T=0;T<g.linked.length;++T){var k=g.linked[T];if(k.doc!=S){var I=w&&k.sharedHist;h&&!I||(u(k.doc,I),f(k.doc,g,I))}}}f(s,null,!0)}function _0(s,u){if(u.cm)throw new Error("This document is already in use.");s.doc=u,u.cm=s,ny(s),hy(s),V0(s),s.options.direction=u.direction,s.options.lineWrapping||Hg(s),s.options.mode=u.modeOption,rr(s)}function V0(s){(s.doc.direction=="rtl"?ye:B)(s.display.lineDiv,"CodeMirror-rtl")}function BO(s){Cr(s,function(){V0(s),rr(s)})}function Kp(s){this.done=[],this.undone=[],this.undoDepth=s?s.undoDepth:Infinity,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=s?s.maxGeneration:1}function gy(s,u){var h={from:ee(u.from),to:So(u),text:Ki(s,u.from,u.to)};return B0(s,h,u.from.line,u.to.line+1),bo(s,function(f){return B0(f,h,u.from.line,u.to.line+1)},!0),h}function O0(s){for(;s.length;){var u=Xe(s);if(u.ranges)s.pop();else break}}function FO(s,u){if(u)return O0(s.done),Xe(s.done);if(s.done.length&&!Xe(s.done).ranges)return Xe(s.done);if(s.done.length>1&&!s.done[s.done.length-2].ranges)return s.done.pop(),Xe(s.done)}function N0(s,u,h,f){var g=s.history;g.undone.length=0;var S=+new Date,w,T;if((g.lastOp==f||g.lastOrigin==u.origin&&u.origin&&(u.origin.charAt(0)=="+"&&g.lastModTime>S-(s.cm?s.cm.options.historyEventDelay:500)||u.origin.charAt(0)=="*"))&&(w=FO(g,g.lastOp==f)))T=Xe(w.changes),M(u.from,u.to)==0&&M(u.from,T.to)==0?T.to=So(u):w.changes.push(gy(s,u));else{var k=Xe(g.done);for((!k||!k.ranges)&&Xp(s.sel,g.done),w={changes:[gy(s,u)],generation:g.generation},g.done.push(w);g.done.length>g.undoDepth;)g.done.shift(),g.done[0].ranges||g.done.shift()}g.done.push(h),g.generation=++g.maxGeneration,g.lastModTime=g.lastSelTime=S,g.lastOp=g.lastSelOp=f,g.lastOrigin=g.lastSelOrigin=u.origin,T||Oe(s,"historyAdded")}function UO(s,u,h,f){var g=u.charAt(0);return g=="*"||g=="+"&&h.ranges.length==f.ranges.length&&h.somethingSelected()==f.somethingSelected()&&new Date-s.history.lastSelTime<=(s.cm?s.cm.options.historyEventDelay:500)}function WO(s,u,h,f){var g=s.history,S=f&&f.origin;h==g.lastSelOp||S&&g.lastSelOrigin==S&&(g.lastModTime==g.lastSelTime&&g.lastOrigin==S||UO(s,S,Xe(g.done),u))?g.done[g.done.length-1]=u:Xp(u,g.done),g.lastSelTime=+new Date,g.lastSelOrigin=S,g.lastSelOp=h,f&&f.clearRedo!==!1&&O0(g.undone)}function Xp(s,u){var h=Xe(u);h&&h.ranges&&h.equals(s)||u.push(s)}function B0(s,u,h,f){var g=u["spans_"+s.id],S=0;s.iter(Math.max(s.first,h),Math.min(s.first+s.size,f),function(w){w.markedSpans&&((g||(g=u["spans_"+s.id]={}))[S]=w.markedSpans),++S})}function GO(s){if(!s)return null;for(var u,h=0;h<s.length;++h)s[h].marker.explicitlyCleared?u||(u=s.slice(0,h)):u&&u.push(s[h]);return u?u.length?u:null:s}function zO(s,u){var h=u["spans_"+s.id];if(!h)return null;for(var f=[],g=0;g<u.text.length;++g)f.push(GO(h[g]));return f}function F0(s,u){var h=zO(s,u),f=Ug(s,u);if(!h)return f;if(!f)return h;for(var g=0;g<h.length;++g){var S=h[g],w=f[g];if(S&&w){e:for(var T=0;T<w.length;++T){for(var k=w[T],I=0;I<S.length;++I)if(S[I].marker==k.marker)continue e;S.push(k)}}else w&&(h[g]=w)}return h}function Vl(s,u,h){for(var f=[],g=0;g<s.length;++g){var S=s[g];if(S.ranges){f.push(h?Nr.prototype.deepCopy.call(S):S);continue}var w=S.changes,T=[];f.push({changes:T});for(var k=0;k<w.length;++k){var I=w[k],U=void 0;if(T.push({from:I.from,to:I.to,text:I.text}),u)for(var G in I)(U=G.match(/^spans_(\d+)$/))&&ge(u,Number(U[1]))>-1&&(Xe(T)[G]=I[G],delete I[G])}}return f}function yy(s,u,h,f){if(f){var g=s.anchor;if(h){var S=M(u,g)<0;S!=M(h,g)<0?(g=u,u=h):S!=M(u,h)<0&&(u=h)}return new lt(g,u)}else return new lt(h||u,u)}function Qp(s,u,h,f,g){g==null&&(g=s.cm&&(s.cm.display.shift||s.extend)),Ln(s,new Nr([yy(s.sel.primary(),u,h,g)],0),f)}function U0(s,u,h){for(var f=[],g=s.cm&&(s.cm.display.shift||s.extend),S=0;S<s.sel.ranges.length;S++)f[S]=yy(s.sel.ranges[S],u[S],null,g);var w=xi(s.cm,f,s.sel.primIndex);Ln(s,w,h)}function vy(s,u,h,f){var g=s.sel.ranges.slice(0);g[u]=h,Ln(s,xi(s.cm,g,s.sel.primIndex),f)}function W0(s,u,h,f){Ln(s,vo(u,h),f)}function HO(s,u,h){var f={ranges:u.ranges,update:function(g){this.ranges=[];for(var S=0;S<g.length;S++)this.ranges[S]=new lt(ve(s,g[S].anchor),ve(s,g[S].head))},origin:h&&h.origin};return Oe(s,"beforeSelectionChange",s,f),s.cm&&Oe(s.cm,"beforeSelectionChange",s.cm,f),f.ranges!=u.ranges?xi(s.cm,f.ranges,f.ranges.length-1):u}function G0(s,u,h){var f=s.history.done,g=Xe(f);g&&g.ranges?(f[f.length-1]=u,Zp(s,u,h)):Ln(s,u,h)}function Ln(s,u,h){Zp(s,u,h),WO(s,s.sel,s.cm?s.cm.curOp.id:NaN,h)}function Zp(s,u,h){(vn(s,"beforeSelectionChange")||s.cm&&vn(s.cm,"beforeSelectionChange"))&&(u=HO(s,u,h));var f=h&&h.bias||(M(u.primary().head,s.sel.primary().head)<0?-1:1);z0(s,$0(s,u,f,!0)),!(h&&h.scroll===!1)&&s.cm&&s.cm.getOption("readOnly")!="nocursor"&&Rl(s.cm)}function z0(s,u){u.equals(s.sel)||(s.sel=u,s.cm&&(s.cm.curOp.updateInput=1,s.cm.curOp.selectionChanged=!0,Cl(s.cm)),sn(s,"cursorActivity",s))}function H0(s){z0(s,$0(s,s.sel,null,!1))}function $0(s,u,h,f){for(var g,S=0;S<u.ranges.length;S++){var w=u.ranges[S],T=u.ranges.length==s.sel.ranges.length&&s.sel.ranges[S],k=ef(s,w.anchor,T&&T.anchor,h,f),I=ef(s,w.head,T&&T.head,h,f);(g||k!=w.anchor||I!=w.head)&&(g||(g=u.ranges.slice(0,S)),g[S]=new lt(k,I))}return g?xi(s.cm,g,u.primIndex):u}function Ol(s,u,h,f,g){var S=we(s,u.line);if(S.markedSpans)for(var w=0;w<S.markedSpans.length;++w){var T=S.markedSpans[w],k=T.marker,I="selectLeft"in k?!k.selectLeft:k.inclusiveLeft,U="selectRight"in k?!k.selectRight:k.inclusiveRight;if((T.from==null||(I?T.from<=u.ch:T.from<u.ch))&&(T.to==null||(U?T.to>=u.ch:T.to>u.ch))){if(g&&(Oe(k,"beforeCursorEnter"),k.explicitlyCleared))if(S.markedSpans){--w;continue}else break;if(!k.atomic)continue;if(h){var G=k.find(f<0?1:-1),Y=void 0;if((f<0?U:I)&&(G=j0(s,G,-f,G&&G.line==u.line?S:null)),G&&G.line==u.line&&(Y=M(G,h))&&(f<0?Y<0:Y>0))return Ol(s,G,u,f,g)}var q=k.find(f<0?-1:1);return(f<0?I:U)&&(q=j0(s,q,f,q.line==u.line?S:null)),q?Ol(s,q,u,f,g):null}}return u}function ef(s,u,h,f,g){var S=f||1,w=Ol(s,u,h,S,g)||!g&&Ol(s,u,h,S,!0)||Ol(s,u,h,-S,g)||!g&&Ol(s,u,h,-S,!0);return w||(s.cantEdit=!0,oe(s.first,0))}function j0(s,u,h,f){return h<0&&u.ch==0?u.line>s.first?ve(s,oe(u.line-1)):null:h>0&&u.ch==(f||we(s,u.line)).text.length?u.line<s.first+s.size-1?oe(u.line+1,0):null:new oe(u.line,u.ch+h)}function J0(s){s.setSelection(oe(s.firstLine(),0),oe(s.lastLine()),He)}function q0(s,u,h){var f={canceled:!1,from:u.from,to:u.to,text:u.text,origin:u.origin,cancel:function(){return f.canceled=!0}};return h&&(f.update=function(g,S,w,T){g&&(f.from=ve(s,g)),S&&(f.to=ve(s,S)),w&&(f.text=w),T!==void 0&&(f.origin=T)}),Oe(s,"beforeChange",s,f),s.cm&&Oe(s.cm,"beforeChange",s.cm,f),f.canceled?(s.cm&&(s.cm.curOp.updateInput=2),null):{from:f.from,to:f.to,text:f.text,origin:f.origin}}function Nl(s,u,h){if(s.cm){if(!s.cm.curOp)return ln(s.cm,Nl)(s,u,h);if(s.cm.state.suppressEdits)return}if(!((vn(s,"beforeChange")||s.cm&&vn(s.cm,"beforeChange"))&&(u=q0(s,u,!0),!u))){var f=Bw&&!h&&WV(s,u.from,u.to);if(f)for(var g=f.length-1;g>=0;--g)Y0(s,{from:f[g].from,to:f[g].to,text:g?[""]:u.text,origin:u.origin});else Y0(s,u)}}function Y0(s,u){if(!(u.text.length==1&&u.text[0]==""&&M(u.from,u.to)==0)){var h=fy(s,u);N0(s,u,h,s.cm?s.cm.curOp.id:NaN),gu(s,u,h,Ug(s,u));var f=[];bo(s,function(g,S){!S&&ge(f,g.history)==-1&&(Z0(g.history,u),f.push(g.history)),gu(g,u,null,Ug(g,u))})}}function tf(s,u,h){var f=s.cm&&s.cm.state.suppressEdits;if(!(f&&!h)){for(var g=s.history,S,w=s.sel,T=u=="undo"?g.done:g.undone,k=u=="undo"?g.undone:g.done,I=0;I<T.length&&(S=T[I],!(h?S.ranges&&!S.equals(s.sel):!S.ranges));I++);if(I!=T.length){for(g.lastOrigin=g.lastSelOrigin=null;;)if(S=T.pop(),S.ranges){if(Xp(S,k),h&&!S.equals(s.sel)){Ln(s,S,{clearRedo:!1});return}w=S}else if(f){T.push(S);return}else break;var U=[];Xp(w,k),k.push({changes:U,generation:g.generation}),g.generation=S.generation||++g.maxGeneration;for(var G=vn(s,"beforeChange")||s.cm&&vn(s.cm,"beforeChange"),Y=function(te){var ue=S.changes[te];if(ue.origin=u,G&&!q0(s,ue,!1))return T.length=0,{};U.push(gy(s,ue));var he=te?fy(s,ue):Xe(T);gu(s,ue,he,F0(s,ue)),!te&&s.cm&&s.cm.scrollIntoView({from:ue.from,to:So(ue)});var Se=[];bo(s,function(me,xe){!xe&&ge(Se,me.history)==-1&&(Z0(me.history,ue),Se.push(me.history)),gu(me,ue,null,F0(me,ue))})},q=S.changes.length-1;q>=0;--q){var Q=Y(q);if(Q)return Q.v}}}}function K0(s,u){if(u!=0&&(s.first+=u,s.sel=new Nr(Sr(s.sel.ranges,function(g){return new lt(oe(g.anchor.line+u,g.anchor.ch),oe(g.head.line+u,g.head.ch))}),s.sel.primIndex),s.cm)){rr(s.cm,s.first,s.first-u,u);for(var h=s.cm.display,f=h.viewFrom;f<h.viewTo;f++)go(s.cm,f,"gutter")}}function gu(s,u,h,f){if(s.cm&&!s.cm.curOp)return ln(s.cm,gu)(s,u,h,f);if(u.to.line<s.first){K0(s,u.text.length-1-(u.to.line-u.from.line));return}if(!(u.from.line>s.lastLine())){if(u.from.line<s.first){var g=u.text.length-1-(s.first-u.from.line);K0(s,g),u={from:oe(s.first,0),to:oe(u.to.line+g,u.to.ch),text:[Xe(u.text)],origin:u.origin}}var S=s.lastLine();u.to.line>S&&(u={from:u.from,to:oe(S,we(s,S).text.length),text:[u.text[0]],origin:u.origin}),u.removed=Ki(s,u.from,u.to),h||(h=fy(s,u)),s.cm?$O(s.cm,u,f):my(s,u,f),Zp(s,h,He),s.cantEdit&&ef(s,oe(s.firstLine(),0))&&(s.cantEdit=!1)}}function $O(s,u,h){var f=s.doc,g=s.display,S=u.from,w=u.to,T=!1,k=S.line;s.options.lineWrapping||(k=st(Zi(we(f,S.line))),f.iter(k,w.line+1,function(q){if(q==g.maxLine)return T=!0,!0})),f.sel.contains(u.from,u.to)>-1&&Cl(s),my(f,u,h,h0(s)),s.options.lineWrapping||(f.iter(k,S.line+u.text.length,function(q){var Q=Fp(q);Q>g.maxLineLength&&(g.maxLine=q,g.maxLineLength=Q,g.maxLineChanged=!0,T=!1)}),T&&(s.curOp.updateMaxLine=!0)),_V(f,S.line),fu(s,400);var I=u.text.length-(w.line-S.line)-1;u.full?rr(s):S.line==w.line&&u.text.length==1&&!R0(s.doc,u)?go(s,S.line,"text"):rr(s,S.line,w.line+1,I);var U=vn(s,"changes"),G=vn(s,"change");if(G||U){var Y={from:S,to:w,text:u.text,removed:u.removed,origin:u.origin};G&&sn(s,"change",s,Y),U&&(s.curOp.changeObjs||(s.curOp.changeObjs=[])).push(Y)}s.display.selForContextMenu=null}function Bl(s,u,h,f,g){var S;f||(f=h),M(f,h)<0&&(S=[f,h],h=S[0],f=S[1]),typeof u=="string"&&(u=s.splitLines(u)),Nl(s,{from:h,to:f,text:u,origin:g})}function X0(s,u,h,f){h<s.line?s.line+=f:u<s.line&&(s.line=u,s.ch=0)}function Q0(s,u,h,f){for(var g=0;g<s.length;++g){var S=s[g],w=!0;if(S.ranges){S.copied||(S=s[g]=S.deepCopy(),S.copied=!0);for(var T=0;T<S.ranges.length;T++)X0(S.ranges[T].anchor,u,h,f),X0(S.ranges[T].head,u,h,f);continue}for(var k=0;k<S.changes.length;++k){var I=S.changes[k];if(h<I.from.line)I.from=oe(I.from.line+f,I.from.ch),I.to=oe(I.to.line+f,I.to.ch);else if(u<=I.to.line){w=!1;break}}w||(s.splice(0,g+1),g=0)}}function Z0(s,u){var h=u.from.line,f=u.to.line,g=u.text.length-(f-h)-1;Q0(s.done,h,f,g),Q0(s.undone,h,f,g)}function yu(s,u,h,f){var g=u,S=u;return typeof u=="number"?S=we(s,nt(s,u)):g=st(u),g==null?null:(f(S,g)&&s.cm&&go(s.cm,g,h),S)}function vu(s){this.lines=s,this.parent=null;for(var u=0,h=0;h<s.length;++h)s[h].parent=this,u+=s[h].height;this.height=u}vu.prototype={chunkSize:function(){return this.lines.length},removeInner:function(s,u){for(var h=s,f=s+u;h<f;++h){var g=this.lines[h];this.height-=g.height,jV(g),sn(g,"delete")}this.lines.splice(s,u)},collapse:function(s){s.push.apply(s,this.lines)},insertInner:function(s,u,h){this.height+=h,this.lines=this.lines.slice(0,s).concat(u).concat(this.lines.slice(s));for(var f=0;f<u.length;++f)u[f].parent=this},iterN:function(s,u,h){for(var f=s+u;s<f;++s)if(h(this.lines[s]))return!0}};function Su(s){this.children=s;for(var u=0,h=0,f=0;f<s.length;++f){var g=s[f];u+=g.chunkSize(),h+=g.height,g.parent=this}this.size=u,this.height=h,this.parent=null}Su.prototype={chunkSize:function(){return this.size},removeInner:function(s,u){this.size-=u;for(var h=0;h<this.children.length;++h){var f=this.children[h],g=f.chunkSize();if(s<g){var S=Math.min(u,g-s),w=f.height;if(f.removeInner(s,S),this.height-=w-f.height,g==S&&(this.children.splice(h--,1),f.parent=null),(u-=S)==0)break;s=0}else s-=g}if(this.size-u<25&&(this.children.length>1||!(this.children[0]instanceof vu))){var T=[];this.collapse(T),this.children=[new vu(T)],this.children[0].parent=this}},collapse:function(s){for(var u=0;u<this.children.length;++u)this.children[u].collapse(s)},insertInner:function(s,u,h){this.size+=u.length,this.height+=h;for(var f=0;f<this.children.length;++f){var g=this.children[f],S=g.chunkSize();if(s<=S){if(g.insertInner(s,u,h),g.lines&&g.lines.length>50){for(var w=g.lines.length%25+25,T=w;T<g.lines.length;){var k=new vu(g.lines.slice(T,T+=25));g.height-=k.height,this.children.splice(++f,0,k),k.parent=this}g.lines=g.lines.slice(0,w),this.maybeSpill()}break}s-=S}},maybeSpill:function(){if(!(this.children.length<=10)){var s=this;do{var u=s.children.splice(s.children.length-5,5),h=new Su(u);if(s.parent){s.size-=h.size,s.height-=h.height;var g=ge(s.parent.children,s);s.parent.children.splice(g+1,0,h)}else{var f=new Su(s.children);f.parent=s,s.children=[f,h],s=f}h.parent=s.parent}while(s.children.length>10);s.parent.maybeSpill()}},iterN:function(s,u,h){for(var f=0;f<this.children.length;++f){var g=this.children[f],S=g.chunkSize();if(s<S){var w=Math.min(u,S-s);if(g.iterN(s,w,h))return!0;if((u-=w)==0)break;s=0}else s-=S}}};var bu=function(s,u,h){if(h)for(var f in h)h.hasOwnProperty(f)&&(this[f]=h[f]);this.doc=s,this.node=u};bu.prototype.clear=function(){var s=this.doc.cm,u=this.line.widgets,h=this.line,f=st(h);if(!(f==null||!u)){for(var g=0;g<u.length;++g)u[g]==this&&u.splice(g--,1);u.length||(h.widgets=null);var S=ou(this);xr(h,Math.max(0,h.height-S)),s&&(Cr(s,function(){eT(s,h,-S),go(s,f,"widget")}),sn(s,"lineWidgetCleared",s,this,f))}},bu.prototype.changed=function(){var s=this,u=this.height,h=this.doc.cm,f=this.line;this.height=null;var g=ou(this)-u;!g||(mo(this.doc,f)||xr(f,f.height+g),h&&Cr(h,function(){h.curOp.forceUpdate=!0,eT(h,f,g),sn(h,"lineWidgetChanged",h,s,st(f))}))},qi(bu);function eT(s,u,h){Ma(u)<(s.curOp&&s.curOp.scrollTop||s.doc.scrollTop)&&sy(s,h)}function jO(s,u,h,f){var g=new bu(s,h,f),S=s.cm;return S&&g.noHScroll&&(S.display.alignWidgets=!0),yu(s,u,"widget",function(w){var T=w.widgets||(w.widgets=[]);if(g.insertAt==null?T.push(g):T.splice(Math.min(T.length,Math.max(0,g.insertAt)),0,g),g.line=w,S&&!mo(s,w)){var k=Ma(w)<s.scrollTop;xr(w,w.height+ou(g)),k&&sy(S,g.height),S.curOp.forceUpdate=!0}return!0}),S&&sn(S,"lineWidgetAdded",S,g,typeof u=="number"?u:st(u)),g}var tT=0,xo=function(s,u){this.lines=[],this.type=u,this.doc=s,this.id=++tT};xo.prototype.clear=function(){if(!this.explicitlyCleared){var s=this.doc.cm,u=s&&!s.curOp;if(u&&bs(s),vn(this,"clear")){var h=this.find();h&&sn(this,"clear",h.from,h.to)}for(var f=null,g=null,S=0;S<this.lines.length;++S){var w=this.lines[S],T=ru(w.markedSpans,this);s&&!this.collapsed?go(s,st(w),"text"):s&&(T.to!=null&&(g=st(w)),T.from!=null&&(f=st(w))),w.markedSpans=NV(w.markedSpans,T),T.from==null&&this.collapsed&&!mo(this.doc,w)&&s&&xr(w,Il(s.display))}if(s&&this.collapsed&&!s.options.lineWrapping)for(var k=0;k<this.lines.length;++k){var I=Zi(this.lines[k]),U=Fp(I);U>s.display.maxLineLength&&(s.display.maxLine=I,s.display.maxLineLength=U,s.display.maxLineChanged=!0)}f!=null&&s&&this.collapsed&&rr(s,f,g+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,s&&H0(s.doc)),s&&sn(s,"markerCleared",s,this,f,g),u&&xs(s),this.parent&&this.parent.clear()}},xo.prototype.find=function(s,u){s==null&&this.type=="bookmark"&&(s=1);for(var h,f,g=0;g<this.lines.length;++g){var S=this.lines[g],w=ru(S.markedSpans,this);if(w.from!=null&&(h=oe(u?S:st(S),w.from),s==-1))return h;if(w.to!=null&&(f=oe(u?S:st(S),w.to),s==1))return f}return h&&{from:h,to:f}},xo.prototype.changed=function(){var s=this,u=this.find(-1,!0),h=this,f=this.doc.cm;!u||!f||Cr(f,function(){var g=u.line,S=st(u.line),w=qg(f,S);if(w&&(o0(w),f.curOp.selectionChanged=f.curOp.forceUpdate=!0),f.curOp.updateMaxLine=!0,!mo(h.doc,g)&&h.height!=null){var T=h.height;h.height=null;var k=ou(h)-T;k&&xr(g,g.height+k)}sn(f,"markerChanged",f,s)})},xo.prototype.attachLine=function(s){if(!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(!u.maybeHiddenMarkers||ge(u.maybeHiddenMarkers,this)==-1)&&(u.maybeUnhiddenMarkers||(u.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(s)},xo.prototype.detachLine=function(s){if(this.lines.splice(ge(this.lines,s),1),!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(u.maybeHiddenMarkers||(u.maybeHiddenMarkers=[])).push(this)}},qi(xo);function Fl(s,u,h,f,g){if(f&&f.shared)return JO(s,u,h,f,g);if(s.cm&&!s.cm.curOp)return ln(s.cm,Fl)(s,u,h,f,g);var S=new xo(s,g),w=M(u,h);if(f&&Ge(f,S,!1),w>0||w==0&&S.clearWhenEmpty!==!1)return S;if(S.replacedWith&&(S.collapsed=!0,S.widgetNode=N("span",[S.replacedWith],"CodeMirror-widget"),f.handleMouseEvents||S.widgetNode.setAttribute("cm-ignore-events","true"),f.insertLeft&&(S.widgetNode.insertLeft=!0)),S.collapsed){if(Hw(s,u.line,u,h,S)||u.line!=h.line&&Hw(s,h.line,u,h,S))throw new Error("Inserting collapsed marker partially overlapping an existing one");OV()}S.addToHistory&&N0(s,{from:u,to:h,origin:"markText"},s.sel,NaN);var T=u.line,k=s.cm,I;if(s.iter(T,h.line+1,function(G){k&&S.collapsed&&!k.options.lineWrapping&&Zi(G)==k.display.maxLine&&(I=!0),S.collapsed&&T!=u.line&&xr(G,0),BV(G,new Vp(S,T==u.line?u.ch:null,T==h.line?h.ch:null),s.cm&&s.cm.curOp),++T}),S.collapsed&&s.iter(u.line,h.line+1,function(G){mo(s,G)&&xr(G,0)}),S.clearOnEnter&&Ie(S,"beforeCursorEnter",function(){return S.clear()}),S.readOnly&&(VV(),(s.history.done.length||s.history.undone.length)&&s.clearHistory()),S.collapsed&&(S.id=++tT,S.atomic=!0),k){if(I&&(k.curOp.updateMaxLine=!0),S.collapsed)rr(k,u.line,h.line+1);else if(S.className||S.startStyle||S.endStyle||S.css||S.attributes||S.title)for(var U=u.line;U<=h.line;U++)go(k,U,"text");S.atomic&&H0(k.doc),sn(k,"markerAdded",k,S)}return S}var xu=function(s,u){this.markers=s,this.primary=u;for(var h=0;h<s.length;++h)s[h].parent=this};xu.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var s=0;s<this.markers.length;++s)this.markers[s].clear();sn(this,"clear")}},xu.prototype.find=function(s,u){return this.primary.find(s,u)},qi(xu);function JO(s,u,h,f,g){f=Ge(f),f.shared=!1;var S=[Fl(s,u,h,f,g)],w=S[0],T=f.widgetNode;return bo(s,function(k){T&&(f.widgetNode=T.cloneNode(!0)),S.push(Fl(k,ve(k,u),ve(k,h),f,g));for(var I=0;I<k.linked.length;++I)if(k.linked[I].isParent)return;w=Xe(S)}),new xu(S,w)}function nT(s){return s.findMarks(oe(s.first,0),s.clipPos(oe(s.lastLine())),function(u){return u.parent})}function qO(s,u){for(var h=0;h<u.length;h++){var f=u[h],g=f.find(),S=s.clipPos(g.from),w=s.clipPos(g.to);if(M(S,w)){var T=Fl(s,S,w,f.primary,f.primary.type);f.markers.push(T),T.parent=f}}}function YO(s){for(var u=function(f){var g=s[f],S=[g.primary.doc];bo(g.primary.doc,function(k){return S.push(k)});for(var w=0;w<g.markers.length;w++){var T=g.markers[w];ge(S,T.doc)==-1&&(T.parent=null,g.markers.splice(w--,1))}},h=0;h<s.length;h++)u(h)}var KO=0,ir=function(s,u,h,f,g){if(!(this instanceof ir))return new ir(s,u,h,f,g);h==null&&(h=0),Su.call(this,[new vu([new El("",null)])]),this.first=h,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=h;var S=oe(h,0);this.sel=vo(S),this.history=new Kp(null),this.id=++KO,this.modeOption=u,this.lineSep=f,this.direction=g=="rtl"?"rtl":"ltr",this.extend=!1,typeof s=="string"&&(s=this.splitLines(s)),my(this,{from:S,to:S,text:s}),Ln(this,vo(S),He)};ir.prototype=ji(Su.prototype,{constructor:ir,iter:function(s,u,h){h?this.iterN(s-this.first,u-s,h):this.iterN(this.first,this.first+this.size,s)},insert:function(s,u){for(var h=0,f=0;f<u.length;++f)h+=u[f].height;this.insertInner(s-this.first,u,h)},remove:function(s,u){this.removeInner(s-this.first,u)},getValue:function(s){var u=eu(this,this.first,this.first+this.size);return s===!1?u:u.join(s||this.lineSeparator())},setValue:cn(function(s){var u=oe(this.first,0),h=this.first+this.size-1;Nl(this,{from:u,to:oe(h,we(this,h).text.length),text:this.splitLines(s),origin:"setValue",full:!0},!0),this.cm&&cu(this.cm,0,0),Ln(this,vo(u),He)}),replaceRange:function(s,u,h,f){u=ve(this,u),h=h?ve(this,h):u,Bl(this,s,u,h,f)},getRange:function(s,u,h){var f=Ki(this,ve(this,s),ve(this,u));return h===!1?f:f.join(h||this.lineSeparator())},getLine:function(s){var u=this.getLineHandle(s);return u&&u.text},getLineHandle:function(s){if(fs(this,s))return we(this,s)},getLineNumber:function(s){return st(s)},getLineHandleVisualStart:function(s){return typeof s=="number"&&(s=we(this,s)),Zi(s)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(s){return ve(this,s)},getCursor:function(s){var u=this.sel.primary(),h;return s==null||s=="head"?h=u.head:s=="anchor"?h=u.anchor:s=="end"||s=="to"||s===!1?h=u.to():h=u.from(),h},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:cn(function(s,u,h){W0(this,ve(this,typeof s=="number"?oe(s,u||0):s),null,h)}),setSelection:cn(function(s,u,h){W0(this,ve(this,s),ve(this,u||s),h)}),extendSelection:cn(function(s,u,h){Qp(this,ve(this,s),u&&ve(this,u),h)}),extendSelections:cn(function(s,u){U0(this,Vr(this,s),u)}),extendSelectionsBy:cn(function(s,u){var h=Sr(this.sel.ranges,s);U0(this,Vr(this,h),u)}),setSelections:cn(function(s,u,h){if(!!s.length){for(var f=[],g=0;g<s.length;g++)f[g]=new lt(ve(this,s[g].anchor),ve(this,s[g].head||s[g].anchor));u==null&&(u=Math.min(s.length-1,this.sel.primIndex)),Ln(this,xi(this.cm,f,u),h)}}),addSelection:cn(function(s,u,h){var f=this.sel.ranges.slice(0);f.push(new lt(ve(this,s),ve(this,u||s))),Ln(this,xi(this.cm,f,f.length-1),h)}),getSelection:function(s){for(var u=this.sel.ranges,h,f=0;f<u.length;f++){var g=Ki(this,u[f].from(),u[f].to());h=h?h.concat(g):g}return s===!1?h:h.join(s||this.lineSeparator())},getSelections:function(s){for(var u=[],h=this.sel.ranges,f=0;f<h.length;f++){var g=Ki(this,h[f].from(),h[f].to());s!==!1&&(g=g.join(s||this.lineSeparator())),u[f]=g}return u},replaceSelection:function(s,u,h){for(var f=[],g=0;g<this.sel.ranges.length;g++)f[g]=s;this.replaceSelections(f,u,h||"+input")},replaceSelections:cn(function(s,u,h){for(var f=[],g=this.sel,S=0;S<g.ranges.length;S++){var w=g.ranges[S];f[S]={from:w.from(),to:w.to(),text:this.splitLines(s[S]),origin:h}}for(var T=u&&u!="end"&&NO(this,f,u),k=f.length-1;k>=0;k--)Nl(this,f[k]);T?G0(this,T):this.cm&&Rl(this.cm)}),undo:cn(function(){tf(this,"undo")}),redo:cn(function(){tf(this,"redo")}),undoSelection:cn(function(){tf(this,"undo",!0)}),redoSelection:cn(function(){tf(this,"redo",!0)}),setExtending:function(s){this.extend=s},getExtending:function(){return this.extend},historySize:function(){for(var s=this.history,u=0,h=0,f=0;f<s.done.length;f++)s.done[f].ranges||++u;for(var g=0;g<s.undone.length;g++)s.undone[g].ranges||++h;return{undo:u,redo:h}},clearHistory:function(){var s=this;this.history=new Kp(this.history),bo(this,function(u){return u.history=s.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(s){return s&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(s){return this.history.generation==(s||this.cleanGeneration)},getHistory:function(){return{done:Vl(this.history.done),undone:Vl(this.history.undone)}},setHistory:function(s){var u=this.history=new Kp(this.history);u.done=Vl(s.done.slice(0),null,!0),u.undone=Vl(s.undone.slice(0),null,!0)},setGutterMarker:cn(function(s,u,h){return yu(this,s,"gutter",function(f){var g=f.gutterMarkers||(f.gutterMarkers={});return g[u]=h,!h&&Da(g)&&(f.gutterMarkers=null),!0})}),clearGutter:cn(function(s){var u=this;this.iter(function(h){h.gutterMarkers&&h.gutterMarkers[s]&&yu(u,h,"gutter",function(){return h.gutterMarkers[s]=null,Da(h.gutterMarkers)&&(h.gutterMarkers=null),!0})})}),lineInfo:function(s){var u;if(typeof s=="number"){if(!fs(this,s)||(u=s,s=we(this,s),!s))return null}else if(u=st(s),u==null)return null;return{line:u,handle:s,text:s.text,gutterMarkers:s.gutterMarkers,textClass:s.textClass,bgClass:s.bgClass,wrapClass:s.wrapClass,widgets:s.widgets}},addLineClass:cn(function(s,u,h){return yu(this,s,u=="gutter"?"gutter":"class",function(f){var g=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass";if(!f[g])f[g]=h;else{if(O(h).test(f[g]))return!1;f[g]+=" "+h}return!0})}),removeLineClass:cn(function(s,u,h){return yu(this,s,u=="gutter"?"gutter":"class",function(f){var g=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass",S=f[g];if(S)if(h==null)f[g]=null;else{var w=S.match(O(h));if(!w)return!1;var T=w.index+w[0].length;f[g]=S.slice(0,w.index)+(!w.index||T==S.length?"":" ")+S.slice(T)||null}else return!1;return!0})}),addLineWidget:cn(function(s,u,h){return jO(this,s,u,h)}),removeLineWidget:function(s){s.clear()},markText:function(s,u,h){return Fl(this,ve(this,s),ve(this,u),h,h&&h.type||"range")},setBookmark:function(s,u){var h={replacedWith:u&&(u.nodeType==null?u.widget:u),insertLeft:u&&u.insertLeft,clearWhenEmpty:!1,shared:u&&u.shared,handleMouseEvents:u&&u.handleMouseEvents};return s=ve(this,s),Fl(this,s,s,h,"bookmark")},findMarksAt:function(s){s=ve(this,s);var u=[],h=we(this,s.line).markedSpans;if(h)for(var f=0;f<h.length;++f){var g=h[f];(g.from==null||g.from<=s.ch)&&(g.to==null||g.to>=s.ch)&&u.push(g.marker.parent||g.marker)}return u},findMarks:function(s,u,h){s=ve(this,s),u=ve(this,u);var f=[],g=s.line;return this.iter(s.line,u.line+1,function(S){var w=S.markedSpans;if(w)for(var T=0;T<w.length;T++){var k=w[T];!(k.to!=null&&g==s.line&&s.ch>=k.to||k.from==null&&g!=s.line||k.from!=null&&g==u.line&&k.from>=u.ch)&&(!h||h(k.marker))&&f.push(k.marker.parent||k.marker)}++g}),f},getAllMarks:function(){var s=[];return this.iter(function(u){var h=u.markedSpans;if(h)for(var f=0;f<h.length;++f)h[f].from!=null&&s.push(h[f].marker)}),s},posFromIndex:function(s){var u,h=this.first,f=this.lineSeparator().length;return this.iter(function(g){var S=g.text.length+f;if(S>s)return u=s,!0;s-=S,++h}),ve(this,oe(h,u))},indexFromPos:function(s){s=ve(this,s);var u=s.ch;if(s.line<this.first||s.ch<0)return 0;var h=this.lineSeparator().length;return this.iter(this.first,s.line,function(f){u+=f.text.length+h}),u},copy:function(s){var u=new ir(eu(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return u.scrollTop=this.scrollTop,u.scrollLeft=this.scrollLeft,u.sel=this.sel,u.extend=!1,s&&(u.history.undoDepth=this.history.undoDepth,u.setHistory(this.getHistory())),u},linkedDoc:function(s){s||(s={});var u=this.first,h=this.first+this.size;s.from!=null&&s.from>u&&(u=s.from),s.to!=null&&s.to<h&&(h=s.to);var f=new ir(eu(this,u,h),s.mode||this.modeOption,u,this.lineSep,this.direction);return s.sharedHist&&(f.history=this.history),(this.linked||(this.linked=[])).push({doc:f,sharedHist:s.sharedHist}),f.linked=[{doc:this,isParent:!0,sharedHist:s.sharedHist}],qO(f,nT(this)),f},unlinkDoc:function(s){if(s instanceof It&&(s=s.doc),this.linked)for(var u=0;u<this.linked.length;++u){var h=this.linked[u];if(h.doc==s){this.linked.splice(u,1),s.unlinkDoc(this),YO(nT(this));break}}if(s.history==this.history){var f=[s.id];bo(s,function(g){return f.push(g.id)},!0),s.history=new Kp(null),s.history.done=Vl(this.history.done,f),s.history.undone=Vl(this.history.undone,f)}},iterLinkedDocs:function(s){bo(this,s)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(s){return this.lineSep?s.split(this.lineSep):Kc(s)},lineSeparator:function(){return this.lineSep||`
`},setDirection:cn(function(s){s!="rtl"&&(s="ltr"),s!=this.direction&&(this.direction=s,this.iter(function(u){return u.order=null}),this.cm&&BO(this.cm))})}),ir.prototype.eachLine=ir.prototype.iter;var rT=0;function XO(s){var u=this;if(iT(u),!($t(u,s)||Ra(u.display,s))){wn(s),o&&(rT=+new Date);var h=gs(u,s,!0),f=s.dataTransfer.files;if(!(!h||u.isReadOnly()))if(f&&f.length&&window.FileReader&&window.File)for(var g=f.length,S=Array(g),w=0,T=function(){++w==g&&ln(u,function(){h=ve(u.doc,h);var q={from:h,to:h,text:u.doc.splitLines(S.filter(function(Q){return Q!=null}).join(u.doc.lineSeparator())),origin:"paste"};Nl(u.doc,q),G0(u.doc,vo(ve(u.doc,h),ve(u.doc,So(q))))})()},k=function(q,Q){if(u.options.allowDropFileTypes&&ge(u.options.allowDropFileTypes,q.type)==-1){T();return}var te=new FileReader;te.onerror=function(){return T()},te.onload=function(){var ue=te.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(ue)){T();return}S[Q]=ue,T()},te.readAsText(q)},I=0;I<f.length;I++)k(f[I],I);else{if(u.state.draggingText&&u.doc.sel.contains(h)>-1){u.state.draggingText(s),setTimeout(function(){return u.display.input.focus()},20);return}try{var U=s.dataTransfer.getData("Text");if(U){var G;if(u.state.draggingText&&!u.state.draggingText.copy&&(G=u.listSelections()),Zp(u.doc,vo(h,h)),G)for(var Y=0;Y<G.length;++Y)Bl(u.doc,"",G[Y].anchor,G[Y].head,"drag");u.replaceSelection(U,"around","paste"),u.display.input.focus()}}catch(q){}}}}function QO(s,u){if(o&&(!s.state.draggingText||+new Date-rT<100)){ps(u);return}if(!($t(s,u)||Ra(s.display,u))&&(u.dataTransfer.setData("Text",s.getSelection()),u.dataTransfer.effectAllowed="copyMove",u.dataTransfer.setDragImage&&!y)){var h=F("img",null,null,"position: fixed; left: 0; top: 0;");h.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",m&&(h.width=h.height=1,s.display.wrapper.appendChild(h),h._top=h.offsetTop),u.dataTransfer.setDragImage(h,0,0),m&&h.parentNode.removeChild(h)}}function ZO(s,u){var h=gs(s,u);if(!!h){var f=document.createDocumentFragment();y0(s,h,f),s.display.dragCursor||(s.display.dragCursor=F("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),s.display.lineSpace.insertBefore(s.display.dragCursor,s.display.cursorDiv)),_(s.display.dragCursor,f)}}function iT(s){s.display.dragCursor&&(s.display.lineSpace.removeChild(s.display.dragCursor),s.display.dragCursor=null)}function aT(s){if(!!document.getElementsByClassName){for(var u=document.getElementsByClassName("CodeMirror"),h=[],f=0;f<u.length;f++){var g=u[f].CodeMirror;g&&h.push(g)}h.length&&h[0].operation(function(){for(var S=0;S<h.length;S++)s(h[S])})}}var oT=!1;function eN(){oT||(tN(),oT=!0)}function tN(){var s;Ie(window,"resize",function(){s==null&&(s=setTimeout(function(){s=null,aT(nN)},100))}),Ie(window,"blur",function(){return aT(Ml)})}function nN(s){var u=s.display;u.cachedCharWidth=u.cachedTextHeight=u.cachedPaddingH=null,u.scrollbarsClipped=!1,s.setSize()}for(var Co={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Cu=0;Cu<10;Cu++)Co[Cu+48]=Co[Cu+96]=String(Cu);for(var nf=65;nf<=90;nf++)Co[nf]=String.fromCharCode(nf);for(var wu=1;wu<=12;wu++)Co[wu+111]=Co[wu+63235]="F"+wu;var _a={};_a.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},_a.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},_a.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},_a.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},_a.default=A?_a.macDefault:_a.pcDefault;function rN(s){var u=s.split(/-(?!$)/);s=u[u.length-1];for(var h,f,g,S,w=0;w<u.length-1;w++){var T=u[w];if(/^(cmd|meta|m)$/i.test(T))S=!0;else if(/^a(lt)?$/i.test(T))h=!0;else if(/^(c|ctrl|control)$/i.test(T))f=!0;else if(/^s(hift)?$/i.test(T))g=!0;else throw new Error("Unrecognized modifier name: "+T)}return h&&(s="Alt-"+s),f&&(s="Ctrl-"+s),S&&(s="Cmd-"+s),g&&(s="Shift-"+s),s}function iN(s){var u={};for(var h in s)if(s.hasOwnProperty(h)){var f=s[h];if(/^(name|fallthrough|(de|at)tach)$/.test(h))continue;if(f=="..."){delete s[h];continue}for(var g=Sr(h.split(" "),rN),S=0;S<g.length;S++){var w=void 0,T=void 0;S==g.length-1?(T=g.join(" "),w=f):(T=g.slice(0,S+1).join(" "),w="...");var k=u[T];if(!k)u[T]=w;else if(k!=w)throw new Error("Inconsistent bindings for "+T)}delete s[h]}for(var I in u)s[I]=u[I];return s}function Ul(s,u,h,f){u=rf(u);var g=u.call?u.call(s,f):u[s];if(g===!1)return"nothing";if(g==="...")return"multi";if(g!=null&&h(g))return"handled";if(u.fallthrough){if(Object.prototype.toString.call(u.fallthrough)!="[object Array]")return Ul(s,u.fallthrough,h,f);for(var S=0;S<u.fallthrough.length;S++){var w=Ul(s,u.fallthrough[S],h,f);if(w)return w}}}function sT(s){var u=typeof s=="string"?s:Co[s.keyCode];return u=="Ctrl"||u=="Alt"||u=="Shift"||u=="Mod"}function lT(s,u,h){var f=s;return u.altKey&&f!="Alt"&&(s="Alt-"+s),(E?u.metaKey:u.ctrlKey)&&f!="Ctrl"&&(s="Ctrl-"+s),(E?u.ctrlKey:u.metaKey)&&f!="Mod"&&(s="Cmd-"+s),!h&&u.shiftKey&&f!="Shift"&&(s="Shift-"+s),s}function cT(s,u){if(m&&s.keyCode==34&&s.char)return!1;var h=Co[s.keyCode];return h==null||s.altGraphKey?!1:(s.keyCode==3&&s.code&&(h=s.code),lT(h,s,u))}function rf(s){return typeof s=="string"?_a[s]:s}function Wl(s,u){for(var h=s.doc.sel.ranges,f=[],g=0;g<h.length;g++){for(var S=u(h[g]);f.length&&M(S.from,Xe(f).to)<=0;){var w=f.pop();if(M(w.from,S.from)<0){S.from=w.from;break}}f.push(S)}Cr(s,function(){for(var T=f.length-1;T>=0;T--)Bl(s.doc,"",f[T].from,f[T].to,"+delete");Rl(s)})}function Sy(s,u,h){var f=po(s.text,u+h,h);return f<0||f>s.text.length?null:f}function by(s,u,h){var f=Sy(s,u.ch,h);return f==null?null:new oe(u.line,f,h<0?"after":"before")}function xy(s,u,h,f,g){if(s){u.doc.direction=="rtl"&&(g=-g);var S=br(h,u.doc.direction);if(S){var w=g<0?Xe(S):S[0],T=g<0==(w.level==1),k=T?"after":"before",I;if(w.level>0||u.doc.direction=="rtl"){var U=Pl(u,h);I=g<0?h.text.length-1:0;var G=ta(u,U,I).top;I=Cn(function(Y){return ta(u,U,Y).top==G},g<0==(w.level==1)?w.from:w.to-1,I),k=="before"&&(I=Sy(h,I,1))}else I=g<0?w.to:w.from;return new oe(f,I,k)}}return new oe(f,g<0?h.text.length:0,g<0?"before":"after")}function aN(s,u,h,f){var g=br(u,s.doc.direction);if(!g)return by(u,h,f);h.ch>=u.text.length?(h.ch=u.text.length,h.sticky="before"):h.ch<=0&&(h.ch=0,h.sticky="after");var S=bt(g,h.ch,h.sticky),w=g[S];if(s.doc.direction=="ltr"&&w.level%2==0&&(f>0?w.to>h.ch:w.from<h.ch))return by(u,h,f);var T=function(he,Se){return Sy(u,he instanceof oe?he.ch:he,Se)},k,I=function(he){return s.options.lineWrapping?(k=k||Pl(s,u),f0(s,u,k,he)):{begin:0,end:u.text.length}},U=I(h.sticky=="before"?T(h,-1):h.ch);if(s.doc.direction=="rtl"||w.level==1){var G=w.level==1==f<0,Y=T(h,G?1:-1);if(Y!=null&&(G?Y<=w.to&&Y<=U.end:Y>=w.from&&Y>=U.begin)){var q=G?"before":"after";return new oe(h.line,Y,q)}}var Q=function(he,Se,me){for(var xe=function(vt,un){return un?new oe(h.line,T(vt,1),"before"):new oe(h.line,vt,"after")};he>=0&&he<g.length;he+=Se){var De=g[he],ke=Se>0==(De.level!=1),qe=ke?me.begin:T(me.end,-1);if(De.from<=qe&&qe<De.to||(qe=ke?De.from:T(De.to,-1),me.begin<=qe&&qe<me.end))return xe(qe,ke)}},te=Q(S+f,f,U);if(te)return te;var ue=f>0?U.end:T(U.begin,-1);return ue!=null&&!(f>0&&ue==u.text.length)&&(te=Q(f>0?0:g.length-1,f,I(ue)),te)?te:null}var Tu={selectAll:J0,singleSelection:function(s){return s.setSelection(s.getCursor("anchor"),s.getCursor("head"),He)},killLine:function(s){return Wl(s,function(u){if(u.empty()){var h=we(s.doc,u.head.line).text.length;return u.head.ch==h&&u.head.line<s.lastLine()?{from:u.head,to:oe(u.head.line+1,0)}:{from:u.head,to:oe(u.head.line,h)}}else return{from:u.from(),to:u.to()}})},deleteLine:function(s){return Wl(s,function(u){return{from:oe(u.from().line,0),to:ve(s.doc,oe(u.to().line+1,0))}})},delLineLeft:function(s){return Wl(s,function(u){return{from:oe(u.from().line,0),to:u.from()}})},delWrappedLineLeft:function(s){return Wl(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return{from:f,to:u.from()}})},delWrappedLineRight:function(s){return Wl(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div");return{from:u.from(),to:f}})},undo:function(s){return s.undo()},redo:function(s){return s.redo()},undoSelection:function(s){return s.undoSelection()},redoSelection:function(s){return s.redoSelection()},goDocStart:function(s){return s.extendSelection(oe(s.firstLine(),0))},goDocEnd:function(s){return s.extendSelection(oe(s.lastLine()))},goLineStart:function(s){return s.extendSelectionsBy(function(u){return uT(s,u.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(s){return s.extendSelectionsBy(function(u){return dT(s,u.head)},{origin:"+move",bias:1})},goLineEnd:function(s){return s.extendSelectionsBy(function(u){return oN(s,u.head.line)},{origin:"+move",bias:-1})},goLineRight:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div")},Pe)},goLineLeft:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:0,top:h},"div")},Pe)},goLineLeftSmart:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return f.ch<s.getLine(f.line).search(/\S/)?dT(s,u.head):f},Pe)},goLineUp:function(s){return s.moveV(-1,"line")},goLineDown:function(s){return s.moveV(1,"line")},goPageUp:function(s){return s.moveV(-1,"page")},goPageDown:function(s){return s.moveV(1,"page")},goCharLeft:function(s){return s.moveH(-1,"char")},goCharRight:function(s){return s.moveH(1,"char")},goColumnLeft:function(s){return s.moveH(-1,"column")},goColumnRight:function(s){return s.moveH(1,"column")},goWordLeft:function(s){return s.moveH(-1,"word")},goGroupRight:function(s){return s.moveH(1,"group")},goGroupLeft:function(s){return s.moveH(-1,"group")},goWordRight:function(s){return s.moveH(1,"word")},delCharBefore:function(s){return s.deleteH(-1,"codepoint")},delCharAfter:function(s){return s.deleteH(1,"char")},delWordBefore:function(s){return s.deleteH(-1,"word")},delWordAfter:function(s){return s.deleteH(1,"word")},delGroupBefore:function(s){return s.deleteH(-1,"group")},delGroupAfter:function(s){return s.deleteH(1,"group")},indentAuto:function(s){return s.indentSelection("smart")},indentMore:function(s){return s.indentSelection("add")},indentLess:function(s){return s.indentSelection("subtract")},insertTab:function(s){return s.replaceSelection("	")},insertSoftTab:function(s){for(var u=[],h=s.listSelections(),f=s.options.tabSize,g=0;g<h.length;g++){var S=h[g].from(),w=ze(s.getLine(S.line),S.ch,f);u.push(zi(f-w%f))}s.replaceSelections(u)},defaultTab:function(s){s.somethingSelected()?s.indentSelection("add"):s.execCommand("insertTab")},transposeChars:function(s){return Cr(s,function(){for(var u=s.listSelections(),h=[],f=0;f<u.length;f++)if(!!u[f].empty()){var g=u[f].head,S=we(s.doc,g.line).text;if(S){if(g.ch==S.length&&(g=new oe(g.line,g.ch-1)),g.ch>0)g=new oe(g.line,g.ch+1),s.replaceRange(S.charAt(g.ch-1)+S.charAt(g.ch-2),oe(g.line,g.ch-2),g,"+transpose");else if(g.line>s.doc.first){var w=we(s.doc,g.line-1).text;w&&(g=new oe(g.line,1),s.replaceRange(S.charAt(0)+s.doc.lineSeparator()+w.charAt(w.length-1),oe(g.line-1,w.length-1),g,"+transpose"))}}h.push(new lt(g,g))}s.setSelections(h)})},newlineAndIndent:function(s){return Cr(s,function(){for(var u=s.listSelections(),h=u.length-1;h>=0;h--)s.replaceRange(s.doc.lineSeparator(),u[h].anchor,u[h].head,"+input");u=s.listSelections();for(var f=0;f<u.length;f++)s.indentLine(u[f].from().line,null,!0);Rl(s)})},openLine:function(s){return s.replaceSelection(`
`,"start")},toggleOverwrite:function(s){return s.toggleOverwrite()}};function uT(s,u){var h=we(s.doc,u),f=Zi(h);return f!=h&&(u=st(f)),xy(!0,s,f,u,1)}function oN(s,u){var h=we(s.doc,u),f=zV(h);return f!=h&&(u=st(f)),xy(!0,s,h,u,-1)}function dT(s,u){var h=uT(s,u.line),f=we(s.doc,h.line),g=br(f,s.doc.direction);if(!g||g[0].level==0){var S=Math.max(h.ch,f.text.search(/\S/)),w=u.line==h.line&&u.ch<=S&&u.ch;return oe(h.line,w?0:S,h.sticky)}return h}function af(s,u,h){if(typeof u=="string"&&(u=Tu[u],!u))return!1;s.display.input.ensurePolled();var f=s.display.shift,g=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),h&&(s.display.shift=!1),g=u(s)!=Fe}finally{s.display.shift=f,s.state.suppressEdits=!1}return g}function sN(s,u,h){for(var f=0;f<s.state.keyMaps.length;f++){var g=Ul(u,s.state.keyMaps[f],h,s);if(g)return g}return s.options.extraKeys&&Ul(u,s.options.extraKeys,h,s)||Ul(u,s.options.keyMap,h,s)}var lN=new tt;function Lu(s,u,h,f){var g=s.state.keySeq;if(g){if(sT(u))return"handled";if(/\'$/.test(u)?s.state.keySeq=null:lN.set(50,function(){s.state.keySeq==g&&(s.state.keySeq=null,s.display.input.reset())}),pT(s,g+" "+u,h,f))return!0}return pT(s,u,h,f)}function pT(s,u,h,f){var g=sN(s,u,f);return g=="multi"&&(s.state.keySeq=u),g=="handled"&&sn(s,"keyHandled",s,u,h),(g=="handled"||g=="multi")&&(wn(h),ry(s)),!!g}function fT(s,u){var h=cT(u,!0);return h?u.shiftKey&&!s.state.keySeq?Lu(s,"Shift-"+h,u,function(f){return af(s,f,!0)})||Lu(s,h,u,function(f){if(typeof f=="string"?/^go[A-Z]/.test(f):f.motion)return af(s,f)}):Lu(s,h,u,function(f){return af(s,f)}):!1}function cN(s,u,h){return Lu(s,"'"+h+"'",u,function(f){return af(s,f,!0)})}var Cy=null;function hT(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&(u.curOp.focus=pe(),!$t(u,s))){o&&l<11&&s.keyCode==27&&(s.returnValue=!1);var h=s.keyCode;u.display.shift=h==16||s.shiftKey;var f=fT(u,s);m&&(Cy=f?h:null,!f&&h==88&&!Rp&&(A?s.metaKey:s.ctrlKey)&&u.replaceSelection("",null,"cut")),t&&!A&&!f&&h==46&&s.shiftKey&&!s.ctrlKey&&document.execCommand&&document.execCommand("cut"),h==18&&!/\bCodeMirror-crosshair\b/.test(u.display.lineDiv.className)&&uN(u)}}function uN(s){var u=s.display.lineDiv;ye(u,"CodeMirror-crosshair");function h(f){(f.keyCode==18||!f.altKey)&&(B(u,"CodeMirror-crosshair"),tr(document,"keyup",h),tr(document,"mouseover",h))}Ie(document,"keyup",h),Ie(document,"mouseover",h)}function mT(s){s.keyCode==16&&(this.doc.sel.shift=!1),$t(this,s)}function gT(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&!(Ra(u.display,s)||$t(u,s)||s.ctrlKey&&!s.altKey||A&&s.metaKey)){var h=s.keyCode,f=s.charCode;if(m&&h==Cy){Cy=null,wn(s);return}if(!(m&&(!s.which||s.which<10)&&fT(u,s))){var g=String.fromCharCode(f==null?h:f);g!="\b"&&(cN(u,s,g)||u.display.input.onKeyPress(s))}}}var dN=400,wy=function(s,u,h){this.time=s,this.pos=u,this.button=h};wy.prototype.compare=function(s,u,h){return this.time+dN>s&&M(u,this.pos)==0&&h==this.button};var ku,Eu;function pN(s,u){var h=+new Date;return Eu&&Eu.compare(h,s,u)?(ku=Eu=null,"triple"):ku&&ku.compare(h,s,u)?(Eu=new wy(h,s,u),ku=null,"double"):(ku=new wy(h,s,u),Eu=null,"single")}function yT(s){var u=this,h=u.display;if(!($t(u,s)||h.activeTouch&&h.input.supportsTouch())){if(h.input.ensurePolled(),h.shift=s.shiftKey,Ra(h,s)){c||(h.scroller.draggable=!1,setTimeout(function(){return h.scroller.draggable=!0},100));return}if(!Ty(u,s)){var f=gs(u,s),g=Ip(s),S=f?pN(f,g):"single";window.focus(),g==1&&u.state.selectingText&&u.state.selectingText(s),!(f&&fN(u,g,f,S,s))&&(g==1?f?mN(u,f,S,s):fo(s)==h.scroller&&wn(s):g==2?(f&&Qp(u.doc,f),setTimeout(function(){return h.input.focus()},20)):g==3&&(V?u.display.input.onContextMenu(s):iy(u)))}}}function fN(s,u,h,f,g){var S="Click";return f=="double"?S="Double"+S:f=="triple"&&(S="Triple"+S),S=(u==1?"Left":u==2?"Middle":"Right")+S,Lu(s,lT(S,g),g,function(w){if(typeof w=="string"&&(w=Tu[w]),!w)return!1;var T=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),T=w(s,h)!=Fe}finally{s.state.suppressEdits=!1}return T})}function hN(s,u,h){var f=s.getOption("configureMouse"),g=f?f(s,u,h):{};if(g.unit==null){var S=D?h.shiftKey&&h.metaKey:h.altKey;g.unit=S?"rectangle":u=="single"?"char":u=="double"?"word":"line"}return(g.extend==null||s.doc.extend)&&(g.extend=s.doc.extend||h.shiftKey),g.addNew==null&&(g.addNew=A?h.metaKey:h.ctrlKey),g.moveOnDrag==null&&(g.moveOnDrag=!(A?h.altKey:h.ctrlKey)),g}function mN(s,u,h,f){o?setTimeout(Le(v0,s),0):s.curOp.focus=pe();var g=hN(s,h,f),S=s.doc.sel,w;s.options.dragDrop&&qc&&!s.isReadOnly()&&h=="single"&&(w=S.contains(u))>-1&&(M((w=S.ranges[w]).from(),u)<0||u.xRel>0)&&(M(w.to(),u)>0||u.xRel<0)?gN(s,f,u,g):yN(s,f,u,g)}function gN(s,u,h,f){var g=s.display,S=!1,w=ln(s,function(I){c&&(g.scroller.draggable=!1),s.state.draggingText=!1,s.state.delayingBlurEvent&&(s.hasFocus()?s.state.delayingBlurEvent=!1:iy(s)),tr(g.wrapper.ownerDocument,"mouseup",w),tr(g.wrapper.ownerDocument,"mousemove",T),tr(g.scroller,"dragstart",k),tr(g.scroller,"drop",w),S||(wn(I),f.addNew||Qp(s.doc,h,null,null,f.extend),c&&!y||o&&l==9?setTimeout(function(){g.wrapper.ownerDocument.body.focus({preventScroll:!0}),g.input.focus()},20):g.input.focus())}),T=function(I){S=S||Math.abs(u.clientX-I.clientX)+Math.abs(u.clientY-I.clientY)>=10},k=function(){return S=!0};c&&(g.scroller.draggable=!0),s.state.draggingText=w,w.copy=!f.moveOnDrag,Ie(g.wrapper.ownerDocument,"mouseup",w),Ie(g.wrapper.ownerDocument,"mousemove",T),Ie(g.scroller,"dragstart",k),Ie(g.scroller,"drop",w),s.state.delayingBlurEvent=!0,setTimeout(function(){return g.input.focus()},20),g.scroller.dragDrop&&g.scroller.dragDrop()}function vT(s,u,h){if(h=="char")return new lt(u,u);if(h=="word")return s.findWordAt(u);if(h=="line")return new lt(oe(u.line,0),ve(s.doc,oe(u.line+1,0)));var f=h(s,u);return new lt(f.from,f.to)}function yN(s,u,h,f){o&&iy(s);var g=s.display,S=s.doc;wn(u);var w,T,k=S.sel,I=k.ranges;if(f.addNew&&!f.extend?(T=S.sel.contains(h),T>-1?w=I[T]:w=new lt(h,h)):(w=S.sel.primary(),T=S.sel.primIndex),f.unit=="rectangle")f.addNew||(w=new lt(h,h)),h=gs(s,u,!0,!0),T=-1;else{var U=vT(s,h,f.unit);f.extend?w=yy(w,U.anchor,U.head,f.extend):w=U}f.addNew?T==-1?(T=I.length,Ln(S,xi(s,I.concat([w]),T),{scroll:!1,origin:"*mouse"})):I.length>1&&I[T].empty()&&f.unit=="char"&&!f.extend?(Ln(S,xi(s,I.slice(0,T).concat(I.slice(T+1)),0),{scroll:!1,origin:"*mouse"}),k=S.sel):vy(S,T,w,Ke):(T=0,Ln(S,new Nr([w],0),Ke),k=S.sel);var G=h;function Y(me){if(M(G,me)!=0)if(G=me,f.unit=="rectangle"){for(var xe=[],De=s.options.tabSize,ke=ze(we(S,h.line).text,h.ch,De),qe=ze(we(S,me.line).text,me.ch,De),vt=Math.min(ke,qe),un=Math.max(ke,qe),Mt=Math.min(h.line,me.line),wr=Math.min(s.lastLine(),Math.max(h.line,me.line));Mt<=wr;Mt++){var ar=we(S,Mt).text,jt=at(ar,vt,De);vt==un?xe.push(new lt(oe(Mt,jt),oe(Mt,jt))):ar.length>jt&&xe.push(new lt(oe(Mt,jt),oe(Mt,at(ar,un,De))))}xe.length||xe.push(new lt(h,h)),Ln(S,xi(s,k.ranges.slice(0,T).concat(xe),T),{origin:"*mouse",scroll:!1}),s.scrollIntoView(me)}else{var or=w,Sn=vT(s,me,f.unit),Qt=or.anchor,Jt;M(Sn.anchor,Qt)>0?(Jt=Sn.head,Qt=Ne(or.from(),Sn.anchor)):(Jt=Sn.anchor,Qt=se(or.to(),Sn.head));var Nt=k.ranges.slice(0);Nt[T]=vN(s,new lt(ve(S,Qt),Jt)),Ln(S,xi(s,Nt,T),Ke)}}var q=g.wrapper.getBoundingClientRect(),Q=0;function te(me){var xe=++Q,De=gs(s,me,!0,f.unit=="rectangle");if(!!De)if(M(De,G)!=0){s.curOp.focus=pe(),Y(De);var ke=jp(g,S);(De.line>=ke.to||De.line<ke.from)&&setTimeout(ln(s,function(){Q==xe&&te(me)}),150)}else{var qe=me.clientY<q.top?-20:me.clientY>q.bottom?20:0;qe&&setTimeout(ln(s,function(){Q==xe&&(g.scroller.scrollTop+=qe,te(me))}),50)}}function ue(me){s.state.selectingText=!1,Q=Infinity,me&&(wn(me),g.input.focus()),tr(g.wrapper.ownerDocument,"mousemove",he),tr(g.wrapper.ownerDocument,"mouseup",Se),S.history.lastSelOrigin=null}var he=ln(s,function(me){me.buttons===0||!Ip(me)?ue(me):te(me)}),Se=ln(s,ue);s.state.selectingText=Se,Ie(g.wrapper.ownerDocument,"mousemove",he),Ie(g.wrapper.ownerDocument,"mouseup",Se)}function vN(s,u){var h=u.anchor,f=u.head,g=we(s.doc,h.line);if(M(h,f)==0&&h.sticky==f.sticky)return u;var S=br(g);if(!S)return u;var w=bt(S,h.ch,h.sticky),T=S[w];if(T.from!=h.ch&&T.to!=h.ch)return u;var k=w+(T.from==h.ch==(T.level!=1)?0:1);if(k==0||k==S.length)return u;var I;if(f.line!=h.line)I=(f.line-h.line)*(s.doc.direction=="ltr"?1:-1)>0;else{var U=bt(S,f.ch,f.sticky),G=U-w||(f.ch-h.ch)*(T.level==1?-1:1);U==k-1||U==k?I=G<0:I=G>0}var Y=S[k+(I?-1:0)],q=I==(Y.level==1),Q=q?Y.from:Y.to,te=q?"after":"before";return h.ch==Q&&h.sticky==te?u:new lt(new oe(h.line,Q,te),f)}function ST(s,u,h,f){var g,S;if(u.touches)g=u.touches[0].clientX,S=u.touches[0].clientY;else try{g=u.clientX,S=u.clientY}catch(Y){return!1}if(g>=Math.floor(s.display.gutters.getBoundingClientRect().right))return!1;f&&wn(u);var w=s.display,T=w.lineDiv.getBoundingClientRect();if(S>T.bottom||!vn(s,h))return Mr(u);S-=T.top-w.viewOffset;for(var k=0;k<s.display.gutterSpecs.length;++k){var I=w.gutters.childNodes[k];if(I&&I.getBoundingClientRect().right>=g){var U=Xi(s.doc,S),G=s.display.gutterSpecs[k];return Oe(s,h,s,U,G.className,u),Mr(u)}}}function Ty(s,u){return ST(s,u,"gutterClick",!0)}function bT(s,u){Ra(s.display,u)||SN(s,u)||$t(s,u,"contextmenu")||V||s.display.input.onContextMenu(u)}function SN(s,u){return vn(s,"gutterContextMenu")?ST(s,u,"gutterContextMenu",!1):!1}function xT(s){s.display.wrapper.className=s.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+s.options.theme.replace(/(^|\s)\s*/g," cm-s-"),su(s)}var Gl={toString:function(){return"CodeMirror.Init"}},CT={},of={};function bN(s){var u=s.optionHandlers;function h(f,g,S,w){s.defaults[f]=g,S&&(u[f]=w?function(T,k,I){I!=Gl&&S(T,k,I)}:S)}s.defineOption=h,s.Init=Gl,h("value","",function(f,g){return f.setValue(g)},!0),h("mode",null,function(f,g){f.doc.modeOption=g,hy(f)},!0),h("indentUnit",2,hy,!0),h("indentWithTabs",!1),h("smartIndent",!0),h("tabSize",4,function(f){mu(f),su(f),rr(f)},!0),h("lineSeparator",null,function(f,g){if(f.doc.lineSep=g,!!g){var S=[],w=f.doc.first;f.doc.iter(function(k){for(var I=0;;){var U=k.text.indexOf(g,I);if(U==-1)break;I=U+g.length,S.push(oe(w,U))}w++});for(var T=S.length-1;T>=0;T--)Bl(f.doc,g,S[T],oe(S[T].line,S[T].ch+g.length))}}),h("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\ufeff\ufff9-\ufffc]/g,function(f,g,S){f.state.specialChars=new RegExp(g.source+(g.test("	")?"":"|	"),"g"),S!=Gl&&f.refresh()}),h("specialCharPlaceholder",YV,function(f){return f.refresh()},!0),h("electricChars",!0),h("inputStyle",L?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),h("spellcheck",!1,function(f,g){return f.getInputField().spellcheck=g},!0),h("autocorrect",!1,function(f,g){return f.getInputField().autocorrect=g},!0),h("autocapitalize",!1,function(f,g){return f.getInputField().autocapitalize=g},!0),h("rtlMoveVisually",!R),h("wholeLineUpdateBefore",!0),h("theme","default",function(f){xT(f),hu(f)},!0),h("keyMap","default",function(f,g,S){var w=rf(g),T=S!=Gl&&rf(S);T&&T.detach&&T.detach(f,w),w.attach&&w.attach(f,T||null)}),h("extraKeys",null),h("configureMouse",null),h("lineWrapping",!1,CN,!0),h("gutters",[],function(f,g){f.display.gutterSpecs=py(g,f.options.lineNumbers),hu(f)},!0),h("fixedGutter",!0,function(f,g){f.display.gutters.style.left=g?ty(f.display)+"px":"0",f.refresh()},!0),h("coverGutterNextToScrollbar",!1,function(f){return _l(f)},!0),h("scrollbarStyle","native",function(f){T0(f),_l(f),f.display.scrollbars.setScrollTop(f.doc.scrollTop),f.display.scrollbars.setScrollLeft(f.doc.scrollLeft)},!0),h("lineNumbers",!1,function(f,g){f.display.gutterSpecs=py(f.options.gutters,g),hu(f)},!0),h("firstLineNumber",1,hu,!0),h("lineNumberFormatter",function(f){return f},hu,!0),h("showCursorWhenSelecting",!1,lu,!0),h("resetSelectionOnContextMenu",!0),h("lineWiseCopyCut",!0),h("pasteLinesPerSelection",!0),h("selectionsMayTouch",!1),h("readOnly",!1,function(f,g){g=="nocursor"&&(Ml(f),f.display.input.blur()),f.display.input.readOnlyChanged(g)}),h("screenReaderLabel",null,function(f,g){g=g===""?null:g,f.display.input.screenReaderLabelChanged(g)}),h("disableInput",!1,function(f,g){g||f.display.input.reset()},!0),h("dragDrop",!0,xN),h("allowDropFileTypes",null),h("cursorBlinkRate",530),h("cursorScrollMargin",0),h("cursorHeight",1,lu,!0),h("singleCursorHeightPerLine",!0,lu,!0),h("workTime",100),h("workDelay",100),h("flattenSpans",!0,mu,!0),h("addModeClass",!1,mu,!0),h("pollInterval",100),h("undoDepth",200,function(f,g){return f.doc.history.undoDepth=g}),h("historyEventDelay",1250),h("viewportMargin",10,function(f){return f.refresh()},!0),h("maxHighlightLength",1e4,mu,!0),h("moveInputWithCursor",!0,function(f,g){g||f.display.input.resetPosition()}),h("tabindex",null,function(f,g){return f.display.input.getField().tabIndex=g||""}),h("autofocus",null),h("direction","ltr",function(f,g){return f.doc.setDirection(g)},!0),h("phrases",null)}function xN(s,u,h){var f=h&&h!=Gl;if(!u!=!f){var g=s.display.dragFunctions,S=u?Ie:tr;S(s.display.scroller,"dragstart",g.start),S(s.display.scroller,"dragenter",g.enter),S(s.display.scroller,"dragover",g.over),S(s.display.scroller,"dragleave",g.leave),S(s.display.scroller,"drop",g.drop)}}function CN(s){s.options.lineWrapping?(ye(s.display.wrapper,"CodeMirror-wrap"),s.display.sizer.style.minWidth="",s.display.sizerWidth=null):(B(s.display.wrapper,"CodeMirror-wrap"),Hg(s)),ny(s),rr(s),su(s),setTimeout(function(){return _l(s)},100)}function It(s,u){var h=this;if(!(this instanceof It))return new It(s,u);this.options=u=u?Ge(u):{},Ge(CT,u,!1);var f=u.value;typeof f=="string"?f=new ir(f,u.mode,null,u.lineSeparator,u.direction):u.mode&&(f.modeOption=u.mode),this.doc=f;var g=new It.inputStyles[u.inputStyle](this),S=this.display=new VO(s,f,g,u);S.wrapper.CodeMirror=this,xT(this),u.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),T0(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new tt,keySeq:null,specialChars:null},u.autofocus&&!L&&S.input.focus(),o&&l<11&&setTimeout(function(){return h.display.input.reset(!0)},20),wN(this),eN(),bs(this),this.curOp.forceUpdate=!0,_0(this,f),u.autofocus&&!L||this.hasFocus()?setTimeout(function(){h.hasFocus()&&!h.state.focused&&ay(h)},20):Ml(this);for(var w in of)of.hasOwnProperty(w)&&of[w](this,u[w],Gl);E0(this),u.finishInit&&u.finishInit(this);for(var T=0;T<Ly.length;++T)Ly[T](this);xs(this),c&&u.lineWrapping&&getComputedStyle(S.lineDiv).textRendering=="optimizelegibility"&&(S.lineDiv.style.textRendering="auto")}It.defaults=CT,It.optionHandlers=of;function wN(s){var u=s.display;Ie(u.scroller,"mousedown",ln(s,yT)),o&&l<11?Ie(u.scroller,"dblclick",ln(s,function(k){if(!$t(s,k)){var I=gs(s,k);if(!(!I||Ty(s,k)||Ra(s.display,k))){wn(k);var U=s.findWordAt(I);Qp(s.doc,U.anchor,U.head)}}})):Ie(u.scroller,"dblclick",function(k){return $t(s,k)||wn(k)}),Ie(u.scroller,"contextmenu",function(k){return bT(s,k)}),Ie(u.input.getField(),"contextmenu",function(k){u.scroller.contains(k.target)||bT(s,k)});var h,f={end:0};function g(){u.activeTouch&&(h=setTimeout(function(){return u.activeTouch=null},1e3),f=u.activeTouch,f.end=+new Date)}function S(k){if(k.touches.length!=1)return!1;var I=k.touches[0];return I.radiusX<=1&&I.radiusY<=1}function w(k,I){if(I.left==null)return!0;var U=I.left-k.left,G=I.top-k.top;return U*U+G*G>20*20}Ie(u.scroller,"touchstart",function(k){if(!$t(s,k)&&!S(k)&&!Ty(s,k)){u.input.ensurePolled(),clearTimeout(h);var I=+new Date;u.activeTouch={start:I,moved:!1,prev:I-f.end<=300?f:null},k.touches.length==1&&(u.activeTouch.left=k.touches[0].pageX,u.activeTouch.top=k.touches[0].pageY)}}),Ie(u.scroller,"touchmove",function(){u.activeTouch&&(u.activeTouch.moved=!0)}),Ie(u.scroller,"touchend",function(k){var I=u.activeTouch;if(I&&!Ra(u,k)&&I.left!=null&&!I.moved&&new Date-I.start<300){var U=s.coordsChar(u.activeTouch,"page"),G;!I.prev||w(I,I.prev)?G=new lt(U,U):!I.prev.prev||w(I,I.prev.prev)?G=s.findWordAt(U):G=new lt(oe(U.line,0),ve(s.doc,oe(U.line+1,0))),s.setSelection(G.anchor,G.head),s.focus(),wn(k)}g()}),Ie(u.scroller,"touchcancel",g),Ie(u.scroller,"scroll",function(){u.scroller.clientHeight&&(uu(s,u.scroller.scrollTop),vs(s,u.scroller.scrollLeft,!0),Oe(s,"scroll",s))}),Ie(u.scroller,"mousewheel",function(k){return I0(s,k)}),Ie(u.scroller,"DOMMouseScroll",function(k){return I0(s,k)}),Ie(u.wrapper,"scroll",function(){return u.wrapper.scrollTop=u.wrapper.scrollLeft=0}),u.dragFunctions={enter:function(k){$t(s,k)||ps(k)},over:function(k){$t(s,k)||(ZO(s,k),ps(k))},start:function(k){return QO(s,k)},drop:ln(s,XO),leave:function(k){$t(s,k)||iT(s)}};var T=u.input.getField();Ie(T,"keyup",function(k){return mT.call(s,k)}),Ie(T,"keydown",ln(s,hT)),Ie(T,"keypress",ln(s,gT)),Ie(T,"focus",function(k){return ay(s,k)}),Ie(T,"blur",function(k){return Ml(s,k)})}var Ly=[];It.defineInitHook=function(s){return Ly.push(s)};function Du(s,u,h,f){var g=s.doc,S;h==null&&(h="add"),h=="smart"&&(g.mode.indent?S=nu(s,u).state:h="prev");var w=s.options.tabSize,T=we(g,u),k=ze(T.text,null,w);T.stateAfter&&(T.stateAfter=null);var I=T.text.match(/^\s*/)[0],U;if(!f&&!/\S/.test(T.text))U=0,h="not";else if(h=="smart"&&(U=g.mode.indent(S,T.text.slice(I.length),T.text),U==Fe||U>150)){if(!f)return;h="prev"}h=="prev"?u>g.first?U=ze(we(g,u-1).text,null,w):U=0:h=="add"?U=k+s.options.indentUnit:h=="subtract"?U=k-s.options.indentUnit:typeof h=="number"&&(U=k+h),U=Math.max(0,U);var G="",Y=0;if(s.options.indentWithTabs)for(var q=Math.floor(U/w);q;--q)Y+=w,G+="	";if(Y<U&&(G+=zi(U-Y)),G!=I)return Bl(g,G,oe(u,0),oe(u,I.length),"+input"),T.stateAfter=null,!0;for(var Q=0;Q<g.sel.ranges.length;Q++){var te=g.sel.ranges[Q];if(te.head.line==u&&te.head.ch<I.length){var ue=oe(u,I.length);vy(g,Q,new lt(ue,ue));break}}}var Ci=null;function sf(s){Ci=s}function ky(s,u,h,f,g){var S=s.doc;s.display.shift=!1,f||(f=S.sel);var w=+new Date-200,T=g=="paste"||s.state.pasteIncoming>w,k=Kc(u),I=null;if(T&&f.ranges.length>1)if(Ci&&Ci.text.join(`
`)==u){if(f.ranges.length%Ci.text.length==0){I=[];for(var U=0;U<Ci.text.length;U++)I.push(S.splitLines(Ci.text[U]))}}else k.length==f.ranges.length&&s.options.pasteLinesPerSelection&&(I=Sr(k,function(he){return[he]}));for(var G=s.curOp.updateInput,Y=f.ranges.length-1;Y>=0;Y--){var q=f.ranges[Y],Q=q.from(),te=q.to();q.empty()&&(h&&h>0?Q=oe(Q.line,Q.ch-h):s.state.overwrite&&!T?te=oe(te.line,Math.min(we(S,te.line).text.length,te.ch+Xe(k).length)):T&&Ci&&Ci.lineWise&&Ci.text.join(`
`)==k.join(`
`)&&(Q=te=oe(Q.line,0)));var ue={from:Q,to:te,text:I?I[Y%I.length]:k,origin:g||(T?"paste":s.state.cutIncoming>w?"cut":"+input")};Nl(s.doc,ue),sn(s,"inputRead",s,ue)}u&&!T&&TT(s,u),Rl(s),s.curOp.updateInput<2&&(s.curOp.updateInput=G),s.curOp.typing=!0,s.state.pasteIncoming=s.state.cutIncoming=-1}function wT(s,u){var h=s.clipboardData&&s.clipboardData.getData("Text");if(h)return s.preventDefault(),!u.isReadOnly()&&!u.options.disableInput&&Cr(u,function(){return ky(u,h,0,null,"paste")}),!0}function TT(s,u){if(!(!s.options.electricChars||!s.options.smartIndent))for(var h=s.doc.sel,f=h.ranges.length-1;f>=0;f--){var g=h.ranges[f];if(!(g.head.ch>100||f&&h.ranges[f-1].head.line==g.head.line)){var S=s.getModeAt(g.head),w=!1;if(S.electricChars){for(var T=0;T<S.electricChars.length;T++)if(u.indexOf(S.electricChars.charAt(T))>-1){w=Du(s,g.head.line,"smart");break}}else S.electricInput&&S.electricInput.test(we(s.doc,g.head.line).text.slice(0,g.head.ch))&&(w=Du(s,g.head.line,"smart"));w&&sn(s,"electricInput",s,g.head.line)}}}function LT(s){for(var u=[],h=[],f=0;f<s.doc.sel.ranges.length;f++){var g=s.doc.sel.ranges[f].head.line,S={anchor:oe(g,0),head:oe(g+1,0)};h.push(S),u.push(s.getRange(S.anchor,S.head))}return{text:u,ranges:h}}function kT(s,u,h,f){s.setAttribute("autocorrect",h?"":"off"),s.setAttribute("autocapitalize",f?"":"off"),s.setAttribute("spellcheck",!!u)}function ET(){var s=F("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),u=F("div",[s],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return c?s.style.width="1000px":s.setAttribute("wrap","off"),x&&(s.style.border="1px solid black"),kT(s),u}function TN(s){var u=s.optionHandlers,h=s.helpers={};s.prototype={constructor:s,focus:function(){window.focus(),this.display.input.focus()},setOption:function(f,g){var S=this.options,w=S[f];S[f]==g&&f!="mode"||(S[f]=g,u.hasOwnProperty(f)&&ln(this,u[f])(this,g,w),Oe(this,"optionChange",this,f))},getOption:function(f){return this.options[f]},getDoc:function(){return this.doc},addKeyMap:function(f,g){this.state.keyMaps[g?"push":"unshift"](rf(f))},removeKeyMap:function(f){for(var g=this.state.keyMaps,S=0;S<g.length;++S)if(g[S]==f||g[S].name==f)return g.splice(S,1),!0},addOverlay:Bn(function(f,g){var S=f.token?f:s.getMode(this.options,f);if(S.startState)throw new Error("Overlays may not be stateful.");Hi(this.state.overlays,{mode:S,modeSpec:f,opaque:g&&g.opaque,priority:g&&g.priority||0},function(w){return w.priority}),this.state.modeGen++,rr(this)}),removeOverlay:Bn(function(f){for(var g=this.state.overlays,S=0;S<g.length;++S){var w=g[S].modeSpec;if(w==f||typeof f=="string"&&w.name==f){g.splice(S,1),this.state.modeGen++,rr(this);return}}}),indentLine:Bn(function(f,g,S){typeof g!="string"&&typeof g!="number"&&(g==null?g=this.options.smartIndent?"smart":"prev":g=g?"add":"subtract"),fs(this.doc,f)&&Du(this,f,g,S)}),indentSelection:Bn(function(f){for(var g=this.doc.sel.ranges,S=-1,w=0;w<g.length;w++){var T=g[w];if(T.empty())T.head.line>S&&(Du(this,T.head.line,f,!0),S=T.head.line,w==this.doc.sel.primIndex&&Rl(this));else{var k=T.from(),I=T.to(),U=Math.max(S,k.line);S=Math.min(this.lastLine(),I.line-(I.ch?0:1))+1;for(var G=U;G<S;++G)Du(this,G,f);var Y=this.doc.sel.ranges;k.ch==0&&g.length==Y.length&&Y[w].from().ch>0&&vy(this.doc,w,new lt(k,Y[w].to()),He)}}}),getTokenAt:function(f,g){return Vw(this,f,g)},getLineTokens:function(f,g){return Vw(this,oe(f),g,!0)},getTokenTypeAt:function(f){f=ve(this.doc,f);var g=Mw(this,we(this.doc,f.line)),S=0,w=(g.length-1)/2,T=f.ch,k;if(T==0)k=g[2];else for(;;){var I=S+w>>1;if((I?g[I*2-1]:0)>=T)w=I;else if(g[I*2+1]<T)S=I+1;else{k=g[I*2+2];break}}var U=k?k.indexOf("overlay "):-1;return U<0?k:U==0?null:k.slice(0,U-1)},getModeAt:function(f){var g=this.doc.mode;return g.innerMode?s.innerMode(g,this.getTokenAt(f).state).mode:g},getHelper:function(f,g){return this.getHelpers(f,g)[0]},getHelpers:function(f,g){var S=[];if(!h.hasOwnProperty(g))return S;var w=h[g],T=this.getModeAt(f);if(typeof T[g]=="string")w[T[g]]&&S.push(w[T[g]]);else if(T[g])for(var k=0;k<T[g].length;k++){var I=w[T[g][k]];I&&S.push(I)}else T.helperType&&w[T.helperType]?S.push(w[T.helperType]):w[T.name]&&S.push(w[T.name]);for(var U=0;U<w._global.length;U++){var G=w._global[U];G.pred(T,this)&&ge(S,G.val)==-1&&S.push(G.val)}return S},getStateAfter:function(f,g){var S=this.doc;return f=nt(S,f==null?S.first+S.size-1:f),nu(this,f+1,g).state},cursorCoords:function(f,g){var S,w=this.doc.sel.primary();return f==null?S=w.head:typeof f=="object"?S=ve(this.doc,f):S=f?w.from():w.to(),bi(this,S,g||"page")},charCoords:function(f,g){return Kg(this,ve(this.doc,f),g||"page")},coordsChar:function(f,g){return f=u0(this,f,g||"page"),Qg(this,f.left,f.top)},lineAtHeight:function(f,g){return f=u0(this,{top:f,left:0},g||"page").top,Xi(this.doc,f+this.display.viewOffset)},heightAtLine:function(f,g,S){var w=!1,T;if(typeof f=="number"){var k=this.doc.first+this.doc.size-1;f<this.doc.first?f=this.doc.first:f>k&&(f=k,w=!0),T=we(this.doc,f)}else T=f;return Gp(this,T,{top:0,left:0},g||"page",S||w).top+(w?this.doc.height-Ma(T):0)},defaultTextHeight:function(){return Il(this.display)},defaultCharWidth:function(){return Al(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(f,g,S,w,T){var k=this.display;f=bi(this,ve(this.doc,f));var I=f.bottom,U=f.left;if(g.style.position="absolute",g.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(g),k.sizer.appendChild(g),w=="over")I=f.top;else if(w=="above"||w=="near"){var G=Math.max(k.wrapper.clientHeight,this.doc.height),Y=Math.max(k.sizer.clientWidth,k.lineSpace.clientWidth);(w=="above"||f.bottom+g.offsetHeight>G)&&f.top>g.offsetHeight?I=f.top-g.offsetHeight:f.bottom+g.offsetHeight<=G&&(I=f.bottom),U+g.offsetWidth>Y&&(U=Y-g.offsetWidth)}g.style.top=I+"px",g.style.left=g.style.right="",T=="right"?(U=k.sizer.clientWidth-g.offsetWidth,g.style.right="0px"):(T=="left"?U=0:T=="middle"&&(U=(k.sizer.clientWidth-g.offsetWidth)/2),g.style.left=U+"px"),S&&xO(this,{left:U,top:I,right:U+g.offsetWidth,bottom:I+g.offsetHeight})},triggerOnKeyDown:Bn(hT),triggerOnKeyPress:Bn(gT),triggerOnKeyUp:mT,triggerOnMouseDown:Bn(yT),execCommand:function(f){if(Tu.hasOwnProperty(f))return Tu[f].call(null,this)},triggerElectric:Bn(function(f){TT(this,f)}),findPosH:function(f,g,S,w){var T=1;g<0&&(T=-1,g=-g);for(var k=ve(this.doc,f),I=0;I<g&&(k=Ey(this.doc,k,T,S,w),!k.hitSide);++I);return k},moveH:Bn(function(f,g){var S=this;this.extendSelectionsBy(function(w){return S.display.shift||S.doc.extend||w.empty()?Ey(S.doc,w.head,f,g,S.options.rtlMoveVisually):f<0?w.from():w.to()},Pe)}),deleteH:Bn(function(f,g){var S=this.doc.sel,w=this.doc;S.somethingSelected()?w.replaceSelection("",null,"+delete"):Wl(this,function(T){var k=Ey(w,T.head,f,g,!1);return f<0?{from:k,to:T.head}:{from:T.head,to:k}})}),findPosV:function(f,g,S,w){var T=1,k=w;g<0&&(T=-1,g=-g);for(var I=ve(this.doc,f),U=0;U<g;++U){var G=bi(this,I,"div");if(k==null?k=G.left:G.left=k,I=DT(this,G,T,S),I.hitSide)break}return I},moveV:Bn(function(f,g){var S=this,w=this.doc,T=[],k=!this.display.shift&&!w.extend&&w.sel.somethingSelected();if(w.extendSelectionsBy(function(U){if(k)return f<0?U.from():U.to();var G=bi(S,U.head,"div");U.goalColumn!=null&&(G.left=U.goalColumn),T.push(G.left);var Y=DT(S,G,f,g);return g=="page"&&U==w.sel.primary()&&sy(S,Kg(S,Y,"div").top-G.top),Y},Pe),T.length)for(var I=0;I<w.sel.ranges.length;I++)w.sel.ranges[I].goalColumn=T[I]}),findWordAt:function(f){var g=this.doc,S=we(g,f.line).text,w=f.ch,T=f.ch;if(S){var k=this.getHelper(f,"wordChars");(f.sticky=="before"||T==S.length)&&w?--w:++T;for(var I=S.charAt(w),U=yi(I,k)?function(G){return yi(G,k)}:/\s/.test(I)?function(G){return/\s/.test(G)}:function(G){return!/\s/.test(G)&&!yi(G)};w>0&&U(S.charAt(w-1));)--w;for(;T<S.length&&U(S.charAt(T));)++T}return new lt(oe(f.line,w),oe(f.line,T))},toggleOverwrite:function(f){f!=null&&f==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?ye(this.display.cursorDiv,"CodeMirror-overwrite"):B(this.display.cursorDiv,"CodeMirror-overwrite"),Oe(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==pe()},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:Bn(function(f,g){cu(this,f,g)}),getScrollInfo:function(){var f=this.display.scroller;return{left:f.scrollLeft,top:f.scrollTop,height:f.scrollHeight-ea(this)-this.display.barHeight,width:f.scrollWidth-ea(this)-this.display.barWidth,clientHeight:Jg(this),clientWidth:hs(this)}},scrollIntoView:Bn(function(f,g){f==null?(f={from:this.doc.sel.primary().head,to:null},g==null&&(g=this.options.cursorScrollMargin)):typeof f=="number"?f={from:oe(f,0),to:null}:f.from==null&&(f={from:f,to:null}),f.to||(f.to=f.from),f.margin=g||0,f.from.line!=null?CO(this,f):b0(this,f.from,f.to,f.margin)}),setSize:Bn(function(f,g){var S=this,w=function(k){return typeof k=="number"||/^\d+$/.test(String(k))?k+"px":k};f!=null&&(this.display.wrapper.style.width=w(f)),g!=null&&(this.display.wrapper.style.height=w(g)),this.options.lineWrapping&&s0(this);var T=this.display.viewFrom;this.doc.iter(T,this.display.viewTo,function(k){if(k.widgets){for(var I=0;I<k.widgets.length;I++)if(k.widgets[I].noHScroll){go(S,T,"widget");break}}++T}),this.curOp.forceUpdate=!0,Oe(this,"refresh",this)}),operation:function(f){return Cr(this,f)},startOperation:function(){return bs(this)},endOperation:function(){return xs(this)},refresh:Bn(function(){var f=this.display.cachedTextHeight;rr(this),this.curOp.forceUpdate=!0,su(this),cu(this,this.doc.scrollLeft,this.doc.scrollTop),uy(this.display),(f==null||Math.abs(f-Il(this.display))>.5||this.options.lineWrapping)&&ny(this),Oe(this,"refresh",this)}),swapDoc:Bn(function(f){var g=this.doc;return g.cm=null,this.state.selectingText&&this.state.selectingText(),_0(this,f),su(this),this.display.input.reset(),cu(this,f.scrollLeft,f.scrollTop),this.curOp.forceScroll=!0,sn(this,"swapDoc",this,g),g}),phrase:function(f){var g=this.options.phrases;return g&&Object.prototype.hasOwnProperty.call(g,f)?g[f]:f},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},qi(s),s.registerHelper=function(f,g,S){h.hasOwnProperty(f)||(h[f]=s[f]={_global:[]}),h[f][g]=S},s.registerGlobalHelper=function(f,g,S,w){s.registerHelper(f,g,w),h[f]._global.push({pred:S,val:w})}}function Ey(s,u,h,f,g){var S=u,w=h,T=we(s,u.line),k=g&&s.direction=="rtl"?-h:h;function I(){var Se=u.line+k;return Se<s.first||Se>=s.first+s.size?!1:(u=new oe(Se,u.ch,u.sticky),T=we(s,Se))}function U(Se){var me;if(f=="codepoint"){var xe=T.text.charCodeAt(u.ch+(h>0?0:-1));if(isNaN(xe))me=null;else{var De=h>0?xe>=55296&&xe<56320:xe>=56320&&xe<57343;me=new oe(u.line,Math.max(0,Math.min(T.text.length,u.ch+h*(De?2:1))),-h)}}else g?me=aN(s.cm,T,u,h):me=by(T,u,h);if(me==null)if(!Se&&I())u=xy(g,s.cm,T,u.line,k);else return!1;else u=me;return!0}if(f=="char"||f=="codepoint")U();else if(f=="column")U(!0);else if(f=="word"||f=="group")for(var G=null,Y=f=="group",q=s.cm&&s.cm.getHelper(u,"wordChars"),Q=!0;!(h<0&&!U(!Q));Q=!1){var te=T.text.charAt(u.ch)||`
`,ue=yi(te,q)?"w":Y&&te==`
`?"n":!Y||/\s/.test(te)?null:"p";if(Y&&!Q&&!ue&&(ue="s"),G&&G!=ue){h<0&&(h=1,U(),u.sticky="after");break}if(ue&&(G=ue),h>0&&!U(!Q))break}var he=ef(s,u,S,w,!0);return H(S,he)&&(he.hitSide=!0),he}function DT(s,u,h,f){var g=s.doc,S=u.left,w;if(f=="page"){var T=Math.min(s.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),k=Math.max(T-.5*Il(s.display),3);w=(h>0?u.bottom:u.top)+h*k}else f=="line"&&(w=h>0?u.bottom+3:u.top-3);for(var I;I=Qg(s,S,w),!!I.outside;){if(h<0?w<=0:w>=g.height){I.hitSide=!0;break}w+=h*5}return I}var ft=function(s){this.cm=s,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new tt,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};ft.prototype.init=function(s){var u=this,h=this,f=h.cm,g=h.div=s.lineDiv;g.contentEditable=!0,kT(g,f.options.spellcheck,f.options.autocorrect,f.options.autocapitalize);function S(T){for(var k=T.target;k;k=k.parentNode){if(k==g)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(k.className))break}return!1}Ie(g,"paste",function(T){!S(T)||$t(f,T)||wT(T,f)||l<=11&&setTimeout(ln(f,function(){return u.updateFromDOM()}),20)}),Ie(g,"compositionstart",function(T){u.composing={data:T.data,done:!1}}),Ie(g,"compositionupdate",function(T){u.composing||(u.composing={data:T.data,done:!1})}),Ie(g,"compositionend",function(T){u.composing&&(T.data!=u.composing.data&&u.readFromDOMSoon(),u.composing.done=!0)}),Ie(g,"touchstart",function(){return h.forceCompositionEnd()}),Ie(g,"input",function(){u.composing||u.readFromDOMSoon()});function w(T){if(!(!S(T)||$t(f,T))){if(f.somethingSelected())sf({lineWise:!1,text:f.getSelections()}),T.type=="cut"&&f.replaceSelection("",null,"cut");else if(f.options.lineWiseCopyCut){var k=LT(f);sf({lineWise:!0,text:k.text}),T.type=="cut"&&f.operation(function(){f.setSelections(k.ranges,0,He),f.replaceSelection("",null,"cut")})}else return;if(T.clipboardData){T.clipboardData.clearData();var I=Ci.text.join(`
`);if(T.clipboardData.setData("Text",I),T.clipboardData.getData("Text")==I){T.preventDefault();return}}var U=ET(),G=U.firstChild;f.display.lineSpace.insertBefore(U,f.display.lineSpace.firstChild),G.value=Ci.text.join(`
`);var Y=pe();fe(G),setTimeout(function(){f.display.lineSpace.removeChild(U),Y.focus(),Y==g&&h.showPrimarySelection()},50)}}Ie(g,"copy",w),Ie(g,"cut",w)},ft.prototype.screenReaderLabelChanged=function(s){s?this.div.setAttribute("aria-label",s):this.div.removeAttribute("aria-label")},ft.prototype.prepareSelection=function(){var s=g0(this.cm,!1);return s.focus=pe()==this.div,s},ft.prototype.showSelection=function(s,u){!s||!this.cm.display.view.length||((s.focus||u)&&this.showPrimarySelection(),this.showMultipleSelections(s))},ft.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},ft.prototype.showPrimarySelection=function(){var s=this.getSelection(),u=this.cm,h=u.doc.sel.primary(),f=h.from(),g=h.to();if(u.display.viewTo==u.display.viewFrom||f.line>=u.display.viewTo||g.line<u.display.viewFrom){s.removeAllRanges();return}var S=lf(u,s.anchorNode,s.anchorOffset),w=lf(u,s.focusNode,s.focusOffset);if(!(S&&!S.bad&&w&&!w.bad&&M(Ne(S,w),f)==0&&M(se(S,w),g)==0)){var T=u.display.view,k=f.line>=u.display.viewFrom&&PT(u,f)||{node:T[0].measure.map[2],offset:0},I=g.line<u.display.viewTo&&PT(u,g);if(!I){var U=T[T.length-1].measure,G=U.maps?U.maps[U.maps.length-1]:U.map;I={node:G[G.length-1],offset:G[G.length-2]-G[G.length-3]}}if(!k||!I){s.removeAllRanges();return}var Y=s.rangeCount&&s.getRangeAt(0),q;try{q=J(k.node,k.offset,I.offset,I.node)}catch(Q){}q&&(!t&&u.state.focused?(s.collapse(k.node,k.offset),q.collapsed||(s.removeAllRanges(),s.addRange(q))):(s.removeAllRanges(),s.addRange(q)),Y&&s.anchorNode==null?s.addRange(Y):t&&this.startGracePeriod()),this.rememberSelection()}},ft.prototype.startGracePeriod=function(){var s=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){s.gracePeriod=!1,s.selectionChanged()&&s.cm.operation(function(){return s.cm.curOp.selectionChanged=!0})},20)},ft.prototype.showMultipleSelections=function(s){_(this.cm.display.cursorDiv,s.cursors),_(this.cm.display.selectionDiv,s.selection)},ft.prototype.rememberSelection=function(){var s=this.getSelection();this.lastAnchorNode=s.anchorNode,this.lastAnchorOffset=s.anchorOffset,this.lastFocusNode=s.focusNode,this.lastFocusOffset=s.focusOffset},ft.prototype.selectionInEditor=function(){var s=this.getSelection();if(!s.rangeCount)return!1;var u=s.getRangeAt(0).commonAncestorContainer;return re(this.div,u)},ft.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||pe()!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},ft.prototype.blur=function(){this.div.blur()},ft.prototype.getField=function(){return this.div},ft.prototype.supportsTouch=function(){return!0},ft.prototype.receivedFocus=function(){var s=this;this.selectionInEditor()?this.pollSelection():Cr(this.cm,function(){return s.cm.curOp.selectionChanged=!0});function u(){s.cm.state.focused&&(s.pollSelection(),s.polling.set(s.cm.options.pollInterval,u))}this.polling.set(this.cm.options.pollInterval,u)},ft.prototype.selectionChanged=function(){var s=this.getSelection();return s.anchorNode!=this.lastAnchorNode||s.anchorOffset!=this.lastAnchorOffset||s.focusNode!=this.lastFocusNode||s.focusOffset!=this.lastFocusOffset},ft.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var s=this.getSelection(),u=this.cm;if(C&&p&&this.cm.display.gutterSpecs.length&&LN(s.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var h=lf(u,s.anchorNode,s.anchorOffset),f=lf(u,s.focusNode,s.focusOffset);h&&f&&Cr(u,function(){Ln(u.doc,vo(h,f),He),(h.bad||f.bad)&&(u.curOp.selectionChanged=!0)})}}},ft.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var s=this.cm,u=s.display,h=s.doc.sel.primary(),f=h.from(),g=h.to();if(f.ch==0&&f.line>s.firstLine()&&(f=oe(f.line-1,we(s.doc,f.line-1).length)),g.ch==we(s.doc,g.line).text.length&&g.line<s.lastLine()&&(g=oe(g.line+1,0)),f.line<u.viewFrom||g.line>u.viewTo-1)return!1;var S,w,T;f.line==u.viewFrom||(S=ys(s,f.line))==0?(w=st(u.view[0].line),T=u.view[0].node):(w=st(u.view[S].line),T=u.view[S-1].node.nextSibling);var k=ys(s,g.line),I,U;if(k==u.view.length-1?(I=u.viewTo-1,U=u.lineDiv.lastChild):(I=st(u.view[k+1].line)-1,U=u.view[k+1].node.previousSibling),!T)return!1;for(var G=s.doc.splitLines(kN(s,T,U,w,I)),Y=Ki(s.doc,oe(w,0),oe(I,we(s.doc,I).text.length));G.length>1&&Y.length>1;)if(Xe(G)==Xe(Y))G.pop(),Y.pop(),I--;else if(G[0]==Y[0])G.shift(),Y.shift(),w++;else break;for(var q=0,Q=0,te=G[0],ue=Y[0],he=Math.min(te.length,ue.length);q<he&&te.charCodeAt(q)==ue.charCodeAt(q);)++q;for(var Se=Xe(G),me=Xe(Y),xe=Math.min(Se.length-(G.length==1?q:0),me.length-(Y.length==1?q:0));Q<xe&&Se.charCodeAt(Se.length-Q-1)==me.charCodeAt(me.length-Q-1);)++Q;if(G.length==1&&Y.length==1&&w==f.line)for(;q&&q>f.ch&&Se.charCodeAt(Se.length-Q-1)==me.charCodeAt(me.length-Q-1);)q--,Q++;G[G.length-1]=Se.slice(0,Se.length-Q).replace(/^\u200b+/,""),G[0]=G[0].slice(q).replace(/\u200b+$/,"");var De=oe(w,q),ke=oe(I,Y.length?Xe(Y).length-Q:0);if(G.length>1||G[0]||M(De,ke))return Bl(s.doc,G,De,ke,"+input"),!0},ft.prototype.ensurePolled=function(){this.forceCompositionEnd()},ft.prototype.reset=function(){this.forceCompositionEnd()},ft.prototype.forceCompositionEnd=function(){!this.composing||(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},ft.prototype.readFromDOMSoon=function(){var s=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(s.readDOMTimeout=null,s.composing)if(s.composing.done)s.composing=null;else return;s.updateFromDOM()},80))},ft.prototype.updateFromDOM=function(){var s=this;(this.cm.isReadOnly()||!this.pollContent())&&Cr(this.cm,function(){return rr(s.cm)})},ft.prototype.setUneditable=function(s){s.contentEditable="false"},ft.prototype.onKeyPress=function(s){s.charCode==0||this.composing||(s.preventDefault(),this.cm.isReadOnly()||ln(this.cm,ky)(this.cm,String.fromCharCode(s.charCode==null?s.keyCode:s.charCode),0))},ft.prototype.readOnlyChanged=function(s){this.div.contentEditable=String(s!="nocursor")},ft.prototype.onContextMenu=function(){},ft.prototype.resetPosition=function(){},ft.prototype.needsContentAttribute=!0;function PT(s,u){var h=qg(s,u.line);if(!h||h.hidden)return null;var f=we(s.doc,u.line),g=n0(h,f,u.line),S=br(f,s.doc.direction),w="left";if(S){var T=bt(S,u.ch);w=T%2?"right":"left"}var k=a0(g.map,u.ch,w);return k.offset=k.collapse=="right"?k.end:k.start,k}function LN(s){for(var u=s;u;u=u.parentNode)if(/CodeMirror-gutter-wrapper/.test(u.className))return!0;return!1}function zl(s,u){return u&&(s.bad=!0),s}function kN(s,u,h,f,g){var S="",w=!1,T=s.doc.lineSeparator(),k=!1;function I(q){return function(Q){return Q.id==q}}function U(){w&&(S+=T,k&&(S+=T),w=k=!1)}function G(q){q&&(U(),S+=q)}function Y(q){if(q.nodeType==1){var Q=q.getAttribute("cm-text");if(Q){G(Q);return}var te=q.getAttribute("cm-marker"),ue;if(te){var he=s.findMarks(oe(f,0),oe(g+1,0),I(+te));he.length&&(ue=he[0].find(0))&&G(Ki(s.doc,ue.from,ue.to).join(T));return}if(q.getAttribute("contenteditable")=="false")return;var Se=/^(pre|div|p|li|table|br)$/i.test(q.nodeName);if(!/^br$/i.test(q.nodeName)&&q.textContent.length==0)return;Se&&U();for(var me=0;me<q.childNodes.length;me++)Y(q.childNodes[me]);/^(pre|p)$/i.test(q.nodeName)&&(k=!0),Se&&(w=!0)}else q.nodeType==3&&G(q.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;Y(u),u!=h;)u=u.nextSibling,k=!1;return S}function lf(s,u,h){var f;if(u==s.display.lineDiv){if(f=s.display.lineDiv.childNodes[h],!f)return zl(s.clipPos(oe(s.display.viewTo-1)),!0);u=null,h=0}else for(f=u;;f=f.parentNode){if(!f||f==s.display.lineDiv)return null;if(f.parentNode&&f.parentNode==s.display.lineDiv)break}for(var g=0;g<s.display.view.length;g++){var S=s.display.view[g];if(S.node==f)return EN(S,u,h)}}function EN(s,u,h){var f=s.text.firstChild,g=!1;if(!u||!re(f,u))return zl(oe(st(s.line),0),!0);if(u==f&&(g=!0,u=f.childNodes[h],h=0,!u)){var S=s.rest?Xe(s.rest):s.line;return zl(oe(st(S),S.text.length),g)}var w=u.nodeType==3?u:null,T=u;for(!w&&u.childNodes.length==1&&u.firstChild.nodeType==3&&(w=u.firstChild,h&&(h=w.nodeValue.length));T.parentNode!=f;)T=T.parentNode;var k=s.measure,I=k.maps;function U(ue,he,Se){for(var me=-1;me<(I?I.length:0);me++)for(var xe=me<0?k.map:I[me],De=0;De<xe.length;De+=3){var ke=xe[De+2];if(ke==ue||ke==he){var qe=st(me<0?s.line:s.rest[me]),vt=xe[De]+Se;return(Se<0||ke!=ue)&&(vt=xe[De+(Se?1:0)]),oe(qe,vt)}}}var G=U(w,T,h);if(G)return zl(G,g);for(var Y=T.nextSibling,q=w?w.nodeValue.length-h:0;Y;Y=Y.nextSibling){if(G=U(Y,Y.firstChild,0),G)return zl(oe(G.line,G.ch-q),g);q+=Y.textContent.length}for(var Q=T.previousSibling,te=h;Q;Q=Q.previousSibling){if(G=U(Q,Q.firstChild,-1),G)return zl(oe(G.line,G.ch+te),g);te+=Q.textContent.length}}var zt=function(s){this.cm=s,this.prevInput="",this.pollingFast=!1,this.polling=new tt,this.hasSelection=!1,this.composing=null};zt.prototype.init=function(s){var u=this,h=this,f=this.cm;this.createField(s);var g=this.textarea;s.wrapper.insertBefore(this.wrapper,s.wrapper.firstChild),x&&(g.style.width="0px"),Ie(g,"input",function(){o&&l>=9&&u.hasSelection&&(u.hasSelection=null),h.poll()}),Ie(g,"paste",function(w){$t(f,w)||wT(w,f)||(f.state.pasteIncoming=+new Date,h.fastPoll())});function S(w){if(!$t(f,w)){if(f.somethingSelected())sf({lineWise:!1,text:f.getSelections()});else if(f.options.lineWiseCopyCut){var T=LT(f);sf({lineWise:!0,text:T.text}),w.type=="cut"?f.setSelections(T.ranges,null,He):(h.prevInput="",g.value=T.text.join(`
`),fe(g))}else return;w.type=="cut"&&(f.state.cutIncoming=+new Date)}}Ie(g,"cut",S),Ie(g,"copy",S),Ie(s.scroller,"paste",function(w){if(!(Ra(s,w)||$t(f,w))){if(!g.dispatchEvent){f.state.pasteIncoming=+new Date,h.focus();return}var T=new Event("paste");T.clipboardData=w.clipboardData,g.dispatchEvent(T)}}),Ie(s.lineSpace,"selectstart",function(w){Ra(s,w)||wn(w)}),Ie(g,"compositionstart",function(){var w=f.getCursor("from");h.composing&&h.composing.range.clear(),h.composing={start:w,range:f.markText(w,f.getCursor("to"),{className:"CodeMirror-composing"})}}),Ie(g,"compositionend",function(){h.composing&&(h.poll(),h.composing.range.clear(),h.composing=null)})},zt.prototype.createField=function(s){this.wrapper=ET(),this.textarea=this.wrapper.firstChild},zt.prototype.screenReaderLabelChanged=function(s){s?this.textarea.setAttribute("aria-label",s):this.textarea.removeAttribute("aria-label")},zt.prototype.prepareSelection=function(){var s=this.cm,u=s.display,h=s.doc,f=g0(s);if(s.options.moveInputWithCursor){var g=bi(s,h.sel.primary().head,"div"),S=u.wrapper.getBoundingClientRect(),w=u.lineDiv.getBoundingClientRect();f.teTop=Math.max(0,Math.min(u.wrapper.clientHeight-10,g.top+w.top-S.top)),f.teLeft=Math.max(0,Math.min(u.wrapper.clientWidth-10,g.left+w.left-S.left))}return f},zt.prototype.showSelection=function(s){var u=this.cm,h=u.display;_(h.cursorDiv,s.cursors),_(h.selectionDiv,s.selection),s.teTop!=null&&(this.wrapper.style.top=s.teTop+"px",this.wrapper.style.left=s.teLeft+"px")},zt.prototype.reset=function(s){if(!(this.contextMenuPending||this.composing)){var u=this.cm;if(u.somethingSelected()){this.prevInput="";var h=u.getSelection();this.textarea.value=h,u.state.focused&&fe(this.textarea),o&&l>=9&&(this.hasSelection=h)}else s||(this.prevInput=this.textarea.value="",o&&l>=9&&(this.hasSelection=null))}},zt.prototype.getField=function(){return this.textarea},zt.prototype.supportsTouch=function(){return!1},zt.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!L||pe()!=this.textarea))try{this.textarea.focus()}catch(s){}},zt.prototype.blur=function(){this.textarea.blur()},zt.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},zt.prototype.receivedFocus=function(){this.slowPoll()},zt.prototype.slowPoll=function(){var s=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){s.poll(),s.cm.state.focused&&s.slowPoll()})},zt.prototype.fastPoll=function(){var s=!1,u=this;u.pollingFast=!0;function h(){var f=u.poll();!f&&!s?(s=!0,u.polling.set(60,h)):(u.pollingFast=!1,u.slowPoll())}u.polling.set(20,h)},zt.prototype.poll=function(){var s=this,u=this.cm,h=this.textarea,f=this.prevInput;if(this.contextMenuPending||!u.state.focused||Mp(h)&&!f&&!this.composing||u.isReadOnly()||u.options.disableInput||u.state.keySeq)return!1;var g=h.value;if(g==f&&!u.somethingSelected())return!1;if(o&&l>=9&&this.hasSelection===g||A&&/[\uf700-\uf7ff]/.test(g))return u.display.input.reset(),!1;if(u.doc.sel==u.display.selForContextMenu){var S=g.charCodeAt(0);if(S==8203&&!f&&(f="\u200B"),S==8666)return this.reset(),this.cm.execCommand("undo")}for(var w=0,T=Math.min(f.length,g.length);w<T&&f.charCodeAt(w)==g.charCodeAt(w);)++w;return Cr(u,function(){ky(u,g.slice(w),f.length-w,null,s.composing?"*compose":null),g.length>1e3||g.indexOf(`
`)>-1?h.value=s.prevInput="":s.prevInput=g,s.composing&&(s.composing.range.clear(),s.composing.range=u.markText(s.composing.start,u.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},zt.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},zt.prototype.onKeyPress=function(){o&&l>=9&&(this.hasSelection=null),this.fastPoll()},zt.prototype.onContextMenu=function(s){var u=this,h=u.cm,f=h.display,g=u.textarea;u.contextMenuPending&&u.contextMenuPending();var S=gs(h,s),w=f.scroller.scrollTop;if(!S||m)return;var T=h.options.resetSelectionOnContextMenu;T&&h.doc.sel.contains(S)==-1&&ln(h,Ln)(h.doc,vo(S),He);var k=g.style.cssText,I=u.wrapper.style.cssText,U=u.wrapper.offsetParent.getBoundingClientRect();u.wrapper.style.cssText="position: static",g.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(s.clientY-U.top-5)+"px; left: "+(s.clientX-U.left-5)+`px;
      z-index: 1000; background: `+(o?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var G;c&&(G=window.scrollY),f.input.focus(),c&&window.scrollTo(null,G),f.input.reset(),h.somethingSelected()||(g.value=u.prevInput=" "),u.contextMenuPending=q,f.selForContextMenu=h.doc.sel,clearTimeout(f.detectingSelectAll);function Y(){if(g.selectionStart!=null){var te=h.somethingSelected(),ue="\u200B"+(te?g.value:"");g.value="\u21DA",g.value=ue,u.prevInput=te?"":"\u200B",g.selectionStart=1,g.selectionEnd=ue.length,f.selForContextMenu=h.doc.sel}}function q(){if(u.contextMenuPending==q&&(u.contextMenuPending=!1,u.wrapper.style.cssText=I,g.style.cssText=k,o&&l<9&&f.scrollbars.setScrollTop(f.scroller.scrollTop=w),g.selectionStart!=null)){(!o||o&&l<9)&&Y();var te=0,ue=function(){f.selForContextMenu==h.doc.sel&&g.selectionStart==0&&g.selectionEnd>0&&u.prevInput=="\u200B"?ln(h,J0)(h):te++<10?f.detectingSelectAll=setTimeout(ue,500):(f.selForContextMenu=null,f.input.reset())};f.detectingSelectAll=setTimeout(ue,200)}}if(o&&l>=9&&Y(),V){ps(s);var Q=function(){tr(window,"mouseup",Q),setTimeout(q,20)};Ie(window,"mouseup",Q)}else setTimeout(q,50)},zt.prototype.readOnlyChanged=function(s){s||this.reset(),this.textarea.disabled=s=="nocursor",this.textarea.readOnly=!!s},zt.prototype.setUneditable=function(){},zt.prototype.needsContentAttribute=!1;function DN(s,u){if(u=u?Ge(u):{},u.value=s.value,!u.tabindex&&s.tabIndex&&(u.tabindex=s.tabIndex),!u.placeholder&&s.placeholder&&(u.placeholder=s.placeholder),u.autofocus==null){var h=pe();u.autofocus=h==s||s.getAttribute("autofocus")!=null&&h==document.body}function f(){s.value=T.getValue()}var g;if(s.form&&(Ie(s.form,"submit",f),!u.leaveSubmitMethodAlone)){var S=s.form;g=S.submit;try{var w=S.submit=function(){f(),S.submit=g,S.submit(),S.submit=w}}catch(k){}}u.finishInit=function(k){k.save=f,k.getTextArea=function(){return s},k.toTextArea=function(){k.toTextArea=isNaN,f(),s.parentNode.removeChild(k.getWrapperElement()),s.style.display="",s.form&&(tr(s.form,"submit",f),!u.leaveSubmitMethodAlone&&typeof s.form.submit=="function"&&(s.form.submit=g))}},s.style.display="none";var T=It(function(k){return s.parentNode.insertBefore(k,s.nextSibling)},u);return T}function PN(s){s.off=tr,s.on=Ie,s.wheelEventPixels=OO,s.Doc=ir,s.splitLines=Kc,s.countColumn=ze,s.findColumn=at,s.isWordChar=Zr,s.Pass=Fe,s.signal=Oe,s.Line=El,s.changeEnd=So,s.scrollbarModel=w0,s.Pos=oe,s.cmpPos=M,s.modes=ei,s.mimeModes=Rr,s.resolveMode=Tl,s.getMode=Ll,s.modeExtensions=vi,s.extendMode=Si,s.copyState=_r,s.startState=Zc,s.innerMode=Qc,s.commands=Tu,s.keyMap=_a,s.keyName=cT,s.isModifierKey=sT,s.lookupKey=Ul,s.normalizeKeyMap=iN,s.StringStream=Ot,s.SharedTextMarker=xu,s.TextMarker=xo,s.LineWidget=bu,s.e_preventDefault=wn,s.e_stopPropagation=wl,s.e_stop=ps,s.addClass=ye,s.contains=re,s.rmClass=B,s.keyNames=Co}bN(It),TN(It);var IN="iter insert remove copy getEditor constructor".split(" ");for(var cf in ir.prototype)ir.prototype.hasOwnProperty(cf)&&ge(IN,cf)<0&&(It.prototype[cf]=function(s){return function(){return s.apply(this.doc,arguments)}}(ir.prototype[cf]));return qi(ir),It.inputStyles={textarea:zt,contenteditable:ft},It.defineMode=function(s){!It.defaults.mode&&s!="null"&&(It.defaults.mode=s),_p.apply(this,arguments)},It.defineMIME=Ia,It.defineMode("null",function(){return{token:function(s){return s.skipToEnd()}}}),It.defineMIME("text/plain","null"),It.defineExtension=function(s,u){It.prototype[s]=u},It.defineDocExtension=function(s,u){ir.prototype[s]=u},It.fromTextArea=DN,PN(It),It.version="5.61.1",It})});var TR=Ht((CR,wR)=>{(function(n){typeof CR=="object"&&typeof wR=="object"?n(is()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";var e="CodeMirror-lint-markers";function t(D,R,P){var E=document.createElement("div");E.className="CodeMirror-lint-tooltip cm-s-"+D.options.theme,E.appendChild(P.cloneNode(!0)),D.state.lint.options.selfContain?D.getWrapperElement().appendChild(E):document.body.appendChild(E);function V(O){if(!E.parentNode)return n.off(document,"mousemove",V);E.style.top=Math.max(0,O.clientY-E.offsetHeight-5)+"px",E.style.left=O.clientX+5+"px"}return n.on(document,"mousemove",V),V(R),E.style.opacity!=null&&(E.style.opacity=1),E}function r(D){D.parentNode&&D.parentNode.removeChild(D)}function i(D){!D.parentNode||(D.style.opacity==null&&r(D),D.style.opacity=0,setTimeout(function(){r(D)},600))}function a(D,R,P,E){var V=t(D,R,P);function O(){n.off(E,"mouseout",O),V&&(i(V),V=null)}var B=setInterval(function(){if(V)for(var W=E;;W=W.parentNode){if(W&&W.nodeType==11&&(W=W.host),W==document.body)return;if(!W){O();break}}if(!V)return clearInterval(B)},400);n.on(E,"mouseout",O)}function o(D,R,P){this.marked=[],this.options=R,this.timeout=null,this.hasGutter=P,this.onMouseOver=function(E){A(D,E)},this.waitingFor=0}function l(D,R){return R instanceof Function?{getAnnotations:R}:((!R||R===!0)&&(R={}),R)}function c(D){var R=D.state.lint;R.hasGutter&&D.clearGutter(e);for(var P=0;P<R.marked.length;++P)R.marked[P].clear();R.marked.length=0}function d(D,R,P,E,V){var O=document.createElement("div"),B=O;return O.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+P,E&&(B=O.appendChild(document.createElement("div")),B.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),V!=!1&&n.on(B,"mouseover",function(W){a(D,W,R,B)}),O}function p(D,R){return D=="error"?D:R}function m(D){for(var R=[],P=0;P<D.length;++P){var E=D[P],V=E.from.line;(R[V]||(R[V]=[])).push(E)}return R}function y(D){var R=D.severity;R||(R="error");var P=document.createElement("div");return P.className="CodeMirror-lint-message CodeMirror-lint-message-"+R,typeof D.messageHTML!="undefined"?P.innerHTML=D.messageHTML:P.appendChild(document.createTextNode(D.message)),P}function v(D,R,P){var E=D.state.lint,V=++E.waitingFor;function O(){V=-1,D.off("change",O)}D.on("change",O),R(D.getValue(),function(B,W){D.off("change",O),E.waitingFor==V&&(W&&B instanceof n&&(B=W),D.operation(function(){x(D,B)}))},P,D)}function b(D){var R=D.state.lint,P=R.options,E=P.options||P,V=P.getAnnotations||D.getHelper(n.Pos(0,0),"lint");if(!!V)if(P.async||V.async)v(D,V,E);else{var O=V(D.getValue(),E,D);if(!O)return;O.then?O.then(function(B){D.operation(function(){x(D,B)})}):D.operation(function(){x(D,O)})}}function x(D,R){c(D);for(var P=D.state.lint,E=P.options,V=m(R),O=0;O<V.length;++O){var B=V[O];if(!!B){var W=[];B=B.filter(function(pe){return W.indexOf(pe.message)>-1?!1:W.push(pe.message)});for(var _=null,F=P.hasGutter&&document.createDocumentFragment(),N=0;N<B.length;++N){var J=B[N],re=J.severity;re||(re="error"),_=p(_,re),E.formatAnnotation&&(J=E.formatAnnotation(J)),P.hasGutter&&F.appendChild(y(J)),J.to&&P.marked.push(D.markText(J.from,J.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+re,__annotation:J}))}P.hasGutter&&D.setGutterMarker(O,e,d(D,F,_,V[O].length>1,P.options.tooltips))}}E.onUpdateLinting&&E.onUpdateLinting(R,V,D)}function C(D){var R=D.state.lint;!R||(clearTimeout(R.timeout),R.timeout=setTimeout(function(){b(D)},R.options.delay||500))}function L(D,R,P){for(var E=P.target||P.srcElement,V=document.createDocumentFragment(),O=0;O<R.length;O++){var B=R[O];V.appendChild(y(B))}a(D,P,V,E)}function A(D,R){var P=R.target||R.srcElement;if(!!/\bCodeMirror-lint-mark-/.test(P.className)){for(var E=P.getBoundingClientRect(),V=(E.left+E.right)/2,O=(E.top+E.bottom)/2,B=D.findMarksAt(D.coordsChar({left:V,top:O},"client")),W=[],_=0;_<B.length;++_){var F=B[_].__annotation;F&&W.push(F)}W.length&&L(D,W,R)}}n.defineOption("lint",!1,function(D,R,P){if(P&&P!=n.Init&&(c(D),D.state.lint.options.lintOnChange!==!1&&D.off("change",C),n.off(D.getWrapperElement(),"mouseover",D.state.lint.onMouseOver),clearTimeout(D.state.lint.timeout),delete D.state.lint),R){for(var E=D.getOption("gutters"),V=!1,O=0;O<E.length;++O)E[O]==e&&(V=!0);var B=D.state.lint=new o(D,l(D,R),V);B.options.lintOnChange!==!1&&D.on("change",C),B.options.tooltips!=!1&&B.options.tooltips!="gutter"&&n.on(D.getWrapperElement(),"mouseover",B.onMouseOver),b(D)}}),n.defineExtension("performLint",function(){this.state.lint&&b(this)})})});var kR=Ht((mbe,LR)=>{LR.exports=function(n){n.defineMode("glsl",function(a,o){var l=a.indentUnit,c=o.keywords||e(t),d=o.builtins||e(r),p=o.blockKeywords||e("case do else for if switch while struct"),m=o.atoms||e("null"),y=o.hooks||{},v=o.multiLineStrings,b=/[+\-*&%=<>!?|\/]/,x;function C(E,V){var O=E.next();if(y[O]){var B=y[O](E,V);if(B!==!1)return B}if(O=='"'||O=="'")return V.tokenize=L(O),V.tokenize(E,V);if(/[\[\]{}\(\),;\:\.]/.test(O))return x=O,"bracket";if(/\d/.test(O))return E.eatWhile(/[\w\.]/),"number";if(O=="/"){if(E.eat("*"))return V.tokenize=A,A(E,V);if(E.eat("/"))return E.skipToEnd(),"comment"}if(O=="#")return E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),"comment";if(b.test(O))return E.eatWhile(b),"operator";E.eatWhile(/[\w\$_]/);var W=E.current();return c.propertyIsEnumerable(W)?(p.propertyIsEnumerable(W)&&(x="newstatement"),"keyword"):d.propertyIsEnumerable(W)?"builtin":m.propertyIsEnumerable(W)?"atom":"word"}function L(E){return function(V,O){for(var B=!1,W,_=!1;(W=V.next())!=null;){if(W==E&&!B){_=!0;break}B=!B&&W=="\\"}return(_||!(B||v))&&(O.tokenize=C),"string"}}function A(E,V){for(var O=!1,B;B=E.next();){if(B=="/"&&O){V.tokenize=C;break}O=B=="*"}return"comment"}function D(E,V,O,B,W){this.indented=E,this.column=V,this.type=O,this.align=B,this.prev=W}function R(E,V,O){return E.context=new D(E.indented,V,O,null,E.context)}function P(E){var V=E.context.type;return(V==")"||V=="]"||V=="}")&&(E.indented=E.context.indented),E.context=E.context.prev}return{startState:function(E){return{tokenize:null,context:new D((E||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(E,V){var O=V.context;if(E.sol()&&(O.align==null&&(O.align=!1),V.indented=E.indentation(),V.startOfLine=!0),E.eatSpace())return null;x=null;var B=(V.tokenize||C)(E,V);if(B=="comment"||B=="meta")return B;if(O.align==null&&(O.align=!0),(x==";"||x==":")&&O.type=="statement")P(V);else if(x=="{")R(V,E.column(),"}");else if(x=="[")R(V,E.column(),"]");else if(x=="(")R(V,E.column(),")");else if(x=="}"){for(;O.type=="statement";)O=P(V);for(O.type=="}"&&(O=P(V));O.type=="statement";)O=P(V)}else x==O.type?P(V):(O.type=="}"||O.type=="top"||O.type=="statement"&&x=="newstatement")&&R(V,E.column(),"statement");return V.startOfLine=!1,B},indent:function(E,V){if(E.tokenize!=C&&E.tokenize!=null)return 0;var O=V&&V.charAt(0),B=E.context,W=O==B.type;return B.type=="statement"?B.indented+(O=="{"?0:l):B.align?B.column+(W?0:1):B.indented+(W?0:l)},electricChars:"{}"}});function e(a){for(var o={},l=a.split(" "),c=0;c<l.length;++c)o[l[c]]=!0;return o}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",r="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function i(a,o){return o.startOfLine?(a.skipToEnd(),"meta"):!1}(function(){function a(o,l){for(var c;(c=o.next())!=null;)if(c=='"'&&!o.eat('"')){l.tokenize=null;break}return"string"}n.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(r),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":i}})})()}});var dV=Ht((cV,uV)=>{(function(n){typeof cV=="object"&&typeof uV=="object"?n(is()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.defineMode("javascript",function(e,t){var r=e.indentUnit,i=t.statementIndent,a=t.jsonld,o=t.json||a,l=t.trackScope!==!1,c=t.typescript,d=t.wordCharacters||/[\w$\xa1-\uffff]/,p=function(){function M(Tn){return{type:Tn,style:"keyword"}}var H=M("keyword a"),ee=M("keyword b"),se=M("keyword c"),Ne=M("keyword d"),nt=M("operator"),ve={type:"atom",style:"atom"};return{if:M("if"),while:H,with:H,else:ee,do:ee,try:ee,finally:ee,return:Ne,break:Ne,continue:Ne,new:M("new"),delete:se,void:se,throw:se,debugger:M("debugger"),var:M("var"),const:M("var"),let:M("var"),function:M("function"),catch:M("catch"),for:M("for"),switch:M("switch"),case:M("case"),default:M("default"),in:nt,typeof:nt,instanceof:nt,true:ve,false:ve,null:ve,undefined:ve,NaN:ve,Infinity:ve,this:M("this"),class:M("class"),super:M("atom"),yield:se,export:M("export"),import:M("import"),extends:se,await:se}}(),m=/[+\-*&%=<>!?|~^@]/,y=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function v(M){for(var H=!1,ee,se=!1;(ee=M.next())!=null;){if(!H){if(ee=="/"&&!se)return;ee=="["?se=!0:se&&ee=="]"&&(se=!1)}H=!H&&ee=="\\"}}var b,x;function C(M,H,ee){return b=M,x=ee,H}function L(M,H){var ee=M.next();if(ee=='"'||ee=="'")return H.tokenize=A(ee),H.tokenize(M,H);if(ee=="."&&M.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return C("number","number");if(ee=="."&&M.match(".."))return C("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(ee))return C(ee);if(ee=="="&&M.eat(">"))return C("=>","operator");if(ee=="0"&&M.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return C("number","number");if(/\d/.test(ee))return M.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),C("number","number");if(ee=="/")return M.eat("*")?(H.tokenize=D,D(M,H)):M.eat("/")?(M.skipToEnd(),C("comment","comment")):oe(M,H,1)?(v(M),M.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),C("regexp","string-2")):(M.eat("="),C("operator","operator",M.current()));if(ee=="`")return H.tokenize=R,R(M,H);if(ee=="#"&&M.peek()=="!")return M.skipToEnd(),C("meta","meta");if(ee=="#"&&M.eatWhile(d))return C("variable","property");if(ee=="<"&&M.match("!--")||ee=="-"&&M.match("->")&&!/\S/.test(M.string.slice(0,M.start)))return M.skipToEnd(),C("comment","comment");if(m.test(ee))return(ee!=">"||!H.lexical||H.lexical.type!=">")&&(M.eat("=")?(ee=="!"||ee=="=")&&M.eat("="):/[<>*+\-|&?]/.test(ee)&&(M.eat(ee),ee==">"&&M.eat(ee))),ee=="?"&&M.eat(".")?C("."):C("operator","operator",M.current());if(d.test(ee)){M.eatWhile(d);var se=M.current();if(H.lastType!="."){if(p.propertyIsEnumerable(se)){var Ne=p[se];return C(Ne.type,Ne.style,se)}if(se=="async"&&M.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return C("async","keyword",se)}return C("variable","variable",se)}}function A(M){return function(H,ee){var se=!1,Ne;if(a&&H.peek()=="@"&&H.match(y))return ee.tokenize=L,C("jsonld-keyword","meta");for(;(Ne=H.next())!=null&&!(Ne==M&&!se);)se=!se&&Ne=="\\";return se||(ee.tokenize=L),C("string","string")}}function D(M,H){for(var ee=!1,se;se=M.next();){if(se=="/"&&ee){H.tokenize=L;break}ee=se=="*"}return C("comment","comment")}function R(M,H){for(var ee=!1,se;(se=M.next())!=null;){if(!ee&&(se=="`"||se=="$"&&M.eat("{"))){H.tokenize=L;break}ee=!ee&&se=="\\"}return C("quasi","string-2",M.current())}var P="([{}])";function E(M,H){H.fatArrowAt&&(H.fatArrowAt=null);var ee=M.string.indexOf("=>",M.start);if(!(ee<0)){if(c){var se=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(M.string.slice(M.start,ee));se&&(ee=se.index)}for(var Ne=0,nt=!1,ve=ee-1;ve>=0;--ve){var Tn=M.string.charAt(ve),Vr=P.indexOf(Tn);if(Vr>=0&&Vr<3){if(!Ne){++ve;break}if(--Ne==0){Tn=="("&&(nt=!0);break}}else if(Vr>=3&&Vr<6)++Ne;else if(d.test(Tn))nt=!0;else if(/["'\/`]/.test(Tn))for(;;--ve){if(ve==0)return;var kl=M.string.charAt(ve-1);if(kl==Tn&&M.string.charAt(ve-2)!="\\"){ve--;break}}else if(nt&&!Ne){++ve;break}}nt&&!Ne&&(H.fatArrowAt=ve)}}var V={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function O(M,H,ee,se,Ne,nt){this.indented=M,this.column=H,this.type=ee,this.prev=Ne,this.info=nt,se!=null&&(this.align=se)}function B(M,H){if(!l)return!1;for(var ee=M.localVars;ee;ee=ee.next)if(ee.name==H)return!0;for(var se=M.context;se;se=se.prev)for(var ee=se.vars;ee;ee=ee.next)if(ee.name==H)return!0}function W(M,H,ee,se,Ne){var nt=M.cc;for(_.state=M,_.stream=Ne,_.marked=null,_.cc=nt,_.style=H,M.lexical.hasOwnProperty("align")||(M.lexical.align=!0);;){var ve=nt.length?nt.pop():o?Pe:He;if(ve(ee,se)){for(;nt.length&&nt[nt.length-1].lex;)nt.pop()();return _.marked?_.marked:ee=="variable"&&B(M,se)?"variable-2":H}}}var _={state:null,column:null,marked:null,cc:null};function F(){for(var M=arguments.length-1;M>=0;M--)_.cc.push(arguments[M])}function N(){return F.apply(null,arguments),!0}function J(M,H){for(var ee=H;ee;ee=ee.next)if(ee.name==M)return!0;return!1}function re(M){var H=_.state;if(_.marked="def",!!l){if(H.context){if(H.lexical.info=="var"&&H.context&&H.context.block){var ee=pe(M,H.context);if(ee!=null){H.context=ee;return}}else if(!J(M,H.localVars)){H.localVars=new fe(M,H.localVars);return}}t.globalVars&&!J(M,H.globalVars)&&(H.globalVars=new fe(M,H.globalVars))}}function pe(M,H){if(H)if(H.block){var ee=pe(M,H.prev);return ee?ee==H.prev?H:new ce(ee,H.vars,!0):null}else return J(M,H.vars)?H:new ce(H.prev,new fe(M,H.vars),!1);else return null}function ye(M){return M=="public"||M=="private"||M=="protected"||M=="abstract"||M=="readonly"}function ce(M,H,ee){this.prev=M,this.vars=H,this.block=ee}function fe(M,H){this.name=M,this.next=H}var Le=new fe("this",new fe("arguments",null));function Ge(){_.state.context=new ce(_.state.context,_.state.localVars,!1),_.state.localVars=Le}function ze(){_.state.context=new ce(_.state.context,_.state.localVars,!0),_.state.localVars=null}function tt(){_.state.localVars=_.state.context.vars,_.state.context=_.state.context.prev}tt.lex=!0;function ge(M,H){var ee=function(){var se=_.state,Ne=se.indented;if(se.lexical.type=="stat")Ne=se.lexical.indented;else for(var nt=se.lexical;nt&&nt.type==")"&&nt.align;nt=nt.prev)Ne=nt.indented;se.lexical=new O(Ne,_.stream.column(),M,null,se.lexical,H)};return ee.lex=!0,ee}function Te(){var M=_.state;M.lexical.prev&&(M.lexical.type==")"&&(M.indented=M.lexical.indented),M.lexical=M.lexical.prev)}Te.lex=!0;function Fe(M){function H(ee){return ee==M?N():M==";"||ee=="}"||ee==")"||ee=="]"?F():N(H)}return H}function He(M,H){return M=="var"?N(ge("vardef",H),qc,Fe(";"),Te):M=="keyword a"?N(ge("form"),Nn,He,Te):M=="keyword b"?N(ge("form"),He,Te):M=="keyword d"?_.stream.match(/^\s*$/,!1)?N():N(ge("stat"),Xe,Fe(";"),Te):M=="debugger"?N(Fe(";")):M=="{"?N(ge("}"),ze,br,Te,tt):M==";"?N():M=="if"?(_.state.lexical.info=="else"&&_.state.cc[_.state.cc.length-1]==Te&&_.state.cc.pop()(),N(ge("form"),Nn,He,Te,Mp)):M=="function"?N(ei):M=="for"?N(ge("form"),ze,Rp,He,tt,Te):M=="class"||c&&H=="interface"?(_.marked="keyword",N(ge("form",M=="class"?M:H),Ll,Te)):M=="variable"?c&&H=="declare"?(_.marked="keyword",N(He)):c&&(H=="module"||H=="enum"||H=="type")&&_.stream.match(/^\s*\w/,!1)?(_.marked="keyword",H=="enum"?N(Xi):H=="type"?N(_p,Fe("operator"),Oe,Fe(";")):N(ge("form"),nr,Fe("{"),ge("}"),br,Te,Te)):c&&H=="namespace"?(_.marked="keyword",N(ge("form"),Pe,He,Te)):c&&H=="abstract"?(_.marked="keyword",N(He)):N(ge("stat"),bl):M=="switch"?N(ge("form"),Nn,Fe("{"),ge("}","switch"),ze,br,Te,Te,tt):M=="case"?N(Pe,Fe(":")):M=="default"?N(Fe(":")):M=="catch"?N(ge("form"),Ge,Ke,He,Te,tt):M=="export"?N(ge("stat"),Qc,Te):M=="import"?N(ge("stat"),Ot,Te):M=="async"?N(He):H=="@"?N(Pe,He):F(ge("stat"),Pe,Fe(";"),Te)}function Ke(M){if(M=="(")return N(Ia,Fe(")"))}function Pe(M,H){return zi(M,H,!1)}function at(M,H){return zi(M,H,!0)}function Nn(M){return M!="("?F():N(ge(")"),Xe,Fe(")"),Te)}function zi(M,H,ee){if(_.state.fatArrowAt==_.stream.start){var se=ee?Zr:Ji;if(M=="(")return N(Ge,ge(")"),bt(Ia,")"),Te,Fe("=>"),se,tt);if(M=="variable")return F(Ge,nr,Fe("=>"),se,tt)}var Ne=ee?Hi:Sr;return V.hasOwnProperty(M)?N(Ne):M=="function"?N(ei,Ne):M=="class"||c&&H=="interface"?(_.marked="keyword",N(ge("form"),Tl,Te)):M=="keyword c"||M=="async"?N(ee?at:Pe):M=="("?N(ge(")"),Xe,Fe(")"),Te,Ne):M=="operator"||M=="spread"?N(ee?at:Pe):M=="["?N(ge("]"),st,Te,Ne):M=="{"?ds(Cn,"}",null,Ne):M=="quasi"?F($i,Ne):M=="new"?N(yi(ee)):N()}function Xe(M){return M.match(/[;\}\)\],]/)?F():F(Pe)}function Sr(M,H){return M==","?N(Xe):Hi(M,H,!1)}function Hi(M,H,ee){var se=ee==!1?Sr:Hi,Ne=ee==!1?Pe:at;if(M=="=>")return N(Ge,ee?Zr:Ji,tt);if(M=="operator")return/\+\+|--/.test(H)||c&&H=="!"?N(se):c&&H=="<"&&_.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?N(ge(">"),bt(Oe,">"),Te,se):H=="?"?N(Pe,Fe(":"),Ne):N(Ne);if(M=="quasi")return F($i,se);if(M!=";"){if(M=="(")return ds(at,")","call",se);if(M==".")return N(po,se);if(M=="[")return N(ge("]"),Xe,Fe("]"),Te,se);if(c&&H=="as")return _.marked="keyword",N(Oe,se);if(M=="regexp")return _.state.lastType=_.marked="operator",_.stream.backUp(_.stream.pos-_.stream.start-1),N(Ne)}}function $i(M,H){return M!="quasi"?F():H.slice(H.length-2)!="${"?N($i):N(Pe,ji)}function ji(M){if(M=="}")return _.marked="string-2",_.state.tokenize=R,N($i)}function Ji(M){return E(_.stream,_.state),F(M=="{"?He:Pe)}function Zr(M){return E(_.stream,_.state),F(M=="{"?He:at)}function yi(M){return function(H){return H=="."?N(M?uo:Da):H=="variable"&&c?N(ps,M?Hi:Sr):F(M?at:Pe)}}function Da(M,H){if(H=="target")return _.marked="keyword",N(Sr)}function uo(M,H){if(H=="target")return _.marked="keyword",N(Hi)}function bl(M){return M==":"?N(Te,He):F(Sr,Fe(";"),Te)}function po(M){if(M=="variable")return _.marked="property",N()}function Cn(M,H){if(M=="async")return _.marked="property",N(Cn);if(M=="variable"||_.style=="keyword"){if(_.marked="property",H=="get"||H=="set")return N(Jc);var ee;return c&&_.state.fatArrowAt==_.stream.start&&(ee=_.stream.match(/^\s*:\s*/,!1))&&(_.state.fatArrowAt=_.stream.pos+ee[0].length),N(er)}else{if(M=="number"||M=="string")return _.marked=a?"property":_.style+" property",N(er);if(M=="jsonld-keyword")return N(er);if(c&&ye(H))return _.marked="keyword",N(Cn);if(M=="[")return N(Pe,Pa,Fe("]"),er);if(M=="spread")return N(at,er);if(H=="*")return _.marked="keyword",N(Cn);if(M==":")return F(er)}}function Jc(M){return M!="variable"?F(er):(_.marked="property",N(ei))}function er(M){if(M==":")return N(at);if(M=="(")return F(ei)}function bt(M,H,ee){function se(Ne,nt){if(ee?ee.indexOf(Ne)>-1:Ne==","){var ve=_.state.lexical;return ve.info=="call"&&(ve.pos=(ve.pos||0)+1),N(function(Tn,Vr){return Tn==H||Vr==H?F():F(M)},se)}return Ne==H||nt==H?N():ee&&ee.indexOf(";")>-1?F(M):N(Fe(H))}return function(Ne,nt){return Ne==H||nt==H?N():F(M,se)}}function ds(M,H,ee){for(var se=3;se<arguments.length;se++)_.cc.push(arguments[se]);return N(ge(H,ee),bt(M,H),Te)}function br(M){return M=="}"?N():F(He,br)}function Pa(M,H){if(c){if(M==":")return N(Oe);if(H=="?")return N(Pa)}}function Ie(M,H){if(c&&(M==":"||H=="in"))return N(Oe)}function xl(M){if(c&&M==":")return _.stream.match(/^\s*\w+\s+is\b/,!1)?N(Pe,tr,Oe):N(Oe)}function tr(M,H){if(H=="is")return _.marked="keyword",N()}function Oe(M,H){if(H=="keyof"||H=="typeof"||H=="infer"||H=="readonly")return _.marked="keyword",N(H=="typeof"?at:Oe);if(M=="variable"||H=="void")return _.marked="type",N(Mr);if(H=="|"||H=="&")return N(Oe);if(M=="string"||M=="number"||M=="atom")return N(Mr);if(M=="[")return N(ge("]"),bt(Oe,"]",","),Te,Mr);if(M=="{")return N(ge("}"),Cl,Te,Mr);if(M=="(")return N(bt(wl,")"),$t,Mr);if(M=="<")return N(bt(Oe,">"),Oe);if(M=="quasi")return F(qi,Mr)}function $t(M){if(M=="=>")return N(Oe)}function Cl(M){return M.match(/[\}\)\]]/)?N():M==","||M==";"?N(Cl):F(vn,Cl)}function vn(M,H){if(M=="variable"||_.style=="keyword")return _.marked="property",N(vn);if(H=="?"||M=="number"||M=="string")return N(vn);if(M==":")return N(Oe);if(M=="[")return N(Fe("variable"),Ie,Fe("]"),vn);if(M=="(")return F(Rr,vn);if(!M.match(/[;\}\)\],]/))return N()}function qi(M,H){return M!="quasi"?F():H.slice(H.length-2)!="${"?N(qi):N(Oe,wn)}function wn(M){if(M=="}")return _.marked="string-2",_.state.tokenize=R,N(qi)}function wl(M,H){return M=="variable"&&_.stream.match(/^\s*[?:]/,!1)||H=="?"?N(wl):M==":"?N(Oe):M=="spread"?N(wl):F(Oe)}function Mr(M,H){if(H=="<")return N(ge(">"),bt(Oe,">"),Te,Mr);if(H=="|"||M=="."||H=="&")return N(Oe);if(M=="[")return N(Oe,Fe("]"),Mr);if(H=="extends"||H=="implements")return _.marked="keyword",N(Oe);if(H=="?")return N(Oe,Fe(":"),Oe)}function ps(M,H){if(H=="<")return N(ge(">"),bt(Oe,">"),Te,Mr)}function fo(){return F(Oe,Ip)}function Ip(M,H){if(H=="=")return N(Oe)}function qc(M,H){return H=="enum"?(_.marked="keyword",N(Xi)):F(nr,Pa,Yi,Kc)}function nr(M,H){if(c&&ye(H))return _.marked="keyword",N(nr);if(M=="variable")return re(H),N();if(M=="spread")return N(nr);if(M=="[")return ds(Yc,"]");if(M=="{")return ds(Ap,"}")}function Ap(M,H){return M=="variable"&&!_.stream.match(/^\s*:/,!1)?(re(H),N(Yi)):(M=="variable"&&(_.marked="property"),M=="spread"?N(nr):M=="}"?F():M=="["?N(Pe,Fe("]"),Fe(":"),Ap):N(Fe(":"),nr,Yi))}function Yc(){return F(nr,Yi)}function Yi(M,H){if(H=="=")return N(at)}function Kc(M){if(M==",")return N(qc)}function Mp(M,H){if(M=="keyword b"&&H=="else")return N(ge("form","else"),He,Te)}function Rp(M,H){if(H=="await")return N(Rp);if(M=="(")return N(ge(")"),Xc,Te)}function Xc(M){return M=="var"?N(qc,ho):M=="variable"?N(ho):F(ho)}function ho(M,H){return M==")"?N():M==";"?N(ho):H=="in"||H=="of"?(_.marked="keyword",N(Pe,ho)):F(Pe,ho)}function ei(M,H){if(H=="*")return _.marked="keyword",N(ei);if(M=="variable")return re(H),N(ei);if(M=="(")return N(Ge,ge(")"),bt(Ia,")"),Te,xl,He,tt);if(c&&H=="<")return N(ge(">"),bt(fo,">"),Te,ei)}function Rr(M,H){if(H=="*")return _.marked="keyword",N(Rr);if(M=="variable")return re(H),N(Rr);if(M=="(")return N(Ge,ge(")"),bt(Ia,")"),Te,xl,tt);if(c&&H=="<")return N(ge(">"),bt(fo,">"),Te,Rr)}function _p(M,H){if(M=="keyword"||M=="variable")return _.marked="type",N(_p);if(H=="<")return N(ge(">"),bt(fo,">"),Te)}function Ia(M,H){return H=="@"&&N(Pe,Ia),M=="spread"?N(Ia):c&&ye(H)?(_.marked="keyword",N(Ia)):c&&M=="this"?N(Pa,Yi):F(nr,Pa,Yi)}function Tl(M,H){return M=="variable"?Ll(M,H):vi(M,H)}function Ll(M,H){if(M=="variable")return re(H),N(vi)}function vi(M,H){if(H=="<")return N(ge(">"),bt(fo,">"),Te,vi);if(H=="extends"||H=="implements"||c&&M==",")return H=="implements"&&(_.marked="keyword"),N(c?Oe:Pe,vi);if(M=="{")return N(ge("}"),Si,Te)}function Si(M,H){if(M=="async"||M=="variable"&&(H=="static"||H=="get"||H=="set"||c&&ye(H))&&_.stream.match(/^\s+[\w$\xa1-\uffff]/,!1))return _.marked="keyword",N(Si);if(M=="variable"||_.style=="keyword")return _.marked="property",N(_r,Si);if(M=="number"||M=="string")return N(_r,Si);if(M=="[")return N(Pe,Pa,Fe("]"),_r,Si);if(H=="*")return _.marked="keyword",N(Si);if(c&&M=="(")return F(Rr,Si);if(M==";"||M==",")return N(Si);if(M=="}")return N();if(H=="@")return N(Pe,Si)}function _r(M,H){if(H=="!"||H=="?")return N(_r);if(M==":")return N(Oe,Yi);if(H=="=")return N(at);var ee=_.state.lexical.prev,se=ee&&ee.info=="interface";return F(se?Rr:ei)}function Qc(M,H){return H=="*"?(_.marked="keyword",N(xr,Fe(";"))):H=="default"?(_.marked="keyword",N(Pe,Fe(";"))):M=="{"?N(bt(Zc,"}"),xr,Fe(";")):F(He)}function Zc(M,H){if(H=="as")return _.marked="keyword",N(Fe("variable"));if(M=="variable")return F(at,Zc)}function Ot(M){return M=="string"?N():M=="("?F(Pe):M=="."?F(Sr):F(we,Ki,xr)}function we(M,H){return M=="{"?ds(we,"}"):(M=="variable"&&re(H),H=="*"&&(_.marked="keyword"),N(eu))}function Ki(M){if(M==",")return N(we,Ki)}function eu(M,H){if(H=="as")return _.marked="keyword",N(we)}function xr(M,H){if(H=="from")return _.marked="keyword",N(Pe)}function st(M){return M=="]"?N():F(bt(at,"]"))}function Xi(){return F(ge("form"),nr,Fe("{"),ge("}"),bt(fs,"}"),Te,Te)}function fs(){return F(nr,Yi)}function tu(M,H){return M.lastType=="operator"||M.lastType==","||m.test(H.charAt(0))||/[,.]/.test(H.charAt(0))}function oe(M,H,ee){return H.tokenize==L&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(H.lastType)||H.lastType=="quasi"&&/\{\s*$/.test(M.string.slice(0,M.pos-(ee||0)))}return{startState:function(M){var H={tokenize:L,lastType:"sof",cc:[],lexical:new O((M||0)-r,0,"block",!1),localVars:t.localVars,context:t.localVars&&new ce(null,null,!1),indented:M||0};return t.globalVars&&typeof t.globalVars=="object"&&(H.globalVars=t.globalVars),H},token:function(M,H){if(M.sol()&&(H.lexical.hasOwnProperty("align")||(H.lexical.align=!1),H.indented=M.indentation(),E(M,H)),H.tokenize!=D&&M.eatSpace())return null;var ee=H.tokenize(M,H);return b=="comment"?ee:(H.lastType=b=="operator"&&(x=="++"||x=="--")?"incdec":b,W(H,ee,b,x,M))},indent:function(M,H){if(M.tokenize==D||M.tokenize==R)return n.Pass;if(M.tokenize!=L)return 0;var ee=H&&H.charAt(0),se=M.lexical,Ne;if(!/^\s*else\b/.test(H))for(var nt=M.cc.length-1;nt>=0;--nt){var ve=M.cc[nt];if(ve==Te)se=se.prev;else if(ve!=Mp&&ve!=tt)break}for(;(se.type=="stat"||se.type=="form")&&(ee=="}"||(Ne=M.cc[M.cc.length-1])&&(Ne==Sr||Ne==Hi)&&!/^[,\.=+\-*:?[\(]/.test(H));)se=se.prev;i&&se.type==")"&&se.prev.type=="stat"&&(se=se.prev);var Tn=se.type,Vr=ee==Tn;return Tn=="vardef"?se.indented+(M.lastType=="operator"||M.lastType==","?se.info.length+1:0):Tn=="form"&&ee=="{"?se.indented:Tn=="form"?se.indented+r:Tn=="stat"?se.indented+(tu(M,H)?i||r:0):se.info=="switch"&&!Vr&&t.doubleIndentSwitch!=!1?se.indented+(/^(?:case|default)\b/.test(H)?r:2*r):se.align?se.column+(Vr?0:1):se.indented+(Vr?0:r)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:o?null:"/*",blockCommentEnd:o?null:"*/",blockCommentContinue:o?null:" * ",lineComment:o?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:o?"json":"javascript",jsonldMode:a,jsonMode:o,expressionAllowed:oe,skipExpression:function(M){W(M,"atom","atom","true",new n.StringStream("",2,null))}}}),n.registerHelper("wordChars","javascript",/[\w$]/),n.defineMIME("text/javascript","javascript"),n.defineMIME("text/ecmascript","javascript"),n.defineMIME("application/javascript","javascript"),n.defineMIME("application/x-javascript","javascript"),n.defineMIME("application/ecmascript","javascript"),n.defineMIME("application/json",{name:"javascript",json:!0}),n.defineMIME("application/x-json",{name:"javascript",json:!0}),n.defineMIME("application/manifest+json",{name:"javascript",json:!0}),n.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),n.defineMIME("text/typescript",{name:"javascript",typescript:!0}),n.defineMIME("application/typescript",{name:"javascript",typescript:!0})})});var Sw=Ht((pV,fV)=>{(function(n){typeof pV=="object"&&typeof fV=="object"?n(is()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";function e(a,o,l,c){if(l&&l.call){var d=l;l=null}else var d=i(a,l,"rangeFinder");typeof o=="number"&&(o=n.Pos(o,0));var p=i(a,l,"minFoldSize");function m(x){var C=d(a,o);if(!C||C.to.line-C.from.line<p)return null;for(var L=a.findMarksAt(C.from),A=0;A<L.length;++A)if(L[A].__isFold&&c!=="fold"){if(!x)return null;C.cleared=!0,L[A].clear()}return C}var y=m(!0);if(i(a,l,"scanUp"))for(;!y&&o.line>a.firstLine();)o=n.Pos(o.line-1,0),y=m(!1);if(!(!y||y.cleared||c==="unfold")){var v=t(a,l,y);n.on(v,"mousedown",function(x){b.clear(),n.e_preventDefault(x)});var b=a.markText(y.from,y.to,{replacedWith:v,clearOnEnter:i(a,l,"clearOnEnter"),__isFold:!0});b.on("clear",function(x,C){n.signal(a,"unfold",a,x,C)}),n.signal(a,"fold",a,y.from,y.to)}}function t(a,o,l){var c=i(a,o,"widget");if(typeof c=="function"&&(c=c(l.from,l.to)),typeof c=="string"){var d=document.createTextNode(c);c=document.createElement("span"),c.appendChild(d),c.className="CodeMirror-foldmarker"}else c&&(c=c.cloneNode(!0));return c}n.newFoldFunction=function(a,o){return function(l,c){e(l,c,{rangeFinder:a,widget:o})}},n.defineExtension("foldCode",function(a,o,l){e(this,a,o,l)}),n.defineExtension("isFolded",function(a){for(var o=this.findMarksAt(a),l=0;l<o.length;++l)if(o[l].__isFold)return!0}),n.commands.toggleFold=function(a){a.foldCode(a.getCursor())},n.commands.fold=function(a){a.foldCode(a.getCursor(),null,"fold")},n.commands.unfold=function(a){a.foldCode(a.getCursor(),null,"unfold")},n.commands.foldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"fold")})},n.commands.unfoldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"unfold")})},n.registerHelper("fold","combine",function(){var a=Array.prototype.slice.call(arguments,0);return function(o,l){for(var c=0;c<a.length;++c){var d=a[c](o,l);if(d)return d}}}),n.registerHelper("fold","auto",function(a,o){for(var l=a.getHelpers(o,"fold"),c=0;c<l.length;c++){var d=l[c](a,o);if(d)return d}});var r={rangeFinder:n.fold.auto,widget:"\u2194",minFoldSize:0,scanUp:!1,clearOnEnter:!0};n.defineOption("foldOptions",null);function i(a,o,l){if(o&&o[l]!==void 0)return o[l];var c=a.options.foldOptions;return c&&c[l]!==void 0?c[l]:r[l]}n.defineExtension("foldOption",function(a,o){return i(this,a,o)})})});var gV=Ht((hV,mV)=>{(function(n){typeof hV=="object"&&typeof mV=="object"?n(is(),Sw()):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./foldcode"],n):n(CodeMirror)})(function(n){"use strict";n.defineOption("foldGutter",!1,function(v,b,x){x&&x!=n.Init&&(v.clearGutter(v.state.foldGutter.options.gutter),v.state.foldGutter=null,v.off("gutterClick",d),v.off("changes",p),v.off("viewportChange",m),v.off("fold",y),v.off("unfold",y),v.off("swapDoc",p)),b&&(v.state.foldGutter=new t(r(b)),c(v),v.on("gutterClick",d),v.on("changes",p),v.on("viewportChange",m),v.on("fold",y),v.on("unfold",y),v.on("swapDoc",p))});var e=n.Pos;function t(v){this.options=v,this.from=this.to=0}function r(v){return v===!0&&(v={}),v.gutter==null&&(v.gutter="CodeMirror-foldgutter"),v.indicatorOpen==null&&(v.indicatorOpen="CodeMirror-foldgutter-open"),v.indicatorFolded==null&&(v.indicatorFolded="CodeMirror-foldgutter-folded"),v}function i(v,b){for(var x=v.findMarks(e(b,0),e(b+1,0)),C=0;C<x.length;++C)if(x[C].__isFold){var L=x[C].find(-1);if(L&&L.line===b)return x[C]}}function a(v){if(typeof v=="string"){var b=document.createElement("div");return b.className=v+" CodeMirror-guttermarker-subtle",b}else return v.cloneNode(!0)}function o(v,b,x){var C=v.state.foldGutter.options,L=b-1,A=v.foldOption(C,"minFoldSize"),D=v.foldOption(C,"rangeFinder"),R=typeof C.indicatorFolded=="string"&&l(C.indicatorFolded),P=typeof C.indicatorOpen=="string"&&l(C.indicatorOpen);v.eachLine(b,x,function(E){++L;var V=null,O=E.gutterMarkers;if(O&&(O=O[C.gutter]),i(v,L)){if(R&&O&&R.test(O.className))return;V=a(C.indicatorFolded)}else{var B=e(L,0),W=D&&D(v,B);if(W&&W.to.line-W.from.line>=A){if(P&&O&&P.test(O.className))return;V=a(C.indicatorOpen)}}!V&&!O||v.setGutterMarker(E,C.gutter,V)})}function l(v){return new RegExp("(^|\\s)"+v+"(?:$|\\s)\\s*")}function c(v){var b=v.getViewport(),x=v.state.foldGutter;!x||(v.operation(function(){o(v,b.from,b.to)}),x.from=b.from,x.to=b.to)}function d(v,b,x){var C=v.state.foldGutter;if(!!C){var L=C.options;if(x==L.gutter){var A=i(v,b);A?A.clear():v.foldCode(e(b,0),L)}}}function p(v){var b=v.state.foldGutter;if(!!b){var x=b.options;b.from=b.to=0,clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){c(v)},x.foldOnChangeTimeSpan||600)}}function m(v){var b=v.state.foldGutter;if(!!b){var x=b.options;clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){var C=v.getViewport();b.from==b.to||C.from-b.to>20||b.from-C.to>20?c(v):v.operation(function(){C.from<b.from&&(o(v,C.from,b.from),b.from=C.from),C.to>b.to&&(o(v,b.to,C.to),b.to=C.to)})},x.updateViewportTimeSpan||400)}}function y(v,b){var x=v.state.foldGutter;if(!!x){var C=b.line;C>=x.from&&C<x.to&&o(v,C,C+1)}}})});var SV=Ht((yV,vV)=>{(function(n){typeof yV=="object"&&typeof vV=="object"?n(is()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.registerHelper("fold","brace",function(e,t){var r=t.line,i=e.getLine(r),a;function o(P){for(var E=t.ch,V=0;;){var O=E<=0?-1:i.lastIndexOf(P,E-1);if(O==-1){if(V==1)break;V=1,E=i.length;continue}if(V==1&&O<t.ch)break;if(a=e.getTokenTypeAt(n.Pos(r,O+1)),!/^(comment|string)/.test(a))return O+1;E=O-1}}var l=o("{"),c=o("["),d,p,m;if(l!=null&&(c==null||c>l))m=l,d="{",p="}";else if(c!=null)m=c,d="[",p="]";else return;var y=1,v=e.lastLine(),b,x;e:for(var C=r;C<=v;++C)for(var L=e.getLine(C),A=C==r?m:0;;){var D=L.indexOf(d,A),R=L.indexOf(p,A);if(D<0&&(D=L.length),R<0&&(R=L.length),A=Math.min(D,R),A==L.length)break;if(e.getTokenTypeAt(n.Pos(C,A+1))==a){if(A==D)++y;else if(!--y){b=C,x=A;break e}}++A}if(!(b==null||r==b))return{from:n.Pos(r,m),to:n.Pos(b,x)}}),n.registerHelper("fold","import",function(e,t){function r(d){if(d<e.firstLine()||d>e.lastLine())return null;var p=e.getTokenAt(n.Pos(d,1));if(/\S/.test(p.string)||(p=e.getTokenAt(n.Pos(d,p.end+1))),p.type!="keyword"||p.string!="import")return null;for(var m=d,y=Math.min(e.lastLine(),d+10);m<=y;++m){var v=e.getLine(m),b=v.indexOf(";");if(b!=-1)return{startCh:p.end,end:n.Pos(m,b)}}}var i=t.line,a=r(i),o;if(!a||r(i-1)||(o=r(i-2))&&o.end.line==i-1)return null;for(var l=a.end;;){var c=r(l.line+1);if(c==null)break;l=c.end}return{from:e.clipPos(n.Pos(i,a.startCh+1)),to:l}}),n.registerHelper("fold","include",function(e,t){function r(c){if(c<e.firstLine()||c>e.lastLine())return null;var d=e.getTokenAt(n.Pos(c,1));if(/\S/.test(d.string)||(d=e.getTokenAt(n.Pos(c,d.end+1))),d.type=="meta"&&d.string.slice(0,8)=="#include")return d.start+8}var i=t.line,a=r(i);if(a==null||r(i-1)!=null)return null;for(var o=i;;){var l=r(o+1);if(l==null)break;++o}return{from:n.Pos(i,a+1),to:e.clipPos(n.Pos(o))}})})});function uf(n,e){let t=n.length,r=0;for(let i=0;i<t;++i)e(n[i],i,n)&&(n[r]=n[i],++r);n.length=r}function MT(n,e){if(n.length===e)return n;let t=new n.constructor(e);return t.set(n),t}function Iu(n,e,t,r){let i=n.length/e,a=n.length*t*r,o=new n.constructor(a),l=n.length*r,c=e,d=e*r;for(let p=0;p<i;++p)for(let m=0;m<e;++m){let y=n[p*e+m],v=p*d+m;for(let b=0;b<t;++b)for(let x=0;x<r;++x)o[b*l+x*c+v]=y}return o}function RT(n,e,t,r=0,i=n.length){for(;r<i;){let a=r+i-1>>1,o=t(e,n[a]);if(o>0)r=a+1;else if(o<0)i=a;else return a}return~r}function _T(n,e,t){let r=e-n;for(;r>0;){let i=Math.floor(r/2),a=n+i;t(a)?r=i:(n=a+1,r-=i+1)}return n}function VT(n,e){let t=[];for(let r=0,i=n.length;r<i;++r)n[r]===e&&t.push(r);return t}function Ce(n,e){let t=n.length;if(e.length!==t)return!1;for(let r=0;r<t;++r)if(n[r]!==e[r])return!1;return!0}function Au(n,e,t=(r,i)=>r===i){let r=n.length;if(e.length!==r)return!1;for(let i=0;i<r;++i)if(!t(n[i],e[i]))return!1;return!0}function OT(n,e,t){let r=[];if(t===e){for(let i=0;i<n;++i)r[i]=i;return r}r[t]=e;for(let i=0,a=0;i<n;){if(i===e){++i;continue}a===t&&++a,r[a++]=i++}return r}function Iy(n,e,t){for(let r=0,i=t.length;r<i;++r){let a=t[r];a!==-1&&(n[r]=e[a])}return n}function Tr(n){let e=[];for(let t=0,r=n.length;t<r;++t){let i=n[t];for(let a=0,o=i.length;a<o;++a){let l=e[a];l===void 0&&(l=e[a]=[]),l.push(i[a])}}return e}function NT(n,e){let t=[],r=0;for(let a=0,o=e.length;a<o;++a){let{retainCount:l,deleteCount:c,insertCount:d}=e[a];l!==0&&(t.push(n.slice(r,r+l)),r+=l),r+=c,d!==0&&t.push(new Array(d))}let i=n.length;return r!==i&&t.push(n.slice(r)),new Array(0).concat(...t)}function BT(n,e,t){let r=[],i=0,a=0,o=n.length,l=e.length;for(;i<o&&a<l;){let c,d=n[i],p=e[a];if(c=t(d,p),c===0){let m=1;for(++i,++a;i<o&&a<l&&(c=t(n[i],e[a]))===0;)++m,++i,++a;r.push({retainCount:m,deleteCount:0,insertCount:0});continue}if(c<0){let m=1;for(;++i<o&&(c=t(n[i],p))<0;)++m;r.push({retainCount:0,deleteCount:m,insertCount:0});continue}if(c>0){let m=1;for(;++a<l&&(c=t(d,e[a]))>0;)++m;r.push({retainCount:0,deleteCount:0,insertCount:m});continue}}return(i<o||a<l)&&r.push({retainCount:0,deleteCount:o-i,insertCount:l-a}),r}function FT(n,e,t,r,i,a){let o=0,l=0;if(n!==0&&e!==0)for(;;){let c=t(o,l);if(c<0){if(r(o),++o===n)break}else if(c>0){if(i(l),++l===e)break}else if(a(o,l),++o,++l,o===n||l===e)break}for(;o<n;)r(o),++o;for(;l<e;)i(l),++l}var vL=rt(Dt());var TB=!1;function yL(n){typeof n=="object"?n.dispose():n()}function Oa(n){for(let e=n.length;e>0;--e)yL(n[e-1])}function bn(n,e,t,r){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t,r)}var $=class{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){if(TB){if(this.refCount===0)debugger;(this.disposedStacks=this.disposedStacks||[]).push(new Error().stack)}--this.refCount==0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let{disposers:e}=this;e!==void 0&&(Oa(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(t!=null){let r=t.indexOf(e);r!==-1&&t.splice(r,1)}return e}registerEventListener(e,t,r,i){this.registerDisposer(bn(e,t,r,i))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}},Ru=class extends ${constructor(e){super();this.value=e}};function pf(n){return()=>{if(n!==void 0){let e=n;n=void 0,yL(e)}}}var We=class{constructor(){this.handlers=new Set;this.count=0;let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}};var ae=class extends We{},ff={count:0,add(n){return()=>{}},remove(n){return!1}};var Ae=class{constructor(e){this.value_=e;this.changed=new ae}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}},ct=class extends Ae{constructor(e,t,r=e){super(e);this.validator=t;this.defaultValue=r}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let{validator:t}=this;try{this.value=t(e);return}catch(r){}}this.value=this.defaultValue}},_y=class extends ${constructor(e,t){super();this.changed=new ae;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}};function Vy(n,...e){return new _y(n,e)}var SL=class extends ${constructor(e,t){super();this.changed=new ae;this.valueGeneration=-1;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){let e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}};function Un(n,...e){return new SL(n,e)}var hf=class extends ${constructor(e,t=(r,i)=>r===i){super();this.changed=new We;this.value=e.value,this.registerDisposer(e.changed.add(()=>{let r=e.value;t(this.value,r)||(this.value=r,this.changed.dispatch())}))}};function qt(n,e,t){let r=new _y(n,e),i=new hf(r,t);return i.registerDisposer(r),i}var _u=class extends ${constructor(e){super();this.changed=new ae;let t=e(this),r=Object.keys(t),i=()=>{let a=Array.isArray(t)?[]:{};for(let o of r)a[o]=t[o].value;this.value=a,this.changed.dispatch()};i();for(let a of r){let o=t[a];this.registerDisposer(o.changed.add(()=>i()))}}};var Oy=class{constructor(e){this.changed=new ae;e===void 0?this.values=new Set:this.values=new Set(e)}add(e){let{values:t}=this;return t.has(e)||(t.add(e),this.changed.dispatch()),this}delete(e){let{values:t}=this;return t.delete(e)?(this.changed.dispatch(),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){let{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch())}};function Wn(n,...e){let t=e.map(c=>c.value),r=e.length,i=new $,a=n(i,...t),o=(0,vL.default)(()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new $,a=n(i,...t))},0),l=e.map(c=>c.changed.add(o));return{flush(){o.flush()},dispose(){o.cancel(),Oa(l),i.dispose()},get value(){return o.flush(),a}}}function Na(n,...e){let t=e.map(c=>c.value),r=e.length,i=new $,a=n(i,...t),o=()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new $,a=n(i,...t))},l=e.map(c=>c.changed.add(o));return{dispose(){Oa(l),i.dispose()},get value(){return a}}}function Br(n){return{changed:ff,value:n}}function Fr(n,e){return n(e.value),e.changed.add(()=>n(e.value))}var Jl=class{constructor(e,t){this.outer=e;this.getInner=t;this.changed=new ae;this.update=()=>{let{disposer:e,outer:t}=this;e!==void 0&&e();let r=this.inner=this.getInner(t.value);this.disposer=r.changed.add(this.changed.dispatch),this.changed.dispatch()};e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}},Vu=class extends Jl{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}};var mf=new Float32Array(1);function bL(n){mf[0]=n,n=mf[0];for(let e=1;e<21;++e){let t=n.toPrecision(e);if(mf[0]=parseFloat(t),mf[0]===n)return t}return n.toString()}var Ue=1e-6,ht=typeof Float32Array!="undefined"?Float32Array:Array,Lr=Math.random;var m5=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});var Ct={};jl(Ct,{add:()=>JB,adjoint:()=>RB,clone:()=>kB,copy:()=>EB,create:()=>Ny,determinant:()=>_B,equals:()=>XB,exactEquals:()=>KB,frob:()=>jB,fromMat2d:()=>WB,fromMat4:()=>LB,fromQuat:()=>GB,fromRotation:()=>FB,fromScaling:()=>UB,fromTranslation:()=>BB,fromValues:()=>DB,identity:()=>IB,invert:()=>MB,mul:()=>QB,multiply:()=>xL,multiplyScalar:()=>qB,multiplyScalarAndAdd:()=>YB,normalFromMat4:()=>zB,projection:()=>HB,rotate:()=>OB,scale:()=>NB,set:()=>PB,str:()=>$B,sub:()=>ZB,subtract:()=>CL,translate:()=>VB,transpose:()=>AB});function Ny(){var n=new ht(9);return ht!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function LB(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n}function kB(n){var e=new ht(9);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e}function EB(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function DB(n,e,t,r,i,a,o,l,c){var d=new ht(9);return d[0]=n,d[1]=e,d[2]=t,d[3]=r,d[4]=i,d[5]=a,d[6]=o,d[7]=l,d[8]=c,d}function PB(n,e,t,r,i,a,o,l,c,d){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n}function IB(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function AB(n,e){if(n===e){var t=e[1],r=e[2],i=e[5];n[1]=e[3],n[2]=e[6],n[3]=t,n[5]=e[7],n[6]=r,n[7]=i}else n[0]=e[0],n[1]=e[3],n[2]=e[6],n[3]=e[1],n[4]=e[4],n[5]=e[7],n[6]=e[2],n[7]=e[5],n[8]=e[8];return n}function MB(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=p*o-l*d,y=-p*a+l*c,v=d*a-o*c,b=t*m+r*y+i*v;return b?(b=1/b,n[0]=m*b,n[1]=(-p*r+i*d)*b,n[2]=(l*r-i*o)*b,n[3]=y*b,n[4]=(p*t-i*c)*b,n[5]=(-l*t+i*a)*b,n[6]=v*b,n[7]=(-d*t+r*c)*b,n[8]=(o*t-r*a)*b,n):null}function RB(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8];return n[0]=o*p-l*d,n[1]=i*d-r*p,n[2]=r*l-i*o,n[3]=l*c-a*p,n[4]=t*p-i*c,n[5]=i*a-t*l,n[6]=a*d-o*c,n[7]=r*c-t*d,n[8]=t*o-r*a,n}function _B(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8];return e*(d*a-o*c)+t*(-d*i+o*l)+r*(c*i-a*l)}function xL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=t[0],v=t[1],b=t[2],x=t[3],C=t[4],L=t[5],A=t[6],D=t[7],R=t[8];return n[0]=y*r+v*o+b*d,n[1]=y*i+v*l+b*p,n[2]=y*a+v*c+b*m,n[3]=x*r+C*o+L*d,n[4]=x*i+C*l+L*p,n[5]=x*a+C*c+L*m,n[6]=A*r+D*o+R*d,n[7]=A*i+D*l+R*p,n[8]=A*a+D*c+R*m,n}function VB(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=t[0],v=t[1];return n[0]=r,n[1]=i,n[2]=a,n[3]=o,n[4]=l,n[5]=c,n[6]=y*r+v*o+d,n[7]=y*i+v*l+p,n[8]=y*a+v*c+m,n}function OB(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=Math.sin(t),v=Math.cos(t);return n[0]=v*r+y*o,n[1]=v*i+y*l,n[2]=v*a+y*c,n[3]=v*o-y*r,n[4]=v*l-y*i,n[5]=v*c-y*a,n[6]=d,n[7]=p,n[8]=m,n}function NB(n,e,t){var r=t[0],i=t[1];return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=i*e[3],n[4]=i*e[4],n[5]=i*e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function BB(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e[0],n[7]=e[1],n[8]=1,n}function FB(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=-t,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function UB(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=e[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function WB(n,e){return n[0]=e[0],n[1]=e[1],n[2]=0,n[3]=e[2],n[4]=e[3],n[5]=0,n[6]=e[4],n[7]=e[5],n[8]=1,n}function GB(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,y=i*o,v=i*l,b=i*c,x=a*o,C=a*l,L=a*c;return n[0]=1-m-b,n[3]=p-L,n[6]=y+C,n[1]=p+L,n[4]=1-d-b,n[7]=v-x,n[2]=y-C,n[5]=v+x,n[8]=1-d-m,n}function zB(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],L=e[15],A=t*l-r*o,D=t*c-i*o,R=t*d-a*o,P=r*c-i*l,E=r*d-a*l,V=i*d-a*c,O=p*x-m*b,B=p*C-y*b,W=p*L-v*b,_=m*C-y*x,F=m*L-v*x,N=y*L-v*C,J=A*N-D*F+R*_+P*W-E*B+V*O;return J?(J=1/J,n[0]=(l*N-c*F+d*_)*J,n[1]=(c*W-o*N-d*B)*J,n[2]=(o*F-l*W+d*O)*J,n[3]=(i*F-r*N-a*_)*J,n[4]=(t*N-i*W+a*B)*J,n[5]=(r*W-t*F-a*O)*J,n[6]=(x*V-C*E+L*P)*J,n[7]=(C*R-b*V-L*D)*J,n[8]=(b*E-x*R+L*A)*J,n):null}function HB(n,e,t){return n[0]=2/e,n[1]=0,n[2]=0,n[3]=0,n[4]=-2/t,n[5]=0,n[6]=-1,n[7]=1,n[8]=1,n}function $B(n){return"mat3("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+")"}function jB(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}function JB(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n}function CL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n}function qB(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n}function YB(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n}function KB(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]}function XB(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=e[0],y=e[1],v=e[2],b=e[3],x=e[4],C=e[5],L=e[6],A=e[7],D=e[8];return Math.abs(t-m)<=Ue*Math.max(1,Math.abs(t),Math.abs(m))&&Math.abs(r-y)<=Ue*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(i-v)<=Ue*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(a-b)<=Ue*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-x)<=Ue*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(l-C)<=Ue*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(c-L)<=Ue*Math.max(1,Math.abs(c),Math.abs(L))&&Math.abs(d-A)<=Ue*Math.max(1,Math.abs(d),Math.abs(A))&&Math.abs(p-D)<=Ue*Math.max(1,Math.abs(p),Math.abs(D))}var QB=xL,ZB=CL;var ie={};jl(ie,{add:()=>VF,adjoint:()=>sF,clone:()=>tF,copy:()=>nF,create:()=>eF,determinant:()=>lF,equals:()=>FF,exactEquals:()=>BF,frob:()=>_F,fromQuat:()=>kF,fromQuat2:()=>xF,fromRotation:()=>yF,fromRotationTranslation:()=>LL,fromRotationTranslationScale:()=>TF,fromRotationTranslationScaleOrigin:()=>LF,fromScaling:()=>gF,fromTranslation:()=>mF,fromValues:()=>rF,fromXRotation:()=>vF,fromYRotation:()=>SF,fromZRotation:()=>bF,frustum:()=>EF,getRotation:()=>wF,getScaling:()=>kL,getTranslation:()=>CF,identity:()=>wL,invert:()=>oF,lookAt:()=>AF,mul:()=>UF,multiply:()=>TL,multiplyScalar:()=>OF,multiplyScalarAndAdd:()=>NF,ortho:()=>IF,perspective:()=>DF,perspectiveFromFieldOfView:()=>PF,rotate:()=>dF,rotateX:()=>pF,rotateY:()=>fF,rotateZ:()=>hF,scale:()=>uF,set:()=>iF,str:()=>RF,sub:()=>WF,subtract:()=>EL,targetTo:()=>MF,translate:()=>cF,transpose:()=>aF});function eF(){var n=new ht(16);return ht!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function tF(n){var e=new ht(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}function nF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function rF(n,e,t,r,i,a,o,l,c,d,p,m,y,v,b,x){var C=new ht(16);return C[0]=n,C[1]=e,C[2]=t,C[3]=r,C[4]=i,C[5]=a,C[6]=o,C[7]=l,C[8]=c,C[9]=d,C[10]=p,C[11]=m,C[12]=y,C[13]=v,C[14]=b,C[15]=x,C}function iF(n,e,t,r,i,a,o,l,c,d,p,m,y,v,b,x,C){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n[9]=p,n[10]=m,n[11]=y,n[12]=v,n[13]=b,n[14]=x,n[15]=C,n}function wL(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function aF(n,e){if(n===e){var t=e[1],r=e[2],i=e[3],a=e[6],o=e[7],l=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=t,n[6]=e[9],n[7]=e[13],n[8]=r,n[9]=a,n[11]=e[14],n[12]=i,n[13]=o,n[14]=l}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function oF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],L=e[15],A=t*l-r*o,D=t*c-i*o,R=t*d-a*o,P=r*c-i*l,E=r*d-a*l,V=i*d-a*c,O=p*x-m*b,B=p*C-y*b,W=p*L-v*b,_=m*C-y*x,F=m*L-v*x,N=y*L-v*C,J=A*N-D*F+R*_+P*W-E*B+V*O;return J?(J=1/J,n[0]=(l*N-c*F+d*_)*J,n[1]=(i*F-r*N-a*_)*J,n[2]=(x*V-C*E+L*P)*J,n[3]=(y*E-m*V-v*P)*J,n[4]=(c*W-o*N-d*B)*J,n[5]=(t*N-i*W+a*B)*J,n[6]=(C*R-b*V-L*D)*J,n[7]=(p*V-y*R+v*D)*J,n[8]=(o*F-l*W+d*O)*J,n[9]=(r*W-t*F-a*O)*J,n[10]=(b*E-x*R+L*A)*J,n[11]=(m*R-p*E-v*A)*J,n[12]=(l*B-o*_-c*O)*J,n[13]=(t*_-r*B+i*O)*J,n[14]=(x*D-b*P-C*A)*J,n[15]=(p*P-m*D+y*A)*J,n):null}function sF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],L=e[15];return n[0]=l*(y*L-v*C)-m*(c*L-d*C)+x*(c*v-d*y),n[1]=-(r*(y*L-v*C)-m*(i*L-a*C)+x*(i*v-a*y)),n[2]=r*(c*L-d*C)-l*(i*L-a*C)+x*(i*d-a*c),n[3]=-(r*(c*v-d*y)-l*(i*v-a*y)+m*(i*d-a*c)),n[4]=-(o*(y*L-v*C)-p*(c*L-d*C)+b*(c*v-d*y)),n[5]=t*(y*L-v*C)-p*(i*L-a*C)+b*(i*v-a*y),n[6]=-(t*(c*L-d*C)-o*(i*L-a*C)+b*(i*d-a*c)),n[7]=t*(c*v-d*y)-o*(i*v-a*y)+p*(i*d-a*c),n[8]=o*(m*L-v*x)-p*(l*L-d*x)+b*(l*v-d*m),n[9]=-(t*(m*L-v*x)-p*(r*L-a*x)+b*(r*v-a*m)),n[10]=t*(l*L-d*x)-o*(r*L-a*x)+b*(r*d-a*l),n[11]=-(t*(l*v-d*m)-o*(r*v-a*m)+p*(r*d-a*l)),n[12]=-(o*(m*C-y*x)-p*(l*C-c*x)+b*(l*y-c*m)),n[13]=t*(m*C-y*x)-p*(r*C-i*x)+b*(r*y-i*m),n[14]=-(t*(l*C-c*x)-o*(r*C-i*x)+b*(r*c-i*l)),n[15]=t*(l*y-c*m)-o*(r*y-i*m)+p*(r*c-i*l),n}function lF(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8],p=n[9],m=n[10],y=n[11],v=n[12],b=n[13],x=n[14],C=n[15],L=e*o-t*a,A=e*l-r*a,D=e*c-i*a,R=t*l-r*o,P=t*c-i*o,E=r*c-i*l,V=d*b-p*v,O=d*x-m*v,B=d*C-y*v,W=p*x-m*b,_=p*C-y*b,F=m*C-y*x;return L*F-A*_+D*W+R*B-P*O+E*V}function TL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=e[9],v=e[10],b=e[11],x=e[12],C=e[13],L=e[14],A=e[15],D=t[0],R=t[1],P=t[2],E=t[3];return n[0]=D*r+R*l+P*m+E*x,n[1]=D*i+R*c+P*y+E*C,n[2]=D*a+R*d+P*v+E*L,n[3]=D*o+R*p+P*b+E*A,D=t[4],R=t[5],P=t[6],E=t[7],n[4]=D*r+R*l+P*m+E*x,n[5]=D*i+R*c+P*y+E*C,n[6]=D*a+R*d+P*v+E*L,n[7]=D*o+R*p+P*b+E*A,D=t[8],R=t[9],P=t[10],E=t[11],n[8]=D*r+R*l+P*m+E*x,n[9]=D*i+R*c+P*y+E*C,n[10]=D*a+R*d+P*v+E*L,n[11]=D*o+R*p+P*b+E*A,D=t[12],R=t[13],P=t[14],E=t[15],n[12]=D*r+R*l+P*m+E*x,n[13]=D*i+R*c+P*y+E*C,n[14]=D*a+R*d+P*v+E*L,n[15]=D*o+R*p+P*b+E*A,n}function cF(n,e,t){var r=t[0],i=t[1],a=t[2],o,l,c,d,p,m,y,v,b,x,C,L;return e===n?(n[12]=e[0]*r+e[4]*i+e[8]*a+e[12],n[13]=e[1]*r+e[5]*i+e[9]*a+e[13],n[14]=e[2]*r+e[6]*i+e[10]*a+e[14],n[15]=e[3]*r+e[7]*i+e[11]*a+e[15]):(o=e[0],l=e[1],c=e[2],d=e[3],p=e[4],m=e[5],y=e[6],v=e[7],b=e[8],x=e[9],C=e[10],L=e[11],n[0]=o,n[1]=l,n[2]=c,n[3]=d,n[4]=p,n[5]=m,n[6]=y,n[7]=v,n[8]=b,n[9]=x,n[10]=C,n[11]=L,n[12]=o*r+p*i+b*a+e[12],n[13]=l*r+m*i+x*a+e[13],n[14]=c*r+y*i+C*a+e[14],n[15]=d*r+v*i+L*a+e[15]),n}function uF(n,e,t){var r=t[0],i=t[1],a=t[2];return n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*a,n[9]=e[9]*a,n[10]=e[10]*a,n[11]=e[11]*a,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function dF(n,e,t,r){var i=r[0],a=r[1],o=r[2],l=Math.hypot(i,a,o),c,d,p,m,y,v,b,x,C,L,A,D,R,P,E,V,O,B,W,_,F,N,J,re;return l<Ue?null:(l=1/l,i*=l,a*=l,o*=l,c=Math.sin(t),d=Math.cos(t),p=1-d,m=e[0],y=e[1],v=e[2],b=e[3],x=e[4],C=e[5],L=e[6],A=e[7],D=e[8],R=e[9],P=e[10],E=e[11],V=i*i*p+d,O=a*i*p+o*c,B=o*i*p-a*c,W=i*a*p-o*c,_=a*a*p+d,F=o*a*p+i*c,N=i*o*p+a*c,J=a*o*p-i*c,re=o*o*p+d,n[0]=m*V+x*O+D*B,n[1]=y*V+C*O+R*B,n[2]=v*V+L*O+P*B,n[3]=b*V+A*O+E*B,n[4]=m*W+x*_+D*F,n[5]=y*W+C*_+R*F,n[6]=v*W+L*_+P*F,n[7]=b*W+A*_+E*F,n[8]=m*N+x*J+D*re,n[9]=y*N+C*J+R*re,n[10]=v*N+L*J+P*re,n[11]=b*N+A*J+E*re,e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n)}function pF(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[4],o=e[5],l=e[6],c=e[7],d=e[8],p=e[9],m=e[10],y=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=a*i+d*r,n[5]=o*i+p*r,n[6]=l*i+m*r,n[7]=c*i+y*r,n[8]=d*i-a*r,n[9]=p*i-o*r,n[10]=m*i-l*r,n[11]=y*i-c*r,n}function fF(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[8],p=e[9],m=e[10],y=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i-d*r,n[1]=o*i-p*r,n[2]=l*i-m*r,n[3]=c*i-y*r,n[8]=a*r+d*i,n[9]=o*r+p*i,n[10]=l*r+m*i,n[11]=c*r+y*i,n}function hF(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[4],p=e[5],m=e[6],y=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i+d*r,n[1]=o*i+p*r,n[2]=l*i+m*r,n[3]=c*i+y*r,n[4]=d*i-a*r,n[5]=p*i-o*r,n[6]=m*i-l*r,n[7]=y*i-c*r,n}function mF(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function gF(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function yF(n,e,t){var r=t[0],i=t[1],a=t[2],o=Math.hypot(r,i,a),l,c,d;return o<Ue?null:(o=1/o,r*=o,i*=o,a*=o,l=Math.sin(e),c=Math.cos(e),d=1-c,n[0]=r*r*d+c,n[1]=i*r*d+a*l,n[2]=a*r*d-i*l,n[3]=0,n[4]=r*i*d-a*l,n[5]=i*i*d+c,n[6]=a*i*d+r*l,n[7]=0,n[8]=r*a*d+i*l,n[9]=i*a*d-r*l,n[10]=a*a*d+c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function vF(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r,n[6]=t,n[7]=0,n[8]=0,n[9]=-t,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function SF(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=0,n[2]=-t,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=t,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function bF(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=0,n[4]=-t,n[5]=r,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function LL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=r+r,c=i+i,d=a+a,p=r*l,m=r*c,y=r*d,v=i*c,b=i*d,x=a*d,C=o*l,L=o*c,A=o*d;return n[0]=1-(v+x),n[1]=m+A,n[2]=y-L,n[3]=0,n[4]=m-A,n[5]=1-(p+x),n[6]=b+C,n[7]=0,n[8]=y+L,n[9]=b-C,n[10]=1-(p+v),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function xF(n,e){var t=new ht(3),r=-e[0],i=-e[1],a=-e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=r*r+i*i+a*a+o*o;return m>0?(t[0]=(l*o+p*r+c*a-d*i)*2/m,t[1]=(c*o+p*i+d*r-l*a)*2/m,t[2]=(d*o+p*a+l*i-c*r)*2/m):(t[0]=(l*o+p*r+c*a-d*i)*2,t[1]=(c*o+p*i+d*r-l*a)*2,t[2]=(d*o+p*a+l*i-c*r)*2),LL(n,e,t),n}function CF(n,e){return n[0]=e[12],n[1]=e[13],n[2]=e[14],n}function kL(n,e){var t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=Math.hypot(t,r,i),n[1]=Math.hypot(a,o,l),n[2]=Math.hypot(c,d,p),n}function wF(n,e){var t=new ht(3);kL(t,e);var r=1/t[0],i=1/t[1],a=1/t[2],o=e[0]*r,l=e[1]*i,c=e[2]*a,d=e[4]*r,p=e[5]*i,m=e[6]*a,y=e[8]*r,v=e[9]*i,b=e[10]*a,x=o+p+b,C=0;return x>0?(C=Math.sqrt(x+1)*2,n[3]=.25*C,n[0]=(m-v)/C,n[1]=(y-c)/C,n[2]=(l-d)/C):o>p&&o>b?(C=Math.sqrt(1+o-p-b)*2,n[3]=(m-v)/C,n[0]=.25*C,n[1]=(l+d)/C,n[2]=(y+c)/C):p>b?(C=Math.sqrt(1+p-o-b)*2,n[3]=(y-c)/C,n[0]=(l+d)/C,n[1]=.25*C,n[2]=(m+v)/C):(C=Math.sqrt(1+b-o-p)*2,n[3]=(l-d)/C,n[0]=(y+c)/C,n[1]=(m+v)/C,n[2]=.25*C),n}function TF(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=i+i,d=a+a,p=o+o,m=i*c,y=i*d,v=i*p,b=a*d,x=a*p,C=o*p,L=l*c,A=l*d,D=l*p,R=r[0],P=r[1],E=r[2];return n[0]=(1-(b+C))*R,n[1]=(y+D)*R,n[2]=(v-A)*R,n[3]=0,n[4]=(y-D)*P,n[5]=(1-(m+C))*P,n[6]=(x+L)*P,n[7]=0,n[8]=(v+A)*E,n[9]=(x-L)*E,n[10]=(1-(m+b))*E,n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function LF(n,e,t,r,i){var a=e[0],o=e[1],l=e[2],c=e[3],d=a+a,p=o+o,m=l+l,y=a*d,v=a*p,b=a*m,x=o*p,C=o*m,L=l*m,A=c*d,D=c*p,R=c*m,P=r[0],E=r[1],V=r[2],O=i[0],B=i[1],W=i[2],_=(1-(x+L))*P,F=(v+R)*P,N=(b-D)*P,J=(v-R)*E,re=(1-(y+L))*E,pe=(C+A)*E,ye=(b+D)*V,ce=(C-A)*V,fe=(1-(y+x))*V;return n[0]=_,n[1]=F,n[2]=N,n[3]=0,n[4]=J,n[5]=re,n[6]=pe,n[7]=0,n[8]=ye,n[9]=ce,n[10]=fe,n[11]=0,n[12]=t[0]+O-(_*O+J*B+ye*W),n[13]=t[1]+B-(F*O+re*B+ce*W),n[14]=t[2]+W-(N*O+pe*B+fe*W),n[15]=1,n}function kF(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,y=i*o,v=i*l,b=i*c,x=a*o,C=a*l,L=a*c;return n[0]=1-m-b,n[1]=p+L,n[2]=y-C,n[3]=0,n[4]=p-L,n[5]=1-d-b,n[6]=v+x,n[7]=0,n[8]=y+C,n[9]=v-x,n[10]=1-d-m,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function EF(n,e,t,r,i,a,o){var l=1/(t-e),c=1/(i-r),d=1/(a-o);return n[0]=a*2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a*2*c,n[6]=0,n[7]=0,n[8]=(t+e)*l,n[9]=(i+r)*c,n[10]=(o+a)*d,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*a*2*d,n[15]=0,n}function DF(n,e,t,r,i){var a=1/Math.tan(e/2),o;return n[0]=a/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==Infinity?(o=1/(r-i),n[10]=(i+r)*o,n[14]=2*i*r*o):(n[10]=-1,n[14]=-2*r),n}function PF(n,e,t,r){var i=Math.tan(e.upDegrees*Math.PI/180),a=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),l=Math.tan(e.rightDegrees*Math.PI/180),c=2/(o+l),d=2/(i+a);return n[0]=c,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=d,n[6]=0,n[7]=0,n[8]=-((o-l)*c*.5),n[9]=(i-a)*d*.5,n[10]=r/(t-r),n[11]=-1,n[12]=0,n[13]=0,n[14]=r*t/(t-r),n[15]=0,n}function IF(n,e,t,r,i,a,o){var l=1/(e-t),c=1/(r-i),d=1/(a-o);return n[0]=-2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*d,n[11]=0,n[12]=(e+t)*l,n[13]=(i+r)*c,n[14]=(o+a)*d,n[15]=1,n}function AF(n,e,t,r){var i,a,o,l,c,d,p,m,y,v,b=e[0],x=e[1],C=e[2],L=r[0],A=r[1],D=r[2],R=t[0],P=t[1],E=t[2];return Math.abs(b-R)<Ue&&Math.abs(x-P)<Ue&&Math.abs(C-E)<Ue?wL(n):(p=b-R,m=x-P,y=C-E,v=1/Math.hypot(p,m,y),p*=v,m*=v,y*=v,i=A*y-D*m,a=D*p-L*y,o=L*m-A*p,v=Math.hypot(i,a,o),v?(v=1/v,i*=v,a*=v,o*=v):(i=0,a=0,o=0),l=m*o-y*a,c=y*i-p*o,d=p*a-m*i,v=Math.hypot(l,c,d),v?(v=1/v,l*=v,c*=v,d*=v):(l=0,c=0,d=0),n[0]=i,n[1]=l,n[2]=p,n[3]=0,n[4]=a,n[5]=c,n[6]=m,n[7]=0,n[8]=o,n[9]=d,n[10]=y,n[11]=0,n[12]=-(i*b+a*x+o*C),n[13]=-(l*b+c*x+d*C),n[14]=-(p*b+m*x+y*C),n[15]=1,n)}function MF(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=r[0],c=r[1],d=r[2],p=i-t[0],m=a-t[1],y=o-t[2],v=p*p+m*m+y*y;v>0&&(v=1/Math.sqrt(v),p*=v,m*=v,y*=v);var b=c*y-d*m,x=d*p-l*y,C=l*m-c*p;return v=b*b+x*x+C*C,v>0&&(v=1/Math.sqrt(v),b*=v,x*=v,C*=v),n[0]=b,n[1]=x,n[2]=C,n[3]=0,n[4]=m*C-y*x,n[5]=y*b-p*C,n[6]=p*x-m*b,n[7]=0,n[8]=p,n[9]=m,n[10]=y,n[11]=0,n[12]=i,n[13]=a,n[14]=o,n[15]=1,n}function RF(n){return"mat4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+", "+n[9]+", "+n[10]+", "+n[11]+", "+n[12]+", "+n[13]+", "+n[14]+", "+n[15]+")"}function _F(n){return Math.hypot(n[0],n[1],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}function VF(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n[9]=e[9]+t[9],n[10]=e[10]+t[10],n[11]=e[11]+t[11],n[12]=e[12]+t[12],n[13]=e[13]+t[13],n[14]=e[14]+t[14],n[15]=e[15]+t[15],n}function EL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n[9]=e[9]-t[9],n[10]=e[10]-t[10],n[11]=e[11]-t[11],n[12]=e[12]-t[12],n[13]=e[13]-t[13],n[14]=e[14]-t[14],n[15]=e[15]-t[15],n}function OF(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n[9]=e[9]*t,n[10]=e[10]*t,n[11]=e[11]*t,n[12]=e[12]*t,n[13]=e[13]*t,n[14]=e[14]*t,n[15]=e[15]*t,n}function NF(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n[9]=e[9]+t[9]*r,n[10]=e[10]+t[10]*r,n[11]=e[11]+t[11]*r,n[12]=e[12]+t[12]*r,n[13]=e[13]+t[13]*r,n[14]=e[14]+t[14]*r,n[15]=e[15]+t[15]*r,n}function BF(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]}function FF(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=n[9],y=n[10],v=n[11],b=n[12],x=n[13],C=n[14],L=n[15],A=e[0],D=e[1],R=e[2],P=e[3],E=e[4],V=e[5],O=e[6],B=e[7],W=e[8],_=e[9],F=e[10],N=e[11],J=e[12],re=e[13],pe=e[14],ye=e[15];return Math.abs(t-A)<=Ue*Math.max(1,Math.abs(t),Math.abs(A))&&Math.abs(r-D)<=Ue*Math.max(1,Math.abs(r),Math.abs(D))&&Math.abs(i-R)<=Ue*Math.max(1,Math.abs(i),Math.abs(R))&&Math.abs(a-P)<=Ue*Math.max(1,Math.abs(a),Math.abs(P))&&Math.abs(o-E)<=Ue*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(l-V)<=Ue*Math.max(1,Math.abs(l),Math.abs(V))&&Math.abs(c-O)<=Ue*Math.max(1,Math.abs(c),Math.abs(O))&&Math.abs(d-B)<=Ue*Math.max(1,Math.abs(d),Math.abs(B))&&Math.abs(p-W)<=Ue*Math.max(1,Math.abs(p),Math.abs(W))&&Math.abs(m-_)<=Ue*Math.max(1,Math.abs(m),Math.abs(_))&&Math.abs(y-F)<=Ue*Math.max(1,Math.abs(y),Math.abs(F))&&Math.abs(v-N)<=Ue*Math.max(1,Math.abs(v),Math.abs(N))&&Math.abs(b-J)<=Ue*Math.max(1,Math.abs(b),Math.abs(J))&&Math.abs(x-re)<=Ue*Math.max(1,Math.abs(x),Math.abs(re))&&Math.abs(C-pe)<=Ue*Math.max(1,Math.abs(C),Math.abs(pe))&&Math.abs(L-ye)<=Ue*Math.max(1,Math.abs(L),Math.abs(ye))}var UF=TL,WF=EL;var Je={};jl(Je,{add:()=>l3,calculateW:()=>XU,clone:()=>i3,conjugate:()=>t3,copy:()=>o3,create:()=>Ky,dot:()=>JL,equals:()=>h3,exactEquals:()=>f3,exp:()=>zL,fromEuler:()=>n3,fromMat3:()=>$L,fromValues:()=>a3,getAngle:()=>JU,getAxisAngle:()=>jU,identity:()=>$U,invert:()=>e3,len:()=>d3,length:()=>qL,lerp:()=>u3,ln:()=>HL,mul:()=>c3,multiply:()=>GL,normalize:()=>Xy,pow:()=>QU,random:()=>ZU,rotateX:()=>qU,rotateY:()=>YU,rotateZ:()=>KU,rotationTo:()=>m3,scale:()=>jL,set:()=>s3,setAxes:()=>y3,setAxisAngle:()=>WL,slerp:()=>bf,sqlerp:()=>g3,sqrLen:()=>p3,squaredLength:()=>YL,str:()=>r3});var K={};jl(K,{add:()=>$F,angle:()=>dU,bezier:()=>rU,ceil:()=>jF,clone:()=>GF,copy:()=>zF,create:()=>gf,cross:()=>Nu,dist:()=>SU,distance:()=>ML,div:()=>vU,divide:()=>AL,dot:()=>yf,equals:()=>mU,exactEquals:()=>hU,floor:()=>JF,forEach:()=>CU,fromValues:()=>ql,hermite:()=>nU,inverse:()=>eU,len:()=>By,length:()=>DL,lerp:()=>tU,max:()=>YF,min:()=>qF,mul:()=>yU,multiply:()=>IL,negate:()=>ZF,normalize:()=>Ou,random:()=>iU,rotateX:()=>lU,rotateY:()=>cU,rotateZ:()=>uU,round:()=>KF,scale:()=>XF,scaleAndAdd:()=>QF,set:()=>HF,sqrDist:()=>bU,sqrLen:()=>xU,squaredDistance:()=>RL,squaredLength:()=>_L,str:()=>fU,sub:()=>gU,subtract:()=>PL,transformMat3:()=>oU,transformMat4:()=>aU,transformQuat:()=>sU,zero:()=>pU});function gf(){var n=new ht(3);return ht!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function GF(n){var e=new ht(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function DL(n){var e=n[0],t=n[1],r=n[2];return Math.hypot(e,t,r)}function ql(n,e,t){var r=new ht(3);return r[0]=n,r[1]=e,r[2]=t,r}function zF(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n}function HF(n,e,t,r){return n[0]=e,n[1]=t,n[2]=r,n}function $F(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n}function PL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function IL(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n}function AL(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n}function jF(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n}function JF(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n}function qF(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n}function YF(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n}function KF(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n}function XF(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function QF(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n}function ML(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return Math.hypot(t,r,i)}function RL(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return t*t+r*r+i*i}function _L(n){var e=n[0],t=n[1],r=n[2];return e*e+t*t+r*r}function ZF(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function eU(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n}function Ou(n,e){var t=e[0],r=e[1],i=e[2],a=t*t+r*r+i*i;return a>0&&(a=1/Math.sqrt(a)),n[0]=e[0]*a,n[1]=e[1]*a,n[2]=e[2]*a,n}function yf(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function Nu(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2];return n[0]=i*c-a*l,n[1]=a*o-r*c,n[2]=r*l-i*o,n}function tU(n,e,t,r){var i=e[0],a=e[1],o=e[2];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n}function nU(n,e,t,r,i,a){var o=a*a,l=o*(2*a-3)+1,c=o*(a-2)+a,d=o*(a-1),p=o*(3-2*a);return n[0]=e[0]*l+t[0]*c+r[0]*d+i[0]*p,n[1]=e[1]*l+t[1]*c+r[1]*d+i[1]*p,n[2]=e[2]*l+t[2]*c+r[2]*d+i[2]*p,n}function rU(n,e,t,r,i,a){var o=1-a,l=o*o,c=a*a,d=l*o,p=3*a*l,m=3*c*o,y=c*a;return n[0]=e[0]*d+t[0]*p+r[0]*m+i[0]*y,n[1]=e[1]*d+t[1]*p+r[1]*m+i[1]*y,n[2]=e[2]*d+t[2]*p+r[2]*m+i[2]*y,n}function iU(n,e){e=e||1;var t=Lr()*2*Math.PI,r=Lr()*2-1,i=Math.sqrt(1-r*r)*e;return n[0]=Math.cos(t)*i,n[1]=Math.sin(t)*i,n[2]=r*e,n}function aU(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[3]*r+t[7]*i+t[11]*a+t[15];return o=o||1,n[0]=(t[0]*r+t[4]*i+t[8]*a+t[12])/o,n[1]=(t[1]*r+t[5]*i+t[9]*a+t[13])/o,n[2]=(t[2]*r+t[6]*i+t[10]*a+t[14])/o,n}function oU(n,e,t){var r=e[0],i=e[1],a=e[2];return n[0]=r*t[0]+i*t[3]+a*t[6],n[1]=r*t[1]+i*t[4]+a*t[7],n[2]=r*t[2]+i*t[5]+a*t[8],n}function sU(n,e,t){var r=t[0],i=t[1],a=t[2],o=t[3],l=e[0],c=e[1],d=e[2],p=i*d-a*c,m=a*l-r*d,y=r*c-i*l,v=i*y-a*m,b=a*p-r*y,x=r*m-i*p,C=o*2;return p*=C,m*=C,y*=C,v*=2,b*=2,x*=2,n[0]=l+p+v,n[1]=c+m+b,n[2]=d+y+x,n}function lU(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function cU(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function uU(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function dU(n,e){var t=ql(n[0],n[1],n[2]),r=ql(e[0],e[1],e[2]);Ou(t,t),Ou(r,r);var i=yf(t,r);return i>1?0:i<-1?Math.PI:Math.acos(i)}function pU(n){return n[0]=0,n[1]=0,n[2]=0,n}function fU(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"}function hU(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}function mU(n,e){var t=n[0],r=n[1],i=n[2],a=e[0],o=e[1],l=e[2];return Math.abs(t-a)<=Ue*Math.max(1,Math.abs(t),Math.abs(a))&&Math.abs(r-o)<=Ue*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=Ue*Math.max(1,Math.abs(i),Math.abs(l))}var gU=PL,yU=IL,vU=AL,SU=ML,bU=RL,By=DL,xU=_L,CU=function(){var n=gf();return function(e,t,r,i,a,o){var l,c;for(t||(t=3),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2];return e}}();var Gn={};jl(Gn,{add:()=>zy,ceil:()=>wU,clone:()=>Fy,copy:()=>Wy,create:()=>VL,cross:()=>AU,dist:()=>UU,distance:()=>FL,div:()=>FU,divide:()=>BL,dot:()=>jy,equals:()=>Yy,exactEquals:()=>qy,floor:()=>TU,forEach:()=>HU,fromValues:()=>Uy,inverse:()=>IU,len:()=>GU,length:()=>vf,lerp:()=>Jy,max:()=>kU,min:()=>LU,mul:()=>BU,multiply:()=>NL,negate:()=>PU,normalize:()=>$y,random:()=>MU,round:()=>EU,scale:()=>Hy,scaleAndAdd:()=>DU,set:()=>Gy,sqrDist:()=>WU,sqrLen:()=>zU,squaredDistance:()=>UL,squaredLength:()=>Sf,str:()=>OU,sub:()=>NU,subtract:()=>OL,transformMat4:()=>RU,transformQuat:()=>_U,zero:()=>VU});function VL(){var n=new ht(4);return ht!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function Fy(n){var e=new ht(4);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e}function Uy(n,e,t,r){var i=new ht(4);return i[0]=n,i[1]=e,i[2]=t,i[3]=r,i}function Wy(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n}function Gy(n,e,t,r,i){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n}function zy(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n}function OL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n}function NL(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n}function BL(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n}function wU(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n[3]=Math.ceil(e[3]),n}function TU(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n[3]=Math.floor(e[3]),n}function LU(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n[3]=Math.min(e[3],t[3]),n}function kU(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n[3]=Math.max(e[3],t[3]),n}function EU(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n[3]=Math.round(e[3]),n}function Hy(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n}function DU(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n}function FL(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return Math.hypot(t,r,i,a)}function UL(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return t*t+r*r+i*i+a*a}function vf(n){var e=n[0],t=n[1],r=n[2],i=n[3];return Math.hypot(e,t,r,i)}function Sf(n){var e=n[0],t=n[1],r=n[2],i=n[3];return e*e+t*t+r*r+i*i}function PU(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=-e[3],n}function IU(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n[3]=1/e[3],n}function $y(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o)),n[0]=t*o,n[1]=r*o,n[2]=i*o,n[3]=a*o,n}function jy(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]+n[3]*e[3]}function AU(n,e,t,r){var i=t[0]*r[1]-t[1]*r[0],a=t[0]*r[2]-t[2]*r[0],o=t[0]*r[3]-t[3]*r[0],l=t[1]*r[2]-t[2]*r[1],c=t[1]*r[3]-t[3]*r[1],d=t[2]*r[3]-t[3]*r[2],p=e[0],m=e[1],y=e[2],v=e[3];return n[0]=m*d-y*c+v*l,n[1]=-(p*d)+y*o-v*a,n[2]=p*c-m*o+v*i,n[3]=-(p*l)+m*a-y*i,n}function Jy(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n[3]=l+r*(t[3]-l),n}function MU(n,e){e=e||1;var t,r,i,a,o,l;do t=Lr()*2-1,r=Lr()*2-1,o=t*t+r*r;while(o>=1);do i=Lr()*2-1,a=Lr()*2-1,l=i*i+a*a;while(l>=1);var c=Math.sqrt((1-o)/l);return n[0]=e*t,n[1]=e*r,n[2]=e*i*c,n[3]=e*a*c,n}function RU(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3];return n[0]=t[0]*r+t[4]*i+t[8]*a+t[12]*o,n[1]=t[1]*r+t[5]*i+t[9]*a+t[13]*o,n[2]=t[2]*r+t[6]*i+t[10]*a+t[14]*o,n[3]=t[3]*r+t[7]*i+t[11]*a+t[15]*o,n}function _U(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2],d=t[3],p=d*r+l*a-c*i,m=d*i+c*r-o*a,y=d*a+o*i-l*r,v=-o*r-l*i-c*a;return n[0]=p*d+v*-o+m*-c-y*-l,n[1]=m*d+v*-l+y*-o-p*-c,n[2]=y*d+v*-c+p*-l-m*-o,n[3]=e[3],n}function VU(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n}function OU(n){return"vec4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}function qy(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]}function Yy(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=e[0],l=e[1],c=e[2],d=e[3];return Math.abs(t-o)<=Ue*Math.max(1,Math.abs(t),Math.abs(o))&&Math.abs(r-l)<=Ue*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=Ue*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-d)<=Ue*Math.max(1,Math.abs(a),Math.abs(d))}var NU=OL,BU=NL,FU=BL,UU=FL,WU=UL,GU=vf,zU=Sf,HU=function(){var n=VL();return function(e,t,r,i,a,o){var l,c;for(t||(t=4),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],n[3]=e[l+3],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2],e[l+3]=n[3];return e}}();function Ky(){var n=new ht(4);return ht!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function $U(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function WL(n,e,t){t=t*.5;var r=Math.sin(t);return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=Math.cos(t),n}function jU(n,e){var t=Math.acos(e[3])*2,r=Math.sin(t/2);return r>Ue?(n[0]=e[0]/r,n[1]=e[1]/r,n[2]=e[2]/r):(n[0]=1,n[1]=0,n[2]=0),t}function JU(n,e){var t=JL(n,e);return Math.acos(2*t*t-1)}function GL(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=t[0],c=t[1],d=t[2],p=t[3];return n[0]=r*p+o*l+i*d-a*c,n[1]=i*p+o*c+a*l-r*d,n[2]=a*p+o*d+r*c-i*l,n[3]=o*p-r*l-i*c-a*d,n}function qU(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+o*l,n[1]=i*c+a*l,n[2]=a*c-i*l,n[3]=o*c-r*l,n}function YU(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c-a*l,n[1]=i*c+o*l,n[2]=a*c+r*l,n[3]=o*c-i*l,n}function KU(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+i*l,n[1]=i*c-r*l,n[2]=a*c+o*l,n[3]=o*c-a*l,n}function XU(n,e){var t=e[0],r=e[1],i=e[2];return n[0]=t,n[1]=r,n[2]=i,n[3]=Math.sqrt(Math.abs(1-t*t-r*r-i*i)),n}function zL(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=Math.exp(a),c=o>0?l*Math.sin(o)/o:0;return n[0]=t*c,n[1]=r*c,n[2]=i*c,n[3]=l*Math.cos(o),n}function HL(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=o>0?Math.atan2(o,a)/o:0;return n[0]=t*l,n[1]=r*l,n[2]=i*l,n[3]=.5*Math.log(t*t+r*r+i*i+a*a),n}function QU(n,e,t){return HL(n,e),jL(n,n,t),zL(n,n),n}function bf(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=t[0],d=t[1],p=t[2],m=t[3],y,v,b,x,C;return v=i*c+a*d+o*p+l*m,v<0&&(v=-v,c=-c,d=-d,p=-p,m=-m),1-v>Ue?(y=Math.acos(v),b=Math.sin(y),x=Math.sin((1-r)*y)/b,C=Math.sin(r*y)/b):(x=1-r,C=r),n[0]=x*i+C*c,n[1]=x*a+C*d,n[2]=x*o+C*p,n[3]=x*l+C*m,n}function ZU(n){var e=Lr(),t=Lr(),r=Lr(),i=Math.sqrt(1-e),a=Math.sqrt(e);return n[0]=i*Math.sin(2*Math.PI*t),n[1]=i*Math.cos(2*Math.PI*t),n[2]=a*Math.sin(2*Math.PI*r),n[3]=a*Math.cos(2*Math.PI*r),n}function e3(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a,l=o?1/o:0;return n[0]=-t*l,n[1]=-r*l,n[2]=-i*l,n[3]=a*l,n}function t3(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n}function $L(n,e){var t=e[0]+e[4]+e[8],r;if(t>0)r=Math.sqrt(t+1),n[3]=.5*r,r=.5/r,n[0]=(e[5]-e[7])*r,n[1]=(e[6]-e[2])*r,n[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;r=Math.sqrt(e[i*3+i]-e[a*3+a]-e[o*3+o]+1),n[i]=.5*r,r=.5/r,n[3]=(e[a*3+o]-e[o*3+a])*r,n[a]=(e[a*3+i]+e[i*3+a])*r,n[o]=(e[o*3+i]+e[i*3+o])*r}return n}function n3(n,e,t,r){var i=.5*Math.PI/180;e*=i,t*=i,r*=i;var a=Math.sin(e),o=Math.cos(e),l=Math.sin(t),c=Math.cos(t),d=Math.sin(r),p=Math.cos(r);return n[0]=a*c*p-o*l*d,n[1]=o*l*p+a*c*d,n[2]=o*c*d-a*l*p,n[3]=o*c*p+a*l*d,n}function r3(n){return"quat("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}var i3=Fy,a3=Uy,o3=Wy,s3=Gy,l3=zy,c3=GL,jL=Hy,JL=jy,u3=Jy,qL=vf,d3=qL,YL=Sf,p3=YL,Xy=$y,f3=qy,h3=Yy,m3=function(){var n=gf(),e=ql(1,0,0),t=ql(0,1,0);return function(r,i,a){var o=yf(i,a);return o<-.999999?(Nu(n,e,i),By(n)<1e-6&&Nu(n,t,i),Ou(n,n),WL(r,n,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Nu(n,i,a),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=1+o,Xy(r,r))}}(),g3=function(){var n=Ky(),e=Ky();return function(t,r,i,a,o,l){return bf(n,r,o,l),bf(e,i,a,l),bf(t,n,e,2*l*(1-l)),t}}(),y3=function(){var n=Ny();return function(e,t,r,i){return n[0]=r[0],n[3]=r[1],n[6]=r[2],n[1]=i[0],n[4]=i[1],n[7]=i[2],n[2]=-t[0],n[5]=-t[1],n[8]=-t[2],Xy(e,$L(e,n))}}();var lr={};jl(lr,{add:()=>C3,angle:()=>G3,ceil:()=>w3,clone:()=>v3,copy:()=>b3,create:()=>KL,cross:()=>_3,dist:()=>X3,distance:()=>ek,div:()=>K3,divide:()=>ZL,dot:()=>R3,equals:()=>j3,exactEquals:()=>$3,floor:()=>T3,forEach:()=>e4,fromValues:()=>S3,inverse:()=>A3,len:()=>J3,length:()=>nk,lerp:()=>V3,max:()=>k3,min:()=>L3,mul:()=>Y3,multiply:()=>QL,negate:()=>I3,normalize:()=>M3,random:()=>O3,rotate:()=>W3,round:()=>E3,scale:()=>D3,scaleAndAdd:()=>P3,set:()=>x3,sqrDist:()=>Q3,sqrLen:()=>Z3,squaredDistance:()=>tk,squaredLength:()=>rk,str:()=>H3,sub:()=>q3,subtract:()=>XL,transformMat2:()=>N3,transformMat2d:()=>B3,transformMat3:()=>F3,transformMat4:()=>U3,zero:()=>z3});function KL(){var n=new ht(2);return ht!=Float32Array&&(n[0]=0,n[1]=0),n}function v3(n){var e=new ht(2);return e[0]=n[0],e[1]=n[1],e}function S3(n,e){var t=new ht(2);return t[0]=n,t[1]=e,t}function b3(n,e){return n[0]=e[0],n[1]=e[1],n}function x3(n,e,t){return n[0]=e,n[1]=t,n}function C3(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n}function XL(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n}function QL(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n}function ZL(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n}function w3(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n}function T3(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n}function L3(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n}function k3(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n}function E3(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n}function D3(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n}function P3(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n}function ek(n,e){var t=e[0]-n[0],r=e[1]-n[1];return Math.hypot(t,r)}function tk(n,e){var t=e[0]-n[0],r=e[1]-n[1];return t*t+r*r}function nk(n){var e=n[0],t=n[1];return Math.hypot(e,t)}function rk(n){var e=n[0],t=n[1];return e*e+t*t}function I3(n,e){return n[0]=-e[0],n[1]=-e[1],n}function A3(n,e){return n[0]=1/e[0],n[1]=1/e[1],n}function M3(n,e){var t=e[0],r=e[1],i=t*t+r*r;return i>0&&(i=1/Math.sqrt(i)),n[0]=e[0]*i,n[1]=e[1]*i,n}function R3(n,e){return n[0]*e[0]+n[1]*e[1]}function _3(n,e,t){var r=e[0]*t[1]-e[1]*t[0];return n[0]=n[1]=0,n[2]=r,n}function V3(n,e,t,r){var i=e[0],a=e[1];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n}function O3(n,e){e=e||1;var t=Lr()*2*Math.PI;return n[0]=Math.cos(t)*e,n[1]=Math.sin(t)*e,n}function N3(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i,n[1]=t[1]*r+t[3]*i,n}function B3(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i+t[4],n[1]=t[1]*r+t[3]*i+t[5],n}function F3(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[3]*i+t[6],n[1]=t[1]*r+t[4]*i+t[7],n}function U3(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[4]*i+t[12],n[1]=t[1]*r+t[5]*i+t[13],n}function W3(n,e,t,r){var i=e[0]-t[0],a=e[1]-t[1],o=Math.sin(r),l=Math.cos(r);return n[0]=i*l-a*o+t[0],n[1]=i*o+a*l+t[1],n}function G3(n,e){var t=n[0],r=n[1],i=e[0],a=e[1],o=t*t+r*r;o>0&&(o=1/Math.sqrt(o));var l=i*i+a*a;l>0&&(l=1/Math.sqrt(l));var c=(t*i+r*a)*o*l;return c>1?0:c<-1?Math.PI:Math.acos(c)}function z3(n){return n[0]=0,n[1]=0,n}function H3(n){return"vec2("+n[0]+", "+n[1]+")"}function $3(n,e){return n[0]===e[0]&&n[1]===e[1]}function j3(n,e){var t=n[0],r=n[1],i=e[0],a=e[1];return Math.abs(t-i)<=Ue*Math.max(1,Math.abs(t),Math.abs(i))&&Math.abs(r-a)<=Ue*Math.max(1,Math.abs(r),Math.abs(a))}var J3=nk,q3=XL,Y3=QL,K3=ZL,X3=ek,Q3=tk,Z3=rk,e4=function(){var n=KL();return function(e,t,r,i,a,o){var l,c;for(t||(t=2),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],a(n,n,o),e[l]=n[0],e[l+1]=n[1];return e}}();var xf=ie.create(),ik=["x","y","z"],Ur=[K.fromValues(1,0,0),K.fromValues(0,1,0),K.fromValues(0,0,1)],M5=K.fromValues(0,0,0),Bu=Gn.fromValues(0,0,0,0),Cf=K.fromValues(1,1,1),R5=K.fromValues(Infinity,Infinity,Infinity),_5=Je.create();function Fu(n){return n[0]*n[1]*n[2]}function To(n){return`${n[0]},${n[1]},${n[2]}`}function ak(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[4]*i+t[8]*a,n[1]=t[1]*r+t[5]*i+t[9]*a,n[2]=t[2]*r+t[6]*i+t[10]*a,n}function wf(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[1]*i+t[2]*a,n[1]=t[4]*r+t[5]*i+t[6]*a,n[2]=t[8]*r+t[9]*i+t[10]*a,n}function t4(n,e,t){let r=t.length,i=0;for(let o=0;o<r;++o)i+=(n[o]-e[o])**2;let a=0;for(let o=0;o<r;++o){let l=n[o];a-=(l-t[o])*(e[o]-l)}return a/Math.max(i,1e-6)}function ok(n,e,t,r){let i=n.length,a=t4(e,t,r);a=Math.max(0,Math.min(1,a));for(let o=0;o<i;++o){let l=e[o];n[o]=l+a*(t[o]-l)}return n}function Ts(n,e){let t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=t,n[1]=r,n[2]=i,n[3]=a,n[4]=o,n[5]=l,n[6]=c,n[7]=d,n[8]=p,n}function Ls(n,e){let t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],L=e[15];n[0]=a+t,n[1]=d+o,n[2]=v+p,n[3]=L+b,n[4]=a-t,n[5]=d-o,n[6]=v-p,n[7]=L-b,n[8]=a+r,n[9]=d+l,n[10]=v+m,n[11]=L+x,n[12]=a-r,n[13]=d-l,n[14]=v-m,n[15]=L-x;let A=a+i,D=d+c,R=v+y,P=L+C,E=a-i,V=d-c,O=v-y,B=L-C,W=Math.sqrt(A**2+D**2+R**2);n[16]=A/W,n[17]=D/W,n[18]=R/W,n[19]=P/W;let _=Math.sqrt(E**2+V**2+O**2);return n[20]=E/_,n[21]=V/_,n[22]=O/_,n[23]=B/_,n}function Tf(n,e,t,r,i,a,o){for(let l=0;l<6;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}return!0}function sk(n,e,t,r,i,a,o){for(let l=0;l<4;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}{let l=5,c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3],y=Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a),v=Math.min(c*n,c*r)+Math.min(d*e,d*i)+Math.min(p*t,p*a),b=Math.abs(m)*1e-6;if(v>-m+b||y<-m-b)return!1}return!0}function ks(n,e,t,r=!1){let i=t.length,a=[],o=r?1:e+1,l=r?e+1:1;for(let c=0;c<i;++c){let d=t[c];for(let p=0;p<e;++p)n[p*o+d*l]!==0&&(a[p]=!0)}return VT(a,!0)}function Qy(n,e,t){for(let r=0;r<3;++r){let i=t[r];for(let a=0;a<3;++a)n[r+a*3]=i*e[r+a*3]}return n}function lk(n){if(n[15]===1){let o=2/Math.abs(n[10]),l=2/Math.abs(n[0]),c=2/Math.abs(n[5]);return l*c*o}let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return 4/(n[0]*n[5])/3*(Math.abs(i)**3-Math.abs(r)**3)}function Lf(n){if(n[15]===1)return 2/Math.abs(n[10]);let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return Math.abs(i-r)}function ck(n){return n[2]=0,n[6]=0,n[10]=0,n[14]=0,n}var Yl=K.create();function uk(n,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){Yl[0]=2*(t&1)-1,Yl[1]=2*(t>>>1&1)-1,Yl[2]=2*(t>>>2&1)-1,K.transformMat4(Yl,Yl,n);for(let r=0;r<3;++r){let i=Yl[r];e[r]=Math.min(e[r],i),e[r+3]=Math.max(e[r+3],i)}}}function Zy(n){return("0"+n.toString(16)).slice(-2)}function dk(n){return Array.prototype.map.call(n,Zy).join("")}function pk(n){if(!/^(?:[0-9a-fA-F]{2})*$/.test(n))throw new Error("Invalid hex-encoded string");let e=n.length/2,t=new Uint8Array(e);for(let r=0;r<e;++r)t[r]=parseInt(n.substr(r*2,2),16);return t}function n4(n){let e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{let r=n.match(e);if(r!==null)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10),parseFloat(r[4])]}let t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{let r=n.match(t);if(r!==null)return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),1]}throw new Error(`Invalid serialized color: ${JSON.stringify(n)}.`)}function ev(n){try{if(typeof n!="string")throw new Error(`Expected string, but received ${JSON.stringify(n)}.`);let e=document.createElement("canvas").getContext("2d");e.fillStyle=n;let t=n4(e.fillStyle);return Gn.fromValues(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function ra(n){return ev(n).subarray(0,3)}function Uu(n){let e=n[3]===void 0?3:4,t=0;for(let r=0;r<e;r++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(n[e-1-r]*255)));return t}function Ba(n){return K.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255)}function Wu(n){return Gn.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255,(n>>>24&255)/255)}function pn(n){if(n[3]===void 0||n[3]===1){let e="#";for(let t=0;t<3;++t)e+=Zy(Math.min(255,Math.max(0,Math.round(n[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(n[t]*255)));return e+=`, ${bL(n[3])})`,e}}function tv(n){return n<=.03928?n/12.92:((n+.055)/1.055)**2.4}function r4(n){let[e,t,r]=n;return .2126*tv(e)+.7152*tv(t)+.0722*tv(r)}function Gu(n){return r4(n)<=.179}var Lo=class extends Ae{constructor(e){super(K.clone(e));this.defaultValue=e}toString(){return pn(this.value)}toJSON(){if(!K.equals(this.value,this.defaultValue))return pn(this.value)}reset(){this.value=K.clone(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ra(e);K.equals(t,r)||(this.value=r)}},nv=class extends Ae{constructor(){super(void 0)}toJSON(){let{value:e}=this;if(e!==void 0)return pn(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ra(e);(t===void 0||!K.equals(t,r))&&(this.value=r)}};var z;(function(c){c[c.UINT8=0]="UINT8",c[c.INT8=1]="INT8",c[c.UINT16=2]="UINT16",c[c.INT16=3]="INT16",c[c.UINT32=4]="UINT32",c[c.INT32=5]="INT32",c[c.UINT64=6]="UINT64",c[c.FLOAT32=7]="FLOAT32"})(z||(z={}));var kf={[0]:!1,[1]:!0,[2]:!1,[3]:!0,[4]:!1,[5]:!0,[6]:!1,[7]:void 0},Ef={[0]:1,[1]:1,[2]:2,[3]:2,[4]:4,[5]:4,[6]:8,[7]:4},fk={[0]:Uint8Array,[1]:Int8Array,[2]:Uint16Array,[3]:Int16Array,[4]:Uint32Array,[5]:Int32Array,[6]:Uint32Array,[7]:Float32Array},z5={[0]:1,[1]:1,[2]:1,[3]:1,[4]:1,[5]:1,[6]:2,[7]:1};var fn;(function(t){t[t.LITTLE=0]="LITTLE",t[t.BIG=1]="BIG"})(fn||(fn={}));function i4(){let n=Uint16Array.of(4386);return new Uint8Array(n.buffer)[0]===17?1:0}var ia=i4();function En(n){let e=typeof n;if(e==="number"||e==="string"){let t=parseFloat(""+n);if(!Number.isNaN(t))return t}throw new Error(`Expected floating-point number, but received: ${JSON.stringify(n)}.`)}function Ze(n){let e=En(n);if(Number.isFinite(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function Df(n){let e=En(n);if(Number.isFinite(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function dt(n){let e=Ze(n);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function zu(n,e,t=En){Z(e),n[0]=n[1]=n[2]=0;for(let r of Object.keys(e))switch(r){case"x":n[0]=t(e[r]);break;case"y":n[1]=t(e[r]);break;case"z":n[2]=t(e[r]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(e)}.`)}return n}function Kl(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let r=0;r<t;++r)if(!Number.isFinite(parseFloat(e[r])))throw new Error("Non-finite value.");for(let r=0;r<t;++r)n[r]=parseFloat(e[r]);return n}function rv(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let r=0;r<t;++r){let i=parseInt(e[r],void 0);if(!Number.isInteger(i))throw new Error("Non-integer value.")}for(let r=0;r<t;++r)n[r]=parseInt(e[r],void 0);return n}function Dn(n){if(typeof n=="object"){if(n===null)return"null";if(Array.isArray(n)){let a="[",o=n.length,l=0;if(l<o)for(a+=Dn(n[l]);++l<o;)a+=",",a+=Dn(n[l]);return a+="]",a}let e="{",t=Object.keys(n).sort(),r=0,i=t.length;if(r<i){let a=t[r];for(e+=JSON.stringify(a),e+=":",e+=Dn(n[a]);++r<i;)e+=",",a=t[r],e+=JSON.stringify(a),e+=":",e+=Dn(n[a])}return e+="}",e}return JSON.stringify(n)}var hk=/('(?:[^'\\]|(?:\\.))*')/,mk=/("(?:[^"\\]|(?:\\.))*")/,a4=new RegExp(`${hk.source}|${mk.source}`),o4=new RegExp(`${mk.source}|${hk.source}`),s4=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,l4=/^((?:[^"'\\]|(?:\\.))*)'/;function c4(n,e,t,r){if(n.length>=2&&n.charAt(0)===e&&n.charAt(n.length-1)===e){let i=n.substr(1,n.length-2),a=t;for(;i.length>0;){let o=i.match(r);if(o===null){a+=i;break}a+=o[1],o[2]===t?(a+="\\",a+=t):a+=e,i=i.substr(o.index+o[0].length)}return a+=t,a}return n}function u4(n,e,t){let r=/[&_,]/g,i,a,o;t==='"'?(i="'",a=s4,o=a4):(i='"',a=l4,o=o4);let l="";for(;n.length>0;){let c=n.match(o),d,p;if(c===null)d=n,n="",p="";else{d=n.substr(0,c.index),n=n.substr(c.index+c[0].length);let m=c[1];m!==void 0?p=c4(m,i,t,a):p=c[2]}l+=d.replace(r,e),l+=p}return l}function d4(n){return u4(n,",",'"')}function Pf(n){return JSON.parse(d4(n))}function Wr(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);if(e!==void 0&&n.length!==e)throw new Error(`Expected array of length ${e}, but received: ${JSON.stringify(n)}.`);return n}function be(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);return n.map(e)}function $e(n,e,t){let r=n.length;if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected length ${r} array, but received: ${JSON.stringify(e)}.`);for(let i=0;i<r;++i)n[i]=t(e[i],i);return n}function Z(n){if(typeof n!="object"||n==null||Array.isArray(n))throw new Error(`Expected JSON object, but received: ${JSON.stringify(n)}.`);return n}function yt(n){let e=parseInt(n,10);if(!Number.isInteger(e))throw new Error(`Expected integer, but received: ${JSON.stringify(n)}.`);return e}function Rt(n){let e=yt(n);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function If(n,e){let t=e.get(n);if(t===void 0)throw new Error(`Expected one of ${JSON.stringify(Array.from(e.keys()))}, but received: ${JSON.stringify(n)}.`);return t}function ne(n){if(typeof n!="string")throw new Error(`Expected string, but received: ${JSON.stringify(n)}.`);return n}function Yt(n){if(n!==void 0)return ne(n)}function ti(n){if(n!==void 0)return yt(n)}function gk(n){if(n!==void 0){if(typeof n=="boolean")return n;if(n==="true")return!0;if(n==="false")return!1;throw new Error(`Expected string or boolean but received: ${JSON.stringify(n)}`)}}function j(n,e,t){let r=Object.prototype.hasOwnProperty.call(n,e)?n[e]:void 0;try{return t(r)}catch(i){throw new Error(`Error parsing ${JSON.stringify(e)} property: ${i.message}`)}}function de(n,e,t,r){return j(n,e,i=>i===void 0?r:t(i))}function Fa(n,e){Z(n);let t=new Map;for(let r of Object.keys(n))try{t.set(r,e(n[r]))}catch(i){throw new Error(`Error parsing value associated with key ${JSON.stringify(r)}: ${i.message}`)}return t}function Af(n){if(typeof n!="number"||!Number.isFinite(n)||n<0||n>1)throw new Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(n)}.`);return n}function ni(n){if(n==="")return{};if(n.startsWith("{"))return Pf(n);{let e={},t=n.split(/[&;]/);for(let r of t){let i=r.match(/^([^=&;]+)=([^&;]*)$/);if(i===null)throw new Error(`Invalid query string part: ${JSON.stringify(r)}.`);e[i[1]]=decodeURIComponent(i[2])}return e}}function yk(n){if(n===void 0)return"";let e=Object.keys(n);return e.length===0?"":e.some(t=>typeof n[t]!="string")?JSON.stringify(n):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(n[t])}`).join("&")}function Bt(n,e){if(typeof n=="string"&&n.match(/^[a-zA-Z]/)!==null&&(n=n.toUpperCase(),e.hasOwnProperty(n)))return e[n];throw new Error(`Invalid enum value: ${JSON.stringify(n)}.`)}function vk(n){return $e(K.create(),n,Ze)}function Sk(n){return $e(K.create(),n,dt)}function bk(n){return $e(K.create(),n,Rt)}function Zt(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(typeof e!="string")throw new Error(`Expected string, received: ${JSON.stringify(e)}.`);return n}function xk(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(!Number.isInteger(e))throw new Error(`Expected integer, received: ${JSON.stringify(e)}.`);return n}function aa(n){if(typeof n!="boolean")throw new Error(`Expected boolean, received: ${JSON.stringify(n)}`);return n}function wi(n){for(let e in n)return n}var Ck=2**-1074,iv=new Float64Array(1),ko=new Uint32Array(iv.buffer);function wk(n,e){if(isNaN(n)||isNaN(e))return NaN;if(n===e)return e;if(n===0)return e<0?-Ck:Ck;iv[0]=n;let t=ia===fn.LITTLE?0:1,r=1-t;return e>n==n>0?ko[t]===4294967295?(ko[t]=0,ko[r]+=1):ko[t]+=1:ko[t]===0?(ko[t]=4294967295,ko[r]-=1):ko[t]-=1,iv[0]}var av=new Uint32Array(2),Hu=4294967296,ov=[];for(let n=2;n<=36;++n){let e=Math.floor(32/Math.log2(n)),t=Math.pow(n,e),r=`^[0-${String.fromCharCode("0".charCodeAt(0)+Math.min(9,n-1))}`;n>10&&(r+=`a-${String.fromCharCode("a".charCodeAt(0)+n-11)}`,r+=`A-${String.fromCharCode("A".charCodeAt(0)+n-11)}`),r+=`]{1,${Math.ceil(64/Math.log2(n))}}$`;let a=new RegExp(r);ov[n]={lowDigits:e,lowBase:t,pattern:a}}function Tk(n,e){n>>>=0,e>>>=0;let t=n&65535,r=n>>>16,i=e&65535,a=e>>>16,l=(t*i>>>16)+r*i,c=l>>>16;l=(l&65535)+t*a,c+=l>>>16;let d=c>>>16;return c=(c&65535)+r*a,d+=c>>>16,((d&65535)<<16|c&65535)>>>0}var ri=class{constructor(e=0,t=0){this.low=e;this.high=t}clone(){return new ri(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,r=this.high;if(r===0)return t.toString(e);r*=Hu;let{lowBase:i,lowDigits:a}=ov[e],o=r%i;r=Math.floor(r/i),t+=o,r+=Math.floor(t/i),t=t%i;let l=t.toString(e);return r.toString(e)+"0".repeat(a-l.length)+l}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return ri.less(e,t)?e:t}static max(e,t){return ri.less(e,t)?t:e}static random(){return crypto.getRandomValues(av),new ri(av[0],av[1])}tryParseString(e,t=10){let{lowDigits:r,lowBase:i,pattern:a}=ov[t];if(!a.test(e))return!1;if(e.length<=r)return this.low=parseInt(e,t),this.high=0,!0;let o=e.length-r,l=parseInt(e.substr(o),t),c=parseInt(e.substr(0,o),t),d,p;if(i===Hu)d=c,p=l;else{let m=Math.imul(c,i)>>>0;d=Tk(c,i)+(Math.imul(Math.floor(c/Hu),i)>>>0),p=l+m,p>=Hu&&(++d,p-=Hu)}return p>>>0!==p||d>>>0!==d?!1:(this.low=p,this.high=d,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${JSON.stringify(e)}.`);return this}static parseString(e,t=10){return new ri().parseString(e,t)}valid(){let{low:e,high:t}=this;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i<<r,e.high=a<<r|i>>>32-r):(e.low=0,e.high=i<<r-32),e}static rshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i>>>r|a<<32-r,e.high=a>>>r):(e.low=a>>>r-32,e.high=0),e}static or(e,t,r){return e.low=t.low|r.low,e.high=t.high|r.high,e}static xor(e,t,r){return e.low=t.low^r.low,e.high=t.high^r.high,e}static and(e,t,r){return e.low=t.low&r.low,e.high=t.high&r.high,e}static add(e,t,r){let i=t.low+r.low,a=t.high+r.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static addUint32(e,t,r){let i=t.low+r,a=t.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static decrement(e,t){let{low:r,high:i}=t;return r===0&&(i-=1),e.low=r-1>>>0,e.high=i>>>0,e}static increment(e,t){let{low:r,high:i}=t;return r===4294967295&&(i+=1),e.low=r+1>>>0,e.high=i>>>0,e}static subtract(e,t,r){let i=t.low-r.low,a=t.high-r.high,o=i>>>0;return o!==i&&(a-=1),e.low=o,e.high=a>>>0,e}static absDifference(e,t,r){return ri.less(t,r)?ri.subtract(e,r,t):ri.subtract(e,t,r)}static multiplyUint32(e,t,r){let{low:i,high:a}=t;return e.low=Math.imul(i,r)>>>0,e.high=Math.imul(a,r)+Tk(i,r)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}},X=ri;X.ZERO=new ri(0,0),X.ONE=new ri(1,0);var Xl={[z.UINT8]:[0,255],[z.INT8]:[-128,127],[z.UINT16]:[0,65535],[z.INT16]:[-32768,32767],[z.UINT32]:[0,4294967295],[z.INT32]:[-2147483648,2147483647],[z.UINT64]:[X.ZERO,new X(4294967295,4294967295)],[z.FLOAT32]:[0,1]};function kr(n,e){if(typeof e=="number"){let t=n[0],r=n[1];return(e-t)/(r-t)}else{let t=n[0],r=n[1],i;X.compare(e,t)<0?i=-X.subtract(Gr,t,e).toNumber():i=X.subtract(Gr,e,t).toNumber();let a=X.absDifference(Gr,r,t).toNumber();return X.compare(t,r)>0&&(a*=-1),i/a}}function oa(n,e,t){if(typeof n[0]=="number"){let r=n[0],i=n[1],a=r*(1-t)+i*t;if(e!==z.FLOAT32){let o=Xl[e];a=Math.round(a),a=Math.max(o[0],a),a=Math.min(o[1],a)}return a}else{let r=n[0],i=n[1];X.compare(r,i)>0&&([r,i]=[i,r],t=1-t);let a=X.subtract(Gr,i,r).toNumber(),o=new X;return t<=0?(Gr.setFromNumber(a*-t),X.subtract(o,r,X.min(Gr,r))):t>=1?(Gr.setFromNumber(a*(t-1)),X.add(o,i,Gr),X.less(o,i)&&(o.low=o.high=4294967295)):(Gr.setFromNumber(a*t),X.add(o,r,Gr),X.less(o,r)&&(o.low=o.high=4294967295)),o}}function Es(n,e){return typeof e=="number"?Math.min(Math.max(n[0],e),n[1]):X.min(X.max(n[0],e),n[1])}function Ds(n,e){return[Es(n,e[0]),Es(n,e[1])]}function sv(n){if(cr(n[0],n[1])<=0)return n;throw new Error(`Invalid interval: [${n[0]}, ${n[1]}]`)}function Lk(n){return cr(n[0],n[1])<=0?n:[n[1],n[0]]}function cr(n,e){return typeof n=="number"?n-e:X.compare(n,e)}var Gr=new X,p4=new X;function kk(n,e){return typeof e=="number"?Math.abs(e-n[0])<Math.abs(e-n[1])?0:1:X.less(X.absDifference(Gr,n[0],e),X.absDifference(p4,n[1],e))?0:1}function Ua(n,e){let t;switch(typeof e!="string"?t=""+e:t=e,n){case z.UINT64:return X.parseString(t);case z.FLOAT32:{let r=parseFloat(t);if(!Number.isFinite(r))throw new Error(`Invalid float32 value: ${JSON.stringify(t)}`);return r}default:{let r=parseInt(t),i=Xl[n];if(!Number.isInteger(r)||r<i[0]||r>i[1])throw new Error(`Invalid ${z[n].toLowerCase()} value: ${JSON.stringify(t)}`);return r}}}function $u(n,e){return $e(new Array(2),n,t=>Ua(e,t))}function ii(n,e,t){return n===z.UINT64?X.equal(e[0],t[0])&&X.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function lv(n,e,t=Xl[e]){if(!ii(e,n,t))return e===z.UINT64?[n[0].toString(),n[1].toString()]:n}function ju(n,e,t){switch(n){case z.FLOAT32:return wk(e,t*Infinity);case z.UINT64:let r=e;return t===-1?r.low===0&&r.high===0?r:X.decrement(new X,r):r.low===4294967295&&r.high===4294967295?r:X.increment(new X,r);default:{let i=Xl[n];return Math.max(i[0],Math.min(i[1],e+t))}}}function Ek(n,e){switch(n){case z.FLOAT32:return 0;case z.UINT64:return .5/X.absDifference(Gr,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function Ql(n,e){switch(n){case z.FLOAT32:return 1;case z.UINT64:{let t=X.absDifference(Gr,e[0],e[1]).toNumber();return t/(t+1)}default:{let t=Math.abs(e[0]-e[1]);return t/(t+1)}}}function Wa(n=128){let e=Math.ceil(n/32),t=new Uint32Array(e);crypto.getRandomValues(t);let r="";for(let i=0;i<e;++i)r+=("00000000"+t[i].toString(16)).slice(-8);return r}function Dk(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t=65536;for(let r=0,i=e.length;r<i;r+=t)crypto.getRandomValues(e.subarray(r,Math.min(i,r+t)));return n}function cv(){let n=new Uint32Array(1);return crypto.getRandomValues(n),n[0]}var Ju=class extends ${constructor(e){super();this.id=e;this.changed=new ae}},Re;(function(i){i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID"})(Re||(Re={}));var Ti=[0,1,2,3],Eo={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, true);dv.setUint8(${e} + 2, ${n} >>> 16);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(n){return Uu(ra(n))},serializeJson(n){return pn(Ba(n))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, true);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, true);`},deserializeJson(n){return Uu(ev(n))},serializeJson(n){return pn(Wu(n))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setFloat32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(n){return En(n)},serializeJson(n){return n}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(n){return yt(n)},serializeJson(n){return n}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setInt32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(n){return yt(n)},serializeJson(n){return n}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(n){return yt(n)},serializeJson(n){return n}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setInt16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(n){return yt(n)},serializeJson(n){return n}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(n,e){return`dv.setUint8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getUint8(${e});`},deserializeJson(n){return yt(n)},serializeJson(n){return n}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(n,e){return`dv.setInt8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getInt8(${e});`},deserializeJson(n){return yt(n)},serializeJson(n){return n}}};function uv(n,e){let t=0,r=e.length,i=new Array(r);for(let l=0;l<r;++l)i[l]=l;let a=l=>Eo[e[l].type].alignment(n);i.sort((l,c)=>a(c)-a(l));let o=new Array(r);for(let l=0;l<r;++l){let c=i[l],d=e[c],p=Eo[d.type],m=p.serializedBytes(n),y=p.alignment(n);t+=(y-t%y)%y,o[c]=t,t+=m}return t+=(4-t%4)%4,{serializedBytes:t,offsets:o}}var Ps=class{constructor(e,t){this.rank=e;this.propertySpecs=t;if(t.length===0){this.serializedBytes=0,this.serialize=this.deserialize=()=>{};return}let r="",i="",{serializedBytes:a,offsets:o}=uv(e,t),l=t.length;for(let c=0;c<l;++c){let d=t[c],p=Eo[d.type],m=`properties[${c}]`,y=`offset + ${o[c]}`;r+=p.serializeCode(m,y,e),i+=p.deserializeCode(m,y,e)}this.serializedBytes=a,this.serialize=new Function("dv","offset","isLittleEndian","properties",r),this.deserialize=new Function("dv","offset","isLittleEndian","properties",i)}};function dv(n,e){let t=n.type==="float32"?e.toPrecision(6):e.toString(),{enumValues:r,enumLabels:i}=n;if(r!==void 0){let a=r.indexOf(e);if(a!==-1)return`${i[a]} (${t})`}return t}function Pk(n,e){switch(n.type){case"rgb":return pn(Ba(e));case"rgba":return pn(Wu(e));default:return dv(n,e)}}function f4(n){let e=ne(n);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${JSON.stringify(n)}`);return e}function h4(n){if(ne(n),!Object.prototype.hasOwnProperty.call(Eo,n))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return n}function m4(n){let e=new Set;for(let t of n){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function g4(n){Z(n);let e=j(n,"id",f4),t=j(n,"type",h4),r=de(n,"description",ne),i=de(n,"default",l=>Eo[t].deserializeJson(l),0),a,o;switch(t){case"rgb":case"rgba":break;default:{let l=z[t.toUpperCase()];a=de(n,"enum_values",c=>be(c,d=>Ua(l,d))),a!==void 0&&(o=j(n,"enum_labels",c=>$e(new Array(a.length),c,ne)))}}return{type:t,identifier:e,description:r,default:i,enumValues:a,enumLabels:o}}function y4(n){let e=n.default;return{id:n.identifier,description:n.description,type:n.type,default:e===0?void 0:Eo[n.type].serializeJson(e)}}function Ik(n){if(!(n===void 0||n.length===0))return n.map(y4)}function Mf(n){if(n===void 0)return[];let e=be(n,g4);return m4(e),e}function pv(n,e,t,r,i){for(let a=0;a<r;++a)n.setFloat32(e,i[a],t),e+=4;return e}function fv(n,e,t,r,i,a){return e=pv(n,e,t,r,i),e=pv(n,e,t,r,a),e}function hv(n,e,t,r,i){for(let a=0;a<r;++a)i[a]=n.getFloat32(e,t),e+=4;return e}function mv(n,e,t,r,i,a){return e=hv(n,e,t,r,i),e=hv(n,e,t,r,a),e}var Kt={[1]:{icon:"\uA579",description:"Line",toJSON(n){return{pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}},restoreState(n,e,t){n.pointA=j(e,"pointA",r=>$e(new Float32Array(t),r,Ze)),n.pointB=j(e,"pointB",r=>$e(new Float32Array(t),r,Ze))},serializedBytes(n){return 2*4*n},serialize(n,e,t,r,i){fv(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return mv(n,e,t,r,a,o),{type:1,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[0]:{icon:"\u26AC",description:"Point",toJSON:n=>({point:Array.from(n.point)}),restoreState:(n,e,t)=>{n.point=j(e,"point",r=>$e(new Float32Array(t),r,Ze))},serializedBytes:n=>n*4,serialize:(n,e,t,r,i)=>{pv(n,e,t,r,i.point)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r);return hv(n,e,t,r,a),{type:0,point:a,id:i,properties:[]}},visitGeometry(n,e){e(n.point,!1)}},[2]:{icon:"\u2751",description:"Bounding Box",toJSON:n=>({pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}),restoreState:(n,e,t)=>{n.pointA=j(e,"pointA",r=>$e(new Float32Array(t),r,Ze)),n.pointB=j(e,"pointB",r=>$e(new Float32Array(t),r,Ze))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){fv(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return mv(n,e,t,r,a,o),{type:2,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[3]:{icon:"\u25CE",description:"Ellipsoid",toJSON:n=>({center:Array.from(n.center),radii:Array.from(n.radii)}),restoreState:(n,e,t)=>{n.center=j(e,"center",r=>$e(new Float32Array(t),r,Ze)),n.radii=j(e,"radii",r=>$e(new Float32Array(t),r,Df))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){fv(n,e,t,r,i.center,i.radii)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return mv(n,e,t,r,a,o),{type:3,center:a,radii:o,id:i,properties:[]}},visitGeometry(n,e){e(n.center,!1),e(n.radii,!0)}}};function Rf(n,e){let t=Kt[n.type].toJSON(n,e.rank);t.type=Re[n.type].toLowerCase(),t.id=n.id,t.description=n.description||void 0;let{relatedSegments:r}=n;if(r!==void 0&&r.some(i=>i.length!==0)&&(t.segments=r.map(i=>i.map(a=>a.toString()))),e.properties.length!==0){let i=e.properties;t.props=n.properties.map((a,o)=>Eo[i[o].type].serializeJson(a))}return t}function v4(n,e,t=!1){Z(n);let r=j(n,"type",c=>Bt(c,Re)),i=j(n,"id",t?Yt:ne)||_f(),a=j(n,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);let d=Wr(c);return d.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(d[0])?[be(d,p=>X.parseString(p))]:be(Wr(c,e.relationships.length),p=>be(p,m=>X.parseString(m)))}),o=j(n,"props",c=>{let d=e.properties;return c===void 0?d.map(p=>p.default):be(Wr(c,e.properties.length),(p,m)=>Eo[d[m].type].deserializeJson(p))}),l={id:i,description:j(n,"description",Yt),relatedSegments:a,properties:o,type:r};return Kt[r].restoreState(l,n,e.rank),l}var Ga=class extends ${constructor(e,t=[],r=[]){super();this.relationships=t;this.properties=r;this.annotationMap=new Map;this.changed=new ae;this.readonly=!1;this.childAdded=new We;this.childUpdated=new We;this.childDeleted=new We;this.pending=new Set;this.references=new Map;this.rank_=e,this.annotationPropertySerializer=new Ps(e,r)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=_f();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();let t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new Ju(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();let e=[],{pending:t}=this;for(let r of this)t.has(r.id)||e.push(Rf(r,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();let{annotationMap:t}=this;t.clear(),this.pending.clear(),e!==void 0&&be(e,r=>{let i=v4(r,this);t.set(i.id,i)});for(let r of this.references.values()){let{id:i}=r,a=t.get(i);r.value=a||null,r.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}},gv=class extends Ga{constructor(e,t,r){super(e.value.sourceRank,r,t);this.watchableTransform=e;this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){let e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;let r=e.sourceRank,i=t.sourceRank;if(i===r&&(t.inputSpace===e.inputSpace||Ce(t.inputSpace.ids.slice(0,r),e.inputSpace.ids.slice(0,r))))return;let{ids:a}=e.inputSpace,o=t.inputSpace.ids,l=[];for(let d=0;d<r;++d){let p=o.indexOf(a[d]);p>=i&&(p=-1),l.push(p)}let c=d=>{let p=new Float32Array(r);for(let m=0;m<r;++m){let y=l[m];p[m]=y===-1?0:d[m]}return p};for(let d of this.annotationMap.values())switch(d.type){case 0:d.point=c(d.point);break;case 1:case 2:d.pointA=c(d.pointA),d.pointB=c(d.pointB);break;case 3:d.center=c(d.center),d.radii=c(d.radii);break}this.rank_!==r&&(this.rank_=r,this.annotationPropertySerializer=new Ps(this.rank_,this.properties)),this.changed.dispatch()}},S4="Data Bounds";function _f(){return Wa(160)}function b4(n){return{type:2,id:"data-bounds",description:S4,pointA:new Float32Array(n.lowerBounds),pointB:new Float32Array(n.upperBounds),properties:[]}}function zn(n){let e=new Ga(n.lowerBounds.length);return e.readonly=!0,e.add(b4(n)),e}function x4(n,e){let{rank:t}=e,r=0,i=[],a=e.serializedBytes;for(let y of Ti){i[y]=r;let b=n[y].length;r+=(Kt[y].serializedBytes(t)+a)*b,r+=(4-r%4)%4}let o=e.serialize,l=[],c=[],d=new ArrayBuffer(r),p=new DataView(d),m=ia===fn.LITTLE;for(let y of Ti){let v=n[y];l[y]=v.map(A=>A.id),c[y]=new Map(v.map((A,D)=>[A.id,D]));let b=Kt[y],x=b.serialize,C=b.serializedBytes(t),L=i[y];for(let A of v)x(p,L,m,t,A),L+=C,o(p,L,m,A.properties),L+=a}return{data:new Uint8Array(d),typeToIds:l,typeToOffset:i,typeToIdMaps:c}}var yv=class{constructor(e){this.propertySerializer=e;this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return x4(this.annotations,this.propertySerializer)}};function vv(n){if(n==null)return n;let{relatedSegments:e}=n;if(e!==void 0)for(let t=0,r=e.length;t<r;++t){let i=e[t];i!==void 0&&(e[t]=i.map(a=>new X(a.low,a.high)))}return n}function Be(n){let e=-1;return Object.assign(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,n()}))},{flush:()=>{e!==-1&&(e=-1,n())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}var Vf=class{constructor(){this.map=new Map}get(e,t){let{map:r}=this,i=r.get(e);return i===void 0?(i=t(),i.registerDisposer(()=>{r.delete(e)}),r.set(e,i)):i.addRef(),i}},qu=class extends Vf{get(e,t){return typeof e!="string"&&(e=Dn(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new Ru(t())).value}};var C4=!1;function Ak(n){let e={antialias:!1,stencil:!0};C4&&(console.log("DEBUGGING via preserveDrawingBuffer"),e.preserveDrawingBuffer=!0);let t=n.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new Vf,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(let r of["EXT_color_buffer_float"])if(!t.getExtension(r))throw new Error(`${r} extension not available`);for(let r of["EXT_float_blend"])t.getExtension(r);return t}var Zl=class{constructor(){this.width=0;this.height=0;this.logicalWidth=0;this.logicalHeight=0;this.visibleLeftFraction=0;this.visibleTopFraction=0;this.visibleWidthFraction=0;this.visibleHeightFraction=0}};function Of(n,e){let t=1/n.visibleWidthFraction,r=1/n.visibleHeightFraction,i=-1-(-1+2*n.visibleLeftFraction)*t,a=-1-(-1+2*n.visibleTopFraction)*r;a=-a,e[0]=e[0]*t+e[3]*i,e[4]=e[4]*t+e[7]*i,e[8]=e[8]*t+e[11]*i,e[12]=e[12]*t+e[15]*i,e[1]=e[1]*r+e[3]*a,e[5]=e[5]*r+e[7]*a,e[9]=e[9]*r+e[11]*a,e[13]=e[13]*r+e[15]*a}function Nf(n,e){return n.width===e.width&&n.height===e.height&&n.logicalWidth===e.logicalWidth&&n.logicalHeight===e.logicalHeight&&n.visibleLeftFraction===e.visibleLeftFraction&&n.visibleTopFraction===e.visibleTopFraction}var Bf=class extends ${constructor(e,t,r){super();this.context=e;this.element=t;this.visibility=r;this.boundsGeneration=-1;this.canvasRelativeClippedLeft=0;this.canvasRelativeClippedTop=0;this.canvasRelativeLogicalLeft=0;this.canvasRelativeLogicalTop=0;this.renderViewport=new Zl;this.boundsObserversRegistered=!1;this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){let{context:e}=this;e.ensureBoundsUpdated();let{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;let{element:r}=this;!this.boundsObserversRegistered&&e.monitorPanel(r)&&(this.boundsObserversRegistered=!0);let i=r.getBoundingClientRect(),a=e.container,o=e.canvasRect,{canvas:l}=e,{width:c,height:d}=l,p=c/o.width,m=d/o.height,y=o.left,v=o.top,b=this.canvasRelativeLogicalLeft=Math.round((i.left-y)*p+r.clientLeft),x=this.canvasRelativeLogicalTop=Math.round((i.top-v)*m+r.clientTop),C=r.clientWidth,L=r.clientHeight,A=b+C,D=x+L,R=x,P=b,E=A,V=D;for(let _=r.parentElement;_!==null&&_!==a;_=_.parentElement){let F=_.getBoundingClientRect();F.x===0&&F.y===0&&F.width===0&&F.height===0||(P=Math.max(P,(F.left-y)*p),R=Math.max(R,(F.top-v)*m),E=Math.min(E,(F.right-y)*p),V=Math.min(V,(F.bottom-v)*m))}R=this.canvasRelativeClippedTop=Math.round(Math.max(R,0)),P=this.canvasRelativeClippedLeft=Math.round(Math.max(P,0)),E=Math.round(Math.min(E,c)),V=Math.round(Math.min(V,d));let O=this.renderViewport,B=O.width=Math.max(0,E-P),W=O.height=Math.max(0,V-R);O.logicalWidth=C,O.logicalHeight=L,O.visibleLeftFraction=(P-b)/C,O.visibleTopFraction=(R-x)/L,O.visibleWidthFraction=B/C,O.visibleHeightFraction=W/L}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:r,renderViewport:{width:i,height:a}}=this,o=t+a;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let l=this.context.canvas.height-o;e.viewport(r,l,i,a),e.scissor(r,l,i,a)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:r,logicalWidth:i,logicalHeight:a}}=this,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+a),i,a),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+r),t,r)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}},Ff=class extends Bf{constructor(e,t,r){super(e,t,r);this.canvas=document.createElement("canvas");this.canvasRenderingContext=this.canvas.getContext("2d");let{canvas:i}=this;t.appendChild(i),t.style.position="relative",i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0"}draw(){this.drawIndirect();let{renderViewport:e,canvas:t}=this,{logicalWidth:r,logicalHeight:i}=e;t.width=r,t.height=i;let{canvasRenderingContext:a}=this;a==null||a.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,r,i,0,0,r,i)}},Sv=class extends ct{constructor(){super(Float64Array.of(0,0,1,1),e=>$e(new Float64Array(4),e,Af))}toJSON(){let{value:e}=this,[t,r,i,a]=e;if(!(t===0&&r==0&&i===1&&a===1))return Array.from(e)}},bv=class extends ${constructor(e){super();this.container=e;this.canvas=document.createElement("canvas");this.updateStarted=new ae;this.updateFinished=new ae;this.changed=this.updateFinished;this.panels=new Set;this.resizeGeneration=0;this.boundsGeneration=-1;this.orderedPanels=[];this.frameNumber=0;this.panelAncestors=new Map;this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()};this.resizeObserver=new ResizeObserver(this.resizeCallback);this.scheduleRedraw=this.registerCancellable(Be(()=>this.draw()));let{canvas:t,resizeObserver:r}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",r.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",i=>{console.log(`Lost WebGL context: ${i.statusMessage}`),i.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=Ak(t)}monitorPanel(e){let{panelAncestors:t,container:r}=this;if(!r.contains(e))return!1;for(;e!==r;){let i=t.get(e);if(i!==void 0){++i.count;break}let a=e.parentElement;i={parent:a,count:1},t.set(e,i),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=a}return!0}unmonitorPanel(e){let{panelAncestors:t,container:r}=this;for(;e!==r;){let i=t.get(e);if(i.count!==1){--i.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=i.parent}}applyWindowedViewportToElement(e,t){let[r,i,a,o]=t,l=1/a,c=1/o;e.style.position="absolute",e.style.top=`${-c*i*100}%`,e.style.left=`${-l*r*100}%`,e.style.width=`${l*100}%`,e.style.height=`${c*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(let e of this.panels)if(!!e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){let{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;let{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);let{orderedPanels:t,panels:r}=this;t.length!==r.size&&(t.push(...r),t.sort((i,a)=>i.drawOrder-a.drawOrder));for(let i of t){if(!i.shouldDraw)continue;i.ensureBoundsUpdated();let{renderViewport:a}=i;a.width===0||a.height===0||i.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){let{width:e,height:t}=this.canvas,r=new Float32Array(e*t);for(let i of this.panels){if(!i.shouldDraw)continue;let a=i.getDepthArray();if(a===void 0)continue;let{canvasRelativeClippedTop:o,canvasRelativeClippedLeft:l,renderViewport:{width:c,height:d}}=i;for(let p=0;p<d;++p){let m=(d-1-p)*c;r.set(a.subarray(m,m+c),(o+p)*c+l)}}return r}};function Uf(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]+t[i];return n}function Wf(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]-t[i];return n}function Mk(n,e,t,r){let i=n.length;for(let a=0;a<i;++a)n[a]=e[a]+t[a]*r;return n}function Rk(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]*t;return n}function ec(n){let e=1;for(let t=0,r=n.length;t<r;++t)e*=n[t];return e}function _k(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=Math.min(e[i],t[i]);return n}var za=new Float32Array(0),xv=new Float64Array(0),AJ=Float64Array.of(1,1,1);var Yu=class extends Zl{constructor(){super(...arguments);this.globalPosition=za;this.projectionMat=ie.create();this.viewMatrix=ie.create();this.invViewMatrix=ie.create();this.viewProjectionMat=ie.create();this.invViewProjectionMat=ie.create()}};function Vk(n,e){return n.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&Nf(n,e)&&Ce(n.globalPosition,e.globalPosition)&&Ce(n.projectionMat,e.projectionMat)&&Ce(n.viewMatrix,e.viewMatrix)}function Gf(n){let{viewMatrix:e,viewProjectionMat:t}=n;ie.invert(e,n.invViewMatrix),ie.multiply(t,n.projectionMat,e),ie.invert(n.invViewProjectionMat,t)}function Is(n,e,t,r,i,a,o,l,c){for(let d=0;d<o;++d)for(let p=0;p<c;++p){let m=0;for(let y=0;y<l;++y)m+=t[d+r*y]*i[y+a*p];n[d+e*p]=m}return n}function w4(n,e,t){for(let r=0;r<t;++r){let i=e*r;n.fill(0,i,i+t),n[i+r]=1}return n}function Hn(n,e,t=e){return w4(new n(e*t),e,Math.min(e,t))}function Cv(n,e,t=!0){let r=e.length,i=t?r+1:r,a=new n(i*(r+1));t&&(a[a.length-1]=1);for(let o=0;o<r;++o)a[(i+1)*o]=e[o];return a}function Ok(n,e,t){for(let r=0;r<t;++r)for(let i=0;i<t;++i)if(n[r*e+i]!=(r===i?1:0))return!1;return!0}function zf(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=o*r,c=o*e;for(let d=0;d<i;++d)n[c+d]=t[l+d]}return n}function Ku(n,e,t,r){zf(n,e+1,t,r+1,r,r);for(let i=0;i<r;++i)n[(e+1)*e+i]=t[(r+1)*r+i];n[n.length-1]=1;for(let i=r;i<e;++i)n[(e+1)*i+i]=1;return n}var ai;function T4(n,e,t){let r=1;(ai===void 0||ai.length<t)&&(ai=new Uint32Array(t));for(let i=0;i<t;++i)ai[i]=i;for(let i=0;i<t;++i){let a=e*i,o=i;{let d=Math.abs(n[a+i]);for(let p=i+1;p<t;++p){let m=Math.abs(n[a+p]);m>d&&(d=m,o=p)}}if(i!==o){r*=-1;for(let d=0;d<t;++d){let p=e*d,m=n[p+i];n[p+i]=n[p+o],n[p+o]=m}{let d=ai[i];ai[i]=ai[o],ai[o]=d}}let l=n[a+i],c=1/l;r*=l;for(let d=0;d<t;++d)n[e*d+i]*=c;n[a+i]=c;for(let d=0;d<t;++d){if(d===i)continue;let p=-n[e*i+d];for(let m=0;m<t;++m){let y=e*m;n[y+d]+=p*n[y+i]}n[e*i+d]=p*c}}for(let i=0;i<t;++i){let a=ai[i];for(;a!==i;){let o=e*i,l=e*a;for(let d=0;d<t;++d){let p=o+d,m=l+d,y=n[p];n[p]=n[m],n[m]=y}let c=ai[i]=ai[a];ai[a]=a,a=c}}return r}function tc(n,e,t,r,i){return zf(n,e,t,r,i,i),T4(n,e,i)}function Nk(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=e*o,c=r*o;for(let d=0;d<i;++d)if(n[l+d]!==t[c+d])return!1}return!0}function zr(n,e,t,r,i){for(let a=0;a<i;++a){let o=e[t*i+a];for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}function Hf(n,e,t,r,i){for(let a=0;a<i;++a){let o=0;for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}var $f=[{prefix:"Y",exponent:24},{prefix:"Z",exponent:21},{prefix:"E",exponent:18},{prefix:"P",exponent:15},{prefix:"T",exponent:12},{prefix:"G",exponent:9},{prefix:"M",exponent:6},{prefix:"k",exponent:3},{prefix:"",exponent:0},{prefix:"c",exponent:-2},{prefix:"m",exponent:-3},{prefix:"\xB5",exponent:-6},{prefix:"n",exponent:-9},{prefix:"p",exponent:-12},{prefix:"f",exponent:-15},{prefix:"a",exponent:-18},{prefix:"z",exponent:-21},{prefix:"y",exponent:-24}],L4=[{prefix:"u",exponent:-6},...$f],nc=new Map;nc.set("",{unit:"",exponent:0});var k4=new Map;for(let{prefix:n,exponent:e}of L4){k4.set(e,n);for(let t of["m","s","Hz","rad/s"])nc.set(`${n}${t}`,{unit:t,exponent:e})}function wv(n){let e=Math.log10(n),t=$f.length,r=_T(0,t,i=>$f[i].exponent<=e);return $f[Math.min(r,t-1)]}function Tv(n,e,t={}){let{precision:r=6,elide1:i=!0}=t,a=n,o="";if(e!==""){let c=wv(n);o=c.prefix,a=Xu(n,-c.exponent)}if(i&&a===1)return{scale:"",unit:e,prefix:o};let l;if(r!=0){a<1||a>=1e3?l=a.toPrecision(r):l=a.toFixed(r);let c=l.indexOf("e"),d,p;c!==-1?(d=l.substring(0,c),p=l.substring(c)):(d=l,p="");let m=d.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);m!==null&&(d=d.substring(0,d.length-m[1].length),d.endsWith(".")&&(d=d.substring(0,d.length-1)),l=d+p)}else l=a.toString();return{scale:l,unit:e,prefix:o}}function Li(n,e,t){let{scale:r,unit:i,prefix:a}=Tv(n,e,t);return`${r}${a}${i}`}function Do(n){if(n==="")return{scale:1,unit:""};let e=n.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([a-zA-Z]+)?$/);if(e===null)return;let t=e[1],r=t===void 0?1:Number(t);if(Number.isNaN(r))return;let i="";if(e[2]!==void 0){let a=nc.get(e[2]);if(a===void 0)return;i=a.unit,a.exponent>0?r*=10**a.exponent:r/=10**-a.exponent}if(!(r<=0||!Number.isFinite(r)))return{scale:r,unit:i}}function jf(n){let e=nc.get(n);if(e===void 0)throw new Error(`Invalid unit: ${JSON.stringify(n)}`);return e}function Xu(n,e){return e>=0?n*10**e:n/10**-e}var E4=0;function As(){return++E4}function D4(n,e){return Ce(n.lowerBounds,e.lowerBounds)&&Ce(n.upperBounds,e.upperBounds)}function P4(n,e){return n===void 0?e===void 0:e===void 0?!1:n.explicit===e.explicit&&Ce(n.coordinates,e.coordinates)&&Ce(n.labels,e.labels)}function I4(n,e){let t=new Map;for(let r=0,i=n.length;r<i;++r)t.set(n[r],e[r]);return n=Array.from(t.keys()),n.sort((r,i)=>r-i),e=Array.from(n,r=>t.get(r)),{coordinates:n,labels:e}}function Bk(n){if(n.length===1)return n[0];let e=new Map,t=!1;for(let a of n){a.explicit&&(t=!0);let{coordinates:o,labels:l}=a;for(let c=0,d=o.length;c<d;++c)e.set(o[c],l[c])}let r=Array.from(e.keys());r.sort((a,o)=>a-o);let i=Array.from(r,a=>e.get(a));return{explicit:t,coordinates:r,labels:i}}function Fk(n){if(n=n.filter(e=>e!==void 0),n.length!==0)return Bk(n)}function A4(n,e){return Ce(n.transform,e.transform)&&D4(n.box,e.box)}function Jf(n,e){return n.valid===e.valid&&n.rank===e.rank&&Ce(n.names,e.names)&&Ce(n.ids,e.ids)&&Ce(n.timestamps,e.timestamps)&&Ce(n.units,e.units)&&Ce(n.scales,e.scales)&&Au(n.boundingBoxes,e.boundingBoxes,A4)&&Au(n.coordinateArrays,e.coordinateArrays,P4)}function Ve(n){let{names:e,units:t,scales:r}=n,{valid:i=!0,rank:a=e.length,timestamps:o=e.map(()=>Number.NEGATIVE_INFINITY),ids:l=e.map((m,y)=>-y),boundingBoxes:c=[]}=n,{coordinateArrays:d=new Array(a)}=n,{bounds:p=R4(c,a)}=n;return{valid:i,rank:a,names:e,timestamps:o,ids:l,units:t,scales:r,boundingBoxes:c,bounds:p,coordinateArrays:d}}var Hr=Ve({valid:!1,names:[],units:[],scales:xv,boundingBoxes:[]}),ki=Ve({valid:!0,names:[],units:[],scales:xv,boundingBoxes:[]});function M4(n){let[e,t]=Wr(n,2),r=dt(e),i=ne(t),a=nc.get(i);if(a===void 0)throw new Error(`Invalid unit: ${JSON.stringify(i)}`);return{unit:a.unit,scale:Xu(r,a.exponent)}}function Qu(n,e=!1){if(n===void 0)return Hr;Z(n);let t=ed(Object.keys(n),e),r=t.length,i=new Array(r),a=new Float64Array(r),o=new Array(r);for(let l=0;l<r;++l)j(n,t[l],c=>{if(Array.isArray(c)){let{unit:d,scale:p}=M4(c);i[l]=d,a[l]=p}else{Z(c);let d=j(c,"coordinates",xk),p=j(c,"labels",Zt),m=d.length;if(m!==p.length)throw new Error(`Length of coordinates array (${m}) does not match length of labels array (${p.length})`);i[l]="",a[l]=1,o[l]={explicit:!0,...I4(d,p)}}});return Ve({valid:!1,names:t,units:i,scales:a,coordinateArrays:o})}function Lv(n){let{rank:e}=n;if(e===0)return;let{names:t,units:r,scales:i,coordinateArrays:a}=n,o={};for(let l=0;l<e;++l){let c=t[l],d=a[l];(d==null?void 0:d.explicit)?o[c]={coordinates:Array.from(d.coordinates),labels:d.labels}:o[c]=[i[l],r[l]]}return o}var Ms=class extends Ae{constructor(){super(Hr)}toJSON(){return Lv(this.value)}reset(){this.value=Hr}restoreState(e){this.value=Qu(e)}};function kv(n,e){let t=(n+e)/2;return Number.isFinite(t)||(t=Math.min(Math.max(0,n),e)),t}function Uk(n,e){let{lowerBounds:t,upperBounds:r}=e,i=n.length;for(let a=0;a<i;++a)n[a]=kv(t[a],r[a]);return n}function ur(n){let e=n.lowerBounds.length;return{box:n,transform:Hn(Float64Array,e,e+1)}}function Ev(n,e,t){let{box:{lowerBounds:r,upperBounds:i},transform:a}=n,o=r.length,l=t,c=a[l*o+e],d=c,p=c,m=!1;for(let y=0;y<o;++y){let v=a[l*y+e];if(v===0)continue;let b=v*r[y],x=v*i[y];d+=Math.min(b,x),p+=Math.max(b,x),m=!0}if(!!m)return{lower:d,upper:p}}function R4(n,e){let t=new Float64Array(e),r=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),r.fill(Number.POSITIVE_INFINITY);for(let i of n)for(let a=0;a<e;++a){let o=Ev(i,a,e);if(o===void 0)continue;let{lower:l,upper:c}=o;t[a]=t[a]===Number.NEGATIVE_INFINITY?l:Math.min(t[a],l),r[a]=r[a]===Number.POSITIVE_INFINITY?c:Math.max(r[a],c)}return{lowerBounds:t,upperBounds:r}}function _4(n,e,t){let{transform:r,box:i}=n,a=t.length,o=i.lowerBounds.length,l=new Float64Array((o+1)*e);for(let c=0;c<a;++c){let d=t[c];if(d!==-1)for(let p=0;p<=o;++p)l[p*e+d]=r[p*a+c]}return{transform:l,box:i}}function Dv(n,e){let t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},r=new Float64Array(2*n);return r[e]=1,{transform:r,box:t}}function Pv(n,e,t){if(e===t)return n;let{box:r}=n,i=r.lowerBounds.length,a=new Float64Array((i+1)*t);return zf(a,t,n.transform,e,e,i+1),{box:r,transform:a}}function Wk(n,e){let{rank:t,sourceRank:r}=n;if(t!==e.rank||r!==e.sourceRank)return!1;let{inputSpace:i}=n,{inputSpace:a}=e;return!Ce(a.scales,i.scales)||!Ce(a.units,i.units)||!Ce(e.outputSpace.names,n.outputSpace.names)?!1:$k(n.transform,t,n.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function wt(n){return{rank:n.rank,sourceRank:n.rank,inputSpace:n,outputSpace:n,transform:Hn(Float64Array,n.rank+1)}}function V4(n,e,t,r){let{transform:i,box:a}=n,o=n.box.lowerBounds.length,l=r.length,c=new Float64Array((o+1)*l);for(let d=0;d<l;++d){let p=r[d];for(let y=0;y<o;++y){let v=0;for(let b=0;b<l;++b){let x=t[b];v+=e[(l+1)*b+d]*i[l*y+b]*(x/p)}c[l*y+d]=v}let m=e[(l+1)*l+d];for(let y=0;y<l;++y){let v=t[y];m+=e[(l+1)*y+d]*i[l*o+y]*(v/p)}c[o*l+d]=m}return{transform:c,box:a}}function Gk(n,e,t){return n.boundingBoxes.map(r=>V4(r,e,n.scales,t))}function Iv(n,e,t){let r=Ve({valid:n.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:Gk(n,e,t.scales),coordinateArrays:t.coordinateArrays});return Jf(r,t)?t:r}function Av(n,e=!1){if(e){let t=Number(n);if(Number.isInteger(t)&&t>=0)return!0}return n.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function rc(n,e=!1){let t=new Set;for(let r of n){if(!Av(r,e)||t.has(r))return!1;t.add(r)}return!0}function Zu(n){let e=n.length,t=new Array(e);t.fill(!0);for(let r=0;r<e;++r){let i=n[r];if(!Av(i)){t[r]=!1;continue}let a=n.indexOf(i,r+1);a!==-1&&(t[r]=!1,t[a]=!1)}return t}function Po(n){return n.endsWith("'")}function Mv(n){return n.endsWith("'")||n.endsWith("^")}function zk(n){return n.endsWith("^")}function Hk(n){return!Mv(n)}function O4(n,e,t){let r=new Float64Array(n),i=e.length,a=(i+1)*i;for(let o=0;o<i;++o)r[a+o]*=e[o]/t[o];return r}function $k(n,e,t,r,i,a){if(!Nk(n,e+1,r,i+1,e,e))return!1;for(let o=0;o<e;++o){let l=n[(e+1)*e+o],c=r[(i+1)*i+o];if(l*(t[o]/a[o])!==c)return!1}for(let o=e;o<i;++o)if(r[(i+1)*i+o]!==0)return!1;for(let o=e;o<i;++o){for(let l=0;l<e;++l)if(r[(i+1)*l+o]!==0)return!1;for(let l=0;l<i;++l){let c=r[(i+1)*o+l];if(o===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function N4(n,e){if(!e.includes(n))return n;let[,t,r]=n.match(/^([^']*)('?)$/);for(let i=0;;++i){let a=`${t}${i}${r}`;if(!e.includes(a))return a}}function B4(n,e){let{inputSpace:t,transform:r}=n,{ids:i,rank:a}=t,{rank:o,names:l,units:c,scales:d}=e,p=new Array(a);p.fill(!0);let m=[],y=e.ids.map((J,re)=>{let pe=i.indexOf(J);return pe!==-1?p[pe]=!1:m.push(re),pe}),{outputSpace:v}=n,{names:b,units:x,scales:C,ids:L,timestamps:A,coordinateArrays:D}=v,R=p,P=[],E=[],V=new Float64Array(o),O=[],B=[],W=new Array(o),_=0,F=new Float64Array((o+1)**2);F[F.length-1]=1;for(let J=0;J<a;++J)if(!R[J]){P[_]=b[J],O[_]=L[J],E[_]=x[J],V[_]=C[J],B[_]=A[J],W[_]=D[J];for(let re=0;re<o;++re){let pe=y[re];pe!==-1&&(F[re*(o+1)+_]=r[pe*(a+1)+J])}F[o*(o+1)+_]=r[a*(a+1)+J],++_}for(let J of m)O[_]=As(),P[_]=N4(l[J],P),V[_]=d[J],E[_]=c[J],F[J*(o+1)+_]=1,++_;let N=Ve({valid:e.valid,rank:o,names:P,ids:O,timestamps:B,units:E,scales:V,boundingBoxes:Gk(e,F,V),coordinateArrays:W});return{rank:o,sourceRank:n.sourceRank,inputSpace:e,outputSpace:N,transform:F}}function jk(n){let e=Iv(n.inputSpace,n.transform,n.outputSpace);return e===n.outputSpace?n:{rank:n.rank,sourceRank:n.sourceRank,inputSpace:n.inputSpace,transform:n.transform,outputSpace:e}}var qf=class{constructor(e,t=!1){this.mutableSourceRank=t;this.value_=void 0;this.changed=new ae;this.inputSpaceChanged=new ae;this.defaultTransform=jk(e);let r=this;this.outputSpace={changed:r.changed,get value(){return r.value.outputSpace},set value(i){let{value:a}=r;if(Jf(a.outputSpace,i)||a.rank!==i.rank)return;let o=O4(a.transform,a.outputSpace.scales,i.scales);r.value_={sourceRank:a.sourceRank,rank:a.rank,inputSpace:a.inputSpace,outputSpace:Iv(a.inputSpace,o,i),transform:o},r.changed.dispatch()}},this.inputSpace={changed:r.inputSpaceChanged,get value(){return r.value.inputSpace},set value(i){let{value:a}=r;Jf(a.inputSpace,i)||(r.value_=B4(a,i),r.inputSpaceChanged.dispatch(),r.changed.dispatch())}}}set value(e){let t=this.value;e!==t&&(this.value_=jk(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){let{value:e}=this,{rank:t,transform:r,inputSpace:i,outputSpace:a,sourceRank:o}=e,{defaultTransform:l,mutableSourceRank:c}=this,{inputSpace:d,rank:p,transform:m,outputSpace:y}=l,{units:v,scales:b}=i,x=o===t&&Ce(b,c?a.scales:d.scales)&&Ce(v,c?a.units:d.units),C=$k(m,p,y.scales,r,t,a.scales),L=Ce(y.names,a.names);if(!(C&&L&&x))return{sourceRank:o,transform:C?void 0:r,outputSpace:e.outputSpace,inputSpace:x?void 0:i}}set transform(e){let{value:t}=this,{inputSpace:r}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:r,transform:e,outputSpace:Iv(r,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){let _=e.inputSpace||e.outputSpace,F=_.rank,N=Ve({rank:F,names:_.names.map((J,re)=>`${re}`),units:_.units,scales:_.scales,coordinateArrays:_.coordinateArrays});this.value={rank:F,transform:e.transform||Hn(Float64Array,F+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:N};return}let{inputSpace:t,sourceRank:r,outputSpace:i,transform:a,rank:o}=this.defaultTransform,{inputSpace:l,sourceRank:c,outputSpace:d,transform:p}=e,m=e.outputSpace.rank,y=t.names,v=l!==void 0?l.names:y,b=new Array(r);for(let _=0;_<r;++_){let F=v.indexOf(y[_]);F>=c&&(F=-1),b[_]=F}let x=m-c+r;for(let _=c;_<m;++_)b[r+_-c]=_;let C=new Float64Array(x),L=new Array(x),A=[];for(let _=0;_<r;++_){let F=b[_];F===-1||l===void 0?(C[_]=t.scales[_],A[_]=t.units[_],L[_]=t.coordinateArrays[_]):(C[_]=l.scales[F],A[_]=l.units[F],L[_]=Fk([t.coordinateArrays[_],l.coordinateArrays[F]]))}let D=l||d,R=y.slice(0,r),P=i.names.slice(0,r),E=i.coordinateArrays.slice(0,r),V=new Float64Array(x),O=[];for(let _=0;_<x;++_){let F=b[_];F===-1?(V[_]=i.scales[_],O[_]=i.units[_],E[_]=i.coordinateArrays[_]):(P[_]=d.names[F],O[_]=d.units[F],V[_]=d.scales[F],E[_]=d.coordinateArrays[F])}if(!rc(P)){this.reset();return}for(let _=r;_<x;++_){let F=_-r+c;C[_]=D.scales[F],A[_]=D.units[F],R[_]=`${_}`}let B=new Float64Array((x+1)**2);B[B.length-1]=1;for(let _=0;_<x;++_){let F=b[_],N;F===-1||p===void 0?_>=r?N=0:N=a[o*(o+1)+_]*(i.scales[_]/V[_]):N=p[m*(m+1)+F],B[x*(x+1)+_]=N;for(let J=0;J<x;++J){let re=b[J],pe;F===-1!=(re===-1)?pe=0:F===-1||p===void 0?F>=r||re>=r?pe=F===re?1:0:pe=a[J*(o+1)+_]:pe=p[re*(m+1)+F],B[J*(x+1)+_]=pe}}let W=t.boundingBoxes.map(_=>Pv(_,o,x));for(let _=r;_<x;++_)W.push(Dv(x,_));for(let _=0;_<x;++_){if(B[x*(x+1)+_]!==0)continue;let N;for(let re=0;re<x;++re){let pe=B[re*(x+1)+_];if(pe!==0)if(pe===1)if(N===void 0)N=re;else{N=null;break}else{N=null;break}}if(N==null)continue;let J=L[N];J!==void 0&&(J.explicit&&(J={...J,explicit:!1}),E[_]=Fk([J,E[_]]))}this.value={rank:x,transform:B,sourceRank:r,outputSpace:Ve({rank:x,names:P,scales:V,units:O,coordinateArrays:E}),inputSpace:Ve({rank:x,names:R,scales:C,units:A,coordinateArrays:L,boundingBoxes:W})}}toJSON(){return _v(this.spec)}restoreState(e){this.spec=Rv(e)}};function F4(n,e=!1){let t=ne(n);if(!Av(t,e))throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return t}function ed(n,e=!1){let t=be(n,r=>F4(r,e));if(!rc(t,e))throw new Error(`Invalid dimensions: ${JSON.stringify(t)}`);return t}var ic=class{constructor(e,t){this.combined=e;this.bindings=new Set;this.retainCount=0;this.prevCombined=this.combined.value;this.dimensionRefCounts=new Map;this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()};this.includeDimensionPredicate_=t}getRenameValidity(e){let t=this.combined.value.names,r=Zu(e),i=e.length;for(let a=0;a<i;++a){if(!r[a])continue;let o=e[a];if(t.includes(o))continue;let l=!0;for(let c of this.bindings)if(c.space.value.names.includes(o)){l=!1;break}r[a]=l}return r}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){let{combined:e,bindings:t}=this,r=this.retainCount>0?1:0;if(t.size===0&&!r){e.value=Hr;return}let i=this.includeDimensionPredicate_,a=e.value,o=Array.from(a.names),l=Array.from(a.units),c=Array.from(a.scales),d=Array.from(a.ids),p=Array.from(a.timestamps),m=a.names.map(()=>r?1:0),y=[],v=!1;for(let P of t){let{space:{value:E},prevValue:V,mappedDimensionIds:O}=P;v=v||E.valid;let{names:B,units:W,scales:_,ids:F,timestamps:N}=E,J=[],re=[];y.push(re),P.mappedDimensionIds=J,P.prevValue=E;let pe=B.length;for(let ye=0;ye<pe;++ye){let ce=B[ye];if(!i(ce))continue;if(V!==void 0){let Ge=F[ye],ze=V.ids.indexOf(Ge);if(ze!==-1){let tt=O[ze];if(tt!==void 0){let ge=d.indexOf(tt);if(ge!==-1){J[ye]=tt,++m[ge],re[ye]=ge;let Te=N[ye];Te!==void 0&&!(Te<=p[ge])&&(o[ge]=ce,c[ge]=_[ye],l[ge]=W[ye],p[ge]=Te);continue}}}}let fe=o.indexOf(ce);if(fe!==-1){J[ye]=d[fe],++m[fe],re[ye]=fe;continue}fe=o.length,re[ye]=fe,m[fe]=1+r,o[fe]=ce,l[fe]=W[ye],c[fe]=_[ye],p[fe]=N[ye];let Le=As();d[fe]=Le,J[ye]=Le}}let{dimensionRefCounts:b}=this;b.clear();let x=0,C=o.length;for(let P of t){let{space:{value:E}}=P,V=y[x++],{rank:O}=E,B=Array.from(E.names),W=Array.from(E.timestamps),_=Float64Array.from(E.scales),F=Array.from(E.units);for(let N=0;N<O;++N){let J=V[N];J!==void 0&&(F[N]=l[J],_[N]=c[J],W[N]=p[J],B[N]=o[J])}for(let N of B){let J=b.get(N);J===void 0?J=1:++J,b.set(N,J)}if(!Ce(F,E.units)||!Ce(_,E.scales)||!Ce(B,E.names)||!Ce(W,E.timestamps)){let N=Ve({valid:E.valid,ids:E.ids,scales:_,units:F,names:B,timestamps:W,boundingBoxes:E.boundingBoxes,coordinateArrays:E.coordinateArrays});P.prevValue=N,P.space.value=N}}{for(let E=0;E<C;++E)i(o[E])||(m[E]=0);let P=(E,V)=>m[V]!==0;o=o.filter(P),l=l.filter(P),c=c.filter(P),d=d.filter(P),p=p.filter(P),m=m.filter(P),C=o.length}let L=[],A=new Array(C);for(let P=0,E=a.rank;P<E;++P){let V=a.coordinateArrays[P];if(!(V==null?void 0:V.explicit))continue;let O=d.indexOf(a.ids[P]);O!==-1&&(A[O]=[V])}for(let P of t){let{space:{value:E}}=P,{rank:V,boundingBoxes:O,coordinateArrays:B}=E,W=E.names.map(_=>o.indexOf(_));for(let _ of O)L.push(_4(_,C,W));for(let _=0;_<V;++_){let F=B[_];if(F===void 0)continue;let N=W[_],J=A[N];J===void 0?A[N]=[F]:J.push(F)}}let D=new Array(C);for(let P=0;P<C;++P){let E=A[P];E!==void 0&&(D[P]=Bk(E))}let R=Ve({valid:v,ids:d,names:o,units:l,scales:new Float64Array(c),boundingBoxes:L,coordinateArrays:D});if(r)for(let P=0;P<C;++P)--m[P];Jf(a,R)||(this.prevCombined=R,e.value=R)}retain(){return++this.retainCount,()=>{--this.retainCount==0&&this.update()}}bind(e){let t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:r}=this;r.size===0&&this.combined.changed.add(this.handleCombinedChanged),r.add(t);let i=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),a=()=>{i();let{bindings:o}=this;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),a}};function Yf(n,e,t,r,i){let a=i.length,o=new n((a+1)**2);o[o.length-1]=1;for(let l=0;l<a;++l){let c=r[l];o[(a+1)*a+l]=e[(t+1)*t+c];for(let d=0;d<a;++d){let p=i[d];o[(a+1)*d+l]=e[(t+1)*p+c]}}return o}function Jk(n){if(n===void 0)return;let e=new Float64Array(16);if(Array.isArray(n))if(n.length===16)for(let t=0;t<4;++t)for(let r=0;r<4;++r)e[t*4+r]=Ze(n[r*4+t]);else{Wr(n,4);for(let t=0;t<4;++t){let r=Wr(n[t],4);for(let i=0;i<4;++i)e[i*4+t]=Ze(r[i])}}else{Z(n);let t=Je.create(),r=K.create(),i=K.fromValues(1,1,1);de(n,"rotation",o=>{Kl(t,o),Je.normalize(t,t)}),de(n,"translation",o=>{Kl(r,o)}),de(n,"scale",o=>{Kl(i,o)});let a=ie.create();ie.fromRotationTranslationScale(a,t,r,i),e.set(a)}return{sourceRank:3,transform:e,outputSpace:Ve({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function Rv(n){if(n===void 0)return;let e=Z(n),t=j(e,"outputDimensions",Qu),r=t.rank,i=j(e,"sourceRank",l=>{if(l===void 0)return r;if(!Number.isInteger(l)||l<0||l>r)throw new Error(`Expected integer in range [0, ${r}] but received: ${JSON.stringify(l)}`);return l}),a=de(e,"inputDimensions",l=>{let c=Qu(l,!0);if(c.rank!==r)throw new Error(`Expected rank of ${r}, but received rank of: ${c.rank}`);return c});return{transform:de(e,"matrix",l=>{let c=new Float64Array((r+1)**2),d=Wr(l,r);c[c.length-1]=1;for(let p=0;p<r;++p)try{let m=Wr(d[p],r+1);for(let y=0;y<=r;++y)c[(r+1)*y+p]=Ze(m[y])}catch(m){throw new Error(`Error in row ${p}: ${m.message}`)}return c}),outputSpace:t,inputSpace:a,sourceRank:i}}function _v(n){if(n===void 0)return;let{transform:e,outputSpace:t,inputSpace:r,sourceRank:i}=n,a,o=t.rank;if(e!==void 0){a=[];for(let l=0;l<o;++l){let c=[];a[l]=c;for(let d=0;d<=o;++d)c[d]=e[(o+1)*d+l]}}return{sourceRank:i===o?void 0:i,matrix:a,outputDimensions:Lv(t),inputDimensions:r===void 0?void 0:Lv(r)}}function U4(n,e,t){let{box:r,transform:i}=n,a=n.box.lowerBounds.length,o=e.length,l=new Float64Array((a+1)*o);for(let c=0;c<o;++c)for(let d=0;d<=a;++d){let p=e[c];l[c+d*o]=i[p+d*t]}if(!l.every(c=>c===0))return{transform:l,box:r}}function Kf(n,e){let{ids:t,names:r,scales:i,units:a,timestamps:o,coordinateArrays:l}=n;return Ve({rank:e.length,valid:n.valid,ids:e.map(c=>t[c]),names:e.map(c=>r[c]),timestamps:e.map(c=>o[c]),scales:Float64Array.from(e,c=>i[c]),units:e.map(c=>a[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:n.boundingBoxes.map(c=>U4(c,e,n.rank)).filter(c=>c!==void 0)})}function Xf(n,e,t){return e===t?n:Kf(n,OT(n.rank,t,e))}function Vv(n,e){let{transform:t,rank:r}=n,i=ks(t,r,[e]);if(i.length!==1)return;let[a]=i,o=Math.abs(t[(r+1)*a+e]),{inputSpace:l}=n;return{scale:l.scales[a]*o,unit:l.units[a]}}function Ov(n,e){let{scales:t,units:r}=n.defaultInputSpace;return e<t.length?{scale:t[e],unit:r[e]}:void 0}var pq={channelCoordinateSpace:ki,shape:new Uint32Array(0),numChannels:1,coordinates:new Uint32Array(0)};function qk(n){let{rank:e}=n,{bounds:{lowerBounds:t,upperBounds:r}}=n;if(t.some(l=>l!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some(l=>!Number.isInteger(l)||l<=0||l>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");let i=new Uint32Array(r),a=ec(i),o=new Uint32Array(a*e);for(let l=0;l<a;++l){let c=l;for(let d=0;d<e;++d){let p=c%i[d];c=(c-p)/i[d],o[l*e+d]=p}}return{channelCoordinateSpace:n,shape:i,numChannels:a,coordinates:o}}function Nv(n,e,t,r,i,a){let{scales:o}=t,{scales:l,rank:c}=i,d=e+1;for(let p=0;p<c;++p){let m=a[p];if(m===-1)continue;let y=l[p];for(let v=0;v<e;++v){let b=r[v],x=o[b];n[d*v+m]*=x/y}}}function W4(n,e,t,r,i=ki){let{inputSpace:a,rank:o,sourceRank:l,outputSpace:c,transform:d}=t,{names:p}=a,{names:m}=c,y;if(r!==void 0)y=Array.from(r.modelSubspaceDimensionIndices);else{y=[];for(let W=0;W<l;++W)y[W]=W}let v=y.length;for(let W=l;W<o;++W)y.push(W);let b=ks(t.transform,o,y,!0),x=y.length,C=y.map(W=>p[W]||`${W}`),L=b.map(W=>m[W]);if(x!==b.length)return{error:"Rank mismatch between model subspace dimensions ("+C.join(", ")+") and corresponding layer/global dimensions ("+L.join(", ")+")"};let A=Yf(Float32Array,d,o,b,y),D=b.map(W=>m[W]),R=e.names.map(W=>D.indexOf(W)),P=n.names.map(W=>D.indexOf(W));Nv(A,x,a,y,n,P),Nv(A,x,a,y,e,R);let E=i.names.map(W=>D.indexOf(W));Nv(A,x,a,y,i,E);let V=[],O=i.rank;if(r!==void 0){let{subsourceToModelSubspaceTransform:W}=r;v!==x&&(W=Ku(new Float32Array((x+1)**2),x,W,v)),A=Is(new Float32Array((x+1)**2),x+1,A,x+1,W,x+1,x+1,x+1,x+1)}let B=new Uint32Array(O);for(let W=0;W<O;++W){let _=i.bounds.lowerBounds[W],F=i.bounds.upperBounds[W];if(_!==0||!Number.isInteger(F)||F<=0||F>=2**32)return{error:`Channel dimension ${i.names[W]} must have lower bound of 0 and positive integer upper bound`};B[W]=F;let N=E[W],J=-1;if(N!==-1)for(let re=0;re<x;++re){let pe=A[N+re*(x+1)];if(pe!==0){if(pe!==1||J!==-1)return{error:`Channel dimension ${L[N]} must map to a single source dimension`};J=re}}V[W]=J}return{rank:x,unpaddedRank:v,modelDimensionNames:C,layerDimensionNames:L,localToRenderLayerDimensions:R,globalToRenderLayerDimensions:P,channelToRenderLayerDimensions:E,modelToRenderLayerTransform:A,channelToModelDimensions:V,channelSpaceShape:B}}function G4(n,e){return n===e?!0:n.error!==void 0||e.error!==void 0?!1:Ce(n.modelDimensionNames,e.modelDimensionNames)&&Ce(n.layerDimensionNames,e.layerDimensionNames)&&Ce(n.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&Ce(n.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&Ce(n.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&Ce(n.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&Ce(n.channelSpaceShape,e.channelSpaceShape)}function Qf(n,e,t,r,i){return qt((a,o,l,c)=>W4(a,o,l,r,c),[n,e,t,i===void 0?Br(void 0):i],G4)}function Yk(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=0,l=r[a];if(l!==-1){let c=i[l];c!==-1&&(o=e[c])}n[a]=o}}function Kk(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=r[a];if(o!==-1){let l=i[o];l!==-1&&(n[l]=e[a])}}}function Zf(n,e){let t=n.rank,r=n.unpaddedRank,i;r!==t&&e!==void 0&&(e=Ku(new Float32Array((t+1)**2),t,e,r)),e!==void 0?(i=new Float32Array((t+1)*(t+1)),Is(i,t+1,n.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):i=n.modelToRenderLayerTransform;let a=new Float32Array((t+1)*(t+1)),o=tc(a,t+1,i,t+1,t+1);if(o===0)throw new Error("Transform is singular");let{globalToRenderLayerDimensions:l,localToRenderLayerDimensions:c,channelToRenderLayerDimensions:d}=n,p=l.length,m=c.length,y=p+m,v=new Float32Array((y+1)*t);for(let P=0;P<t;++P){for(let E=0;E<p;++E){let V=l[E];V!==-1&&(v[P+E*t]=a[P+V*(t+1)])}for(let E=0;E<m;++E){let V=c[E];V!==-1&&(v[P+(p+E)*t]=a[P+V*(t+1)])}v[P+y*t]=a[P+t*(t+1)]}let b=d.length,x=new Array(b),C=[];for(let P=0;P<b;++P){let E=d[P],V=-1;if(E!==-1){for(let O=0;O<t;++O){let B=i[E+O*(t+1)];if(B!==0){if(B!==1||V!==-1)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must map with stride 1 to a single data chunk dimensions`);V=O}}if(V!==-1){if(i[E+t*(t+1)]!==0)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must have an offset of 0 in the chunk coordinate space`);C.push(V)}}x[P]=V}let{channelSpaceShape:L}=n,A=ec(L),D=C.length,R=new Uint32Array(A*D);for(let P=0;P<A;++P){let E=P,V=0;for(let O=0;O<b;++O){let B=E%L[O];E=(E-B)/L[O],x[O]!==-1&&(R[P*D+V]=B,++V)}}return{layerRank:t,modelTransform:n,chunkToLayerTransform:i,layerToChunkTransform:a,chunkToLayerTransformDet:o,combinedGlobalLocalRank:y,combinedGlobalLocalToChunkTransform:v,channelToChunkDimensionIndices:x,chunkChannelDimensionIndices:C,numChannels:A,chunkChannelCoordinates:R,channelSpaceShape:L}}function eh(n,e){let{globalToRenderLayerDimensions:t}=n,r=[],i=[];for(let a=0;a<3;++a){let o=e[a];if(o==-1)continue;let l=t[o];i.push(l),l!==-1&&r.push(l)}for(let a=i.length;a<3;++a)i[a]=-1;return{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:i}}function th(n,e){let{chunkToLayerTransform:t,modelTransform:r}=n,i=r.rank,{layerDisplayDimensionIndices:a,displayToLayerDimensionIndices:o}=e,l=a.length,c=ks(t,i,a);if(c.length!==l){let{modelDimensionNames:m,layerDimensionNames:y}=r;throw new Error(`Rank mismatch between displayed layer dimensions (${Array.from(a,v=>y[v]).join(",\xA0")}) and corresponding chunk dimensions (${Array.from(c,v=>m[v]).join(",\xA0")})`)}let d=ie.create();for(let m=0;m<3;++m){let y=o[m];if(y!==-1){for(let v=0;v<l;++v){let b=c[v];d[v*4+m]=t[b*(i+1)+y]}d[12+m]=t[i*(i+1)+y]}}let p=ie.create();ie.invert(p,d);for(let m=c.length;m<3;++m)c[m]=-1;return{modelTransform:n.modelTransform,chunkTransform:n,displaySubspaceModelMatrix:d,displaySubspaceInvModelMatrix:p,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function Ha(n,e,t,r,i){let a=e.length,o=t.length,l=n.length,c=!0;for(let d=0;d<r;++d){let p=d,m=0;for(let y=0;y<a;++y)m+=i[p+y*r]*e[y];p+=a*r;for(let y=0;y<o;++y)m+=i[p+y*r]*t[y];m+=i[p+o*r],d<l?n[d]=m:(m<0||m>=1)&&(c=!1)}return c}function Xk(n,e,t){n.fill(0),n[15]=1;let r=!0,{displayDimensionIndices:i}=e,{globalToRenderLayerDimensions:a,modelToRenderLayerTransform:o}=t,l=t.rank;for(let c=0;c<3;++c){let d=i[c];if(d===-1){r=!1;continue}let p=a[d];if(p===-1){r=!1;continue}n[c+12]=o[p+l*(l+1)];for(let m=0;m<3;++m)n[c+4*m]=o[p+(l+1)*m]}if(!r){let{globalDimensionNames:c}=e,d=Array.from(i.filter(p=>p!==-1),p=>c[p]).join(",\xA0");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(",\xA0")}) to display dimensions (${d}) does not have full rank`)}}var Rs=class{constructor(e,t,r){this.size=K.clone(e),this.transform=ie.clone(t),this.finiteRank=r;let i=ie.create(),a=tc(i,4,t,4,4);if(a===0)throw new Error("Transform is singular");this.invTransform=i,this.detTransform=a}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new Rs(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return K.transformMat4(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return ak(e,t,this.transform)}globalToLocalNormal(e,t){return wf(e,t,this.transform)}};var Qk=class{constructor(){this.name="CancellationError";this.message="CANCELED"}toString(){return"CANCELED"}},Er=new Qk;function Zk(n){if(n.isCanceled===!0)throw Er}var Bv=()=>{},et={isCanceled:!1,add:()=>Bv,remove:Bv},dr=class{cancel(){let{handlers:e}=this;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let{handlers:t}=this;return t===null?(e(),Bv):(t===void 0&&(t=this.handlers=new Set),t.add(e),()=>{this.remove(e)})}remove(e){let{handlers:t}=this;t!=null&&t.delete(e)}},Fv=class extends dr{constructor(){super(...arguments);this.consumers=new Set}addConsumer(e=et){let{consumers:t}=this;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}};function eE(n,e){return new Promise((t,r)=>{if(n===et){e(t,r,et);return}let i=new dr,a=n.add(()=>{i.cancel()});e(o=>{a(),t(o)},o=>{a(),r(o)},i)})}var nh=!(typeof Window!="undefined"&&self instanceof Window),tE=!1,nE=!1,Uv="rpc.promise.response",rE="rpc.promise.cancel",iE=new Map;function Tt(n,e){iE.set(n,e)}var aE=class extends Error{constructor(e,t){super(t);this.name=e;this.message=t}};function rh(n,e){Tt(n,function(t){let r=t.id,i=new dr,a=e.call(this,t,i);this.set(r,{promise:a,cancellationToken:i}),a.then(({value:o,transfers:l})=>{this.delete(r),this.invoke(Uv,{id:r,value:o},l)},o=>{this.delete(r),this.invoke(Uv,{id:r,error:o.message,errorName:o.name})})})}Tt(rE,function(n){let e=n.id,t=this.get(e);if(t!==void 0){let{cancellationToken:r}=t;r.cancel()}});Tt(Uv,function(n){let e=n.id,{resolve:t,reject:r}=this.get(e);this.delete(e),n.hasOwnProperty("value")?t(n.value):n.errorName===Er.name?r(Er):r(new aE(n.errorName,n.error))});var z4=nh?-1:0,Wv=class{constructor(e){this.target=e;this.objects=new Map;this.nextId=z4;e.onmessage=t=>{let r=t.data;nE&&console.log("Received message",r),iE.get(r.functionName).call(this,r)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(e===void 0)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e,nE&&console.trace("Sending message",t),this.target.postMessage(t,r)}promiseInvoke(e,t,r=et,i){return eE(r,(a,o,l)=>{let c=t.id=this.newId();this.set(c,{resolve:a,reject:o}),this.invoke(e,t,i),l.add(()=>{this.invoke(rE,{id:c})})})}newId(){return nh?this.nextId--:this.nextId++}},hn=class extends ${constructor(){super(...arguments);this.rpc=null;this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){tE&&console.log(`[${nh}] #rpc object = ${this.rpc.numObjects}`);let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}};function H4(n,e,t={}){e!=null&&n.initializeSharedObject(e,t.id)}var $a=class extends hn{constructor(e,t={}){super();H4(this,e,t)}};Tt("SharedObject.dispose",function(n){let e=this.get(n.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");tE&&console.log(`[${nh}] #rpc objects: ${this.numObjects}`),e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});var $4="Worker";Tt($4,function(n){let{port:e,path:t}=n;new Worker(t).postMessage({port:e},[e])});Tt("SharedObject.refCountReachedZero",function(n){let e=this.get(n.id),t=n.gen;e.counterpartRefCountReachedZero(t)});var oE=new Map;function mn(n){return e=>{e.prototype.RPC_TYPE_ID=n}}function Io(n){return e=>{if(n!==void 0)e.prototype.RPC_TYPE_ID=n;else if(n=e.prototype.RPC_TYPE_ID,n===void 0)throw new Error("RPC_TYPE_ID should have already been defined");oE.set(n,e)}}Tt("SharedObject.new",function(n){let e=this,t=n.type,r=oE.get(t),i=new r(e,n);--i.refCount});var ih=!1,j4=!1,J4=ie.create();function q4(n,e){let t=0,r=Math.abs(n.detTransform),{transform:i,size:a}=n;for(let o=0;o<3;++o){let l=0;for(let d=0;d<3;++d)l+=e[d*4+2]*i[4*o+d];let c=a[o];t+=Math.abs(l)*c,r*=c}return r/t}function sE(n,e,t){let{curPositionInChunks:r,fixedPositionWithinChunk:i}=n,{nonDisplayLowerClipBound:a,nonDisplayUpperClipBound:o}=n,{rank:l,chunkDataSize:c}=n.source.spec;if(!Ha(r,e,t,n.layerRank,n.fixedLayerToChunkTransform))return!1;for(let d=0;d<l;++d){let p=r[d];if(p<a[d]||p>=o[d])return ih&&console.log("excluding source",n,`because of chunkDim=${d}, sum=${p}`,a,o,n.fixedLayerToChunkTransform),!1;let m=c[d],y=r[d]=Math.floor(p/m);i[d]=p-y*m}return!0}function Y4(n,e){let t=e.length,r=0;if(ih&&console.log(e),t>1){let i=0;for(let a=0;a<t;++a){let o=e[a],{chunkLayout:l}=o,c=q4(l,n);ih&&console.log(`chunksize = ${l.size}, sliceArea = ${c}`),c>i&&(i=c,r=a)}}return r}var ac=new Rs(K.create(),ie.create(),0),Gv=class extends Yu{constructor(){super(...arguments);this.viewportNormalInGlobalCoordinates=K.create();this.viewportNormalInCanonicalCoordinates=K.create();this.centerDataPosition=K.create();this.pixelSize=0}};function K4(n,e){if(n.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||n.pixelSize!==e.pixelSize)return!0;let{viewMatrix:t}=n,{viewMatrix:r}=e;for(let i=0;i<12;++i)if(t[i]!==r[i])return!0;return!1}var zv=class extends hn{constructor(e){super();this.projectionParameters=e;this.visibleLayers=new Map;this.visibleSourcesStale=!0;this.registerDisposer(e.changed.add((t,r)=>{K4(t,r)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[r,{allSources:i,visibleSources:a,displayDimensionRenderInfo:o}]of t){if(a.length=0,o!==e||i.length===0)continue;let l=Y4(this.projectionParameters.value.viewMatrix,i.map(d=>d[0])),c=i[l];for(let d of r.filterVisibleSources(this,c))a.push(d);a.reverse(),ih&&console.log("visible sources chosen",a)}}},X4=18;function td(n){let{rank:e,upperVoxelBound:t,maxVoxelsPerChunkLog2:r=X4,chunkToViewTransform:i,displayRank:a,minBlockSize:o,maxBlockSize:l}=n,{lowerVoxelBound:c=new Uint32Array(e)}=n,d=new Float32Array(e);for(let v=0;v<e;++v){let b=0;for(let x=0;x<a;++x){let C=i[v*a+x];b+=C*C}d[v]=Math.sqrt(b)}let p=new Uint32Array(e);o!==void 0?p.set(o):p.fill(1);let m=new Array(e);for(let v=0;v<e;++v){let b=Number.POSITIVE_INFINITY;d[v]===0?b=p[v]:(t!==void 0&&(b=Math.pow(2,Math.floor(Math.log2(t[v]-c[v])))),l!==void 0&&(b=Math.min(b,l[v]))),m[v]=b}function y(){let v=Infinity,b=-1;for(let x=0;x<e;++x){if(p[x]>=m[x])continue;let C=p[x]*d[x];C<v&&(v=C,b=x)}return b}r-=Math.log2(ec(p));for(let v=0;v<r;++v){let b=y();if(b===-1)break;p[b]*=2}return p}function Q4(n){let e=[],{displayRank:t,chunkToViewTransform:r,rank:i}=n;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[td(n)];for(let a=0;a<3;++a){let o=(a+2)%3,l=new Float32Array(r);for(let c=0;c<i;++c)l[c*t+o]=0;e[a]=td({...n,chunkToViewTransform:l})}return e}var _s;(function(t){t[t.ISOTROPIC=0]="ISOTROPIC",t[t.FLAT=1]="FLAT"})(_s||(_s={}));function lE(n){if(n.chunkDataSizes!==void 0)return n.chunkDataSizes;let{chunkLayoutPreference:e=0}=n;switch(e){case 0:return[td(n)];case 1:return Q4(n)}}function oc(n){let{rank:e,chunkDataSize:t,upperVoxelBound:r}=n,{lowerVoxelBound:i=new Float32Array(e)}=n,a=new Float32Array(e),o=new Float32Array(e);for(let l=0;l<e;++l)a[l]=Math.floor(i[l]/t[l]),o[l]=Math.floor((r[l]-1)/t[l]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:a,upperChunkBound:o,lowerVoxelBound:i,upperVoxelBound:r}}function*cE(n,e,t){let r=n.projectionParameters.value.pixelSize*1.1,i=t[0].effectiveVoxelSize,a=e.renderScaleTarget.value,o=p=>{let m=r*a;for(let y=0;y<3;++y){let v=p[y];if(v>m&&v>1.01*i[y])return!0}return!1},l=(p,m)=>{let y=r*a;for(let v=0;v<3;++v){let b=p[v],x=m[v];if(Math.abs(y-b)<Math.abs(y-x)&&b<1.01*x)return!0}return!1},c=t.length-1,d;for(;;){let p=t[c];if(d!==void 0&&!l(p.effectiveVoxelSize,d)||(yield p,c===0||!o(p.effectiveVoxelSize)))break;d=p.effectiveVoxelSize,--c}}var uE="SliceView",dE="sliceview/RenderLayer",pE="SliceView.addVisibleLayer",fE="SliceView.removeVisibleLayer",Hv=new Float32Array(3),$v=new Float32Array(3),hE=ie.create(),mE=new Float32Array(24);function gE(n,e,t,r){let i=Hv,a=$v,{lowerChunkDisplayBound:o,upperChunkDisplayBound:l}=e;for(let m=0;m<3;++m)i[m]=Math.max(i[m],o[m]),a[m]=Math.min(a[m],l[m]);let{curPositionInChunks:c,chunkDisplayDimensionIndices:d}=e;function p(){if(!r(i[0],i[1],i[2],a[0],a[1],a[2],n))return;let m=0,y=Math.max(0,a[0]-i[0]),v=y;for(let L=1;L<3;++L){let A=Math.max(0,a[L]-i[L]);v*=A,A>y&&(y=A,m=L)}if(v===0)return;if(v===1){c[d[0]]=i[0],c[d[1]]=i[1],c[d[2]]=i[2],t(i,n);return}let b=i[m],x=a[m],C=Math.floor(.5*(b+x));a[m]=C,p(),a[m]=x,i[m]=C,p(),i[m]=b}p()}function ah(n,e,t,r){if(!sE(t,n.globalPosition,e))return;let{size:i}=t.chunkLayout,a=ie.multiply(hE,n.viewProjectionMat,t.chunkLayout.transform);for(let d=0;d<3;++d){let p=i[d];for(let m=0;m<4;++m)a[4*d+m]*=p}let o=mE;Ls(o,a);let l=Hv,c=$v;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),gE(o,t,r,Tf)}function yE(n,e,t,r,i){if(!sE(t,n.globalPosition,e))return;let{size:a}=r,o=ie.multiply(hE,n.viewProjectionMat,r.transform);for(let y=0;y<3;++y){let v=a[y];for(let b=0;b<4;++b)o[4*y+b]*=v}let l=J4;ie.invert(l,o);let c=Hv,d=$v,p=.001;for(let y=0;y<3;++y){let v=l[12+y]+p/a[y],b=Math.abs(l[y]),x=Math.abs(l[4+y]);c[y]=Math.floor(v-b-x),d[y]=Math.floor(v+b+x+1)}let m=mE;for(let y=0;y<3;++y){let v=o[4*y],b=o[4*y+1],x=o[4*y+2];m[y]=v,m[4+y]=-v,m[8+y]=+b,m[12+y]=-b,m[16+y]=+x,m[20+y]=-x}{let y=3,v=o[4*y],b=o[4*y+1],x=o[4*y+2];m[y]=1+v,m[4+y]=1-v,m[8+y]=1+b,m[12+y]=1-b,m[16+y]=x,m[20+y]=-x}j4&&(console.log("clippingPlanes",m),console.log("modelViewProjection",o.join(",")),console.log(`lower=${c.join(",")}, upper=${d.join(",")}`)),gE(m,t,i,sk)}function sc(n,e){let{finiteRank:t}=e;if(t===3)return e;ac.finiteRank=t,K.copy(ac.size,e.size);let r=ie.copy(ac.transform,e.transform),i=ie.copy(ac.invTransform,e.invTransform);ac.detTransform=e.detTransform;let{invViewMatrix:a,width:o,height:l}=n,c=Lf(n.projectionMat);for(let d=t;d<3;++d){let p=a[12+d],m=p,y=p,v=Math.abs(a[d]*o);m-=v,y+=v;let b=Math.abs(a[d+4]*l);m-=b,y+=b;let x=Math.abs(a[d+8]*c);m-=x,y+=x;let C=Math.max(1,y-m);r[12+d]=m,r[5*d]=C}return ie.invert(i,r),ac}var vE="annotation.MetadataChunkSource",SE="annotation.GeometryChunkSource",bE="annotation.SubsetGeometryChunkSource",xE="annotation.reference.add",CE="annotation.reference.delete",wE="annotation.commit",TE="annotation.commit",LE="annotation/SpatiallyIndexedRenderLayer",kE="annotation/PerspectiveRenderLayer:updateSources",EE="annotation/RenderLayer",DE="annotation/RenderLayer.updateSegmentation",Z4=Ct.create();function PE(n,e,t,r,i,a){let{displayDimensionRenderInfo:o,viewMatrix:l,projectionMat:c,width:d,height:p}=n,{voxelPhysicalScales:m}=o,y=Math.abs(Ct.determinant(Ts(Z4,l))),v=Fu(m),b=lk(c)/y*v;if(r.length===0)return;let x=r[0],C=Math.abs(x.chunkLayout.detTransform)*v,{lowerClipDisplayBound:L,upperClipDisplayBound:A}=x;for(let O=0;O<3;++O)C*=A[O]-L[O];let D=Math.min(C,b),R=d*p,E=R/t**2/D,V=0;for(let O=r.length-1;O>=0&&V<E;--O){let B=r[O],W=B.source.spec,{chunkLayout:_}=B,F=Fu(_.size)*Math.abs(_.detTransform)*v,{limit:N,rank:J}=W,{nonDisplayLowerClipBound:re,nonDisplayUpperClipBound:pe}=B,ye=1;for(let Te=0;Te<J;++Te){let Fe=pe[Te]-re[Te];Number.isFinite(Fe)&&(ye/=Fe)}let ce=N*ye/F,fe=!0,Le=V+ce,Ge=Math.pow(1/Le,1/3),ze=Math.sqrt(R/(Le*D)),tt=(E-V)*F/ye,ge=Math.min(1,tt/W.limit);ah(n,e,B,()=>{fe&&(i(B,O),fe=!1),a(B,O,ge,Ge,ze)}),V=Le}}var Ei=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;var IE=Symbol("objectId"),eW=0;function pt(n){if(n instanceof Object){let e=n[IE];return e===void 0&&(e=n[IE]=eW++),`o${e}`}else return""+JSON.stringify(n)}var jv=!1,Jv;(function(t){t[t.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",t[t.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(Jv||(Jv={}));function tW(n){n=n.replace("\0","");let e=[];for(let t of n.split(`
`)){let r=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);r!==null?e.push({message:r[3].trim(),file:parseInt(r[1],10),line:parseInt(r[2],10)}):(r=t.match(/^ERROR:\s*(.+)$/),r!==null?e.push({message:r[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}var AE=class extends Error{constructor(e,t,r,i){let a=`Error compiling ${Jv[e].toLowerCase()} shader: ${r}`;super(a);this.name="ShaderCompilationError",this.log=r,this.message=a,this.shaderType=e,this.source=t,this.errorMessages=i}},ME=class extends Error{constructor(e,t,r){let i=`Error linking shader: ${r}`;super(i);this.name="ShaderLinkError",this.log=r,this.message=i,this.vertexSource=e,this.fragmentSource=t}};function RE(n,e,t){var r=n.createShader(t);if(n.shaderSource(r,e),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){let i=n.getShaderInfoLog(r)||"";if(jv){let a=e.replace("<","&lt;").replace(">","&gt;").split(`
`),o="<pre>";o+=i.replace("<","&lt;").replace(">","&gt;")+`
`,a.forEach((c,d)=>{o+=`${d+1}: ${c}
`}),o+=`
</pre>`,console.log(o);let l=window.open("about:blank","_blank");if(l!==null)try{l.document.write(o)}catch(c){}}throw new AE(t,e,i,tW(i))}return r}var nd,_E=class extends ${constructor(e,t,r,i,a,o){super();this.gl=e;this.vertexSource=t;this.fragmentSource=r;this.attributes=new Map;this.uniforms=new Map;this.vertexShaderInputBinders={};let l=this.vertexShader=RE(e,t,e.VERTEX_SHADER),c=this.fragmentShader=RE(e,r,e.FRAGMENT_SHADER),d=e.createProgram();if(e.attachShader(d,l),e.attachShader(d,c),jv&&(o==null?void 0:o.length)&&(e.transformFeedbackVaryings(d,o.map(y=>y.name),WebGL2RenderingContext.INTERLEAVED_ATTRIBS),this.vertexDebugOutputs=o),e.linkProgram(d),!e.getProgramParameter(d,e.LINK_STATUS)){let y=e.getProgramInfoLog(d)||"";throw new ME(t,r,y)}this.program=d;let{uniforms:p,attributes:m}=this;if(i)for(let y of i)p.set(y,e.getUniformLocation(d,y));if(a)for(let y of a)m.set(y,e.getAttribLocation(d,y))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){nd=this,this.gl.useProgram(this.program)}disposed(){let{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}};function VE(n,e,t,r,i){if(n.drawArraysInstanced(e,t,r,i),!jv||!(nd==null?void 0:nd.vertexDebugOutputs))return;let{vertexDebugOutputs:a}=nd,o=0;for(let y of a)o+=nW[y.typeName];let l=n.createBuffer(),c=o*r*i;n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l),n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,c,WebGL2RenderingContext.DYNAMIC_DRAW),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,l),n.beginTransformFeedback(WebGL2RenderingContext.POINTS),n.enable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.drawArraysInstanced(WebGL2RenderingContext.POINTS,t,r,i),n.disable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.endTransformFeedback(),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,null),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l);let d=new Uint8Array(c);n.getBufferSubData(WebGL2RenderingContext.ARRAY_BUFFER,0,d,0,c),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.deleteBuffer(l);let p=0,m=new Float32Array(d.buffer);for(let y=0;y<i;++y)for(let v=0;v<r;++v){let b=`i=${y} v=${v}:`;for(let x of a)switch(b+=` ${x.name}=`,x.typeName){case"float":b+=`${m[p++]}`;break;case"vec2":b+=`${m[p++]},${m[p++]}`;break;case"vec3":b+=`${m[p++]},${m[p++]},${m[p++]}`;break;case"vec4":b+=`${m[p++]},${m[p++]},${m[p++]},${m[p++]}`;break}console.log(b)}}var qv=class{constructor(){this.code="";this.parts=new Set}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}},oh={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D},nW={float:4,vec2:8,vec3:12,vec4:16},$r=class{constructor(e){this.gl=e;this.nextSymbolID=0;this.nextTextureUnit=0;this.uniformsCode="";this.attributesCode="";this.varyingsCodeVS="";this.varyingsCodeFS="";this.fragmentExtensionsSet=new Set;this.fragmentExtensions="";this.vertexCode=new qv;this.vertexMain="";this.fragmentCode=new qv;this.outputBufferCode="";this.fragmentMain="";this.required=new Set;this.uniforms=new Array;this.attributes=new Array;this.initializers=[];this.textureUnits=new Map;this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let r=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,r),r}addTextureSampler(e,t,r,i){let a=this.allocateTextureUnit(r,i);return this.addUniform(`highp ${e}`,t,i),this.addInitializer(o=>{if(i){let l=new Int32Array(i);for(let c=0;c<i;++c)l[c]=c+a;o.gl.uniform1iv(o.uniform(t),l)}else o.gl.uniform1i(o.uniform(t),a)}),a}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,r){return this.attributes.push(t),r!==void 0&&(this.attributesCode+=`layout(location = ${r})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,r=""){this.varyingsCodeVS+=`${r} out ${e} ${t};
`,this.varyingsCodeFS+=`${r} in ${e} ${t};
`}addOutputBuffer(e,t,r){r!==null&&(this.outputBufferCode+=`layout(location = ${r}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,r){return this.uniforms.push(t),r!=null?this.uniformsCode+=`uniform ${e} ${t}[${r}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,r=new _E(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);r.textureUnits=this.textureUnits;let{initializers:i}=this;if(i.length>0){r.bind();for(let a of i)a(r)}return r}};function sa(){return new Ae(void 0)}function Ao(n){return new ct(n,ne)}function rd(n,e,t){let r=new Map,{parameters:i,fallbackParameters:a,shaderError:o,encodeParameters:l=C=>C,extraParameters:c=Br(void 0),encodeExtraParameters:d=C=>C,getContextKey:p,defineShader:m}=t;o!==void 0&&(o.value=void 0);let{encodeContext:y=p}=t,v=Dn(t.memoizeKey);function b(C,L,A){let D=JSON.stringify({id:v,context:y(C),parameters:l(L),extraParameters:d(A)});return e.memoize.get(D,()=>{let R=new $r(e);return m(R,C,L,A),R.build()})}function x(C){let L=p(C),A=r.get(L);A===void 0&&(A={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:i.value,extraParameters:c.value},r.set(L,A));let D=i.changed.count,R=c.changed.count;if(D===A.parametersGeneration&&R===A.extraParametersGeneration)return A;let P=A.parameters=i.value,E=A.extraParameters=c.value,V=A.shader;A.parametersGeneration=D,A.extraParametersGeneration=R;let O=null;try{O=b(C,P,E),A.fallback=!1,a!==void 0&&(a.value=P),o!==void 0&&(o.value=null)}catch(B){if(o!==void 0&&(o.value=B),a!==void 0)try{let W=a.value;O=b(C,W,E),A.parameters=W,A.fallback=!0}catch{}}return V!==null&&V.dispose(),A.shader=O,A}return n.registerDisposer(()=>{for(let C of r.values()){let{shader:L}=C;L!==null&&L.dispose()}}),x}function jr(n,e,t){return rd(n,e,{...t,getContextKey:r=>r,encodeContext:r=>pt(r),defineShader:(r,i,a,o)=>(r.require(i),t.defineShader(r,a,o))})}function Di(n,e=1,t=0){return`
#line ${t} ${e}
`+n}var OE=rt(Dt());var mt=class{constructor(e,t=e){this.value_=e;this.defaultValue=t;this.changed=new ae}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}},pr=class extends ${constructor(e,t={}){super();this.model=e;this.element=document.createElement("input");let{element:r}=this;r.type="checkbox";let i=()=>{var o;let a=this.model.value;this.element.checked=a,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(o=a?t.enableTitle:t.disableTitle)!=null?o:"")};this.registerDisposer(e.changed.add(i)),i(),this.registerEventListener(r,"change",function(a){e.value=this.checked}),r.addEventListener("mousedown",a=>{a.preventDefault()})}disposed(){let{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}},$n=class extends ${constructor(e,t){super();this.model=e;this.element=t;this.initialDisplay=this.element.style.display;this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,OE.default)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}};var NE="SharedWatchableValue.changed",Lt=class extends $a{constructor(e,t={}){super(e,t);this.updatingValue_=!1;e!==void 0&&(this.base=new Ae(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;e!==null&&e.invoke(NE,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let r=new Lt;return r.base=t,r.setupChangedHandler(),r.initializeCounterpart(e),r}static make(e,t){return Lt.makeFromExisting(e,new Ae(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}};Lt=xt([Io("SharedWatchableValue")],Lt);Tt(NE,function(n){let e=this.get(n.id);e.updatingValue_=!0,e.base.value=n.value,e.updatingValue_=!1});var kt=class extends Ae{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}};kt.VISIBLE=Number.POSITIVE_INFINITY,kt.IGNORED=Number.NEGATIVE_INFINITY;var ja=class extends kt{constructor(){super(...arguments);this.contributors=new Map}add(e){let{contributors:t}=this,r=e.changed.add(()=>{this.update()}),i=()=>{t.delete(i),r(),this.update()};return t.set(i,e),this.update(),i}update(){let e=Number.NEGATIVE_INFINITY;for(let t of this.contributors.values())e=Math.max(e,t.value);this.value=e}};function la(n){return class extends n{constructor(){super(...arguments);this.visibility=new ja}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(Lt.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var _t=class{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e;this.bufferType=t;this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,r=WebGL2RenderingContext.FLOAT,i=!1,a=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,r,i,a,o)}bindToVertexAttribI(e,t,r=WebGL2RenderingContext.UNSIGNED_INT,i=0,a=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,r,i,a)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let r=this.gl;this.bind(),r.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,r,i){let a=new _t(e,r);return a.setData(t,i),a}};function Ja(n,e,t,...r){return n.memoize.get(Dn({id:"getMemoizedBuffer",getter:pt(t),args:r}),()=>{let i=new Ru(_t.fromData(n,t(...r),e,WebGL2RenderingContext.STATIC_DRAW));return i.registerDisposer(i.value),i})}function rW(n=-1,e=-1,t=1,r=1,i=1,a=1){return Iu(new Float32Array([n,e,n,r,t,r,t,e]),2,i,a)}function Mo(n,e=-1,t=-1,r=1,i=1,a=1,o=1){return Ja(n,WebGL2RenderingContext.ARRAY_BUFFER,rW,e,t,r,i,a,o).value}function qa(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function BE(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function FE(n,e,t,r,i=WebGL2RenderingContext.RGBA8,a=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),qa(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,i,t,r,0,a,o,null),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function UE(n,e,t){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function Yv(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain("v4f_fragColor = getValue0();")}function WE(n,e=Yv,t=1){return n.memoize.get(`elementWiseTextureShader:${t}:${pt(e)}`,()=>{let r=new $r(n);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler",t),r.addInitializer(i=>{let a=[];for(let o=0;o<t;++o)a[o]=o;n.uniform1iv(i.uniform("uSampler"),a)});for(let i=0;i<t;++i)r.addFragmentCode(`
vec4 getValue${i}() {
  return texture(uSampler[${i}], vTexCoord);
}
`);return r.addUniform("mat4","uProjectionMatrix"),r.require(e),r.addAttribute("vec4","aVertexPosition"),r.addAttribute("vec2","aTexCoord"),r.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),r.build()})}function GE(n){return n.memoize.get("trivialColorShader",()=>{let e=new $r(n);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}var Kv=class extends ${constructor(){super(...arguments);this.width=Number.NaN;this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}},zE=class extends Kv{constructor(e,t){super();this.gl=e;this.internalformat=t;this.renderbuffer=null;this.renderbuffer=e.createRenderbuffer()}performResize(){let{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}},HE=class extends zE{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16);this.gl=e;this.includeStencilBuffer=t}attachToFramebuffer(){let{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}},Xv=class extends HE{constructor(e){super(e,!0)}};var $E=class extends ${constructor(e){super();this.gl=e;this.framebuffer=this.gl.createFramebuffer()}disposed(){let{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}},ca=class extends Kv{constructor(e,t,r,i){super();this.gl=e;this.internalFormat=t;this.format=r;this.dataType=i;this.texture=e.createTexture()}performResize(){FE(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}},Qv=class extends ca{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,r=WebGL2RenderingContext.DEPTH_COMPONENT,i=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,r,i)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}};function Vs(n,e,t=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,i=WebGL2RenderingContext.UNSIGNED_BYTE){let a=new Array;for(let o=0;o<e;++o)a[o]=new ca(n,t,r,i);return a}var Pi=class extends ${constructor(e,t){super();this.gl=e;this.width=Number.NaN;this.height=Number.NaN;this.fullAttachmentList=new Array;this.attachmentVerified=!1;this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];let{framebuffer:r=new $E(e),colorBuffers:i,depthBuffer:a}=t;this.framebuffer=this.registerDisposer(r),this.colorBuffers=i,this.depthBuffer=a,a!==void 0&&this.registerDisposer(a);let{fullAttachmentList:o}=this;i.forEach((l,c)=>{this.registerDisposer(l),o[c]=e.COLOR_ATTACHMENT0+c})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let{gl:r,depthBuffer:i}=this;i!==void 0?(i.resize(e,t),i.attachToFramebuffer()):r.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((a,o)=>{a.resize(e,t),a.attachToFramebuffer(r.COLOR_ATTACHMENT0+o)}),r.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),r.viewport(0,0,e,t)}bindSingle(e){let{gl:t}=this;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,r,i,a=1,o=1){let{gl:l}=this;try{this.bindSingle(e),l.readPixels(t,r,a,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,i)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}},ua=class extends ${constructor(e,t){super();this.gl=e;this.shader=t;this.copyVertexPositionsBuffer=Mo(this.gl);this.copyTexCoordsBuffer=Mo(this.gl,0,0,1,1);this.registerDisposer(t)}draw(...e){let{gl:t,shader:r}=this;r.bind();let i=e.length;for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,xf);let a=r.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(a,2);let o=r.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(a),t.disableVertexAttribArray(o);for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=Yv,r=1){return e.memoize.get(`OffscreenCopyHelper:${r}:${pt(t)}`,()=>new ua(e,WE(e,t,r)))}};var jE=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,JE=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,Et=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,qE=[Et,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],sh=[Et,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],id=[Et,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],Zv=[Et,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],iW=[Et,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],YE=[iW,id,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],KE=[Zv,id,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],eS=[Et,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],XE=[Et,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],tS=[Et,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],nS=[Et,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],lh=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,rS=[Et,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],iS=[Et,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],Os=[Et,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],aS=[Et,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],QE=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,ZE=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,e1=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,t1=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,n1=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,ch=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,r1=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,i1=[ch,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],a1=[ch,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function At(n,e=1){switch(n){case z.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case z.UINT8:case z.INT8:case z.UINT16:case z.INT16:case z.UINT32:case z.INT32:case z.UINT64:{let t=kf[n]?"":"u",r=Ef[n]*8;if(e===1)return`${t}int${r}_t`;if(e>1&&e*r<=32)return`${t}int${r}x${e}_t`;break}}throw new Error(`No shader type for ${z[n]}[${e}].`)}var Ns={[z.UINT8]:tS,[z.INT8]:nS,[z.UINT16]:rS,[z.INT16]:iS,[z.UINT32]:Os,[z.INT32]:aS,[z.UINT64]:Et,[z.FLOAT32]:lh};function aW(n,e){return e===1?n:n==="float"?`vec${e}`:`${n[0]}vec${e}`}var oW={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function Ro(n,e,t,r,i,a,o=1){let l=0,c=a*o;for(;c>0;){let m=Math.min(4,c),y=aW(e,m);c-=m,n.addAttribute("highp "+y,`a${i}${l}`),++l}c=a*o;let d="";for(let m=0;m<o;++m){d+=`highp ${e}[${a}] get${i}${m}() {
  highp ${e}[${a}] result;
`;for(let y=0;y<a;++y){let v=m*a+y,b=Math.floor(v/4),x=v%4;d+=`  result[${y}] = a${i}${b}`,(x!==0||v!==c-1)&&(d+=`[${x}]`),d+=`;
`}d+=`  return result;
`,d+=`}
`}n.addVertexCode(d);let p=oW[t];n.addInitializer(m=>{let y=[];for(let v=0;v<l;++v)y[v]=m.attribute(`a${i}${v}`);m.vertexShaderInputBinders[i]={enable(v){let{gl:b}=m;for(let x=0;x<l;++x){let C=y[x];b.enableVertexAttribArray(C),b.vertexAttribDivisor(C,v)}},disable(){let{gl:v}=m;for(let b=0;b<l;++b){let x=y[b];v.vertexAttribDivisor(x,0),v.disableVertexAttribArray(x)}},bind(v,b){let{gl:x}=m;for(let C=0;C<l;++C){let L=y[C],A=Math.min(4,c-4*C);e==="float"?x.vertexAttribPointer(L,A,t,r,v,b):x.vertexAttribIPointer(L,Math.min(4,c-4*C),t,v,b),b+=p*A}}}})}var sW=!1,ad=class extends ${constructor(e,t,r=new ja){super();this.channels=e;this.bounds=t;this.visibility=r;this.framebuffers=[];this.producerVisibility=new ja;this.frameNumber=-1}getFramebuffers(e){let{framebuffers:t}=this;for(;t.length<this.channels.value.length;){let r=new Pi(e,{colorBuffers:Vs(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(r)}return t}disposed(){for(let e of this.framebuffers)e.dispose();this.framebuffers.length=0}},o1=Symbol("histogramDataSamplerTextureUnit"),s1=Symbol("histogramDepthTextureUnit"),oS=4096,lW=2**14,od=class extends ${constructor(e){super();this.gl=e;this.shader=this.registerDisposer((()=>{let e=new $r(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",o1),e.addTextureSampler("sampler2D","uDepthSampler",s1),e.addVertexCode(t1),e.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),e.build()})());this.inputIndexBuffer=this.registerDisposer(Ja(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(oS)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new od(e))}compute(e,t,r,i,a){let{gl:o}=this,{shader:l}=this,c=i.getFramebuffers(o);l.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let d=l.textureUnit(o1),p=l.textureUnit(s1);o.activeTexture(WebGL2RenderingContext.TEXTURE0+p),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),qa(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+d);let m=i.frameNumber;i.frameNumber=a;for(let y=0;y<e;++y)if(o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r[y].texture),qa(o),c[y].bind(256,1),a!==m&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,oS,lW/oS),sW){let v=new Float32Array(256*4);o.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,v);let b=new Float32Array(256);for(let x=0;x<256;++x)b[x]=v[x*4];console.log("histogram",b.join(" "))}o.disable(WebGL2RenderingContext.BLEND)}};var sS={[z.UINT8]:"vec2",[z.INT8]:"vec2",[z.UINT16]:"vec2",[z.INT16]:"vec2",[z.FLOAT32]:"vec2",[z.UINT32]:"Uint32LerpParameters",[z.INT32]:"Int32LerpParameters",[z.UINT64]:"Uint64LerpParameters"},sd={[z.UINT8]:"",[z.INT8]:"",[z.UINT16]:"",[z.INT16]:"",[z.FLOAT32]:"",[z.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[z.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[z.UINT64]:[Et,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]};function ld(n){let t=`
float computeInvlerp(${At(n)} inputValue, vec2 p) {
  float outputValue = float(toRaw(inputValue));
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;return[Ns[n],t]}function l1(n){let e=At(n),t=n===z.INT32?"int":"uint",r=sS[n];return[Ns[n],sd[n],`
float computeInvlerp(${e} inputValue, ${r} p) {
  ${t} v = toRaw(inputValue);
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
`]}var cW={[z.UINT8]:ld(z.UINT8),[z.INT8]:ld(z.INT8),[z.UINT16]:ld(z.UINT16),[z.INT16]:ld(z.INT16),[z.FLOAT32]:ld(z.FLOAT32),[z.UINT32]:l1(z.UINT32),[z.INT32]:l1(z.INT32),[z.UINT64]:[Et,id,Zv,eS,sd[z.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function cd(n){let t=`
${At(n)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return n===z.FLOAT32?t+=`return inputValue;
`:t+=`return ${z[n].toLowerCase()}FromFloat(round(inputValue));
`,t+=`
}
`,[Ns[n],t]}function c1(n){let e=At(n),t=sS[n];return[Ns[n],sd[n],n1,n===z.UINT32?ch:i1,n===z.UINT32?r1:a1,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}var uW={[z.UINT8]:cd(z.UINT8),[z.INT8]:cd(z.INT8),[z.UINT16]:cd(z.UINT16),[z.INT16]:cd(z.INT16),[z.FLOAT32]:cd(z.FLOAT32),[z.UINT32]:c1(z.UINT32),[z.INT32]:c1(z.INT32),[z.UINT64]:[Et,id,sh,YE,KE,eS,XE,sd[z.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function u1(n,e,t){let r=`uLerpParams_${e}`,i=`uLerpBounds_${e}`,a=`uLerpScalar_${e}`,o="";switch(t){case z.INT8:case z.UINT8:case z.INT16:case z.UINT16:case z.FLOAT32:n.addUniform("vec2",r);break;case z.INT32:case z.UINT32:{let l=sS[t];n.addUniform(`${t===z.INT32?"i":"u"}vec2`,i),n.addUniform("float",a),o+=`
#define ${r} ${l}(${i}[0], int(${i}[1]), ${a})
`;break}case z.UINT64:{n.addUniform("uvec3",i),n.addUniform("float",a),o+=`
#define ${r} Uint64LerpParameters(uint64_t(${i}.xy), int(${i}[2]), ${a})
`;break}}return[sd[t],o]}function uh(n,e,t,r=!1){return[Ns[t],u1(n,e,t),cW[t],`
float ${e}(${At(t)} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${r?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`]}function d1(n,e,t){return[Ns[t],u1(n,e,t),uW[t],`
${At(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}var Bs=new X;function lc(n,e,t,r){let{gl:i}=n;switch(t){case z.INT8:case z.UINT8:case z.INT16:case z.UINT16:case z.FLOAT32:i.uniform2f(n.uniform(`uLerpParams_${e}`),r[0],1/(r[1]-r[0]));break;case z.INT32:case z.UINT32:{let a=r[0],o=r[1]-a,l=Math.max(0,Math.ceil(Math.log2(Math.abs(o)))-24),c=Math.pow(2,l)/o,d=n.uniform(`uLerpBounds_${e}`);t===z.UINT32?i.uniform2ui(d,a,l):i.uniform2i(d,a,l),i.uniform1f(n.uniform(`uLerpScalar_${e}`),c);break}case z.UINT64:{let a=r[0],o=r[1];X.absDifference(Bs,o,a);let l=Bs.high>0?32+Math.ceil(Math.log2(Bs.high)):Math.ceil(Math.log2(Bs.low)),c=Math.max(0,l-24);X.rshift(Bs,Bs,c);let d=1/Bs.low;X.compare(a,o)>0&&(d*=-1);let p=n.uniform(`uLerpBounds_${e}`);i.uniform3ui(p,a.low,a.high,c),i.uniform1f(n.uniform(`uLerpScalar_${e}`),d)}}}function dW(n){let e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return n.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function pW(n){let e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/,t=0,r=n;e:for(;n.length;){let i=n.match(e);if(i===null)break;let a=i[0];switch(a.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){n=n.substring(a.length);break e}break}n=n.substring(a.length)}return t!==0?-1:r.length-n.length}function fW(n){let e=[],t=new Map;if(n===void 0)return{errors:e,parameters:t};let r=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;n=n.trim(),n.length!=0;){let i=n.match(r);if(i===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a=i[1];n=n.substring(i[0].length);let o=pW(n);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(n.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${a}: ${l}`);break}t.has(a)?e.push(`Duplicate #uicontrol parameter: ${a}`):t.set(a,l),n=n.substring(o),n=n.trim(),n.length>0&&!n.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),n=n.substring(1)}return{parameters:t,errors:e}}function hW(n,e){let t,r,i,a,o=[];n!=="float"&&n!=="uint"&&n!=="int"&&o.push("type must be float, int, or uint");for(let[l,c]of e){let d=()=>{if(typeof c!="number"){o.push(`Expected ${l} argument to be a number`);return}return(n==="int"||n==="uint")&&(Number.isInteger(c)||o.push(`Expected ${l} argument to be an integer`),n==="uint"&&c<0&&o.push(`Expected ${l} argument to be an unsigned integer`)),c};l==="min"?t=d():l==="max"?r=d():l==="default"?a=d():l==="step"?i=d():o.push(`Invalid parameter: ${l}`)}return t===void 0&&o.push("min must be specified"),r===void 0&&o.push("max must be specified"),t!==void 0&&r!==void 0&&(t>r&&o.push("min must be less than max"),i===void 0&&(n==="float"?i=(r-t)/100:i=1),a!==void 0?(a<t||a>r)&&o.push("default must be within valid range"):n==="float"?a=(t+r)/2:a=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:n,min:t,max:r,step:i,default:a},errors:void 0}}function mW(n,e){let t=!1,r=[];n!=="bool"&&r.push("type must be bool");for(let[i,a]of e)if(i==="default"){if(typeof a!="boolean"){r.push(`Expected ${i} argument to be a boolean`);continue}t=a}else r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"checkbox",valueType:n,default:t},errors:void 0}}function gW(n,e){let t="white",r=[];n!=="vec3"&&r.push("type must be vec3");for(let[i,a]of e)i==="default"?typeof a!="string"?r.push("Expected default argument to be a string"):t=a:r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"color",valueType:n,defaultString:t,default:ra(t)},errors:void 0}}function p1(n,e){typeof n=="number"&&(n=[n]);let t=new Array(e);return $e(t,n,r=>{if(!Number.isInteger(r)||r<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(r)}`);return r}),t}function yW(n,e,t){let r=[],{imageData:i}=t;if(i===void 0)return r.push("invlerp control not supported"),{errors:r};n!=="invlerp"&&r.push("type must be invlerp");let a=new Array(i.channelRank).fill(0),{dataType:o}=i,l=!0,c=Xl[o],d;for(let[p,m]of e)try{switch(p){case"range":{c=$u(m,o);break}case"window":{d=sv($u(m,o));break}case"clamp":{typeof m!="boolean"?r.push(`Invalid clamp value: ${JSON.stringify(m)}`):l=m;break}case"channel":{a=p1(m,a.length);break}default:r.push(`Invalid parameter: ${p}`);break}}catch(y){r.push(`Invalid ${p} value: ${y.message}`)}return r.length>0?{errors:r}:{control:{type:"invlerp",dataType:o,clamp:l,default:{range:c,window:d!=null?d:Lk(c),channel:a}},errors:void 0}}var vW=new Map([["slider",hW],["color",gW],["invlerp",yW],["checkbox",mW]]);function Ya(n,e={}){n=dW(n);let t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,r=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,i=[],a=new Map,o=n.replace(t,(l,c,d)=>{var R;let p=c.match(r),m=()=>Math.max(0,n.substring(0,d).split(`
`).length-1);if(p===null)return i.push({line:m(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";let y=p[1],v=p[2],b=(R=p[3])!=null?R:y,x=p[4],{parameters:C,errors:L}=fW(x);for(let P of L)i.push({line:m(),message:P});if(a.has(v)&&i.push({line:m(),message:`Duplicate definition for control ${v}`}),L.length>0)return"";let A=vW.get(b);if(A===void 0)return i.push({line:m(),message:`Invalid control type ${b}`}),"";let D=A(y,C,e);if(D.errors!==void 0){for(let P of D.errors)i.push({line:m(),message:P});return""}return a.set(v,D.control),""});return{source:n,code:o,errors:i,controls:a}}function f1(n){return`u_shaderControl_${n}`}function Ii(n,e){let{builderValues:t}=n;for(let[r,i]of n.parseResult.controls){let a=f1(r),o=t[r];switch(i.type){case"invlerp":{let l=[uh(e,a,i.dataType,i.clamp),`
float ${a}() {
  return ${a}(getDataValue(${o.channel.join(",")}));
}
`];e.addFragmentCode(l),e.addFragmentCode(`#define ${r} ${a}
`);break}case"checkbox":{let l=`#define ${r} ${o.value}
`;e.addFragmentCode(l),e.addVertexCode(l);break}default:{e.addUniform(`highp ${i.valueType}`,a),e.addVertexCode(`#define ${r} ${a}
`),e.addFragmentCode(`#define ${r} ${a}
`);break}}}}function SW(n){let e={};for(let[t,r]of n)e[t]=r;return e}function h1(n){if(n!==void 0)return JSON.stringify(SW(n))}var m1=class{constructor(){this.changed=new ae;this.controls=void 0}get value(){return this.controls}set value(e){h1(e)!==h1(this.controls)&&(this.controls=e,this.changed.dispatch())}};function bW(n,e,t){return n===void 0?t:(Z(n),{range:de(n,"range",r=>$u(r,e),t.range),window:de(n,"window",r=>sv($u(r,e)),t.window),channel:de(n,"channel",r=>p1(r,t.channel.length),t.channel)})}var g1=class extends ct{constructor(e,t){super(t,r=>bW(r,e,t));this.dataType=e;this.defaultValue=t}toJSON(){let{value:{range:e,window:t,channel:r},dataType:i,defaultValue:a}=this,o=lv(e,i,a.range),l=lv(t,i,a.window),c=Ce(a.channel,r)?void 0:r;if(!(o===void 0&&l===void 0&&c===void 0))return{range:o,window:l,channel:c}}};function y1(n){switch(n.type){case"slider":return{trackable:new ct(n.default,e=>{let t;if(n.valueType==="float"?t=Ze(e):t=yt(e),t<n.min||t>n.max)throw new Error(`${JSON.stringify(e)} is outside valid range [${n.min}, ${n.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new Lo(n.default),getBuilderValue:()=>null};case"invlerp":return{trackable:new g1(n.dataType,n.default),getBuilderValue:e=>({channel:e.channel,dataType:n.dataType})};case"checkbox":return{trackable:new mt(n.default),getBuilderValue:e=>({value:e})}}}function v1(n,e){return JSON.stringify(n)+"\0"+e.source}function _o(n){let e={};for(let[t,r]of n.controls){let{trackable:i,getBuilderValue:a}=y1(r);e[t]=a(i.value)}return{builderValues:e,parseResult:n,key:v1(e,n)}}var Ka=class extends ${constructor(e,t=Br({}),r){super();this.fragmentMain=e;this.dataContext=t;this.channelCoordinateSpaceCombiner=r;this.changed=new ae;this.controls=new m1;this.fragmentMainGeneration=-1;this.dataContextGeneration=-1;this.parseErrors_=[];this.processedFragmentMain_="";this.controlsGeneration=-1;this.parseResultChanged=new ae;this.state_=new Map;this.unparsedJson=void 0;this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();let i=this;this.parseErrors={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return i.parseResult_}},this.builderState=qt((l,c)=>{let d={};for(let[p,{trackable:m,getBuilderValue:y}]of c){let v=y(m.value);d[p]=v}return{key:v1(d,l),parseResult:l,builderValues:d}},[this.parseResult,this],(l,c)=>l.key===c.key);let a=qt(l=>{let c=[];for(let{control:d,trackable:p}of l.values())d.type==="invlerp"&&c.push({channel:p.value.channel});return c},[this],(l,c)=>Au(l,c,(d,p)=>Ce(d.channel,p.channel))),o=Un(l=>{let c=[];for(let{control:d,trackable:p}of l.values())d.type==="invlerp"&&c.push(p.value.window);return c},this);this.histogramSpecifications=this.registerDisposer(new ad(a,o))}handleFragmentMainChanged(){let e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;let r=this.dataContext.value;if(r===null)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{let i=this.parseResult_=Ya(this.fragmentMain.value,r);this.parseErrors_=i.errors,this.processedFragmentMain_=i.code,i.errors.length===0&&(this.controls.value=i.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){let e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;let t=this.controls.value;if(t===void 0)return;let r=!1,{state_:i,unparsedJson:a}=this;for(let[o,l]of i)if(t.get(o)===void 0){l.trackable.changed.remove(this.changed.dispatch),i.delete(o),r=!0;continue}for(let[o,l]of t){let c=i.get(o);if(c!==void 0&&JSON.stringify(c.control)!==JSON.stringify(l)&&(c.trackable.changed.remove(this.changed.dispatch),c=void 0),c===void 0){let{trackable:d,getBuilderValue:p}=y1(l);c={control:l,trackable:d,getBuilderValue:p},c.trackable.changed.add(this.changed.dispatch),i.set(o,c),r=!0}if(a!==void 0&&a.hasOwnProperty(o)){r=!0;try{c.trackable.restoreState(a[o])}catch{}}}a!==void 0&&(r=!0),this.unparsedJson=void 0,r&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;let{state:t}=this;if(Z(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(let[i,a]of t){let{trackable:o}=a;if(o.reset(),e.hasOwnProperty(i))try{o.restoreState(e[i])}catch{}}this.unparsedJson=void 0}reset(){for(let e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){let{state:e}=this,{unparsedJson:t}=this;if(t!==void 0)return t;let r={},i=!0;for(let[a,o]of e){let l=o.trackable.toJSON();l!==void 0&&(r[a]=l,i=!1)}if(!i)return r}};function S1(n,e,t,r,i){let a=f1(t),o=e.uniform(a);switch(r.type){case"slider":switch(r.valueType){case"int":case"uint":n.uniform1i(o,i);break;case"float":n.uniform1f(o,i)}break;case"color":n.uniform3fv(o,i);break;case"invlerp":lc(e,a,r.dataType,i.range);break;case"checkbox":break}}function Jr(n,e,t,r){let{state:i}=t;if(t.controls.value===r)for(let[a,o]of i)S1(n,e,a,o.control,o.trackable.value);else for(let[a,o]of r){let l=i.get(a),c=l!==void 0&&JSON.stringify(l.control)===JSON.stringify(o)?l.trackable.value:o.default;S1(n,e,a,o,c)}}function b1(n,e){return{defineShader(t,r){let i=`prop_${r}`,a=`a_${i}`;t.addAttribute(`${n}`,a),t.addVertexCode(`${n} ${i}() { return ${a}; }`),t.addInitializer(o=>{let l=o.attribute(a),{gl:c}=o;o.vertexShaderInputBinders[i]=l===-1?{enable(){},disable(){},bind(){}}:{enable(d){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,d)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(d,p){e(c,l,d,p)}}})}}}function lS(n,e,t,r){return b1(n,(i,a,o,l)=>{i.vertexAttribPointer(a,e,t,r,o,l)})}function cc(n,e,t){return b1(n,(r,i,a,o)=>{r.vertexAttribIPointer(i,e,t,a,o)})}var xW={rgb:lS("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:lS("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:lS("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:cc("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:cc("highp int",1,WebGL2RenderingContext.INT),uint16:cc("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:cc("highp int",1,WebGL2RenderingContext.SHORT),uint8:cc("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:cc("highp int",1,WebGL2RenderingContext.BYTE)},Xa=class extends ${constructor(e,t,r,i,a,o,l){super();this.gl=e;this.annotationType=t;this.rank=r;this.properties=i;this.shaderControlState=a;this.fallbackShaderParameters=o;this.shaderError=l;let c=this.serializedGeometryBytesPerAnnotation=Kt[t].serializedBytes(r),{offsets:d,serializedBytes:p}=uv(r,i);this.serializedBytesPerAnnotation=p+c,this.propertyOffsets=d}getDependentShader(e,t){return jr(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(r,i)=>{let{rank:a,properties:o}=this,l=[],c=i.parseResult.code;for(let m=0,y=o.length;m<y;++m){let v=o[m],b=`prop_${v.identifier}`;if(!c.match(new RegExp(`\\b${b}\\b`)))continue;l.push(m),xW[v.type].defineShader(r,v.identifier,a)}let{propertyOffsets:d}=this;r.addInitializer(m=>{let y=l.map(b=>m.vertexShaderInputBinders[`prop_${o[b].identifier}`]),v=y.length;m.vertexShaderInputBinders.properties={enable(b){for(let x=0;x<v;++x)y[x].enable(b)},bind(b,x){for(let C=0;C<v;++C)y[C].bind(b,x+d[l[C]])},disable(){for(let b=0;b<v;++b)y[b].disable()}}}),r.addUniform("highp vec3","uColor"),r.addUniform("highp uint","uSelectedIndex"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec3","uSubspaceMatrix",a),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp float","uModelClipBounds",a*2),r.addUniform("highp uint","uPickID"),r.addVarying("highp uint","vPickID","flat"),r.addVertexCode(Ei),r.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),r.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);let p=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;r.addVertexCode(p),r.addFragmentCode(p),r.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${a}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),Ii(i,r),r.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(let[m,y]of cS)m!==this.annotationType&&y.defineShaderNoOpSetters(r);t(r),r.addVertexCode(`
#define main userMain
`+Di(i.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let r=`
void setPartIndex(${t.map((i,a)=>`highp uint partIndex${a}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((i,a)=>`highp uint pickOffset${a} = pickBaseOffset + partIndex${a};`).join(`
`)}
`;return t.length===0&&(r+=`
  highp uint pickOffset0 = pickBaseOffset;
`),r+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((i,a)=>` || selectedIndex == pickOffset${a}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(r),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,r){let{shader:i,parameters:a}=e(t.renderContext.emitter);if(i===null)return;i.bind();let{gl:o}=this,{renderContext:l}=t,{annotationLayer:c}=t;if(Jr(o,i,this.shaderControlState,a.parseResult.controls),o.uniform3fv(i.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(i.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(i.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),l.emitPickID&&o.uniform1ui(i.uniform("uPickID"),t.basePickId),l.emitColor){let p=c.state.displayState.color.value;o.uniform3f(i.uniform("uColor"),p[0],p[1],p[2]),o.uniform1ui(i.uniform("uSelectedIndex"),t.selectedIndex)}let d=i.vertexShaderInputBinders.properties;d.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),d.bind(this.serializedBytesPerAnnotation,t.bufferOffset+this.serializedGeometryBytesPerAnnotation),r(i),d.disable()}},cS=new Map;function Vo(n,e){cS.set(n,e)}function Oo(n){return cS.get(n)}var Qe;(function(c){c[c.GPU_MEMORY=0]="GPU_MEMORY",c[c.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",c[c.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",c[c.DOWNLOADING=3]="DOWNLOADING",c[c.QUEUED=4]="QUEUED",c[c.NEW=5]="NEW",c[c.FAILED=6]="FAILED",c[c.EXPIRED=7]="EXPIRED"})(Qe||(Qe={}));var dh=8,da;(function(l){l[l.FIRST_TIER=0]="FIRST_TIER",l[l.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",l[l.VISIBLE=0]="VISIBLE",l[l.PREFETCH=1]="PREFETCH",l[l.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",l[l.RECENT=2]="RECENT",l[l.LAST_TIER=2]="LAST_TIER"})(da||(da={}));var uS=3,ud;(function(t){t[t.totalTime=0]="totalTime",t[t.totalChunks=1]="totalChunks"})(ud||(ud={}));var pa;(function(r){r[r.numChunks=0]="numChunks",r[r.systemMemoryBytes=1]="systemMemoryBytes",r[r.gpuMemoryBytes=2]="gpuMemoryBytes"})(pa||(pa={}));var fa=3,CW=2,bY=dh*uS*fa+CW;function No(n,e){return n*uS+e}function dS(n){return dh*uS*fa+n}var x1="ChunkQueueManager",C1="ChunkManager",w1="ChunkSource.invalidate",T1="ChunkQueueManager.requestChunkStatistics",L1="ChunkManager.chunkLayerStatistics",Fs=class{constructor(){this.numVisibleChunksNeeded=0;this.numVisibleChunksAvailable=0;this.numPrefetchChunksNeeded=0;this.numPrefetchChunksAvailable=0}};var k1=!1,fr=class{constructor(e){this.source=e;this.state=Qe.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=Qe.GPU_MEMORY}freeGPUMemory(e){this.state=Qe.SYSTEM_MEMORY}};function E1(n){if(typeof n!="number"||n<0)throw new Error(`Expected non-negative number as limit, but received: ${JSON.stringify(n)}`);return n}var uc=class{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new ct(t,E1),this.itemLimit=new ct(e,E1)}},dd=class extends hn{constructor(e,t,r,i){super();this.gl=t;this.frameNumberCounter=r;this.capacities=i;this.visibleChunksChanged=new ae;this.pendingChunkUpdates=null;this.pendingChunkUpdatesTail=null;this.chunkUpdateDeadline=null;this.chunkUpdateDelay=30;this.enablePrefetch=new mt(!0,!0);let a=o=>({itemLimit:this.registerDisposer(Lt.makeFromExisting(e,o.itemLimit)).rpcId,sizeLimit:this.registerDisposer(Lt.makeFromExisting(e,o.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:a(i.gpuMemory),systemMemoryCapacity:a(i.systemMemory),downloadCapacity:a(i.download),computeCapacity:a(i.compute),enablePrefetch:this.registerDisposer(Lt.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e=this.chunkUpdateDeadline,t;e===null||Date.now()<e?t=0:t=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),t)}processPendingChunkUpdates(e=!1){let t=this.chunkUpdateDeadline;!e&&t===null&&(t=Date.now()+30);let r=!1,i=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let a=this.pendingChunkUpdates;if(a==null)break;if(this.applyChunkUpdate(a)&&(r=!0),++i,(this.pendingChunkUpdates=a.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return r&&this.visibleChunksChanged.dispatch(),i}handleFetch_(e,t){let{resolve:r,reject:i,cancellationToken:a}=t.promise;if(a.isCanceled){i(Er);return}let o=t.key,l=e.chunks.get(o);if(!l){i(new Error(`No chunk found at ${o} for source ${e.constructor.name}`));return}let c=l.data;if(!c){i(new Error(`At ${o} for source ${e.constructor.name}: chunk has no data`));return}r({value:c})}applyChunkUpdate(e){let t=!1,{rpc:r}=this,i=r.get(e.source);if(k1&&console.log(`${Date.now()} Chunk.update processed: ${i.rpcId} ${e.id} ${e.state}`),e.promise!==void 0)this.handleFetch_(i,e);else if(e.id===void 0){for(let a of i.chunks.keys())i.deleteChunk(a);t=!0}else{let a=e.state;if(a===Qe.EXPIRED)i.deleteChunk(e.id);else{let o,l=e.id;e.new?(o=i.getChunk(e),i.addChunk(l,o)):o=i.chunks.get(l);let c=o.state;if(a!==c)switch(a){case Qe.GPU_MEMORY:o.copyToGPU(this.gl),t=!0;break;case Qe.SYSTEM_MEMORY:o.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${Qe[a]}`)}}}return t}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){let e=this.rpc,t=await e.promiseInvoke(T1,{queue:this.rpcId}),r=new Map;for(let[i,a]of t){let o=e.get(i);o!==void 0&&r.set(o,a)}return r}};dd=xt([mn(x1)],dd);function D1(n,e){let t=n.get(e.source);k1&&console.log(`${Date.now()} Chunk.update received: ${t.rpcId} ${e.id} ${e.state} with chunkDataSize ${e.chunkDataSize}`);let r=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){r.applyChunkUpdate(e)&&r.visibleChunksChanged.dispatch();return}let i=r.pendingChunkUpdatesTail;i==null?(r.pendingChunkUpdates=e,r.pendingChunkUpdatesTail=e,r.scheduleChunkUpdate()):(i.nextUpdate=e,r.pendingChunkUpdatesTail=e)}Tt("Chunk.update",function(n){D1(this,n)});rh("Chunk.retrieve",function(n,e){return new Promise((t,r)=>{n.promise={resolve:t,reject:r,cancellationToken:e},D1(this,n)})});Tt(L1,function(n){let e=this.get(n.id);for(let t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(let t of n.layers){let r=this.get(t.id);if(r===void 0)continue;let i=r.layerChunkProgressInfo;i.numVisibleChunksAvailable=t.numVisibleChunksAvailable,i.numVisibleChunksNeeded=t.numVisibleChunksNeeded,i.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,i.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(i)}e.layerChunkStatisticsUpdated.dispatch()});var pd=class extends hn{constructor(e){super();this.chunkQueueManager=e;this.memoize=new qu;this.prevStatisticsLayers=[];this.layerChunkStatisticsUpdated=new ae;this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(e,t){let r=e.encodeOptions(t);r.constructorId=pt(e);let i=Dn(r);return this.memoize.get(i,()=>{let a=new e(this,t);return a.initializeCounterpart(this.rpc,{}),a.key=r,a})}};pd=xt([mn(C1)],pd);var Pn=class extends hn{constructor(e,t={}){super();this.chunkManager=e;this.chunks=new Map;this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){let t=this.chunks.get(e);t.state===Qe.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(w1,{id:this.rpcId})}static encodeOptions(e){return{}}};function ut(n,e){let t=class extends n{constructor(...i){super(...i);let a=i[1];this.parameters=a.parameters}initializeCounterpart(i,a){a.parameters=this.parameters,super.initializeCounterpart(i,a)}static encodeOptions(i){return Object.assign({parameters:i.parameters},super.encodeOptions(i))}};return t=xt([mn(e.RPC_ID)],t),t}var ha=class extends hn{constructor(e){super();this.layerChunkProgressInfo=e}};var P1=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function I1(n,e,t){n.registerDisposer(e.visibleSegments.changed.add(t)),n.registerDisposer(e.segmentEquivalences.changed.add(t))}function A1(n,e,t){n.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),n.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Dr(n){return`${n.low},${n.high}`}function wW(n){return!!(n.high>>>31)}function pS(n){return n.useTemporaryVisibleSegments.value?n.temporaryVisibleSegments:n.visibleSegments}function TW(n){return n.useTemporarySegmentEquivalences.value?n.temporarySegmentEquivalences:n.segmentEquivalences}function ma(n,e){let t=pS(n),r=TW(n),i=r.disjointSets.highBitRepresentative.value;for(let a of t)if(!!r.disjointSets.isMinElement(a))for(let o of r.setElements(a))i&&wW(o)||e(o,a)}var U1=rt(Dt());var fS=rt(Dt());var M1="rendered_view.addLayer",R1="rendered_view.removeLayer",_1="SharedProjectionParameters",V1="SharedProjectionParameters.changed";var hr;(function(r){r[r.info=0]="info",r[r.warning=1]="warning",r[r.error=2]="error"})(hr||(hr={}));var Ai=class{constructor(){this.changed=new ae;this.messages=[];this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){let{messages:e}=this;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{let{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){yield*this.messages;for(let e of this.children)yield*e}};var jn;(function(r){r[r.DATA=0]="DATA",r[r.ANNOTATION=1]="ANNOTATION",r[r.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(jn||(jn={}));function O1(){return new Oy([0,1,2])}var ph=class extends ${constructor(){super(...arguments);this.role=0;this.messages=new Ai;this.layerChanged=new ae;this.redrawNeeded=new ae;this.layerChunkProgressInfo=new Fs}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,r,i){}},fd=class extends ph{constructor(){super(...arguments);this.visibility=new ja}attach(e){}};function Bo(n,e,t){let{state:r}=t;if(r===void 0||r.transform!==n||r.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),r=t.state={transform:n,displayDimensionRenderInfo:e,modelTransform:void 0},n.error!==void 0){t.messages.addMessage({severity:hr.error,message:n.error});return}try{let i=ie.create();Xk(i,e,n),r.modelTransform=i}catch(i){t.messages.addMessage({severity:hr.error,message:i.message})}}return r.modelTransform}var hd=class extends ${constructor(e){super();this.renderViewport=new Zl;this.changed=new We;let{parametersConstructor:t=Yu,navigationState:r,update:i,isEqual:a=Vk}=e;this.oldValue_=new t,this.value_=new t;let o=()=>{let{oldValue_:c,value_:d}=this;c.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,Object.assign(c,this.renderViewport);let{globalPosition:p}=c,m=r.position.value,y=m.length;p.length!==y&&(c.globalPosition=p=new Float32Array(y)),p.set(m),i(c,r),!a(c,d)&&(this.value_=c,this.oldValue_=d,this.changed.dispatch(d,c))},l=this.update=this.registerCancellable((0,fS.default)(o,0));this.registerDisposer(r.changed.add(l)),o()}setViewport(e){Nf(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}},Us=class extends hn{constructor(e,t,r=10){super();this.base=t;this.updateInterval=r;this.prevDisplayDimensionRenderInfo=void 0;this.update=this.registerCancellable((0,fS.default)((e,t)=>{let r;if(t.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)r=t,this.prevDisplayDimensionRenderInfo=t.displayDimensionRenderInfo;else{let{displayDimensionRenderInfo:i,...a}=t;r=a}this.rpc.invoke(V1,{id:this.rpcId,value:r})},this.updateInterval));this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}};Us=xt([mn(_1)],Us);var en=40,N1=.5,B1=-4;function md(n){return(Math.log2(n)-B1)/N1}function F1(n){return 2**(n*N1+B1)}function Mi(n){return new ct(n,dt)}var ga=class{constructor(){this.visibility=new ja;this.changed=new ae;this.frameNumber=-1;this.spatialScales=new Map;this.numHistogramRows=1;this.value=new Uint32Array(en*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,r,i){let{spatialScales:a,numHistogramRows:o,value:l}=this,c=a.get(e);if(c===void 0&&(c=a.size,a.set(e,c)),c>=o){this.numHistogramRows=o*=2;let p=new Uint32Array(o*en*2);p.set(l),this.value=l=p}let d=c*en*2+Math.min(Math.max(0,Math.round(md(t))),en-1);l[d]+=r,l[d+en]+=i}};var dc=class extends ph{constructor(e,t,r){super();this.chunkManager=e;this.multiscaleSource=t;this.rpcId=null;this.visibleSources=new Map;this.visibleSourcesList_=[];var a;let{renderScaleTarget:i=Mi(1)}=r;this.renderScaleTarget=i,this.renderScaleHistogram=r.renderScaleHistogram,this.transform=r.transform,this.localPosition=r.localPosition,this.dataHistogramSpecifications=this.registerDisposer((a=r.dataHistogramSpecifications)!=null?a:new ad(Br([]),Br([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){let{dataHistogramSpecifications:e}=this;return e.visibility.visible?e.bounds.value.length:0}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){let{visibleSources:r}=this,i=r.get(e);i!==void 0?(++i.refCount,i.chunkTransform=t):(r.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){let{visibleSources:t}=this,r=t.get(e);r.refCount!==1?--r.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){let{visibleSources:e,visibleSourcesList_:t}=this;if(t.length===0&&e.size!==0){for(let r of e.values())t.push(r);t.sort((r,i)=>r.chunkTransform.chunkToLayerTransformDet-i.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){let e=this.registerDisposer(new ha(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(Lt.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Lt.makeFromExisting(t,this.renderScaleTarget)).rpcId}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return cE(e,this,t)}};dc.prototype.RPC_TYPE_ID=dE;var ya=class extends fd{draw(e,t){}isReady(e,t){return!0}};var W1=class extends zv{},LW=la(W1);function kW(n){return{source:n.source.addCounterpartRef(),effectiveVoxelSize:n.effectiveVoxelSize,layerRank:n.layerRank,nonDisplayLowerClipBound:n.nonDisplayLowerClipBound,nonDisplayUpperClipBound:n.nonDisplayUpperClipBound,lowerClipBound:n.lowerClipBound,upperClipBound:n.upperClipBound,lowerClipDisplayBound:n.lowerClipDisplayBound,upperClipDisplayBound:n.upperClipDisplayBound,chunkDisplayDimensionIndices:n.chunkDisplayDimensionIndices,lowerChunkDisplayBound:n.lowerChunkDisplayBound,upperChunkDisplayBound:n.upperChunkDisplayBound,fixedLayerToChunkTransform:n.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:n.combinedGlobalLocalToChunkTransform,chunkLayout:n.chunkLayout.toObject()}}function gd(n){return n.map(e=>e.map(kW))}function hS(n,e){for(let t of e)for(let{source:r}of t)n.removeSource(r),r.dispose()}var pc=class extends LW{constructor(e,t,r,i){super(new hd({parametersConstructor:Gv,navigationState:r,update:(l,c)=>{let{invViewMatrix:d,centerDataPosition:p}=l;c.toMat4(d);let{canonicalVoxelFactors:m,voxelPhysicalScales:y}=l.displayDimensionRenderInfo;for(let P=0;P<3;++P)p[P]=d[12+P];let{logicalWidth:v,logicalHeight:b,projectionMat:x,viewportNormalInGlobalCoordinates:C,viewportNormalInCanonicalCoordinates:L}=l,{relativeDepthRange:A}=c;ie.ortho(x,-v/2,v/2,b/2,-b/2,-A,A),Of(l,x),Gf(l);let{viewMatrix:D}=l;for(let P=0;P<3;++P){let E=C[P]=D[P*4+2];L[P]=E/m[P]}K.normalize(C,C),K.normalize(L,L);let R=0;for(let P=0;P<3;++P){let E=y[P],V=d[P];R+=(E*V)**2}R=Math.sqrt(R),l.pixelSize=R}}));this.chunkManager=e;this.layerManager=t;this.navigationState=r;this.wireFrame=i;this.gl=this.chunkManager.gl;this.viewChanged=new ae;this.renderingStale=!0;this.visibleChunksStale=!0;this.visibleLayerList=new Array;this.offscreenFramebuffer=this.registerDisposer(new Pi(this.gl,{colorBuffers:Vs(this.gl,1),depthBuffer:new Qv(this.gl)}));this.histogramInputTextures=[];this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer];this.histogramGenerator=od.get(this.gl);this.updateVisibleLayers=this.registerCancellable((0,U1.default)(()=>{this.updateVisibleLayersNow()},0));this.registerDisposer(r),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((l,c)=>{l.displayDimensionRenderInfo!==c.displayDimensionRenderInfo&&this.updateVisibleLayers()}));let a=this.chunkManager.rpc,o=this.sharedProjectionParameters=this.registerDisposer(new Us(a,this.projectionParameters));this.initializeCounterpart(a,{chunkManager:e.rpcId,projectionParameters:o.rpcId}),this.registerDisposer(t.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(e,t,r){yE(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,()=>{r(e.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(let{visibleSources:r}of this.visibleLayers.values())for(let i of r){let a=sc(this.projectionParameters.value,i.chunkLayout),{source:o}=i,{chunks:l}=o;this.forEachVisibleChunk(i,a,c=>{let d=l.get(c);++t,d&&d.state===Qe.GPU_MEMORY&&++e})}return e===t}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add(()=>this.invalidateVisibleChunks())),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));let{renderScaleHistogram:r}=e;r!==void 0&&t.push(r.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;let e=Date.now(),{visibleLayers:t,visibleLayerList:r}=this,{displayDimensionRenderInfo:i}=this.projectionParameters.value,a=this.rpc,o={id:this.rpcId},l=!1;r.length=0;for(let c of this.layerManager.readyRenderLayers())if(c instanceof dc){r.push(c);let d=t.get(c);if(d===void 0){let p=[],m=new Ai;d={messages:m,allSources:this.getTransformedSources(c,m),transformGeneration:c.transform.changed.count,visibleSources:[],disposers:p,lastSeenGeneration:e,displayDimensionRenderInfo:i},p.push(c.messages.addChild(d.messages)),t.set(c.addRef(),d),this.bindVisibleRenderLayer(c,p)}else{d.lastSeenGeneration=e;let p=c.transform.changed.count;if(d.transformGeneration===p&&d.displayDimensionRenderInfo===i)continue;let m=d.allSources;d.allSources=this.getTransformedSources(c,d.messages),hS(c,m),d.visibleSources.length=0,d.displayDimensionRenderInfo=i,d.transformGeneration=p}o.layerId=c.rpcId,o.sources=gd(d.allSources),this.flushBackendProjectionParameters(),a.invoke(pE,o),l=!0}for(let[c,d]of t)d.lastSeenGeneration!==e&&(o.layerId=c.rpcId,a.invoke(fE,o),t.delete(c),hS(c,d.allSources),Oa(d.disposers),c.dispose(),l=!0);return l&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),l}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){let{offscreenFramebuffersWithHistograms:t}=this,r=t[e];if(r===void 0){let{gl:i,histogramInputTextures:a,offscreenFramebuffer:o}=this;a.length<e&&a.push(...Vs(i,e-a.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let l=[o.colorBuffers[0].addRef()];for(let c=0;c<e;++c)l.push(a[c].addRef());r=this.registerDisposer(new Pi(i,{colorBuffers:l,depthBuffer:o.depthBuffer.addRef()})),t[e]=r}return r}updateRendering(){let e=this.projectionParameters.value,{width:t,height:r}=e;if(!this.renderingStale||!this.valid||t===0||r===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let{gl:i,offscreenFramebuffer:a}=this;a.bind(t,r),i.disable(i.SCISSOR_TEST),i.clearColor(0,0,0,0),i.colorMask(!0,!0,!0,!0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let o=0,l=this.wireFrame.value,c={sliceView:this,projectionParameters:e,wireFrame:l};for(let d of this.visibleLayerList){let p=l?0:d.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(p).bind(t,r);for(let y=0;y<p;++y)i.clearBufferfv(WebGL2RenderingContext.COLOR,1+y,Bu);i.enable(WebGL2RenderingContext.DEPTH_TEST),i.depthFunc(WebGL2RenderingContext.LESS),i.clearDepth(1),i.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),d.setGLBlendMode(i,o),d.draw(c),++o}i.disable(WebGL2RenderingContext.BLEND),i.disable(WebGL2RenderingContext.DEPTH_TEST),a.unbind()}disposed(){for(let[e,t]of this.visibleLayers)hS(e,t.allSources),Oa(t.disposers),e.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){let r=Sd(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,i=>e.getSources(i),t,e);for(let i of r)for(let a of i)e.addSource(a.source,a.chunkTransform);return r}};pc=xt([mn(uE)],pc);var yd=class extends Pn{constructor(e,t){super(e,t);this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){let t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}},vd=class extends fr{constructor(e,t){super(e);this.chunkGridPosition=t.chunkGridPosition,this.state=Qe.SYSTEM_MEMORY}},Ws=class extends ${constructor(e,t){super();this.gl=e;this.copyVertexPositionsBuffer=Mo(this.gl);this.textureCoordinateAdjustment=new Float32Array(4);let r=new $r(e);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler"),r.addInitializer(i=>{e.uniform1i(i.uniform("uSampler"),0)}),r.addUniform("vec4","uColorFactor"),r.addUniform("vec4","uBackgroundColor"),r.addUniform("mat4","uProjectionMatrix"),r.addUniform("vec4","uTextureCoordinateAdjustment"),r.require(t),r.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),r.addAttribute("vec4","aVertexPosition"),r.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(r.build())}draw(e,t,r,i,a,o,l,c){let{gl:d,shader:p,textureCoordinateAdjustment:m}=this;m[0]=a,m[1]=o,m[2]=l-a,m[3]=c-o,p.bind(),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,e),d.disable(WebGL2RenderingContext.BLEND),d.uniformMatrix4fv(p.uniform("uProjectionMatrix"),!1,t),d.uniform4fv(p.uniform("uColorFactor"),r),d.uniform4fv(p.uniform("uBackgroundColor"),i),d.uniform4fv(p.uniform("uTextureCoordinateAdjustment"),m);let y=p.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(y,2),d.drawArrays(d.TRIANGLE_FAN,0,4),d.disableVertexAttribArray(y),d.bindTexture(d.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${pt(t)}`,()=>new Ws(e,t))}},mS=class{constructor(e){this.chunkManager=e}};function Sd(n,e,t,r,i){r.clearMessages();let a=L=>(r.addMessage({severity:hr.error,message:L}),[]);if(e.error!==void 0)return a(e.error);let o=e.rank,l=e.unpaddedRank,{displayDimensionIndices:c,displayRank:d,canonicalVoxelFactors:p}=n,m=eh(e,c),{displayToLayerDimensionIndices:y}=m,v=new Float32Array(d*l),{modelToRenderLayerTransform:b}=e;for(let L=0;L<d;++L){let A=y[L];if(A===-1)continue;let D=p[L];for(let R=0;R<l;++R)v[d*R+L]=b[(o+1)*R+A]*D}let x=t({displayRank:d,multiscaleToViewTransform:v,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),{voxelPhysicalScales:C}=n;try{let L=A=>{let{chunkSource:D}=A,{spec:R}=D,{lowerClipBound:P=R.lowerVoxelBound,upperClipBound:E=R.upperVoxelBound}=A,V=Zf(e,A.chunkToMultiscaleTransform),{chunkDataSize:O}=R,{channelToChunkDimensionIndices:B}=V,W=new Float32Array(l),_=new Float32Array(l);W.set(P),_.set(E);let F=B.length,{channelSpaceShape:N}=e;for(let Ke=0;Ke<F;++Ke){let Pe=B[Ke];if(Pe===-1)continue;let at=N[Ke];if(O[Pe]!==at)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[Ke]]+` has extent ${at} but corresponding chunk dimension has extent ${O[Pe]}`);W[Pe]=Number.NEGATIVE_INFINITY,_[Pe]=Number.POSITIVE_INFINITY}let J=th(V,m),re=K.create(),pe=K.create(),ye=K.create(),ce=K.create(),fe=K.create(),{numChunkDisplayDims:Le,chunkDisplayDimensionIndices:Ge}=J,{combinedGlobalLocalToChunkTransform:ze,layerRank:tt,combinedGlobalLocalRank:ge}=V,Te=new Float32Array(ze);for(let Ke=0;Ke<Le;++Ke){let Pe=Ge[Ke];for(let at=0;at<=ge;++at)Te[Pe+at*tt]=0;Pe<l?(fe[Ke]=R.chunkDataSize[Pe],re[Ke]=R.lowerChunkBound[Pe],pe[Ke]=R.upperChunkBound[Pe],ye[Ke]=P[Pe],ce[Ke]=E[Pe],W[Pe]=Number.NEGATIVE_INFINITY,_[Pe]=Number.POSITIVE_INFINITY):(fe[Ke]=1,re[Ke]=0,pe[Ke]=1,ye[Ke]=0,ce[Ke]=1)}fe.fill(1,Le),re.fill(0,Le),pe.fill(1,Le),ye.fill(0,Le),ce.fill(1,Le);let Fe=new Rs(fe,J.displaySubspaceModelMatrix,Le),He=Fe.localSpatialVectorToGlobal(K.create(),Cf);for(let Ke=0;Ke<d;++Ke)He[Ke]=Math.abs(He[Ke]*C[Ke]);return He.fill(1,d),{layerRank:tt,lowerClipBound:P,upperClipBound:E,nonDisplayLowerClipBound:W,nonDisplayUpperClipBound:_,renderLayer:i,source:D,lowerChunkDisplayBound:re,upperChunkDisplayBound:pe,lowerClipDisplayBound:ye,upperClipDisplayBound:ce,effectiveVoxelSize:He,chunkLayout:Fe,chunkDisplayDimensionIndices:Ge,fixedLayerToChunkTransform:Te,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:V.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:V,chunkDisplayTransform:J}};return x.map(A=>A.map(D=>L(D)))}catch(L){for(let P of x)for(let{chunkSource:E}of P)E.dispose();let{globalDimensionNames:A}=n,R=`Cannot render (${Array.from(n.displayDimensionIndices.filter(P=>P!==-1),P=>A[P]).join(",\xA0")}) cross section: ${L.message}`;return a(R)}}var Gs=null,EW=200,Ee=class{constructor(e=!1){if(Gs===null){Gs=document.createElement("ul"),Gs.id="statusContainer";let r=document.getElementById("neuroglancer-container");r?r.appendChild(Gs):document.body.appendChild(Gs)}let t=document.createElement("li");this.element=t,e===!0&&(e=EW),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,Gs.appendChild(t)}dispose(){Gs.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let r=new Ee(t.delay);r.setText(t.initialMessage);let i=r.dispose.bind(r);return e.then(i,a=>{let o;a instanceof Error?o=a.message:o=""+a;let{errorPrefix:l=""}=t;r.setErrorMessage(l+o),r.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){let t=new Ee;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){let r=this.showMessage(e);return window.setTimeout(()=>r.dispose(),t),r}};function gS(n){let e=0,{typeToIds:t}=n;for(let r of Ti)e+=Oo(r).pickIdsPerInstance*t[r].length;return e}var yS=class{constructor(e){this.bufferValid=!1;this.numPickIds=0;this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){let{buffer:t}=this;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}},G1=class extends fr{constructor(e,t){super(e);t.data!==void 0&&(this.data=new yS(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},vS=class extends vd{constructor(e,t){super(e,t);t.data!==void 0&&(this.data=new yS(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},zs=class extends yd{constructor(e,t){super(e,t);this.immediateChunkUpdates=!0;(this.parent=t.parent).spatiallyIndexedSources.add(this);let{rank:i,chunkDataSize:a}=this.spec,o=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);tc(o,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let l=0;l<i;++l)for(let c=0;c<i+1;++c)o[(i+1)*c+l]/=a[l]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new vS(this,e)}};zs=xt([mn(SE)],zs);var fh=class extends Pn{constructor(e,t,r){super(e,{});this.parent=t;this.relationshipIndex=r;this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new G1(this,e)}};fh=xt([mn(bE)],fh);var z1=class extends fr{constructor(e,t){super(e);this.annotation=vv(t.annotation)}},hh=class extends Pn{constructor(e,t){super(e);this.parent=t}getChunk(e){return new z1(this,e)}addChunk(e,t){super.addChunk(e,t);let{references:r}=this.parent,i=r.get(e);i!==void 0&&(i.value=t.annotation,i.changed.dispatch())}deleteChunk(e){let{references:t}=this.parent,r=t.get(e);r!==void 0&&(r.value=void 0,r.changed.dispatch())}};hh=xt([mn(vE)],hh);function mh(n,e,t){let{rank:r}=t,i=e.type,{serializedAnnotations:a}=n,o=a.typeToIds[i],l=a.typeToIdMaps[i],c=Kt[i],d=c.serializedBytes(r),p=d+t.serializedBytes,m=l.get(e.id),y=0;if(m===void 0){m=l.size,o.push(e.id),l.set(e.id,m);let C=new Uint8Array(a.data.length+p);y=a.typeToOffset[i]+p*m,C.set(a.data.subarray(0,y),0),C.set(a.data.subarray(y),y+p),a.data=C;for(let L of Ti)L>i&&(a.typeToOffset[L]+=p)}else y=a.typeToOffset[i]+p*m;let v=new DataView(a.data.buffer,a.data.byteOffset,a.data.byteLength),b=a.typeToOffset[i]+m*p,x=ia===fn.LITTLE;c.serialize(v,b,x,r,e),b+=d,t.serialize(v,b,x,e.properties),n.bufferValid=!1}function gh(n,e,t,r){let{serializedAnnotations:i}=n,a=i.typeToIdMaps[e],o=a.get(t);if(o===void 0)return!1;let l=i.typeToIds[e],c=Kt[e],{rank:d}=r,m=c.serializedBytes(d)+r.serializedBytes;l.splice(o,1),a.delete(t);for(let C=o,L=l.length;C<L;++C)a.set(l[C],C);let{typeToOffset:y}=i,v=y[e]+m*o,{data:b}=i,x=new Uint8Array(b.length-m);x.set(b.subarray(0,v),0),x.set(b.subarray(v+m),v),i.data=x;for(let C of Ti)C>e&&(y[C]-=m);return n.bufferValid=!1,!0}function DW(){let n=[],e=[],t=[];for(let r of Ti)n[r]=[],e[r]=0,t[r]=new Map;return new vS(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:n,typeToIdMaps:t})}var Ri=class extends hn{constructor(e,t){super();this.chunkManager=e;this.metadataChunkSource=this.registerDisposer(new hh(this.chunkManager,this));this.spatiallyIndexedSources=new Set;this.temporary=DW();this.references=new Map;this.localUpdates=new Map;this.numCommitsInProgress=0;this.changed=new ae;this.readonly=!1;this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializer=new Ps(this.rank,this.properties);let r=this.segmentFilteredSources=[],{relationships:i}=t;this.relationships=i;for(let a=0,o=i.length;a<o;++a)r.push(this.registerDisposer(new fh(e,this,a)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(let r of this.segmentFilteredSources)r.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(r=>r.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=_f();let r=new Ju(e.id);return r.value=e,this.references.set(r.id,r),r.registerDisposer(()=>{this.references.delete(r.id)}),this.applyLocalUpdate(r,!1,t,e),r}applyLocalUpdate(e,t,r,i){let{localUpdates:a}=this,{id:o}=e,l=this.localUpdates.get(o),c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},a.set(o,l),this.forEachPossibleChunk(c,d=>{let{data:p}=d;p!==void 0&&gh(p,c.type,o,this.annotationPropertySerializer)}),i!==null&&mh(this.temporary.data,i,this.annotationPropertySerializer)):(i===null?gh(this.temporary.data,c.type,c.id,this.annotationPropertySerializer):mh(this.temporary.data,i,this.annotationPropertySerializer),e.value=i),r)if(l.commitInProgress!==void 0)l.pendingCommit=i;else{if(i===null&&l.existingAnnotation===void 0){a.delete(o),l.reference.dispose();return}this.sendCommitRequest(l,i)}this.notifyChanged(e.id,i||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(wE,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){let r=this.references.get(e),i=this.metadataChunkSource.chunks.get(e);i!==void 0&&(i.annotation=t||null),r!==void 0&&(r.value=t||null,r.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new Ju(e),this.references.set(e,t),this.rpc.invoke(xE,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke(CE,{id:this.rpcId,annotation:e})});let r=this.metadataChunkSource.chunks.get(e);return r!==void 0&&(t.value=r.annotation),t}forEachPossibleChunk(e,t){let{relatedSegments:r}=e;if(r!==void 0){let c=r.length,{segmentFilteredSources:d}=this;for(let p=0;p<c;++p){let m=r[p];if(m===void 0)return;let y=d[p];for(let v of m){let b=y.chunks.get(Dr(v));b!==void 0&&t(b)}}}let{rank:i}=this,a=new Float32Array(i),o=new Float32Array(i),l=new Float32Array(i);for(let c of this.spatiallyIndexedSources){switch(e.type){case Re.POINT:zr(a,c.multiscaleToChunkTransform,i+1,e.point,i),o.set(a);break;case Re.LINE:case Re.AXIS_ALIGNED_BOUNDING_BOX:zr(a,c.multiscaleToChunkTransform,i+1,e.pointA,i),zr(o,c.multiscaleToChunkTransform,i+1,e.pointB,i);break;case Re.ELLIPSOID:zr(a,c.multiscaleToChunkTransform,i+1,e.center,i),Hf(o,c.multiscaleToChunkTransform,i+1,e.radii,i);for(let m=0;m<i;++m){let y=a[m],v=o[m];a[m]=y-v,o[m]=y+v}break}let d=1;for(let m=0;m<i;++m){let y=a[m],v=o[m],b=Math.min(y,v),x=Math.max(y,v);a[m]=Math.ceil(b-1),o[m]=Math.floor(x+1),d*=o[m]-a[m]}let{chunks:p}=c;for(let m=0;m<d;++m){let y=m;for(let b=0;b<i;++b){let x=a[b],L=o[b]-x,A=l[b]=y%L;y=(y-A)/L}let v=p.get(l.join());v!==void 0&&t(v)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&r.reference.id!==t.id){if(r.commitInProgress===null)throw new Error("Received invalid successful update notification");r.reference.id=t.id,this.references.delete(e),this.references.set(t.id,r.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,r),r.reference.value!==null&&(r.reference.value.id=t.id,gh(this.temporary.data,r.type,e,this.annotationPropertySerializer),mh(this.temporary.data,r.reference.value,this.annotationPropertySerializer)),r.reference.changed.dispatch()}r.existingAnnotation=t||void 0,r.commitInProgress=void 0;let{pendingCommit:i}=r;r.pendingCommit=void 0,t===null&&(i=void 0),i!==void 0?(i!==null&&(i.id=t.id),this.sendCommitRequest(r,i)):this.revertLocalUpdate(r)}disposed(){let{commitStatus:e}=this;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Ee(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid update notification");new Ee().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(r),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){gh(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializer);let{existingAnnotation:t}=e;t!==void 0&&this.forEachPossibleChunk(t,a=>{let{data:o}=a;o!==void 0&&mh(o,t,this.annotationPropertySerializer)});let{reference:r}=e,{id:i}=r;r.value=t||null,r.changed.dispatch(),r.dispose(),this.localUpdates.delete(i)}*[Symbol.iterator](){}};Tt(TE,function(n){let e=this.get(n.id),t=n.annotationId,r=n.error;if(r!==void 0)e.handleFailedUpdate(t,r);else{let i=vv(n.newAnnotation);e.handleSuccessfulUpdate(t,i)}});var H1="CredentialsProvider",$1="CredentialsProvider.get";var bd=class extends hn{constructor(e,t){super();this.provider=e;this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}};bd=xt([mn(H1)],bd);rh($1,function(n,e){return this.get(n.providerId).get(n.invalidCredentials,e).then(r=>({value:r}))});function xd(n,e){if(e===void 0)return;let t=n.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:pt(e)},()=>new bd(e.addRef(),n.rpc)),r=t.addCounterpartRef();return t.dispose(),r}function gt(){return function(n){class e extends n{constructor(...r){super(...r);var a;let i=r[1];this.credentialsProvider=(a=i.credentialsProvider)==null?void 0:a.addRef()}initializeCounterpart(r,i){let{credentialsProvider:a}=this;i.credentialsProvider=xd(this.chunkManager,a),super.initializeCounterpart(r,i)}static encodeOptions(r){let i=super.encodeOptions(r),{credentialsProvider:a}=r;return i.credentialsProvider=a===void 0?void 0:pt(a),i}}return e}}function Qa(n,e){return n<e?-1:n>e?1:0}var j1={offset:0,completions:[]};function Pr(n,e){return e.offset+=n,e}function yh(n,e){let t=[];for(let r of e)r.startsWith(n)&&t.push({value:r});return t.sort((r,i)=>Qa(r.value,i.value)),t}function tn(n,e,t,r){let i=[];for(let a of e){let o=t(a);o.startsWith(n)&&i.push({value:o,description:r(a)})}return i.sort((a,o)=>Qa(a.value,o.value)),i}async function PW(n,e,t){if(n.startsWith("{"))return j1;let i=n.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],a=n.length-i.length,o=i.indexOf("=");if(o===-1){let l=await e(i);return{offset:l.offset+a,completions:l.completions.map(c=>({...c,value:`${c.value}=`}))}}return Pr(a+o+1,await t(i.substring(0,o),i.substring(o+1)))}async function vh(n,e){return PW(n,async t=>{let r=[];for(let i of e){let a=i.key;a.value.startsWith(t)&&r.push(a)}return{offset:0,completions:r}},async(t,r)=>{for(let i of e)if(i.key.value===t)return{offset:0,completions:i.values.filter(a=>a.value.startsWith(r))};return j1})}var Sh=class extends Error{constructor(e){super(`Redirected to: ${e}`);this.redirectTarget=e}};function J1(n,e){e===void 0&&(n.indexOf("/")===-1?e=":":e="/");let t=n.lastIndexOf(e);return t===-1?0:t+1}function IW(n,e){let t=J1(n,e);return n.substring(t)}var oi;(function(t){t[t.annotations=0]="annotations",t[t.equivalences=1]="equivalences"})(oi||(oi={}));function bh(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}var Vt=class extends ${normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}},SS="local://annotations",xh="local://equivalences",q1=class extends Vt{get description(){return"Local in-memory"}async get(e){switch(e.url){case SS:{let{transform:t}=e,r;if(t===void 0){let i=e.globalCoordinateSpace.value,{rank:a,names:o,scales:l,units:c}=i,d=Ve({rank:a,scales:l,units:c,names:o.map((m,y)=>`${y}`)}),p=Ve({rank:a,scales:l,units:c,names:o});r={rank:a,sourceRank:a,inputSpace:d,outputSpace:p,transform:Hn(Float64Array,a+1)}}else r=wt(ki);return{modelTransform:r,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case xh:return{modelTransform:wt(ki),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:tn(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}},Y1=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/,bS=class extends ${constructor(e){super();this.credentialsManager=e;this.dataSources=new Map([["local",new q1]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){let t=e.match(Y1);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');let[,r,i]=t,a=this.dataSources.get(r);if(a===void 0)throw new Error(`Unsupported data source: ${JSON.stringify(r)}.`);return[a,i,r]}async get(e){let t=new Set,{cancellationToken:r=et}=e,i=e.url;for(;;){let[a,o,l]=this.getProvider(e.url);t.add(e.url);try{return a.get({...e,url:i,providerProtocol:l,providerUrl:o,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager})}catch(c){if(c instanceof Sh){let d=c.redirectTarget;if(t.has(d))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);i=d;continue}throw c}}}convertLegacyUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}normalizeUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}async completeUrl(e){let{url:t,cancellationToken:r=et}=e,i=t.match(Y1),a=i[1];if(a===void 0)return Promise.resolve({offset:0,completions:tn(t,this.dataSources,([o])=>`${o}://`,([,o])=>o.description)});{let o=this.dataSources.get(a);if(o!==void 0){let l=await o.completeUrl({registry:this,url:t,providerUrl:i[2],chunkManager:e.chunkManager,cancellationToken:r,credentialsManager:this.credentialsManager});return Pr(a.length+3,l)}throw null}}suggestLayerName(e){let[t,r]=this.getProvider(e);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=t.suggestLayerName;return i!==void 0?i(r):IW(r)}findSourceGroup(e){let[t,r,i]=this.getProvider(e);return(t.findSourceGroup||J1)(r)+i.length+3}};var qr=class extends Error{constructor(e,t,r){let i=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;r&&(i+=`: ${r}`),i+=".",super(i),this.name="HttpError",this.message=i,this.url=e,this.status=t,this.statusText=r}static fromResponse(e){return new qr(e.url,e.status,e.statusText)}static fromRequestError(e,t){if(t instanceof TypeError){let r;return typeof e=="string"?r=e:r=e.url,new qr(r,0,"Network or CORS error")}return t}};async function Ch(n,e){let t;try{t=await fetch(n,e)}catch(r){throw qr.fromRequestError(n,r)}if(!t.ok)throw qr.fromResponse(t);return t}function wh(n){return n.arrayBuffer()}function St(n){return n.json()}async function si(n,e,t,r=et){if(r===et){let o=await Ch(n,e);return await t(o)}let i=new AbortController,a=r.add(()=>i.abort());try{let o=await Ch(n,{...e,signal:i.signal});return await t(o)}finally{a()}}var h7=new X;function Hs(n){let e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/,t=n.match(e);if(t===null)throw new Error(`Invalid URL: ${JSON.stringify(n)}`);return{protocol:t[1],host:t[2],path:t[3]}}function $s(n){return n instanceof qr?n.status===0||n.status===403||n.status===404:!1}var AW=32,MW=3,RW=500,_W=1e4;function K1(n){return Math.min(2**n*RW,_W/2)*(1+Math.random())}async function va(n,e,t,r,i,a,o=et){let l;e:for(let c=0;;){Zk(o),c>1&&await new Promise(d=>setTimeout(d,K1(c-2))),l=await n.get(l,o);t:for(let d=0;;)try{return await si(typeof e=="function"?e(l.credentials):e,i(l.credentials,t),r,o)}catch(p){if(p instanceof qr){if(a(p,l.credentials)==="refresh"){if(++c===MW)throw p;continue e}if(++d===AW)throw p;await new Promise(m=>setTimeout(m,K1(d-1)));continue t}throw p}}}function Sa(n,e,t,r,i=et){return n===void 0?si(e,t,r,i):va(n,e,t,r,(a,o)=>{if(!a.accessToken)return o;let l=new Headers(o.headers);return l.set("Authorization",`${a.tokenType} ${a.accessToken}`),{...o,headers:l}},(a,o)=>{let{status:l}=a;if(l===401)return"refresh";if(l===504||l===503)return"retry";if(l===403&&!o.accessToken)return"refresh";throw a},i)}var Cd="google-brainmaps";function js(n,e,t,r=et){return Sa(e,`${n.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?St:wh,r)}var ba;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(ba||(ba={}));var Th=class{};Th.RPC_ID="brainmaps/VolumeChunkSource";var Lh=class{};Lh.RPC_ID="brainmaps/MultiscaleMeshSource";var kh=class{};kh.RPC_ID="brainmaps/MeshSource";var Eh=class{};Eh.RPC_ID="brainmaps/SkeletonSource";var Dh=class{};Dh.RPC_ID="brainmaps/Annotation";var Ph=class{};Ph.RPC_ID="brainmaps/AnnotationSpatialIndex";var X1="mesh/MeshLayer",Q1="mesh/MultiscaleMeshLayer",Z1="mesh/FragmentSource",eD="mesh/MultiscaleFragmentSource",li;(function(r){r[r.float32=0]="float32",r[r.uint10=1]="uint10",r[r.uint16=2]="uint16"})(li||(li={}));function tD(n,e,t){return n&1|e<<1&2|t<<2&4}var Ih=!1;function VW(n,e,t,r,i,a,o){let{octree:l,lodScales:c,chunkGridSpatialOrigin:d,chunkShape:p}=n,m=c.length-1,y=e[0],v=e[4],b=e[8],x=e[1],C=e[5],L=e[9],A=e[3],D=e[7],R=e[11],P=e[15],E=A>0?0:1,V=D>0?0:1,O=R>0?0:1,B=t[4*4],W=t[4*4+1],_=t[4*4+2],F=t[4*4+3];function N(He,Ke,Pe){return A*He+D*Ke+R*Pe+P}function J(He,Ke,Pe,at,Nn,zi){return N(He+E*(at-He),Ke+V*(Nn-Ke),Pe+O*(zi-Pe))}let re=N(-F*B,-F*W,-F*_),pe=n.clipLowerBound[0],ye=n.clipLowerBound[1],ce=n.clipLowerBound[2],fe=n.clipUpperBound[0],Le=n.clipUpperBound[1],Ge=n.clipUpperBound[2],ze=Math.sqrt((y*i)**2+(x*a)**2),tt=Math.sqrt((v*i)**2+(C*a)**2),ge=Math.sqrt((b*i)**2+(L*a)**2),Te=Math.max(ze,tt,ge);function Fe(He,Ke,Pe){let at=1<<He,Nn=Ke*5,zi=l[Nn],Xe=l[Nn+1],Sr=l[Nn+2],Hi=l[Nn+3],$i=l[Nn+4],ji=zi*at*p[0]+d[0],Ji=Xe*at*p[1]+d[1],Zr=Sr*at*p[2]+d[2],yi=ji+at*p[0],Da=Ji+at*p[1],uo=Zr+at*p[2];if(ji=Math.max(ji,pe),Ji=Math.max(Ji,ye),Zr=Math.max(Zr,ce),yi=Math.min(yi,fe),Da=Math.min(Da,Le),uo=Math.min(uo,Ge),Tf(ji,Ji,Zr,yi,Da,uo,t)){let po=Math.max(re,J(ji,Ji,Zr,yi,Da,uo))/Te;if(Pe===0||po*r<Pe){let Cn=c[He];if(Cn!==0&&o(He,Ke,Cn/po,$i>>>31),He>0&&(Cn===0||po*r<Cn)){let Jc=Cn===0?Pe:Cn,er=($i&2147483647)>>>0;for(let bt=Hi;bt<er;++bt)Fe(He-1,bt,Jc)}}}}Fe(m,l.length/5-1,0)}function xS(n,e,t,r,i,a,o,l){let{lodScales:c}=n,d=0;for(;d+1<c.length&&c[d+1]!==0;)++d;let p=3,m=[],y=0,v=0;function b(L,A){for(Ih&&console.log(`emitChunksUpTo: stackDepth=${y}, targetStackIndex=${L}, subChunkIndex=${A}, priorSubChunkIndex=${v}`);;){if(y===0)return;let D=y-1,R=d-D,P=m[D*p],E=R===0?1:8,V=m[D*p+1],O=m[D*p+2];if(L===y){let B=A&E-1;v!==B&&P!==-1&&(Ih&&console.log(`  drawing chunk because priorSubChunkIndex (${v}) != endSubChunk (${B})`),l(R,P,v,B,O)),v=B+1;return}v!==E&&P!==-1&&l(R,P,v,E,O),v=V+1,--y}}let x=0;Ih&&(console.log(""),console.log("Starting to draw"));let{octree:C}=n;VW(n,e,t,r,i,a,(L,A,D,R)=>{if(!R&&!o(L,A,D)){x=Math.max(L,x);return}if(L<x)return;x=0;let P=A*5,E=C[P],V=C[P+1],O=C[P+2],B=tD(E,V,O),W=d-L;b(W,B);let _=W*p;m[_]=R?-1:A,m[_+1]=B,m[_+2]=D,Ih&&console.log(`Adding to stack: lod=${L}, row=${m[_]}, subChunkIndex=${B}`),v=0,y=W+1}),b(0,0)}function nD(n){if(n.length%5!=0)throw new Error("Invalid length");let e=n.length/5,t=new Set;function r(i){if(t.has(i))throw new Error("Previously seen node");if(t.add(i),i<0||i>=e)throw new Error("Invalid node reference");let a=n[i*5],o=n[i*5+1],l=n[i*5+2],c=n[i*5+3],d=n[i*5+4];if(c<0||d<0||d<c||d>e||c+8<d)throw new Error("Invalid child references");for(let p=c;p<d;++p){let m=n[p*5],y=n[p*5+1],v=n[p*5+2];if(m>>>1!==a||y>>>1!==o||v>>>1!=l)throw new Error("invalid child");r(p)}}if(e!==0&&(r(e-1),t.size!==e))throw new Error("Orphan nodes in octree")}function CS(n,e,t){return`${n}/${e}:${t}`}var Ir=class extends fd{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}};var OW=3432918353,NW=461845907;function fc(n,e){return e>>>=0,n>>>=0,e=Math.imul(e,OW)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,NW)>>>0,n=(n^e)>>>0,n=(n<<13|n>>>19)>>>0,n=n*5+3864292196>>>0,n}var Ah=3,BW=.9,Fo=!1,xa=0,Ca=0,rD=0,iD=0,hc=class{constructor(e=hc.generateHashSeeds(Ah)){this.hashSeeds=e;this.loadFactor=BW;this.size=0;this.emptyLow=4294967295;this.emptyHigh=4294967295;this.maxRehashAttempts=5;this.maxAttempts=5;this.generation=0;this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=hc.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,r=new Array(t);for(let c=0;c<t;++c)r[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:i}=this;if(i===-1){e:for(;;){i=Math.random()*16777216>>>0;for(let c=0;c<t;++c){let d=this.getHash(c,i,i);for(let p=0;p<t;++p)if(r[p]===d)continue e}this.mungedEmptyKey=i;break}}let{table:a,emptyLow:o,emptyHigh:l}=this;for(let c=0;c<t;++c){let d=r[c];a[d]===o&&a[d+1]===l&&(a[d]=i,a[d+1]=i)}try{e(a)}finally{for(let c=0;c<t;++c){let d=r[c];a[d]===i&&a[d+1]===i&&(a[d]=o,a[d+1]=l)}}}static generateHashSeeds(e=Ah){return Dk(new Uint32Array(e))}getHash(e,t,r){let i=this.hashSeeds[e];return i=fc(i,t),i=fc(i,r),this.entryStride*(i&this.tableSize-1)}*keys(e=new X){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this;for(let o=0,l=a.length;o<l;o+=i){let c=a[o],d=a[o+1];(c!==t||d!==r)&&(e.low=c,e.high=d,yield e)}}indexOfPair(e,t){let{table:r,emptyLow:i,emptyHigh:a}=this;if(e===i&&t===a)return-1;for(let o=0,l=this.hashSeeds.length;o<l;++o){let c=this.getHash(o,e,t);if(r[c]===e&&r[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let{emptyLow:e,emptyHigh:t,table:r,entryStride:i}=this,a,o;for(;a=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(a===e&&o===t)&&!this.hasPair(a,o)););this.emptyLow=a,this.emptyHigh=o;for(let l=0,c=r.length;l<c;l+=i)r[l]===e&&r[l+1]===t&&(r[l]=a,r[l+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let{table:r}=this;return r[t]=this.emptyLow,r[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,entryStride:t,emptyLow:r,emptyHigh:i}=this,a=e.length;for(let o=0;o<a;o+=t)e[o]=r,e[o+1]=i}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}swapPending(e,t){let r=xa,i=Ca;this.storePending(e,t),e[t]=r,e[t+1]=i}storePending(e,t){xa=e[t],Ca=e[t+1]}backupPending(){rD=xa,iD=Ca}restorePending(){xa=rD,Ca=iD}tryToInsert(){Fo&&console.log(`tryToInsert: ${xa}, ${Ca}`);let e=0,{emptyLow:t,emptyHigh:r,maxAttempts:i,table:a}=this,o=this.hashSeeds.length,l=Math.floor(Math.random()*o);for(;;){let c=this.getHash(l,xa,Ca);if(this.swapPending(a,c),xa===t&&Ca===r)return!0;if(++e===i)break;l=(l+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){Fo&&console.log("rehash begin"),this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{emptyLow:r,emptyHigh:i,entryStride:a}=this;for(let o=0,l=e.length;o<l;o+=a){let c=e[o],d=e[o+1];if((c!==r||d!==i)&&(this.storePending(e,o),!this.tryToInsert()))return Fo&&console.log("rehash failed"),!1}return Fo&&console.log("rehash end"),!0}grow(e){Fo&&console.log(`grow: ${e}`);let t=this.table,{tableSize:r}=this;for(;r<e;)r*=2;for(;;){for(let i=0;i<this.maxRehashAttempts;++i)if(this.rehash(t,r)){Fo&&console.log("grow end");return}r*=2}}insertInternal(){for(++this.generation,xa===this.emptyLow&&Ca===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}},Mh=class extends hc{add(e){let{low:t,high:r}=e;return this.hasPair(t,r)?!1:(Fo&&console.log(`add: ${t},${r}`),xa=t,Ca=r,this.insertInternal(),!0)}[Symbol.iterator](){return this.keys()}};Mh.prototype.entryStride=2;var wd=0,Td=0,aD=0,oD=0,mc=class extends hc{set(e,t){let{low:r,high:i}=e;return this.hasPair(r,i)?!1:(Fo&&console.log(`add: ${r},${i} -> ${t.low},${t.high}`),xa=r,Ca=i,wd=t.low,Td=t.high,this.insertInternal(),!0)}get(e,t){let r=this.indexOf(e);if(r===-1)return!1;let{table:i}=this;return t.low=i[r+2],t.high=i[r+3],!0}swapPending(e,t){let r=wd,i=Td;super.swapPending(e,t),e[t+2]=r,e[t+3]=i}storePending(e,t){super.storePending(e,t),wd=e[t+2],Td=e[t+3]}backupPending(){super.backupPending(),aD=wd,oD=Td}restorePending(){super.restorePending(),wd=aD,Td=oD}[Symbol.iterator](){return this.entries()}*entries(e=[new X,new X]){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this,[o,l]=e;for(let c=0,d=a.length;c<d;c+=i){let p=a[c],m=a[c+1];(p!==t||m!==r)&&(o.low=p,o.high=m,l.low=a[c+2],l.high=a[c+3],yield e)}}};mc.prototype.entryStride=4;var _i=class{},Js=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],FW=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],Rh=["","r","rg","rgb","rgba"],UW=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],WW=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],GW=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],zW=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],sD=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],HW=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],$W=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function gc(n){return n===z.FLOAT32?"":kf[n]?"i":"u"}function ci(n,e,t=1){switch(e){case z.UINT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=UW[t],n.textureFormat=Js[t],n.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint8Array,n.samplerPrefix="u",n;case z.INT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=WW[t],n.textureFormat=Js[t],n.texelType=WebGL2RenderingContext.BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Int8Array,n.samplerPrefix="i",n;case z.UINT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=GW[t],n.textureFormat=Js[t],n.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint16Array,n.samplerPrefix="u",n;case z.INT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=zW[t],n.textureFormat=Js[t],n.texelType=WebGL2RenderingContext.SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Int16Array,n.samplerPrefix="i",n;case z.UINT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=sD[t],n.textureFormat=Js[t],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case z.INT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=HW[t],n.textureFormat=Js[t],n.texelType=WebGL2RenderingContext.INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Int32Array,n.samplerPrefix="i",n;case z.UINT64:if(t<1||t>2)break;return n.texelsPerElement=1,n.textureInternalFormat=sD[t*2],n.textureFormat=Js[t*2],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=2*t,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case z.FLOAT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=$W[t],n.textureFormat=FW[t],n.texelType=WebGL2RenderingContext.FLOAT,n.arrayElementsPerTexel=t,n.arrayConstructor=Float32Array,n.samplerPrefix="",n}throw new Error(`No supported texture format for ${z[e]}[${t}].`)}function Uo(n,e,t){let{arrayConstructor:r,arrayElementsPerTexel:i,textureInternalFormat:a,textureFormat:o,texelsPerElement:l}=e,{maxTextureSize:c}=n,d=t.length/i;if(d*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+d);let p=Math.ceil(d/c),m=Math.ceil(Math.log2(p)),y=(1<<m)*l,v=Math.ceil(d/(1<<m)),b=y*v*i;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT));let x=MT(t,b);n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),qa(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,y,v,0,o,e.texelType,x)}function lD(n,e,t,r,i){let{arrayConstructor:a,textureInternalFormat:o,textureFormat:l,texelsPerElement:c}=e;t.constructor!==a&&(t=new a(t.buffer,t.byteOffset,t.byteLength/a.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),qa(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,r*c,i,0,l,e.texelType,t)}function cD(n,e,t,r,i,a){let{arrayConstructor:o,textureInternalFormat:l,textureFormat:c,texelsPerElement:d}=e;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),BE(n),n.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,r*d,i,a,0,c,e.texelType,t)}function jW(n){switch(n){case z.UINT8:return tS;case z.INT8:return nS;case z.UINT16:return rS;case z.INT16:return iS;case z.UINT32:return Os;case z.INT32:return aS;case z.UINT64:return Et;case z.FLOAT32:return lh}}function uD(n,e,t,r,i,a){let o=At(i,a),l=[jW(i)],c=`
${o} ${n}(${r} index) {
`;switch(i){case z.UINT8:case z.UINT16:case z.UINT32:c+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Rh[a]};
  return result;
`;break;case z.INT8:case z.INT16:case z.INT32:c+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Rh[a]};
  return result;
`;break;case z.UINT64:l.push(qE),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${Rh[a*2]});
`;break;case z.FLOAT32:l.push(lh),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${Rh[a]};
`;break}return c+=`
}
`,l.push(c),l}var Za=class{constructor(e){this.key=e;this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let r=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let i=0;i<e;++i)r+=`, out ${t}vec4 output${i}`;r+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let i=0;i<e;++i)r+=`
  output${i} = texelFetch(sampler, ivec2(x + ${i}, y), 0);
`;return r+=`
}
`,[ZE,r]}getAccessor(e,t,r,i=1){let a=gc(r);return[this.getReadTextureValueCode(1,a),...uD(e,this.readTextureValue,t,"highp uint",r,i)]}},wS=class{constructor(e,t){this.key=e;this.textureDims=t;this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){let{textureDims:r}=this,i=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${r} p`;for(let a=0;a<e;++a)i+=`, out ${t}vec4 output${a}`;i+=`) {
`;for(let a=0;a<e;++a)i+=`
  output${a} = texelFetch(sampler, ivec${r}(p.x * ${e} + ${a}, p.y
                                         ${r===3?", p.z":""}), 0);
`;return i+=`
}
`,i}getAccessor(e,t,r,i=1){let a=gc(r);return[this.getReadTextureValueCode(1,a),...uD(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,r,i)]}};var TS=[Et,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],JW=ci(new _i,z.UINT64,1),qs=class extends ${constructor(e,t){super();this.gl=e;this.hashTable=t;this.generation=-1;this.texture=null;this.texture=e.createTexture()}copyToGPU(){let{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;let{gl:r,texture:i}=this;this.generation=t,r.activeTexture(WebGL2RenderingContext.TEXTURE0+r.tempTextureUnit),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),e.tableWithMungedEmptyKey(a=>{Uo(this.gl,JW,a)}),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){let{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}},_h=class{constructor(e,t=Ah){this.prefix=e;this.numAlternatives=t;this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`);this.accessHelper=new Za(`gpuhashtable_${this.prefix}`);this.samplerName=this.prefix+"_sampler";this.hashSeedsName=this.prefix+"_seeds";this.hashKeyMask=this.prefix+"_keyMask";this.readTable=this.prefix+"_readTable"}defineShader(e){let{hashSeedsName:t,samplerName:r,numAlternatives:i,hashKeyMask:a}=this;e.addUniform("highp uint",t,i),e.addUniform("highp uint",a),e.addTextureSampler("usampler2D",r,this.textureUnitSymbol),e.addFragmentCode(TS),e.addFragmentCode(Et),e.addFragmentCode(sh),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,z.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<i;++l)o+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${a};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,r){r.copyToGPU();let i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r.texture),e.uniform1ui(t.uniform(this.hashKeyMask),r.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),r.hashTable.hashSeeds)}disable(e,t){let r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}},Ld=class extends _h{defineShader(e){super.defineShader(e);let{numAlternatives:t,hashSeedsName:r,hashKeyMask:i}=this,a=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)a+=`
  {
    uint h = hashCombine(${r}[${o}], x) & ${i};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;a+=`
  return false;
}
`,e.addFragmentCode(a)}get getFunctionName(){return`${this.prefix}_get`}};function Ys(n,e,t,r){e*=6;let i=Math.floor(e),a=e-i,o=r*(1-t),l=r*(1-t*a),c=r*(1-t*(1-a));switch(i%6){case 0:n[0]=r,n[1]=c,n[2]=o;break;case 1:n[0]=l,n[1]=r,n[2]=o;break;case 2:n[0]=o,n[1]=r,n[2]=c;break;case 3:n[0]=o,n[1]=l,n[2]=r;break;case 4:n[0]=c,n[1]=o,n[2]=r;break;case 5:n[0]=r,n[1]=o,n[2]=l;break}return n}function dD(n,e,t,r){let i=Math.max(Math.max(e,t),r),a=Math.min(Math.min(e,t),r);if(n[2]=i,a===i)n[0]=0,n[1]=0;else{let o=i-a;n[1]=o/i,e===i?n[0]=(t-r)/o:t===i?n[0]=2+(r-e)/o:n[0]=4+(e-t)/o,n[0]/=6,n[0]<0&&(n[0]+=1),n[0]>1&&(n[0]-=1)}return n}var pD=2,LS=class{constructor(e){this.prefix=e;this.seedName=this.prefix+"_seed"}defineShader(e){let{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(Et),e.addFragmentCode(TS),e.addFragmentCode(JE);let r=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${pD} v;
`;for(let i=0;i<pD;++i)r+=`
  v[${i}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;r+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(r)}enable(e,t,r){e.uniform1ui(t.uniform(this.seedName),r)}},fD=new Float32Array(3);function kS(n){return`rgb(${n[0]*100}%,${n[1]*100}%,${n[2]*100}%)`}var kd=class{constructor(e=cv()){this.hashSeed=e;this.changed=new ae}static getDefault(){return new kd(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let r=fc(this.hashSeed,t.low);r=fc(r,t.high);let i=(r&255)/255,a=(r>>8&255)/255;return Ys(e,i,.5+.5*a,1),e}computeCssColor(e){return this.compute(fD,e),kS(fD)}randomize(){this.hashSeed=cv(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){let t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}},ES=class{constructor(e){this.prefix=e;this.hashMapShaderManager=new Ld("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec3 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,r){this.hashMapShaderManager.enable(e,t,r)}disable(e,t){this.hashMapShaderManager.disable(e,t)}};var Vh='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowLeftIconTitle"><path d="M9 6l-6 6 6 6"></path><path d="M21 12H4"></path><path stroke-linecap="round" d="M3 12h1"></path></svg>';var Oh='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowRightIconTitle"><path d="M15 18l6-6-6-6"></path><path d="M3 12h17"></path><path stroke-linecap="round" d="M21 12h-1"></path></svg>';var DS=class{constructor(e){this.parents=new Array;this.parentPriorities=new Array;this.bindings=new Map;if(e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(let[t,r]of e.bindings)this.bindings.set(t,r)}}addParent(e,t){let{parents:r,parentPriorities:i}=this,a=0,{length:o}=r;for(;a<o&&t<i[a];)++a;return r.splice(a,0,e),i.splice(a,0,t),()=>{this.removeParent(e)}}removeParent(e){let t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;++a)if(o=t[a].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;a<i;++a)if(o=t[a].get(e),o!==void 0)return o}*getAll(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;)o=t[a].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);a<i;)o=t[a].get(e),o!==void 0&&(yield o)}*entries(){let{parents:e,parentPriorities:t}=this,r=t.length,i=0;for(;i<r&&t[i]>0;++i)yield*e[i].entries();for(yield*this.bindings.entries();i<r;++i)yield*e[i].entries()}};var Pt;(function(i){i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT"})(Pt||(Pt={}));function qW(n){return(n.ctrlKey?1:0)|(n.altKey?2:0)|(n.metaKey?4:0)|(n.shiftKey?8:0)}function PS(n,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=n,t}function YW(n,e,t){let r="";return e&1&&(r+="control+"),t&1&&(r+="control?+"),e&2&&(r+="alt+"),t&2&&(r+="alt?+"),e&4&&(r+="meta+"),t&4&&(r+="meta?+"),e&8&&(r+="shift+"),t&8&&(r+="shift?+"),r+=n,r}function hD(n){let e=n.indexOf(":"),t;if(e!==-1&&(t=n.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${JSON.stringify(t)}`);let r=n.substring(e+1).split("+"),i,a=0,o=0;e:for(let l of r)switch(l){case"control":a|=1;break;case"control?":o|=1;break;case"alt":a|=2;break;case"alt?":o|=2;break;case"meta":a|=4;break;case"meta?":o|=4;break;case"shift":a|=8;break;case"shift?":o|=8;break;default:if(i===void 0)i=l;else{i=void 0;break e}}if(i===void 0||a&o)throw new Error(`Invalid event identifier: ${JSON.stringify(n)}`);return{phase:t,keyName:i,modifiers:a,optionalModifiers:o}}function*KW(n,e,t){t===0&&(yield PS(n,e));for(let r=0;r<16;++r)(r&(e|t))===r&&(r&e)===e&&(yield PS(n,r))}function*mD(n){let{phase:e}=n,t=KW(n.keyName,n.modifiers,n.optionalModifiers);if(e===void 0)for(let r of t)yield`at:${r}`,yield`bubble:${r}`;else for(let r of t)yield`${e}:${r}`}function XW(n,e){let t=YW(n.keyName,n.modifiers,n.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:{...e,originalEventIdentifier:t}}var _e=class extends DS{static fromObject(e,t={}){let r=new _e;if(r.label=t.label,t.parents!==void 0)for(let[i,a]of t.parents)r.addParent(i,a);for(let i of Object.keys(e))r.set(i,e[i]);return r}setFromObject(e){for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){let r=hD(e),i=XW(r,t);for(let a of mD(r))super.set(a,i)}delete(e){for(let t of mD(hD(e)))super.delete(t)}describe(){let e=[],t=new Map;for(let[,r]of this.entries())t.set(r.originalEventIdentifier,r.action);for(let[r,i]of t)e.push(`${r}\u2192${i}`);return e.join(", ")}};function IS(n,e,t){if(t===void 0)return;t.stopPropagation!==!1&&n.stopPropagation();let r=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),i=!n.target.dispatchEvent(r);(t.preventDefault!==!1||i)&&n.preventDefault()}var Nh=[];Nh[Event.AT_TARGET]="at";Nh[Event.CAPTURING_PHASE]="capture";Nh[Event.BUBBLING_PHASE]="bubble";function AS(n,e,t,r,i){let a=Nh[t]+":"+n,o=i.get(a);IS(e,r,o)}function Bh(n,e,t,r){AS(PS(n,qW(e)),e,e.eventPhase,t,r)}function le(n,e,t,r){return bn(n,`action:${e}`,t,r)}var MS;function QW(){if(MS===void 0){let n=new _e;n.set("keyl","recolor"),n.set("keyx","clear-segments"),n.set("keys","toggle-show-slices"),n.set("keyb","toggle-scale-bar"),n.set("keyv","toggle-default-annotations"),n.set("keya","toggle-axis-lines"),n.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)n.set("digit"+e,"toggle-layer-"+e),n.set("control+digit"+e,"select-layer-"+e),n.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){let t=String.fromCharCode(97+e),r=String.fromCharCode(65+e);n.set(`shift+key${t}`,`tool-${r}`)}n.set("keyn","add-layer"),n.set("keyh","help"),n.set("space","toggle-layout"),n.set("shift+space","toggle-layout-alternative"),n.set("backslash","toggle-show-statistics"),MS=n}return MS}var RS;function yc(){return RS===void 0&&(RS=_e.fromObject({"control+mousedown2":"select-position"})),RS}var _S;function gD(){return _S===void 0&&(_S=_e.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[yc(),0]]})),_S}var VS;function yD(){return VS===void 0&&(VS=_e.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[yc(),0]]})),VS}var OS;function ZW(){return OS===void 0&&(OS=_e.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[yD(),Number.NEGATIVE_INFINITY]]})),OS}var NS;function eG(){return NS===void 0&&(NS=_e.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[yD(),Number.NEGATIVE_INFINITY]]})),NS}function vD(n){n.global.addParent(QW(),Number.NEGATIVE_INFINITY),n.sliceView.addParent(eG(),Number.NEGATIVE_INFINITY),n.perspectiveView.addParent(ZW(),Number.NEGATIVE_INFINITY)}function Me(n){for(;;){let e=n.firstChild;if(!e)break;n.removeChild(e)}}function Ye(n){let{parentElement:e}=n;return e?(e.removeChild(n),!0):!1}function gn(n,e=Math.max(1,n.value.length)){let t=`${e}ch`;n.style.width!==t&&(n.style.width="0px",n.offsetWidth,n.style.width=t)}function In(n,e){let t=n.firstElementChild;for(let r of e)r!==t&&n.insertBefore(r,t),t=r.nextElementSibling;for(;t!==null;){let r=t.nextElementSibling;n.removeChild(t),t=r}}function Ed(n){return n instanceof HTMLElement?!!(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n.isContentEditable):!1}function SD(n){let e=n.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}var vc,Dd=[];function tG(){if(vc===void 0){let n=vc=document.createElement("div");n.classList.add("neuroglancer-drag-status"),document.body.appendChild(n)}return vc}function nG(){vc!==void 0&&(Me(vc),vc.style.display="none")}function bD(n){let e=tG();Me(e),typeof n=="string"?e.appendChild(document.createTextNode(n)):e.appendChild(n()),e.style.display=""}function xD(n,e){uf(Dd,t=>!(t.target===n&&t.operation===e))}function mr(n,e,t){xD(n,e),Dd.push({target:n,operation:e,status:t}),bD(t)}function Xt(n,e){xD(n,e);let t=Dd.length===0?void 0:Dd[Dd.length-1];t===void 0?nG():bD(t.status)}var rG=300,iG=100,ui={side:"right",col:0,row:Infinity,flex:1,size:rG,minSize:iG,visible:!1},Jn=class{constructor(e=ui,t=e){this.defaultValue=e;this.value=t;this.changed=new We;this.locationChanged=new We;this.locationChanged.add(this.changed.dispatch);let r=this;this.watchableVisible={get value(){return r.visible},set value(i){r.visible=i},changed:r.locationChanged}}toJSON(e=this.defaultValue){let t={},{value:r}=this;for(let i in r)r[i]!==e[i]&&(t[i]=r[i]);return t}get visible(){return this.value.visible}set visible(e){let{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;Z(e);let r={side:de(e,"side",i=>{if(i!=="left"&&i!=="right"&&i!=="top"&&i!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(i)}`);return i},t.side),col:de(e,"col",Ze,t.col),row:de(e,"row",Ze,t.row),flex:de(e,"flex",Ze,t.flex),size:de(e,"size",Rt,t.size),visible:de(e,"visible",aa,t.visible),minSize:t.minSize};this.value=r,this.locationChanged.dispatch()}};function An(n,e,t){let{document:r}=n.view,i=n.clientX,a=n.clientY,o=p=>{let m=p.clientX-i,y=p.clientY-a;i=p.clientX,a=p.clientY,e(p,m,y)},l=n.button,c=p=>{r.removeEventListener("pointermove",o,!0),r.removeEventListener("pointerup",d,!1),t!==void 0&&t(p,p.clientX-i,p.clientY-a)},d=p=>{p.button===l&&c(p)};r.addEventListener("pointermove",o,!0),r.addEventListener("pointerup",d,!1),r.addEventListener("pointercancel",c,!1)}var CD='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="closeIconTitle"><path d="M6.34314575 6.34314575L17.6568542 17.6568542M6.34314575 17.6568542L17.6568542 6.34314575"></path></svg>';function je(n){let{title:e,onClick:t,href:r}=n,i;r!==void 0?(i=document.createElement("a"),i.href=r,i.target="_blank"):i=document.createElement("div"),e!==void 0&&(i.title=e),t!==void 0&&i.addEventListener("click",t);let{svg:a}=n;return i.className="neuroglancer-icon",a!==void 0&&(i.innerHTML=a),n.text!==void 0&&i.appendChild(document.createTextNode(n.text)),i}function Fh(n={}){return je({svg:CD,...n})}var Ks="neuroglancer-drag-over",wD={row:"row",column:"col"},aG={left:"right",right:"left",top:"bottom",bottom:"top"},Wo={left:"column",right:"column",top:"row",bottom:"row"},Uh={left:"row",right:"row",top:"column",bottom:"column"},Sc={row:"width",column:"height"},TD={row:"left",column:"top"},oG={row:"right",column:"bottom"},LD={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},Wh={left:-1,right:1,top:-1,bottom:1},Ar=class extends ${constructor(e,t=new Jn){super();this.sidePanelManager=e;this.location=t;this.element=document.createElement("div");this.visibility=new kt(kt.VISIBLE);let{element:r}=this;r.classList.add("neuroglancer-side-panel"),r.draggable=!0,r.addEventListener("dragstart",i=>{this.sidePanelManager.startDrag(this.makeDragSource(),i),r.style.backgroundColor="black",setTimeout(()=>{r.style.backgroundColor=""},0),mr(r,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),r.addEventListener("dragend",i=>{this.sidePanelManager.endDrag(),Xt(r,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{let t=this.location.value;this.location.value={...t,...e},this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){let t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");let{title:r}=e,i;r!==void 0&&(i=document.createElement("div"),i.classList.add("neuroglancer-side-panel-title"),i.textContent=r,t.appendChild(i));let a=Fh({title:"Close panel",onClick:()=>{this.close()}});return a.style.order="100",t.appendChild(a),this.element.appendChild(t),{titleBar:t,titleElement:i,closeButton:a}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}},BS=class extends ${constructor(e,t,r=new kt(kt.VISIBLE)){super();this.display=e;this.center=t;this.visibility=r;this.element=document.createElement("div");this.centerColumn=document.createElement("div");this.beforeRender=new We;this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")};this.registeredPanels=new Set;this.layoutNeedsUpdate=!1;this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};let{element:i,centerColumn:a}=this;i.style.display="flex",i.style.flex="1",i.style.flexDirection="row",a.style.display="flex",a.style.flex="1",a.style.flexDirection="column",a.style.flexBasis="0px",a.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),!!this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,Wh[e]*Infinity,0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,r,i,a=!1){let o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";let l=10,c=Wo[i],d=Uh[i];return o.style[Sc[d]]=`${l}px`,o.style[Sc[c]]="100%",a?(o.style.position="absolute",o.style[i]="50%",o.style[LD[i]]="-${size/2}px"):(o.style.position="relative",o.style[LD[aG[i]]]=`-${l}px`),o.addEventListener("dragenter",p=>{!this.hasDroppablePanel()||(o.classList.add(Ks),p.preventDefault(),mr(o,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),o.addEventListener("dragleave",()=>{Xt(o,"drop"),o.classList.remove(Ks)}),o.addEventListener("dragover",p=>{!this.hasDroppablePanel()||p.preventDefault()}),o.addEventListener("drop",p=>{let{dragSource:m}=this;if(m===void 0)return;Xt(o,"drop"),o.classList.remove(Ks);let y=Wo[e];m.dropAsNewPanel({side:e,row:y==="column"?r:t,col:y==="row"?r:t}),this.dragSource=void 0,p.preventDefault(),p.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)==null||t.dispose(),this.invalidateLayout()}disposed(){for(let{panel:e}of this.registeredPanels)e==null||e.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;let e={left:[],right:[],top:[],bottom:[]};for(let o of this.registeredPanels)e[o.location.value.side].push(o);let t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),r=this;function*i(){yield r.sides.left.outerDropZoneElement,yield*t("left"),yield r.centerColumn,yield*t("right"),yield r.sides.right.outerDropZoneElement}In(this.element,i());function*a(){yield r.sides.top.outerDropZoneElement,yield*t("top"),yield r.center,yield*t("bottom"),yield r.sides.bottom.outerDropZoneElement}In(this.centerColumn,a())}makeCrossGutter(e,t){let r=document.createElement("div");r.style.position="relative";let i=Uh[e];r.className=`neuroglancer-resize-gutter-${i==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();let l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let d=l.element.getBoundingClientRect()[Sc[i]],p=l.minSize,m=()=>{mr(r,"drag",`Drag to resize, current ${Sc[i]} is ${l.crossSize}px`)};m(),An(o,(y,v,b)=>{let x=i==="row"?v:b;d-=Wh[e]*x,l.crossSize=Math.max(p,Math.round(d)),m(),this.invalidateLayout()},()=>{Xt(r,"drag")})});let a=this.makeDropZone(e,t-Wh[e]*.5,0,e,!0);return r.appendChild(a),r}makeFlexGutter(e,t,r){let i=document.createElement("div");i.style.position="relative";let a=Wo[e];i.className=`neuroglancer-resize-gutter-${a==="row"?"horizontal":"vertical"}`,i.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();let c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;let{cells:d}=c,p=d[r];if(p===void 0||!p.registeredPanel.location.visible)return;let m=r+1;for(;m<d.length&&!d[m].registeredPanel.location.visible;)++m;if(m===d.length)return;let y=d[m],v=()=>{mr(i,"drag",`Drag to resize, current ${Sc[a]} ratio is ${p.registeredPanel.location.value.flex} : ${y.registeredPanel.location.value.flex}`)};v(),An(l,b=>{let x=p.registeredPanel.panel,C=y.registeredPanel.panel;if(x===void 0||C===void 0)return;let L=x.element.getBoundingClientRect(),A=C.element.getBoundingClientRect(),D=Math.max(.1,Math.min(.9,a==="column"?(b.clientY-L.top)/(A.bottom-L.top):(b.clientX-L.left)/(A.right-L.left))),R=p.registeredPanel.location.value,P=y.registeredPanel.location.value,E=R.flex+P.flex;p.registeredPanel.location.value={...R,flex:Math.round(D*E*100)/100},y.registeredPanel.location.value={...P,flex:Math.round((1-D)*E*100)/100},v(),p.registeredPanel.location.locationChanged.dispatch(),y.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{Xt(i,"drag")})});let o=this.makeDropZone(e,t,r+.5,TD[Wo[e]],!0);return i.appendChild(o),i}renderSide(e,t,r){let i=wD[Uh[e]],a=wD[Wo[e]];r.sort((c,d)=>{let p=c.location.value,m=d.location.value,y=p[a]-m[a];return y!==0?y:p[i]-m[i]});let o=this;function*l(){let c=0,d=r.length,p=0;for(;c<d;){let m=r[c].location.value[a],y=c,v=0,b=0;do{let A=r[y].location.value;if(A[a]!==m)break;A.visible&&(++v,b=Math.max(b,A.minSize)),++y}while(y<d);let x=v>0,C=t[p];if(C===void 0){let A=o.makeCrossGutter(e,p),D=document.createElement("div");D.className=`neuroglancer-side-panel-${Wo[e]}`,C=t[p]={element:D,gutterElement:A,cells:[],crossSize:-1,minSize:b,visible:x,beginDropZone:o.makeDropZone(e,p,-Infinity,TD[Wo[e]]),endDropZone:o.makeDropZone(e,p,Infinity,oG[Wo[e]])}}else C.visible=x,C.minSize=b,C.crossSize=Math.max(C.crossSize,b);function*L(){yield C.beginDropZone;let A=0;for(let D=c,R=0;D<y;++D,++R){let P=r[D],E=C.cells[R];E===void 0?E=C.cells[R]={registeredPanel:P,gutterElement:void 0}:E.registeredPanel=P;let V=E.registeredPanel.location.value;C.crossSize==-1&&(C.crossSize=Math.max(b,V.size)),(V[a]!==p||V[i]!==R||V.visible&&V.size!==C.crossSize)&&(E.registeredPanel.location.value={...V,[a]:p,[i]:R,size:V.visible?C.crossSize:V.size},E.registeredPanel.location.changed.dispatch());let O=V.visible&&o.visibility.visible,{panel:B}=P;if(!O){B!==void 0&&(B.dispose(),P.panel=void 0);continue}++A,B===void 0&&(B=P.panel=P.makePanel()),B.element.style.flex=v>1?`${V.flex}`:"1",yield B.element,A===v?E.gutterElement=void 0:(E.gutterElement===void 0&&(E.gutterElement=o.makeFlexGutter(e,p,R)),yield E.gutterElement)}yield C.endDropZone}In(C.element,L()),C.cells.length=y-c,x&&(C.element.style[Sc[Uh[e]]]=`${C.crossSize}px`,Wh[e]>0?(yield C.gutterElement,yield C.element):(yield C.element,yield C.gutterElement)),c=y,++p}t.length=p}return l()}};function gr(n,e="text/plain"){let t=!1,r=bn(document,"copy",i=>{let{clipboardData:a}=i;a!==null&&(a.setData(e,n),t=!0),i.stopPropagation(),i.preventDefault()},!0);try{document.execCommand("copy")}finally{r()}return t}var yn=class extends ${constructor(e,t,r){super();this.target=e;this.eventMap=t;this.registerEventListener(e,"wheel",i=>{r!==void 0&&r(i),this.dispatch("wheel",i)}),this.registerEventListener(e,"click",i=>{r!==void 0&&r(i),this.dispatch(`click${i.button}`,i)}),this.registerEventListener(e,"dblclick",i=>{r!==void 0&&r(i),this.dispatch(`dblclick${i.button}`,i)}),this.registerEventListener(e,"mousedown",i=>{r!==void 0&&r(i),this.dispatch(`mousedown${i.button}`,i)}),this.registerEventListener(e,"mouseup",i=>{r!==void 0&&r(i),this.dispatch(`mouseup${i.button}`,i)})}dispatch(e,t){Bh(e,t,t,this.eventMap)}};var qn=class extends ${constructor(e,t){super();this.element=je({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");let r=()=>{let i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(r)),r()}};var kD='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="copyIconTitle"><rect width="12" height="14" x="8" y="7"></rect><polyline points="16 3 4 3 4 17"></polyline></svg>';function yr(n={}){return je({svg:kD,...n})}var ED=class extends ${constructor(e){super();this.redraw=e}},Mn=class extends ${constructor(e,t,r=new kt(kt.VISIBLE)){super();this.model=e;this.render=t;this.visibility=r;this.element=document.createElement("div");this.generation=-1;this.currentViewDisposer=void 0;this.debouncedUpdateView=this.registerCancellable(Be(()=>this.updateView()));this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(r.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;let{model:e}=this;if(e.changed.count===this.generation)return;this.disposeCurrentView();let r=this.currentViewDisposer=new ED(this.debouncedUpdateView);this.render(e.value,this.element,r)}disposeCurrentView(){let{currentViewDisposer:e}=this;e!==void 0&&e.dispose(),Me(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}};function Gh(n={}){return je({text:"\u2197",...n})}function FS(n){return n.closest(".neuroglancer-selection-details")}var US=class extends Ar{constructor(e,t,r,i){super(e,t.location);this.sidePanelManager=e;this.state=t;this.manager=r;this.selectedLayer=i;this.body=document.createElement("div");let{element:a,body:o}=this;a.classList.add("neuroglancer-selection-details"),this.registerDisposer(new yn(this.element,yc()));let{titleBar:l}=this.addTitleBar({title:"Selection"}),c=je({svg:Vh,title:"Previous selection",onClick:()=>{this.state.goBack()}}),d=je({svg:Oh,title:"Next selection",onClick:()=>{this.state.goForward()}});l.appendChild(c),l.appendChild(d),l.appendChild(this.registerDisposer(new qn(t.pin,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new Mn(t,(p,m,y)=>{if(!t.location.visible||(c.style.visibility=t.canGoBack()?"visible":"hidden",d.style.visibility=t.canGoForward()?"visible":"hidden",p===void 0))return;let{position:v}=p;if(v!==void 0){let b=document.createElement("div");b.classList.add("neuroglancer-selection-details-position");let x=yr({title:"Copy position",onClick:()=>{gr(A.map(R=>Math.floor(R)).join(", "))}});b.appendChild(x);let{coordinateSpace:{rank:C,names:L},position:A}=p;for(let R=0;R<C;++R){let P=document.createElement("span");P.classList.add("neuroglancer-selection-details-position-dimension");let E=document.createElement("span");E.classList.add("neuroglancer-selection-details-position-dimension-name"),E.textContent=L[R];let V=document.createElement("span");V.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),V.textContent=Math.floor(A[R]).toString(),P.appendChild(E),P.appendChild(V),b.appendChild(P)}let D=Gh({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=A}});b.appendChild(D),m.appendChild(b)}for(let b of p.layers){let{layer:x}=b;m.appendChild(y.registerDisposer(new Mn({value:void 0,changed:x.managedLayer.layerChanged},(C,L,A)=>{if(x.wasDisposed||!x.isReady)return;let D=document.createElement("div");if(D.classList.add("neuroglancer-selection-details-layer-body"),!x.displaySelectionState(b.state,D,A))return;let R=document.createElement("div");L.appendChild(R),R.classList.add("neuroglancer-selection-details-layer");let P=document.createElement("div");P.classList.add("neuroglancer-selection-details-layer-title"),P.textContent=x.managedLayer.name,P.addEventListener("click",()=>{this.selectedLayer.layer=x.managedLayer,this.selectedLayer.visible=!0}),P.title="Click to show layer side panel",R.appendChild(P),R.appendChild(D)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}};var DD='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="filterIconTitle"><path d="M10 12.261L4.028 3.972h16L14 12.329V17l-4 3z"></path></svg>';function PD(n={}){return je({svg:DD,...n})}var Vi=class{constructor(e,t,r){this.key=e;this.value=t;this.label=r}toString(){let{key:e,value:t,label:r}=this,i;return t===void 0?i=`${e}`:i=`${e}\u2192${t}`,r===void 0?i:`${i} ${r}`}},WS=class extends ${constructor(){super(...arguments);this.selectedSegment=new X;this.baseSelectedSegment=new X;this.hasSelectedSegment=!1;this.changed=new ae}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){let{selectedSegment:r,baseSelectedSegment:i}=this,a=0,o=0,l=0,c=0,d;if(e==null)d=!1;else if(typeof e=="number")a=l=e>>>0,o=c=e<0?4294967295:0,d=!0;else if(e instanceof Vi){let p=e.value||e.key;a=p.low,o=p.high,l=e.key.low,c=e.key.high,d=!0}else e instanceof X?(a=l=e.low,o=c=e.high,d=!0):d=!1;t&&a===0&&o===0&&(d=!1),d?d&&(!this.hasSelectedSegment||r.low!==a||r.high!==o||i.low!==l||i.high!==c)&&(r.low=a,r.high=o,i.low=l,i.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&X.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{let r=e.get(t),i;r!==void 0&&(i=r.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}};function Pd(n){n.useTemporarySegmentEquivalences.value=!1,n.useTemporaryVisibleSegments.value=!1,n.temporaryVisibleSegments.clear(),n.temporarySegmentEquivalences.clear()}function GS(n,e,t=!1){let r,i,a,o;if(typeof e=="number"?r=new X(e>>>0,e<0?4294967295:0):typeof e=="string"?r=X.parseString(e):r=t?e.clone():e,n==null)return r;let{segmentEquivalences:l,segmentPropertyMap:{value:c}}=n.segmentationGroupState.value;return l.size!==0?(i=l.get(r),X.equal(i,r)?a=void 0:a=i):i=r,o=c==null?void 0:c.getSegmentLabel(i),o===void 0&&a==null?r:new Vi(r,a,o)}function Go(n,e){if(e instanceof Vi)return e;let t=GS(n,e);return t instanceof X?new Vi(t):t}function ID(n,e){let{length:t}=e;n.value<t&&(n.value=t)}function zo(n,e){return Fr(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),n.segmentationGroupState.value.maxIdLength)}var zS=(()=>{let n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry");let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),n.appendChild(e);let t=yr({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");let r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");let i=r.childElementCount;r.appendChild(t);let a=e.childElementCount;e.appendChild(r);let o=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);let c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");let d=e.childElementCount;e.appendChild(c);let p=document.createElement("div");p.classList.add("neuroglancer-segment-list-entry-id");let m=c.childElementCount;c.appendChild(p);let y=document.createElement("span");y.classList.add("neuroglancer-segment-list-entry-name");let v=n.childElementCount;n.appendChild(y);let b=PD({title:"Filter by label"});b.classList.add("neuroglancer-segment-list-entry-filter");let x=n.childElementCount;return n.appendChild(b),{template:n,copyContainerIndex:a,copyIndex:i,visibleIndex:o,idContainerIndex:d,idIndex:m,labelIndex:v,filterIndex:x,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),sG=(()=>{let n=zS,e=n.template.cloneNode(!0),t=e.children[0],r=t.children[n.idContainerIndex],i=r.childElementCount,a=r.children[n.idIndex].cloneNode(!0);a.classList.add("neuroglancer-segment-list-entry-unmapped-id"),r.appendChild(a);let o=t.children[n.copyContainerIndex],l=o.childElementCount;return o.appendChild(o.children[n.copyIndex].cloneNode(!0)),{...n,template:e,unmappedIdIndex:i,unmappedCopyIndex:l}})();function lG(n){let e=zS,t=e.template.cloneNode(!0),r=[];for(let i=0;i<n;++i){r.push(t.childElementCount);let a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry-extra-property"),a.style.width=`max(var(--neuroglancer-column-${i}-width), var(--neuroglancer-column-${i}-label-width))`,t.appendChild(a)}return{...e,template:t,numericalPropertyIndices:r}}var AD=new WeakMap;function cG(n){let e=p=>{let m=p.currentTarget,y=m.dataset.id,v=Oi;v.tryParseString(y),n.segmentSelectionState.set(v),FS(m)||n.selectSegment(v,!1)},t=p=>{let m=p.currentTarget,y=m.dataset.id,v=Oi;v.tryParseString(y),n.selectSegment(v,FS(m)?"toggle":!0)},r=()=>{n.segmentSelectionState.set(null)},i=p=>p.currentTarget.closest(".neuroglancer-segment-list-entry"),a=p=>{let m=i(p);gr(m.dataset.id),p.stopPropagation()},o=p=>{let m=i(p);gr(m.dataset.unmappedId),p.stopPropagation()},l=p=>{let y=i(p).dataset.id,v=Oi;v.tryParseString(y);let{visibleSegments:b}=n.segmentationGroupState.value;b.set(v,!b.has(v)),p.stopPropagation()},c=p=>{let y=i(p).dataset.id,v=Oi;v.tryParseString(y),n.filterBySegmentLabel(v),p.stopPropagation()},d=p=>{if(p.button!==2||p.ctrlKey||p.altKey||p.metaKey||p.shiftKey)return;let y=p.currentTarget.dataset.id,v=Oi;v.tryParseString(y),n.moveToSegment(v)};return(p,m)=>{let{children:y}=p,v=y[0].children;p.addEventListener("mousedown",d);let b=v[m.copyContainerIndex];m.unmappedCopyIndex!==-1&&b.children[m.unmappedCopyIndex].addEventListener("click",o),b.children[m.copyIndex].addEventListener("click",a),p.addEventListener("mouseenter",e),p.addEventListener("mouseleave",r),v[m.visibleIndex].addEventListener("click",l),y[m.filterIndex].addEventListener("click",c),p.addEventListener("action:select-position",t)}}var Xs=class{constructor(e,t){this.displayState=e;this.template=t;if(e!==void 0){let r=AD.get(e);r===void 0&&(r=cG(e),AD.set(e,r)),this.registerEventHandlers=r}}static make(e,t){return new Xs(e,t?sG:zS)}get(e){let{displayState:t}=this;return this.getWithNormalizedId(Go(t,e))}getWithNormalizedId(e){var y,v;let{displayState:t}=this,{template:r}=this,i=r.template.cloneNode(!0),a=e.key,o=(y=e.value)!=null?y:a,l=o.toString();i.dataset.id=l;let{children:c}=i,d=c[0].children,p=d[r.idContainerIndex];p.children[r.idIndex].textContent=l;let{unmappedIdIndex:m}=r;if(t!==void 0?this.registerEventHandlers(i,r):d[r.visibleIndex].style.display="none",m!==-1){let b=p.children[m];if(X.equal(a,o)){b.style.display="none";let x=d[r.copyContainerIndex];x.children[r.unmappedCopyIndex].style.display="none"}else{let x=a.toString();i.dataset.unmappedId=x,b.textContent=x,t!==void 0&&ID(t.segmentationGroupState.value.maxIdLength,x)}}return c[r.labelIndex].textContent=(v=e.label)!=null?v:"",t!==void 0&&(this.updateWithId(i,o),ID(t.segmentationGroupState.value.maxIdLength,l)),i}update(e){let t=Oi,r=e.dataset.id;r!==void 0&&(t.parseString(r),this.updateWithId(e,t))}updateWithId(e,t){let{children:r}=e,i=r[0].children,{template:a}=this,{displayState:o}=this,{segmentSelectionState:l}=o,{visibleSegments:c}=o.segmentationGroupState.value;i[a.visibleIndex].checked=c.has(t),e.dataset.selected=(l.hasSelectedSegment&&X.equal(l.selectedSegment,t)).toString();let d=i[a.idContainerIndex];MD(d.children[a.idIndex],jS(this.displayState,t));let{unmappedIdIndex:p}=a;if(p!==-1){let m,y;if(o.baseSegmentColoring.value&&(m=e.dataset.unmappedId)!==void 0){let v=Oi;v.parseString(m),y=jS(this.displayState,v)}else y=Cf;MD(d.children[p],y)}}};function MD(n,e){n.style.backgroundColor=kS(e),n.style.color=Gu(e)?"white":"black"}var HS=class extends Xs{constructor(e,t,r){var c;let i=e.segmentationGroupState.value.segmentPropertyMap.value,a=((c=i==null?void 0:i.numericalProperties)!=null?c:[]).filter(r),o=lG(a.length);super(e,o);this.parentElement=t,this.segmentPropertyMap=i,this.numericalProperties=a,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var a,o,l;let t=super.getWithNormalizedId(e),{numericalProperties:r}=this,{numericalPropertyIndices:i}=this.template;if(i.length>0){let c=(l=(o=this.segmentPropertyMap)==null?void 0:o.getSegmentInlineIndex((a=e.value)!=null?a:e.key))!=null?l:-1;if(c!==-1){let{numericalPropertyWidths:d}=this;for(let p=0,m=i.length;p<m;++p){let y=r[p].values[c];if(!isNaN(y)){let v=y.toString(),b=v.length;b>d[p]&&(d[p]=b,this.parentElement.style.setProperty(`--neuroglancer-column-${p}-width`,`${b}ch`)),t.children[i[p]].textContent=v}}}}return t}makeHeaderLabel(e,t,r){let i=document.createElement("span");i.textContent=e,i.classList.add("neuroglancer-segment-list-header-label"),i.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(r.style.textAlign="left");let a=document.createElement("span");a.classList.add("neuroglancer-segment-list-header-label-sort"),i.appendChild(a),a.textContent="\u25B2";let o=SD(i).width;return this.parentElement.style.setProperty(t,`${o}px`),r.appendChild(i),{id:e,label:i,sortIcon:a}}getHeader(){let{template:e}=this,t=e.template.cloneNode(!0),{children:r}=t,i=r[0].children,a=i[e.copyContainerIndex];a.style.visibility="hidden",i[e.visibleIndex].style.visibility="hidden",r[e.filterIndex].style.visibility="hidden";let o=i[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",r[e.labelIndex])],{numericalProperties:c}=this,{numericalPropertyIndices:d}=this.template;for(let p=0,m=d.length;p<m;++p){let y=c[p],v=this.makeHeaderLabel(y.id,`--neuroglancer-column-${p}-label-width`,t.children[d[p]]),{description:b}=y;b&&(v.label.title=b),l.push(v)}return{container:t,propertyLabels:l}}};function Id(n,e){return Xs.make(n!=null?n:void 0,!0).getWithNormalizedId(e)}function Ho(n,e,t){e.registerDisposer(Na((r,i)=>{I1(r,i,t)},n.segmentationGroupState)),e.registerDisposer(Na((r,i)=>{r.registerDisposer(i.segmentColorHash.changed.add(t)),r.registerDisposer(i.segmentDefaultColor.changed.add(t))},n.segmentationColorGroupState)),e.registerDisposer(n.saturation.changed.add(t)),e.registerDisposer(n.segmentSelectionState.changed.add(t)),e.registerDisposer(n.baseSegmentColoring.changed.add(t))}function $S(n,e){let t=e.redrawNeeded.dispatch;Ho(n,e,t),e.registerDisposer(Na((r,i)=>{A1(r,i,t)},n.segmentationGroupState))}function uG(n,e){$S(n,e),e.registerDisposer(n.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function Ad(n,e){uG(n,e),e.registerDisposer(n.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}var RD=Gn.create(),Oi=new X;function jS(n,e,t=RD){if(n==null)return t.fill(1),t;let r=n.segmentationColorGroupState.value,{segmentStatedColors:i}=r;if(i.size!==0&&r.segmentStatedColors.get(e,Oi))return t[0]=(Oi.low&255)/255,t[1]=((Oi.low&65280)>>>8)/255,t[2]=((Oi.low&16711680)>>>16)/255,t;let a=r.segmentDefaultColor.value;return a!==void 0?(t[0]=a[0],t[1]=a[1],t[2]=a[2],t):(r.segmentColorHash.compute(t,e),t)}function dG(n,e,t=1){let r=RD;r[3]=t,jS(n,e,r);let i=n.saturation.value;n.segmentSelectionState.isSelected(e)&&(i>.5?i=i-=.5:i+=.5);for(let a=0;a<3;++a)r[a]=r[a]*i+(1-i);return r[0]*=t,r[1]*=t,r[2]*=t,r}function JS(n,e={}){for(let t of P1)e[t]=n[t].rpcId;return e}var pG=la(ha),bc=class extends pG{constructor(e,t,r){super(r);this.chunkManager=e;this.displayState=t}initializeCounterpartWithChunkManager(e){let{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,JS(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(Lt.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(Lt.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}};function Md(n,e,t,r,i){let a=Math.min(1,n.objectAlpha.value),o=n.baseSegmentColoring.value;ma(n.segmentationGroupState.value,(l,c)=>{let d=r==null?void 0:r.registerUint64(e,l),p=t?dG(n,o?l:c,a):void 0;i(l,p,d,c)})}var fG=ie.create(),di=Ct.create(),_D=!1;function VD(n,e){e.vertexBuffer=_t.fromData(n,e.meshData.vertexPositions,n.ARRAY_BUFFER,n.STATIC_DRAW),e.indexBuffer=_t.fromData(n,e.meshData.indices,n.ELEMENT_ARRAY_BUFFER,n.STATIC_DRAW),e.normalBuffer=_t.fromData(n,e.meshData.vertexNormals,n.ARRAY_BUFFER,n.STATIC_DRAW)}function OD(n){n.vertexBuffer.dispose(),n.indexBuffer.dispose(),n.normalBuffer.dispose()}var hG=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function ND(n){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,r){r.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,n,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}var mG={[li.float32]:ND(WebGL2RenderingContext.FLOAT),[li.uint16]:ND(WebGL2RenderingContext.UNSIGNED_SHORT),[li.uint10]:{defineShader:n=>{n.addAttribute("highp uint","aVertexPosition"),n.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(n,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(n,e)=>{n.disableVertexAttribArray(e.attribute("aVertexPosition"))}}},qS=class{constructor(e,t){this.fragmentRelativeVertices=e;this.vertexPositionFormat=t;this.tempLightVec=new Float32Array(4);this.vertexPositionHandler=mG[this.vertexPositionFormat]}beginLayer(e,t,r,i){let{lightDirection:a,ambientLighting:o,directionalLighting:l}=r,c=this.tempLightVec;K.scale(c,a,l),c[3]=o,e.uniform4fv(t.uniform("uLightDirection"),c);let d=i.silhouetteRendering.value;d>0&&e.uniform1f(t.uniform("uSilhouettePower"),d)}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginModel(e,t,r,i){let{projectionParameters:a}=r;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,ie.multiply(fG,a.viewProjectionMat,i)),Ts(di,i),Qy(di,di,a.displayDimensionRenderInfo.canonicalVoxelFactors),Ct.invert(di,di),Ct.transpose(di,di),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,di)}drawFragmentHelper(e,t,r,i,a){this.vertexPositionHandler.bind(e,t,r);let{meshData:o}=r;r.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),r.indexBuffer.bind();let{indices:l}=o;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,a-i,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,i*l.BYTES_PER_ELEMENT)}drawFragment(e,t,r){let{meshData:i}=r,{indices:a}=i;this.drawFragmentHelper(e,t,r,0,a.length)}drawMultiscaleFragment(e,t,r,i,a){let o=r.meshData.subChunkOffsets[i],l=r.meshData.subChunkOffsets[a];this.drawFragmentHelper(e,t,r,o,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){let t=e.registerDisposer(qt(r=>r>0,[e.displayState.silhouetteRendering]));return jr(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(r,i)=>{this.vertexPositionHandler.defineShader(r),r.addAttribute("highp vec2","aVertexNormal"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec4","uLightDirection"),r.addUniform("highp vec4","uColor"),r.addUniform("highp mat3","uNormalMatrix"),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp uint","uPickID"),i&&r.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(r.addUniform("highp vec3","uFragmentOrigin"),r.addUniform("highp vec3","uFragmentShape")),r.addVertexCode(hG);let a="";this.fragmentRelativeVertices?a+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:a+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,a+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,i&&(a+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),r.setVertexMain(a),r.setFragmentMain("emit(vColor, uPickID);")}})}},zh=class extends Ir{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new qS(!1,li.float32);this.getShader=this.meshShaderManager.makeGetter(this);Ad(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new bc(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=X1,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=Bo(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState),a.beginModel(r,l,e,o);let c=this.source.chunks,d=0,p=0,{renderScaleHistogram:m}=this.displayState,y=this.source.fragmentSource.chunks;Md(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(v,b,x)=>{let C=Dr(v),L=c.get(C);if(++d,L!==void 0){++p,e.emitColor&&a.setColor(r,l,b),e.emitPickID&&a.setPickID(r,l,x),d+=L.fragmentIds.length;for(let A of L.fragmentIds){let D=y.get(`${C}/${A}`);D!==void 0&&D.state===Qe.GPU_MEMORY&&(a.drawFragment(r,l,D),++p)}}}),e.emitColor&&(m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),m.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,p,d-p)),a.endLayer(r,l)}isReady(){let{displayState:e,source:t}=this,r=!0,i=t.fragmentSource.chunks;return ma(e.segmentationGroupState.value,a=>{let o=Dr(a),l=t.chunks.get(o);if(l===void 0){r=!1;return}for(let c of l.fragmentIds){let d=i.get(`${o}/${c}`);if(d===void 0||d.state!==Qe.GPU_MEMORY){r=!1;return}}}),r}},BD=class extends fr{constructor(e,t){super(e);this.fragmentIds=t.fragmentIds}},FD=class extends fr{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),VD(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),OD(this)}},Yr=class extends Pn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new Hh(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new BD(this,e)}},Hh=class extends Pn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new FD(this,e)}};Hh=xt([mn(Z1)],Hh);function UD(n,e,t,r){let i=n.get(CS(e,t,r));return i!==void 0&&i.state===Qe.GPU_MEMORY}var Rd=class extends Ir{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new qS(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat);this.getShader=this.meshShaderManager.makeGetter(this);Ad(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new bc(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=Q1,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=Bo(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState);let{renderScaleHistogram:c}=this.displayState;e.emitColor&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),Ts(di,o),Qy(di,di,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);let d=Math.pow(Math.abs(Ct.determinant(di)),1/3),{chunks:p}=this.source,m=this.source.fragmentSource.chunks,{projectionParameters:y}=e,v=ie.multiply(ie.create(),y.viewProjectionMat,o),b=Ls(new Float32Array(24),v),x=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:C}=this.source.format;a.beginModel(r,l,e,o);let L=0,A=0;Md(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(D,R,P)=>{let E=Dr(D),V=p.get(E);if(++L,V===void 0)return;++A;let{manifest:O}=V,{octree:B,chunkShape:W,chunkGridSpatialOrigin:_,vertexOffsets:F}=O;if(_D)try{nD(B)}catch(N){console.log(`invalid octree for object=${D}: ${N.message}`)}e.emitColor&&a.setColor(r,l,R),e.emitPickID&&a.setPickID(r,l,P),xS(O,v,b,x,y.width,y.height,(N,J,re)=>{let pe=UD(m,E,N,J);return e.emitColor&&c.add(O.lodScales[N]*d,re,pe?1:0,pe?0:1),pe},(N,J,re,pe)=>{let ye=CS(E,N,J),ce=m.get(ye),fe=B[5*J],Le=B[5*J+1],Ge=B[5*J+2],ze=1<<N;if(C&&(r.uniform3f(l.uniform("uFragmentOrigin"),_[0]+fe*W[0]*ze+F[N*3+0],_[1]+Le*W[1]*ze+F[N*3+1],_[2]+Ge*W[2]*ze+F[N*3+2]),r.uniform3f(l.uniform("uFragmentShape"),W[0]*ze,W[1]*ze,W[2]*ze)),_D){let tt=`lod=${N}, chunkIndex=${J}, subChunkBegin=${re}, subChunkEnd=${pe}, uFragmentOrigin=${[_[0]+fe*W[0]*ze+F[N*3+0],_[1]+Le*W[1]*ze+F[N*3+1],_[2]+Ge*W[2]*ze+F[N*3+2]]}, uFragmentShape=${[W[0]*ze,W[1]*ze,W[2]*ze]}`,ge=e.pickIDs.registerUint64(this,D,1,tt);e.emitPickID&&a.setPickID(r,l,ge)}a.drawMultiscaleFragment(r,l,ce,re,pe)})}),c.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,A,L-A),a.endLayer(r,l)}isReady(e,t){let{displayState:r}=this;if(r.objectAlpha.value<=0)return!0;let i=Bo(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(i===void 0)return!1;let{chunks:a}=this.source,o=this.source.fragmentSource.chunks,{projectionParameters:l}=e,c=ie.multiply(ie.create(),l.viewProjectionMat,i),d=Ls(new Float32Array(24),c),p=this.displayState.renderScaleTarget.value,m=!0;return ma(r.segmentationGroupState.value,y=>{if(!m)return;let v=Dr(y),b=a.get(v);if(b===void 0){m=!1;return}let{manifest:x}=b;xS(x,c,d,p,l.width,l.height,(C,L)=>(m=m&&UD(o,v,C,L),m),()=>{})}),m}getObjectPosition(e){let t=this.displayState.transform.value;if(t.error!==void 0)return;let r=this.source.chunks.get(Dr(e));if(r===void 0)return;let{manifest:i}=r,{clipLowerBound:a,clipUpperBound:o}=i,{rank:l}=t,c=new Float32Array(l);for(let p=0;p<3;++p)c[p]=(a[p]+o[p])/2;let d=new Float32Array(l);return zr(d,t.modelToRenderLayerTransform,l+1,c,l),d}},WD=class extends fr{constructor(e,t){super(e);this.manifest=t.manifest}},GD=class extends fr{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),VD(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),OD(this)}},eo=class extends Pn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new $h(this.chunkManager,this));this.format=t.format}static encodeOptions(e){return{format:e.format,...super.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new WD(this,e)}},$h=class extends Pn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new GD(this,e)}};$h=xt([mn(eD)],$h);var zD="skeleton/SkeletonLayer";function nn(n,e,t){de(n,e,r=>t.restoreState(r))}var $o=class extends ${constructor(){super(...arguments);this.children=new Map;this.changed=new ae}add(e,t){let{children:r}=this;if(r.has(e))throw new Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){let{children:t}=this;if(t.has(e))throw new Error(`Key ${JSON.stringify(e)} not registered.`);let r=t.get(e);this.children.delete(e),r.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){let{changed:e}=this;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){let e=this.baseJSON();for(let[t,r]of this.children)e[t]=r.toJSON();return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){Z(e);for(let[t,r]of this.children)try{if(e.hasOwnProperty(t)){let i=e[t];if(i===void 0)continue;r.restoreState(i)}}catch(i){throw new Error(`Error restoring property ${JSON.stringify(t)}: ${i.message}`)}}};var HD=new WeakMap;function Qs(n){let e=HD.get(n),t=n.changed.count;if(e!==void 0&&e.generation===t)return e;let r;if(n instanceof $o){r=n.baseJSON();for(let[i,a]of n.children)r[i]=Qs(a).value}else r=n.toJSON();return e===void 0?(e={generation:t,value:r},HD.set(n,e)):(e.generation=t,e.value=r),e}var jo=class{constructor(e,t,r=t){this.enumType=e;this.value_=t;this.defaultValue=r;this.changed=new ae}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=Bt(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}};var _d=6;var xc=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function Cc(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,_d*e,t)}var jh=_d;function Jo(n,e){n.addVertexCode(xc),n.addUniform("highp vec3","uCircleParams"),n.addVarying("highp vec4","vCircleCoord"),n.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),n.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function qo(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function Yo(n,e,t){Cc(n,e,t)}var pi=_d;function Yn(n,e=!1){n.addVertexCode(xc),n.addUniform("highp vec3","uLineParams"),n.addVarying("highp float","vLineCoord"),n.addVarying("highp float","vLineFeatherFraction"),e&&(n.addVarying("highp float","vEndpointFraction"),n.addVarying("highp float","vLineCoordT"),n.addVarying("highp float","vLineBorderStartFraction")),n.addVertexCode(e1),n.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&n.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),n.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function Kn(n,e,t){Cc(n,e,t)}function Xn(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uLineParams"),1/e.width,1/e.height,t)}function vr(n){n.addAttribute("int","aDummyVertexId",0),n.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}var Rn=class extends ${constructor(e){super();this.buffer=new _t(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){let{buffer:t}=this,{gl:r}=t;t.bind(),e>this.size&&(this.size=e,r.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),r.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),r.vertexAttribDivisor(0,0),r.enableVertexAttribArray(0)}disable(){let{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new Rn(e))}};var gG=ie.create(),$D=`void main() {
  emitDefault();
}
`,Vd=[],yG=ci(new _i,z.FLOAT32,3),YS=class extends ${constructor(e,t){super();this.base=e;this.targetIsSliceView=t;this.textureAccessHelper=new Za("vertexData");this.vertexIdHelper=this.registerDisposer(Rn.get(this.gl));this.edgeShaderGetter=jr(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),Yn(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),e.addFragmentCode(Ei);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Ii(t,e),e.setFragmentMainFunction(Di(t.parseResult.code))}});this.nodeShaderGetter=jr(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),Jo(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),e.addFragmentCode(Ei);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Ii(t,e),e.setFragmentMainFunction(Di(t.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){vr(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){let{textureAccessHelper:t}=this;t.defineShader(e);let r=this.vertexAttributes.length;for(let i=Vd.length;i<r;++i)Vd[i]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${i}`);this.vertexAttributes.forEach((i,a)=>{e.addTextureSampler(`${gc(i.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,Vd[a]),e.addVertexCode(t.getAccessor(`readAttribute${a}`,`uVertexAttributeSampler${a}`,i.dataType,i.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,r,i){let{viewProjectionMat:a}=r.projectionParameters,o=ie.multiply(gG,a,i);e.uniformMatrix4fv(t.uniform("uProjection"),!1,o),this.vertexIdHelper.enable()}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}drawSkeleton(e,t,r,i,a){let{vertexAttributes:o}=this,l=o.length,{vertexAttributeTextures:c}=i;for(let d=0;d<l;++d){let p=WebGL2RenderingContext.TEXTURE0+t.textureUnit(Vd[d]);e.activeTexture(p),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c[d])}{t.bind();let d=t.attribute("aVertexIndex");i.indexBuffer.bindToVertexAttribI(d,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(d,1),Xn(t,a,this.targetIsSliceView?1:0),Kn(e,1,i.numIndices/2),e.vertexAttribDivisor(d,0),e.disableVertexAttribArray(d)}r!==null&&(r.bind(),qo(r,a,{featherWidthInPixels:this.targetIsSliceView?1:0}),Yo(r.gl,2,i.numVertices))}endLayer(e,t){let{vertexAttributes:r}=this,i=r.length;for(let a=0;a<i;++a){let o=t.textureUnit(Vd[a])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(o),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}},wc;(function(t){t[t.LINES=0]="LINES",t[t.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(wc||(wc={}));var KS=class extends jo{constructor(e,t=e){super(wc,e,t)}},XS=class extends ct{constructor(e,t=e){super(e,dt,t)}},QS=class{constructor(){this.compound=new $o;this.shader=Ao($D);this.shaderControlState=new Ka(this.shader);this.params2d={mode:new KS(1),lineWidth:new XS(2)};this.params3d={mode:new KS(0),lineWidth:new XS(1)};let{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){let e=this.compound.toJSON();for(let t of Object.values(e))if(t!==void 0)return e}},ZS=class extends ${constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.layerChunkProgressInfo=new Fs;this.redrawNeeded=new ae;this.fallbackShaderParameters=new Ae(_o(Ya($D)));Ad(r,this),this.displayState.shaderError.value=void 0;let{skeletonRenderingOptions:i}=r;this.registerDisposer(i.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let a=this.sharedObject=this.registerDisposer(new bc(e,r,this.layerChunkProgressInfo));a.RPC_TYPE_ID=zD,a.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});let o=this.vertexAttributes=[SG];for(let[l,c]of t.vertexAttributes)o.push({name:l,dataType:c.dataType,numComponents:c.numComponents,webglDataType:vG(c.dataType),glslDataType:c.numComponents>1?`vec${c.numComponents}`:"float"})}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,r,i,a){let o=i.lineWidth.value,{gl:l,source:c,displayState:d}=this;if(d.objectAlpha.value<=0)return;let p=Bo(d.transform.value,e.projectionParameters.displayDimensionRenderInfo,a);if(p===void 0)return;let m;i.mode.value===1?m=Math.max(5,o*2):m=o;let y=r.edgeShaderGetter(e.emitter),v=r.nodeShaderGetter(e.emitter),{shader:b,parameters:x}=y,{shader:C,parameters:L}=v;if(b===null||C===null)return;let{shaderControlState:A}=this.displayState.skeletonRenderingOptions;b.bind(),r.beginLayer(l,b,e,p),Jr(l,b,A,x.parseResult.controls),l.uniform1f(b.uniform("uLineWidth"),o),C.bind(),r.beginLayer(l,C,e,p),l.uniform1f(C.uniform("uNodeDiameter"),m),Jr(l,C,A,L.parseResult.controls);let D=c.chunks;Md(d,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(R,P,E)=>{let V=Dr(R),O=D.get(V);O===void 0||O.state!==Qe.GPU_MEMORY||(P!==void 0&&(b.bind(),r.setColor(l,b,P),C.bind(),r.setColor(l,C,P)),E!==void 0&&(b.bind(),r.setPickID(l,b,E),C.bind(),r.setPickID(l,C,E)),r.drawSkeleton(l,b,C,O,e.projectionParameters))}),r.endLayer(l,b)}isReady(){let{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;let r=e.chunks,i=!0;return ma(t.segmentationGroupState.value,a=>{let o=Dr(a),l=r.get(o);if(l===void 0||l.state!==Qe.GPU_MEMORY){i=!1;return}}),i}},Od=class extends Ir{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new YS(this.base,!1));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}},Jh=class extends ya{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new YS(this.base,!0));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}};function vG(n){switch(n){case z.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${z[n]}`)}}var SG={dataType:z.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"},jD=class extends fr{constructor(e,t){super(e);this.vertexAttributes=t.vertexAttributes;let r=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=r.length}copyToGPU(e){super.copyToGPU(e);let{attributeTextureFormats:t}=this.source,{vertexAttributes:r,vertexAttributeOffsets:i}=this,a=this.vertexAttributeTextures=[];for(let o=0,l=i.length;o<l;++o){let c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),Uo(e,t[o],r.subarray(i[o],o+1!==l?i[o+1]:r.length)),a[o]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=_t.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0,this.indexBuffer.dispose()}},bG=new Map;function xG(n){let e=[yG];for(let t of n.values())e.push(ci(new _i,t.dataType,t.numComponents));return e}var to=class extends Pn{get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=xG(this.vertexAttributes)),e}getChunk(e){return new jD(this,e)}constructor(e,t){super(e,t)}get vertexAttributes(){return bG}};var ot;(function(r){r[r.UNKNOWN=0]="UNKNOWN",r[r.IMAGE=1]="IMAGE",r[r.SEGMENTATION=2]="SEGMENTATION"})(ot||(ot={}));function qh(n){let{rank:e,dataType:t,compressedSegmentationBlockSize:r}=n,{baseVoxelOffset:i=new Float32Array(e)}=n;return{...oc(n),compressedSegmentationBlockSize:r,baseVoxelOffset:i,dataType:t}}function CG(n){if(n.compressedSegmentationBlockSize!==void 0||n.volumeType!==2&&!n.volumeSourceOptions.discreteValues)return!1;switch(n.dataType){case z.UINT32:case z.UINT64:break;default:return!1}switch(n.rank){case 3:return!0;case 4:{let{chunkDataSize:e}=n;return e[3]===1}default:return!1}}function eb(n){let{rank:e,lowerVoxelBound:t,upperVoxelBound:r}=n;if(!CG(n))return qh(n);let{volumeSourceOptions:{displayRank:i,multiscaleToViewTransform:a},chunkToMultiscaleTransform:o,chunkToViewTransform:l}=n;l===void 0&&(l=Is(new Float32Array(e*i),i,a,i,o,e+1,i,e,e));let{maxCompressedSegmentationBlockSize:c,chunkDataSize:d}=n;return qh({...n,compressedSegmentationBlockSize:Float32Array.from(td({rank:e,chunkToViewTransform:l,displayRank:i,lowerVoxelBound:t,upperVoxelBound:r,maxVoxelsPerChunkLog2:9,maxBlockSize:c===void 0?d:_k(new Uint32Array(e),d,c)}))})}function fi(n){let{rank:e}=n,{volumeSourceOptions:{displayRank:t,multiscaleToViewTransform:r,modelChannelDimensionIndices:i},chunkToMultiscaleTransform:a}=n,o=Is(new Float32Array(t*e),t,r,t,a,e+1,t,e,e),{minBlockSize:l}=n;l===void 0?(l=new Uint32Array(e),l.fill(1)):l=new Uint32Array(l);let{lowerVoxelBound:c,upperVoxelBound:d}=n;if(i.length!==0)for(let m of ks(a,e,i)){let y=d[m];c!==void 0&&(y-=c[m]),l[m]=y}let{chunkDataSizes:p=lE({...n,minBlockSize:l,chunkToViewTransform:o,displayRank:t})}=n;return p.map(m=>eb({...n,chunkDataSize:m,chunkToViewTransform:o}))}function Yh(n,e,t,r){let{dataType:i}=e;e.defineShader(n,t);let a="",o="";if(t===0)a+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(a+=", "),a+=`highp int channelIndex${c}`,o+=`, channelIndex${c}`;n.addFragmentCode(jE);let l=`
${At(i)} getDataValue(${a}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${r}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${At(i)} getInterpolatedDataValue(${a}) {
  highp vec3 positionWithinChunk = ${r};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${At(i)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${At(i)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${At(i)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;n.addFragmentCode(l),t<=1&&n.addFragmentCode(`
${At(i)} getDataValue() { return getDataValue(0); }
${At(i)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var JD=new Array;function Kh(n){JD.push(n)}function wG(n,e){for(let t of JD){let r=t(n,e);if(r!=null)return r}throw new Error("No chunk format handler found.")}var _n=class extends yd{constructor(e,t){super(e,t);this.chunkFormatHandler=this.registerDisposer(wG(e.chunkQueueManager.gl,this.spec));let r=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(r),this.tempPositionWithinChunk=new Uint32Array(r)}static encodeSpec(e){let t=e;return{...super.encodeSpec(e),dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Array.from(t.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(t.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){let r=this.spec.rank,i=this.tempChunkGridPosition,a=this.tempPositionWithinChunk,{spec:o}=this;{let{chunkDataSize:x}=o;for(let C=0;C<r;++C){let L=e[C],A=x[C],D=Math.floor(L/A);i[C]=D,a[C]=Math.floor(L-A*D)}}let l=this.chunks.get(i.join());if(l===void 0)return null;let c=l.chunkDataSize;for(let x=0;x<3;++x)if(a[x]>=c[x])return;if(t.channelSpaceShape.length===0)return l.getValueAt(a);let{numChannels:d,chunkChannelCoordinates:p,chunkChannelDimensionIndices:m}=t,y=m.length,v=0,b=new Array(d);for(let x=0;x<d;++x){for(let C=0;C<y;++C)a[m[C]]=p[v++];b[x]=l.getValueAt(a)}return b}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}},tb=class extends vd{get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t);this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}},Ft=class extends mS{};var qD=class extends ut(gt()(_n),Th){},YD=class extends ut(gt()(eo),Lh){},KD=class extends ut(gt()(Yr),kh){},XD=class extends ut(gt()(to),Eh){},QD=class extends ut(gt()(zs),Ph){},Nd=new Map;Nd.set("UINT8",z.UINT8);Nd.set("FLOAT",z.FLOAT32);Nd.set("UINT32",z.UINT32);Nd.set("UINT64",z.UINT64);function TG(n){Z(n);try{return{corner:j(n,"corner",e=>zu(K.create(),e,Ze)),size:j(n,"size",e=>zu(K.create(),e,dt)),metadata:j(n,"metadata",Yt)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}var ZD=class{constructor(e){try{Z(e),this.numChannels=j(e,"channelCount",Rt),this.dataType=j(e,"channelType",t=>If(t,Nd)),this.voxelSize=j(e,"pixelSize",t=>zu(K.create(),t,dt)),this.upperVoxelBound=j(e,"volumeSize",t=>zu(K.create(),t,Rt)),this.boundingBoxes=j(e,"boundingBox",t=>t===void 0?[]:be(t,TG))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}};function LG(n){return Z(n),{name:j(n,"name",ne),type:j(n,"type",ne)}}function kG(n){try{return Z(n),j(n,"meshes",e=>e===void 0?[]:be(e,LG))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}var EG="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",nb="([0-9]+)",eP=new RegExp(`^(.*)_${nb}x${nb}x${nb}_lod([0-9]+)_${EG}$`);function DG(n,e){let t=new Map,r=n.scales[0],i=new Set;for(let o of e){if(o.type!=="TRIANGLES")continue;let l=o.name.match(eP);if(l===null)continue;let c=l[1],d=t.get(c);d===void 0&&(d={key:c,chunkShape:K.create(),lods:[]},t.set(c,d));let p=parseInt(l[5]);if(d.lods[p]!==void 0){i.add(c);continue}let m=K.fromValues(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),y=new Uint32Array(3);for(let v=0;v<3;++v)y[v]=Math.ceil(r.upperVoxelBound[v]/m[v]);d.lods[p]={info:o,scale:parseFloat(l[6]),relativeBlockShape:m,gridShape:y}}let a=[];e:for(let o of t.values()){if(i.has(o.key))continue e;let l=o.lods[0];if(l===void 0)continue e;let c=l.relativeBlockShape;K.multiply(o.chunkShape,c,r.voxelSize);for(let d=1;d<o.lods.length;++d){let p=o.lods[d];if(p===void 0)continue e;let{relativeBlockShape:m}=p;for(let y=0;y<3;++y){let v=m[y],b=c[y];if(v<b||v%b!=0)continue e;m[y]=v/b}}c.fill(1),a.push(o)}return a}function PG(n,e){let t=DG(n,e),r=[],i=o=>{r.some(l=>l.name===o.name)||r.push(o)},a=new Set;for(let o of t){i({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(let l of o.lods)a.add(l.info)}for(let o of e)i({single:o,multi:void 0,name:o.name,partOfMultiscale:a.has(o)});return r}var tP=class{constructor(e){try{Z(e);let t=this.scales=j(e,"geometry",o=>be(o,l=>new ZD(l)));if(t.length===0)throw new Error("Expected at least one scale.");let r=t[0],i=this.numChannels=r.numChannels,a=this.dataType=r.dataType;for(let o=1,l=t.length;o<l;++o){let c=t[o];if(c.dataType!==a)throw new Error(`Scale ${o} has data type ${z[c.dataType]} but scale 0 has data type ${z[a]}.`);if(c.numChannels!==i)throw new Error(`Scale ${o} has ${c.numChannels} channel(s) but scale 0 has ${i} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(r.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){let t=this.scales[0],r=["x","y","z"],i=["m","m","m"],a=Array.from(t.voxelSize,c=>c/1e9),o=[0,0,0],l=Array.from(t.upperVoxelBound);return e&&(r.push("c^"),i.push(""),a.push(1),o.push(0),l.push(this.numChannels)),Ve({names:r,units:i,scales:Float64Array.from(a),boundingBoxes:[ur({lowerBounds:new Float64Array(r.length),upperBounds:Float64Array.from(l)})]})}},nP=class extends Ft{constructor(e,t,r,i,a,o,l){super(e);this.instance=t;this.credentialsProvider=r;this.volumeId=i;this.changeSpec=a;this.multiscaleVolumeInfo=o;this.encoding=l.encoding,this.jpegQuality=l.jpegQuality,this.chunkLayoutPreference=l.chunkLayoutPreference;let c=ot.IMAGE;this.dataType===z.UINT64&&(c=ot.SEGMENTATION),this.volumeType=c}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(e){let t=ba.RAW;(this.dataType===z.UINT64||this.dataType===z.UINT32)&&this.volumeType===ot.SEGMENTATION&&this.encoding!==ba.RAW?t=ba.COMPRESSED_SEGMENTATION:this.volumeType===ot.IMAGE&&this.dataType===z.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==ba.RAW&&e.discreteValues!==!0&&(t=ba.JPEG);let r=t===ba.JPEG?this.jpegQuality:void 0,i=this.scales[0],{upperVoxelBound:a}=i,o=K.create(),{rank:l}=this;return Tr(this.scales.map((c,d)=>{K.divide(o,c.voxelSize,i.voxelSize);let p=c.upperVoxelBound,m,{numChannels:y}=c,v=new Float32Array((l+1)**2);v[(l+1)*l+l]=1;let b=new Float32Array(l);y!==1&&(p=Float32Array.of(...p,y),m=Uint32Array.of(1,1,1,y),v[(l+1)*3+3]=1,b[3]=y);for(let x=0;x<3;++x)v[(l+1)*x+x]=o[x],b[x]=a[x]/o[x];return fi({rank:l,minBlockSize:m,chunkToMultiscaleTransform:v,dataType:c.dataType,upperVoxelBound:p,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:K.fromValues(64,64,64)}).map(x=>({chunkSource:this.chunkManager.getChunkSource(qD,{credentialsProvider:this.credentialsProvider,spec:x,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:d,encoding:t,jpegQuality:r,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:b}))}))}};function IG(n){let e=ie.create(),t=n.scales[0].voxelSize;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}function AG(n){let e=n.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${JSON.stringify(n)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});let r=ni(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:r}}function MG(n){try{return Z(n),{id:j(n,"id",ne),label:j(n,"label",ne),description:j(n,"description",Yt)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function RG(n){try{return Z(n),j(n,"project",e=>e===void 0?[]:be(e,MG))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function rP(n,e){try{return Z(n),j(n,e,t=>t===void 0?[]:be(t,ne))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function _G(n){return j(n,"changeStackId",e=>e===void 0?void 0:be(e,ne))}var VG=ut(gt()(Ri),Dh),iP=class extends VG{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t});this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){let{upperVoxelBound:e}=this.parameters,t=oc({rank:3,chunkDataSize:e,upperVoxelBound:e}),r=ie.create();return[[{chunkSource:this.chunkManager.getChunkSource(QD,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:r,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:r}]]}},OG=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}],Xh=class extends Vt{constructor(e,t){super();this.instance=e;this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:pt(this.credentialsProvider)},()=>js(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(r=>new tP(r)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:pt(this.credentialsProvider)},()=>js(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(r=>kG(r)))}get(e){let{volumeId:t,changeSpec:r,meshName:i,parameters:a}=AG(e.providerUrl);Z(a);let o=de(a,"encoding",p=>Bt(p,ba)),l=de(a,"jpegQuality",p=>{let m=yt(p);if(m<1||m>100)throw new Error(`Expected integer in range [1, 100], but received: ${p}`);return m},70),c=de(a,"chunkLayout",p=>Bt(p,_s)),d={encoding:o,chunkLayoutPreference:c,jpegQuality:l};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:r,brainmapsOptions:d},async()=>{let[p,m]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),y=new nP(e.chunkManager,this.instance,this.credentialsProvider,t,r,p,d),v={modelTransform:wt(p.getModelSpace(p.numChannels!==1)),subsources:[{id:i===void 0?"default":"volume",subsource:{volume:y},default:i===void 0}]},b=zn(p.box);p.scales[0].boundingBoxes.forEach((A,D)=>{b.add({type:Re.AXIS_ALIGNED_BOUNDING_BOX,description:A.metadata,pointA:A.corner,pointB:K.add(K.create(),A.corner,A.size),id:`boundingBox${D}`,properties:[]})}),v.subsources.push({id:"bounds",subsource:{staticAnnotations:b},default:!0});let C=PG(p,m),L=(A,D)=>{let R,{single:P}=A;if(P!==void 0)P.type==="TRIANGLES"?R=e.chunkManager.getChunkSource(KD,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:P.name,changeSpec:r}}):R=e.chunkManager.getChunkSource(XD,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:A.name,changeSpec:r}});else{let E=A.multi;R=e.chunkManager.getChunkSource(YD,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:li.float32},parameters:{instance:this.instance,volumeId:t,info:E,changeSpec:r}})}v.subsources.push({id:i===void 0?`/${A.name}`:"default",subsource:{mesh:R},subsourceToModelSubspaceTransform:IG(p),modelSubspaceDimensionIndices:[0,1,2],default:D})};if(i!==void 0){let A=C.find(D=>D.name===i);if(A===void 0)throw new Error(`Mesh/skeleton source not found: ${JSON.stringify(A)}`);L(A,!0)}else{let A=!0;for(let D of C)D.partOfMultiscale||(L(D,A),A=!1)}return r!==void 0&&v.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(iP,{parameters:{volumeId:t,changestack:r.changeStackId,instance:this.instance,upperVoxelBound:p.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),v})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=js(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(i=>RG(i)),r=`${this.instance.description} project list`;return Ee.forPromise(t,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let r=js(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(a=>rP(a,"datasetIds")),i=`${this.instance.description} dataset list`;return Ee.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),r})}getVolumeList(e,t,r){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${r}:getVolumeList`},()=>{let i=js(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${r}`,responseType:"json"}).then(o=>{let l=rP(o,"volumeId"),c=t.length+r.length+2,d=[];for(let p of l)d.push(p.substring(c));return d}),a=`${this.instance.description} volume list`;return Ee.forPromise(i,{delay:!0,initialMessage:`Retrieving ${a}`,errorPrefix:`Error retrieving ${a}`}),i})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let r=js(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(a=>_G(a)),i=`change stacks for ${t}`;return Ee.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}.`,errorPrefix:`Error retrieving ${i}: `}),r})}async completeUrl(e){let{providerUrl:t}=e,r=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(r===null)throw null;let[,i,a,o,l,c,d]=r;if(d!==void 0)return Pr(t.length-d.length,await vh(d,OG));if(c!==void 0){let m=`${i}:${a}:${o}`,y=await this.getMeshesInfo(e.chunkManager,m),v=[],b=new Set;for(let x of y)if(!!x.name.startsWith(c))switch(x.type){case"LINE_SEGMENTS":v.push({value:x.name,description:"Skeletons"});break;case"TRIANGLES":{v.push({value:x.name,description:"Mesh (single-resolution)"});let C=x.name.match(eP);if(C!==null){let L=C[1];if(b.has(L))break;b.add(L),v.push({value:L,description:"Mesh (multi-resolution)"})}break}}return v.sort((x,C)=>Qa(x.value,C.value)),{offset:t.length-c.length,completions:v}}if(l!==void 0){let m=`${i}:${a}:${o}`,y=await this.getChangeStackList(e.chunkManager,m);if(y===void 0)throw null;return{offset:t.length-l.length,completions:yh(l,y)}}if(o!==void 0)return{offset:t.length-o.length,completions:yh(o,await this.getVolumeList(e.chunkManager,i,a))};if(a!==void 0){let m=await this.getDatasetList(e.chunkManager,i);return{offset:t.length-a.length,completions:yh(a,m.map(y=>`${y}:`))}}let p=await this.getProjectList(e.chunkManager);return{offset:0,completions:tn(i,p,m=>`${m.id}:`,m=>m.label)}}},aP={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};var rn=class extends ${};function oP(n){let e,t,r;return(i,a)=>t!==void 0&&(e===void 0||i===void 0||e.generation!==i.generation)?(e===void 0&&r.addConsumer(a),t):(e=void 0,r=new Fv,t=n(i,r).then(o=>(e=o,r=void 0,o),o=>{throw r.isCanceled&&(r=void 0,t=void 0),o}),t)}function xn(n){let e=0;return oP((t,r)=>n(r).then(i=>({generation:++e,credentials:i})))}var sP=class{constructor(){this.providers=new Map;this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){let r=this.providers.get(e);if(r===void 0)throw new Error(`No registered credentials provider: ${JSON.stringify(e)}`);return r(t,this.topLevelManager)}},lP=class extends ${constructor(e){super();this.base=e;this.memoize=new qu}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}},Bd=class extends lP{constructor(){super(new sP);this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}},rb=class extends rn{constructor(e,t){super();this.baseProvider=e;this.anonymousCredentials=t;this.anonymous=!0;this.get=oP(e=>this.anonymous&&e===void 0?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e)))}};var Qn=new Bd;var NG="https://accounts.google.com/o/oauth2/auth",cP="https://accounts.google.com";function BG(n,e){let t=document.createElement("iframe");t.style.display="none",t.id=n,t.name=n;let r=location.origin;t.src=`https://accounts.google.com/o/oauth2/postmessageRelay?parent=${encodeURIComponent(r)}#rpctoken=${e}`,document.body.appendChild(t)}var uP=class{constructor(){this.finished=new We}},dP=class{constructor(){this.proxyName=`postmessageRelay${Wa()}`;this.rpcToken=`${Wa()}`;this.relayReadyService=`oauth2relayReady:${this.rpcToken}`;this.oauth2CallbackService=`oauth2callback:${this.rpcToken}`;this.pendingRequests=new Map;BG(this.proxyName,this.rpcToken),this.relayReadyPromise=new Promise(e=>{addEventListener("message",t=>{if(t.origin===cP)try{let r=Z(JSON.parse(t.data)),i=ne(r.s);if(i===this.relayReadyService&&e(),i===this.oauth2CallbackService){let a=be(r.a,A=>A),o=ne(a[0]),l=location.origin;if(!o.startsWith(l+"#")&&!o.startsWith(l+"?"))throw new Error(`oauth2callback: URL ${JSON.stringify(o)} does not match current origin ${l}.`);let d=o.substring(l.length+1).split("&"),p=new Map;for(let A of d){let D=A.match("^([a-z_]+)=(.*)$");if(D===null)throw new Error(`oauth2callback: URL part ${JSON.stringify(D)} does not match expected pattern.`);p.set(D[1],D[2])}let m=p.get("state");if(m===void 0)throw new Error("oauth2callback: State argument is missing.");let y=this.pendingRequests.get(m);if(y===void 0)return;let v=p.get("error");if(v!==void 0){let A=p.get("error_subtype"),D=v;A!==void 0&&(D+=": "+A),y.finished.dispatch(void 0,new Error(`Error obtaining Google OAuth2 token: ${D}`));return}let b=p.get("access_token"),x=p.get("token_type"),C=p.get("expires_in"),L=p.get("scope");if(b===void 0||x===void 0||C===void 0||L===void 0)throw new Error("oauth2callback: URL lacks expected parameters.");y.finished.dispatch({accessToken:b,tokenType:x,expiresIn:C,scope:L});return}}catch(r){throw new Error(`Invalid message received from ${cP}: ${JSON.stringify(t.data)}: ${r.message}.`)}})})}addPendingRequest(e){let t=new uP;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${NG}?client_id=${encodeURIComponent(e.clientId)}`;t+="&redirect_uri=postmessage",t+="&response_type=token";let{origin:r=location.origin}=e;return t+=`&origin=${encodeURIComponent(r)}`,t+=`&proxy=${this.proxyName}`,t+="&include_granted_scopes=true",t+=`&scope=${encodeURIComponent(e.scopes.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.approvalPrompt&&(t+=`&approval_prompt=${encodeURIComponent(e.approvalPrompt)}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),e.authUser!==void 0&&(t+=`&authuser=${e.authUser}`),t}},ib;function FG(){return ib===void 0&&(ib=new dP),ib}function UG(n,e=et){let t=Wa(),r=FG(),i=r.makeAuthRequestUrl({state:t,clientId:n.clientId,scopes:n.scopes,approvalPrompt:n.approvalPrompt,loginHint:n.loginHint,immediate:n.immediate,authUser:n.authUser}),a=r.addPendingRequest(t),o=new Promise((l,c)=>{a.finished.add((d,p)=>{d!==void 0?l(d):c(p)})});if(a.finished.add(e.add(()=>{a.finished.dispatch(void 0,Er)})),n.immediate)r.relayReadyPromise.then(()=>{if(e.isCanceled)return;let l=document.createElement("iframe");l.src=i,l.style.display="none",document.body.appendChild(l),a.finished.add(()=>{Ye(l)})});else if(!e.isCanceled){let l=open(i);l!==null&&a.finished.add(()=>{l.close()})}return o}var ab=class extends rn{constructor(e){super();this.options=e;this.get=xn(e=>{let{options:t}=this,r=new Ee(!0),i;return new Promise((a,o)=>{let l=()=>{i=void 0,r.dispose()};e.add(()=>{i!==void 0&&(i.cancel(),i=void 0,r.dispose(),o(Er))});function c(p=`${t.description} authorization required.`,m="Request authorization."){r.setText(p+"  ");let y=document.createElement("button");y.textContent=m,r.element.appendChild(y),y.addEventListener("click",()=>{d(!1)}),r.setVisible(!0)}function d(p){i!==void 0&&i.cancel(),i=new dr,c(`Waiting for ${t.description} authorization...`,"Retry"),UG({clientId:t.clientId,scopes:t.scopes,immediate:p,authUser:0},i).then(m=>{i!==void 0&&(l(),a(m))},m=>{i!==void 0&&(i=void 0,p?c():c(`${t.description} authorization failed: ${m}.`,"Retry"))})}d(!0)})})}};var WG="https://www.googleapis.com/auth/brainmaps",ob=class extends ab{constructor(e){super({clientId:e,scopes:[WG],description:"Brain Maps"})}};Qn.register(Cd,()=>new ob("639403125587-4k5hgdfumtrvur8v48e3pr7oo91d765k.apps.googleusercontent.com"));var pP=new Map;function Ut(n,e){pP.set(n,e)}function fP(n){let e=new bS(n.credentialsManager);for(let[t,r]of pP)e.register(t,r(n));return e}Ut("brainmaps",n=>new Xh(aP,n.credentialsManager.getCredentialsProvider(Cd)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS!="undefined")for(let[n,e]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))Ut(`brainmaps-${n}`,t=>new Xh(e,t.credentialsManager.getCredentialsProvider(Cd)));var Qh="boss";function Zs(n,e,t,r,i=et){return va(n,e,t,r,a=>{let o=new Headers(t.headers);return o.set("Authorization",`Bearer ${a}`),{...t,headers:o}},a=>{let{status:o}=a;if(o===403||o===401)return"refresh";if(o===504)return"retry";throw a},i)}var hP=class{},Zh=class extends hP{static stringify(e){return`boss:volume:${e.baseUrl}/${e.collection}/${e.experiment}/${e.channel}/${e.resolution}/${e.encoding}`}};Zh.RPC_ID="boss/VolumeChunkSource";var em=class{static stringify(e){return`boss:mesh:${e.baseUrl}`}};em.RPC_ID="boss/MeshChunkSource";var mP=class extends ut(gt()(_n),Zh){},gP=class extends ut(gt()(Yr),em){},sb=new Map;sb.set("image",ot.IMAGE);sb.set("annotation",ot.SEGMENTATION);var GG=new Set(["npz","jpeg"]),zG=Uint32Array.of(512,512,16),el;(function(i){i[i.NANOMETERS=0]="NANOMETERS",i[i.MICROMETERS=1]="MICROMETERS",i[i.MILLIMETERS=2]="MILLIMETERS",i[i.CENTIMETERS=3]="CENTIMETERS"})(el||(el={}));function HG(n){switch(n){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}function $G(n,e){Z(n);let t=j(n,"voxel_unit",d=>Bt(d,el)),r=HG(t),i=new Float32Array(3),a=new Float64Array(3),o=new Float64Array(3),l=new Float64Array(3),c=["x","y","z"];for(let d=0;d<3;++d){let p=c[d];i[d]=j(n,`${p}_voxel_size`,dt),a[d]=i[d]/r,o[d]=j(n,`${p}_start`,yt),l[d]=j(n,`${p}_stop`,yt)}return e.coordFrame={voxelSizeBaseInMeters:a,voxelSizeBaseInOriginalUnits:i,voxelOffsetBase:o,imageSizeBase:l,voxelUnit:t,names:c},e}function jG(n){let e=sb.get(n);return e===void 0&&(e=ot.UNKNOWN),e}function JG(n){Z(n);let e=j(n,"type",ne),t=!1;return j(n,"downsample_status",ne)==="DOWNSAMPLED"&&(t=!0),{channelType:e,description:j(n,"description",ne),volumeType:jG(e),dataType:j(n,"datatype",i=>Bt(i,z)),downsampled:t,scales:[],key:j(n,"name",ne)}}function qG(n,e,t,r,i,a){Z(n);let o=j(n,"channels",l=>be(l,c=>KG(e,t,r,a,i,c)));return Promise.all(o).then(l=>{let c=new Map;l.forEach(p=>{c.set(p.key,p)});let d={channels:c,scalingLevels:j(n,"num_hierarchy_levels",yt),coordFrameKey:j(n,"coord_frame",ne),coordFrame:void 0,key:j(n,"name",ne),collection:j(n,"collection",ne)};return rz(e,t,r,d)})}var yP=class extends Ft{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.credentialsProvider=r;this.experimentInfo=i;this.parameters=o;this.meshPath=void 0;this.meshUrl=void 0;if(a===void 0){let m=Array.from(i.channels.keys());if(m.length!==1)throw new Error(`Experiment contains multiple channels: ${JSON.stringify(m)}`);a=m[0]}let l=i.channels.get(a);if(l===void 0)throw new Error(`Specified channel ${JSON.stringify(a)} is not one of the supported channels ${JSON.stringify(Array.from(i.channels.keys()))}`);if(this.channel=a,this.channelInfo=l,this.scales=l.scales,i.coordFrame===void 0)throw new Error(`Specified experiment ${JSON.stringify(i.key)} does not have a valid coordinate frame`);this.coordinateFrame=i.coordFrame,this.channelInfo.downsampled===!1&&(this.scales=[l.scales[0]]),this.experiment=i.key;let c=Yt(o.window);if(c!==void 0){let m=lr.create(),y=c.split(/,/);if(y.length===2)m[0]=Ze(y[0]),m[1]=Ze(y[1]);else if(y.length===1)m[0]=0,m[1]=Ze(y[1]);else throw new Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(c)}`);if(this.window=m,this.window[0]===this.window[1])throw new Error(`Invalid window. First element must be different from second: ${JSON.stringify(c)}.`)}let d=Yt(o.meshurl);d!==void 0&&(this.meshUrl=d);let p=Yt(o.encoding);if(p===void 0)p=this.volumeType===ot.IMAGE?"jpeg":"npz";else if(!GG.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p}get dataType(){return this.channelInfo.dataType===z.UINT16?z.UINT8:this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}get rank(){return 3}getSources(e){return Tr(this.scales.map(t=>{let{downsampleFactors:r,imageSize:i}=t,a=this.coordinateFrame.voxelOffsetBase,o=K.create();for(let c=0;c<3;++c)o[c]=Math.ceil(a[c]);let l=ie.create();for(let c=0;c<3;++c)l[5*c]=r[c],l[12+c]=a[c];return fi({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:l,chunkDataSizes:[zG],baseVoxelOffset:o,upperVoxelBound:i,volumeSourceOptions:e}).map(c=>({chunkSource:this.chunkManager.getChunkSource(mP,{credentialsProvider:this.credentialsProvider,spec:c,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:t.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:l}))}))}getMeshSource(){return this.meshUrl!==void 0?this.chunkManager.getChunkSource(gP,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}},YG=/^([^\/?]+)\/([^\/?]+)(?:\/([^\/?]+))?(?:\?(.*))?$/;function vP(n,e,t,r,i){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,type:"boss:getExperimentInfo"},()=>Zs(t,`${e}/latest/collection/${i}/experiment/${r}/`,{},St).then(a=>qG(a,n,e,t,i,r)))}function KG(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,channel:a,type:"boss:getChannelInfo"},()=>Zs(t,`${e}/latest/collection/${i}/experiment/${r}/channel/${a}/`,{},St).then(JG))}function XG(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:r,experiment:i.key,channel:a,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>Zs(t,`${e}/latest/downsample/${r}/${i.key}/${a}/`,{},St)).then(o=>ZG(o,i,a))}function QG(n,e){Z(n);let t=j(n,"voxel_size",o=>Fa(o,Sk)),r=j(n,"extent",o=>Fa(o,bk)),i=j(n,"num_hierarchy_levels",yt),a=new Array;for(let o=0;o<i;o++){let l=String(o),c=t.get(l),d=r.get(l);if(c===void 0||d===void 0)throw new Error(`Missing voxel_size/extent for resolution ${l}.`);let p=new Float32Array(3);for(let m=0;m<3;++m)p[m]=c[m]=e[m];a[o]={downsampleFactors:p,imageSize:d,key:l}}return a}function ZG(n,e,t){let r=e.coordFrame;if(r===void 0)throw new Error(`Missing coordinate frame information for experiment ${e.key}. A valid coordinate frame is required to retrieve downsampling information.`);let i=e.channels.get(t);if(i===void 0)throw new Error(`Specified channel ${JSON.stringify(t)} is not one of the supported channels ${JSON.stringify(Array.from(e.channels.keys()))}`);return i.scales=QG(n,r.voxelSizeBaseInOriginalUnits),e.channels.set(t,i),e}function ez(n,e,t,r){let i=r.match(YG);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=ni(i[4]||"");return n.memoize.getUncounted({hostname:e,path:r,type:"boss:getVolume"},async()=>{let d=await vP(n,e,t,o,a),p=await XG(n,e,t,a,d,l),m=new yP(n,e,t,p,l,c),y=p.coordFrame,v={lowerBounds:y.voxelOffsetBase,upperBounds:Float64Array.from(y.imageSizeBase,(C,L)=>y.voxelOffsetBase[L]+C)},b=Ve({rank:3,names:y.names,units:["m","m","m"],scales:y.voxelSizeBaseInMeters,boundingBoxes:[ur(v)]});return{modelTransform:wt(b),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:zn(v)}}]}})}var SP=/^((?:http|https):\/\/[^\/?]+)\/(.*)$/;function tz(n,e,t){return n.memoize.getUncounted({hostname:e,type:"boss:getCollections"},()=>Zs(t,`${e}/latest/collection/`,{},St).then(r=>j(r,"collections",i=>be(i,ne))))}function nz(n,e,t,r){return n.memoize.getUncounted({hostname:e,collection:r,type:"boss:getExperiments"},()=>Zs(t,`${e}/latest/collection/${r}/experiment/`,{},St).then(i=>j(i,"experiments",a=>be(a,ne))))}function rz(n,e,t,r){let i=r.coordFrameKey;return n.memoize.getUncounted({hostname:e,coordinateframe:i,experimentInfo:r,type:"boss:getCoordinateFrame"},()=>Zs(t,`${e}/latest/coord/${i}/`,{},St).then(a=>$G(a,r)))}function iz(n,e,t,r){let i=r.match(/^(?:([^\/]+)(?:\/?([^\/]*)(?:\/?([^\/]*)(?:\/?([^\/]*)?))?)?)?$/);if(i===null||i[1]===void 0)return Promise.reject(null);if(i[2]===void 0){let a=i[1]||"";return tz(n,e,t).then(o=>({offset:0,completions:tn(a,o,l=>l+"/",()=>{})}))}if(i[3]===void 0){let a=i[2]||"";return nz(n,e,t,i[1]).then(o=>({offset:i[1].length+1,completions:tn(a,o,l=>l+"/",()=>{})}))}return vP(n,e,t,i[2],i[1]).then(a=>{let o=tn(i[3],a.channels,l=>l[0],l=>`${l[1].channelType} (${z[l[1].dataType]})`);return{offset:i[1].length+i[2].length+2,completions:o}})}function az(n){let e=n.match(/^(?:https:\/\/[^.]+([^\/]+))/);if(e===null)throw new Error(`Unable to construct auth server hostname from base hostname ${n}.`);return`https://auth${e[1]}/auth`}var lb=class extends Vt{constructor(e){super();this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){let t=az(e);return this.credentialsManager.getCredentialsProvider(Qh,t)}get(e){let t=e.providerUrl.match(SP);if(t===null)throw new Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);let r=this.getCredentialsProvider(e.providerUrl);return ez(e.chunkManager,t[1],r,t[2])}async completeUrl(e){let t=e.providerUrl.match(SP);if(t===null)throw null;let r=t[1],i=this.getCredentialsProvider(t[1]),a=t[2],o=await iz(e.chunkManager,r,i,a);return Pr(t[1].length+1,o)}};var bP=class{constructor(){this.finished=new We}},xP=class{constructor(){this.oidcCallbackService="bossAuthCallback";this.pendingRequests=new Map;this.registerListener()}registerListener(){addEventListener("message",e=>{if(e.origin===location.origin)try{let t=Z(JSON.parse(e.data));if(ne(t.service)===this.oidcCallbackService){let i=ne(t.access_token),a=ne(t.state),o=this.pendingRequests.get(a);if(o===void 0)return;o.finished.dispatch(i)}}catch(t){}})}addPendingRequest(e){let t=new bP;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${e.authServer}/realms/BOSS/protocol/openid-connect/auth?`;return t+=`client_id=${encodeURIComponent(e.clientId)}`,t+=`&redirect_uri=${encodeURIComponent(e.redirect_uri)}`,t+="&response_mode=fragment",t+="&response_type=code%20id_token%20token",e.state&&(t+=`&state=${e.state}`),e.nonce&&(t+=`&nonce=${e.nonce}`),t}},cb;function oz(){return cb===void 0&&(cb=new xP),cb}function sz(n,e=et){let t=Wa(),r=Wa(),i=oz(),a=i.makeAuthRequestUrl({state:t,clientId:n.clientId,redirect_uri:new URL("bossauth.html",window.location.href).href,authServer:n.authServer,nonce:r}),o=i.addPendingRequest(t),l=new Promise((c,d)=>{o.finished.add((p,m)=>{p!==void 0?c(p):d(m)})});if(o.finished.add(e.add(()=>{o.finished.dispatch(void 0,Er)})),!e.isCanceled){let c=open(a);c!==null&&o.finished.add(()=>{c.close()})}return l}var ub=class extends rn{constructor(e){super();this.authServer=e;this.get=xn(e=>{let t=new Ee(!0),r;return new Promise((i,a)=>{let o=()=>{r=void 0,t.dispose()};e.add(()=>{r!==void 0&&(r.cancel(),r=void 0,t.dispose(),a(Er))});function l(p="Boss authorization required.",m="Request authorization."){t.setText(p+" ");let y=document.createElement("button");y.textContent=m,t.element.appendChild(y),y.addEventListener("click",()=>{d()}),t.setVisible(!0)}let c=this.authServer;function d(){r!==void 0&&r.cancel(),r=new dr,l("Waiting for Boss authorization...","Retry"),sz({realm:"boss",clientId:"endpoint",authServer:c},r).then(p=>{r!==void 0&&(o(),i(p))},p=>{r!==void 0&&(r=void 0,l(`Boss authorization failed: ${p}.`,"Retry"))})}l()})})}};Qn.register(Qh,n=>new ub(n));Ut("boss",n=>new lb(n.credentialsManager));var Fd="DVID";function db(n){return n.text()}function CP(n,e,t=et){return lz(n,e.url,{method:e.method,body:e.payload},e.responseType===""?db:e.responseType==="json"?St:wh,t)}function lz(n,e,t,r,i=et){return va(n,e,t,r,(a,o)=>{let l={...o};return a.token&&(l.headers={...l.headers,Authorization:`Bearer ${a}`}),l},a=>{let{status:o}=a;if(o===403||o===401)return"refresh";if(o===504)return"retry";throw a},i)}var Kr;(function(i){i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(Kr||(Kr={}));var tm=class{},nm=class extends tm{};nm.RPC_ID="dvid/VolumeChunkSource";var rm=class extends tm{};rm.RPC_ID="dvid/SkeletonSource";var im=class extends tm{};im.RPC_ID="dvid/MeshSource";var am=new Map;am.set("uint8",z.UINT8);am.set("uint32",z.UINT32);am.set("uint64",z.UINT64);var wP=class{constructor(e){this.obj=e;Z(e),j(e,"TypeName",ne)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}},TP=class{constructor(e,t,r){this.obj=e;this.name=t;this.base=r}},LP=class extends ut(gt()(_n),nm){},kP=class extends ut(gt()(to),rm){},EP=class extends ut(gt()(Yr),im){},Ud=class extends TP{constructor(e,t,r,i,a){super(e,t,r);this.encoding=i;let o=j(e,"Extended",Z),l=j(o,"Values",d=>be(d,Z));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;let c=new Set(a);if(i===Kr.COMPRESSED_SEGMENTATIONARRAY){let d=j(o,"MaxDownresLevel",Rt);this.numLevels=d+1}else for(;c.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=j(l[0],"DataType",d=>If(d,am)),this.voxelSize=j(o,"VoxelSize",d=>$e(K.create(),d,dt)),this.blockSize=j(o,"BlockSize",d=>$e(K.create(),d,dt)),this.lowerVoxelBound=j(o,"MinPoint",d=>rv(K.create(),d)),this.upperVoxelBoundInclusive=j(o,"MaxPoint",d=>rv(K.create(),d))}get volumeType(){return this.encoding===Kr.COMPRESSED_SEGMENTATION||this.encoding===Kr.COMPRESSED_SEGMENTATIONARRAY?ot.SEGMENTATION:ot.IMAGE}getSources(e,t,r,i){let{encoding:a}=this,o=[],l=64;for(let c=0;c<this.numLevels;++c){let d=Math.pow(2,c),p=Math.pow(2,-c),m=K.create(),y=K.create();for(let L=0;L<3;++L){let A=Math.floor(this.lowerVoxelBound[L]*p);m[L]=A-A%l;let D=Math.ceil((this.upperVoxelBoundInclusive[L]+1)*p);y[L]=D,D%l!=0&&(y[L]+=l-D%l)}let v=t.dataInstanceKey;a!==Kr.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(v+="_"+c.toString());let b={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:v,dataScale:c.toString(),encoding:a},x=ie.create();for(let L=0;L<3;++L)x[5*L]=d,x[12+L]=m[L]*d;let C=fi({rank:3,chunkToMultiscaleTransform:x,dataType:this.dataType,baseVoxelOffset:m,upperVoxelBound:K.subtract(K.create(),y,m),volumeType:this.volumeType,volumeSourceOptions:r,compressedSegmentationBlockSize:a===Kr.COMPRESSED_SEGMENTATION||a===Kr.COMPRESSED_SEGMENTATIONARRAY?K.fromValues(8,8,8):void 0}).map(L=>({chunkSource:e.getChunkSource(LP,{spec:L,parameters:b,credentialsProvider:i}),chunkToMultiscaleTransform:x}));o.push(C)}return Tr(o)}};function cz(n,e,t){Z(n);let r=j(n,"Base",i=>new wP(i));switch(r.typeName){case"uint8blk":case"grayscale8":let i=r.compressionName.indexOf("jpeg")!==-1;return new Ud(n,e,r,i?Kr.JPEG:Kr.RAW,t);case"labels64":case"labelblk":return new Ud(n,e,r,Kr.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new Ud(n,e,r,Kr.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${JSON.stringify(r.typeName)} is not supported.`)}}var Wd=class{constructor(e){this.errors=[];this.dataInstances=new Map;this.vnodes=new Set;if(e instanceof Wd){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}Z(e),this.alias=j(e,"Alias",ne),this.description=j(e,"Description",ne);let t=j(e,"DataInstances",Z),r=Object.keys(t);for(let o of r)try{this.dataInstances.set(o,cz(t[o],o,r))}catch(l){let c=`Failed to parse data instance ${JSON.stringify(o)}: ${l.message}`;console.log(c),this.errors.push(c)}let i=j(e,"DAG",Z),a=j(i,"Nodes",Z);for(let o of Object.keys(a))this.vnodes.add(o)}};function uz(n){try{let e=Fa(n,r=>new Wd(r)),t=new Map;for(let[r,i]of e){t.set(r,i);for(let a of i.vnodes)if(a!==r){let o=new Wd(i);t.set(a,o)}}for(let[r,i]of t)i.uuid=r;return t}catch(e){throw new Error(`Failed to parse DVID repositories info: ${e.message}`)}}var DP=class{constructor(e){this.repositories=uz(e)}getNode(e){let t=[];for(let r of this.repositories.keys())r.startsWith(e)&&t.push(r);if(t.length!==1)throw new Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}};function PP(n,e,t){return n.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{let r=CP(t,{url:`${e}/api/repos/info`,method:"GET",responseType:"json"}).then(a=>new DP(a)),i=`repository info for DVID server ${e}`;return Ee.forPromise(r,{initialMessage:`Retrieving ${i}.`,delay:!0,errorPrefix:`Error retrieving ${i}: `}),r})}var IP=class extends Ft{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.nodeKey=r;this.dataInstanceKey=i;this.info=a;this.credentialsProvider=o}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}},dz=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/]+)(\?.*)?$/;function AP(n){if(n.startsWith("https"))return n+"/api/server/token"}function pz(n){let e=n.match(dz);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(n)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]},r=e[4];if(r&&r.length>1){let i=ni(r.substring(1));i.user&&(t.user=i.user)}return t.authServer=AP(t.baseUrl),t}function fz(n,e,t,r){let i=e.baseUrl,a=e.nodeKey,o=e.dataInstanceKey,l=t,c={lowerBounds:new Float64Array(l.lowerVoxelBound),upperBounds:Float64Array.from(l.upperVoxelBoundInclusive,y=>y+1)},d=Ve({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(l.voxelSize,y=>y/1e9),boundingBoxes:[ur(c)]}),p=new IP(n.chunkManager,i,a,o,l,r),m={modelTransform:wt(d),subsources:[{id:"default",subsource:{volume:p},default:!0}]};if(l.meshSrc){let y=ie.create();for(let v=0;v<3;++v)y[5*v]=1/l.voxelSize[v];m.subsources.push({id:"meshes",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(EP,{parameters:{...e,dataInstanceKey:l.meshSrc},credentialsProvider:r})},subsourceToModelSubspaceTransform:y})}return l.skeletonSrc&&m.subsources.push({id:"skeletons",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(kP,{parameters:{...e,dataInstanceKey:l.skeletonSrc},credentialsProvider:r})}}),m.subsources.push({id:"bounds",subsource:{staticAnnotations:zn(c)},default:!0}),m}function hz(n){let e=pz(n.providerUrl),{baseUrl:t,nodeKey:r,dataInstanceKey:i}=e;return n.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:t,nodeKey:r,dataInstanceKey:i},async()=>{let a=n.credentialsManager.getCredentialsProvider(Fd,{dvidServer:e.baseUrl,authServer:e.authServer}),l=(await PP(n.chunkManager,t,a)).getNode(r);if(l===void 0)throw new Error(`Invalid node: ${JSON.stringify(r)}.`);let c=l.dataInstances.get(i);if(!(c instanceof Ud))throw new Error(`Invalid data instance ${i}.`);return fz(n,e,c,a)})}function mz(n,e){return{offset:0,completions:tn(e,n.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function gz(n,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:tn(e,n.repositories.values(),a=>a.uuid+"/",a=>`${a.alias}: ${a.description}`)};let r=t[1],i=n.getNode(r);return Pr(r.length+1,mz(i,t[2]))}async function yz(n){let e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/,r=n.providerUrl.match(e);if(r===null)throw null;let i=r[1],a=r[2],o=AP(i),l=await PP(n.chunkManager,i,n.credentialsManager.getCredentialsProvider(Fd,{dvidServer:i,authServer:o}));return Pr(i.length+1,gz(l,a))}var pb=class extends Vt{constructor(e){super();this.credentialsManager=e}get description(){return"DVID"}get(e){return hz(e)}completeUrl(e){return yz(e)}};async function vz(n,e=et){return{token:await si(n,{method:"GET",credentials:"include"},db,e)}}var MP=class extends rn{constructor(e){super();this.authServer=e;this.get=xn(e=>{if(!this.authServer)return Promise.resolve({token:""});let t=new Ee(!0),r;return new Promise((i,a)=>{let o=()=>{r=void 0,t.dispose()};e.add(()=>{r!==void 0&&(r.cancel(),r=void 0,t.dispose(),a(Er))});function l(d,p="DVID authorization required.",m="Request authorization."){t.setText(p+" ");let y=document.createElement("button");y.textContent=m,t.element.appendChild(y),y.addEventListener("click",()=>{let v=d.match(/^[^\/]+\/\/[^\/\.]+\.([^\/]+)/);if(v){let b=`https://flyemlogin.${v[1]}/login`;window.alert(`Please log into ${b} and then refresh the neurogalncer page to try again.
If you are unable to log into ${b}, please check your authorization server ${d} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${d} to make sure it is correct.`)}),t.setVisible(!0)}function c(d){r!==void 0&&r.cancel(),r=new dr,l(d,"Waiting for DVID authorization...","Retry"),vz(d,r).then(p=>{r!==void 0&&(o(),i(p))},p=>{r!==void 0&&(r=void 0,l(d,`DVID authorization failed: ${p}.`,"Retry"))})}c(this.authServer)})})}},fb=class extends rb{constructor(e,t){super(new MP(t),{})}};Qn.register(Fd,n=>new fb(n.dvidServer,n.authServer));Ut("dvid",n=>new pb(n.credentialsManager));var RP=class{},_P=class extends RP{},om=class extends _P{};om.RPC_ID="render/TileChunkSource";var Sz=new Set(["jpg","raw16"]),bz=ut(_n,om),VP=class extends bz{},xz=new Set(["COMPLETE","READ_ONLY"]),Cz=new Set(["LOADING"]);function wz(n){let e=be(n,Z);if(e.length<1)throw new Error("No stacks found for owner object.");let t=new Map,r=j(e[0],"stackId",Lz);for(let i of e){let a=j(i,"stackId",Tz),o=kz(i);if(o!==void 0){let l=o.project,c=t.get(l);if(c===void 0){let d=new Map;t.set(l,{stacks:d}),c=t.get(l)}c.stacks.set(a,o)}}return{owner:r,projects:t}}function Tz(n){return Z(n),j(n,"stack",ne)}function Lz(n){return Z(n),j(n,"owner",ne)}function kz(n){Z(n);let e=j(n,"state",ne),t=[],r=K.create(),i=K.create();if(xz.has(e)){let l=j(n,"stats",Z);r=Dz(l),i=Ez(l),l.hasOwnProperty("channelNames")&&(t=Pz(l))}else if(!Cz.has(e))return;let a=j(n,"currentVersion",Iz),o=j(n,"stackId",Az);return{lowerVoxelBound:r,upperVoxelBound:i,voxelResolution:a,project:o,channels:t}}function Ez(n){Z(n);let e=j(n,"stackBounds",Z),t=K.create();return t[0]=j(e,"maxX",En)+1,t[1]=j(e,"maxY",En)+1,t[2]=j(e,"maxZ",En)+1,t}function Dz(n){Z(n);let e=j(n,"stackBounds",Z),t=K.create();return t[0]=j(e,"minX",En),t[1]=j(e,"minY",En),t[2]=j(e,"minZ",En),t}function Pz(n){return Z(n),j(n,"channelNames",e=>be(e,ne))}function Iz(n){Z(n);let e=K.create();try{e[0]=j(n,"stackResolutionX",En),e[1]=j(n,"stackResolutionY",En),e[2]=j(n,"stackResolutionZ",En)}catch(t){e[0]=1,e[1]=1,e[2]=1}return e}function Az(n){return Z(n),j(n,"project",ne)}var OP=class extends Ft{constructor(e,t,r,i,a,o,l){super(e);this.baseUrl=t;this.ownerInfo=r;this.project=a;this.parameters=l;let c=r.projects.get(a);if(c===void 0)throw new Error(`Specified project ${JSON.stringify(a)} does not exist for specified owner ${JSON.stringify(r.owner)}`);if(i===void 0){let y=Array.from(c.stacks.keys());if(y.length!==1)throw new Error(`Dataset contains multiple stacks: ${JSON.stringify(y)}`);i=y[0]}let d=c.stacks.get(i);if(d===void 0)throw new Error(`Specified stack ${JSON.stringify(i)} is not one of the supported stacks: `+JSON.stringify(Array.from(c.stacks.keys())));this.stack=i,this.stackInfo=d,o!==void 0&&o.length>0&&(this.channel=o),this.minIntensity=ti(l.minIntensity),this.maxIntensity=ti(l.maxIntensity),this.maxTileSpecsToRender=ti(l.maxTileSpecsToRender),this.filter=gk(l.filter),this.minX=ti(l.minX),this.minY=ti(l.minY),this.minZ=ti(l.minZ),this.maxX=ti(l.maxX),this.maxY=ti(l.maxY),this.maxZ=ti(l.maxZ),this.minX!==void 0&&(d.lowerVoxelBound[0]=this.minX),this.minY!==void 0&&(d.lowerVoxelBound[1]=this.minY),this.minZ!==void 0&&(d.lowerVoxelBound[2]=this.minZ),this.maxX!==void 0&&(d.upperVoxelBound[0]=this.maxX),this.maxY!==void 0&&(d.upperVoxelBound[1]=this.maxY),this.maxZ!==void 0&&(d.upperVoxelBound[2]=this.maxZ);let p=Yt(l.encoding);if(p===void 0)p="jpg";else if(!Sz.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p,this.numLevels=ti(l.numlevels),this.dims=K.create();let m=ti(l.tilesize);m===void 0&&(m=1024),this.dims[0]=m,this.dims[1]=m,this.dims[2]=1}get dataType(){return this.parameters.encoding==="raw16"?z.UINT16:z.UINT8}get volumeType(){return ot.IMAGE}get rank(){return 3}getSources(e){let t=[],r=this.numLevels;r===void 0&&(r=Mz(this.stackInfo,this.dims[0]));let{lowerVoxelBound:i,upperVoxelBound:a}=this.stackInfo;for(let o=0;o<r;o++){let l=ie.create(),c=Uint32Array.of(1,1,1);for(let x=0;x<2;++x)l[5*x]=Math.pow(2,o),c[x]=this.dims[x];let d=K.create(),p=K.create(),m=K.create(),y=K.create();for(let x=0;x<3;x++){let C=l[5*x],L=m[x]=i[x]/C,A=y[x]=a[x]/C;d[x]=Math.floor(L),p[x]=Math.ceil(A)}let v=qh({rank:3,chunkDataSize:c,dataType:this.dataType,lowerVoxelBound:d,upperVoxelBound:p}),b=this.chunkManager.getChunkSource(VP,{spec:v,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:o,encoding:this.encoding}});t.push([{chunkSource:b,chunkToMultiscaleTransform:l,lowerClipBound:m,upperClipBound:y}])}return Tr(t)}};function Mz(n,e){let t=0;for(let i=0;i<2;i++)t=Math.max(t,n.upperVoxelBound[i]);if(e>=t)return 1;let r=0;for(;t>e;)t=t/2,r++;return r}function sm(n,e,t){return n.memoize.getUncounted({type:"render:getOwnerInfo",hostname:e,owner:t},()=>Ch(`${e}/render-ws/v1/owner/${t}/stacks`).then(r=>r.json()).then(wz))}var Rz=/^([^\/?]+)(?:\/([^\/?]+))?(?:\/([^\/?]+))(?:\/([^\/?]*))?(?:\?(.*))?$/,NP=/^((?:(?:(?:http|https):\/\/[^,\/]+)[^\/?]))\/(.*)$/;function _z(n,e){let t,r;{let p=e.match(NP);if(p===null)throw new Error(`Invalid render volume path: ${JSON.stringify(e)}`);t=p[1],r=p[2]}let i=r.match(Rz);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=i[4],d=ni(i[5]||"");return n.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:t,path:r},async()=>{let p=await sm(n,t,a),m=new OP(n,t,p,l,o,c,d),y=Ve({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(m.stackInfo.voxelResolution,b=>b/1e9),boundingBoxes:[ur({lowerBounds:new Float64Array(m.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(m.stackInfo.upperVoxelBound)})]});return{modelTransform:wt(y),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:zn(y.bounds)}}]}})}async function Vz(n,e,t){let r=t.match(/^(?:([^\/]+)(?:\/([^\/]*))?(?:\/([^\/]*))?(\/.*?)?)?$/);if(r===null||r[2]===void 0)throw null;if(r[3]===void 0){let p=r[2]||"",m=await sm(n,e,r[1]),y=tn(p,m.projects,v=>v[0]+"/",()=>{});return{offset:r[1].length+1,completions:y}}if(r[4]===void 0){let p=r[3]||"",y=(await sm(n,e,r[1])).projects.get(r[2]);if(y===void 0)throw null;let v=tn(p,y.stacks,b=>b[0]+"/",b=>b[1].project);return{offset:r[1].length+r[2].length+2,completions:v}}let i=r[4].substr(1)||"",o=(await sm(n,e,r[1])).projects.get(r[2]);if(o===void 0)throw null;let l=o.stacks.get(r[3]);if(l===void 0)throw null;let c=l.channels;if(c.length===0)throw null;let d=tn(i,c,p=>p,()=>{});return{offset:r[1].length+r[2].length+r[3].length+3,completions:d}}async function Oz(n,e){let t=n.match(NP);if(t===null)throw null;let r=t[1],i=t[2],a=await Vz(e,r,i);return Pr(t[1].length+1,a)}var hb=class extends Vt{get description(){return"Render"}get(e){return _z(e.chunkManager,e.providerUrl)}completeUrl(e){return Oz(e.providerUrl,e.chunkManager)}};Ut("render",()=>new hb);var Gd;(function(i){i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSO=3]="COMPRESSO"})(Gd||(Gd={}));var lm=class{};lm.RPC_ID="precomputed/VolumeChunkSource";var cm=class{};cm.RPC_ID="precomputed/MeshSource";var zd;(function(t){t[t.RAW=0]="RAW",t[t.GZIP=1]="GZIP"})(zd||(zd={}));var um;(function(t){t[t.IDENTITY=0]="IDENTITY",t[t.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(um||(um={}));var dm=class{};dm.RPC_ID="precomputed/MultiscaleMeshSource";var pm=class{};pm.RPC_ID="precomputed/SkeletonSource";var fm=class{};fm.RPC_ID="precomputed/AnnotationSpatialIndexSource";var hm=class{};hm.RPC_ID="precomputed/AnnotationSource";var mm=class{};mm.RPC_ID="precomputed/IndexedSegmentPropertySource";function BP(n,e){return e=Math.imul(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,461845907)>>>0,n^=e,n=(n<<13|n>>>19)>>>0,n=Math.imul(n,5)+3864292196>>>0,n}function Nz(n,e){return n^=e,n^=n>>>16,n=Math.imul(n,2246822507)>>>0,n^=n>>>13,n*=3266489909,n^=n>>>16,n>>>0}function mb(n,e,t){let r=n;return r=BP(r,e),r=BP(r,t),Nz(r,8)}var gb=class extends Pn{constructor(e,t){super(e,t);this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}};function Bz(n,e,t){let r=n.length-1;for(;;){if(e=e&r,n[e]===0){n[e]=t;return}++e}}function gm(n,e){return e<=255?new Uint8Array(n):e<=65535?new Uint16Array(n):new Uint32Array(n)}function Fz(n){let e=n.length/2,t=Math.ceil(Math.log2(e))+1,r=2**t,i=gm(r,e+1);for(let a=0;a<e;++a){let o=n[2*a],l=n[2*a+1];Bz(i,mb(0,o,l),a+1)}return i}function Uz(n,e,t,r){let i=mb(0,t,r),a=n.length-1;for(;;){i=i&a;let o=n[i];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===r)return o;++i}}var ym=class{constructor(e){this.inlineProperties=e.inlineProperties}},FP=class{constructor(e){this.segmentPropertyMap=e;var r;let{inlineProperties:t}=e;t!==void 0&&(this.inlineIdToIndex=Fz(t.ids)),this.tags=t==null?void 0:t.properties.find(i=>i.type==="tags"),this.labels=t==null?void 0:t.properties.find(i=>i.type==="label"),this.numericalProperties=(r=t==null?void 0:t.properties.filter(i=>i.type==="number"))!=null?r:[]}getSegmentInlineIndex(e){let{inlineIdToIndex:t}=this;return t===void 0?-1:Uz(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){let t=this.getSegmentInlineIndex(e);if(t===-1)return;let{labels:r,tags:i}=this,a="";if(r!==void 0&&(a=r.values[t]),i!==void 0){let{tags:o,values:l}=i,c=l[t];for(let d=0,p=c.length;d<p;++d){let m=o[c.charCodeAt(d)];a.length>0&&(a+=" "),a+="#",a+=m}}if(a.length!==0)return a}};function UP(n,e,t){for(let r=0,i=t.length;r<i;++r)e[t[r]]=n[r]}function Wz(n){let e=n.length;if(e===0)return!0;let t=n[0],r=n[1];for(let i=0;i<e;i+=2){let a=n[i],o=n[i+1];if((o-r||a-t)<=0)return!1;t=a,r=o}return!0}function WP(n){let{ids:e}=n;if(Wz(e))return n;let t=e.length/2,r=gm(t,t-1);for(let o=0;o<t;++o)r[o]=o;r.sort((o,l)=>{let c=e[o*2],d=e[o*2+1],p=e[l*2],m=e[l*2+1];return d-m||c-p});let i=new Uint32Array(t*2);for(let o=0;o<t;++o){let l=r[o];i[o*2]=e[l*2],i[o*2+1]=e[l*2+1]}let a=n.properties.map(o=>{let{values:l}=o,c=new l.constructor(t);for(let d=0;d<t;++d)c[d]=l[r[d]];return{...o,values:c}});return{ids:i,properties:a}}function Gz(n,e,t){let r=new Array(e);return r.fill(""),UP(n.values,r,t),{...n,values:r}}function zz(n,e,t){let r=new Float32Array(e);return r.fill(Number.NaN),UP(n.values,r,t),{...n,values:r}}function GP(n,e,t){let{type:r}=n;return r==="label"||r==="description"||r==="string"||r==="tags"?Gz(n,e,t):zz(n,e,t)}function Hz(n,e){if(n===void 0)return e;if(e===void 0)return n;let t=0,r=n.ids.length/2,i=e.ids.length/2,a=new Uint32Array(r),o=new Uint32Array(i),l=n.ids,c=e.ids;FT(r,i,(m,y)=>{let v=l[2*m+1],b=l[2*m],x=c[2*y+1],C=c[2*y];return v-x||b-C},m=>{a[m]=t,++t},m=>{o[m]=t,++t},(m,y)=>{a[m]=t,o[y]=t,++t});let d;if(t===r)d=l;else if(t===i)d=c;else{d=new Uint32Array(t*2);for(let m=0;m<r;++m){let y=a[m];d[2*y]=l[2*m],d[2*y+1]=l[2*m+1]}for(let m=0;m<i;++m){let y=o[m];d[2*y]=c[2*m],d[2*y+1]=c[2*m+1]}}let p=[];if(t===r)p.push(...n.properties);else for(let m of n.properties)p.push(GP(m,t,a));if(t===i)p.push(...e.properties);else for(let m of e.properties)p.push(GP(m,t,o));return{ids:d,properties:p}}function $z(n,e){return new ym({inlineProperties:Hz(n.inlineProperties,e.inlineProperties)})}function jz(n){for(;;){if(n.length===0)return;if(n.length===1)return n[0];let e=[];for(let t=0,r=n.length;t<r;t+=2)t+1===r?e.push(n[t]):e.push($z(n[t],n[t+1]));n=e}}function zP(n,e){return n.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>pt(t))},()=>{let t=jz(e);if(t!==void 0)return new FP(t)})}var Jz=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function HP(n,e){var p;if(e.match(Jz)!==null){let m=e.split(/[\s,]+/),y=[],v=new Set;for(let b=0,x=m.length;b<x;++b){let C=m[b];if(C==="")continue;let L=new X;if(!L.tryParseString(C))continue;let A=L.toString();v.has(A)||(v.add(A),y.push(L))}return y.sort(X.compare),{ids:y}}let t={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=(p=n==null?void 0:n.segmentPropertyMap.inlineProperties)==null?void 0:p.properties,i=n==null?void 0:n.tags,a=(i==null?void 0:i.tags)||[],o=a.map(m=>m.toLowerCase()),l=n==null?void 0:n.labels,c=[],d;for(let m=0;m<e.length;m=d){let y=e.indexOf(" ",m),v;if(y===-1?d=y=e.length:d=y+1,v=e.substring(m,y),v.length===0)continue;let b=(C,L)=>{let A=C.toLowerCase(),D=o.indexOf(A);if(D===-1){c.push({begin:L,end:y,message:`Invalid tag: ${C}`});return}if(C=a[D],t.includeTags.includes(C)||t.excludeTags.includes(C)){c.push({begin:L,end:y,message:`Duplicate tag: ${C}`});return}return C};if(v.startsWith("#")){let C=b(v.substring(1),m+1);C!==void 0&&t.includeTags.push(C);continue}if(v.startsWith("-#")){let C=b(v.substring(2),m+2);C!==void 0&&t.excludeTags.push(C);continue}if(v.startsWith("<")||v.startsWith(">")){let C=v.substring(1).toLowerCase();if(C!=="id"&&C!=="label"){let L=r==null?void 0:r.find(A=>A.id.toLowerCase()===C&&(A.type==="number"||A.type==="label"||A.type==="string"));if(L===void 0){c.push({begin:m+1,end:y,message:`Invalid field: ${C}`});continue}C=L.id}if(t.sortBy.find(L=>L.fieldId===C)!==void 0){c.push({begin:m+1,end:y,message:`Duplicate sort field: ${C}`});continue}t.sortBy.push({order:v[0],fieldId:C});continue}if(v.startsWith("|")){let C=v.substring(1).toLowerCase();if(C==="id"||C==="label")continue;let L=r==null?void 0:r.find(A=>A.id.toLowerCase()===C&&(A.type==="number"||A.type==="string"));if(L===void 0){c.push({begin:m+1,end:y,message:`Invalid field: ${C}`});continue}if(C=L.id,t.sortBy.find(A=>A.fieldId===C)||t.includeColumns.find(A=>A===C))continue;t.includeColumns.push(C);continue}if(v.startsWith("/")){if(t.regexp!==void 0){c.push({begin:m,end:y,message:"Only one regular expression allowed"});continue}if(t.prefix!==void 0){c.push({begin:m,end:y,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:m,end:y,message:"No label property"});continue}try{t.regexp=new RegExp(v.substring(1))}catch(C){c.push({begin:m,end:y,message:"Invalid regular expression syntax"})}continue}let x=v.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(x!==null){let C=x[1].toLowerCase(),L=x[2],A=n==null?void 0:n.numericalProperties.find(B=>B.id.toLowerCase()===C);if(A===void 0){c.push({begin:m,end:m+C.length,message:`Invalid numerical field: ${C}`});continue}C=A.id;let D;try{D=Ua(A.dataType,x[3])}catch(B){c.push({begin:m+x[1].length+x[2].length,end:y,message:B.message});continue}let R=t.numericalConstraints.find(B=>B.fieldId===C);R===void 0&&(R={fieldId:C,bounds:A.bounds},t.numericalConstraints.push(R));let P=Es(A.bounds,R.bounds[0]),E=Es(A.bounds,R.bounds[1]),V=E,O=P;switch(L){case"<":V=ju(A.dataType,D,-1);break;case"<=":V=D;break;case"=":V=O=D;break;case">=":O=D;break;case">":O=ju(A.dataType,D,1);break}if(O=cr(P,O)>0?P:O,V=cr(E,V)<0?E:V,cr(O,V)>0){c.push({begin:m,end:y,message:"Constraint would not match any values"});continue}R.bounds=[O,V];continue}if(t.regexp!==void 0){c.push({begin:m,end:y,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:m,end:y,message:"No label property"});continue}t.prefix!==void 0?t.prefix+=` ${v}`:t.prefix=v}return c.length>0?{errors:c}:(t.sortBy.length===0&&t.sortBy.push({fieldId:JP(n),order:"<"}),t)}function yb(n){return"\\u"+n.toString(16).padStart(4,"0")}function $P(n,e){var L;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){let{ids:A}=e;return{query:e,total:-1,explicitIds:A,count:A.length}}let t=(L=n==null?void 0:n.segmentPropertyMap)==null?void 0:L.inlineProperties;if(t===void 0)return{query:e,count:0,total:-1};let r=t==null?void 0:t.properties,i=t.ids.length/2,a=gm(i,i);for(let A=0;A<i;++A)a[A]=A;let o=A=>{let D=a.length,R=0;for(let P=0;P<D;++P){let E=a[P];A(E)&&(a[R]=E,++R)}a=a.subarray(0,R)};if(e.regexp!==void 0||e.prefix!==void 0){let A=n.labels.values,{regexp:D,prefix:R}=e;D!==void 0&&o(P=>A[P].match(D)!==null),R!==void 0&&o(P=>A[P].startsWith(R))}let{includeTags:l,excludeTags:c}=e,d=n.tags;if(l.length>0||c.length>0){let{values:A,tags:D}=d,R=[];for(let B of l)R.push([D.indexOf(B),1]);for(let B of c)R.push([D.indexOf(B),0]);R.sort((B,W)=>B[0]-W[0]);let P="^",E=0,V=B=>{B<E||(P+=`[${yb(E)}-${yb(B)}]*`)};for(let[B,W]of R)V(B-1),W&&(P+=yb(B)),E=B+1;V(65535),P+="$";let O=new RegExp(P);o(B=>A[B].match(O)!==null)}let p,m,{numericalConstraints:y}=e;if(y.length>0){let A=n.numericalProperties,D=y.length,R=2**D-1;p=gm(a.length,R);for(let V=0;V<D;++V){let O=y[V],B=A.find(J=>J.id===O.fieldId),{values:W}=B,_=2**V,[F,N]=O.bounds;for(let J=0,re=a.length;J<re;++J){let pe=W[a[J]];p[J]|=_*(pe>=F&&pe<=N)}}m=a,a=m.slice();let P=a.length,E=0;for(let V=0;V<P;++V)p[V]===R&&(a[E]=a[V],++E);a=a.subarray(0,E)}let v=[];if(d!==void 0){let A=[],{tags:D,values:R}=d,P=new Uint32Array(D.length);for(let E=0,V=a.length;E<V;++E){let O=R[a[E]];for(let B=0,W=O.length;B<W;++B)++P[O.charCodeAt(B)]}for(let E=0,V=D.length;E<V;++E){let O=P[E],B=D[E],W={tag:B,tagIndex:E,count:P[E]};e.includeTags.includes(B)||e.excludeTags.includes(B)?A.push(W):O>0&&v.push(W)}A.push(...v),v=A}let b=(A,D)=>{if(A.type!=="number"){let{values:R}=A;a.sort((P,E)=>Qa(R[P],R[E])*D)}else{let R=A.values;a.sort((P,E)=>(R[P]-R[E])*D)}},x=A=>{d!==void 0&&b(d,A);let D=n==null?void 0:n.labels;D!==void 0&&b(D,A)},{sortBy:C}=e;for(let A=C.length-1;A>=0;--A){let{fieldId:D,order:R}=C[A],P=R==="<"?1:-1;if(D==="id"){if(A+1===C.length){if(R==="<")continue;a.reverse();continue}a.sort((E,V)=>P*(E-V));continue}else D==="label"?x(P):b(r.find(E=>E.id===D),P)}return{query:e,intermediateIndices:m,intermediateIndicesMask:p,indices:a,tags:v,count:a.length,total:i}}function qz(n,e,t){let r=256,{values:i}=e,[a,o]=t,l=o<=a?0:r/(o-a),c=new Uint32Array(r+2),{numericalConstraints:d}=n.query,p=d.findIndex(m=>m.fieldId===e.id);if(p===-1){let m=n.indices;for(let y=0,v=m.length;y<v;++y){let b=i[m[y]];isNaN(b)||++c[Math.min(r-1,Math.max(-1,(b-a)*l))+1>>>0]}}else{let m=n.intermediateIndices,y=n.intermediateIndicesMask,v=2**d.length-1-2**p;for(let b=0,x=m.length;b<x;++b)if((y[b]&v)==v){let L=i[m[b]];isNaN(L)||++c[Math.min(r-1,Math.max(-1,(L-a)*l))+1>>>0]}}return{queryResult:n,histogram:c,window:t}}function jP(n,e,t,r){if(n===void 0){t.length=0,r.length=0;return}let{numericalProperties:i}=n,a=i.length;if((e==null?void 0:e.indices)===void 0){t.length=0;return}for(let l=0;l<a;++l){let c=t[l],d=r[l],p=i[l];c!==void 0&&c.queryResult===e&&ii(p.dataType,c.window,d)||(t[l]=qz(e,p,d))}}function JP(n){return(n==null?void 0:n.tags)||(n==null?void 0:n.labels)?"label":"id"}function qP(n,e){let{ids:t}=e;if(t!==void 0)return t.map(l=>l.toString()).join(", ");let r="";e=e;let{prefix:i,regexp:a}=e;i!==void 0?r=i:a!==void 0&&(r=`/${a}`);for(let l of e.includeTags)r.length>0&&(r+=" "),r+=`#${l}`;for(let l of e.excludeTags)r.length>0&&(r+=" "),r+=`-#${l}`;for(let l of e.numericalConstraints){let{fieldId:c,bounds:d}=l,[p,m]=d,y=n.numericalProperties.find(v=>v.id===c);if(!ii(y.dataType,y.bounds,d)){if(cr(p,m)===0){r.length>0&&(r+=" "),r+=`${c}=${p}`;continue}if(cr(p,y.bounds[0])>0){r.length>0&&(r+=" ");let v=ju(y.dataType,p,-1),b=p.toString(),x=v.toString();y.dataType!==z.FLOAT32||b.length<=x.length?r+=`${c}>=${b}`:r+=`${c}>${x}`}if(cr(m,y.bounds[1])<0){r.length>0&&(r+=" ");let v=ju(y.dataType,m,1),b=m.toString(),x=v.toString();y.dataType!==z.FLOAT32||b.length<=x.length?r+=`${c}<=${b}`:r+=`${c}<${x}`}}}let{sortBy:o}=e;if(o.length===1){let l=o[0];l.order==="<"&&l.fieldId===JP(n)&&(o=[])}for(let l of o)r.length>0&&(r+=" "),r+=`${l.order}${l.fieldId}`;for(let l of e.includeColumns)r.length>0&&(r+=" "),r+=`|${l}`;return r}var vb=new X;function Hd(n,e,t){if(e===void 0)return;let{explicitIds:r}=e;if(r!==void 0){r.forEach(t);return}let{indices:i}=e;if(i!==void 0){let{ids:a}=n==null?void 0:n.segmentPropertyMap.inlineProperties;for(let o=0,l=i.length;o<l;++o){let c=i[o];vb.low=a[c*2],vb.high=a[c*2+1],t(vb,o)}}}function YP(n,e,t){if(t.size===0)return 0;let r=0;return Hd(n,e,i=>{t.has(i)&&++r}),r}function Sb(n,e,t,r){let i=n.includeTags.filter(o=>o!==e),a=n.excludeTags.filter(o=>o!==e);return r===!0&&(t?i:a).push(e),{...n,includeTags:i,excludeTags:a}}function KP(n){return n.ids!==void 0?!1:n.errors!==void 0?!0:!(n.numericalConstraints.length>0||n.includeTags.length>0||n.excludeTags.length>0||n.prefix||n.regexp)}function vm(n,e){if(n===void 0||n.ids!==void 0||n.errors!==void 0)return!1;let{sortBy:t,includeColumns:r}=n;return t.find(i=>i.fieldId===e)!==void 0||r.includes(e)}async function Yz(n,e,t,r,i){let a=await Sa(n,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(r)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},St,i);Z(a);let o=de(a,"prefixes",Zt,[]),l=de(a,"items",c=>be(c,d=>(Z(d),j(d,"name",ne))),[]).filter(c=>!c.endsWith("_$folder$"));return[...o,...l]}async function XP(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await Yz(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function Kz(n,e,t,r,i){let a=await Sa(n,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(r)}`,{},p=>p.text(),i),o=new DOMParser().parseFromString(a,"application/xml"),l=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let p=0,m=l.snapshotLength;p<m;++p)c.push(l.snapshotItem(p).textContent||"");let d=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let p=0,m=d.snapshotLength;p<m;++p)c.push(d.snapshotItem(p).textContent||"");return c}async function $d(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await Kz(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}var QP=class extends rn{constructor(e){super();this.bucket=e;this.get=xn(async()=>{var o;let{bucket:e}=this,t=await si(`https://s3.amazonaws.com/${e}?location`,{},l=>l.text()),i=new DOMParser().parseFromString(t,"application/xml").querySelector("LocationConstraint");if(i===null)throw new Error(`Unable to determine location of S3 bucket: ${e}`);return{region:((o=i.textContent)==null?void 0:o.trim())||"us-east-1"}})}},Sm;function bb(n){return Sm===void 0&&(Sm=new Bd,Sm.register("s3",e=>new QP(e))),Sm.getCredentialsProvider("s3",n)}async function ZP(n,e,t,r,i,a=et){let o=await n.get(),{region:l}=o.credentials;return await si(`https://${e}.s3.${l}.amazonaws.com${t}`,r,i,a)}async function eI(n,e,t){let i=await bb(n).get(),{region:a}=i.credentials;return await $d(void 0,`s3://${n}`,`https://${n}.s3.${a}.amazonaws.com`,e,t)}function Xz(n,e){return n.getCredentialsProvider("middleauthapp",new URL(e).origin)}function bm(n,e,t){let r=/^\/([^\/]+)/,i=t.match(r);if(i!==null)return typeof NEUROGLANCER_PYTHON_INTEGRATION!="undefined"?n.getCredentialsProvider("gcs",{bucket:i[1]}):n.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:i[1]})}function Zn(n,e){let t=Hs(n);switch(t.protocol){case"gs":case"gs+xml":return{credentialsProvider:typeof NEUROGLANCER_PYTHON_INTEGRATION!="undefined"?e.getCredentialsProvider("gcs",{bucket:t.host}):void 0,url:n};case"gs+ngauth+http":return{credentialsProvider:bm(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:bm(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:bm(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:bm(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return n=n.substr("middleauth+".length),{credentialsProvider:Xz(e,n),url:n};case"s3":return{credentialsProvider:bb(t.host),url:n};default:return{credentialsProvider:void 0,url:n}}}async function Ni(n,e,t,r,i=et){let a=Hs(e);switch(a.protocol){case"gs":return Sa(n,`https://www.googleapis.com/storage/v1/b/${a.host}/o/${encodeURIComponent(a.path.substring(1))}?alt=media&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,t,r,i);case"gs+xml":return Sa(n,`https://storage.googleapis.com/${a.host}${a.path}`,t,r,i);case"s3":return ZP(n,a.host,a.path,t,r,i);default:return Sa(n,e,t,r,i)}}async function Qz(n,e){let{text:t,contentType:r}=await si(n,{headers:{accept:"text/html"}},async l=>({text:await l.text(),contentType:l.headers.get("content-type")}),e);if(r===null||/\btext\/html\b/i.exec(r)===null)return[];let i=new DOMParser().parseFromString(t,"text/html"),a=i.evaluate("//a/@href",i,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),o=[];for(let l=0,c=a.snapshotLength;l<c;++l){let p=a.snapshotItem(l).textContent;p&&o.push(new URL(p,n).toString())}return o}async function Zz(n,e){let t=n.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(t===null)throw null;let r=await Qz(t[1],e),i=t[1].length,a=[];for(let o of r)!o.startsWith(n)||a.push({value:o.substring(i)});return{offset:i,completions:a}}var e6=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function hi(n,e,t){if(!e.includes("://"))return{offset:0,completions:tn(e,e6,m=>m.value,m=>m.description)};let{url:r,credentialsProvider:i}=Zn(e,n),a=e.length-r.length,o;try{o=Hs(r)}catch{throw null}let{protocol:l,host:c,path:d}=o,p=await(async()=>{if(l==="gs+xml"&&d.length>0)return await $d(i,`${l}://${c}`,`https://storage.googleapis.com/${c}`,d,t);if(l==="gs"&&d.length>0)return await XP(i,`${l}://${c}`,c,d,t);if(l==="s3"&&d.length>0)return await eI(c,d,t);let m=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(m!==null)return await $d(i,m[1],m[1],m[2],t);if((l==="http"||l==="https")&&d.length>0)return await Zz(r,t);throw null})();return{offset:a+p.offset,completions:p.completions}}var tI=class extends ut(gt()(_n),lm){},nI=class extends ut(gt()(Yr),cm){},rI=class extends ut(gt()(eo),dm){},iI=class extends ut(gt()(to),pm){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}};function tl(n,e){let t=n.split("/");for(let r of e.split("/")){if(r===".."&&t.length!==0){t.length=t.length-1;continue}t.push(r)}return t.join("/")}var aI=class{constructor(e,t){Z(e);let r=t===1?3:4,i=this.resolution=new Float64Array(r),a=this.voxelOffset=new Float32Array(r),o=this.size=new Float32Array(r);if(r===4&&(i[3]=1,o[3]=t),j(e,"resolution",c=>$e(i.subarray(0,3),c,dt)),de(e,"voxel_offset",c=>$e(a.subarray(0,3),c,yt)),j(e,"size",c=>$e(o.subarray(0,3),c,Rt)),this.chunkSizes=j(e,"chunk_sizes",c=>be(c,d=>{let p=new Uint32Array(r);return r===4&&(p[3]=t),$e(p.subarray(0,3),d,Rt),p})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=j(e,"sharding",xm),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=j(e,"encoding",c=>Bt(c,Gd)))===Gd.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=j(e,"compressed_segmentation_block_size",c=>$e(K.create(),c,Rt))),this.key=j(e,"key",ne)}};function t6(n){Z(n);let e=j(n,"data_type",L=>Bt(L,z)),t=j(n,"num_channels",Rt),r=j(n,"type",L=>Bt(L,ot)),i=j(n,"mesh",Yt),a=j(n,"skeletons",Yt),o=j(n,"segment_properties",Yt),l=j(n,"scales",L=>be(L,A=>new aI(A,t)));if(l.length===0)throw new Error("Expected at least one scale");let c=l[0],d=t===1?3:4,p=new Float64Array(d),m=new Float64Array(d),y=new Float64Array(d),v=["x","y","z"],b=["m","m","m"];for(let L=0;L<3;++L)p[L]=c.resolution[L]/1e9,m[L]=c.voxelOffset[L],y[L]=m[L]+c.size[L];d===4&&(p[3]=1,y[3]=t,v[3]="c^",b[3]="");let C=Ve({rank:d,names:v,units:b,scales:p,boundingBoxes:[ur({lowerBounds:m,upperBounds:y})]});return{dataType:e,volumeType:r,mesh:i,skeletons:a,segmentPropertyMap:o,scales:l,modelSpace:C}}var oI=class extends Ft{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){let t=this.info.scales[0].resolution,{rank:r}=this;return Tr(this.info.scales.map(i=>{let{resolution:a}=i,o=r+1,l=new Float32Array(o*o);l[l.length-1]=1;let{lowerBounds:c,upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,p=new Float32Array(r),m=new Float32Array(r);for(let y=0;y<3;++y){let v=a[y]/t[y];l[o*y+y]=v;let b=i.voxelOffset[y];l[o*r+y]=b*v,p[y]=c[y]/v-b,m[y]=d[y]/v-b}return r===4&&(l[o*3+3]=1,p[3]=c[3],m[3]=d[3]),fi({rank:r,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:i.chunkSizes,baseVoxelOffset:i.voxelOffset,compressedSegmentationBlockSize:i.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(y=>({chunkSource:this.chunkManager.getChunkSource(tI,{credentialsProvider:this.credentialsProvider,spec:y,parameters:{url:tl(this.url,i.key),encoding:i.encoding,sharding:i.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:p,upperClipBound:m}))}))}},n6=ut(gt()(Ri),hm),sI=class extends ut(gt()(zs),fm){},lI=class extends n6{constructor(e,t){let{parameters:r}=t;super(e,{rank:r.rank,relationships:r.relationships.map(i=>i.name),properties:r.properties,parameters:r});this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{let{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(sI,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}};function r6(n,e,t){return n.getChunkSource(nI,{parameters:t,credentialsProvider:e})}function cI(n){return j(n,"transform",e=>{let t=ie.create();return e!==void 0&&$e(t.subarray(0,12),e,Ze),ie.transpose(t,t),t})}function i6(n){Z(n);let e=j(n,"@type",ne),t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=j(n,"lod_scale_multiplier",dt),a=j(n,"vertex_quantization_bits",Rt),o=cI(n),l=j(n,"sharding",xm);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=j(n,"segment_properties",Yt);return{metadata:t,segmentPropertyMap:r}}async function a6(n,e,t){let r;try{r=await Tc(n,e,t)}catch(i){if($s(i))return{metadata:void 0};throw i}return i6(r)}function uI(n){return n===void 0?zd.RAW:Bt(n,zd)}function xm(n){if(n===void 0)return;Z(n);let e=j(n,"@type",ne);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=j(n,"hash",c=>Bt(c,um)),r=j(n,"preshift_bits",yt),i=j(n,"shard_bits",yt),a=j(n,"minishard_bits",yt),o=j(n,"minishard_index_encoding",uI),l=j(n,"data_encoding",uI);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function o6(n){Z(n);let e=j(n,"@type",ne);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${JSON.stringify(e)}`);let t=cI(n),r=new Map;j(n,"vertex_attributes",o=>{o!==void 0&&be(o,l=>{Z(l);let c=j(l,"id",ne);if(c==="")throw new Error("vertex attribute id must not be empty");if(r.has(c))throw new Error(`duplicate vertex attribute id ${JSON.stringify(c)}`);let d=j(l,"data_type",m=>Bt(m,z)),p=j(l,"num_components",Rt);r.set(c,{dataType:d,numComponents:p})})});let i=j(n,"sharding",xm),a=j(n,"segment_properties",Yt);return{metadata:{transform:t,vertexAttributes:r,sharding:i},segmentPropertyMap:a}}async function s6(n,e,t){let r=await Tc(n,e,t);return o6(r)}function dI(){return Ve({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function pI(n,e,t){let{metadata:r,segmentPropertyMap:i}=await a6(n,e,t);if(r===void 0)return{source:r6(n,e,{url:t,lod:0}),transform:ie.create(),segmentPropertyMap:i};let a,{vertexQuantizationBits:o}=r;if(o===10)a=li.uint10;else if(o===16)a=li.uint16;else throw new Error(`Invalid vertex quantization bits: ${o}`);return{source:n.getChunkSource(rI,{credentialsProvider:e,parameters:{url:t,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:a}}),transform:r.transform,segmentPropertyMap:i}}async function fI(n,e,t){let{metadata:r,segmentPropertyMap:i}=await s6(n,e,t);return{source:n.getChunkSource(iI,{credentialsProvider:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:i}}function Tc(n,e,t){return n.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:pt(e)},async()=>await Ni(e,`${t}/info`,{},St))}function hI(n){let e=ie.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function l6(n,e,t,r){let i=t6(r),a=new oI(n.chunkManager,e,t,i),{modelSpace:o}=i,l=[{id:"default",default:!0,subsource:{volume:a}},{id:"bounds",default:!0,subsource:{staticAnnotations:zn(o.bounds)}}];if(i.segmentPropertyMap!==void 0){let c=tl(t,i.segmentPropertyMap),d=await Tc(n.chunkManager,e,c),p=Cm(n.chunkManager,e,d,c);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:p}})}if(i.mesh!==void 0){let c=tl(t,i.mesh),{source:d,transform:p}=await pI(n.chunkManager,e,c),m=hI(i);ie.multiply(m,m,p),l.push({id:"mesh",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}if(i.skeletons!==void 0){let c=tl(t,i.skeletons),{source:d,transform:p}=await fI(n.chunkManager,e,c),m=hI(i);ie.multiply(m,m,p),l.push({id:"skeletons",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}return{modelTransform:wt(o),subsources:l}}async function c6(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await fI(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=tl(t,a),c=await Tc(n.chunkManager,e,l),d=Cm(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:wt(dI()),subsources:o}}function xb(n,e){return Z(e),{url:tl(n,j(e,"key",ne)),sharding:j(e,"sharding",xm)}}var mI=class{constructor(e,t){this.url=e;Z(t);let r=j(t,"dimensions",Qu),{rank:i}=r,a=j(t,"lower_bound",l=>$e(new Float64Array(i),l,Ze)),o=j(t,"upper_bound",l=>$e(new Float64Array(i),l,Ze));this.coordinateSpace=Ve({rank:i,names:r.names,units:r.units,scales:r.scales,boundingBoxes:[ur({lowerBounds:a,upperBounds:o})]}),this.parameters={type:j(t,"annotation_type",l=>Bt(l,Re)),rank:i,relationships:j(t,"relationships",l=>be(l,c=>{let d=xb(e,c),p=j(c,"id",ne);return{...d,name:p}})),properties:j(t,"properties",Mf),byId:j(t,"by_id",l=>xb(e,l))},this.spatialIndices=j(t,"spatial",l=>be(l,c=>{let d=xb(e,c),p=j(c,"grid_shape",C=>$e(new Float32Array(i),C,Rt)),m=j(c,"chunk_size",C=>$e(new Float32Array(i),C,dt)),y=j(c,"limit",Rt),v=new Float32Array(i);for(let C=0;C<i;++C)v[C]=p[C]*m[C];let b=Hn(Float32Array,i+1);for(let C=0;C<i;++C)b[(i+1)*i+C]=a[C];let x={limit:y,chunkToMultiscaleTransform:b,...oc({rank:i,chunkDataSize:m,upperVoxelBound:v})};return x.upperChunkBound=p,{parameters:d,spec:x,limit:y}})),this.spatialIndices.reverse()}};async function u6(n,e,t,r){let i=new mI(t,r);return{modelTransform:wt(i.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:n.chunkManager.getChunkSource(lI,{credentialsProvider:e,metadata:i,parameters:i.parameters})}}]}}async function gI(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await pI(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=tl(t,a),c=await Tc(n.chunkManager,e,l),d=Cm(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:wt(dI()),subsources:o}}function d6(n){Z(n);let e=new X,t=j(n,"ids",a=>{a=Zt(a);let o=a.length,l=new Uint32Array(o*2);for(let c=0;c<o;++c){if(!e.tryParseString(a[c]))throw new Error(`Invalid uint64 id: ${JSON.stringify(a[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),r=t.length/2,i=j(n,"properties",a=>be(a,o=>{Z(o);let l=j(o,"id",ne),c=de(o,"description",ne),d=j(o,"type",m=>{if(m!=="label"&&m!=="description"&&m!=="string"&&m!=="tags"&&m!=="number")throw new Error(`Invalid property type: ${JSON.stringify(m)}`);return m});if(d==="tags"){let m=j(o,"tags",Zt),y=de(o,"tag_descriptions",Zt);if(y===void 0)y=new Array(m.length),y.fill("");else if(y.length!==m.length)throw new Error(`Expected tag_descriptions to have length: ${m.length}`);let v=j(o,"values",b=>{if(!Array.isArray(b)||b.length!==r)throw new Error(`Expected ${r} values, but received: ${b.length}`);return b.map(x=>String.fromCharCode(...x))});return{id:l,description:c,type:d,tags:m,tagDescriptions:y,values:v}}if(d==="number"){let m=j(o,"data_type",x=>Bt(x,z));if(m===z.UINT64)throw new Error("uint64 properties not supported");let y=j(o,"values",x=>{if(!Array.isArray(x)||x.length!==r)throw new Error(`Expected ${r} values, but received: ${x.length}`);return fk[m].from(x)}),v=Infinity,b=-Infinity;for(let x=y.length-1;x>=0;--x){let C=y[x];C<v&&(v=C),C>b&&(b=C)}return{id:l,description:c,type:d,dataType:m,values:y,bounds:[v,b]}}let p=j(o,"values",m=>{if(Zt(m),m.length!==r)throw new Error(`Expected ${r} values, but received: ${m.length}`);return m});return{id:l,description:c,type:d,values:p}}));return WP({ids:t,properties:i})}var coe=ut(gt()(gb),mm);function Cm(n,e,t,r){try{let i=j(t,"@type",ne);if(i!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${JSON.stringify(i)}`);let a=de(t,"inline",d6);return new ym({inlineProperties:a})}catch(i){throw new Error(`Error parsing segment property map: ${i.message}`)}}async function p6(n,e,t,r){return{modelTransform:wt(ki),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Cm(n.chunkManager,e,r,t)}}]}}var f6=/^([^#]*)(?:#(.*))?$/;function Cb(n){let[,e,t]=n.match(f6);e.endsWith("/")&&(e=e.substring(0,e.length-1));let r=ni(t||"");return{url:e,parameters:r}}function yI(n,e){let t=yk(e);return t&&(n+=`#${t}`),n}var wb=class extends Vt{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){let{url:t,parameters:r}=Cb(e.providerUrl);return e.providerProtocol+"://"+yI(t,r)}convertLegacyUrl(e){let{url:t,parameters:r}=Cb(e.providerUrl);return e.type==="mesh"&&(r.type="mesh"),e.providerProtocol+"://"+yI(t,r)}get(e){let{url:t,parameters:r}=Cb(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=Zn(t,e.credentialsManager),o;try{o=await Tc(e.chunkManager,a,i)}catch(d){if($s(d)&&r.type==="mesh")return await gI(e,a,i);throw d}Z(o);let l=de(o,"redirect",ne);if(l!==void 0)throw new Sh(l);let c=de(o,"@type",ne);switch(c){case"neuroglancer_skeletons":return await c6(e,a,i);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await gI(e,a,i);case"neuroglancer_annotations_v1":return await u6(e,a,i,o);case"neuroglancer_segment_properties":return await p6(e,a,i,o);case"neuroglancer_multiscale_volume":case void 0:return await l6(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}completeUrl(e){return hi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ut("precomputed",()=>new wb);var vI="nifti/getNiftiVolumeInfo",wm=class{};wm.RPC_ID="nifti/VolumeChunkSource";var SI=class extends ut(gt()(_n),wm){},bI=class extends Ft{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return ot.UNKNOWN}get rank(){return this.info.rank}getSources(e){let{info:t}=this,r=Hn(Float32Array,t.rank+1),i=eb({rank:t.rank,volumeType:ot.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:r,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(SI,{credentialsProvider:this.credentialsProvider,spec:i,parameters:{url:this.url}}),chunkToMultiscaleTransform:r}]]}};function h6(n,e,t,r){return n.rpc.promiseInvoke(vI,{chunkManager:n.addCounterpartRef(),credentialsProvider:xd(n,e),url:t},r)}function m6(n,e,t){return n.memoize.getUncounted({type:"nifti/getVolume",url:t},async()=>{let{url:r,credentialsProvider:i}=Zn(t,e),a=await h6(n,i,r,et),o=new bI(n,i,r,a),l={lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.volumeSize)},c=Ve({rank:a.rank,names:a.sourceNames,scales:a.sourceScales,units:a.units,boundingBoxes:[ur(l)]}),d=Ve({rank:a.rank,names:a.viewNames,scales:a.viewScales,units:a.units});return{subsources:[{id:"default",default:!0,subsource:{volume:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:zn(l)}}],modelTransform:{sourceRank:a.rank,rank:a.rank,inputSpace:c,outputSpace:d,transform:a.transform}}})}var Tb=class extends Vt{get description(){return"Single NIfTI file"}get(e){return m6(e.chunkManager,e.credentialsManager,e.providerUrl)}completeUrl(e){return hi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ut("nifti",()=>new Tb);var jd;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(jd||(jd={}));var Tm=class{};Tm.RPC_ID="n5/VolumeChunkSource";var xI=class extends ut(gt()(_n),Tm){},CI=class extends Ft{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.multiscaleMetadata=r;this.scales=i;let a,o;if(i.forEach((m,y)=>{if(m!==void 0){if(o===void 0&&(o=y),a!==void 0&&m.dataType!==a)throw new Error(`Scale s${y} has data type ${z[m.dataType]} but expected ${z[a]}.`);a=m.dataType}}),a===void 0)throw new Error("At least one scale must be specified.");let l=r.scales[o],c=i[o];this.dataType=a,this.volumeType=ot.IMAGE,this.baseScaleIndex=o;let d=r.modelSpace,{rank:p}=d;this.modelSpace=Ve({names:d.names,scales:d.scales,units:d.units,boundingBoxes:[{transform:Cv(Float64Array,l.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(p),upperBounds:new Float64Array(c.size)}}],coordinateArrays:d.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){let{}=this,{scales:t,rank:r}=this,i=this.multiscaleMetadata.scales;return Tr(t.filter(a=>a!==void 0).map((a,o)=>{let l=i[o],c=Cv(Float32Array,l.downsamplingFactor);return fi({rank:r,chunkToMultiscaleTransform:c,dataType:a.dataType,upperVoxelBound:a.size,volumeType:this.volumeType,chunkDataSizes:[a.chunkSize],volumeSourceOptions:e}).map(d=>({chunkSource:this.chunkManager.getChunkSource(xI,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:l.url,encoding:a.encoding}}),chunkToMultiscaleTransform:c}))}))}},wI=class{constructor(e){Z(e),this.dataType=j(e,"dataType",r=>Bt(r,z)),this.size=Float32Array.from(j(e,"dimensions",r=>be(r,Rt))),this.chunkSize=j(e,"blockSize",r=>$e(new Uint32Array(this.size.length),r,Rt));let t;de(e,"compression",r=>{t=j(r,"type",i=>Bt(i,jd))}),t===void 0&&(t=j(e,"compressionType",r=>Bt(r,jd))),this.encoding=t}};function g6(n,e,t){return Promise.all(t.scales.map(async r=>{let i=await TI(n,e,r.url,!0);if(i!==void 0)return new wI(i)}))}function y6(n){let{protocol:e,host:t,path:r}=Hs(n);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=[];for(;;){i.push(`${e}://${t}${r}/attributes.json`);let a=r.lastIndexOf("/");if(a===-1)break;r=r.substring(0,a)}return i}function v6(n,e,t,r){return n.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:pt(e)},()=>Ni(e,t,{},St).then(i=>{try{return Z(i)}catch(a){throw new Error(`Error reading attributes from ${t}: ${a.message}`)}}).catch(i=>{if($s(i))return r?void 0:{};throw i}))}async function TI(n,e,t,r){let i=y6(t),a=await Promise.all(i.map((o,l)=>v6(n,e,o,r&&l===i.length-1)));if(a.indexOf(void 0)===-1)return a.reverse(),Object.assign({},...a)}function Ko(n,e){if(n!==-1&&e!==n)throw new Error(`Rank mismatch, received ${e} but expected ${n}`);return e}function LI(n){return Float64Array.from(be(n,dt))}function kI(n){let e=Wr(n);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:be(e,i=>{let a=LI(i);return t=Ko(t,a.length),a}),single:void 0,rank:t}}function S6(n){let e=Wr(n);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return kI(e);let t=LI(n);return{all:void 0,single:t,rank:t.length}}var b6=["x","y","z","t","c"];function x6(n){let e=b6.slice(0,n);for(;e.length<n;)e.push(`d${e.length+1}`);return e}function C6(n,e){Z(e);let t=-1,r=de(e,"resolution",y=>{let v=Float64Array.from(be(y,dt));return t=Ko(t,v.length),v}),i=de(e,"axes",y=>{let v=be(y,ne);return t=Ko(t,v.length),v}),a=de(e,"units",y=>{let v=be(y,jf);return t=Ko(t,v.length),v}),o={unit:"m",exponent:-9},l,c;de(e,"downsamplingFactors",y=>{let{single:v,all:b,rank:x}=S6(y);t=Ko(t,x),v!==void 0&&(l=v),b!==void 0&&(c=b)}),de(e,"pixelResolution",y=>{o=j(y,"unit",jf),de(y,"dimensions",v=>{r=Float64Array.from(be(v,dt)),t=Ko(t,r.length)})}),de(e,"scales",y=>{let{all:v,rank:b}=kI(y);t=Ko(t,b),c=v});let d=de(e,"dimensions",y=>{let v=be(y,Rt);return t=Ko(t,v.length),v});if(t===-1)throw new Error("Unable to determine rank of dataset");a===void 0&&(a=new Array(t),a.fill(o)),r===void 0&&(r=new Float64Array(t),r.fill(1));for(let y=0;y<t;++y)r[y]=Xu(r[y],a[y].exponent);let p=new Array(t);i!==void 0&&de(e,"coordinateArrays",y=>{Z(y);for(let v=0;v<t;++v){let b=i[v];if(Object.prototype.hasOwnProperty.call(y,b)){let x=Zt(y[b]);p[v]={explicit:!1,labels:x,coordinates:Array.from(x,(C,L)=>L)},a[v]={unit:"",exponent:0},r[v]=1}}}),i===void 0&&(i=x6(t));let m=Ve({rank:t,valid:!0,names:i,scales:r,units:a.map(y=>y.unit),coordinateArrays:p});if(d===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:m,url:n,attributes:e,scales:c.map((y,v)=>({url:`${n}/s${v}`,downsamplingFactor:y}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:m,url:n,attributes:e,scales:[{url:n,downsamplingFactor:l}]}}var Lb=class extends Vt{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{let{url:r,credentialsProvider:i}=Zn(t,e.credentialsManager),a=await TI(e.chunkManager,i,r,!1),o=C6(r,a),l=await g6(e.chunkManager,i,o),c=new CI(e.chunkManager,i,o,l);return{modelTransform:wt(c.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:c}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:zn(c.modelSpace.bounds)}}]}})}completeUrl(e){return hi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ut("n5",()=>new Lb);var nl;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(nl||(nl={}));var Lm=class{};Lm.RPC_ID="zarr/VolumeChunkSource";var no=new Map;no.set("|u1",{endianness:fn.LITTLE,dataType:z.UINT8});no.set("|i1",{endianness:fn.LITTLE,dataType:z.INT8});for(let[n,e]of[["<",fn.LITTLE],[">",fn.BIG]]){for(let t of["u","i"])no.set(`${n}${t}8`,{endianness:e,dataType:z.UINT64});no.set(`${n}u2`,{endianness:e,dataType:z.UINT16}),no.set(`${n}i2`,{endianness:e,dataType:z.INT16}),no.set(`${n}u4`,{endianness:e,dataType:z.UINT32}),no.set(`${n}i4`,{endianness:e,dataType:z.INT32}),no.set(`${n}f4`,{endianness:e,dataType:z.FLOAT32})}function EI(n){let e=no.get(n);if(e===void 0)throw new Error(`Unsupported numpy data type: ${JSON.stringify(n)}`);return e}var DI=class extends ut(gt()(_n),Lm){};function PI(n){return de(n,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${JSON.stringify(e)}`);return e})}function w6(n){try{Z(n),j(n,"zarr_format",l=>{if(l!==2)throw new Error(`Expected 2 but received: ${JSON.stringify(l)}`)});let e=j(n,"shape",l=>be(l,c=>{if(typeof c!="number"||!Number.isInteger(c)||c<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(c)}`);return c})),t=j(n,"chunks",l=>$e(new Array(e.length),l,c=>{if(typeof c!="number"||!Number.isInteger(c)||c<=0)throw new Error(`Expected positive integer, but received: ${JSON.stringify(c)}`);return c})),r=j(n,"order",l=>{if(l!=="C"&&l!=="F")throw new Error(`Expected "C" or "F", but received: ${JSON.stringify(l)}`);return l}),i=PI(n),a=j(n,"dtype",l=>EI(ne(l))),o=j(n,"compressor",l=>{if(l===null)return nl.RAW;Z(l);let c=j(l,"id",ne);switch(c){case"blosc":return nl.BLOSC;case"gzip":return nl.GZIP;case"zlib":return nl.GZIP;default:throw new Error(`Unsupported compressor: ${JSON.stringify(c)}`)}});return{rank:e.length,shape:e,chunks:t,order:r,dataType:a.dataType,encoding:{compressor:o,endianness:a.endianness},dimensionSeparator:i}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}var II=class extends Ft{constructor(e,t,r,i,a,o){super(e);this.credentialsProvider=t;this.url=r;this.separator=i;this.metadata=a;this.attrs=o;this.dataType=a.dataType,this.volumeType=ot.IMAGE;let l=de(o,"_ARRAY_DIMENSIONS",c=>$e(new Array(a.rank),c,ne));l===void 0&&(l=Array.from(a.shape,(c,d)=>`d${d}`)),this.modelSpace=Ve({names:l,scales:Float64Array.from(a.shape,()=>1),units:Array.from(a.shape,()=>""),boundingBoxes:[ur({lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.shape)})]})}get rank(){return this.metadata.rank}getSources(e){let{metadata:t}=this,{rank:r,chunks:i,shape:a}=t,o,l,c;if(t.order==="F")o=Uint32Array.from(i),l=Float32Array.from(a),c=Hn(Float32Array,r+1);else{o=new Uint32Array(r),l=new Float32Array(r),c=new Float32Array((r+1)**2),c[(r+1)**2-1]=1;for(let d=0;d<r;++d)o[d]=i[r-1-d],l[d]=a[r-1-d],c[d+(r-1-d)*(r+1)]=1}return Tr([fi({rank:r,chunkToMultiscaleTransform:c,dataType:t.dataType,upperVoxelBound:l,volumeType:this.volumeType,chunkDataSizes:[o],volumeSourceOptions:e}).map(d=>({chunkSource:this.chunkManager.getChunkSource(DI,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:this.url,encoding:t.encoding,separator:this.separator}}),chunkToMultiscaleTransform:c}))])}};function T6(n,e,t){return n.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:pt(e)},async()=>{try{let r=await Ni(e,t+"/.zattrs",{},St);return Z(r),r}catch(r){if($s(r))return{};throw r}})}function L6(n,e,t){return n.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:pt(e)},async()=>{let r=await Ni(e,t+"/.zarray",{},St);return w6(r)})}var k6=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}],kb=class extends Vt{get description(){return"Zarr data source"}get(e){let[,t,r]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),i=ni(r||"");Z(i);let a=PI(i);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:a},async()=>{let{url:o,credentialsProvider:l}=Zn(t,e.credentialsManager),[c,d]=await Promise.all([L6(e.chunkManager,l,o),T6(e.chunkManager,l,o)]);if(c.dimensionSeparator!==void 0&&a!==void 0&&c.dimensionSeparator!==a)throw new Error(`Explicitly specified dimension separator ${JSON.stringify(a)} does not match value in .zarray ${JSON.stringify(c.dimensionSeparator)}`);let p=new II(e.chunkManager,l,o,a||c.dimensionSeparator||".",c,d);return{modelTransform:wt(p.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:p}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:zn(p.modelSpace.bounds)}}]}})}async completeUrl(e){let[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return t!==void 0?Pr(e.providerUrl.length-t.length,await vh(t,k6)):await hi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ut("zarr",()=>new kb);var AI="single_mesh/SingleMeshLayer",MI="single_mesh/getSingleMeshInfo",km="",RI=class{},Em=class extends RI{};Em.RPC_ID="single_mesh/SingleMeshSource";var _I=class extends ${constructor(e){super();this.gl=e;this.buffer=this.registerDisposer(new _t(e))}resize(e){let t;if(e<256){let r=t=new Uint8Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){let r=t=new Uint16Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{let r=t=new Uint32Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(this.length===void 0||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){let r=e.attribute("aIndexRaw");r>=0&&(this.bindToVertexAttrib(r),t!==0&&this.gl.vertexAttribDivisor(r,t))}};function VI(n,e,t=!1){let r=e.attribute("aIndexRaw");r>=0&&(t&&n.vertexAttribDivisor(r,0),n.disableVertexAttribArray(r))}function OI(n){return n.memoize.get("IndexBuffer",()=>new _I(n))}function NI(n){n.addAttribute("highp uint","aIndexRaw"),n.addVertexCode(Os),n.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}var Eb=class{constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){let r=t.attribute(this.name);e.bindToVertexAttribI(r,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}};function BI(n,e){return _t.fromData(n,e,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}var FI=`void main() {
  emitGray();
}
`,Db=class{constructor(){this.shaderError=sa();this.fragmentMain=Ao(FI);this.shaderControlState=new Ka(this.fragmentMain)}};function Pb(n){return At(n.dataType,n.numComponents)}var rl=[],UI=ci(new _i,z.FLOAT32,3),E6=UI;function D6(n){return n.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_")}function Ib(n){let e=new Set,t=[];for(let r of n){let i=D6(r),a="",o=0;for(;e.has(i+a);)a=""+ ++o;t.push(i+a)}return t}var WI=class{constructor(e,t){this.attributeNames=e;this.attributeInfo=t;this.tempLightVec=new Float32Array(4);this.textureAccessHelper=new Za("vertexData");this.indexBufferHelper=new Eb("vertexIndex")}defineAttributeAccess(e,t){let{textureAccessHelper:r}=this;r.defineShader(e);let{attributeNames:i}=this,a=2+i.length;for(let l=rl.length;l<a;++l)rl[l]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${l}`);a=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",rl[a++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",rl[a++]),e.addVertexCode(r.getAccessor("readVertexPosition","uVertexAttributeSampler0",z.FLOAT32,3)),e.addVertexCode(r.getAccessor("readVertexNormal","uVertexAttributeSampler1",z.FLOAT32,3));let o=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((l,c)=>{e.addTextureSampler(`${gc(l.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,rl[a]);let d=Pb(l);e.addVarying(`highp ${d}`,`vCustom${c}`),e.addFragmentCode(`
#define ${i[c]} vCustom${c}
`),e.addVertexCode(r.getAccessor(`readAttribute${c}`,`uVertexAttributeSampler${a}`,l.dataType,l.numComponents)),o+=`vCustom${c} = readAttribute${c}(${t});
`,++a}),e.addVertexMain(o)}defineShader(e){e.require(NI),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(Ei),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,r){let{lightDirection:i,ambientLighting:a,directionalLighting:o,projectionParameters:l}=r,{viewProjectionMat:c}=l;e.uniformMatrix4fv(t.uniform("uProjection"),!1,c);let d=this.tempLightVec;K.scale(d,i,o),d[3]=a,e.uniform4fv(t.uniform("uLightDirection"),d)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginObject(e,t,r){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,r)}bindVertexData(e,t,r){let i=0,a=l=>{let c=WebGL2RenderingContext.TEXTURE0+t.textureUnit(rl[i]);e.activeTexture(c),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l),++i};a(r.vertexTexture),a(r.normalTexture);let{attributeNames:o}=this;r.vertexAttributeTextures.forEach((l,c)=>{o[c]!==void 0&&a(l)})}disableVertexData(e,t){let r=2,i=this.attributeInfo.length,{attributeNames:a}=this;for(let o=0;o<i;++o)a[o]!==void 0&&++r;for(let o=0;o<r;++o){let l=t.textureUnit(rl[o])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(l),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,r,i){i.ensure(r.numIndices).bind(t),this.bindVertexData(e,t,r.vertexData),this.indexBufferHelper.bind(r.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,r.numIndices)}endLayer(e,t){VI(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}},GI=class{copyToGPU(e,t){let r=(i,a)=>{let o=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),Uo(e,a,i),o};this.vertexTexture=r(this.vertexPositions,UI),this.normalTexture=r(this.vertexNormals,E6),this.vertexAttributeTextures=this.vertexAttributes.map((i,a)=>r(i,t[a])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0}},zI=class extends fr{constructor(e,t){super(e);let r=this.vertexData=new GI;r.vertexPositions=t.vertexPositions,r.vertexNormals=t.vertexNormals,r.vertexAttributes=t.vertexAttributes;let i=this.indices=t.indices;this.numIndices=i.length}copyToGPU(e){super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=BI(e,this.indices)}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}};function P6(n){return n.map(e=>ci(new _i,e.dataType,e.numComponents))}var HI=class extends ut(gt()(Pn),Em){constructor(){super(...arguments);this.attributeTextureFormats=P6(this.info.vertexAttributes)}get info(){return this.parameters.info}getChunk(e){return new zI(this,e)}},I6=la(hn),$I=class extends I6{},Ab=class extends Ir{constructor(e,t,r){super();this.source=e;this.displayState=t;this.transform=r;this.shaderManager=new WI(Ib(this.source.info.vertexAttributes.map(e=>e.name)),this.source.info.vertexAttributes);this.shaders=new Map;this.sharedObject=this.registerDisposer(new $I);this.shaderGetter=jr(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new Ae(_o(Ya(FI))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:e=>e.key,shaderError:this.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Ii(t,e),this.shaderManager.defineShader(e),e.setFragmentMainFunction(Di(t.parseResult.code))}});this.countingBuffer=this.registerDisposer(OI(this.gl));this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch));let{sharedObject:i}=this;i.visibility.add(this.visibility),i.RPC_TYPE_ID=AI,i.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){let{shaders:e}=this;for(let t of e.values())t!==null&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)!==null}get gl(){return this.source.gl}isReady(){let e=this.source.chunks.get(km);return!(e===void 0||e.state!==Qe.GPU_MEMORY)}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let r=Bo(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(r===void 0)return;let i=this.source.chunks.get(km);if(i===void 0||i.state!==Qe.GPU_MEMORY)return;let a=this.shaderGetter(e.emitter),{shader:o,parameters:l}=a;if(o===null)return;let{gl:c}=this,d=this.shaderManager;o.bind(),d.beginLayer(c,o,e),Jr(c,o,this.displayState.shaderControlState,l.parseResult.controls);let{pickIDs:p}=e;d.beginObject(c,o,r),e.emitPickID&&d.setPickID(c,o,p.register(this,i.numIndices/3)),d.drawFragment(c,o,i,this.countingBuffer),d.endLayer(c,o)}transformPickedValue(e){let{pickedOffset:t}=e,r=this.source.chunks.get(km);if(r===void 0)return;let i=t*3,{indices:a}=r;if(i>=a.length)return;let o=a[i],l=[],{attributeNames:c}=this.shaderManager;return r.vertexData.vertexAttributes.forEach((d,p)=>{let m=c[p];m!==void 0&&l.push(`${m}=${d[o].toPrecision(6)}`)}),l.join(", ")}};function A6(n,e,t){return n.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:t},async()=>{let{url:r,credentialsProvider:i}=Zn(t,e);return{info:await n.rpc.promiseInvoke(MI,{chunkManager:n.addCounterpartRef(),credentialsProvider:xd(n,i),parameters:{meshSourceUrl:r}}),url:r,credentialsProvider:i}})}async function Dm(n,e,t){let{info:r,url:i,credentialsProvider:a}=await A6(n,e,t);return n.getChunkSource(HI,{credentialsProvider:a,parameters:{meshSourceUrl:i,info:r}})}var Mb=class extends Vt{get description(){return"VTK mesh file"}async get(e){let t=await Dm(e.chunkManager,e.credentialsManager,e.url),r=Ve({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:wt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return hi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ut("vtk",()=>new Mb);var Rb=class extends Vt{get description(){return"Wavefront OBJ mesh file"}async get(e){let t=await Dm(e.chunkManager,e.credentialsManager,e.url),r=Ve({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:wt(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return hi(e.credentialsManager,e.providerUrl,e.cancellationToken)}};Ut("obj",()=>new Rb);function jI(n){return new Error(`ngauth server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function M6(n){let e=new Ee(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to ngauth server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n)return;let d=()=>{window.removeEventListener("message",o,!1)},{data:p}=l;l.data==="badorigin"&&(d(),a(jI(n)));try{Z(p);let m=j(p,"token",ne);d(),i(m)}catch(m){console.log("ngauth: Received unexpected message from ${serverUrl}",l)}}window.addEventListener("message",o,!1)});t(`ngauth server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var _b=class extends rn{constructor(e){super();this.serverUrl=e;this.get=xn(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await M6(this.serverUrl);case 403:throw jI(this.serverUrl);default:throw qr.fromResponse(e)}})}},Vb=class extends rn{constructor(e,t,r){super();this.ngauthCredentialsProvider=e;this.serverUrl=t;this.bucket=r;this.get=xn(async()=>{let e=await va(this.ngauthCredentialsProvider,`${this.serverUrl}/gcs_token`,{method:"POST"},St,(t,r)=>({...r,body:JSON.stringify({token:t.token,bucket:this.bucket})}),t=>{let{status:r}=t;if(r===401)return"refresh";throw t});return{tokenType:"Bearer",accessToken:e.token}})}};Qn.register("ngauth",n=>new _b(n));Qn.register("ngauth_gcs",(n,e)=>new Vb(e.getCredentialsProvider("ngauth",n.authServer),n.authServer,n.bucket));function R6(n,e,t){let r=window.outerHeight-window.innerHeight+window.innerHeight/2-t/2,i=window.innerWidth/2-e/2;return window.open(n,void 0,`toolbar=no, menubar=no, width=${e}, height=${t}, top=${r}, left=${i}`)}async function _6(n){let e=new Ee(!1),t=new Promise(r=>{function i(a,o){e.element.textContent=a+" ";let l=document.createElement("button");l.textContent=o,e.element.appendChild(l),l.addEventListener("click",()=>{i(`Waiting for login to middleauth server ${n}...`,"Retry");let c=R6(`${n}/api/v1/authorize`,400,650),d=()=>{c==null||c.close()};window.addEventListener("beforeunload",d);let p=setInterval(()=>{(c==null?void 0:c.closed)&&(clearInterval(p),i(`Login window closed for middleauth server ${n}.`,"Retry"))},1e3),m=async y=>{if(y.source===c){clearInterval(p),window.removeEventListener("message",m),window.removeEventListener("beforeunload",d),d(),Z(y.data);let v=j(y.data,"token",ne),b=j(y.data,"app_urls",Zt);r({tokenType:"Bearer",accessToken:v,url:n,appUrls:b})}};window.addEventListener("message",m)})}i(`middleauth server ${n} login required.`,"Login")});try{return await t}finally{e.dispose()}}var JI="auth_token_v2";function V6(n){let e=localStorage.getItem(`${JI}_${n}`);return e?JSON.parse(e):null}function O6(n,e){localStorage.setItem(`${JI}_${n}`,JSON.stringify(e))}var Ob=class extends rn{constructor(e){super();this.serverUrl=e;this.alreadyTriedLocalStorage=!1;this.get=xn(async()=>{let e;return this.alreadyTriedLocalStorage||(this.alreadyTriedLocalStorage=!0,e=V6(this.serverUrl)),e||(e=await _6(this.serverUrl),O6(this.serverUrl,e)),e})}},qI=class extends Error{constructor(e){super();this.url=e}},Nb=class extends rn{constructor(e,t){super();this.serverUrl=e;this.credentialsManager=t;this.credentials=void 0;this.get=xn(async()=>{let e=await fetch(`${this.serverUrl}/auth_info`).then(r=>r.json()),t=this.credentialsManager.getCredentialsProvider("middleauth",e.login_url);if(this.credentials=await t.get(this.credentials),this.credentials.credentials.appUrls.includes(this.serverUrl))return this.credentials.credentials;throw new Ee(!1).setText(`middleauth: unverified app ${this.serverUrl}`),new qI(this.serverUrl)})}};Qn.register("middleauth",n=>new Ob(n));Qn.register("middleauthapp",(n,e)=>new Nb(n,e));var Wb=rt(Dt());function YI(n){return new Error(`Nggraph server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function N6(n){let e=new Ee(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to nggraph server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n||typeof l.data!="string")return;let d=()=>{window.removeEventListener("message",o,!1)};l.data==="badorigin"?(d(),a(YI(n))):(d(),i(l.data))}window.addEventListener("message",o,!1)});t(`Nggraph server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var Bb=class extends rn{constructor(e){super();this.serverUrl=e;this.get=xn(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await N6(this.serverUrl);case 403:throw YI(this.serverUrl);default:throw qr.fromResponse(e)}})}};var Jd=class{},qd=class extends ${constructor(e,t){super();this.graph=e;this.segmentsState=t}};function Lc(n){return!(n.high>>>31)}var Fb=new X(4294967295,4294967295);var Pm=Symbol("disjoint_sets:rank"),ro=Symbol("disjoint_sets:parent"),Im=Symbol("disjoint_sets:next"),Yd=Symbol("disjoint_sets:prev");function Ub(n){let e=n,t=n[ro];for(;t!==n;)n=t,t=n[ro];for(n=e[ro];t!==n;)e[ro]=t,e=n,n=e[ro];return t}function B6(n,e){let t=n[Pm],r=e[Pm];return t>r?(e[ro]=n,n):(n[ro]=e,t===r&&(e[Pm]=r+1),e)}function F6(n,e){let t=n[Yd],r=e[Yd];e[Yd]=t,t[Im]=e,n[Yd]=r,r[Im]=n}function*KI(n){let e=n;do yield e,e=e[Im];while(e!==n)}function U6(n){n[ro]=n,n[Pm]=0,n[Im]=n[Yd]=n}var kc=Symbol("disjoint_sets:min");function XI(n){return n[ro]===n}var il=class{constructor(){this.map=new Map;this.highBitRepresentative=new Ae(!1);this.generation=0}get(e){let t=e.toString(),r=this.map.get(t);return r===void 0?e:Ub(r)[kc]}isMinElement(e){let t=this.get(e);return t===e||X.equal(t,e)}makeSet(e){let t=e.toString(),{map:r}=this,i=r.get(t);return i===void 0?(i=e.clone(),U6(i),i[kc]=i,r.set(t,i),i):Ub(i)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let r=B6(e,t);F6(e,t);let i=e[kc],a=t[kc];return r[kc]=X.less(i,a)!==this.highBitRepresentative.value?i:a,!0}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}deleteSet(e){let{map:t}=this,r=!1;for(let i of this.setElements(e))t.delete(i.toString()),r=!0;return r}*setElements(e){let t=e.toString(),r=this.map.get(t);r===void 0?yield e:yield*KI(r)}clear(){let{map:e}=this;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=Ub(t)[kc],yield e}*roots(){for(let e of this.map.values())XI(e)&&(yield e)}[Symbol.iterator](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(XI(t)){let r=new Array;for(let i of KI(t))r.push(i);r.sort(X.compare),e.push(r)}return e.sort((t,r)=>X.compare(t[0],r[0])),e.map(t=>t.map(r=>r.toString()))}};var W6="^(https?://[^/]+)/(.*)$";function G6(n){return Z(n),{id:j(n,"id",e=>X.parseString(ne(e))),baseSegments:j(n,"base_segment_ids",e=>be(e,t=>X.parseString(ne(t)))),baseSegmentParents:j(n,"base_segment_parent_ids",e=>be(e,t=>X.parseString(ne(t)))),name:j(n,"name",ne),tags:j(n,"tags",Zt),numVoxels:j(n,"num_voxels",yt),bounds:j(n,"bounds",e=>be(e,t=>Ze(t))),lastLogId:j(n,"last_log_id",e=>e==null?null:X.parseString(ne(e)))}}var QI=0,ZI=class extends qd{constructor(e,t){super(e,t);this.debouncedVisibleSegmentsChanged=this.registerCancellable((0,Wb.default)(()=>this.visibleSegmentsChanged(),0));this.segmentQueries=new Map;this.ignoreVisibleSegmentsChanged=!1;this.segmentEquivalencesChanged=this.registerCancellable((0,Wb.default)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();let{segmentQueries:e}=this,{segmentEquivalences:t}=this.segmentsState;t.clear();for(let[r,i]of e){if(i.current===void 0||Lc(i.id))continue;let{id:a,baseSegments:o}=i.current;if(o.length>0){for(let l of o)t.link(l,a);i.addedEquivalences=!0}else i.addedEquivalences=!1}},0));let r=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(r)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(r)),this.visibleSegmentsChanged()}computeSplit(e,t){let{segmentEquivalences:r}=this.segmentsState,i=r.get(e);if(Lc(i)||!X.equal(r.get(t),i))return;let a=this.segmentQueries.get(i.toString());if(a===void 0)return;let{current:o}=a;if(o===void 0)return;let{baseSegments:l,baseSegmentParents:c}=o,d=c.length,p=new il;for(let b=0;b<d;++b){let x=l[b],C=c[b];X.equal(x,t)||X.equal(C,t)||(p.link(x,C),console.log(`Linking ${x} - ${C} == ${e}? ${X.equal(e,x)} ${X.equal(e,C)} :: unioned with include = ${X.equal(e,p.get(x))}, with exclude = ${X.equal(t,p.get(x))}`))}let m=[],y=[],v=p.get(e);for(let b of l)X.equal(p.get(b),v)?m.push(b):y.push(b);return console.log("include = "+m.map(b=>b.toString()).join(",")),console.log("exclude = "+y.map(b=>b.toString()).join(",")),{includeRepresentative:i,includeBaseSegments:m,excludeRepresentative:Fb,excludeBaseSegments:y}}registerVisibleSegment(e){let t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:QI,disposer:this.graph.watchSegment(e,i=>this.handleSegmentUpdate(t.id.toString(),i))},r=e.toString();this.segmentQueries.set(r,t),console.log(`adding to segmentQueries: ${r}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);let r=this.segmentQueries.get(e);if(t==="invalid"){r.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(r.id),this.segmentsState.temporaryVisibleSegments.delete(r.id)}finally{this.ignoreVisibleSegmentsChanged=!1}r.addedEquivalences&&this.segmentEquivalencesChanged();return}if(t==="error"){r.current=void 0,r.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}r.current=t;let i=r.id,a=t.id;if(X.equal(a,i))r.current=t,Lc(r.id)||this.segmentEquivalencesChanged();else{r.id=a;let o=a.toString(),l=this.segmentQueries.get(o);console.log(`removing from segmentQueries: ${e} due to rename -> ${a}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(i)&&(this.segmentsState.visibleSegments.delete(i),this.segmentsState.visibleSegments.add(a)),this.segmentsState.temporaryVisibleSegments.has(i)&&(this.segmentsState.temporaryVisibleSegments.delete(i),this.segmentsState.temporaryVisibleSegments.add(a))}finally{this.ignoreVisibleSegmentsChanged=!1}l===void 0?(console.log(`adding to segmentQueries due to rename -> ${a}`),this.segmentQueries.set(o,r),this.segmentEquivalencesChanged()):(t.lastLogId!==null&&(typeof l.current!="object"||l.current.lastLogId===null||X.less(l.current.lastLogId,t.lastLogId))&&(l.current=t,this.segmentEquivalencesChanged()),r.disposer())}}visibleSegmentsChanged(){let{segmentsState:e}=this,{segmentQueries:t}=this,r=++QI,i=a=>{for(let o of a){if(X.equal(o,Fb))continue;let l=o.toString(),c=t.get(l);if(c!==void 0){c.seenGeneration=r;continue}this.registerVisibleSegment(o.clone())}};i(e.visibleSegments),i(e.temporaryVisibleSegments);for(let[a,o]of t)o.seenGeneration!==r&&(console.log(`removing from segmentQueries due to seenGeneration: ${a}`),t.delete(a),o.disposer(),o.addedEquivalences&&this.segmentEquivalencesChanged())}},eA=class extends Jd{constructor(e,t,r){super();this.chunkManager=e;this.serverUrl=t;this.entityName=r;this.startingWebsocket=!1;this.websocket=void 0;this.watchesById=new Map;this.watches=new Set;this.nextWatchId=0;this.numOpenFailures=0}get highBitRepresentative(){return!0}startWebsocket(){if(this.startingWebsocket||this.watches.size===0)return;this.startingWebsocket=!0;let e=new Ee(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{let{numOpenFailures:t}=this;if(t>1){let o=1e3*Math.min(16,2**t);await new Promise(l=>setTimeout(l,o))}let r=(await zb(this.chunkManager,this.serverUrl,this.entityName).get()).credentials,i=new URL("/graph/watch/"+encodeURIComponent(r.token),this.serverUrl);i.protocol=i.protocol.replace("http","ws");let a=new WebSocket(i.href);a.onclose=()=>{e!==void 0&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},a.onopen=()=>{e!==void 0&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=a,this.nextWatchId=0;try{for(let o of this.watches){a.send(JSON.stringify({watch:{segment_id:o.segment.toString()}}));let l=this.nextWatchId++;o.watchId=l,this.watchesById.set(l,o)}}catch{}},a.onmessage=o=>{let l,c;try{let d=JSON.parse(o.data);Z(d);let p=j(d,"watch_id",yt),m=this.watchesById.get(p);if(m===void 0)return;c=m;let y=j(d,"state",ne);y==="invalid"||y==="error"?l=y:l=j(d,"info",G6)}catch(d){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,o.data,d);return}console.log("got update",l),c.callback(l)}})()}connect(e){return new ZI(this,e)}trackSegment(e,t){return this.watchSegment(e,r=>{if(r==="invalid")t(null);else{if(r==="error")return;t(r.id)}})}watchSegment(e,t){let r={callback:t,segment:e,watchId:-1};this.watches.add(r);let{websocket:i}=this;if(i!==void 0)try{i.send(JSON.stringify({watch:{segment_id:e.toString()}}));let o=this.nextWatchId++;r.watchId=o,this.watchesById.set(o,r)}catch{}else this.startWebsocket();return()=>{let{websocket:o}=this;if(o!==void 0&&o.readyState===WebSocket.OPEN){let l=r.watchId;this.watchesById.delete(l);try{o.send(JSON.stringify({unwatch:{watch_id:l}}))}catch{}}this.watches.delete(r)}}async merge(e,t){let r=await Hb(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Z(r),j(r,"merged",i=>X.parseString(i))}async split(e,t){let r=await Hb(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Z(r),{include:j(r,"include",i=>X.parseString(i)),exclude:j(r,"exclude",i=>X.parseString(i))}}};function tA(n){let e=n.match(W6);if(e===null)throw new Error(`Invalid nggraph url: ${JSON.stringify(n)}`);return{serverUrl:e[1],id:e[2]}}function Gb(n,e,t,r,i=et){return va(n,`${e}${t}`,r,St,(a,o)=>{let l=new Headers(o.headers);return l.set("Authorization",a.token),{...o,headers:l}},a=>{let{status:o}=a;if(o===401)return"refresh";throw a},i)}function z6(n,e,t,r,i=et){return Gb(rA(n,e),e,t,r,i)}var nA=class extends rn{constructor(e,t,r){super();this.parentCredentialsProvider=e;this.serverUrl=t;this.entityName=r;this.get=xn(async()=>{let e=await Gb(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:e.token,entityType:e.entity_type,role:e.role}})}};function rA(n,e){return n.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:e},()=>new Bb(e))}function zb(n,e,t){return n.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:e,entityName:t},()=>new nA(rA(n,e),e,t))}function Hb(n,e,t,r,i,a=et){return Gb(zb(n,e,t),e,r,i,a)}function H6(n){return Z(n),j(n,"entities",e=>be(e,t=>{Z(t);let r=j(t,"entity",ne),i=j(t,"entity_type",ne),a=j(t,"access_role",ne);return{id:r,entityType:i,accessRole:a}}))}var $b=class extends Vt{get description(){return"nggraph data source"}get(e){let{serverUrl:t,id:r}=tA(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:r},async()=>{let i=zb(e.chunkManager,t,r),{entityType:a}=(await i.get()).credentials;if(a!="graph")throw new Error(`Unsupported entity type: ${JSON.stringify(a)}`);let{datasource_url:o}=await Hb(e.chunkManager,t,r,"/graph/config",{method:"POST"}),l=await e.registry.get({...e,url:o}),c=new eA(e.chunkManager,t,r),d=[...l.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:c}}];return{modelTransform:l.modelTransform,subsources:d}})}async completeUrl(e){let{serverUrl:t,id:r}=tA(e.providerUrl),i=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>H6(await z6(e.chunkManager,t,"/list",{method:"POST"})));return{offset:t.length+1,completions:tn(r,i,a=>a.id,a=>`${a.entityType} (${a.accessRole})`)}}};Ut("nggraph",()=>new $b);var Gm=rt(Dt()),jA=rt(Kd());function Y6(n){return typeof n=="boolean"?{enabled:n}:(Z(n),{enabled:de(n,"enabled",aa)})}function al(n,e=void 0){return typeof n=="string"?{url:n,transform:e,enableDefaultSubsources:!0,subsources:new Map}:(Z(n),{url:j(n,"url",ne),transform:j(n,"transform",Rv)||e,enableDefaultSubsources:de(n,"enableDefaultSubsources",aa,!0),subsources:de(n,"subsources",t=>Fa(t,Y6),new Map)})}function K6(n){return n.enabled}function aA(n){let e=_v(n.transform),t={},r=!0;for(let[i,a]of n.subsources){let o=K6(a);o!==void 0&&(t[i]=o,r=!1)}return e===void 0&&r&&n.enableDefaultSubsources===!0?n.url:{url:n.url,transform:e,subsources:r?void 0:t,enableDefaultSubsources:n.enableDefaultSubsources===!0?void 0:!1}}var oA=class{constructor(e,t,r,i,a){this.loadedDataSource=e;this.subsourceEntry=t;this.subsourceSpec=r;this.subsourceIndex=i;this.activated=void 0;this.guardValues=[];this.messages=new Ai;this.isActiveChanged=new ae;let o;r===void 0||r.enabled===void 0?o=t.default&&a:o=r.enabled;let l=e.dataSource.modelTransform.sourceRank,{modelSubspaceDimensionIndices:c}=t;if(c===void 0){c=new Array(l);for(let p=0;p<l;++p)c[p]=p}let{subsourceToModelSubspaceTransform:d=Hn(Float32Array,c.length+1)}=t;this.enabled=o,this.subsourceToModelSubspaceTransform=d,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(Ce(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;let r=this.activated=new $;e(r),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:hr.error,message:e});let{activated:t}=this;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){let t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){let t=this.activated,{layer:r,transform:i}=this.loadedDataSource;return t.registerDisposer(Qf(r.manager.root.coordinateSpace,r.localPosition.coordinateSpace,i,this,e))}},Am=class extends ${constructor(e,t,r){super();this.layerDataSource=e;this.dataSource=t;this.error=void 0;this.enabledSubsourcesChanged=new ae;this.activatedSubsourcesChanged=new ae;this.messages=new Ai;t.canChangeModelSpaceRank?(this.transform=new qf(wt(Ve({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new qf(t.modelTransform),r.transform!==void 0&&(this.transform.spec=r.transform);let i=r.subsources;this.enableDefaultSubsources=r.enableDefaultSubsources,this.subsources=t.subsources.map((a,o)=>new oA(this,a,i.get(a.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(let e of this.subsources){let{activated:t}=e;t!==void 0&&(e.activated=void 0,t.dispose())}}},jb=class extends ${constructor(e,t=void 0){super();this.layer=e;this.changed=new ae;this.messages=new Ai;this.loadState_=void 0;this.specGeneration=-1;this.refCounted_=void 0;this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=bh():this.spec=t}get spec(){let{loadState:e}=this;if(e!==void 0&&e.error===void 0){let t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,r=>{let i=e.enableDefaultSubsources&&r.subsourceEntry.default;return[r.subsourceEntry.id,{enabled:r.enabled!==i?r.enabled:void 0}]}))})}return this.spec_}get loadState(){return this.loadState_}set spec(e){let{layer:t}=this;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){let c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}let r=new $,i=r.registerDisposer(pf(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=r,this.spec_=e;let a=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,l=new dr;this.messages.addMessage({severity:hr.info,message:"Loading data source"}),o.get({chunkManager:a,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform}).then(c=>{if(r.wasDisposed)return;this.messages.clearMessages();let d=r.registerDisposer(new Am(this,c,e));d.registerDisposer(t.addCoordinateSpace(d.transform.outputSpace)),d.registerDisposer(d.transform.changed.add(this.changed.dispatch)),this.loadState_=d,d.registerDisposer(d.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),i()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:hr.error,message:c.message}),this.changed.dispatch())}),r.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){let e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){let{loadState:e}=this;return e===void 0||e.error!==void 0?aA(this.spec):aA({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let r=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==r?t.enabled:void 0}]}))})}};var Wt;(function(r){r[r.LINKED=0]="LINKED",r[r.RELATIVE=1]="RELATIVE",r[r.UNLINKED=2]="UNLINKED"})(Wt||(Wt={}));var Mm;(function(t){t[t.LINKED=0]="LINKED",t[t.UNLINKED=2]="UNLINKED"})(Mm||(Mm={}));var sA=class extends jo{constructor(e=0){super(Wt,e)}},lA=class extends jo{constructor(e=0){super(Mm,e)}},Rm=K.create(),cA=Je.create();function Xd(n,e,t,r){let i=!1,a=!1,o;n.registerDisposer(e);let l=()=>{if(!a){switch(i=!0,t.value){case 2:if(r.isValid(n))break;case 0:r.assign(n,e);break;case 1:r.add(n,e,o);break}i=!1}},c=()=>{if(!i)switch(t.value){case 2:break;case 0:r.assign(e,n);break;case 1:r.subtract(e,n,o);break}},d=2,p=()=>{let m=t.value;if(m!==d)switch(m){case 2:o=void 0;break;case 0:o=void 0,r.assign(n,e);break;case 1:o=r.difference(n,e);break}d=m,n.changed.dispatch()};return n.registerDisposer(n.changed.add(c)),n.registerDisposer(e.changed.add(l)),n.registerDisposer(t.changed.add(p)),p(),n}function uA(n,e,t,r){return Xd(n,e,t,r)}var Bi=class extends ${constructor(e){super();this.coordinateSpace=e;this.coordinates_=za;this.changed=new ae;this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=za,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(t===void 0||!t.valid||t.rank!==e.length)return;let{coordinates_:r}=this;r.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:r}=e;if(!e.valid)return;if(t===void 0||!t.valid){let{coordinates_:p}=this;if(!(p!==void 0&&p.length===r)){p=this.coordinates_=new Float32Array(r),Uk(p,e.bounds);for(let m=0;m<r;++m)p[m]=Math.floor(p[m])+.5}this.changed.dispatch();return}let i=new Float32Array(r),a=this.coordinates_,{ids:o,scales:l}=e,{ids:c,scales:d}=t;for(let p=0;p<r;++p){let m=o[p],y=c.indexOf(m);y===-1?i[p]=kv(e.bounds.lowerBounds[p],e.bounds.upperBounds[p]):i[p]=a[y]*(d[y]/l[p])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(e.length!==0)return Array.from(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(be(e,Ze)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{coordinates_:e}=this,t=e.length;for(let r=0;r<t;++r)e[r]=Math.floor(e[r])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:r}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(r),this.changed.dispatch()}static getOffset(e,t){let r=e.coordinates_,i=t.coordinates_;if(r.length===i.length)return Wf(new Float32Array(r.length),r,i)}static addOffset(e,t,r,i=1){e.handleCoordinateSpaceChanged();let{value:a}=t;r!==void 0&&a.length===r.length&&(Mk(e.value,a,r,i),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}Z(t),nn(t,"voxelCoordinates",e)}}}};function dA(n,e,t){if(t===void 0||Object.keys(t).length===0){n.value=0;return}Z(t),n.value=2,j(t,"value",r=>{r!==void 0&&e.restoreState(r)}),j(t,"link",r=>n.restoreState(r))}var Ec=class{constructor(e,t=new sA){this.peer=e;this.link=t}get changed(){return this.value.changed}toJSON(){let{link:e}=this;if(e.value!==0)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){dA(this.link,this.value,e)}copyToPeer(){this.link.value!==0&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}},Jb=class extends Ec{constructor(e,t=new lA){super(e,t)}},Qd=class extends Ec{constructor(){super(...arguments);this.value=Xd(new Bi(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:Bi.getOffset,add:Bi.addOffset,subtract:(e,t,r)=>{Bi.addOffset(e,t,r,-1)}})}};function X6(n){return n[0]===0&&n[1]===0&&n[2]===0&&n[3]===1}var io=class extends ${constructor(e){super();this.changed=new ae;e==null&&(e=Je.create()),this.orientation=e}toJSON(){let{orientation:e}=this;if(Je.normalize(this.orientation,this.orientation),!X6(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{Kl(this.orientation,e),Je.normalize(this.orientation,this.orientation)}catch(t){Je.identity(this.orientation)}this.changed.dispatch()}reset(){Je.identity(this.orientation),this.changed.dispatch()}snap(){let e=Ct.create();Ct.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let i=0,a=0;for(let o=0;o<3;++o){let l=e[r*3+o];e[r*3+o]=0,!t[o]&&Math.abs(l)>Math.abs(i)&&(i=l,a=o)}e[r*3+a]=Math.sign(i),t[a]=!0}Je.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new io(Je.multiply(Je.create(),e.orientation,t)),i=!1;r.registerDisposer(e.changed.add(()=>{i||(a=!0,Je.multiply(r.orientation,e.orientation,t),r.changed.dispatch(),a=!1)}));let a=!1,o=Je.invert(Je.create(),t);return r.registerDisposer(r.changed.add(()=>{a||(i=!0,Je.multiply(e.orientation,r.orientation,o),e.changed.dispatch(),i=!1)})),r}assign(e){Je.copy(this.orientation,e.orientation),this.changed.dispatch()}},Dc=class extends Ec{constructor(){super(...arguments);this.value=Xd(new io,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{let r=Je.create();return Je.multiply(r,Je.invert(r,t.orientation),e.orientation)},add:(e,t,r)=>{Je.multiply(e.orientation,t.orientation,r),e.changed.dispatch()},subtract:(e,t,r)=>{Je.multiply(e.orientation,t.orientation,Je.invert(cA,r)),e.changed.dispatch()}})}},_m=class extends ${constructor(e){super();this.coordinateSpace=e;this.changed=new ae;this.curCoordinateSpace=Hr;this.value_={factors:new Float64Array(0)};this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=Hr,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:r}=this,{factors:i}=r,{names:a,rank:o}=this.curCoordinateSpace;for(let l=0;l<o;++l){let c=i[l];c!==1&&(e[a[l]]=c,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:r,rank:i}=t,a=new Float64Array(i);if(a.fill(-1),e!==void 0){let o=Z(e);for(let l=0;l<i;++l)a[l]=j(o,r[l],c=>c===void 0?1:dt(c))}this.value_={factors:a},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:r}=this;if(r===e)return t;let{ids:i}=r,{ids:a,rank:o}=e,l=t.factors,c=new Float64Array(o);c.fill(1);for(let d=0;d<o;++d){let p=a[d],m=i.indexOf(p);m!==-1&&(c[d]=l[m])}return Ce(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}};function pA(n,e,t,r,i){if(t===r)return e;let{ids:a}=t,{rank:o,ids:l}=r,c=new n(o);for(let d=0;d<o;++d){let p=l[d],m=a.indexOf(p);c[d]=m===-1?i(d):e[m]}return c}var qb=class extends Ec{constructor(){super(...arguments);this.value=Xd(new _m(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{let{factors:r}=e.value,i=e.coordinateSpace.value,a=t.value.factors;return{coordinateSpace:i,offsets:Wf(new Float64Array(r.length),r,a)}},add:(e,t,r)=>{let i=pA(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Uf(new Float64Array(i.length),i,t.value.factors))},subtract:(e,t,r)=>{let i=pA(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Wf(new Float64Array(i.length),t.value.factors,i))},isValid:()=>!0})}};function fA(n,e,t){let{rank:r,names:i,units:a}=n,{displayRank:o,displayDimensionIndices:l}=e,c=new Float64Array(3),d=new Float64Array(3),p,{factors:m}=t,y=new Array(3),v=new Float64Array(3);if(c.fill(1),d.fill(1),v.fill(1),y.fill(""),o===0)p=1;else{p=Number.POSITIVE_INFINITY;let{scales:b}=n;for(let x=0;x<o;++x){let C=l[x],L=d[x]=m[C]*b[C];p=Math.min(p,L),y[x]=a[C],v[x]=b[C]}for(let x=0;x<o;++x)c[x]=d[x]/p}return{globalRank:r,globalDimensionNames:i,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:y,displayDimensionScales:v,canonicalVoxelFactors:c,voxelPhysicalScales:d,canonicalVoxelPhysicalSize:p}}function Q6(n,e){return Ce(n.globalDimensionNames,e.globalDimensionNames)&&Ce(n.displayDimensionIndices,e.displayDimensionIndices)&&Ce(n.canonicalVoxelFactors,e.canonicalVoxelFactors)&&Ce(n.voxelPhysicalScales,e.voxelPhysicalScales)&&n.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&Ce(n.displayDimensionUnits,e.displayDimensionUnits)&&Ce(n.displayDimensionScales,e.displayDimensionScales)}var Zd=class extends ${constructor(e,t){super();this.relativeDisplayScales=e;this.displayDimensions=t;this.changed=new ae;this.curRelativeDisplayScales=this.relativeDisplayScales.value;this.curDisplayDimensions=this.displayDimensions.value;this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value;this.value_=fA(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales);this.registerDisposer(e),this.registerDisposer(t);let r=()=>{this.value};this.registerDisposer(e.changed.add(r)),this.registerDisposer(t.changed.add(r))}get value(){let{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:r},curRelativeDisplayScales:i,curDisplayDimensions:a,curCoordinateSpace:o}=this,l=this.value_;if(i!==e||a!==r||o!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=r,this.curCoordinateSpace=t;let c=fA(t,r,e);Q6(l,c)||(this.value_=l=c,this.changed.dispatch())}return l}},Vm=class extends ${constructor(e){super();this.coordinateSpace=e;this.changed=new ae;this.default_=!0;this.value_=void 0;this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}let r=new Int32Array(3),{ids:i}=t.coordinateSpace,{ids:a}=e,o=t.displayDimensionIndices,l=t.displayRank,c=0;for(let d=0;d<l;++d){let p=a.indexOf(i[o[d]]);p!==-1&&(r[c]=p,++c)}if(r.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,r),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),r=new Int32Array(3);r.fill(-1);for(let i=0;i<t;++i)r[i]=i;this.assignValue(e,t,r)}assignValue(e,t,r){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:r},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}let t=ed(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:r}}=this,i=new Int32Array(3);i.fill(-1);let{names:a}=r,o=0;for(let l of t){let c=a.indexOf(l);c!==-1&&(i[o++]=c)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(r,o,i)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:r,displayDimensionIndices:i,coordinateSpace:{names:a}}=e;if(r!==0){for(let o=0;o<r;++o)t[o]=a[i[o]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:r}=e.value;this.setDimensionIndices(t,r)}}},Yb=class extends Jb{constructor(e){super(e);this.value=uA(new Vm(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}},wa=class extends ${constructor(e,t,r){super();this.position=e;this.displayDimensionRenderInfo=t;this.orientation=r;this.changed=new ae;this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(r.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=Rm){let{coordinateSpace:{value:r},value:i}=this.position,{displayDimensionIndices:a,displayRank:o}=this.displayDimensions.value;if(r===void 0)return!1;t.fill(0);for(let l=0;l<o;++l){let c=a[l];t[l]=i[c]}if(e(t)!==!1){for(let l=0;l<o;++l){let c=a[l];i[c]=t[l]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){ie.fromQuat(e,this.orientation.orientation);let{value:r}=this.position,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value;for(let o=0;o<3;++o){let l=a[o],c=t/i[o];e[o]*=c,e[4+o]*=c,e[8+o]*=c,e[12+o]=r[l]||0}}toMat3(e,t){Ct.fromQuat(e,this.orientation.orientation);let{canonicalVoxelFactors:r,displayRank:i}=this.displayDimensionRenderInfo.value;for(let a=0;a<i;++a){let o=t/r[a];e[a]*=o,e[3+a]*=o,e[6+a]*=o}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;let{position:r}=this,{value:i}=r,{bounds:{lowerBounds:a,upperBounds:o}}=r.coordinateSpace.value,l=i[e]+t;if(t>0){let c=o[e];Number.isFinite(c)&&(l=Math.min(l,Math.ceil(c-1)))}else{let c=a[e];Number.isFinite(c)&&(l=Math.max(l,Math.floor(c)))}i[e]=l,r.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;let r=K.transformQuat(Rm,e,this.orientation.orientation),{position:i}=this,{value:a}=i,{displayDimensionIndices:o,displayRank:l}=this.displayDimensions.value,{bounds:{lowerBounds:c,upperBounds:d}}=i.coordinateSpace.value;for(let p=0;p<l;++p){let m=o[p],y=r[p];if(y===0)continue;let v=a[m]+y;if(y>0){let b=d[m];Number.isFinite(b)&&(v=Math.min(v,Math.ceil(b-1)))}else{let b=c[m];Number.isFinite(b)&&(v=Math.max(v,Math.floor(b)))}t&&(v=Math.floor(v)+.5),a[m]=v}this.position.changed.dispatch()}rotateRelative(e,t){var r=Je.create();Je.setAxisAngle(r,e,t);var i=this.orientation.orientation;Je.multiply(i,i,r),this.orientation.changed.dispatch()}rotateAbsolute(e,t,r){let{coordinateSpace:{value:i},value:a}=this.position;if(i===void 0)return;let{relativeDisplayScales:{value:{factors:o}},displayDimensions:{value:{displayDimensionIndices:l,displayRank:c}}}=this,{scales:d}=i,p=Je.create();Je.setAxisAngle(p,e,t);let m=this.orientation.orientation,y=Rm;Rm.fill(0);for(let b=0;b<c;++b){let x=l[b],C=r[x]-a[x];y[b]=C*d[x]*o[x]}let v=Je.invert(cA,m);K.transformQuat(y,y,v),Je.multiply(m,p,m),K.transformQuat(y,y,m);for(let b=0;b<c;++b){let x=l[b];a[x]=r[x]-y[b]/(d[x]*o[x])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;let{displayDimensionIndices:r}=this.displayDimensions.value,{position:i}=this,a=i.coordinateSpace.value.rank;for(let o=0;o<a;++o)if(r.indexOf(o)===-1&&e--==0){this.translateDimensionRelative(o,t);return}}},Pc=class extends Ec{constructor(e,t){super(e);this.value=(()=>{let r=new e.constructor(t),i=(d,p)=>{d.assign(p)},a=(d,p)=>d.value/p.value*(d.canonicalVoxelPhysicalSize/p.canonicalVoxelPhysicalSize),o=(d,p,m)=>{d.setPhysicalScale(p.value*m,p.canonicalVoxelPhysicalSize)},l=(d,p,m)=>{d.setPhysicalScale(p.value/m,p.canonicalVoxelPhysicalSize)},c=d=>d.coordinateSpaceValue.valid&&d.canonicalVoxelPhysicalSize!==0;return Xd(r,this.peer,this.link,{assign:i,isValid:c,difference:a,add:o,subtract:l}),r})()}};function ol(n){return{changed:n.changed,toJSON(){return n.toJSON()},restoreState(e){dA(n.link,n.value.legacyJsonView,e)},reset(){n.reset()}}}var Kb=class extends ${constructor(e){super();this.displayDimensionRenderInfo=e;this.changed=new ae;this.curCanonicalVoxelPhysicalSize=0;this.value_=Number.NaN;this.legacyValue_=Number.NaN;this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){let{canonicalVoxelPhysicalSize:t}=this;Object.is(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){let{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:r}}}}=this,{curCanonicalVoxelPhysicalSize:i}=this;if(!(!Number.isNaN(e)&&t===i)){if(!Number.isNaN(e)){i!==0&&(this.value_=e*(i/t),this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}!r.valid||t===0||(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){let{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=dt(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=dt(t)}}}setPhysicalScale(e,t){let r=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/r)}assign(e){let{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}},Xb=class extends Kb{getDefaultValue(){let{legacyValue_:e}=this;if(Number.isNaN(e))return 1;let{canonicalVoxelPhysicalSize:t}=this;return this.legacyValue_*1e-9/t}},Qb=class extends Kb{getDefaultValue(){let{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;let{canonicalVoxelPhysicalSize:l}=this;return 2*100*Math.tan(Math.PI/8)*1e-9*e/l}let{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:r}}}=this,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value,o=i.reduce((l,c,d)=>{let p=a[d],m=(r[p]-t[p])*c;return Math.max(l,m)},0);return Number.isFinite(o)?o=2**Math.ceil(Math.log2(o)):o=1024,o}},ep=class extends ${constructor(e,t){super();this.defaultValue=e;this.displayDimensionRenderInfo=t;this.changed=new ae;this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let{value_:e}=this;if(e>0){let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,r=this.canonicalVoxelPhysicalSize;t!==r&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=r/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){let{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!Number.isFinite(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){let{canonicalVoxelPhysicalSize:r}=this.displayDimensionRenderInfo.value;e=e*(t/r)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}},Om=class extends Jb{constructor(e,t){super(e);this.value=uA(new ep(e.defaultValue,t),this.peer,this.link,{assign:(r,i)=>r.assign(i),isValid:()=>!0})}},Ta=class extends ${constructor(e,t,r){super();this.pose=e;this.zoomFactor=t;this.depthRange=r;this.changed=new ae;this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(r),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}};var sl='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="plusIconTitle"><path d="M20 12L4 12M12 4L12 20"></path></svg>';function Nm(n={}){return je({svg:sl,...n})}var hA='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowUpIconTitle"><path d="M18 9l-6-6-6 6"></path><path d="M12 21V4"></path><path stroke-linecap="round" d="M12 3v1"></path></svg>';var Z6=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),eH=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]),Gt=class extends ${constructor(e,t){super();this.target=e;this.eventMap=t;this.modifierShortcutsAreGlobal=!0;this.allShortcutsAreGlobal=!1;this.allowSpaceKeyOnButtons=!1;this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var r=t.target;let{tagName:i}=r;if(r===this.target)return!1;var a=i==="TEXTAREA"||i==="INPUT"||i==="BUTTON"||i==="SELECT",o=!a&&(r.isContentEditable||r.ownerDocument&&r.ownerDocument.designMode==="on");return!a&&!o||this.allShortcutsAreGlobal||Z6.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:i==="INPUT"&&eH.has(r.type)?e!=="enter":i==="INPUT"||i==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){let t=tH(e);this.shouldIgnoreEvent(t,e)||Bh(t,e,e,this.eventMap)}};function tH(n){return n.code.toLowerCase()}function tp(n,e=n.value){n.style.minWidth=e.length+1+"ch"}var mA="neuroglancer-coordinate-space-transform-singleton";function gA(n,e){let t;n===Number.NEGATIVE_INFINITY?t="(-\u221E,":t=`[${Math.floor(n)},`;let r;return e===Number.POSITIVE_INFINITY?r="+\u221E)":r=`${Math.floor(e)})`,{lower:t,upper:r}}var yA=_e.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function vA(){let n=document.createElement("div"),e=document.createElement("input");n.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),n.appendChild(e);let t=document.createElement("div"),r=document.createElement("span");r.innerHTML=hA,t.appendChild(r);let i=document.createTextNode("");return t.appendChild(i),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),n.appendChild(t),{cellElement:n,inputElement:e,suggestionElement:t}}function SA(n,e,t,r,i){if(e===void 0||e.scale===t&&e.unit===r)n.style.display="none";else{n.style.display="";let a=Li(e.scale,e.unit,{elide1:!1});n.lastChild.textContent=a,n.title=`${i}${a}`}}function bA(){let n=document.createElement("input");return n.spellcheck=!1,n.autocomplete="off",n.size=1,n.placeholder=" ",n.classList.add("neuroglancer-coordinate-space-transform-output-name"),n}function xA(n,e,t){let r=n.map(y=>Do(y.value));if(r.includes(void 0))return!1;let i=Float64Array.from(r,y=>y.scale),a=Array.from(r,y=>y.unit),o=t.value,{scales:l,units:c,rank:d}=o;for(let y=0;y<d;++y)e[y]||(i[y]=l[y],a[y]=c[y]);if(Ce(l,i)&&Ce(c,a))return!1;let p=o.timestamps.map((y,v)=>i[v]===l[v]&&a[v]===c[v]?y:Date.now()),m=Ve({valid:o.valid,rank:o.rank,scales:i,units:a,timestamps:p,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=m,!0}function CA(n,e,t,r){let i=new Float64Array(n.scales),a=Array.from(n.units);if(i[e]===t&&a[e]===r)return n;let o=Array.from(n.timestamps);return i[e]=t,a[e]=r,o[e]=Date.now(),{...n,scales:i,units:a,timestamps:o}}var Zb=class extends ${constructor(e,t,r){super();this.transform=e;this.localCombiner=t;this.globalCombiner=r;this.element=document.createElement("div");this.coefficientContainer=document.createElement("div");this.translationContainer=document.createElement("div");this.outputNameContainer=document.createElement("div");this.outputScaleContainer=document.createElement("div");this.inputNameContainer=document.createElement("div");this.inputScaleContainer=document.createElement("div");this.inputLowerBoundsContainer=document.createElement("div");this.inputUpperBoundsContainer=document.createElement("div");this.coefficientElements=[];this.inputNameElements=[];this.outputNameElements=[];this.outputScaleElements=[];this.outputScaleSuggestionElements=[];this.inputScaleSuggestionElements=[];this.inputScaleElements=[];this.inputBoundsElements=[];this.outputBoundsElements=[];this.addSourceDimensionIcon=je({svg:sl,text:"S"});this.addOutputDimensionIcon=je({svg:sl,text:"V"});this.addOutputDimensionCell=document.createElement("div");this.addOutputDimensionInput=bA();this.inputScaleModified=[];this.outputScaleModified=[];this.curSourceRank=-1;this.curRank=-1;this.curTransform=void 0;this.addingSourceDimension=!1;this.resetToIdentityButton=je({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{let{transform:e}=this,t=e.value.rank;e.transform=Hn(Float64Array,t+1)}});this.resetToDefaultButton=je({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{let{transform:e}=this;if(e.mutableSourceRank)return;let{defaultTransform:t}=e,{outputSpace:r}=t,i=r.ids.map(()=>As());e.value={...t,outputSpace:{...r,ids:i}}}});let{element:i}=this,a=this.registerDisposer(new Gt(i,yA));a.allShortcutsAreGlobal=!0,i.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new yn(i,yA));let o=Be(()=>this.updateView());this.registerDisposer(e.changed.add(o));let{coefficientContainer:l,translationContainer:c,outputNameContainer:d,inputNameContainer:p,inputScaleContainer:m,inputLowerBoundsContainer:y,inputUpperBoundsContainer:v,outputScaleContainer:b,addOutputDimensionCell:x,addOutputDimensionIcon:C,addSourceDimensionIcon:L,resetToIdentityButton:A,resetToDefaultButton:D}=this;l.style.display="contents",c.style.display="contents",d.style.display="contents",p.style.display="contents",m.style.display="contents",b.style.display="contents",y.style.display="contents",v.style.display="contents";let R=document.createElement("div");R.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),A.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),D.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),R.appendChild(A),R.appendChild(D),i.appendChild(R);for(let[B,W]of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){let _=document.createElement("div");_.classList.add(`neuroglancer-coordinate-space-transform-${B}-label`),_.classList.add("neuroglancer-coordinate-space-transform-label"),_.textContent=W,i.appendChild(_)}e.mutableSourceRank&&x.appendChild(L),x.appendChild(C),x.classList.add("neuroglancer-coordinate-space-transform-output-extend");let P="Embed in additional output dimension",E="Extend to additional source dimension";C.title=P,L.title=E,x.appendChild(this.addOutputDimensionInput),x.dataset.isActive="false",C.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=P,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),L.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=E,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),i.appendChild(l),i.appendChild(d),i.appendChild(p),i.appendChild(m),i.appendChild(b),i.appendChild(y),i.appendChild(v),l.appendChild(c),i.addEventListener("input",B=>{let{target:W}=B;if(W instanceof HTMLInputElement){tp(W);let _=this.inputScaleElements.indexOf(W);if(_!==-1){this.inputScaleModified[_]=!0,this.updateScaleValidity(W);return}if(_=this.outputScaleElements.indexOf(W),_!==-1){this.outputScaleModified[_]=!0,this.updateScaleValidity(W);return}if(_=this.outputNameElements.indexOf(W),_!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(W)){this.updateCoefficientValidity(W);return}}});let V=(B,W,_)=>{le(i,B,F=>{F.stopPropagation();let N=F.target;if(!(N instanceof HTMLInputElement)||_!==0&&(N.selectionStart!==N.selectionEnd||N.selectionStart!==(_===1?N.value.length:0)))return;let J=this.getElementGridPosition(N);if(J===void 0)return;let re=this.getElementByGridPosition(J.row+W,J.col+_);re!==null&&(re.focus(),F.preventDefault())})};V("move-up",-1,0),V("move-down",1,0),V("move-left",0,-1),V("move-right",0,1);let O=(B,W)=>{B.addEventListener("focusout",_=>{let{relatedTarget:F}=_;F instanceof Node&&B.contains(F)||W(_)})};O(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),O(d,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),O(m,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),O(b,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),le(i,"cancel",B=>{this.curTransform=void 0,this.updateView(),B.target.blur()}),le(l,"commit",()=>{this.updateModelTransform()}),le(d,"commit",()=>{this.updateModelOutputNames()}),le(m,"commit",()=>{this.updateModelInputScales()}),le(b,"commit",()=>{this.updateModelOutputScales()}),i.addEventListener("focusin",B=>{let{target:W}=B;W instanceof HTMLInputElement&&W.select()}),this.updateView()}updateWillBeDeletedAttributes(e){let{rank:t}=this.transform.value;e===void 0&&(e=new Array(t),e.fill(!1));let{coefficientElements:r,inputBoundsElements:i,inputScaleElements:a}=this;for(let o=0;o<t;++o){let l=e[o];for(let p=0;p<=t;++p){let m=r[t*p+o],y=p<t&&e[p];m.dataset.willBeDeleted=(l||y).toString()}a[o].dataset.willBeDeleted=l.toString();let{lower:c,upper:d}=i[o];c.dataset.willBeDeleted=l.toString(),d.dataset.willBeDeleted=l.toString()}}updateAddOutputDimensionCellStyle(){let{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){let{outputNameElements:e}=this,t=e.map(c=>c.value),{value:{sourceRank:r,rank:i},mutableSourceRank:a}=this.transform;if(e.length!==i+1)return;let o=Zu(t),l=new Array(i);l.fill(!1);for(let c=0;c<=i;++c){let d=o[c];t[c].length===0&&(a||c>=r)&&(d=!0,l[c]=!0),e[c].dataset.isValid=d.toString()}this.updateWillBeDeletedAttributes(l),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){let t=Do(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){let t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{let t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{let t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{let t=this.coefficientElements.indexOf(e),{rank:r}=this.transform.value;if(t!==-1)return{row:t%r,col:Math.floor(t/r)}}{let t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){let{rank:r}=this.transform.value;return e===-1?t<0||t>=r?null:this.inputScaleElements[t]:t===-2?e<0||e>r?null:this.outputNameElements[e]:t===-1?e<0||e>=r?null:this.outputScaleElements[e]:e<0||e>=r||t<0||t>r?null:this.coefficientElements[t*r+e]}dimensionRefCount(e){return(Po(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return xA(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return xA(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){let e=this.outputNameElements.map(A=>A.value),{value:t,mutableSourceRank:r}=this.transform,{outputSpace:i,rank:a,sourceRank:o}=t;if(e.length!==a+1)return;let l=[],c=[],d=e[a].length!==0,p=o;for(let A=0;A<=a;++A){let D=e[A];if(D.length===0){if(A<o){if(!r)return!1;--p}continue}c.push(D),l.push(A)}if(!rc(c))return!1;let m=i.names;if(!d&&Ce(m,c))return!0;let y=t.inputSpace,v=t.outputSpace,b=t.transform;if(d){this.addingSourceDimension&&++p;let A=e[a],D=(Po(A)?this.localCombiner:this.globalCombiner).combined.value,R=D.names.indexOf(A),P,E;R!==-1?(P=D.units[R],E=D.scales[R]):(P="",E=1);let V=y.boundingBoxes.map(O=>Pv(O,a,a+1));this.addingSourceDimension||V.push(Dv(a+1,a)),y=Ve({valid:y.valid,rank:a+1,names:[...y.names,""],ids:[...y.ids,As()],timestamps:[...y.timestamps,Date.now()],scales:Float64Array.from([...y.scales,E]),units:[...y.units,P],boundingBoxes:V,coordinateArrays:[...y.coordinateArrays,void 0]}),v=Ve({valid:i.valid,rank:a+1,names:[...i.names,A],ids:[...i.ids,As()],timestamps:[...i.timestamps,Date.now()],scales:Float64Array.from([...i.scales,E]),units:[...i.units,P],coordinateArrays:[...i.coordinateArrays,void 0]}),b=Ku(new Float64Array((a+2)**2),a+1,b,a)}b=Yf(Float64Array,b,y.rank,l,l),y=Kf(y,l),v=Kf(v,l);let x=v.ids.map((A,D)=>{let R=l[D];if(R===a)return A;let P=c[D],E=m[R];return P===E||this.dimensionRefCount(E)===1&&this.dimensionRefCount(P)===(m.includes(P)?1:0)?A:As()}),C=v.timestamps.map((A,D)=>{let R=l[D];return R===a||c[D]===m[R]?A:Date.now()});v={...v,names:c,ids:x,timestamps:C};let L={rank:v.rank,sourceRank:p,outputSpace:v,inputSpace:y,transform:b};return this.transform.value=L,!0}updateModelTransform(){let e=this.coefficientElements,{rank:t}=this.transform.value,r=new Float64Array((t+1)**2);r[r.length-1]=1;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=e[a*t+i],l=parseFloat(o.value);if(!Number.isFinite(l))return!1;r[a*(t+1)+i]=l}return this.transform.transform=r,!0}updateViewOutputNames(){let{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;let{outputNameElements:r}=this,{names:i}=e;for(let a=0;a<t;++a){let o=r[a];o.value=i[a],o.dataset.isValid="true",tp(o)}r[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){let{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:r}=this;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=r[a*t+i];o.value=e[a*(t+1)+i].toString(),o.dataset.isValid="true",tp(o)}}ensureViewRankUpdated(){let e=this.transform.value,{rank:t}=e,r=e.sourceRank;if(this.curSourceRank===r&&this.curRank===t)return;let{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o}=this,{element:l,coefficientElements:c,outputNameElements:d,outputScaleElements:p,outputScaleSuggestionElements:m,inputScaleSuggestionElements:y,outputBoundsElements:v,coefficientContainer:b,translationContainer:x,outputNameContainer:C,inputNameContainer:L,inputScaleContainer:A,inputLowerBoundsContainer:D,inputUpperBoundsContainer:R,outputScaleContainer:P}=this;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Me(b),Me(x),b.appendChild(x),Me(C),Me(L),Me(A),Me(D),Me(R),Me(P),a.length=0,o.length=0,i.length=0,p.length=0,m.length=0,y.length=0,c.length=0,d.length=0,v.length=0;for(let E=0;E<t;++E){let V=O=>{O.classList.add("neuroglancer-coordinate-space-transform-input"),E>=r&&O.classList.add(mA)};{let O=document.createElement("div");O.classList.add("neuroglancer-coordinate-space-transform-input-name"),V(O),O.style.gridRowStart="sourceNames",O.style.gridColumnStart=`sourceDim ${E+1}`,L.appendChild(O),a.push(O)}{let{cellElement:O,inputElement:B,suggestionElement:W}=vA();O.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),V(O),O.style.gridRowStart="sourceScales",O.style.gridColumnStart=`sourceDim ${E+1}`,A.appendChild(O),o.push(B),y.push(W);let _=E;W.addEventListener("click",()=>{let F=Ov(this.transform,_);F!==void 0&&(this.transform.inputSpace.value=CA(this.transform.inputSpace.value,_,F.scale,F.unit))})}{let O=document.createElement("div");V(O),O.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),O.style.gridRowStart="sourceLower",O.style.gridColumnStart=`sourceDim ${E+1}`,D.appendChild(O);let B=document.createElement("div");V(B),B.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),B.style.gridRowStart="sourceUpper",B.style.gridColumnStart=`sourceDim ${E+1}`,R.appendChild(B),i.push({lower:O,upper:B})}}for(let E=0;E<t;++E){for(let V=0;V<=t;++V){let O=document.createElement("input");O.classList.add("neuroglancer-coordinate-space-transform-coeff"),O.spellcheck=!1,O.autocomplete="off",O.size=1,O.style.gridRowStart=`outputDim ${E+1}`,O.placeholder=" ",O.style.gridColumnStart=`sourceDim ${V+1}`,c[V*t+E]=O,V===t?O.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):V==r&&O.classList.add(mA),(V===t?x:b).appendChild(O)}{let{cellElement:V,suggestionElement:O,inputElement:B}=vA();V.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputScales";let W=E;O.addEventListener("click",()=>{let{value:_}=this.transform,F=Vv(_,W);F!==void 0&&(this.transform.outputSpace.value=CA(_.outputSpace,W,F.scale,F.unit))}),m.push(O),P.appendChild(V),p.push(B)}{let V=document.createElement("div");V.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputNames";let O=bA();O.title="Rebind to a different dimension",E>=r?O.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(O.title+=", or delete to remove source dimension"),O.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",d.push(O),C.appendChild(V),V.appendChild(O);let B=document.createElement("div");B.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(B);let W=document.createElement("div");W.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(W),v.push({lower:B,upper:W}),V.addEventListener("mousedown",_=>{_.target!==O&&(O.focus(),_.preventDefault())})}}d.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",C.appendChild(this.addOutputDimensionCell),this.curSourceRank=r,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;let{inputSpace:e,rank:t,sourceRank:r}=this.transform.value,{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o,inputScaleSuggestionElements:l}=this,{names:c,scales:d,units:p,bounds:{lowerBounds:m,upperBounds:y}}=e;for(let v=0;v<t;++v){let b=o[v],x=d[v],C=p[v];b.value=Li(x,C,{elide1:!1}),b.dataset.isValid="true",tp(b);let L;if(v<r){let P=c[v];P||(P=`${v}`),a[v].textContent=P,L=`source dimension ${P}`,b.title=`Override scale of ${L}`}else L="singleton dimension",b.title=`Set extent of ${L}`;let{lower:A,upper:D}=gA(m[v],y[v]),R=i[v];R.lower.textContent=A,R.lower.title=`Lower bound of ${L}`,R.upper.title=`Upper bound of ${L}`,R.upper.textContent=D,SA(l[v],Ov(this.transform,v),x,C,`Revert scale of ${L} to `)}}updateViewOutputScales(){let{value:e}=this.transform,{rank:t,names:r,units:i,scales:a,bounds:{lowerBounds:o,upperBounds:l}}=e.outputSpace,{outputScaleElements:c,outputBoundsElements:d,outputScaleSuggestionElements:p}=this;for(let m=0;m<t;++m){let y=c[m],v=a[m],b=i[m];y.value=Li(v,b,{elide1:!1}),tp(y);let x=r[m];y.dataset.isValid="true";let C=`Change coordinates of ${Po(x)?"local":"global"} dimension ${x}`;y.title=`${C} (does not rescale the source)`;let{lower:L,upper:A}=gA(o[m],l[m]),D=d[m];D.lower.textContent=L,D.upper.textContent=A,SA(p[m],Vv(e,m),v,b,`${C} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){let{transform:{value:r,mutableSourceRank:i,defaultTransform:a}}=this,{rank:o}=r;this.resetToIdentityButton.style.visibility=e||!Ok(r.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!i&&(e||t||!Wk(a,r))?"visible":"hidden"}updateView(){let e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){Ye(this.element),super.disposed()}};var tx=rt(Dt());function wA(n,e,{horizontal:t=!1,vertical:r=!0,topMargin:i=6,bottomMargin:a=6,leftMargin:o=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:d=!0}={}){let p=e.getBoundingClientRect();if(t){let m=n.ownerDocument.documentElement.clientWidth,y=p.right,v=m-p.left;y>v?(n.style.left="",n.style.right=`${m-p.right}px`,d&&(n.style.maxWidth=y-o+"px")):(n.style.right="",n.style.left=`${p.left}px`,d&&(n.style.maxWidth=v-l+"px"))}if(r){let m=n.ownerDocument.documentElement.clientHeight,y=p.top-i,v=m-p.bottom-a;n.style.left=`${p.left}px`,n.style.width=`${p.width}px`,y>v*3?(n.style.top="",n.style.bottom=`${m-p.top}px`,c&&(n.style.maxHeight=y+"px")):(n.style.top=`${p.bottom}px`,n.style.bottom="",c&&(n.style.maxHeight=v+"px"))}}function TA(n){let e=n[Symbol.iterator](),{value:t,done:r}=e.next();if(r)return"";let i=t.length;for(;i>0;){let{value:a,done:o}=e.next();if(o)break;let l=0;for(;l<i&&t.charCodeAt(l)===a.charCodeAt(l);++l);i=l}return t.substring(0,i)}var LA=10,Bm=.5,kA=class{constructor(){this.anchorIndex=0;this.anchorClientOffset=0}splice(e){let{anchorIndex:t}=this,r=0;for(let i of e){if(r+=i.retainCount,t<r)break;let{deleteCount:a}=i;if(t<r+a){t=r;break}let{insertCount:o}=i;t=t-a+o,r+=o-o}this.anchorIndex=t}},ex=class{constructor(){this.startIndex=0;this.endIndex=0;this.anchorIndex=0;this.anchorOffset=0;this.scrollOffset=0}},EA=class{constructor(){this.itemSize=[];this.totalKnownSize=0;this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!=null?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,r=0){for(;t<e;++t)r+=this.getEstimatedSize(t);for(;t>e;--t)r-=this.getEstimatedSize(t-1);return r}getRangeSize(e,t){var o;let r=0,{itemSize:i,averageSize:a}=this;for(let l=e;l<t;++l)r+=(o=i[l])!=null?o:a;return r}splice(e){let{itemSize:t}=this;t=this.itemSize=NT(t,e),this.totalKnownSize=t.reduce((r,i)=>r+i,0),this.numItemsInTotalKnownSize=t.reduce(r=>r+1,0)}};function nH(n,e,t,r,i,a){let{anchorIndex:o,anchorClientOffset:l}=a,c=i.getEstimatedOffset(o),d,p,m,y,v;if(r===0||i.totalKnownSize===0)d=Math.max(0,o-LA/2),p=Math.min(t,d+LA),v=o,m=0,y=l;else{let b=i.getEstimatedTotalSize(),x=Math.max(0,b-r);y=c-l,y=Math.max(0,Math.min(x,y));let C=y-2*Bm*r,L=y-Bm*r,A=y+r+Bm*r,D=c-l+r+2*Bm*r;d=Math.min(t,e.startIndex);let R=i.getEstimatedOffset(d,o,c);if(R<C)for(;d+1<t;++d){let E=i.getEstimatedSize(d);if(R+E>=L)break;R+=E}if(R>=L)for(;R>C&&d>0;--d)R-=i.getEstimatedSize(d-1);p=Math.min(t,e.endIndex);let P=i.getEstimatedOffset(p,o,c);if(P<A)for(;P<=D&&p+1<=t;++p)P+=i.getEstimatedSize(p);else if(P>=D)for(;p>d;--p){let E=i.getEstimatedSize(p-1);if(P-E<A)break;P-=E}for(v=o,m=c;v<d;++v)m+=i.getEstimatedSize(v);for(;v>p;--v)m-=i.getEstimatedSize(v-1)}n.startIndex=d,n.endIndex=p,n.anchorIndex=v,n.anchorOffset=m,n.scrollOffset=y}function rH(n,e){let t=e.getEstimatedOffset(n.anchorIndex),r=n.anchorOffset;n.anchorOffset=t,n.scrollOffset+=t-r}function iH(n,e){return n.startIndex<e.startIndex||n.endIndex>e.endIndex}var ll=class extends ${constructor(e){super();this.element=document.createElement("div");this.scrollContent=document.createElement("div");this.header=document.createElement("div");this.body=document.createElement("div");this.topItems=document.createElement("div");this.bottomItems=document.createElement("div");this.renderedItems=[];this.renderGeneration=-1;this.listGeneration=-1;this.newRenderedItems=[];this.state=new kA;this.renderParams=new ex;this.newRenderParams=new ex;this.sizes=new EA;this.debouncedUpdateView=this.registerCancellable(Be(()=>this.updateView()));this.resizeObserver=new ResizeObserver(()=>this.updateView());let{selectedIndex:t}=e;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);let r=this.source=e.source;this.sizes.itemSize.length=r.length;let{element:i,header:a,body:o,scrollContent:l,topItems:c,bottomItems:d}=this;this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.disconnect()),i.appendChild(l),i.style.overflowAnchor="none",l.appendChild(a),l.appendChild(o),a.style.position="sticky",a.style.zIndex="1",a.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",a.style.width="min-content",a.style.minWidth="100%",d.style.width="min-content",d.style.minWidth="100%"):(l.style.width="100%",a.style.width="100%",d.style.width="100%"),o.appendChild(c),o.appendChild(d),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",d.style.height="0",d.style.position="relative",i.addEventListener("scroll",()=>{let p=i.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-p,this.renderParams.scrollOffset=p,this.debouncedUpdateView()}),r.changed!==void 0&&this.registerDisposer(r.changed.add(p=>{this.sizes.splice(p),this.state.splice(p),this.renderedItems.length=0,this.debouncedUpdateView()})),r.renderChanged!==void 0&&this.registerDisposer(r.renderChanged.add(this.debouncedUpdateView))}updateView(){let{element:e}=this;if(e.offsetHeight===0)return;let t=e.clientHeight-this.header.offsetHeight,{source:r,state:i,sizes:a}=this,o=r.length,{body:l,topItems:c,bottomItems:d}=this,{changed:p,renderChanged:m}=r,y;for(;;){y=this.newRenderParams;let x=this.renderParams;nH(y,x,o,t,a,i);let C;if(m!==void 0&&m.count!==this.renderGeneration||p!==void 0&&p.count!==this.listGeneration?(this.renderGeneration=m===void 0?-1:m.count,this.listGeneration=p===void 0?-1:p.count,C=!0,this.renderedItems.length=0):C=!1,!C&&!iH(y,x)){x.scrollOffset=y.scrollOffset,y=x;break}this.renderParams=y,this.newRenderParams=x;let L=this.renderedItems,A=this.newRenderedItems;A.length=0,this.renderedItems=A,this.newRenderedItems=L;let{source:D}=this,{render:R}=D,{startIndex:P,endIndex:E,anchorIndex:V}=y;function*O(B,W){for(let _=B;_<W;++_){let F=L[_];F===void 0&&(F=R.call(D,_)),A[_]=F,yield F}}In(c,O(P,V)),In(d,O(V,E));for(let B=P;B<E;++B){let F=A[B].getBoundingClientRect().height,N=a.itemSize[B];N!==void 0&&(a.totalKnownSize-=N,--a.numItemsInTotalKnownSize),a.itemSize[B]=F,a.totalKnownSize+=F,++a.numItemsInTotalKnownSize}}rH(y,a),i.anchorIndex=y.anchorIndex,i.anchorClientOffset=y.anchorOffset-y.scrollOffset;let v=a.getRangeSize(y.startIndex,y.anchorIndex),b=a.getEstimatedTotalSize();l.style.height=`${b}px`,c.style.top=`${y.anchorOffset-v}px`,d.style.top=`${y.anchorOffset}px`,e.scrollTop=y.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){let{startIndex:t,endIndex:r}=this.renderParams,{renderedItems:i}=this;for(let a=t;a<r;++a){let o=i[a];o!==void 0&&e(o,a)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){let t=this.sizes.getEstimatedOffset(e),r=t+this.sizes.getEstimatedSize(e),i=this.element.scrollTop;if(t<i)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>i&&r>i+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){Ye(this.element)}};var nx="neuroglancer-multiline-autocomplete-completion-active",aH=!1;function oH(n){let e=document.createElement("div");return e.textContent=n.value,e}function*DA(n){for(;n.length>0;){let e=n.match(/[:/_]+/);if(e===null){yield n;return}let t=e.index+e[0].length;yield n.substring(0,t),n=n.substring(t)}}function PA(n){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=n.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=n.description||"",e.appendChild(t),e}var sH=_e.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),lH=200,rx=class extends ${constructor(e){super();this.element=document.createElement("div");this.inputElement=document.createElement("span");this.hintElement=document.createElement("span");this.completionsVirtualList=void 0;this.onCommit=new We;this.onInput=new We;this.prevInputValue="";this.completionsVisible=!1;this.activeCompletionPromise=null;this.activeCompletionCancellationToken=void 0;this.hasFocus=!1;this.completionResult=null;this.dropdownContentsStale=!0;this.hasResultForDropdown=!1;this.commonPrefix="";this.completionDisabled=-1;this.activeIndex=-1;this.dropdownStyleStale=!0;this.resizeHandler=()=>{!this.completionsVisible||this.updateDropdownStyle()};this.resizeObserver=new ResizeObserver(this.resizeHandler);this.debouncedUpdateHintState=this.registerCancellable((0,tx.default)(()=>this.updateHintState(),0));this.completer=e.completer;let{delay:t=lH}=e,r=this.scheduleUpdateCompletions=(0,tx.default)(()=>{let c=this.activeCompletionCancellationToken=new dr,d=this.activeCompletionPromise=this.completer(this.value,c);d!==null&&d.then(p=>{this.activeCompletionPromise===d&&(this.setCompletions(p),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{r.cancel()});let{element:i,inputElement:a,hintElement:o}=this;i.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.unobserve(a)),a.contentEditable="true",a.spellcheck=!1,i.appendChild(document.createTextNode("\u200B")),i.appendChild(a),i.appendChild(o),a.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),a.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),a.addEventListener("copy",c=>{let{clipboardData:d}=c;if(d!==null){let p=window.getSelection();p!==null&&!p.isCollapsed&&p.containsNode(a,!0)&&d.setData("text/plain",p.toString())}c.preventDefault(),c.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{let c=this.getSelectionRange(),{completionDisabled:d}=this;c!==void 0&&c.begin===d&&c.end===d||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),i.addEventListener("pointerdown",c=>{let{target:d}=c;if(d instanceof Node){if(a.contains(d))return;let{completionsVirtualList:p}=this;if(p!==void 0&&p.element.contains(d))return}a===document.activeElement&&(this.moveCaretToEndOfInput(),c.stopPropagation(),c.preventDefault())}),i.addEventListener("click",()=>{a.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();let c=document.createRange(),{childNodes:d}=a;c.setStart(a,0),d.length===0?c.setEnd(a,0):c.setEndAfter(d[d.length-1]);let p=window.getSelection();p!==null&&(p.removeAllRanges(),p.addRange(c)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{if(this.hasFocus){if(aH)return;this.hasFocus=!1,this.updateDropdown()}this.debouncedUpdateHintState();let c=window.getSelection();c!==null&&c.containsNode(this.inputElement,!0)&&c.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});let l=this.registerDisposer(new Gt(a,sH));l.allShortcutsAreGlobal=!0,le(a,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),le(a,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),le(a,"home",()=>{this.moveCaretToBeginningOfInput()}),le(a,"end",()=>{this.moveCaretToEndOfInput()}),le(a,"choose-active-completion-or-prefix",c=>{this.selectActiveCompletion(!0)&&c.preventDefault()}),le(a,"commit",c=>{if(this.selectActiveCompletion(!1))c.stopPropagation();else{let d=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,d)}}),le(a,"cancel",c=>{c.stopPropagation(),this.cancel()&&(c.detail.preventDefault(),c.detail.stopPropagation())})}disableCompletion(){let e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){let e=window.getSelection();if(e===null||e.rangeCount===0)return;let t=e.getRangeAt(0),{inputElement:r}=this,i=document.createRange();i.setStart(r,0),i.setEnd(t.startContainer,t.startOffset);let a=i.toString().length,o=e.toString().length;return{begin:a,end:a+o}}setValueAndSelection(e,t=void 0){let r=this.completionDisabled!==-1;this.onInput.dispatch(e);let{inputElement:i}=this;Me(i);let a=0,o=t!==void 0?document.createRange():void 0,l=!0;for(let c of DA(e)){l||i.appendChild(document.createElement("wbr")),l=!1;let d=a+c.length,p=document.createTextNode(c);if(i.appendChild(p),o!==void 0){let{begin:m,end:y}=t;m>=a&&m<=d&&o.setStart(p,m-a),y>=a&&y<=d&&o.setEnd(p,y-a)}a=d}if(o!==void 0){l&&(o.setStart(i,0),o.setEnd(i,0));let c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(o))}this.completionDisabled=r&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){let{inputElement:e}=this;if(document.activeElement!==e)return!1;let t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){let{value:e}=this;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let{completionsVirtualList:t}=this;if(t===void 0)return;let r=t.element;for(let i=e.target;i instanceof HTMLElement&&i!==r;i=i.parentElement){let a=i.dataset.completionIndex;if(a!==void 0){this.selectCompletion(Number(a));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let{activeIndex:t}=this,r=this.completionResult.completions.length;t===-1?e>0?t=0:t=r-1:t=(t+e+r)%r,this.setActiveIndex(t)}shouldShowDropdown(){let{completionResult:e}=this;return e===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){let{completionsVirtualList:e,element:t}=this;e!==void 0&&wA(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();let r=this.completionResult,{makeElement:i=oH}=r;e=this.completionsVirtualList=new ll({source:{length:r.completions.length,render:a=>{let o=r.completions[a],l=i.call(r,o);return l.classList.add("neuroglancer-multiline-autocomplete-completion"),l.dataset.completionIndex=`${a}`,this.activeIndex===a&&l.classList.add(nx),l}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",a=>{this.inputElement.focus(),a.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);let{activeIndex:t}=this;t!==-1&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let{completions:t}=e;if(t.length===0)return;let r=this.prevInputValue;if(r!==void 0){if(this.completionResult=e,t.length===1){let i=t[0];e.showSingleResult?this.hasResultForDropdown=!0:i.value.startsWith(r)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let i=TA(function*(){for(let o of e.completions)yield o.value}()),a=this.getCompletedValue(i);a.startsWith(r)&&(this.commonPrefix=a,this.setHintValue(a))}this.updateDropdown()}}setHintValue(e){let t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);let{hintElement:r}=this;Me(r);let i=!0;for(let a of DA(e)){i||r.appendChild(document.createElement("wbr")),i=!1;let o=document.createTextNode(a);r.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){let{activeIndex:t}=this,{completionsVirtualList:r}=this;if(r!==void 0){if(t!==-1){let i=r.getItemElement(t);i!==void 0&&i.classList.remove(nx)}if(e!==-1){let i=r.getItemElement(e);i!==void 0&&i.classList.add(nx),r.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,r=this.prevInputValue;return r===void 0?"":r.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){let e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);let r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){let e=document.createRange(),{inputElement:t}=this,{childNodes:r}=t,i=r[r.length-1];i===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(i),e.setEndAfter(i));let a=window.getSelection();a!==null&&(a.removeAllRanges(),a.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(t===-1){if(!e)return!1;let{completionResult:i}=this;if(i!==null&&i.completions.length===1)t=0;else{let{commonPrefix:a}=this;return a.length>this.value.length?(this.value=a,this.moveCaretToEndOfInput(),!0):!1}}let r=this.getCompletedValueByIndex(t);return this.value===r?!1:(this.value=r,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;let e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";let{completionsVirtualList:e}=this;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){let{completionsVirtualList:e}=this;e!==void 0&&e.dispose(),Ye(this.element),this.cancelActiveCompletion(),super.disposed()}};var an=class extends ${constructor(e=new kt(kt.VISIBLE)){super();this.visibility=e;this.element=document.createElement("div");let{element:t}=this;t.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){Ye(this.element),super.disposed()}},IA=class extends ${constructor(){super(...arguments);this.changed=new ae;this.options=new Map;this.optionsChanged=new ae;this.selectedValue=void 0;this.defaultValue=void 0;this.ready_=!0}get value(){let{selectedValue:e}=this;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0);let{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){let e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){let{options:r}=this;if(r.has(e))throw new Error(`Option already defined: ${JSON.stringify(e)}.`);r.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}toJSON(){let{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}},AA=class extends ${constructor(e,t,r=new kt(kt.VISIBLE),i=!1){super();this.getter=e;this.selected=t;this.visibility=r;this.invalidateByDefault=i;this.element=document.createElement("div");this.tabs=new Map;this.tabVisibilityChanged=new We;this.debouncedUpdateSelectedTab=this.registerCancellable(Be(()=>this.updateSelectedTab()));let{element:a}=this;a.className="neuroglancer-stack-view",this.registerDisposer(r.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){let{tabs:t}=this,r=t.get(e);r!==void 0&&(r.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){let t=this.tabs.get(e);t!==void 0&&(t.visibility.value=kt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){let{tabs:t}=this,r=t.get(e);r===void 0&&(r=this.getter(e),this.element.appendChild(r.element),t.set(e,r)),r.element.style.display="",r.visibility.value=kt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){let{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){let{tabs:t}=this;for(let[r,i]of t)e!==void 0&&e(r)||(t.delete(r),i.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),Ye(this.element),super.disposed()}},ix=class extends IA{};function cH(n,e){let t="neuroglancer-selected-tab-label";e?n.classList.add(t):n.classList.remove(t)}var ax=class extends ${constructor(e,t=new kt(kt.VISIBLE)){super();this.visibility=t;this.element=document.createElement("div");this.tabBar=document.createElement("div");this.tabLabels=new Map;this.tabsGeneration=-1;this.debouncedUpdateView=this.registerCancellable(Be(()=>this.updateTabs()));this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;let{element:r,tabBar:i}=this;r.className="neuroglancer-tab-view",i.className="neuroglancer-tab-view-bar",r.appendChild(i),this.registerDisposer(t.changed.add(this.debouncedUpdateView));let a=this.stack=this.registerDisposer(new AA(e.makeTab,e.selectedTab,this.visibility));r.appendChild(a.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView)),this.registerDisposer(e.selectedTab.changed.add(()=>this.updateTabLabelStyles())),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){let e=this.selectedTab.value;for(let[t,r]of this.tabLabels)cH(r,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{let e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:r})=>r===t)!==void 0)}Me(this.tabBar),this.tabsGeneration=-1}}makeTabs(){let{tabBar:e,tabLabels:t,handleTabElement:r}=this;for(let{id:i,label:a}of this.tabs.value){let o=document.createElement("div");o.classList.add("neuroglancer-tab-label"),o.textContent=a,o.addEventListener("click",()=>{this.selectedTab.value=i}),r!==void 0&&r(i,o),t.set(i,o),e.appendChild(o)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Me(this.tabBar),this.tabLabels.clear(),Ye(this.element),super.disposed()}};var MA=class extends rx{constructor(e){let{manager:t}=e.source.layer,r=(a,o)=>t.dataSourceProviderRegistry.completeUrl({url:a,chunkManager:t.chunkManager,cancellationToken:o}).then(l=>({completions:l.completions,makeElement:PA,offset:l.offset,showSingleResult:!0}));super({completer:r,delay:0});this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new Ae(!1);let i=a=>{a!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}},ox=class extends ${constructor(e){super();this.model=e;this.element=document.createElement("ul");this.generation=-1;this.element.classList.add("neuroglancer-layer-data-sources-source-messages");let t=this.registerCancellable(Be(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>Ye(this.element)),this.updateView()}updateView(){let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;let{element:r}=this;Me(r);let i=new Set;for(let a of e){let o=`${a.severity} ${a.message}`;if(i.has(o))continue;i.add(o);let l=document.createElement("li");r.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${hr[a.severity]}`),l.textContent=a.message}}},RA=class extends ${constructor(e,t){super();this.loadedSubsource=t;this.element=document.createElement("div");let{element:r}=this;r.classList.add("neuroglancer-layer-data-source-subsource");let i=document.createElement("label"),a=document.createElement("span"),o=()=>{i.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));let l=this.registerDisposer(new pr({get value(){return t.enabled},set value(b){t.enabled=b,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));i.classList.add("neuroglancer-layer-data-sources-info-line"),i.appendChild(l.element);let c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");let{id:d}=t.subsourceEntry;d!=="default"&&(c.textContent=d),i.appendChild(c),a.classList.add("neuroglancer-layer-data-sources-source-type");let p=this.registerDisposer(new ox(this.loadedSubsource.messages));r.appendChild(i),i.appendChild(a),r.appendChild(p.element);let m="",{subsource:y}=t.subsourceEntry,{volume:v}=y;if(v instanceof Ft)m=`${z[v.dataType].toLowerCase()} volume`;else if(y.mesh instanceof Yr)m="meshes (single-res.)";else if(y.mesh instanceof eo)m="meshes (multi-res.)";else if(y.mesh instanceof to)m="skeletons";else if(y.segmentPropertyMap!==void 0)m="segment property map";else if(y.local!==void 0)switch(y.local){case oi.annotations:m="Local annotations";break;case oi.equivalences:m="local segmentation graph";break}else y.staticAnnotations!==void 0?m="default annotations":y.annotation!==void 0?m="annotations":y.singleMesh!==void 0?m="single mesh":y.segmentationGraph!==void 0&&(m="segmentation graph");a.textContent=m}},_A=class extends ${constructor(e){super();this.source=e;this.element=document.createElement("div");let{element:t}=this,r=document.createElement("label");r.classList.add("neuroglancer-layer-data-sources-source-default"),r.appendChild(this.registerDisposer(new pr({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(a){if(e.enableDefaultSubsources!==a){if(e.enableDefaultSubsources=a,a)for(let o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),r.appendChild(document.createTextNode("Enable default subsource set")),r.title="Enable the default set of subsources for this data source.",t.appendChild(r);for(let a of e.subsources)t.appendChild(this.registerDisposer(new RA(e,a)).element);let{transform:i}=e;if(i.mutableSourceRank||i.value.sourceRank!==0){let a=this.registerDisposer(new Zb(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(a.element)}this.registerDisposer(()=>Ye(this.element))}},VA=class extends ${constructor(e,t){super();this.tab=e;this.source=t;this.element=document.createElement("div");this.seenGeneration=0;this.generation=-1;let r=this.urlInput=this.registerDisposer(new MA(this)),i=(o,l)=>{let{source:c}=this,d=c.spec,p=this.source.layer;if(o=p.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==r.value&&(r.disableCompletion(),r.setValueAndSelection(o,{begin:o.length,end:o.length})),r.dirty.value=!1,o&&o===d.url){l&&e.detectedLayerConstructor!==void 0&&OA(c.layer);return}if(p instanceof Fi)try{let m=p.manager.dataSourceProviderRegistry.suggestLayerName(o);Fm(p.managedLayer,m)}catch{}c.spec={...d,url:o}};r.onCommit.add(i);let{element:a}=this;a.classList.add("neuroglancer-layer-data-source"),a.appendChild(r.element),a.appendChild(this.registerDisposer(new ox(t.messages)).element),this.updateView()}updateView(){let e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;let{loadState:t}=this.source,{loadedView:r}=this;if(r!==void 0){if(r.source===t)return;r.dispose(),r=this.loadedView=void 0}t instanceof Am&&(r=this.loadedView=new _A(t),this.element.appendChild(r.element))}disposed(){let{loadedView:e}=this;e!==void 0&&e.dispose(),Ye(this.element),super.disposed()}};function OA(n){if(n instanceof Fi){let e=n.detectedLayerConstructor;if(e!==void 0)return np(n.managedLayer,e),!0}return!1}var sx=class extends an{constructor(e){super();this.layer=e;this.generation=-1;this.sourceViews=new Map;this.addDataSourceIcon=Nm({title:"Add additional data source"});this.layerTypeDetection=document.createElement("div");this.layerTypeElement=document.createElement("span");this.dataSourcesContainer=document.createElement("div");this.detectedLayerConstructor=void 0;let{element:t,dataSourcesContainer:r}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),r.classList.add("neuroglancer-layer-data-sources-container");let{addDataSourceIcon:i}=this;if(i.style.alignSelf="start",i.addEventListener("click",()=>{let o=this.layer.addDataSource(void 0);this.updateView();let l=this.sourceViews.get(o);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Fi){let{layerTypeDetection:o,layerTypeElement:l}=this;o.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(l),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{OA(e)})}let a=this.reRender=Be(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(a)),this.registerDisposer(this.visibility.changed.add(a)),this.updateView()}updateLayerTypeDetection(){let e=(()=>{let r=this.layer;if(!(r instanceof Fi))return;let i=r.detectedLayerConstructor;if(i!==void 0){for(let a of this.sourceViews.values())if(a.urlInput.dirty.value)return;return i}})();if(e===this.detectedLayerConstructor)return;let{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,e!==void 0){let{layerTypeElement:r}=this;r.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){let{sourceViews:e}=this;for(let t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;let e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;let t=Date.now(),{sourceViews:r}=this,{layer:i}=this;function*a(){let o=!0,{dataSources:l}=i;for(let c of l){let d=r.get(c);d===void 0&&(d=new VA(this,c),d.registerDisposer(d.urlInput.dirty.changed.add(this.reRender)),r.set(c,d)),d.seenGeneration=t,d.updateView();let p=c.spec.url;l.length===1&&p===""&&setTimeout(()=>{d.urlInput.inputElement.focus()},0),o=c.spec.url.length===0,yield d.element}o||(yield this.addDataSourceIcon)}In(this.dataSourcesContainer,a.call(this));for(let[o,l]of r)l.seenGeneration!==t&&(l.dispose(),r.delete(o))}this.updateLayerTypeDetection()}};var Um="tab",NA="tabs",BA="panels",FA={...ui,row:0},lx={...ui,visible:!0,row:0},Ic=class extends ${constructor(e){super();this.panels=e;this.layer=this.panels.layer;this.location=new Jn(lx);this.tabsChanged=new We;this.selectedTab=new Ae(void 0);this.tabs=[]}initialize(){let{panels:e}=this;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var a;e.specificationChanged.dispatch();let{layer:t}=this,{selectedLayer:r}=t.manager.root;if(((a=r.layer)==null?void 0:a.layer)!==t||this!==t.panels.panels[0])return;let i=this.location.value;r.location.value!==i&&(r.location.value=i,r.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)})}normalizeTabs(){let{tabs:e}=this;if(e.length===0){this.selectedTab.value=void 0;return}let t=this.layer.tabs.options,r=o=>{var l;return(l=t.get(o).order)!=null?l:0};e.sort((o,l)=>r(o)-r(l));let{selectedTab:i}=this,a=i.value;(a===void 0||!e.includes(a))&&(i.value=e[0])}pin(){var a;let{layer:e}=this,{selectedLayer:t}=e.manager.root;if(((a=t.layer)==null?void 0:a.layer)!==e||this!==e.panels.panels[0]||this.tabs.length===0)return;let{panels:r}=this,i=e.registerDisposer(new Ic(r));r.panels.splice(0,1,i),r.panels.push(this),r.updateTabs(),i.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var l;let{panels:e}=this,t=e.panels.indexOf(this);if(t===-1||t===0)return;let{layer:r}=this,{selectedLayer:i}=r.manager.root,a=(l=i.layer)==null?void 0:l.layer;i.visible&&a!=null&&a!=r&&a.panels.panels[0].pin(),e.panels.splice(t,1);let[o]=e.panels.splice(0,1,this);if(this.explicitTabs===void 0)r.unregisterDisposer(o);else{e.panels.push(o);for(let c=1,d=e.panels.length;c<d;++c){let p=e.panels[c];p.explicitTabs===void 0&&(p.explicitTabs=new Set(p.tabs))}}this.explicitTabs=void 0,e.updateTabs(),i.layer=r.managedLayer,i.location.value=this.location.value,i.location.locationChanged.dispatch(),i.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;let{panels:r}=this;{let{explicitTabs:o}=this;o!==void 0&&o.delete(e)}let{layer:i}=this,a=i.registerDisposer(new Ic(r));a.location.value=t,a.explicitTabs=new Set([e]),r.panels.splice(1,0,a),r.updateTabs(),a.initialize(),i.manager.root.layerManager.layersChanged.dispatch(),r.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{let{explicitTabs:i}=this;i!==void 0&&i.delete(e)}{let{explicitTabs:i}=t;i!==void 0&&i.add(e)}let{panels:r}=this;r.updateTabs(),t.selectedTab.value=e,r.specificationChanged.dispatch()}mergeInto(e){let{explicitTabs:t}=e;if(t!==void 0)for(let i of this.tabs)t.add(i);let{panels:r}=this;r.removePanel(this)}},cx=class{constructor(e){this.layer=e;this.specificationChanged=new We;this.updating=!1;this.panels=[e.registerDisposer(new Ic(this))]}restoreState(e){let{panels:t}=this;t[0].selectedTab.value=de(e,Um,ne);let{layer:r}=this,{tabs:i}=r,a=new Set(i.options.keys());de(e,BA,o=>be(o,l=>{Z(l);let c=new Ic(this);c.location.restoreState(l),!!c.location.visible&&(c.selectedTab.value=de(l,Um,ne),c.explicitTabs=de(l,NA,d=>{let p=new Set;for(let m of Zt(d))!a.has(m)||(a.delete(m),p.add(m));return p}),c.explicitTabs===void 0?(c.tabs=Array.from(a),a.clear()):c.tabs=Array.from(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),r.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Array.from(a),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;let t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var o;let{layer:e}=this,{tabs:t}=e,r=new Set(t.options.keys()),{panels:i}=this;this.updating=!0;let a=l=>{let c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Array.from(r),r.clear();else{l.tabs=Array.from(l.explicitTabs);for(let d of l.tabs)r.delete(d)}Ce(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<i.length;){let c=i[l];if(c.location.visible&&(a(c),c.tabs.length!==0)){++l;continue}i.splice(l,1),e.unregisterDisposer(c)}if(a(i[0]),i[0].tabs.length===0){let{selectedLayer:l}=this.layer.manager.root;((o=l.layer)==null?void 0:o.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var r;let{panels:e}=this,t={};if(t[Um]=e[0].selectedTab.value,e.length>1){let i=[];for(let a=1,o=e.length;a<o;++a){let l=e[a],c=(r=l.location.toJSON())!=null?r:{};c[Um]=l.selectedTab.value;let{explicitTabs:d}=l;d!==void 0&&(c[NA]=Array.from(d)),i.push(c)}t[BA]=i}return t}};var UA=rt(Dt());var uH=/^[A-Z]$/,WA=class extends ${constructor(e,t){super();this.tool=e;this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(le(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}},ao=class extends ${constructor(e){super();this.layer=e;this.changed=new We;this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this,{keyBinding:t}=this;t!==void 0&&e.toolBinder.set(t,void 0)}},rp=class extends ${constructor(e){super();this.layer=e;this.changed=new We}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}};function GA(n,e){var i;if(e===void 0)return;typeof e=="string"&&(e={type:e}),Z(e);let t=j(e,"type",ne),r=(i=ux.get(n.constructor))==null?void 0:i.get(t);if(r===void 0&&(r=pH.get(t)),r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}function dH(n,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),Z(e);let t=j(e,"type",ne),r=zA.get(t);if(r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}var zA=new Map,pH=new Map,ux=new Map;function ip(n,e){zA.set(n,e)}function cl(n,e,t){let r=ux.get(n);r===void 0&&(r=new Map,ux.set(n,r)),r.set(e,t)}var dx=class extends ${constructor(e){super();this.layer=e;this.changed=new We}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){let e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=dH(this.layer,e)}reset(){this.value=void 0}toJSON(){let e=this.value_;if(e!==void 0)return e.toJSON()}},px=class extends ${constructor(){super(...arguments);this.bindings=new Map;this.changed=new We;this.debounceDeactivate=this.registerCancellable((0,UA.default)(()=>this.deactivate(),1))}get(e){return this.bindings.get(e)}set(e,t){let{bindings:r}=this,i=r.get(e);if(i!==void 0){i.keyBinding=void 0,r.delete(e);let a=i.layer.toolBinder;a.bindings.delete(e),a.jsonToKey.delete(JSON.stringify(i.toJSON())),this.destroyTool(i),a.changed.dispatch()}if(t!==void 0){let a=t.layer.toolBinder,o=JSON.stringify(t.toJSON()),l=a.jsonToKey.get(o);if(l!==void 0){let c=a.bindings.get(l);c.keyBinding=void 0,r.delete(l),a.bindings.delete(l),a.jsonToKey.delete(o),this.destroyTool(c)}a.bindings.set(e,t),t.keyBinding=e,a.jsonToKey.set(o,e),r.set(e,t),a.changed.dispatch()}this.changed.dispatch()}activate(e,t){var o;let r=this.get(e);if(r===void 0){this.deactivate();return}if(this.debounceDeactivate.cancel(),r===((o=this.activeTool)==null?void 0:o.tool))return;let i=new WA(r,t);this.activeTool=i;let a=`Key${e}`;return i.registerEventListener(window,"keyup",l=>{l.code===a&&this.debounceDeactivate()}),i.registerEventListener(window,"blur",()=>{this.debounceDeactivate()}),r.activate(i),r}destroyTool(e){var t;((t=this.activeTool)==null?void 0:t.tool)===e&&this.deactivate(),e.dispose()}disposed(){this.deactivate(),super.disposed()}deactivate(){this.debounceDeactivate.cancel();let e=this.activeTool;e!==void 0&&(this.activeTool=void 0,e.dispose())}},fx=class{constructor(e){this.layer=e;this.bindings=new Map;this.jsonToKey=new Map;this.changed=new We;e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){let r=GA(this.layer,t);r!==void 0&&this.set(e,r)}removeJsonString(e){let t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){let{bindings:e}=this;if(e.size===0)return;let t={};for(let[r,i]of e)t[r]=i.toJSON();return t}clear(){let{globalBinder:e,bindings:t}=this;if(t.size!==0){for(let[r,i]of t)i.keyBinding=void 0,e.bindings.delete(r),e.destroyTool(i);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){Z(e);for(let[t,r]of Object.entries(e)){if(!t.match(uH))throw new Error(`Invalid tool key: ${JSON.stringify(t)}`);let i=GA(this.layer,r);if(i===void 0)return;this.set(t,i)}}}},Wm=class extends ${constructor(e,t){super();this.layer=e;this.toolJson=t;this.element=document.createElement("div");this.toolJsonString=JSON.stringify(this.toolJson);let{element:r}=this;r.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(Be(()=>this.updateView())))),this.updateView(),r.title="click \u2192 bind key, dbclick \u2192 unbind",r.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),hx(this,r,i=>this.layer.toolBinder.setJson(i,this.toolJson))}updateView(){let{toolBinder:e}=this.layer,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t!=null?t:" "}};function hx(n,e,t){let r;e.addEventListener("mousedown",i=>{if(i.button!==0||r!==void 0)return;i.preventDefault(),i.stopPropagation(),r=new $,n.registerDisposer(r),r.registerDisposer(new Ee(!1)).setText("Press A-Z to bind key"),r.registerEventListener(window,"keydown",o=>{let{code:l}=o,c=l.match(/^Key([A-Z])$/);if(c===null)return;o.stopPropagation(),o.preventDefault();let d=c[1];t(d)},{capture:!0}),r.registerEventListener(window,"mouseup",o=>{o.button!==0||r===void 0||(o.preventDefault(),o.stopPropagation(),n.unregisterDisposer(r),r.dispose(),r=void 0)})}),e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation()})}function mx(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-tool-button"),r.appendChild(n.registerDisposer(new Wm(e,t.toolJson)).element);let i=document.createElement("div");return i.classList.add("neuroglancer-tool-button-label"),i.textContent=t.label,t.title&&(i.title=t.title),r.appendChild(i),r}function fH(n){let e=n.registerDisposer(new Ee(!1));e.element.classList.add("neuroglancer-tool-status");let t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);let{inputEventMapBinder:r}=n;return n.inputEventMapBinder=(i,a)=>{let o=document.createElement("div");o.textContent=i.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),r(i,a)},{message:e,content:t}}function ap(n){let{message:e,content:t}=fH(n),r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");let i=document.createElement("div");i.classList.add("neuroglancer-tool-status-header-container"),i.appendChild(r),t.appendChild(i);let a=document.createElement("div");return a.classList.add("neuroglancer-tool-status-body"),t.appendChild(a),{message:e,body:a,header:r}}function HA(n,e){n.remove(e)}function $A(n,e){n.add(e)}var JA="tool",qA="toolBindings",gx="localPosition",YA="localDimensions",KA="source",hH="transform",XA="pick",QA=class{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}},mi=class extends ${constructor(e){super();this.managedLayer=e;this.pick=new mt(!0,!0);this.layersChanged=new ae;this.readyStateChanged=new ae;this.specificationChanged=new ae;this.renderLayers=new Array;this.loadingCounter=1;this.tabs=this.registerDisposer(new ix);this.panels=new cx(this);this.tool=this.registerDisposer(new dx(this));this.toolBinder=new fx(this);this.dataSourcesChanged=new ae;this.dataSources=[];this.localCoordinateSpaceCombiner.includeDimensionPredicate=Mv,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new sx(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=za,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationSerialized=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){let r=e.localCoordinateSpace=this.localCoordinateSpace.value,{rank:i}=r;if(i!==0){let o=de(t,gx,l=>$e(new Float32Array(i),l,Ze));o===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=o)}(e.annotationId=de(t,"annotationId",ne))!==void 0&&(e.annotationSourceIndex=de(t,"annotationSource",yt,0),e.annotationPartIndex=de(t,"annotationPart",yt),e.annotationSubsource=de(t,"annotationSubsource",ne)),e.value=t.value}displaySelectionState(e,t,r){return!1}selectionStateToJson(e,t){let r={};if(e.localPositionValid){let{localPosition:i}=e;i.length>0&&(r.localPosition=Array.from(i))}return e.annotationId!==void 0&&(r.annotationId=e.annotationId,r.annotationPart=e.annotationPartIndex,r.annotationSource=e.annotationSourceIndex,r.annotationSubsource=e.annotationSubsource),e.value!=null&&(r.value=e.value),r}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;let r=this.localPosition.value,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():i.set(r),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;let r=t.localPosition,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():e.localPosition.set(r),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationSerialized=t.annotationSerialized,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){let t=new jb(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(let t of this.dataSources){let{loadState:r}=t;if(!(r===void 0||r.error!==void 0))for(let i of r.subsources)if(i.enabled)yield i;else{let{activated:a}=i;i.messages.clearMessages(),a!==void 0&&(a.dispose(),i.activated=void 0,r.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter==0&&this.readyStateChanged.dispatch()}markLoading(){let e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter==1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){let t=this.manager.root.coordinateSpaceCombiner.bind(e),r=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}initializationDone(){let e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,r,i){return e===void 0?[]:[al(e,r)]}getDataSourceSpecifications(e){let t,r=j(e,KA,a=>Array.isArray(a)?a.map(o=>al(o)):typeof a=="object"?[al(a)]:(t=a,[])),i=j(e,hH,Jk);return r.push(...this.getLegacyDataSourceSpecifications(t,e,i,r)),r=r.filter(a=>a.url),r.length===0&&r.push(bh()),r}restoreState(e){this.tool.restoreState(e[JA]),this.toolBinder.restoreState(e[qA]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[YA]),this.localPosition.restoreState(e[gx]),this.constructor.supportsPickOption&&this.pick.restoreState(e[XA]);for(let t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);let{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){let{renderLayers:t,layersChanged:r}=this,i=t.indexOf(e);if(i===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(i,1),e.layerChanged.remove(r.dispatch),e.userLayer=void 0,e.dispose(),r.dispatch()}disposed(){let{layersChanged:e}=this;Oa(this.dataSources);for(let t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let r,{renderLayers:i}=this,{pickedRenderLayer:a}=t;if(a!==null&&i.indexOf(a)!==-1&&(r=a.transformPickedValue(t),r=this.transformPickedValue(r),r!=null))return r;for(let o of i)if(r=o.getValueAt(e),r!=null)break;return this.transformPickedValue(r)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[KA]:mH(this.dataSources),[JA]:this.tool.toJSON(),[qA]:this.toolBinder.toJSON(),[YA]:this.localCoordinateSpace.toJSON(),[gx]:this.localPosition.toJSON(),[XA]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){let{globalPosition:r}=this.manager.root,{localPosition:i}=this;Iy(r.value,t,e.globalToRenderLayerDimensions),Iy(i.value,t,e.localToRenderLayerDimensions),i.changed.dispatch(),r.changed.dispatch()}};mi.supportsPickOption=!1;function mH(n){if(n.length!==0)return n.length===1?n[0].toJSON():n.map(e=>e.toJSON())}var op=class extends ${constructor(e,t){super();this.manager=t;this.localCoordinateSpace=new Ms;this.localCoordinateSpaceCombiner=new ic(this.localCoordinateSpace,Po);this.localPosition=this.registerDisposer(new Bi(this.localCoordinateSpace));this.nonArchivedLayerIndex=-1;this.readyStateChanged=new ae;this.layerChanged=new ae;this.specificationChanged=new ae;this.containers=new Set;this.layer_=null;this.visible=!0;this.archived=!1;this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){let r=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{r.forEach(i=>i())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){let{layer:e}=this;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){let t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(let{layerManager:t}of this.manager.root.subsets)!t.has(this)||t.removeManagedLayer(this)}else{for(let{layerManager:t}of this.manager.root.subsets)t.has(this)||t.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}},zm=class extends ${constructor(){super();this.managedLayers=new Array;this.layerSet=new Set;this.layersChanged=new ae;this.readyStateChanged=new ae;this.specificationChanged=new ae;this.boundPositions=new WeakSet;this.numDirectUsers=0;this.nonArchivedLayerIndexGeneration=-1;this.renderLayerToManagedLayerMapGeneration=-1;this.renderLayerToManagedLayerMap_=new Map;this.scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,Gm.default)(()=>this.removeLayersWithSingleRef(),0));this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){let e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(let r of this.managedLayers)r.archived||(r.nonArchivedLayerIndex=t++);for(let r of this.managedLayers)r.archived&&(r.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(let r of this.managedLayers)if(!r.archived){if(t===e)return r;++t}}get renderLayerToManagedLayerMap(){let e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(let r of this.managedLayers){let i=r.layer;if(i!==null)for(let a of i.renderLayers)t.set(a,r)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(r=>e(r)?!0:(this.unbindManagedLayer(r),this.layerSet.delete(r),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers==1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers==0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,$A),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,HA),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){let t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){let r=this.managedLayers.length;if(e===t||e<0||e>=r||t<0||t>=r)return;let[i]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,i),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,r=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++r;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(t.layer!==null)for(let r of t.layer.renderLayers)yield r}}}get visibleRenderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let r of t.layer.renderLayers)yield r}}}invokeAction(e){let t=new QA;for(let r of this.managedLayers){if(r.layer===null||!r.visible)continue;let i=r.layer;i.handleAction(e,t);for(let a of i.renderLayers)a.handleAction(e)}for(let r of t.callbacks)r()}},yx=class{constructor(){this.changed=new ae;this.coordinateSpace=Hr;this.position=za;this.unsnappedPosition=za;this.active=!1;this.displayDimensions=void 0;this.pickedRenderLayer=null;this.pickedValue=new X(0,0);this.pickedOffset=0;this.pickedAnnotationLayer=void 0;this.pickedAnnotationId=void 0;this.pickedAnnotationBuffer=void 0;this.pickedAnnotationBufferOffset=void 0;this.pickedAnnotationType=void 0;this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){let{forcerFunction:e}=this;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}},vx=class extends ${constructor(e,t){super();this.layerManager=e;this.mouseState=t;this.changed=new ae;this.needsUpdate=!0;this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState,t=this.changed.count;if(e.active)for(let r of this.layerManager.managedLayers){let i=r.layer;if(r.visible&&i!==null){let{selectionState:a}=i;i.resetSelectionState(a),a.generation=t,i.captureSelectionState(a,e)}}}get(e){this.update();let{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();let e={};for(let t of this.layerManager.managedLayers){let r=t.layer;if(r){let i=this.get(r);i!==void 0&&(e[t.name]=r.selectionStateToJson(i,!0))}}return e}},ZA=10,Sx={...ui,minSize:150,row:1},eM={...Sx,visible:!0},bx=class extends ${constructor(e,t){super();this.coordinateSpace=e;this.layerSelectedValues=t;this.changed=new ae;this.history=[];this.historyIndex=0;this.location=new Jn(Sx);this.pin=new Ae(!0);this.registerDisposer(Wn((r,i)=>{i||(this.capture(!0),r.registerDisposer(t.changed.add(r.registerCancellable((0,jA.default)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){let e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;let e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){let{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>ZA&&t.splice(0,t.length-ZA),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,r=!0){if(r===!1&&(!this.location.visible||this.pin.value))return;let i={};e.initializeSelectionState(i),t(i)&&(this.location.visible=!0,r===!0?this.pin.value=!0:r==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:i}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){let{value:e}=this,t;if(this.location.visible){if(t=this.location.toJSON(eM),this.pin.value&&e!==void 0){let r={};for(let i of e.layers){let{layer:a}=i,o=a.selectionStateToJson(i.state,!1);Object.keys(o).length===0&&(o=void 0),r[i.layer.managedLayer.name]=o}e.position!==void 0&&(t.position=Array.from(e.position)),t.layers=r}}else t=this.location.toJSON(Sx),t=wi(t),t!==void 0&&(t.visible=!1);return t}select(){let{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){let t=gH(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}Z(e),this.location.restoreState(e,eM);let t=this.coordinateSpace.value,r=de(e,"position",a=>$e(new Float32Array(t.rank),a,Ze)),i=[];de(e,"layers",a=>{Z(a);let{layerManager:o}=this.layerSelectedValues;for(let[l,c]of Object.entries(a)){let d=o.getLayerByName(l);if(d===void 0)return;let p=d.layer;if(p===null)return;Z(c);let m={};p.initializeSelectionState(m),p.selectionStateFromJson(m,c),i.push({layer:p,state:m})}}),this.pin.value=i.length>0||r!==void 0,this.value={position:r,coordinateSpace:t,layers:i}}};function gH(n){let{mouseState:e}=n;if(!e.active)return;let t=[];for(let r of n.layerManager.managedLayers){let i=r.layer;if(i===null)continue;let a=n.get(i);if(a===void 0)continue;let o={};i.initializeSelectionState(o),i.copySelectionState(o,a),t.push({layer:i,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}var tM=class extends ${constructor(e){super();this.view=e;this.messages=new Ai;this.seenGeneration=-1;this.state=void 0}},yH=0,nM=class extends ${constructor(e,t,r,i,a,o){super();this.layerManager=e;this.renderLayerType=t;this.view=r;this.roles=i;this.layerAdded=a;this.visibility=o;this.visibleLayers_=new Map;this.debouncedUpdateVisibleLayers=this.registerCancellable((0,Gm.default)(()=>this.updateVisibleLayers(),0));this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(i.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){let e=++yH,{visibleLayers_:t,renderLayerType:r,layerAdded:i,roles:a}=this;for(let o of this.layerManager.readyRenderLayers())if(o instanceof r&&a.has(o.role)){let l=o,c=t.get(l);c===void 0&&(c=new tM(this.view),c.registerDisposer(l.messages.addChild(c.messages)),c.registerDisposer(l.addRef()),c.registerDisposer(l.visibility.add(this.visibility)),t.set(l,c),i(l,c),l.attach(c)),c.seenGeneration=e}for(let[o,l]of t)l.seenGeneration!==e&&(t.delete(o),l.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}};function Hm(n,e,t,r,i){return r.registerDisposer(new nM(n,e,r,t,(a,o)=>{o.registerDisposer(a.redrawNeeded.add(()=>r.scheduleRedraw()));let{backend:l}=a;l&&(l.rpc.invoke(M1,{layer:l.rpcId,view:r.rpcId}),o.registerDisposer(()=>l.rpc.invoke(R1,{layer:l.rpcId,view:r.rpcId}))),i!==void 0&&i(a,o),r.scheduleRedraw(),o.registerDisposer(()=>r.scheduleRedraw())},r.visibility))}var xx=class extends ${constructor(e){super();this.layerManager=e;this.changed=new ae;this.location=new Jn(FA);this.registerDisposer(e),this.location.changed.add(()=>{var r,i;this.changed.dispatch();let t=(i=(r=this.layer)==null?void 0:r.layer)!=null?i:void 0;if(t!==void 0){let a=this.location.value;if(a.visible){let o=t.panels.panels[0];o.location.value!==a&&(o.location.value=a,o.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){let{managedLayers:r}=this.layerManager;r.length>0?t=this.layer=r[0]:e=!1}if(e===!0&&t!==void 0){let r=t.layer;(r===null||r.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;let t=e.layer;t!==null&&t instanceof Fi&&(t.dataSources.some(r=>r.spec.url.length!==0)||ul(e))}set layer(e){if(e===this.layer_)return;let t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){let r=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(r);let i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{let a=e.layer;if(a!==null){let o=a.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(r),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){let e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),wi(e)}restoreState(e){if(e===void 0){this.reset();return}Z(e),this.location.restoreState(e);let t=j(e,"layer",Yt),r=t!==void 0?this.layerManager.getLayerByName(t):void 0;r===void 0&&(this.visible=!1),this.layer=r}reset(){this.location.reset(),this.layer=void 0}},Cx=class extends ${constructor(e,t){super();this.layerManager=e;this.filter=t;this.changed=new ae;this.validate=(0,Gm.default)(()=>{let{layerName_:e}=this;if(e!==void 0){let t=this.layerManager.getLayerByName(e);t!==void 0&&this.filter(t)?(this.layer_=t,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0);this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{let{layer_:r}=this;if(r!==void 0)if(!this.layerManager.layerSet.has(r)||!this.filter(r))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{let{name:i}=r;i!==this.layerName_&&(this.layerName_=i,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){let t=Yt(e);this.layerName=t}toJSON(){let{layer_:e}=this;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}},$m=class extends ${constructor(e,t,r,i){super();this.layerManager=e;this.layer=t;this.predicate=r;this.getGroup=i;this.linkedLayers_=new Set;this.changed=new ae;this.linkedLayersChanged=new ae;this.root_=t;let a=this;this.root={get value(){return a.root_},changed:a.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;let t=ne(e);this.linkByName(t)}toJSON(){let{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){let{getGroup:t,layer:r,root_:i}=this;if(i===r){let{linkedLayers_:o}=this;if(o.size!==0){for(let l of o){let c=t(l);c.root_=l,c.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}let a=t(i);a.linkedLayers_.delete(r),a.linkedLayersChanged.dispatch(),this.root_=r,e&&this.changed.dispatch()}linkByName(e){let{layer:t}=this,{managedLayer:r}=t,{layerManager:i}=this,a=i.getLayerByName(e);if(a===void 0||a===r)return;let o=a.layer;o!==null&&(!this.predicate(o)||this.linkToLayer(o))}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);let{getGroup:t}=this,r=t(e).root_;if(r===this.layer)return;let i=t(r);i.linkedLayers_.add(this.layer),i.linkedLayersChanged.dispatch(),this.root_=r,this.changed.dispatch()}disposed(){this.isolate(!1)}};function rM(n,e){let t=de(e,"type",ne,"auto");n.archived=de(e,"archived",aa,!1),n.archived?n.visible=!1:n.visible=de(e,"visible",aa,!0);let r=lp.get(t)||Fi;return n.layer=new r(n),e}function iM(n,e){try{let t=n.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw ul(n),t}}function aM(n,e){try{Z(e),rM(n,e),iM(n,e)}catch(t){throw ul(n),t}}function oM(n,e){try{aM(n,e)}catch(t){new Ee().setErrorMessage(t instanceof Error?t.message:""+t)}}function wx(n,e,t){let r=new op(e,n);return aM(r,t),r}var Tx=class extends ${constructor(){super(...arguments);this.changed=new ae}},Lx=class extends Tx{constructor(e,t,r,i,a,o,l,c,d){super();this.display=e;this.dataSourceProviderRegistry=t;this.layerManager=r;this.chunkManager=i;this.selectionState=a;this.selectedLayer=o;this.coordinateSpace=l;this.globalPosition=c;this.toolBinder=d;this.coordinateSpaceCombiner=new ic(this.coordinateSpace,Hk);this.subsets=new Set;this.layerSelectedValues=this.selectionState.layerSelectedValues;this.registerDisposer(r.layersChanged.add(this.changed.dispatch)),this.registerDisposer(r.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(Z(e),t=Object.entries(e).map(([i,a])=>typeof a=="string"?{name:i,source:a}:(Z(a),{...a,name:i})));let r=[];for(let i of t){Z(i);let a=this.layerManager.getUniqueLayerName(j(i,"name",ne)),o=new op(a,this);try{rM(o,i),this.layerManager.addManagedLayer(o),r.push({managedLayer:o,spec:i})}catch(l){o.dispose(),new Ee().setErrorMessage(`Error creating layer ${JSON.stringify(a)}: `+(l instanceof Error)?l.message:""+l)}}for(let{managedLayer:i,spec:a}of r)try{iM(i,a)}catch(o){new Ee().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(o instanceof Error)?o.message:""+o)}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){let e=[],t=0;for(let r of this.layerManager.managedLayers){let i=r.toJSON();i!=null&&(e.push(i),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}},sp=class extends Tx{constructor(e){super();this.master=e;this.changed=new ae;this.layerManager=this.registerDisposer(new zm);this.registerDisposer(e);let{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){let t=this.master.layerManager,r=[];for(let i of new Set(be(e,ne))){let a=t.getLayerByName(i);if(a===void 0)throw new Error(`Undefined layer referenced in subset specification: ${JSON.stringify(i)}`);a.archived||r.push(a)}this.layerManager.clear();for(let i of r)this.layerManager.addManagedLayer(i.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}},lp=new Map,kx=new Map,sM=[n=>{let{volume:e}=n;if(e===void 0)return;let t=kx.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function Ui(n,e=n.type){lp.set(e,n)}function Xo(n){sM.push(n)}function jm(n,e){kx.set(n,e)}function np(n,e){let t=n.layer;if(t===null)return;let r=t.toJSON(),i=new e(n);i.restoreState(r),i.initializationDone(),n.layer=i}function Fm(n,e){return e!==n.name?(e=n.manager.root.layerManager.getUniqueLayerName(e),n.name=e,n.layerChanged.dispatch(),!0):!1}function ul(n){if(!n.wasDisposed)for(let e of n.containers)e.removeManagedLayer(n)}function Ex(n,e){return n===void 0?e:e===void 0?n:n.priority<e.priority?e:n}function vH(n){let e;for(let r of sM)e=Ex(e,r(n));let{volume:t}=n;if(t!==void 0){let r=kx.get(t.volumeType);r!==void 0&&(e=Ex(e,{layerConstructor:r,priority:0}))}return e}function lM(n){let e;for(let t of n){let{subsourceEntry:r}=t,{subsource:i}=r;e=Ex(e,vH(i))}return e}var Fi=class extends mi{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=lM(e))==null?void 0:t.layerConstructor}};Fi.type="new",Fi.typeAbbreviation="new";var Jm=class extends mi{activateDataSubsources(e){var r;let t=(r=lM(e))==null?void 0:r.layerConstructor;t!==void 0&&np(this.managedLayer,t)}};Jm.type="auto",Jm.typeAbbreviation="auto";function qm(n,e){let t=wx(n,"new layer",{type:"new"});n.add(t),e.layer=t,e.visible=!0}Ui(Fi);Ui(Jm);var Dx=rt(Dt());var Qo=class{static insertAfter(n,e){let t=n.next0;e.next0=t,e.prev0=n,n.next0=e,t.prev0=e}static insertBefore(n,e){let t=n.prev0;e.prev0=t,e.next0=n,n.prev0=e,t.next0=e}static front(n){let e=n.next0;return e===n?null:e}static back(n){let e=n.prev0;return e===n?null:e}static pop(n){let e=n.next0,t=n.prev0;return e.prev0=t,t.next0=e,n.next0=null,n.prev0=null,n}static*iterator(n){for(let e=n.next0;e!==n;e=e.next0)yield e}static*reverseIterator(n){for(let e=n.prev0;e!==n;e=e.prev0)yield e}static initializeHead(n){n.next0=n.prev0=n}};var cM=class{constructor(){Qo.initializeHead(this)}},Px=new cM,SH=window.top===window,Ix=(0,Dx.default)(()=>{if(!SH)return;let{activeElement:n}=document;if(n===null||n===document.body){let e=Qo.front(Px);e!==null&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{Ix()},!0);window.addEventListener("blur",()=>{Ix()},!0);var oo=class extends ${constructor(e){super();this.element=e;this.prev0=null;this.next0=null;this.lastFocusedElement=null;this.scheduleUpdateFocus=this.registerCancellable((0,Dx.default)(()=>{let{activeElement:e}=document,{element:t}=this;t.contains(e)||Ed(e)||(e!=null&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0));e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),Qo.insertBefore(Px,this),this.registerEventListener(e,"focus",()=>{Qo.pop(this),Qo.insertAfter(Px,this)}),Ix()}disposed(){Qo.pop(this),super.disposed()}};var Ym=0,bH=_e.fromObject({escape:{action:"close"}}),Wi=class extends ${constructor(){super();this.keyMap=new _e;this.keyMap.addParent(bH,Number.NEGATIVE_INFINITY),++Ym;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new oo(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new Gt(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--Ym,document.body.removeChild(this.container),super.disposed()}};var xH=K.create(),CH=K.create(),Km=.001,uM=.001;function dM(n){let e=0;for(var t=0;t<3;++t)n[t]<0&&(e+=1<<t);return e}var Xm=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),pM=(()=>{let n=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],r=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],i=new Int32Array(8*8*6);for(let a=0;a<8;++a)for(let o=0;o<t.length;++o){let l=e[a]*8+t[o];i[a*8*6+o]=n[r[l]]}return i})();function dl(n){n.addUniform("highp vec3","uPlaneNormal"),n.addUniform("highp float","uPlaneDistance"),n.addUniform("highp ivec2","uVertexIndex",24),n.addUniform("highp vec3","uVertexBasePosition",8),n.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),Xm)}),n.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${uM}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${Km}) && (lambda <= (1.0 + ${Km}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function fM(n,e,t,r,i,a,o,l=!0){let c=dM(i),d=pM.subarray(c*48,(c+1)*48),p=[0,0],m=[K.create(),K.create()],y=K.create(),v=K.create(),b=x=>Xm.subarray(x*3,x*3+3);for(let x=0;x<4;++x){for(let L=0;L<2;++L)p[L]=d[2*(o*4+x)+L],K.multiply(m[L],n,b(p[L])),K.add(m[L],m[L],a),K.min(m[L],m[L],t),K.max(m[L],m[L],e);K.subtract(y,m[1],m[0]);let C=K.dot(y,i);if(Math.abs(C)>uM){let L=(r-K.dot(m[0],i))/C;if(L>=-Km&&L<=1+Km)return l&&console.log(`vertex ${o}, e = ${x}, good, lambda=${L}, denom=${C}, v0=${m[0].join()}, vDir=${y.join()}`),L=Math.max(0,Math.min(1,L)),K.scaleAndAdd(v,m[0],y,L),v;l&&console.log(`vertex ${o}, e = ${x}, skipped, denom = ${C}, vDir = ${y.join()}, v0=${m[0].join()}, v1=${m[1].join()}uPlaneNormal = ${To(i)}, lambda=${L}`)}else l&&console.log(`vertex ${o}, e = ${x}, skipped, deom = ${C}, vDir = ${To(y)}, uPlaneNormal = ${To(i)}, uLowerClipBound=${e.join()}, uUpperClipBound=${t.join()}, chunkSize=${n}, uVertexBasePosition(v0)=${b(p[0]).join()}, uVertexBasePosition(v1)=${b(p[1]).join()}, uTranslation=${a.join()}`)}}function wH(n,e,t){let{gl:r}=n;r.uniform3fv(n.uniform("uPlaneNormal"),e),r.uniform1f(n.uniform("uPlaneDistance"),t);let i=dM(e);r.uniform2iv(n.uniform("uVertexIndex"),pM.subarray(i*48,(i+1)*48))}function Ac(n,e,t,r,i){let a=wf(xH,e,r);K.normalize(a,a);let o=K.dot(K.transformMat4(CH,t,i),a);wH(n,a,o)}var Ax=!1,hM=.001,mM=ie.create();function TH(n,e){if(vr(n),dl(n),n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),e){Yn(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${pi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}n.addVarying("highp vec3","vChunkPosition"),n.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${hM} * abs(uPlaneNormal);
`)}function LH(n,e,t,r,i,a,o){let l=K.create(),c=K.create(),d=K.fromValues(Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])),p=K.create();for(let m=0;m<6;++m){let y=fM(n,e,t,r,i,a,m);if(y===void 0){console.log("no intersection found");return}K.transformMat4(l,y,o);let v=m!==0&&K.equals(l,p);K.copy(p,l),K.sub(c,y,a),K.scaleAndAdd(c,c,d,hM),console.log(`${v?"SKIPPED":"OUTPUT"} vertex ${m}, at ${l}, vChunkPosition = ${c}, uTranslation=${a.join()}, position=${y.join()}`)}}function kH(n,e,t){t&&Xn(n,e,1)}function EH(n,e,t,r,i,a){let o=t.projectionParameters.value,{centerDataPosition:l}=o;Ac(e,o.viewportNormalInGlobalCoordinates,l,a.transform,a.invTransform),n.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,ie.multiply(mM,r,a.transform)),n.uniform3fv(e.uniform("uLowerClipBound"),i.lowerClipDisplayBound),n.uniform3fv(e.uniform("uUpperClipBound"),i.upperClipDisplayBound),Ax&&(window.debug_sliceView_uLowerClipBound=i.lowerClipDisplayBound,window.debug_sliceView_uUpperClipBound=i.upperClipDisplayBound,window.debug_sliceView=t,window.debug_sliceView_dataToDevice=ie.clone(mM),window.debug_sliceView_chunkLayout=a)}function DH(n,e,t){n.uniform3fv(e.uniform("uChunkDataSize"),t),Ax&&(window.debug_sliceView_chunkDataSize=t)}function PH(n,e,t,r){if(n.uniform3fv(e.uniform("uTranslation"),t),r?Kn(e.gl,6,1):n.drawArrays(n.TRIANGLE_FAN,0,6),Ax){let a=window.debug_sliceView.projectionParameters.value,o=window.debug_sliceView_chunkDataSize,l=window.debug_sliceView_uLowerClipBound,c=window.debug_sliceView_uUpperClipBound,d=window.debug_sliceView_dataToDevice,p=window.debug_sliceView_chunkLayout;console.log(`Drawing chunk: ${t.join()} of data size ${o.join()}, projection`,d);let m=p.globalToLocalNormal(K.create(),a.viewportNormalInGlobalCoordinates),y=K.dot(K.transformMat4(K.create(),a.centerDataPosition,p.invTransform),m);LH(o,l,c,y,m,t,d)}}function IH(n,e,t){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t}var cp=class extends dc{constructor(e,t){let{shaderError:r=sa(),shaderParameters:i}=t;super(e.chunkManager,e,t);let{gl:a}=this;this.vertexIdHelper=this.registerDisposer(Rn.get(a)),this.shaderParameters=i;let{channelCoordinateSpace:o}=t;this.channelCoordinateSpace=o===void 0?Br(Hr):o,this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch));let l=this.registerDisposer(qt((c,d)=>({numChannelDimensions:c.rank,dataHistogramChannelSpecifications:d}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=rd(this,a,{memoizeKey:`volume/RenderLayer:${pt(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:i,encodeParameters:t.encodeShaderParameters,shaderError:r,extraParameters:l,defineShader:(c,d,p,m)=>{let{chunkFormat:y,dataHistogramsEnabled:v}=d,{dataHistogramChannelSpecifications:b,numChannelDimensions:x}=m;if(TH(c,y===null),c.addOutputBuffer("vec4","v4f_fragData0",0),c.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),y===null)return;Yh(c,y,x,"vChunkPosition");let C=b.length;if(v&&C>0){let L="",{dataType:A}=y;for(let D=0;D<C;++D){let{channel:R}=b[D],P=`out_histogram${D}`;c.addOutputBuffer("vec4",P,1+D);let E=`getDataValue(${R.join(",")})`,V=`invlerpForHistogram${D}`;c.addFragmentCode(uh(c,V,A,!1)),c.addFragmentCode(`
float getHistogramValue${D}() {
  return invlerpForHistogram${D}(${E});
}
`),L+=`{
float x = getHistogramValue${D}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${P} = vec4(x, x, x, 1.0);
}`}c.addFragmentCode(`void userMain();
void main() {
  ${L}
  userMain();
}
#define main userMain
`)}this.defineShader(c,p)},getContextKey:c=>{var d;return`${(d=c.chunkFormat)==null?void 0:d.shaderKey}/${c.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let{tempChunkPosition:t}=this;for(let{source:r,chunkTransform:i}of this.visibleSourcesList){if(!Ha(t,e,this.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))continue;let a=r.getValueAt(t,i);if(a!=null)return a}return null}beginChunkFormat(e,t,r){let{gl:i}=this,a=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:a}),{shader:l,parameters:c,fallback:d}=o;if(l!==null&&(l.bind(),kH(l,r,t===null),t!==null)){if(a){let{dataHistogramChannelSpecifications:p}=o.extraParameters,m=p.length,y=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<m;++v)lc(l,`invlerpForHistogram${v}`,t.dataType,y[v])}this.initializeShader(e,l,c,d),t.beginDrawing(i,l)}return o}endSlice(e,t,r){}draw(e){let{sliceView:t}=e,r=t.visibleLayers.get(this),{visibleSources:i}=r;if(i.length===0)return;let{projectionParameters:a,wireFrame:o}=e,{gl:l}=this;this.vertexIdHelper.enable();let c=K.create(),{renderScaleHistogram:d}=this;d!==void 0&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let p,m=null,y,v=K.create(),b=()=>{m!==null&&(y!==null&&y.endDrawing(l,m),this.endSlice(t,m,p.parameters))},x=!0;for(let C of i){let L=sc(a,C.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:A}}=C,D=C.source,{fixedPositionWithinChunk:R,chunkDisplayDimensionIndices:P}=C;for(let N of P)R[N]=0;let E=o?null:D.chunkFormat;if(E!==y&&(y=E,b(),p=this.beginChunkFormat(t,E,a),m=p.shader),m===null)continue;let V=D.chunks;v.fill(1);let O=L.size,B,W=D.spec.rank;EH(l,m,t,a.viewProjectionMat,C,L),E!==null&&E.beginSource(l,m),x=!0;let _=0,F=0;if(t.forEachVisibleChunk(C,L,N=>{let J=V.get(N);if(J&&J.state===Qe.GPU_MEMORY){let re=J.chunkDataSize;if(re!==B){B=re;for(let ye=0;ye<3;++ye){let ce=P[ye];v[ye]=ce===-1||ce>=W?1:B[ce]}DH(l,m,v)}let{chunkGridPosition:pe}=J;for(let ye=0;ye<3;++ye){let ce=P[ye];c[ye]=ce===-1||ce>=W?0:O[ye]*pe[ce]}E!==null&&E.bindChunk(l,m,J,R,P,A,x),x=!1,PH(l,m,c,o),++_}else++F}),(_!==0||F!==0)&&d!==void 0){let{effectiveVoxelSize:N}=C,J=IH(N[0],N[1],N[2]);d.add(J,J/a.pixelSize,_,F)}}if(b(),this.vertexIdHelper.disable(),!e.wireFrame){let C=this.getDataHistogramCount();C>0&&t.computeHistograms(C,this.dataHistogramSpecifications)}}};var Zo;(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ADDITIVE=1]="ADDITIVE"})(Zo||(Zo={}));var gM=new Map([[0,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)}],[1,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE)}]]);function yM(n=0){return new jo(Zo,n)}var vM=`#uicontrol invlerp normalized
#uicontrol vec3 color color(default="white")
#uicontrol float brightness slider(default=0, min=-1, max=1, step=0.1)
#uicontrol float contrast slider(default=0, min=-3, max=3, step=0.1)

void main() {
  emitRGB(
    color * vec3(normalized() + brightness) * exp(contrast));
}`;function SM(n=vM){return Ao(n)}function Mx(n,e){n.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),n.addFragmentCode(Ei),Ii(e,n),n.setFragmentMainFunction(Di(e.parseResult.code))}var Rx=class extends cp{constructor(e,t){var o,l,c;let{opacity:r,blendMode:i,shaderControlState:a}=t;super(e,{...t,fallbackShaderParameters:new Ae(_o(Ya(vM,{imageData:{dataType:e.dataType,channelRank:(c=(l=(o=t.channelCoordinateSpace)==null?void 0:o.value)==null?void 0:l.rank)!=null?c:0}}))),encodeShaderParameters:d=>d.key,shaderParameters:a.builderState,dataHistogramSpecifications:a.histogramSpecifications});this.shaderControlState=a,this.opacity=r,this.blendMode=i,this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),Mx(e,t)}initializeShader(e,t,r){let{gl:i}=this;i.uniform1f(t.uniform("uOpacity"),this.opacity.value),Jr(i,t,this.shaderControlState,r.parseResult.controls)}setGLBlendMode(e,t){let r=this.blendMode.value;r===Zo.ADDITIVE||t>0?(e.enable(e.BLEND),gM.get(r)(e)):e.disable(WebGL2RenderingContext.BLEND)}};function pl(n=.5){return new ct(n,Af)}function Qm(n){try{return n()}catch(e){return{error:e.message}}}function bM(n){if(n.error!==void 0)throw new Error(n.error);return n}var fl=class extends ${constructor(e,t){super();this.register=e;this.changed=new ae;this.disposerMap=new Map;if(t===void 0)this.map=new Map;else{let r=this.map=new Map(t),{disposerMap:i}=this;for(let[a,o]of r){let l=new $;i.set(a,l),e(l,o,a)}}}get value(){return this.map}set(e,t){let{map:r,disposerMap:i}=this,a=i.get(e);return a!==void 0&&a.dispose(),a=new $,i.set(e,a),r.set(e,t),this.register(a,t,e),this.changed.dispatch(),this}delete(e){let{map:t,disposerMap:r}=this,i=r.get(e);return i!==void 0?(i.dispose(),r.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){let{map:e,disposerMap:t}=this;if(e.size>0){for(let r of t.values())r.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){let{map:e,disposerMap:t}=this;for(let r of t.values())r.dispose();e.clear(),t.clear(),super.disposed()}};var xM=class extends Ae{},CM=class extends fl{constructor(){super((e,{showMatches:t,segmentationState:r})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(r.changed.add(this.changed.dispatch)),e.registerDisposer(Wn((i,a)=>{if(a==null)return;let{segmentationGroupState:o}=a;i.registerDisposer(o.changed.add(this.changed.dispatch)),i.registerDisposer(Wn((l,c)=>{let{visibleSegments:d}=c,p=d.size===0;l.registerDisposer(d.changed.add(()=>{let m=d.size===0;m!==p&&(p=m,this.changed.dispatch())}))},o))},r))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new Ae(void 0),showMatches:new mt(!1)},super.set(e,t)),t}},wM=`
void main() {
  setColor(defaultColor());
}
`,_x=class extends ${constructor(){super(...arguments);this.shader=Ao(wM);this.shaderControls=new Ka(this.shader);this.fallbackShaderControls=new Ae(_o(Ya(wM)));this.shaderError=sa();this.color=new Lo(K.fromValues(1,1,0));this.relationshipStates=this.registerDisposer(new CM);this.ignoreNullSegmentFilter=new mt(!0);this.displayUnfiltered=Un((e,t)=>{for(let r of e.values())if(r.showMatches.value){if(!t)return!1;let i=r.segmentationState.value;if(i!=null&&i.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter);this.hoverState=new xM(void 0)}},Mc=class extends ${constructor(e){super();let{transform:t,localPosition:r,source:i,role:a=jn.ANNOTATION}=e;this.transform=t,this.localPosition=r,this.source=this.registerDisposer(i),this.role=a,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(Un(o=>Qm(()=>Zf(bM(o))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex}get sourceIndex(){let{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}};var up=12,Vx=8,AH=6,TM=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function LM(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*AH*e,t)}var kM=0,Zm=kM+1,Vn=Zm+Vx,Ox=Vn+up,MH=Ox+6,RH=Float32Array.from([0,0,0,0,0,1,Vn+0,1,0,0,1,0,1,Vn+1,0,1,0,0,1,1,Vn+2,1,1,0,1,1,1,Vn+3,0,0,0,0,1,0,Vn+4,0,0,1,0,1,1,Vn+5,1,0,0,1,1,0,Vn+6,1,0,1,1,1,1,Vn+7,0,0,0,1,0,0,Vn+8,0,0,1,1,0,1,Vn+9,0,1,0,1,1,0,Vn+10,0,1,1,1,1,1,Vn+11]),EM=ie.create(),es=new Float32Array(6),Nx=class extends Xa{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Rn.get(this.gl))}defineShader(e){vr(e);let{rank:t}=this;Ro(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,r){ie.invert(EM,t.modelViewProjectionMatrix),uk(EM,es);let{numChunkDisplayDims:i}=t.chunkDisplayTransform;for(let a=0;a<i;++a)es[a]=0,es[a+3]=0;for(let a=i;a<3;++a){let o=Math.abs(es[a+3]-es[a]);es[a]-=o,es[a+3]+=o}super.enable(e,t,a=>{let o=a.vertexShaderInputBinders.Bounds;o.enable(1);let{gl:l}=this;l.uniform3fv(a.uniform("uModelSpaceBoundOffsets"),es),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.serializedBytesPerAnnotation,t.bufferOffset);let{vertexIdHelper:c}=this;c.enable(),r(a),c.disable(),o.disable()})}};function DM(n){n.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function PM(n){n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function Bx(n){PM(n),n.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function _H(n){DM(n),n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}var IM=class extends Nx{constructor(){super(...arguments);this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(_t.fromData(this.gl,Iu(RH,7,1,pi)));this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{let{rank:t}=this;this.defineShader(e),Yn(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),Bx(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)});this.boxCornerOffsetsBuffer=this.registerDisposer(_t.fromData(this.gl,Iu(Xm,3,1,jh)));this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{let{rank:t}=this;this.defineShader(e),Jo(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),Bx(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${Zm}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){let{gl:t}=this;this.enable(this.edgeShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset1"),a=r.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1,4*7,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(a,4,WebGL2RenderingContext.FLOAT,!1,4*7,4*3),Xn(r,e.renderContext.projectionParameters,1),Kn(t,up,e.count),t.disableVertexAttribArray(i),t.disableVertexAttribArray(a)})}drawCorners(e){let{gl:t}=this;this.enable(this.cornerShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),qo(r,e.renderContext.projectionParameters,{featherWidthInPixels:0}),Yo(r.gl,Vx,e.count),t.disableVertexAttribArray(i)})}draw(e){this.drawEdges(e),this.drawCorners(e)}},AM=class extends Nx{constructor(){super(...arguments);this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{let{rank:t}=this;super.defineShader(e),dl(e),Yn(e),e.addVarying("highp float","vClipCoefficient"),Bx(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${pi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)});this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{let{rank:t}=this;super.defineShader(e),dl(e),e.addVarying("highp float","vClipCoefficient"),_H(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(e,t,r){super.enable(e,t,i=>{let a=t.renderContext.sliceView.projectionParameters.value;Ac(i,a.viewportNormalInGlobalCoordinates,a.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),r(i)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{VE(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{Xn(t,e.renderContext.projectionParameters,1),Kn(t.gl,6,e.count)})}};function VH(n,e){let t=n.length;for(let r=0;r<t;++r){let i=e[r],a=e[r+t],o=n[r];n[r]=Math.abs(i-o)<Math.abs(a-o)?i:a}}Vo(Re.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:AM,perspectiveViewRenderHelper:IM,defineShaderNoOpSetters(n){PM(n),DM(n)},pickIdsPerInstance:MH,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r>=Zm&&r<Vn?VH(n,a):r>=Vn&&r<Ox},getRepresentativePoint(n,e,t){t===kM||t>=Zm&&t<Vn||t>=Vn&&t<Ox,n.set(e.pointA)},updateViaRepresentativePoint(n,e,t){let r=e.length,{pointA:i,pointB:a}=n,o=new Float32Array(r),l=new Float32Array(r);for(let c=0;c<r;++c){let d=o[c]=e[c];l[c]=a[c]+(d-i[c])}return{...n,pointA:o,pointB:l}}});var Rc=0,Fx=Rc+1,OH=Fx+2;function MM(n){n.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function RM(n){n.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}var Ux=class extends Xa{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Rn.get(this.gl));this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{let{rank:t}=this;this.defineShader(e),Yn(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),MM(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{let{rank:t}=this;this.defineShader(e),Jo(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),RM(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${jh};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(e){vr(e);let{rank:t}=this;Ro(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{Xn(t,e.renderContext.projectionParameters,1),Kn(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{qo(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Yo(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}};function NH(n,e){let t=n.length;ok(n,e.subarray(0,t),e.subarray(t),n)}function BH(n,e,t){let r=n.length,i=r*t;for(let a=0;a<r;++a)n[a]=e[i+a]}Vo(Re.LINE,{sliceViewRenderHelper:Ux,perspectiveViewRenderHelper:Ux,defineShaderNoOpSetters(n){MM(n),RM(n)},pickIdsPerInstance:OH,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r===Rc?NH(n,a):BH(n,a,r-Fx)},getRepresentativePoint(n,e,t){n.set(t===Rc||t===Fx?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r={...n},i=e.length;switch(t){case Rc:{let{pointA:a,pointB:o}=n,l=new Float32Array(i),c=new Float32Array(i);for(let d=0;d<i;++d){let p=l[d]=e[d];c[d]=o[d]+(p-a[d])}return{...n,pointA:l,pointB:c}}case Rc+1:return{...n,pointA:new Float32Array(e)};case Rc+2:return{...n,pointB:new Float32Array(e)}}return r}});var Wx=class extends Xa{constructor(){super(...arguments);this.shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{vr(e),Jo(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)});this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{vr(t),Yn(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)});this.shaderGetter2d=this.makeShaderGetter2d(2);this.shaderGetter1d=this.makeShaderGetter2d(1);this.vertexIdHelper=this.registerDisposer(Rn.get(this.gl))}defineShaderCommon(e){let{rank:t}=this;Ro(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}draw(e){let{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,r=>{qo(r,e.renderContext.projectionParameters,{featherWidthInPixels:1}),Yo(r.gl,1,e.count)});break;case 2:case 1:this.enable(t===2?this.shaderGetter2d:this.shaderGetter1d,e,r=>{Xn(r,e.renderContext.projectionParameters,1),Kn(r.gl,1,e.count)});break}}};Vo(Re.POINT,{sliceViewRenderHelper:Wx,perspectiveViewRenderHelper:Wx,defineShaderNoOpSetters(n){n.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(n,e,t){n.set(new Float32Array(e,t,n.length))},getRepresentativePoint(n,e){n.set(e.point)},updateViaRepresentativePoint(n,e){return{...n,point:new Float32Array(e)}}});var _M=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,VM=[_M,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`];function OM(n,e){let t=[[n[0],n[1],n[2]],[n[3],n[4],n[5]],[n[6],n[7],n[8]]];return{A:t[0][0],B:t[0][1]+t[1][0],C:t[1][1],D:-2*e[0]*t[0][0]-e[1]*(t[0][1]+t[1][0])+e[2]*(t[0][2]+t[2][0]),E:-e[0]*(t[0][1]+t[1][0])-2*e[1]*t[1][1]+e[2]*(t[1][2]+t[2][1]),F:e[0]*e[0]*t[0][0]+e[0]*e[1]*(t[0][1]+t[1][0])-e[0]*e[2]*(t[0][2]+t[2][0])+e[1]*e[1]*t[1][1]-e[1]*e[2]*(t[1][2]+t[2][1])+e[2]*e[2]*t[2][2]-1}}var FH=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,NM=[_M,FH,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function BM(n){let e=n.A,t=n.B/2,r=n.C,i=n.D,a=n.E,o=n.F,l=2*(t*t-e*r),c=(r*i-t*a)/l,d=(e*a-t*i)/l,p=1/(e*c*c+2*t*c*d+r*d*d-o),m=p*e,y=p*t,v=p*r,b=m+v,x=Math.sqrt((m-v)*(m-v)+4*y*y),C=(b+x)/2,L=(b-x)/2,A=1/Math.sqrt(C),D=1/Math.sqrt(L),R;m>=v?R=lr.fromValues(C-v,y):R=lr.fromValues(y,C-m),lr.normalize(R,R);let P=lr.fromValues(-R[1],R[0]);return{k:lr.fromValues(c,d),u1:R,u2:P,a:A,b:D,lambda1:C,lambda2:L,m11:m,m12:y,m22:v,valid:C>0&&L>0}}function UH(n,e){let t=new Float32Array((n+1)*(e+1)*3),r=0;for(let i=0;i<=n;++i){let a=i*Math.PI/n,o=Math.sin(a),l=Math.cos(a);for(let c=0;c<=e;++c){let d=c*2*Math.PI/e,p=Math.sin(d),m=Math.cos(d);t[r++]=m*o,t[r++]=l,t[r++]=p*o}}return t}function WH(n,e){let t=new Uint16Array(n*e*6),r=0;for(let i=0;i<n;i++)for(let a=0;a<e;a++){let o=i*(e+1)+a,l=o+e+1;t[r++]=o,t[r++]=l,t[r++]=o+1,t[r++]=l,t[r++]=l+1,t[r++]=o+1}return t}var Gx=class extends ${constructor(e,t,r){super();this.vertexBuffer=this.registerDisposer(Ja(e,WebGL2RenderingContext.ARRAY_BUFFER,UH,t,r)).value,this.indexBuffer=this.registerDisposer(Ja(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,WH,t,r)).value,this.numIndices=t*r*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){let r=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(r)}};var FM=ie.create(),GH=!1,zx=class extends Xa{defineShader(e){let{rank:t}=this;Ro(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.CenterAndRadii;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset),r(i),a.disable()})}},UM=class extends zx{constructor(){super(...arguments);this.sphereRenderHelper=this.registerDisposer(new Gx(this.gl,10,10));this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)});this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=this.tempLightVec,{lightDirection:a,ambientLighting:o,directionalLighting:l}=e.renderContext;K.scale(i,a,l),i[3]=o,r.uniform4fv(t.uniform("uLightDirection"),i),r.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,ie.transpose(ie.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}},WM=class extends zx{constructor(){super(...arguments);this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{vr(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(VM),e.addVertexCode(NM),e.addVertexCode(xc),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});this.vertexIdHelper=this.registerDisposer(Rn.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=e.renderContext.sliceView.projectionParameters.value,a=ie.multiply(FM,e.renderSubspaceInvModelMatrix,i.invViewMatrix);r.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,a),r.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,i.projectionMat);let o=FM;ie.invert(o,a),r.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);let{vertexIdHelper:l}=this;if(l.enable(),Cc(r,1,e.count),l.disable(),GH){let c=K.fromValues(3406.98779296875,3234.910400390625,4045),d=K.fromValues(10,10,10),p=Ct.create();p[0]=1/(d[0]*d[0]),p[4]=1/(d[1]*d[1]),p[8]=1/(d[2]*d[2]);let m=Ct.fromMat4(Ct.create(),a),y=Ct.multiply(Ct.create(),Ct.transpose(Ct.create(),m),p);Ct.multiply(y,y,m);let v=K.transformMat4(K.create(),c,o);console.log("Aviewport",y),console.log("cViewport",v);let b=OM(y,v),x=BM(b);console.log(b),console.log(x)}})}};Vo(Re.ELLIPSOID,{sliceViewRenderHelper:WM,perspectiveViewRenderHelper:UM,defineShaderNoOpSetters(n){n.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(n,e){n.set(e.center)},updateViaRepresentativePoint(n,e){return{...n,center:new Float32Array(e)}}});var GM=ie.create(),zM=K.create();function HM(n){n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}var $M={defineShader(n){HM(n),Yn(n),n.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),n.setVertexMain(`
int edgeIndex = gl_VertexID / ${pi};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){Xn(n,e,1)},draw(n,e,t){let{gl:r}=n,i=GM,{chunkLayout:a}=e;ie.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=zM;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),Kn(r,up,1)}},jM={defineShader(n){dl(n),HM(n),Yn(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${pi};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){Xn(n,e,1)},draw(n,e,t){let{gl:r}=n,i=GM,{chunkLayout:a}=e;ie.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=zM;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),Ac(n,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,a.transform,a.invTransform),Kn(r,6,1)}};var zH=ie.create();function HH(n){if(n!==void 0)return e=>{let{relatedSegments:t}=e;if(t===void 0)return!1;for(let r=0,i=t.length;r<i;++r){let a=n[r];if(a==null)continue;let{visibleSegments:o,segmentEquivalences:l}=a.segmentationGroupState.value;for(let c of t[r])if(o.has(l.get(c)))return!0}return!1}}function $H(n,e){let t=new yv(n.annotationPropertySerializer);for(let r of n)(e===void 0||e(r))&&t.add(r);return t.serialize()}var eg=class extends la(ha){constructor(e,t,r,i){super(i);this.chunkManager=e;this.source=t;this.segmentationStates=r;this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()});let a=()=>{let o={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(DE,o)};this.registerDisposer(r.changed.add(a))}serializeDisplayState(){let{value:e}=this.segmentationStates;if(e!==void 0)return e.map(t=>t==null?t:JS(t.segmentationGroupState.value))}};eg=xt([mn(EE)],eg);var Hx=class extends ${constructor(e,t){super();this.chunkManager=e;this.state=t;this.layerChunkProgressInfo=new Fs;this.numPickIds=0;this.generation=-1;this.redrawNeeded=new ae;this.serializedAnnotations=void 0;this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()};this.segmentationStates=this.registerDisposer(qt(e=>{let{displayState:t,source:r}=this.state,{relationshipStates:i}=t;return t.displayUnfiltered.value?void 0:r.relationships.map(a=>{let o=i.get(a);return o.showMatches.value?o.segmentationState.value:void 0})},[this.state.displayState.relationshipStates],(e,t)=>e===void 0||t===void 0?e===t:Ce(e,t)));this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Wn((i,a)=>{if(this.handleChangeAffectingBuffer(),a!==void 0)for(let o of a)o!=null&&i.registerDisposer(Na((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof Ga||(this.sharedObject=this.registerDisposer(new eg(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));let{displayState:r}=this.state;this.registerDisposer(r.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){let{sharedObject:e}=this;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){let{source:e}=this;if(e instanceof Ga){let t=e.changed.count;if(this.generation!==t){let{buffer:r}=this;r===void 0&&(r=this.buffer=this.registerDisposer(new _t(this.chunkManager.gl))),this.generation=t;let i=this.serializedAnnotations=$H(e,HH(this.segmentationStates.value));r.setData(this.serializedAnnotations.data),this.numPickIds=gS(i)}}}};function JM(n){let{chunkTransform:e}=n,{unpaddedRank:t}=e.modelTransform,r=new Float32Array(t*2),i=new Float32Array(t*3);i.fill(0),r.fill(1,t);let{numChunkDisplayDims:a,chunkDisplayDimensionIndices:o}=n;for(let l=0;l<a;++l){let c=o[l];r[t+c]=0,i[c*3+l]=1}return{modelClipBounds:r,renderSubspaceTransform:i}}function qM(n,e,t){t.clearMessages();let r=c=>{t.addMessage({severity:hr.error,message:c})};if(n.error!==void 0)return r(n.error);let i=eh(n.modelTransform,e.displayDimensionIndices),a;try{a=th(n,i)}catch(c){return r(c.message)}let{modelClipBounds:o,renderSubspaceTransform:l}=JM(a);return{chunkTransform:n,chunkDisplayTransform:a,modelClipBounds:o,renderSubspaceTransform:l}}function $x(n,e){class t extends n{constructor(i,a){super();this.base=i;this.renderScaleHistogram=a;this.curRank=-1;this.renderHelpers=[];this.isAnnotation=!0;let o=i.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(let l of this.renderHelpers)l.dispose()}),this.role=i.state.role,this.registerDisposer(i.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged()}handleRankChanged(){let{rank:i}=this.base.source;if(i===this.curRank)return;this.curRank=i,this.tempChunkPosition=new Float32Array(i);let{renderHelpers:a,gl:o}=this;for(let d of a)d.dispose();let{properties:l}=this.base.source,{displayState:c}=this.base.state;for(let d of Ti){let p=Oo(d),m=p[e],y=a[d]=new m(o,d,i,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);y.pickIdsPerInstance=p.pickIdsPerInstance,y.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(i){super.attach(i),this.handleRankChanged();let{chunkTransform:a}=this,o=i.view.displayDimensionRenderInfo.value;i.state={chunkTransform:a,displayDimensionRenderInfo:o,chunkRenderParameters:qM(a,o,i.messages)}}updateAttachmentState(i){let a=i.state;this.handleRankChanged();let{chunkTransform:o}=this,l=i.view.displayDimensionRenderInfo.value;return a!==void 0&&a.chunkTransform===o&&a.displayDimensionRenderInfo===l?a.chunkRenderParameters:(a.chunkTransform=o,a.displayDimensionRenderInfo=l,a.chunkRenderParameters=qM(o,l,i.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(i,a){let{modelClipBounds:o}=a,l=this.curRank,{chunkTransform:c}=a;Ha(o.subarray(0,l),i.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(i,a,o,l=1){if(!i.bufferValid){let{buffer:c}=i;c===void 0&&(c=i.buffer=new _t(this.gl));let{serializedAnnotations:d}=i;c.setData(d.data),i.numPickIds=gS(d),i.bufferValid=!0}this.drawGeometry(i,a,o,l)}drawGeometry(i,a,o,l=1){let{base:c}=this,{chunkDisplayTransform:d}=o,{serializedAnnotations:p}=i,{typeToIdMaps:m,typeToOffset:y}=p,v=0;a.emitPickID&&(v=a.pickIDs.register(this,i.numPickIds,0,0,i));let b=c.hoverState.value,x=ie.multiply(zH,a.projectionParameters.viewProjectionMat,d.displaySubspaceModelMatrix),C={annotationLayer:c,renderContext:a,selectedIndex:0,basePickId:v,buffer:i.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:x,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:d.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:d.displaySubspaceInvModelMatrix,chunkDisplayTransform:d};for(let L of Ti){let A=m[L],D=A.size;if(D>0){let R=Oo(L),P=4294967295;if(b!==void 0){let E=A.get(b.id);E!==void 0&&(P=E*R.pickIdsPerInstance)}D=Math.round(D*l),C.count=D,C.bufferOffset=y[L],C.selectedIndex=P,this.renderHelpers[L].draw(C),C.basePickId+=D*R.pickIdsPerInstance}}}updateMouseState(i,a,o,l){let c=l,{serializedAnnotations:d}=c,{typeToIds:p,typeToOffset:m}=d,y=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(let b of Ti){let x=p[b],C=Oo(b),L=Kt[b],{pickIdsPerInstance:A}=C;if(o<x.length*A){let D=Math.floor(o/A),R=x[D],P=o%A;i.pickedAnnotationId=R,i.pickedAnnotationLayer=this.base.state,i.pickedOffset=P,i.pickedAnnotationBuffer=d.data.buffer,i.pickedAnnotationType=b,i.pickedAnnotationBufferOffset=d.data.byteOffset+m[b]+D*(L.serializedBytes(y)+this.base.source.annotationPropertySerializer.serializedBytes);let E=this.tempChunkPosition,{chunkToLayerTransform:V,combinedGlobalLocalToChunkTransform:O,layerRank:B}=v,{globalToRenderLayerDimensions:W}=v.modelTransform,{position:_}=i;if(!Ha(E,_,this.base.state.localPosition.value,B,O))return;C.snapPosition(E,i.pickedAnnotationBuffer,i.pickedAnnotationBufferOffset,P);let F=W.length;for(let N=0;N<F;++N){let J=W[N];if(J===-1)continue;let re=V[(y+1)*y+J];for(let pe=0;pe<y;++pe)re+=E[pe]*V[pe*(B+1)+J];!Number.isFinite(re)||(_[N]=re)}return}o-=x.length*A}}transformPickedValue(i){let{pickedAnnotationBuffer:a}=i;if(a===void 0)return;let{properties:o}=this.base.source;if(o.length===0)return;let{pickedAnnotationBufferOffset:l,pickedAnnotationType:c}=i,d=Kt[c],{rank:p,annotationPropertySerializer:m}=this.base.source,y=d.serializedBytes(p),v=new Array(o.length);return m.deserialize(new DataView(a),l+y,fn.LITTLE===ia,v),Pk(o[0],v[0])}isReady(){let{base:i}=this,{source:a}=i;if(!(a instanceof Ri))return!0;let{value:o}=this.base.segmentationStates;if(o===void 0)return!0;for(let l=0,c=o.length;l<c;++l){let d=o[l];if(d===null)return!1;if(d===void 0)continue;let p=a.segmentFilteredSources[l].chunks,m=!1;if(ma(d.segmentationGroupState.value,y=>{let v=Dr(y);p.has(v)||(m=!0)}),m)return!1}return!0}}return t}var YM=n=>class extends n{constructor(){super(...arguments);this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(t,r){let i=this.updateAttachmentState(r);if(this.curRank===0||i===void 0)return;this.updateModelClipBounds(t,i);let{source:a}=this.base;if(a instanceof Ga){let{base:o}=this;o.updateBuffer(),this.drawGeometry(o,t,i)}else{let{renderScaleHistogram:o}=this;o.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(a.temporary.data,t,i);let{value:l}=this.base.segmentationStates,c=0,d=0;if(l!==void 0)for(let p=0,m=l.length;p<m;++p){let y=l[p];if(y==null)continue;let v=a.segmentFilteredSources[p].chunks;ma(y.segmentationGroupState.value,b=>{let x=Dr(b),C=v.get(x);if(C!==void 0&&C.state===Qe.GPU_MEMORY){let{data:L}=C;if(L===void 0)return;this.drawGeometryChunkData(L,t,i),++c}else++d})}o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,c,d)}}},KM=$x(Ir,"perspectiveViewRenderHelper"),jx=class extends YM(KM){},XM=n=>{class e extends n{constructor(r){super(r.annotationLayer,r.renderScaleHistogram);this.wireFrameRenderHelper=this instanceof ya?jM:$M;this.wireFrameShaderGetter=jr(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof ya}`,parameters:Br(void 0),defineShader:r=>{this.wireFrameRenderHelper.defineShader(r)}});this.renderScaleTarget=r.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));let i=this.registerDisposer(new ha(this.layerChunkProgressInfo)),a=this.base.chunkManager.rpc;i.RPC_TYPE_ID=LE,i.initializeCounterpart(a,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(Lt.makeFromExisting(a,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Lt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}attach(r){super.attach(r),r.state.sources=r.registerDisposer(Wn((i,a,o)=>{let l=Sd(o,a,c=>this.base.state.source.getSources(c),r.messages,this);for(let c of l)for(let d of c)i.registerDisposer(d.source),Object.assign(d,JM(d.chunkDisplayTransform));return r.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(kE,{layer:this.backend.rpcId,view:r.view.rpcId,sources:gd(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,r.view.displayDimensionRenderInfo))}draw(r,i){let a=this.updateAttachmentState(i);if(this.curRank===0||a===void 0)return;let o=i.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(r,a);let{renderScaleHistogram:l}=this;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let{projectionParameters:c}=r,d;if(r.wireFrame){let{shader:p}=this.wireFrameShaderGetter(r.emitter);if(p===null)return;p.bind(),this.wireFrameRenderHelper.initialize(p,c),d=p}PE(c,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(p,m,y,v,b)=>{let x=p.source.chunks.get(p.curPositionInChunks.join()),C;if(x===void 0||x.state!==Qe.GPU_MEMORY)C=0;else{let{data:L}=x;if(L===void 0)return;d!==void 0?this.wireFrameRenderHelper.draw(d,p,c):this.drawGeometryChunkData(L,r,a,y),C=1}l.add(v,b,C,1-C)})}}return e},QM=XM(KM),ZM=XM($x(ya,"sliceViewRenderHelper")),eR=YM($x(ya,"sliceViewRenderHelper"));var hl=class extends ${constructor(e,t=()=>K.fromValues(1,0,0)){super();this.model=e;this.getDefaultColor=t;this.element=document.createElement("input");let{element:r}=this;r.classList.add("neuroglancer-color-widget"),r.type="color",r.addEventListener("change",()=>this.updateModel()),r.addEventListener("input",()=>this.updateModel()),r.addEventListener("wheel",i=>{i.stopPropagation(),i.preventDefault(),this.adjustHueViaWheel(i)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!=null?e:this.getDefaultColor()}updateView(){this.element.value=pn(this.getRGB())}updateModel(){this.model.value=ra(this.element.value)}adjustHueViaWheel(e){let t=this.getRGB(),r=K.create();dD(r,t[0],t[1],t[2]);let{deltaY:i}=e,a=Math.round(r[0]*256);a+=i>0?1:i<0?-1:0,a=(a+256)%256,r[0]=a/256,Ys(r,r[0],r[1],r[2]),this.model.value=r}};var tR='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="binIconTitle"><path d="M19 6L5 6M14 5L10 5M6 10L6 20C6 20.6666667 6.33333333 21 7 21 7.66666667 21 11 21 17 21 17.6666667 21 18 20.6666667 18 20 18 19.3333333 18 16 18 10"></path></svg>';function La(n={}){let e=je({svg:tR,...n}),t=e.firstElementChild;return t.style.fill="white",e}var nR=class extends ${constructor(){super(...arguments);this.changed=new ae;this.isLoadingChanged=new ae;this.states=[];this.relationships=[];this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount==0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let r=e.sourceIndex-t.sourceIndex;return r!==0?r:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){let e=new Set;for(let t of this.states)for(let r of t.source.relationships)e.add(r);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{let t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}};function jH(n,e){switch(e.type){case Re.AXIS_ALIGNED_BOUNDING_BOX:case Re.LINE:Uf(n,e.pointA,e.pointB),Rk(n,n,.5);break;case Re.POINT:n.set(e.point);break;case Re.ELLIPSOID:n.set(e.center);break}}function rR(n,e,t){e.error===void 0&&n.setLayerPosition(e.modelTransform,t)}function iR(n,e,t){let{layerRank:r}=e,i=new Float32Array(r);Kt[n.type].visitGeometry(n,(a,o)=>{i.set(a);let l=new Float32Array(r);(o?Hf:zr)(l,e.chunkToLayerTransform,r+1,i,r),t(l,o)})}var aR=class extends an{constructor(e,t){super();this.layer=e;this.displayState=t;this.previousSelectedState=void 0;this.previousHoverId=void 0;this.previousHoverAnnotationLayerState=void 0;this.virtualListSource={length:0,render:e=>this.render(e),changed:new We};this.virtualList=new ll({source:this.virtualListSource});this.listElements=[];this.updated=!1;this.mutableControls=document.createElement("div");this.headerRow=document.createElement("div");this.attachedAnnotationStates=new Map;this.forceUpdateView=()=>{this.updated=!1,this.updateView()};this.globalDimensionIndices=[];this.localDimensionIndices=[];this.curCoordinateSpaceGeneration=-1;this.prevCoordinateSpaceGeneration=-1;this.columnWidths=[];this.gridTemplate="";this.selectedAnnotationState=Un((e,t)=>{var l;if(e===void 0)return;let{layer:r}=this,i=(l=e.layers.find(c=>c.layer===r))==null?void 0:l.state;if(i===void 0)return;let{annotationId:a}=i;if(a===void 0)return;let o=this.annotationStates.states.find(c=>c.sourceIndex===i.annotationSourceIndex&&(i.annotationSubsource===void 0||c.subsourceId===i.annotationSubsource));if(o!==void 0)return{annotationId:a,annotationLayerState:o,pin:t}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin);this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(e.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");let r=document.createElement("div");r.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);let i=this.registerDisposer(new hl(this.displayState.color));i.element.title="Change annotation display color",this.registerDisposer(new $n(Un(y=>y.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),i.element)),r.appendChild(i.element);let{mutableControls:a}=this,o=je({text:Kt[Re.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new qx(this.layer,{})}});a.appendChild(o);let l=je({text:Kt[Re.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new ng(this.layer,{})}});a.appendChild(l);let c=je({text:Kt[Re.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new rg(this.layer,{})}});a.appendChild(c);let d=je({text:Kt[Re.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new Xx(this.layer,{})}});a.appendChild(d),r.appendChild(a),this.element.appendChild(r),this.element.appendChild(this.headerRow);let{virtualList:p}=this;p.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(p.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});let m=gD();this.registerDisposer(new yn(this.virtualList.element,m)),this.virtualList.element.title=m.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){let e=this.annotationStates.states,{attachedAnnotationStates:t}=this,r=new Map;for(let[i,a]of t)e.includes(i)||(t.delete(i),a.refCounted.dispose());for(let i of e){let a=t.get(i);if(a!==void 0){r.set(i,a);continue}let o=i.source,l=new $;o instanceof Ga&&(l.registerDisposer(o.childAdded.add(c=>this.addAnnotationElement(c,i))),l.registerDisposer(o.childUpdated.add(c=>this.updateAnnotationElement(c,i))),l.registerDisposer(o.childDeleted.add(c=>this.deleteAnnotationElement(c,i)))),l.registerDisposer(i.transform.changed.add(this.forceUpdateView)),r.set(i,{refCounted:l,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=r,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){let e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,r=[],i=[];for(let a=0,o=t.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[a]!==-1})&&r.push(a);for(let a=0,o=e.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[a]!==-1})&&i.push(a);(!Ce(r,this.globalDimensionIndices)||!Ce(i,this.localDimensionIndices))&&(this.localDimensionIndices=i,this.globalDimensionIndices=r,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,r=!1){let i=this.attachedAnnotationStates.get(e);if(i==null)return;let a=i.idToIndex.get(t);if(a===void 0)return;let o=i.listOffset+a;return r&&this.virtualList.scrollItemIntoView(a),this.virtualList.getItemElement(o)}clearSelectionClass(){let{previousSelectedState:e}=this;if(e===void 0)return;this.previousSelectedState=void 0;let t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){let{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;let r=this.getRenderedAnnotationListElement(t,e);r!==void 0&&r.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){let e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;let r=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);r!==void 0&&r.classList.add("neuroglancer-annotation-selected")}updateHoverView(){let e=this.displayState.hoverState.value,t,r;e!==void 0&&(t=e.id,r=e.annotationLayerState);let{previousHoverId:i,previousHoverAnnotationLayerState:a}=this;if(t===i&&r===a||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=r,t===void 0))return;let o=this.getRenderedAnnotationListElement(r,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){let{annotation:t,state:r}=this.listElements[e];return this.makeAnnotationListElement(t,r)}setColumnWidth(e,t){t+=2;let{columnWidths:r}=this;r[e]>t||(r[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;let{columnWidths:i}=this;i.length=0;let{headerRow:a}=this,o=document.createElement("div");o.style.gridColumn="symbol";let l=document.createElement("div");l.style.gridColumn="delete",Me(a),a.appendChild(o);let c=0,d="[symbol] 2ch",p=(v,b)=>{let x=document.createElement("div");x.classList.add("neuroglancer-annotations-view-dimension");let C=document.createElement("span");C.classList.add("neuroglancer-annotations-view-dimension-name"),C.textContent=v.names[b];let L=document.createElement("scale");L.classList.add("neuroglancer-annotations-view-dimension-scale"),L.textContent=Li(v.scales[b],v.units[b],{precision:2}),x.appendChild(C),x.appendChild(L),x.style.gridColumn=`dim ${c+1}`,this.setColumnWidth(c,L.textContent.length+C.textContent.length+3),d+=` [dim] var(--neuroglancer-column-${c}-width)`,++c,a.appendChild(x)},m=this.layer.manager.root.coordinateSpace.value;for(let v of this.globalDimensionIndices)p(m,v);let y=this.layer.localCoordinateSpace.value;for(let v of this.localDimensionIndices)p(y,v);a.appendChild(l),d+=" [delete] 2ch",this.gridTemplate=d,a.style.gridTemplateColumns=d,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1,{listElements:t}=this;t.length=0;for(let[i,a]of this.attachedAnnotationStates){if(i.source.readonly||(e=!0),i.chunkTransform.value.error!==void 0)continue;let{source:o}=i,l=Array.from(o);a.annotations=l;let{idToIndex:c}=a;c.clear();for(let d=0,p=l.length;d<p;++d)c.set(l[d].id,d);for(let d of l)t.push({state:i,annotation:d})}let r=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(let t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.annotations.length;r.annotations.push(e),r.idToIndex.set(e.id,i);let a=r.listOffset+i;this.listElements.splice(a,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.idToIndex.get(e.id);if(i!==void 0){let a=r.listOffset+i;r.annotations[i]=e,this.listElements[a].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let{idToIndex:i}=r,a=i.get(e);if(a!==void 0){let o=r.listOffset+a,{annotations:l}=r;l.splice(a,1),i.delete(e);for(let c=a,d=l.length;c<d;++c)i.set(l[c].id,c);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){let r=t.chunkTransform.value,i=document.createElement("div");i.classList.add("neuroglancer-annotation-list-entry"),i.style.gridTemplateColumns=this.gridTemplate;let a=document.createElement("div");a.className="neuroglancer-annotation-icon",a.textContent=Kt[e.type].icon,i.appendChild(a);let o,l=()=>{t.source.readonly||o===void 0&&(o=La({title:"Delete annotation",onClick:p=>{p.stopPropagation(),p.preventDefault();let m=t.source.getReference(e.id);try{t.source.delete(m)}finally{m.dispose()}}}),o.classList.add("neuroglancer-annotation-list-entry-delete"),i.appendChild(o))},c=0;if(iR(e,r,(p,m)=>{++c;let y=document.createElement("div");y.className="neuroglancer-annotation-position",i.appendChild(y);let v=0,b=(x,C)=>{for(let L of x){let A=C[L];if(A!==-1){let D=Math.floor(p[A]),R=document.createElement("div"),P=D.toString();R.textContent=P,R.classList.add("neuroglancer-annotation-coordinate"),R.style.gridColumn=`dim ${v+1}`,this.setColumnWidth(v,P.length),y.appendChild(R)}++v}};b(this.globalDimensionIndices,r.modelTransform.globalToRenderLayerDimensions),b(this.localDimensionIndices,r.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;let p=document.createElement("div");p.classList.add("neuroglancer-annotation-description"),p.textContent=e.description,i.appendChild(p)}a.style.gridRow=`span ${c}`,o!==void 0&&(o.style.gridRow=`span ${c}`),i.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),i.addEventListener("action:select-position",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),i.addEventListener("action:pin-annotation",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),i.addEventListener("action:move-to-annotation",p=>{p.stopPropagation(),p.preventDefault();let{layerRank:m}=r,y=new Float32Array(m),v=new Float32Array(m);jH(y,e),zr(v,r.chunkToLayerTransform,m+1,y,m),rR(this.layer,r,v)});let d=this.selectedAnnotationState.value;return d!==void 0&&d.annotationLayerState===t&&d.annotationId===e.id&&i.classList.add("neuroglancer-annotation-selected"),i}},oR=class extends an{constructor(e){super();this.layer=e;this.layerView=this.registerDisposer(new aR(this.layer,this.layer.annotationDisplayState));let{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}};function tg(n){let e=[],{relationships:t}=n.source,{relationshipStates:r}=n.displayState;for(let i=0,a=t.length;i<a;++i){let o=r.get(t[i]).segmentationState.value;if(o!=null&&o.segmentSelectionState.hasSelectedSegment){e[i]=[o.segmentSelectionState.selectedSegment.clone()];continue}e[i]=[]}return e}var Jx=class extends rp{constructor(e,t){super(e)}get annotationLayer(){for(let e of this.layer.annotationStates.states)if(!e.source.readonly)return e}},sR="annotatePoint",lR="annotateLine",cR="annotateBoundingBox",uR="annotateSphere",qx=class extends Jx{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=dp(e,t);if(r===void 0)return;let i={id:"",description:"",relatedSegments:tg(t),point:r,type:Re.POINT,properties:t.source.properties.map(o=>o.default)},a=t.source.add(i,!0);this.layer.selectAnnotation(t,a.id,!0),a.dispose()}}get description(){return"annotate point"}toJSON(){return sR}};function dp(n,e){let t=e.chunkTransform.value;if(t.error!==void 0)return;let r=new Float32Array(t.modelTransform.unpaddedRank);if(!!Ha(r,n.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return r}var Yx=class extends Jx{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=()=>{let i=this.inProgressAnnotation,a=i.reference,o=this.getUpdatedAnnotation(a.value,e,t);JSON.stringify(Rf(o,t.source))!==JSON.stringify(Rf(a.value,t.source))&&(i.annotationLayer.source.update(a,o),this.layer.selectAnnotation(t,a.id,!0))};if(this.inProgressAnnotation===void 0){let i=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,i.id,!0);let a=e.changed.add(r),o=()=>{a(),i.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:i,disposer:o}}else r(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}},Kx=class extends Yx{getInitialAnnotation(e,t){let r=dp(e,t);return{id:"",type:this.annotationType,description:"",pointA:r,pointB:r,properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=dp(t,r);return i===void 0?e:{...e,pointB:i}}},ng=class extends Kx{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),{pointA:a,pointB:o}=i,l=a.length;for(let c=0;c<l;++c)a[c]===o[c]&&(o[c]+=1);return i}toJSON(){return cR}};ng.prototype.annotationType=Re.AXIS_ALIGNED_BOUNDING_BOX;var rg=class extends Kx{get description(){return"annotate line"}getInitialAnnotation(e,t){let r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=tg(t),r}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),a=this.initialRelationships,o=tg(r);return a===void 0?i.relatedSegments=o:i.relatedSegments=Array.from(o,(l,c)=>{let d=a[c];return l=l.filter(p=>d.findIndex(m=>X.equal(p,m))===-1),[...d,...l]}),i}toJSON(){return lR}};rg.prototype.annotationType=Re.LINE;var Xx=class extends Yx{getInitialAnnotation(e,t){let r=dp(e,t);return{type:Re.ELLIPSOID,id:"",description:"",segments:tg(t),center:r,radii:K.fromValues(0,0,0),properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=dp(t,r);if(i===void 0)return e;let a=e.center,o=a.length;for(let l=0;l<o;++l)i[l]=Math.abs(a[l]-i[l]);return{...e,radii:i}}get description(){return"annotate ellipsoid"}toJSON(){return uR}};ip(sR,(n,e)=>new qx(n,e));ip(cR,(n,e)=>new ng(n,e));ip(lR,(n,e)=>new rg(n,e));ip(uR,(n,e)=>new Xx(n,e));var JH=_e.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function qH(n,e,t,r){return new Mn(t,(i,a,o)=>{let l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),i!=null&&o.registerDisposer(zo(i,l));let c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");let d=yr({title:"Copy segment IDs",onClick:()=>{gr(e.map(b=>b.toString()).join(", "))}});c.appendChild(d);let p;if(i!=null&&(p=document.createElement("input"),p.type="checkbox",p.addEventListener("change",()=>{let{visibleSegments:b}=i.segmentationGroupState.value,x=e.some(C=>!b.has(C));for(let C of e)b.set(C,x)}),c.appendChild(p)),r!==void 0){let b=La({title:"Remove all IDs",onClick:()=>{r([])}});c.appendChild(b)}let m=document.createElement("span");if(m.classList.add("neuroglancer-related-segment-list-title"),m.textContent=n,c.appendChild(m),r!==void 0){let b=Nm({title:"Add related segment ID",onClick:()=>{let x=new $,C=o.registerDisposer(pf(x)),L=document.createElement("div");L.classList.add("neuroglancer-segment-list-entry"),L.classList.add("neuroglancer-segment-list-entry-new");let A=yr({});if(A.classList.add("neuroglancer-segment-list-entry-copy"),L.appendChild(A),i!=null){let V=document.createElement("input");V.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),V.type="checkbox",L.appendChild(V)}let D=La({title:"Cancel adding new segment ID",onClick:()=>{C()}});D.classList.add("neuroglancer-segment-list-entry-delete"),L.appendChild(D);let R=document.createElement("input");R.autocomplete="off",R.spellcheck=!1,R.classList.add("neuroglancer-segment-list-entry-id");let P=x.registerDisposer(new Gt(R,JH));P.allShortcutsAreGlobal=!0;let E=()=>{let V=new X;if(V.tryParseString(R.value))return R.dataset.valid="true",V;R.dataset.valid="false"};E(),R.addEventListener("input",()=>{E()}),R.addEventListener("blur",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),le(R,"cancel",C),le(R,"commit",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),L.appendChild(R),l.appendChild(L),R.focus(),x.registerDisposer(()=>{R.value="",L.remove()})}});c.appendChild(b)}l.appendChild(c);let y=[],v=Xs.make(i!=null?i:void 0,!1);for(let b of e){let x=v.get(b);if(y.push(x),r!==void 0){let C=La({title:"Remove ID",onClick:L=>{r(e.filter(A=>!X.equal(A,b))),L.stopPropagation()}});C.classList.add("neuroglancer-segment-list-entry-delete"),x.children[0].appendChild(C)}l.appendChild(x)}if(i!=null){let b=o.registerCancellable(Be(()=>{let{visibleSegments:x}=i.segmentationGroupState.value,C=0;for(let L of e)x.has(L)&&++C;for(let L of y)v.update(L);p.checked=C===e.length&&C>0,p.indeterminate=C>0&&C<e.length}));b(),b.flush(),Ho(i,o,b),o.registerDisposer(i.segmentationGroupState.changed.add(b))}a.appendChild(l)})}var dR="annotationColor";function _c(n){class e extends n{constructor(...r){super(...r);this.annotationStates=this.registerDisposer(new nR);this.annotationDisplayState=new _x;this.annotationCrossSectionRenderScaleHistogram=new ga;this.annotationCrossSectionRenderScaleTarget=Mi(8);this.annotationProjectionRenderScaleHistogram=new ga;this.annotationProjectionRenderScaleTarget=Mi(8);this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new oR(this)});let i,a=()=>{let l=this.isReady;l&&i!==void 0?(i(),i=void 0):!l&&i===void 0&&(i=this.annotationStates.markLoading())};this.readyStateChanged.add(a),a();let{mouseState:o}=this.manager.layerSelectedValues;this.registerDisposer(o.changed.add(()=>{if(o.active){let{pickedAnnotationLayer:l}=o;if(l!==void 0&&this.annotationStates.states.includes(l)){let c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==o.pickedAnnotationId||c.partIndex!==o.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(r){}restoreState(r){super.restoreState(r),this.annotationDisplayState.color.restoreState(r[dR])}captureSelectionState(r,i){super.captureSelectionState(r,i);let a=i.pickedAnnotationLayer;a===void 0||!this.annotationStates.states.includes(a)||(r.annotationId=i.pickedAnnotationId,r.annotationType=i.pickedAnnotationType,r.annotationSerialized=new Uint8Array(i.pickedAnnotationBuffer,i.pickedAnnotationBufferOffset),r.annotationPartIndex=i.pickedOffset,r.annotationSourceIndex=a.sourceIndex,r.annotationSubsource=a.subsourceId)}displayAnnotationState(r,i,a){if(r.annotationId===void 0)return!1;let o=this.annotationStates.states.find(c=>c.sourceIndex===r.annotationSourceIndex&&(r.annotationSubsource===void 0||c.subsourceId===r.annotationSubsource));if(o===void 0)return!1;let l=a.registerDisposer(o.source.getReference(r.annotationId));return i.appendChild(a.registerDisposer(new Mn(a.registerDisposer(new _u(()=>({annotation:l,chunkTransform:o.chunkTransform}))),({annotation:c,chunkTransform:d},p,m)=>{let y;if(c==null)if(r.annotationType!==void 0&&r.annotationSerialized!==void 0){let v=Kt[r.annotationType],b=o.source.rank,x=v.serializedBytes(b),C=r.annotationSerialized.byteOffset,L=C+x,A=new DataView(r.annotationSerialized.buffer),D=fn.LITTLE===ia,{properties:R}=o.source,P=new Ps(b,R);c=v.deserialize(A,C,D,b,r.annotationId),P.deserialize(A,L,D,c.properties=new Array(R.length)),o.source.hasNonSerializedProperties()&&(y="Loading...")}else y=c===null?"Annotation not found":"Loading...";if(c!=null){let v=d.error===void 0?d.layerRank:0,b=document.createElement("div");b.classList.add("neuroglancer-selected-annotation-details-position-grid"),b.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${v}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,p.appendChild(b);let x=Kt[c.type],C=document.createElement("div");if(C.className="neuroglancer-selected-annotation-details-icon",C.textContent=x.icon,b.appendChild(C),v!==0){let{layerDimensionNames:P}=d.modelTransform;for(let E=0;E<v;++E){let V=document.createElement("div");V.classList.add("neuroglancer-selected-annotation-details-position-dim"),V.textContent=P[E],V.style.gridColumn=`dim ${E+1}`,b.appendChild(V)}iR(c,d,(E,V)=>{let O=yr({title:"Copy position",onClick:()=>{gr(E.map(B=>Math.floor(B)).join(", "))}});O.style.gridColumn="copy",b.appendChild(O);for(let B=0;B<v;++B){let W=document.createElement("div");W.classList.add("neuroglancer-selected-annotation-details-position-coord"),W.style.gridColumn=`coord ${B+1}`,W.textContent=Math.floor(E[B]).toString(),b.appendChild(W)}if(!V){let B=Gh({title:"Move to position",onClick:()=>{rR(this,d,E)}});B.style.gridColumn="move",b.appendChild(B)}})}if(!o.source.readonly){let P=La({title:"Delete annotation",onClick:()=>{o.source.delete(l)}});P.classList.add("neuroglancer-selected-annotation-details-delete"),b.appendChild(P)}let{relationships:L,properties:A}=o.source,D=o.source.readonly;for(let P=0,E=A.length;P<E;++P){let V=A[P],O=document.createElement("label");O.classList.add("neuroglancer-annotation-property");let B=document.createElement("span");B.classList.add("neuroglancer-annotation-property-label"),B.textContent=V.identifier,O.appendChild(B);let{description:W}=V;W!==void 0&&(O.title=W);let _=c.properties[P],F=document.createElement("span");switch(F.classList.add("neuroglancer-annotation-property-value"),V.type){case"rgb":{let N=Ba(_),J=pn(N);F.textContent=J,F.style.backgroundColor=J,F.style.color=Gu(N)?"white":"black";break}case"rgba":{let N=Ba(_);F.textContent=pn(Wu(_)),F.style.backgroundColor=pn(Ba(_)),F.style.color=Gu(N)?"white":"black";break}default:F.textContent=dv(V,_);break}O.appendChild(F),p.appendChild(O)}let{relatedSegments:R}=c;for(let P=0,E=L.length;P<E;++P){let V=R===void 0?[]:R[P];if(V.length===0&&D)continue;let O=P,B=L[P];p.appendChild(m.registerDisposer(qH(B,V,o.displayState.relationshipStates.get(B).segmentationState,D?void 0:W=>{let _=l.value;if(_==null)return;let{relatedSegments:F}=_;F===void 0?F=o.source.relationships.map(()=>[]):F=F.slice(),F[O]=W;let N={..._,relatedSegments:F};o.source.update(l,N),o.source.commit(l)})).element)}if(!o.source.readonly||c.description)if(o.source.readonly){let P=document.createElement("div");P.className="neuroglancer-annotation-details-description",P.textContent=c.description||"",p.appendChild(P)}else{let P=document.createElement("textarea");P.value=c.description||"",P.rows=3,P.className="neuroglancer-annotation-details-description",P.placeholder="Description",P.addEventListener("change",()=>{let E=P.value;o.source.update(l,{...c,description:E||void 0}),o.source.commit(l)}),p.appendChild(P)}}if(y!==void 0){let v=document.createElement("div");v.classList.add("neuroglancer-selection-annotation-status"),v.textContent=y,p.appendChild(v)}})).element),!0}displaySelectionState(r,i,a){let o=this.displayAnnotationState(r,i,a);return super.displaySelectionState(r,i,a)&&(o=!0),o}addLocalAnnotations(r,i,a){let{subsourceEntry:o}=r,l=new Mc({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:i,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:o.id,role:a});this.addAnnotationLayerState(l,r)}addStaticAnnotations(r){let{subsourceEntry:i}=r,{staticAnnotations:a}=i.subsource;return a===void 0?!1:(r.activate(()=>{this.addLocalAnnotations(r,a,jn.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(r,i){let a=i.activated;a.registerDisposer(this.annotationStates.add(r));let o=new Hx(this.manager.chunkManager,r.addRef());if(o.source instanceof Ri){let l=new ZM({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(l.messages));let c=new QM({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(c.messages)),a.registerDisposer(Wn((d,p)=>{p&&(d.registerDisposer(this.addRenderLayer(l.addRef())),d.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{let l=new eR(o,this.annotationCrossSectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}{let l=new jx(o.addRef(),this.annotationProjectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}}selectAnnotation(r,i,a){this.manager.root.selectionState.captureSingleLayerState(this,o=>(o.annotationId=i,o.annotationSourceIndex=r.sourceIndex,o.annotationSubsource=r.subsourceId,!0),a)}toJSON(){let r=super.toJSON();return r[dR]=this.annotationDisplayState.color.toJSON(),r}}return e}var pR="volume_rendering/VolumeRenderingRenderLayer",fR="volume_rendering/VolumeRenderingRenderLayer/update",ig=64,YH=Ct.create();function hR(n,e,t){let r=0,i=0;for(let d=0;d<3;++d){let p=n[16+d],m=p*e[d],y=p*t[d];r+=Math.min(m,y),i+=Math.max(m,y)}let a=-n[19],o=Math.max(a,r),l=n[23],c=Math.min(l,i);return{near:a,far:l,adjustedNear:o,adjustedFar:c}}function Qx(n,e,t,r,i,a){if(r.length===0)return;let{viewMatrix:o,projectionMat:l,displayDimensionRenderInfo:c}=n,{voxelPhysicalScales:d}=c,p=Fu(d),y=(Lf(l)/ig)**3,v=Ct.determinant(Ts(YH,o)),b=P=>{let E=r[P];return Math.abs(E.chunkLayout.detTransform*v)},x=r.length-1,C=b(x);for(let P=x-1;P>=0;--P){let E=b(P);if(Math.abs(E-y)<Math.abs(C-y))C=E,x=P;else break}let L=Math.pow(C*p/v,1/3),A=Math.pow(C,1/3)*n.width/(2*l[0]),D=!0,R=r[x];ah(n,e,R,(P,E)=>{D&&(i(R,x,L,A,E),D=!1),a(R,x,P)})}var KH=ie.create(),XH=new Float32Array(24),Zx=class extends Ir{get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}constructor(e){super();this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));let t=this.registerDisposer(qt(o=>o.rank,[this.channelCoordinateSpace]));this.shaderGetter=rd(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:l})=>`${pt(o)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:l,chunkFormat:c},d,p)=>{if(d.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");vr(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addVarying("highp vec4","vNormalizedPosition"),o.addVertexCode(TM),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),Yh(o,c,p,"curChunkPosition"),o.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),o.addFragmentCode(Ei),Ii(d,o),o.addFragmentCode(`
#define main userMain
`+Di(d.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(Rn.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));let{chunkManager:r}=this.multiscaleSource,i=this.registerDisposer(new ha(this.layerChunkProgressInfo)),a=r.rpc;i.RPC_TYPE_ID=pR,i.initializeCounterpart(a,{chunkManager:r.rpcId,localPosition:this.registerDisposer(Lt.makeFromExisting(a,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Lt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Wn((t,r,i)=>{let a=Sd(i,r,o=>this.multiscaleSource.getSources(o),e.messages,this);for(let o of a)for(let l of o)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(fR,{layer:this.backend.rpcId,view:e.view.rpcId,sources:gd(a)}),this.redrawNeeded.dispatch(),a},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;let r=t.state.sources.value;if(r.length===0)return;let i=0,a=0,o=null,l,c,d=K.create(),{gl:p}=this;this.vertexIdHelper.enable();let{renderScaleHistogram:m}=this;m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let y=()=>{o!==null&&(l!==null&&l.endDrawing(p,o),(C!==0||L!==0)&&m.add(i,a,C,L))},v=!0,{projectionParameters:b}=e,x,C=0,L=0,A,D=this.multiscaleSource.rank,R=K.create();p.enable(WebGL2RenderingContext.CULL_FACE),p.cullFace(WebGL2RenderingContext.FRONT),Qx(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],(P,E,V,O)=>{i=V,a=O;let B=sc(b,P.chunkLayout),W=P.source,{fixedPositionWithinChunk:_,chunkDisplayDimensionIndices:F}=P;for(let ge of F)_[ge]=0;let N=W.chunkFormat;if(N!==l&&(l=N,y(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:N}),o=c.shader,o!==null&&(o.bind(),N!==null&&(Jr(p,o,this.shaderControlState,c.parameters.parseResult.controls),N.beginDrawing(p,o),N.beginSource(p,o)))),A=void 0,o===null)return;x=W.chunks,d.fill(1);let J=ie.multiply(KH,b.viewProjectionMat,B.transform);p.uniformMatrix4fv(o.uniform("uModelViewProjectionMatrix"),!1,J);let re=XH;Ls(re,J),ie.invert(J,J),p.uniformMatrix4fv(o.uniform("uInvModelViewProjectionMatrix"),!1,J);let{near:pe,far:ye,adjustedNear:ce,adjustedFar:fe}=hR(re,P.lowerClipDisplayBound,P.upperClipDisplayBound),Ge=(fe-ce)/(ig-1)/(ye-pe);p.uniform1f(o.uniform("uBrightnessFactor"),Ge);let ze=(ce-pe)/(ye-pe),tt=(fe-pe)/(ye-pe);p.uniform1f(o.uniform("uNearLimitFraction"),ze),p.uniform1f(o.uniform("uFarLimitFraction"),tt),p.uniform1i(o.uniform("uMaxSteps"),ig),p.uniform3fv(o.uniform("uLowerClipBound"),P.lowerClipDisplayBound),p.uniform3fv(o.uniform("uUpperClipBound"),P.upperClipDisplayBound)},P=>{if(o===null)return;let E=P.curPositionInChunks.join(),V=x.get(E);if(V!==void 0&&V.state===Qe.GPU_MEMORY){let O=P.chunkLayout.size,B=V.chunkDataSize,{chunkDisplayDimensionIndices:W,fixedPositionWithinChunk:_,chunkTransform:{channelToChunkDimensionIndices:F}}=P,{}=P;if(B!==A){A=B;for(let J=0;J<3;++J){let re=W[J];d[J]=re===-1||re>=D?1:A[re]}p.uniform3fv(o.uniform("uChunkDataSize"),d)}let{chunkGridPosition:N}=V;for(let J=0;J<3;++J){let re=W[J];R[J]=re===-1||re>=D?0:O[J]*N[re]}l!=null&&l.bindChunk(p,o,V,_,W,F,v),v=!1,p.uniform3fv(o.uniform("uTranslation"),R),LM(p,1,1),++C}else++L}),p.disable(WebGL2RenderingContext.CULL_FACE),y(),this.vertexIdHelper.disable()}isReady(e,t){let r=t.state.sources.value;if(r.length===0)return!0;let i=!1;return Qx(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},a=>{let o=a.source.chunks.get(a.curPositionInChunks.join());(o===void 0||o.state!==Qe.GPU_MEMORY)&&(i=!0)}),i}};var QH=_e.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}}),mR=class{constructor(e){this.id=e;this.element=document.createElement("div");this.nameContainer=document.createElement("div");this.nameElement=document.createElement("input");this.lowerElement=document.createElement("div");this.upperElement=document.createElement("div");let{element:t,nameContainer:r,nameElement:i,lowerElement:a,upperElement:o}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),r.classList.add("neuroglancer-channel-dimensions-widget-name-container"),i.classList.add("neuroglancer-channel-dimensions-widget-name"),r.appendChild(i),a.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(r),t.appendChild(a),t.appendChild(o),r.draggable=!0,i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",i.required=!0,i.placeholder=" ",r.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.addEventListener("dblclick",()=>{i.disabled=!1,i.focus(),i.select()}),i.addEventListener("focus",()=>{i.select()})}},eC=class extends ${constructor(e){super();this.combiner=e;this.element=document.createElement("div");this.dimensionWidgets=[];this.curCoordinateSpace=void 0;this.dragSource=void 0;this.coordinateSpace=this.combiner.combined;let{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");let r=this.registerCancellable(Be(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(r));let i=this.registerDisposer(new Gt(t,QH));i.allShortcutsAreGlobal=!0,this.registerDisposer(le(t,"cancel",a=>{this.forceUpdateView();let{target:o}=a;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this;r.value=Xf(r.value,e,t)}makeNewDimensionWidget(e){let t=new mR(e);return t.nameContainer.addEventListener("dragstart",r=>{this.dragSource=t,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",r=>{let{dragSource:i}=this;if(i===void 0||i===t)return;let{dimensionWidgets:a}=this,o=a.indexOf(i),l=a.indexOf(t);o===-1||l===-1||(r.preventDefault(),this.reorderDimensionTo(l,o))}),t.nameContainer.addEventListener("dragend",r=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",r=>{t.nameElement.disabled=!0;let{relatedTarget:i}=r;this.dimensionWidgets.some(a=>a.nameElement===i)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{let{nameElement:r}=t;gn(r),this.updateNameValidity()}),le(t.nameElement,"commit",()=>{this.updateNames()}),le(t.nameElement,"tab-forward",r=>this.selectAdjacentField(r,t,1)),le(t.nameElement,"tab-backward",r=>this.selectAdjacentField(r,t,-1)),t}selectAdjacentField(e,t,r){e.stopPropagation();let{dimensionWidgets:i}=this,a=i.indexOf(t);if(a===-1)return;let o=a+r;if(o<0||o>=i.length)return;let l=i[o];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){let{dimensionWidgets:e,coordinateSpace:t}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(Ce(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateNameValidity(){let{dimensionWidgets:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){let{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;let{element:t}=this,r=this.dimensionWidgets,i=this.dimensionWidgets=e.ids.map(o=>r.find(l=>l.id===o)||this.makeNewDimensionWidget(o));function*a(){let{names:o,rank:l,bounds:{lowerBounds:c,upperBounds:d}}=e;for(let p=0;p<l;++p){let m=i[p];m.nameElement.value=o[p],delete m.nameElement.dataset.isValid,gn(m.nameElement),m.lowerElement.textContent=c[p].toString(),m.upperElement.textContent=d[p].toString(),yield m.element}}In(t,a.call(this))}};function ts(n={}){return je({text:"?",...n})}function gR(n,e,t,r){let i=document.createElement("label");i.classList.add("neuroglancer-layer-control-container");let a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label-container");let o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),a.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),o.appendChild(l),t.title&&(o.title=t.title),i.appendChild(a);let{control:c,controlElement:d}=t.makeControl(e,n,{labelContainer:a,labelTextContainer:l,display:e.manager.root.display,visibility:r});return d.classList.add("neuroglancer-layer-control-control"),i.appendChild(d),{controlContainer:i,label:o,labelContainer:a,labelTextContainer:l,control:c}}var ag=class extends ao{constructor(e,t){super(e);this.options=t}activate(e){let{options:t}=this,{layer:r}=this,{isValid:i}=t;if(i!==void 0&&!i(r).value)return;let{header:a,body:o}=ap(e),{controlContainer:l,control:c,labelContainer:d}=gR(e,r,t,new kt(kt.VISIBLE));a.appendChild(d),o.appendChild(l),t.activateTool(e,c)}get description(){var t;let{options:e}=this;return(t=e.toolDescription)!=null?t:e.label}toJSON(){return this.options.toolJson}};function yR(n,e,t,r){let{controlContainer:i,label:a}=gR(n,e,t,r);return i.classList.add("neuroglancer-layer-options-control-container"),a.prepend(n.registerDisposer(new Wm(e,t.toolJson)).element),i}function Vc(n,e,t,r){let{isValid:i}=r;return i===void 0?yR(n,e,r,t):n.registerDisposer(new Mn(i(e),(a,o,l)=>{!a||o.appendChild(yR(l,e,r,t))},t)).element}function og(n,e){let{toolJson:t}=e,r=typeof t=="string"?t:t.type;cl(n,r,i=>new ag(i,e))}function ns(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new pr(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}var pp=class extends ${constructor(e){super();this.model=e;this.element=document.createElement("select");this.valueIndexMap=new Map;let{element:t,valueIndexMap:r}=this,i=0;for(let a of Object.keys(e.enumType))if(isNaN(Number(a))){let o=document.createElement("option");o.textContent=o.value=a.toLowerCase(),t.appendChild(o),r.set(e.enumType[a],i),++i}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",a=>{a.preventDefault(),a.stopPropagation(),this.adjustViaWheel(a)}),this.updateView()}adjustViaWheel(e){let{element:t}=this,{deltaY:r}=e;r>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):r<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){let{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}};var ZH=_e.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function sg(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new pp(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(ZH),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)})}}}var tC=class extends ${constructor(e,{min:t=0,max:r=1,step:i=.01}={}){super();this.value=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");this.numericInputElement=document.createElement("input");let{element:a,inputElement:o,numericInputElement:l}=this;a.className="range-slider";let c=p=>{p.min=""+t,p.max=""+r,p.step=""+i,p.valueAsNumber=this.value.value,this.registerEventListener(p,"change",()=>this.inputValueChanged(p)),this.registerEventListener(p,"input",()=>this.inputValueChanged(p)),this.registerEventListener(p,"wheel",m=>{this.adjustViaWheel(p,m)})};o.type="range",c(o),l.type="number";let d=Math.max(t.toString().length,r.toString().length,Math.min(r,t+i).toString().length,Math.max(t,r-i).toString().length);l.style.width=d+2+"ch",c(l),a.appendChild(o),a.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){let r=this.inputElement,{deltaY:i}=t;i>0?(r.stepUp(),this.inputValueChanged(e)):i<0&&(r.stepDown(),this.inputValueChanged(e))}disposed(){Ye(this.element),super.disposed()}};var e$=_e.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function Gi(n){return{makeControl:(e,t)=>{let{value:r,options:i}=n(e),a=t.registerDisposer(new tC(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(e$),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(t.inputElement,r.detail)})}}}var vR='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="maximiseIconTitle"><polyline points="21 16 21 21 16 21"></polyline><polyline points="8 21 3 21 3 16"></polyline><polyline points="16 3 21 3 21 8"></polyline><polyline points="3 8 3 3 8 3"></polyline></svg>';function rs(n={}){return je({svg:vR,...n})}var SR=rt(Dt()),bR=rt(Kd());function lg(n,e){let t="";for(let r=0;r<=e&&(t=n.toFixed(r),parseFloat(t)!==n);++r);return t}var t$=200,xR=_e.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function n$(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${lg(t,1)}p${e}`}return Math.round(n)+""}var fp=class extends ${constructor(e,t){super();this.histogram=e;this.target=t;this.label=document.createElement("div");this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.legend=document.createElement("div");this.legendRenderScale=document.createElement("div");this.legendSpatialScale=document.createElement("div");this.legendChunks=document.createElement("div");this.ctx=this.canvas.getContext("2d");this.hoverTarget=new Ae(void 0);this.throttledUpdateView=this.registerCancellable((0,bR.default)(()=>this.debouncedUpdateView(),t$,{leading:!0,trailing:!0}));this.debouncedUpdateView=this.registerCancellable((0,SR.default)(()=>this.updateView(),0));let{canvas:r,label:i,element:a,legend:o,legendRenderScale:l,legendSpatialScale:c,legendChunks:d}=this;i.className="neuroglancer-render-scale-widget-prompt",a.className="neuroglancer-render-scale-widget",a.title=xR.describe(),o.className="neuroglancer-render-scale-widget-legend",a.appendChild(i),a.appendChild(r),a.appendChild(o),l.title="Target resolution of data in screen pixels",d.title="Number of chunks rendered",o.appendChild(l),o.appendChild(d),o.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new yn(r,xR)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));let p=y=>{let v=y.offsetX/r.width*en;return F1(v)};this.registerEventListener(r,"pointermove",y=>{this.hoverTarget.value=[p(y),y.offsetY]}),this.registerEventListener(r,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(le(r,"set",y=>{this.target.value=p(y.detail)})),this.registerDisposer(le(r,"adjust-via-wheel",y=>{this.adjustViaWheel(y.detail)})),this.registerDisposer(le(r,"reset",y=>{this.reset(),y.preventDefault()}));let m=new ResizeObserver(()=>this.debouncedUpdateView());m.observe(r),this.registerDisposer(()=>m.disconnect()),this.updateView()}adjustViaWheel(e){let{deltaY:t}=e;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**Math.sign(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){let{ctx:e}=this,{canvas:t}=this,r=t.width=t.offsetWidth,i=t.height=t.offsetHeight,a=this.target.value,o=this.hoverTarget.value;{let{legendRenderScale:E}=this,V=o===void 0?a:o[0],O=n$(V);E.textContent=O+" px"}function l(E){return E*r/en}e.clearRect(0,0,r,i);let{histogram:c}=this,{value:d,spatialScales:p}=c;c.visibility.visible||d.fill(0);let m=Array.from(p.keys());m.sort();let y=K.create(),v=1,b=p.size,x=0,C=0;for(let E=0;E<en;++E){let V=0;for(let O=0;O<b;++O){let B=O*en*2+E,W=d[B],_=d[B+en];x+=W,C+=_,V+=W+_}v=Math.max(V,v)}let A=i/Math.log(1+v);function D(E){return i-Math.log(1+E)*A}let R;if(o!==void 0){let E=Math.floor(md(o[0]));if(E>=0&&E<en){let V=0,O=o[1];for(let B=b-1;B>=0;--B){let W=m[B],_=p.get(W),F=2*_*en+E,N=d[F]+d[F+en];if(N===0)continue;let J=Math.round(D(V));if(V+=N,Math.round(D(V))<=O&&O<=J){R=W;break}}}}if(R!==void 0){x=0,C=0;let E=p.get(R),V=2*E*en;for(let O=0;O<en;++O){let B=V+O;x+=d[B],C+=d[B+en]}Number.isFinite(R)?this.legendSpatialScale.textContent=Li(R,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${x}/${x+C}`;let P=m.map(E=>{let V=E===R?.5:1,O;Number.isFinite(E)?O=(Math.log2(E)*.1%1+1)%1:O=0,Ys(y,O,V,1);let B=pn(y);Ys(y,O,V,.5);let W=pn(y);return[B,W]});for(let E=0;E<en;++E){let V=0;for(let O=b-1;O>=0;--O){let B=m[O],_=p.get(B)*en*2+E,F=d[_],N=d[_+en],J=F+N;if(J===0)continue;let re=Math.round(l(E)),pe=Math.round(l(E+1)),ye=Math.round(D(V));V+=J;let ce=Math.round(D(V)),fe=(F*ce+N*ye)/J;e.fillStyle=P[O][1],e.fillRect(re,ce,pe-re,fe-ce),e.fillStyle=P[O][0],e.fillRect(re,fe,pe-re,ye-fe)}}{let E=a;e.fillStyle="#fff";let V=l(md(E)),O=1;e.fillRect(Math.floor(V),0,O,i)}if(o!==void 0){let E=o[0];e.fillStyle="#888";let V=l(md(E)),O=1;e.fillRect(Math.floor(V),0,O,i)}}},r$=_e.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function Oc(n){return{makeControl:(e,t)=>{let{histogram:r,target:i}=n(e),a=t.registerDisposer(new fp(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(r$),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)}),e.bindAction("reset",r=>{r.stopPropagation(),r.preventDefault(),t.reset()})}}}var gbe=rt(TR());var ml=rt(is()),ER=rt(kR()),DR=rt(Dt());(0,ER.default)(ml.default);var i$=500,so=class extends ${constructor(e){super();this.state=e;this.changingValue=!1;this.debouncedValueUpdater=(0,DR.default)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},i$);this.textEditor=(0,ml.default)(i=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));let{shaderControlState:t}=this.state;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();let r=new IntersectionObserver(i=>{i.some(a=>a.isIntersecting)&&this.textEditor.refresh()},{root:document.body});r.observe(this.element),this.registerDisposer(()=>r.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){let{sourceStringNumber:e=1}=this.state,t=this.state.shaderError.value,r,{shaderControlState:i}=this.state;i!==void 0?r=i.parseErrors.value:r=[],t===void 0&&r.length===0?this.setValidState(void 0):t!=null||r.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{let a=[];for(let o of r)a.push({message:o.message,severity:"error",from:ml.default.Pos(o.line)});if(t!=null)if(t.name==="ShaderCompilationError")for(let o of t.errorMessages)a.push({message:o.message,severity:"error",from:ml.default.Pos(o.file===e&&o.line||0)});else t.name==="ShaderLinkError"?a.push({message:t.log,severity:"error",from:ml.default.Pos(0)}):a.push({message:t.message,severity:"error",from:ml.default.Pos(0)});return a}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,Ye(this.element),this.textEditor=void 0,super.disposed()}};var pC=rt(Dt());var a$=0,o$=1,s$=2;function gl(n){let e=0,{deltaMode:t}=n;switch(t){case a$:e=1/200;break;case o$:e=1/10;break;case s$:e=2;break}return Math.exp(n.deltaY*e)}var PR=_e.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}}),cg=class extends ${constructor(e,t,r,i){super();this.element=e;this.dataType=t;this.getModel=r;this.setModel=i;e.title=PR.describe(),this.registerDisposer(new yn(e,PR)),le(e,"set",a=>{let o=a.detail,l=this.getModel(),c=this.getTargetValue(o);if(c===void 0)return;let d=Ds(l.window,l.range),p=kk(d,c),m=y=>{let v=this.getModel();this.setModel(hp(v,"range",p,y))};m(c),An(o,y=>{let v=this.getTargetValue(y);v!==void 0&&m(v)})}),le(e,"adjust-window-via-drag",a=>{let o=a.detail,l=this.getTargetFraction(o),c=this.getWindowLerp(l),d=l<.5?0:1,p=m=>{let y=this.getModel();this.setModel(hp(y,"window",d,m))};An(o,m=>{let y=this.getModel().window,v=this.getTargetFraction(m);p(d===0?oa([c,y[1]],this.dataType,-v/(1-v)):oa([y[0],c],this.dataType,1/v))})}),le(e,"zoom-via-wheel",a=>{let o=a.detail,l=gl(o),c=this.getTargetFraction(o),{dataType:d}=this,p=this.getModel(),m=oa(p.window,d,c*(1-l)),y=oa(p.window,d,(1-c)*l+c);this.setModel({...p,window:[m,y],range:p.range})})}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return oa(this.getModel().window,this.dataType,e)}getTargetValue(e){let t=this.getTargetFraction(e);if(!!Number.isFinite(t))return this.getWindowLerp(t)}},IR=Symbol("histogramSamplerTexture");function hp(n,e,t,r,i=!1){let a={...n},o=n[e];if(a[e]=[o[0],o[1]],a[e][t]=r,e==="window"&&cr(r,o[1-t])*(2*t-1)<0&&(a[e][1-t]=r),e==="range"&&i){let l=[n.window[0],n.window[1]];for(let c=0;c<2;++c)cr(r,l[c])*(2*c-1)>0&&(l[c]=r);a.window=l}return a}var l$=254,mp=l$+1,AR=class extends Ff{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.controller=this.registerDisposer(new cg(this.element,this.parent.dataType,()=>this.parent.trackable.value,e=>{this.parent.trackable.value=e}));this.dataValuesBuffer=this.registerDisposer(Ja(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{let e=new Uint8Array(mp*pi);for(let t=0;t<mp;++t)for(let r=0;r<pi;++r)e[t*pi+r]=t;return e})).value;this.lineShader=this.registerDisposer((()=>{let e=new $r(this.gl);return Yn(e),e.addTextureSampler("sampler2D","uHistogramSampler",IR),e.addOutputBuffer("vec4","out_color",0),e.addAttribute("uint","aDataValue"),e.addUniform("float","uBoundsFraction"),e.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),e.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${mp-1} ? cumSum : total;
if (dataValue == ${mp-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),e.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),e.build()})());this.regionCornersBuffer=Mo(this.gl,0,-1,1,1);this.regionShader=this.registerDisposer((()=>{let e=new $r(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),e.setFragmentMain(`
out_color = uColor;
`),e.build()})());let{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){let{lineShader:e,gl:t,regionShader:r,parent:{dataType:i,trackable:{value:a}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{r.bind(),t.uniform4f(r.uniform("uColor"),.2,.2,.2,1);let o=kr(a.window,a.range[0]),l=kr(a.window,a.range[1]),c=Ql(i,a.window);t.uniform2f(r.uniform("uBounds"),Math.min(o,l)*c,Math.max(o,l)*c+(1-c));let d=r.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(d,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(d)}if(this.parent.histogramSpecifications.producerVisibility.visible){let{renderViewport:o}=this;e.bind(),Xn(e,{width:o.logicalWidth,height:o.logicalHeight},1);let l=e.textureUnit(IR);t.uniform1f(e.uniform("uBoundsFraction"),Ql(i,a.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),qa(t);let c=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(c,1,WebGL2RenderingContext.UNSIGNED_BYTE),Kn(t,mp,1),t.disableVertexAttribArray(c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}};function c$(){}var MR=class extends Ff{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.cornersBuffer=Mo(this.gl,-1,-1,1,1);let{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");let r=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=jr(this,this.gl,{...r,memoizeKey:{id:"colorLegendShader",base:r.memoizeKey},defineShader:(i,a,o)=>{i.addOutputBuffer("vec4","v4f_fragData0",0),i.addAttribute("vec2","aVertexPosition"),i.addUniform("float","uLegendOffset"),i.addVarying("float","vLinearPosition"),i.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);let l=this.parent.dataType,c=At(l);i.addFragmentCode(d1(i,"ng_colorLegendLerp",l)),i.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${c} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${c} getDataValue(int dummyChannel) {
  return getDataValue();
}
${c} getInterpolatedDataValue() {
  return getDataValue();
}
${c} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),r.defineShader(i,a,o)}})}drawIndirect(){let e=this.shaderGetter(c$),{shader:t}=e;if(t===null)return;this.setGLLogicalViewport();let{gl:r}=this;r.clearColor(0,0,0,0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),r.enable(WebGL2RenderingContext.BLEND);let{trackable:{value:{window:i}},dataType:a}=this.parent;lc(t,"ng_colorLegendLerp",this.parent.dataType,i);let o=Ek(a,i);r.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(o)?o:0),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.disable(WebGL2RenderingContext.STENCIL_TEST);let l=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT),r.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),r.disableVertexAttribArray(l)}isReady(){return!0}};function RR(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${n}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=n==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function _R(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-invlerp-widget-bounds"),r.classList.add(`neuroglancer-invlerp-widget-${n}-bounds`);let i=[RR(n,0),RR(n,1)];for(let o=0;o<2;++o){let l=i[o];l.addEventListener("input",()=>{VR(l)}),l.addEventListener("change",()=>{let c=t.value,d=c[n];try{let p=Ua(e,l.value);t.value=hp(c,n,o,p,!0)}catch{iC(l,d[o])}})}let a;return r.appendChild(i[0]),r.appendChild(i[1]),n==="range"&&(a=[document.createElement("div"),document.createElement("div"),document.createElement("div")],a[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),r.insertBefore(a[0],i[0]),r.insertBefore(a[1],i[1]),r.appendChild(a[2])),{container:r,inputs:i,spacers:a}}function VR(n){gn(n,Math.max(1,n.value.length+.1))}function iC(n,e){let t;e instanceof X||Number.isInteger(e)?t=e.toString():t=e.toPrecision(6),n.value=t,VR(n)}function aC(n){let e=n.value,{range:t}=e;n.value={...e,range:[t[1],t[0]]}}function OR(n,e,t){let r=e.value,i=oa(r.range,n,.5-t/2),a=oa(r.range,n,.5+t/2);e.value={...r,range:[i,a]}}function NR(n,e,t,r,i){let a=Math.exp(i),o=e.value,l=oa(t,n,.5-a/2+r),c=oa(t,n,.5+a/2+r);e.value={...o,range:[l,c]}}var oC=class extends an{constructor(e,t,r,i,a,o,l){super(e);this.display=t;this.dataType=r;this.trackable=i;this.histogramSpecifications=a;this.histogramIndex=o;this.legendShaderOptions=l;this.cdfPanel=this.registerDisposer(new AR(this));this.boundElements={range:_R("range",this.dataType,this.trackable),window:_R("window",this.dataType,this.trackable)};this.registerDisposer(a.visibility.add(this.visibility));let{element:c,boundElements:d}=this;if(l!==void 0){let m=this.registerDisposer(new MR(this));c.appendChild(m.element)}let p=m=>{let y=je({svg:m,title:"Invert range",onClick:()=>{this.invertRange()}});return d.range.spacers[1].appendChild(y),y};this.invertArrows=[p(Oh),p(Vh)],c.appendChild(d.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(d.window.container),this.updateView(),this.registerDisposer(i.changed.add(this.registerCancellable(Be(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){aC(this.trackable)}updateView(){let{boundElements:e}=this,{trackable:{value:t},dataType:r}=this;for(let m=0;m<2;++m)iC(e.range.inputs[m],t.range[m]),iC(e.window.inputs[m],t.window[m]);let i=cr(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=i?"row-reverse":"row";let a=Ds(t.window,t.range),o=e.range.spacers,l=Ql(r,t.window),c=kr(t.window,a[i?1:0])*l,d=kr(t.window,a[i?0:1])*l+(1-l);o[i?2:0].style.width=`${c*100}%`,o[i?0:2].style.width=`${(1-d)*100}%`;let{invertArrows:p}=this;p[i?1:0].style.display="",p[i?0:1].style.display="none"}};var gp="neuroglancer-position",BR=_e.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),u$=[n=>n.nameElement,n=>n.coordinate,n=>n.scaleElement];function ug(n,e){let t=n.coordinateArrays[e];return t===void 0?t:n.units[e]!=""||n.scales[e]!==1?null:t}var FR=class{constructor(e,t){this.coordinateSpace=e;this.container=document.createElement("div");this.nameContainer=document.createElement("span");this.nameElement=document.createElement("input");this.scaleContainer=document.createElement("span");this.scaleElement=document.createElement("input");this.coordinate=document.createElement("input");this.coordinateLabel=document.createElement("span");this.coordinateLabelWidth=0;this.dropdownOwner=void 0;this.modified=!1;this.draggingPosition=!1;this.hasFocus=!1;let{container:r,scaleElement:i,scaleContainer:a,coordinate:o,nameElement:l,nameContainer:c,coordinateLabel:d}=this;r.title="",r.classList.add("neuroglancer-position-dimension"),r.draggable=!0,r.tabIndex=-1,r.appendChild(c),r.appendChild(i),c.appendChild(l),c.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(i),l.classList.add("neuroglancer-position-dimension-name"),l.disabled=!0,l.spellcheck=!1,l.autocomplete="off",l.required=!0,l.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),i.classList.add("neuroglancer-position-dimension-scale"),i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",r.appendChild(a),r.appendChild(o),o.type="text",o.classList.add("neuroglancer-position-dimension-coordinate"),o.spellcheck=!1,o.autocomplete="off",o.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;let p=ug(e,t);if(p!=null){let m=0;for(let y of p.labels)m=Math.max(m,y.length);this.coordinateLabelWidth=m,d.style.width=`${m+2}ch`,r.appendChild(d)}o.required=!0,o.placeholder=" ",d.classList.add("neuroglancer-position-dimension-coordinate-label")}};function sC(n,e,t,r){return Math.floor((n-e)*(r-1)/(t-e))}function d$(n,e,t){let{boundingBoxes:r,bounds:i}=n,a=Math.floor(i.lowerBounds[e]),o=Math.ceil(i.upperBounds[e]-1);if(!Number.isFinite(a)||!Number.isFinite(o))return;let l=[],c=p=>sC(p,a,o,t),{rank:d}=n;for(let p of r){let m=Ev(p,e,d);m!==void 0&&(m.lower=c(m.lower),m.upper=c(Math.ceil(m.upper-1)),l.push(m))}return l.sort((p,m)=>{let y=p.lower-m.lower;return y!==0?y:m.upper-m.upper}),uf(l,(p,m)=>{if(m===0)return!0;let y=l[m-1];return y.lower!==p.lower||y.upper!==p.upper}),{lowerBound:a,upperBound:o,normalizedBounds:l}}var lC=10,cC=15,p$=10,uC=lC+cC+p$;function f$(n,e,t){e.clearRect(0,0,n.width,n.height);let{normalizedBounds:r}=t;function i(o){e.fillRect(0,o,lC,1)}e.fillStyle="#fff";for(let{lower:o,upper:l}of r)i(o),i(l);let a=r.length;e.fillStyle="#ccc";for(let o=0;o<a;++o){let{lower:l,upper:c}=r[o],d=Math.floor(o*cC/a),p=Math.max(1,cC/a);e.fillRect(d+lC,l,p,c+1-l)}}function UR(n,e){gn(n,e.length+1)}function WR(n){let{value:e}=n;gn(n),n.parentElement.dataset.isEmpty=e===""?"true":"false"}var as=class extends ${constructor(e,t,{copyButton:r=!0}={}){super();this.position=e;this.combiner=t;this.element=document.createElement("div");this.dimensionContainer=document.createElement("div");this.coordinateSpace=void 0;this.dimensionWidgets=new Map;this.dimensionWidgetList=[];this.dragSource=void 0;let{element:i,dimensionContainer:a}=this;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(Be(()=>this.updateDimensions())))),i.className="neuroglancer-position-widget",a.style.display="contents",i.appendChild(a),r){let l=yr({title:"Copy position to clipboard",onClick:()=>{let c=gr(this.getPositionText());Ee.showTemporaryMessage(c?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",c=>{c.dataTransfer.setData(gp,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),c.dataTransfer.setData("text",this.getPositionText()),c.stopPropagation()}),l.draggable=!0,i.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(Be(()=>this.updateView()))));let o=this.registerDisposer(new Gt(i,BR));o.allShortcutsAreGlobal=!0,this.registerDisposer(new yn(i,BR)),this.registerDisposer(le(i,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();let{target:c}=l;c instanceof HTMLElement&&c.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");let r=document.createElement("canvas"),i=r.getContext("2d"),a=document.createElement("div"),o=document.createElement("div");o.appendChild(a);let l=document.createTextNode("");a.appendChild(l);let c=document.createElement("div"),d=document.createElement("div");o.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),c.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),d.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(o),t.appendChild(c),t.appendChild(d),t.appendChild(r);let p=100;r.width=uC,r.height=p,c.style.marginTop=`${p-1}px`;let m,y,v,b=()=>{let D=this.dimensionWidgetList.indexOf(e);if(D===-1)return;let{coordinateSpace:R}=e,P=d$(R,D,p);if(P===void 0||R.bounds.lowerBounds[D]+1===R.bounds.upperBounds[D]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";let{lowerBound:E,upperBound:V}=P;m=E,y=V,l.textContent=E.toString(),c.textContent=V.toString(),f$(r,i,P);let O=this.position.value[D];if(O>=E&&O<=V&&(i.fillStyle="#f66",i.fillRect(0,sC(O,E,V,p),uC,1)),v!==void 0&&v>=E&&v<=V){i.fillStyle="#66f";let B=sC(v,E,V,p);i.fillRect(0,B,uC,1),d.textContent=v.toString();let W=a.clientHeight;a.style.visibility=B>W?"":"hidden",c.style.visibility=B<p-W?"":"hidden",d.style.display="",d.style.visibility="visible",d.style.marginTop=`${B}px`}else a.style.visibility="",d.style.display="none",c.style.visibility=""},x=e.dropdownOwner,C=x.registerCancellable(Be(b));x.registerDisposer(this.position.changed.add(C));let L=D=>{if(m===void 0||y===void 0)return;let R=r.getBoundingClientRect(),P=(D.clientY-R.top)/R.height;return P=Math.max(0,P),P=Math.min(1,P),Math.round(P*(y-m))+m},A=D=>{let R=this.dimensionWidgetList.indexOf(e);if(R===-1)return;let P=L(D);if(P===void 0)return;let{position:E}=this,V=E.value;V[R]=P+.5,e.modified=!1,E.value=V};r.addEventListener("pointermove",D=>{v=L(D),C()}),r.addEventListener("pointerleave",()=>{v=void 0,C()}),r.addEventListener("pointerdown",D=>{D.preventDefault(),D.stopPropagation(),!(D.ctrlKey||D.altKey||D.shiftKey||D.metaKey)&&(An(D,R=>{e.dropdownOwner!==void 0&&(v=void 0,A(R),C(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),A(D))}),b()}openCoordinateArrayDropdown(e,t,r){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");let{coordinates:i,labels:a}=r,o=[],l=i.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let c=0;c<l;++c){let d=document.createElement("div");d.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");let p=document.createElement("div");p.classList.add("neuroglancer-dimension-dropdown-coordinate");let m=document.createElement("div");m.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),m.textContent=a[c],p.textContent=i[c].toString(),d.appendChild(p),d.appendChild(m),d.addEventListener("click",()=>{let y=this.dimensionWidgetList.indexOf(e);if(y===-1)return;let{position:v}=this,b=v.value;b[y]=i[c]+.5,e.modified=!1,v.value=b}),t.appendChild(d),o.push({entryElement:d,coordinateElement:p,labelElement:m})}}openDropdown(e){if(e.dropdownOwner!==void 0)return;let t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();let r=e.dropdownOwner=new $,i=document.createElement("div");i.draggable=!0,i.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),i.addEventListener("pointerenter",()=>{e.hasFocus=!0}),i.tabIndex=-1,e.container.appendChild(i);let a=ug(e.coordinateSpace,t);a==null?this.openRegularDropdown(e,i):this.openCoordinateArrayDropdown(e,i,a),this.widgetWithOpenDropdown=e,r.registerDisposer(()=>{Ye(i),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),r.registerEventListener(document,"pointerdown",o=>{let{target:l}=o;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;let{dropdownOwner:t}=e;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();let r=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(r===null)break;if(r[1]!==void 0&&document.execCommand("insertText",void 0,r[1]),r[2]!==void 0){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a===-1||a+1===i.length)break;let o=t.substring(r[0].length);e=i[a+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this.position;r.value=Xf(r.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){let r=new FR(e,t);r.container.addEventListener("dragstart",i=>{this.dragSource=r,i.stopPropagation(),i.dataTransfer.setData("neuroglancer-dimension","")}),r.container.addEventListener("dragenter",i=>{let{dragSource:a}=this;if(a===void 0||a===r)return;let{dimensionWidgetList:o}=this,l=o.indexOf(a),c=o.indexOf(r);l===-1||c===-1||(i.preventDefault(),this.reorderDimensionTo(c,l))}),r.container.addEventListener("dragend",i=>{this.dragSource===r&&(this.dragSource=void 0)}),r.nameContainer.addEventListener("dblclick",()=>{r.nameElement.disabled=!1,r.nameElement.focus(),r.nameElement.select()}),r.scaleContainer.addEventListener("dblclick",()=>{r.scaleElement.disabled=!1,r.scaleElement.focus(),r.scaleElement.select()}),r.coordinate.addEventListener("focus",()=>{r.coordinate.select()}),r.container.addEventListener("focusin",()=>{r.hasFocus=!0,this.updateDropdownVisibility(r)}),r.container.addEventListener("focusout",i=>{let{relatedTarget:a}=i;a instanceof Node&&r.container.contains(a)||(r.hasFocus=!1,this.updateDropdownVisibility(r))}),r.container.addEventListener("click",i=>{(!(i.target instanceof HTMLInputElement)||i.target.disabled)&&r.coordinate.focus()}),r.coordinate.addEventListener("paste",i=>{let a=r.coordinate,o=a.value,{clipboardData:l}=i;if(l===null)return;let c=l.getData("text"),{selectionEnd:d,selectionStart:p}=a;if(p!==0||d!==o.length){p==null&&(p=0),d==null&&(d=0);let m=c.match(/[^\-0-9\.]/);m!==null&&(c=c.substring(0,m.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(r,c);i.preventDefault(),i.stopPropagation()}),r.coordinate.addEventListener("input",()=>{r.modified=!0;let i=r.coordinate,a=i.value,{selectionDirection:o,selectionEnd:l,selectionStart:c}=i;c===null&&(c=0),l===null&&(l=c);let d="",p=/[^\-0-9\.]/g;d+=a.substring(0,c).replace(p,"");let m=d.length;d+=a.substring(c,l).replace(p,"");let y=d.length;d+=a.substring(l).replace(p,""),i.value=d,i.selectionStart=m,i.selectionEnd=y,i.selectionDirection=o,UR(i,d),l===c&&l===a.length&&a.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(r,1)}),r.nameElement.addEventListener("input",()=>{let{nameElement:i}=r;gn(i),this.updateNameValidity()}),r.scaleElement.addEventListener("input",()=>{let{scaleElement:i}=r;WR(i),this.updateScaleValidity(r)}),r.coordinate.addEventListener("blur",i=>{let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.coordinate===a)||r.modified&&this.updatePosition()}),r.nameElement.addEventListener("blur",i=>{r.nameElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.nameElement===a)||this.updateNames()||this.forceUpdateDimensions()}),r.scaleElement.addEventListener("blur",i=>{r.scaleElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.scaleElement===a)||this.updateScales()||this.forceUpdateDimensions()}),le(r.container,"adjust-via-wheel",i=>{let a=i.detail,{deltaY:o}=a;o!==0&&this.adjustDimension(r,Math.sign(o))}),le(r.container,"adjust-up",()=>{this.adjustDimension(r,-1)}),le(r.container,"adjust-down",()=>{this.adjustDimension(r,1)});for(let i of u$){let a=i(r);le(a,"maybe-tab-forward",o=>{this.handleLeftRightMovement(o,r,1,i)}),le(a,"maybe-tab-backward",o=>{this.handleLeftRightMovement(o,r,-1,i)}),le(a,"tab-forward",()=>{this.selectAdjacentField(r,1,i)}),le(a,"tab-backward",()=>{this.selectAdjacentField(r,-1,i)})}return le(r.coordinate,"commit",()=>{this.updatePosition()}),le(r.nameElement,"commit",()=>{this.updateNames()}),le(r.scaleElement,"commit",()=>{this.updateScales()}),le(r.coordinate,"delete-backward",i=>{i.stopPropagation();let{coordinate:a}=r;a.selectionStart===a.selectionEnd&&a.selectionStart===0&&(i.preventDefault(),this.selectAdjacentCoordinate(r,-1))}),r}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||(e=Hr),this.coordinateSpace=e;let{dimensionWidgets:t,dimensionWidgetList:r}=this;r.length=0;let{names:i,ids:a,scales:o,units:l}=e;In(this.dimensionContainer,a.map((c,d)=>{let p=t.get(c);p===void 0?(p=this.newDimension(e,d),t.set(c,p)):p.coordinateSpace=e;let m=i[d];p.nameElement.value=m,delete p.nameElement.dataset.isValid,gn(p.nameElement);let y=ug(e,d);y===void 0?p.container.dataset.coordinateArray="none":y===null?p.container.dataset.coordinateArray="invalid":p.container.dataset.coordinateArray="valid",p.scaleContainer.title="Drag to reorder, double click to change scale",y===null&&(p.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");let{scale:v,prefix:b,unit:x}=Tv(o[d],l[d]),C=`${v}${b}${x}`;return p.scaleElement.value=C,delete p.scaleElement.dataset.isValid,WR(p.scaleElement),r.push(p),p.container}));for(let[c,d]of t)d.coordinateSpace!==e&&(this.closeDropdown(d),t.delete(c))}updateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,r){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a!==-1)for(;;){if(a+=t,a<0||a>=i.length)return!1;let o=i[a],l=r(o);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,r=>r.coordinate)}handleLeftRightMovement(e,t,r,i){e.stopPropagation();let a=i(t);a.selectionStart!==a.selectionEnd||a.selectionStart!==(r===1?a.value.length:0)||this.selectAdjacentField(t,r,i)&&e.preventDefault()}updateNameValidity(){let{dimensionWidgetList:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}updateScaleValidity(e){let t=Do(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){let r=this.dimensionWidgetList.indexOf(e);if(r===-1)return;this.updatePosition();let{position:i}=this;if(!i.valid)return;let a=i.coordinateSpace.value,{bounds:o}=a,l=Float32Array.from(i.value),c=Math.floor(l[r]+t);if(t>0){let d=o.upperBounds[r];Number.isFinite(d)&&(c=Math.min(c,Math.ceil(d-1)))}else{let d=o.lowerBounds[r];Number.isFinite(d)&&(c=Math.max(c,Math.floor(d)))}l[r]=c+.5,this.position.value=l,this.updateView()}updatePosition(){let{dimensionWidgetList:e}=this,{position:t}=this,{value:r}=t;if(r===void 0)return;let i=e.length;for(let a=0;a<i;++a){let o=e[a];o.modified=!1;let l=Number(o.coordinate.value);Number.isFinite(l)&&(r[a]=l+(Number.isInteger(l)?.5:0))}t.value=r}updateNames(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(Ce(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateScales(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(m=>Do(m.scaleElement.value));if(i.includes(void 0))return!1;let a=Float64Array.from(i,m=>m.scale),o=Array.from(i,m=>m.unit),{scales:l,units:c}=r;if(Ce(l,a)&&Ce(c,o))return!1;let d=r.timestamps.map((m,y)=>a[y]===l[y]&&o[y]===c[y]?m:Date.now()),p=Ve({valid:r.valid,rank:r.rank,scales:a,units:o,timestamps:d,ids:r.ids,names:r.names,boundingBoxes:r.boundingBoxes,coordinateArrays:r.coordinateArrays});return t.value=p,!0}getPositionText(){let{position:e}=this;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();let{position:{value:e},dimensionWidgetList:t}=this,r=t.length;if(e===void 0)return;let i=this.coordinateSpace;for(let a=0;a<r;++a){let o=t[a],l=o.coordinate,c=Math.floor(e[a]),d=c.toString();UR(l,d),l.value=d;let p=ug(i,a),m="";if(p!=null){let{coordinates:v}=p,b=RT(v,c,(x,C)=>x-C);b!==v.length&&(m=p.labels[b])}let y=o.coordinateLabel;y.textContent=m}}disposed(){this.closeDropdown(),Ye(this.element),super.disposed()}},dC=class extends ${constructor(e,t,r){super();this.element=e;this.mouseState=t;this.coordinateSpace=r;this.tempPosition=K.create();e.className="neuroglancer-mouse-position-widget";let i=this.registerCancellable(Be(()=>this.updateView()));this.registerDisposer(t.changed.add(i)),this.registerDisposer(r.changed.add(i))}updateView(){let e="",{mouseState:t,coordinateSpace:{value:r}}=this;if(t.active&&r!==void 0){let i=t.position,{rank:a,names:o}=r;for(let l=0;l<a;++l)l!==0&&(e+="  "),e+=`${o[l]} ${Math.floor(i[l])}`}this.element.textContent=e}disposed(){Ye(this.element),super.disposed()}};var h$=_e.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function GR(n){return{makeControl:(e,t,r)=>{let{watchableValue:i,channelCoordinateSpaceCombiner:a,dataType:o,defaultChannel:l,histogramSpecifications:c,legendShaderOptions:d,histogramIndex:p}=n(e);if(a!==void 0&&l.length!==0){let y=t.registerDisposer(new Bi(a.combined)),v=t.registerDisposer(new as(y,a,{copyButton:!1}));t.registerDisposer(y.changed.add(()=>{let x=y.value,C=Array.from(x,A=>Math.floor(A)),L=i.value;Ce(L.channel,C)||(i.value={...i.value,channel:C})}));let b=()=>{let x=y.value,C=i.value;Ce(x,C.channel)||(x.set(C.channel),y.changed.dispatch())};b(),t.registerDisposer(i.changed.add(b)),r.labelContainer.appendChild(v.element)}let m=t.registerDisposer(new oC(r.visibility,r.display,o,i,c,p,l.length===0?d:void 0));return{control:m,controlElement:m.element}},activateTool:(e,t)=>{e.bindInputEventMap(h$),e.bindAction("adjust-contrast-via-wheel",r=>{r.stopPropagation();let i=gl(r.detail);OR(t.dataType,t.trackable,i)}),e.bindAction("adjust-via-drag",r=>{r.stopPropagation();let i=r.detail.screenX,a=r.detail.screenY,o=t.trackable.value.range,l=o,c=i,d=a;An(r.detail,p=>{let m=t.trackable.value.range,y=p.screenX,v=p.screenY;ii(t.dataType,m,l)||(o=m,i=c,a=d),NR(t.dataType,t.trackable,o,(v-a)*2/screen.height,(y-i)*4/screen.width),l=t.trackable.value.range,c=y,d=v})}),e.bindAction("invert-range",r=>{r.stopPropagation(),aC(t.trackable)})}}}var m$=_e.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function dg(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new hl(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(m$),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustHueViaWheel(r.detail)})}}}function zR(n,e){let{shaderControlState:t}=n,r=t.state.get(e);if(r===void 0)return;let{control:i}=r;switch(i.type){case"slider":return Gi(()=>({value:r.trackable,options:{min:i.min,max:i.max,step:i.step}}));case"color":return dg(()=>r.trackable);case"checkbox":return ns(()=>r.trackable);case"invlerp":{let a=0;for(let[o,{control:{type:l}}]of t.state){if(o===e)break;l==="invlerp"&&++a}return GR(()=>({dataType:i.dataType,defaultChannel:i.default.channel,watchableValue:r.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}}}function HR(n,e,t){return{label:t,toolJson:g$(t,e),makeControl:(r,i,a)=>{let o=n(r);return zR(o,t).makeControl(r,i,a)},activateTool:(r,i)=>{let a=n(r.tool.layer);return zR(a,t).activateTool(r,i)}}}var lo=class extends an{constructor(e,t,r,i={}){super(i.visibility);this.state=e;this.display=t;this.layer=r;this.options=i;this.controlDisposer=void 0;let{toolId:a=$R}=i;this.toolId=a;let{element:o}=this;o.style.display="contents";let{controls:l}=e;this.registerDisposer(l.changed.add(this.registerCancellable((0,pC.default)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){let{element:e}=this;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),Me(e));let t=this.controlDisposer=new $,r=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(let i of this.state.state.keys())e.appendChild(Vc(t,this.layer,this.visibility,HR(r,this.toolId,i)))}disposed(){var e;(e=this.controlDisposer)==null||e.dispose(),super.disposed()}},$R="shaderControl",jR="control";function g$(n,e){return{type:e,[jR]:n}}var JR=class extends ag{constructor(e,t,r,i){super(e,HR(()=>t,r,i));this.layerShaderControls=t;this.control=i;this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable((0,pC.default)(()=>{t.shaderControlState.state.get(i)===void 0&&this.unbind()}))))}activate(e){let{shaderControlState:t}=this.layerShaderControls;t.state.get(this.control)!==void 0&&super.activate(e)}};function os(n,e,t=$R){cl(n,t,(r,i)=>{let a=j(i,jR,ne);return new JR(r,e(r),t,a)})}var fC="opacity",hC="blend",qR="shader",mC="shaderControls",gC="crossSectionRenderScale",YR="channelDimensions",yC="volumeRendering",y$="volumeRenderScale",vC="color",v$=_c(mi),ss=class extends v${constructor(e){super(e);this.opacity=pl(.5);this.blendMode=yM();this.fragmentMain=SM();this.shaderError=sa();this.dataType=new Ae(void 0);this.sliceViewRenderScaleHistogram=new ga;this.sliceViewRenderScaleTarget=Mi(1);this.volumeRenderingRenderScaleHistogram=new ga;this.volumeRenderingRenderScaleTarget=Mi(1);this.channelCoordinateSpace=new Ms;this.channelCoordinateSpaceCombiner=new ic(this.channelCoordinateSpace,zk);this.channelSpace=this.registerDisposer(Un(e=>Qm(()=>qk(e)),this.channelCoordinateSpace));this.volumeRendering=new mt(!1,!1);this.shaderControlState=this.registerDisposer(new Ka(this.fragmentMain,this.registerDisposer(qt((e,t)=>e===void 0?null:{imageData:{dataType:e,channelRank:t.rank}},[this.dataType,this.channelCoordinateSpace],(e,t)=>JSON.stringify(e)===JSON.stringify(t))),this.channelCoordinateSpaceCombiner));this.localCoordinateSpaceCombiner.includeDimensionPredicate=Po,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new QR(this)}),this.tabs.default="rendering"}markLoading(){let e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){let t=super.addCoordinateSpace(e),r=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}activateDataSubsources(e){let t;for(let r of e){if(this.addStaticAnnotations(r))continue;let{subsourceEntry:i}=r,{subsource:a}=i,{volume:o}=a;if(!(o instanceof Ft)){r.deactivate("Not compatible with image layer");continue}if(t&&o.dataType!==t){r.deactivate(`Data type must be ${z[o.dataType].toLowerCase()}`);continue}t=o.dataType,r.activate(l=>{r.addRenderLayer(new Rx(o,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));let c=l.registerDisposer(new Zx({multiscaleSource:o,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));l.registerDisposer(r.messages.addChild(c.messages)),l.registerDisposer(Wn((d,p)=>{!p||d.registerDisposer(this.addRenderLayer(c.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[fC]),de(e,hC,r=>this.blendMode.restoreState(r)),this.fragmentMain.restoreState(e[qR]);let t={};mC in e&&(t=e[mC]),vC in e&&(t[vC]=e[vC]),this.shaderControlState.restoreState(t),this.sliceViewRenderScaleTarget.restoreState(e[gC]),this.channelCoordinateSpace.restoreState(e[YR]),this.volumeRendering.restoreState(e[yC])}toJSON(){let e=super.toJSON();return e[fC]=this.opacity.toJSON(),e[hC]=this.blendMode.toJSON(),e[qR]=this.fragmentMain.toJSON(),e[mC]=this.shaderControlState.toJSON(),e[gC]=this.sliceViewRenderScaleTarget.toJSON(),e[YR]=this.channelCoordinateSpace.toJSON(),e[yC]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){let{value:r}=e;if(r==null)return!1;let i=this.channelSpace.value;if(i.error!==void 0)return!1;let{numChannels:a,coordinates:o,channelCoordinateSpace:{names:l,rank:c}}=i,d=document.createElement("div");d.classList.add("neuroglancer-selection-details-value-grid");let p="[copy] 0fr ";c!==0&&(p+=`repeat(${c}, [dim] 0fr [coord] 0fr) `),p+="[value] 1fr",d.style.gridTemplateColumns=p;for(let m=0;m<a;++m){let y=c===0?r:r[m],v=y==null?"":y.toString(),b=yr({title:"Copy value",onClick:()=>{gr(v)}});d.appendChild(b);for(let C=0;C<c;++C){let L=document.createElement("div");L.classList.add("neuroglancer-selection-details-value-grid-dim"),L.textContent=l[C],d.appendChild(L);let A=document.createElement("div");A.classList.add("neuroglancer-selection-details-value-grid-coord"),A.textContent=o[m*c+C].toString(),d.appendChild(A)}let x=document.createElement("div");x.classList.add("neuroglancer-selection-details-value-grid-value"),x.textContent=v,d.appendChild(x)}return t.appendChild(d),!0}displaySelectionState(e,t,r){let i=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,r)&&(i=!0),i}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),Mx(e,t)},initializeShader:e=>{let t=e.shader;Jr(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}};ss.type="image",ss.typeAbbreviation="img";function KR(n){return new so({shaderError:n.shaderError,fragmentMain:n.fragmentMain,shaderControlState:n.shaderControlState})}var XR=[{label:"Resolution (slice)",toolJson:gC,...Oc(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Blending",toolJson:hC,...sg(n=>n.blendMode)},{label:"Volume rendering (experimental)",toolJson:yC,...ns(n=>n.volumeRendering)},{label:"Resolution (3d)",toolJson:y$,isValid:n=>n.volumeRendering,...Oc(n=>({histogram:n.volumeRenderingRenderScaleHistogram,target:n.volumeRenderingRenderScaleTarget}))},{label:"Opacity",toolJson:fC,...Gi(n=>({value:n.opacity}))}];for(let n of XR)og(ss,n);var QR=class extends an{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(KR(this.layer));let{element:t}=this;t.classList.add("neuroglancer-image-dropdown");for(let a of XR)t.appendChild(Vc(this,e,this.visibility,a));let r=document.createElement("div");r.style.flex="1";let i=document.createElement("div");i.className="neuroglancer-image-dropdown-top-row",i.appendChild(document.createTextNode("Shader")),i.appendChild(r),i.appendChild(rs({title:"Show larger editor view",onClick:()=>{new ZR(this.layer)}})),i.appendChild(ts({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.registerDisposer(new eC(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new lo(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}},ZR=class extends Wi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(KR(this.layer));this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Ui(ss);jm(ot.IMAGE,ss);Xo(n=>{let{volume:e}=n;if(e!==void 0&&e.volumeType===ot.UNKNOWN)return{layerConstructor:ss,priority:-100}});os(ss,n=>({shaderControlState:n.shaderControlState,legendShaderOptions:n.getLegendShaderOptions()}));var a_=rt(Dt());var S$="DisjointUint64Sets",e_="DisjointUint64Sets.add",t_="DisjointUint64Sets.clear",n_="DisjointUint64Sets.highBitRepresentativeChanged",r_="DisjointUint64Sets.deleteSet",ka=class extends $a{constructor(){super(...arguments);this.disjointSets=new il;this.changed=new ae}get value(){return this}static makeWithCounterpart(e,t){let r=new this;return r.disjointSets.highBitRepresentative=t,r.registerDisposer(t.changed.add(()=>{i_(r)})),r.initializeCounterpart(e),t.value&&i_(r),r}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:r}=this;return r&&r.invoke(e_,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(t_,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(r_,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(e!==void 0){let t=[new X,new X];be(e,r=>{be(r,(i,a)=>{t[a%2].parseString(String(i),10),a!==0&&this.link(t[0],t[1])})})}}assignFrom(e){this.clear(),e instanceof ka&&(e=e.disjointSets);for(let[t,r]of e)this.link(t,r)}};ka=xt([Io(S$)],ka);var Nc=new X,SC=new X;Tt(e_,function(n){let e=this.get(n.id);Nc.low=n.al,Nc.high=n.ah,SC.low=n.bl,SC.high=n.bh,e.disjointSets.link(Nc,SC)&&e.changed.dispatch()});Tt(t_,function(n){let e=this.get(n.id);e.disjointSets.clear()&&e.changed.dispatch()});function i_(n){n.rpc.invoke(n_,{id:n.rpcId,value:n.disjointSets.highBitRepresentative.value})}Tt(n_,function(n){let e=this.get(n.id);e.disjointSets.highBitRepresentative.value=n.value});Tt(r_,function(n){let e=this.get(n.id);Nc.low=n.l,Nc.high=n.h,e.disjointSets.deleteSet(Nc)&&e.changed.dispatch()});var bC=class extends Jd{constructor(){super(...arguments);this.spanningTreeEdges=new Map;this.equivalences=new ka;this.connections=new Set;this.changed=new We}link(e,t){this.equivalences.link(e,t);for(let r of this.connections)r.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(let e of this.connections)xC(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r);o===void 0&&(o=new Set,a.set(r,o));let l=a.get(i);l===void 0&&(l=new Set,a.set(i,l)),o.add(i),l.add(r)}removeSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r),l=a.get(i);o.delete(i),o.size===0&&a.delete(r),l.delete(r),l.size===0&&a.delete(i)}*getSpanningTreeNeighbors(e){let t=new X,r=this.spanningTreeEdges.get(e.toString());if(r!==void 0)for(let i of r)t.parseString(i),yield t}restoreState(e){let{equivalences:t,spanningTreeEdges:r}=this;if(t.clear(),r.clear(),e===void 0)return;let i=[new X,new X];be(e,a=>{be(a,(o,l)=>{i[l%2].parseString(String(o),10),l!==0&&t.link(i[0],i[1])&&this.addSpanningTreeEdge(i[0],i[1])})})}toJSON(){let{spanningTreeEdges:e}=this;if(e.size===0)return;let t=new Array;for(let[r,i]of e){let a=X.parseString(r);for(let o of i){let l=X.parseString(o);X.compare(a,l)>0||t.push([a,l])}}return t.sort((r,i)=>X.compare(r[0],i[0])||X.compare(r[1],i[1])),t.map(r=>r.map(i=>i.toString()))}get highBitRepresentative(){return!1}async merge(e,t){let{equivalences:r}=this;return X.equal(r.get(e),r.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),r.get(e))}async split(e,t){let r=this.computeSplit(e,t);if(r===void 0)throw new Error("Segments are already split");let{includeBaseSegments:i,includeRepresentative:a,excludeBaseSegments:o,excludeRepresentative:l}=r,{equivalences:c}=this;this.deleteSet(e),this.linkAll(i),this.linkAll(o);let d=(y,v)=>{for(let b of y)for(let x of this.getSpanningTreeNeighbors(b))X.equal(c.get(x),v)||this.removeSpanningTreeEdge(b,x)},p=c.get(e),m=c.get(t);d(i,p),d(o,m);for(let y of this.connections){let{visibleSegments:v}=y.segmentsState;v.has(l)&&(v.delete(l),v.add(a))}return this.normalizeAll(),this.changed.dispatch(),{include:p,exclude:m}}trackSegment(e,t){return()=>{}}computeSplit(e,t){let{equivalences:r}=this,i=r.get(e);if(!X.equal(i,r.get(t)))return;let a=new il;for(let m of r.setElements(i))if(!X.equal(m,t))for(let y of this.getSpanningTreeNeighbors(m))X.equal(y,t)||a.link(m,y);let o=[],l=[],c=a.get(e),d=e,p=t;for(let m of r.setElements(i))X.equal(a.get(m),c)?(o.push(m),X.compare(m,d)<0&&(d=m)):(l.push(m),X.compare(m,p)<0&&(p=m));return o.sort(X.compare),l.sort(X.compare),{includeBaseSegments:o,includeRepresentative:d,excludeBaseSegments:l,excludeRepresentative:p}}connect(e){let t=new o_(this,e);return e.segmentEquivalences.assignFrom(this.equivalences),xC(e.visibleSegments,e.segmentEquivalences.disjointSets),t.registerDisposer(e.visibleSegments.changed.add(t.registerCancellable((0,a_.default)(()=>xC(e.visibleSegments,e.segmentEquivalences.disjointSets),0)))),this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}};function xC(n,e){let t=[];for(let r of n){let i=e.get(r);X.equal(r,i)||(t.push(i),n.delete(r))}for(let r of t)n.add(r)}var o_=class extends qd{computeSplit(e,t){return this.graph.computeSplit(e,t)}};var CC=class{constructor(e){this.disjointSets=e;this.generation=Number.NaN;this.hashMap=new mc}update(){let{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;let{hashMap:r}=this;r.clear();for(let[i,a]of e.mappings())r.set(i,a)}}},pg=class extends cp{constructor(e,t){super(e,{shaderParameters:new _u(r=>({hasEquivalences:r.registerDisposer(qt(i=>i.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:r.registerDisposer(qt(i=>i.size!==0,[t.segmentStatedColors])),hasSegmentDefaultColor:r.registerDisposer(qt(i=>i!==void 0,[t.segmentDefaultColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition});this.displayState=t;this.segmentationGroupState=this.displayState.segmentationGroupState.value;this.segmentColorShaderManager=new LS("segmentColorHash");this.segmentStatedColorShaderManager=new ES("segmentStatedColor");this.hashTableManager=new _h("visibleSegments");this.gpuHashTable=this.registerDisposer(qs.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable));this.gpuTemporaryHashTable=qs.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable);this.equivalencesShaderManager=new Ld("equivalences");this.equivalencesHashMap=new CC(this.segmentationGroupState.segmentEquivalences.disjointSets);this.temporaryEquivalencesHashMap=new CC(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets);this.gpuEquivalencesHashTable=this.registerDisposer(qs.get(this.gl,this.equivalencesHashMap.hashMap));this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(qs.get(this.gl,this.temporaryEquivalencesHashMap.hashMap));this.registerDisposer(this.shaderParameters),$S(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)==null||e.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let r=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;r+=`return x;
}
`,e.addFragmentCode(r),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uShowAllSegments"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let i=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(i+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),i+=`
  bool has = uShowAllSegments != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if (uSelectedSegment == value.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let a=`vec3 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),a+=`
  vec3 rgb;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgb)) {
    return rgb;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec3","uSegmentDefaultColor"),a+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),a+=`  return segmentColorHash(value);
`),a+=`
}
`,e.addFragmentCode(a),i+=`
  vec3 rgb = getMappedIdColor(valueForColor);
  emit(vec4(mix(vec3(1.0,1.0,1.0), rgb, saturation), alpha));
`,e.setFragmentMain(i)}initializeShader(e,t,r){let{gl:i}=this,{displayState:a,segmentationGroupState:o}=this,{segmentSelectionState:l}=this.displayState,{segmentDefaultColor:{value:c},segmentColorHash:{value:d}}=this.displayState,p=pS(o),m=this.displayState.ignoreNullVisibleSet.value,y=0,v=0;if(l.hasSelectedSegment){let b=l.selectedSegment;y=b.low,v=b.high}if(i.uniform1f(t.uniform("uSelectedAlpha"),a.selectedAlpha.value),i.uniform1f(t.uniform("uSaturation"),a.saturation.value),i.uniform1f(t.uniform("uNotSelectedAlpha"),a.notSelectedAlpha.value),i.uniform2ui(t.uniform("uSelectedSegment"),y,v),i.uniform1ui(t.uniform("uShowAllSegments"),p.hashTable.size||!m?0:1),this.hashTableManager.enable(i,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),r.hasEquivalences){let b=o.useTemporarySegmentEquivalences.value;(b?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(i,t,b?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}if(c===void 0?this.segmentColorShaderManager.enable(i,t,d):i.uniform3fv(t.uniform("uSegmentDefaultColor"),c),r.hasSegmentStatedColors){let b=this.displayState.segmentStatedColors.value,{gpuSegmentStatedColorHashTable:x}=this;(x===void 0||x.hashTable!==b.hashTable)&&(x==null||x.dispose(),this.gpuSegmentStatedColorHashTable=x=qs.get(i,b.hashTable)),this.segmentStatedColorShaderManager.enable(i,t,x)}}endSlice(e,t,r){let{gl:i}=this;this.hashTableManager.disable(i,t),r.hasEquivalences&&this.equivalencesShaderManager.disable(i,t),r.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(i,t),super.endSlice(e,t,r)}};var mg=rt(Dt()),u_=rt(Kd());var fg="mergeSegments",hg="splitSegments",b$=_e.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),x$=_e.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),s_=class extends ao{constructor(e){super(e);this.lastAnchorBaseSegment=new Ae(void 0);let t=()=>{let r=e.anchorSegment.value;if(r===void 0)return;let{segmentSelectionState:i}=e.displayState;if(!i.hasSelectedSegment)return;let{segmentEquivalences:a}=e.displayState.segmentationGroupState.value,o=a.get(r);if(!X.equal(i.selectedSegment,o))return;let l=i.baseSelectedSegment;a.disjointSets.highBitRepresentative.value&&!Lc(l)||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return fg}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let d=this.layer.anchorSegment.value,p=this.lastAnchorBaseSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};let m=t.segmentEquivalences.get(d);return t.visibleSegments.has(m)?p===void 0||!X.equal(t.segmentEquivalences.get(p),m)?{anchorSegment:d,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:p,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},i=()=>{let{anchorSegment:d,error:p}=r();if(d===void 0||p!==void 0)return{anchorSegment:d,error:p,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:m}=this.layer,y=m.segmentSelectionState.baseValue;return y===void 0||X.equal(m.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))?{anchorSegment:d,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:d,otherSegment:y,error:void 0,anchorSegmentValid:!0}},{body:a,header:o}=ap(e);o.textContent="Merge segments",a.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(b$),e.registerDisposer(()=>{Pd(t)});let l=()=>{Me(a);let{displayState:d}=this.layer,{anchorSegment:p,otherSegment:m,anchorSegmentValid:y,error:v}=i(),b=C=>{let L=Id(this.layer.displayState,C);return L.classList.add("neuroglancer-segment-list-entry-double-line"),L};if(p!==void 0&&a.appendChild(b(Go(d,p))),v!==void 0){let C=document.createElement("span");C.textContent=v,a.appendChild(C)}if(m!==void 0){let C=document.createElement("span");C.textContent=" merge ",a.appendChild(C),a.appendChild(b(Go(d,m)))}let{segmentEquivalences:x}=t;if(y){t.useTemporaryVisibleSegments.value=!0;let C=t.temporaryVisibleSegments;C.clear(),C.add(x.get(p)),m!==void 0&&C.add(x.get(m))}else{Pd(t);return}};l(),e.registerDisposer(zo(this.layer.displayState,a));let c=e.registerCancellable(Be(l));Ho(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(c)),e.bindAction("merge-segments",d=>{d.stopPropagation(),(async()=>{let{graph:{value:p}}=t;if(p===void 0)return;let{anchorSegment:m,otherSegment:y,error:v}=i();if(!(m===void 0||y===void 0||v!==void 0))try{await p.merge(m,y),Ee.showTemporaryMessage("Merge performed")}catch(b){Ee.showTemporaryMessage(`Merge failed: ${b}`)}})()}),e.bindAction("set-anchor",d=>{d.stopPropagation();let{segmentSelectionState:p}=this.layer.displayState,m=p.baseValue;if(m===void 0)return;let y=this.layer.anchorSegment.value;if(t.visibleSegments.add(m),y===void 0||!X.equal(y,m)){this.layer.anchorSegment.value=m.clone();return}})}get description(){return"merge"}},l_=class extends ao{toJSON(){return hg}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let d=this.layer.anchorSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};let p=t.segmentEquivalences.get(d);return t.visibleSegments.has(p)?{anchorSegment:d,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},{body:i,header:a}=ap(e);a.textContent="Split segments",i.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(x$);let o=()=>{let{anchorSegment:d,error:p}=r();if(d===void 0||p!==void 0)return{anchorSegment:d,error:p,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:m}=this.layer,y=m.segmentSelectionState.baseValue;return y===void 0||!X.equal(m.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))||X.equal(y,d)?{anchorSegment:d,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:d,otherSegment:y,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{Pd(t)});let l=()=>{Me(i);let{displayState:d}=this.layer,{anchorSegment:p,otherSegment:m,anchorSegmentValid:y,error:v}=o(),b,x;(()=>{let{segmentEquivalences:A}=t,{graphConnection:D}=this.layer;if(!y||D===void 0){Pd(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,m!==void 0){let P=D.computeSplit(p,m);if(P!==void 0){b=new Vi(p,P.includeRepresentative),x=new Vi(m,P.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;let E=P.includeRepresentative,V=P.excludeRepresentative,O=t.temporarySegmentEquivalences;O.clear();for(let W of P.includeBaseSegments)O.link(W,E);for(let W of P.excludeBaseSegments)O.link(W,V);let B=t.temporaryVisibleSegments;B.clear(),B.add(E),B.add(V);return}}t.useTemporarySegmentEquivalences.value=!1;let R=t.temporaryVisibleSegments;R.clear(),R.add(A.get(p))}})();let L=A=>{let D=Id(this.layer.displayState,A);return D.classList.add("neuroglancer-segment-list-entry-double-line"),D};if(p!==void 0&&i.appendChild(L(b!=null?b:Go(d,p))),v!==void 0){let A=document.createElement("span");A.textContent=v,i.appendChild(A)}if(x!==void 0){let A=document.createElement("span");A.textContent=" split ",i.appendChild(A),i.appendChild(L(x))}};e.registerDisposer(zo(this.layer.displayState,i)),l();let c=e.registerCancellable(Be(l));Ho(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.bindAction("split-segments",d=>{d.stopPropagation(),(async()=>{let{graph:{value:p}}=t;if(p===void 0)return;let{anchorSegment:m,otherSegment:y,error:v}=o();if(!(m===void 0||y===void 0||v!==void 0))try{await p.split(m,y),Ee.showTemporaryMessage("Split performed")}catch(b){Ee.showTemporaryMessage(`Split failed: ${b}`)}})()}),e.bindAction("set-anchor",d=>{d.stopPropagation();let{segmentSelectionState:p}=this.layer.displayState,m=p.baseValue;if(m===void 0)return;t.visibleSegments.add(m);let y=this.layer.anchorSegment.value;if(y===void 0||!X.equal(y,m)){this.layer.anchorSegment.value=m.clone();return}})}get description(){return"split"}};function c_(){cl(On,fg,n=>new s_(n)),cl(On,hg,n=>new l_(n))}var C$=new X,d_=class extends ${constructor(e,t,r,i){super();this.query=e;this.segmentPropertyMap=t;this.segmentationDisplayState=r;this.parentElement=i;this.changed=new We;this.explicitSegmentsVisible=!1;this.visibleSegmentsGeneration=-1;this.queryResult=new Ae(void 0);this.statusText=new Ae("");this.selectedMatches=0;this.matchStatusTextPrefix="";this.debouncedUpdate=(0,mg.default)(()=>this.update(),0);this.render=e=>{let{explicitSegments:t}=this,r,i=!1;if(t!==void 0&&e<t.length)r=t[e],i=this.explicitSegmentsVisible;else{t!==void 0&&(e-=t.length),r=C$;let o=this.queryResult.value.indices[e],{ids:l}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;r.low=l[o*2],r.high=l[o*2+1]}let a=this.segmentWidgetFactory.get(r);return i&&(a.dataset.visibleList="true"),a};this.update(),this.registerDisposer(r.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)==null?void 0:e.count)!=null?t:0}update(){var b;let e=this.query.value,{segmentPropertyMap:t}=this,r=this.queryResult.value,i;if(this.prevQuery===e)i=r;else{let x=HP(t,e);i=$P(t,x)}let a=[],o=!1,l="",{visibleSegments:c}=this.segmentationDisplayState.segmentationGroupState.value,d=c.changed.count,p=this.visibleSegmentsGeneration,m=KP(i.query);if(m){if(p!==d||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=d;let x=Array.from(c,L=>L.clone());x.sort(X.compare);let{explicitSegments:C}=this;C===void 0?(this.explicitSegments=x,a.push({retainCount:0,insertCount:x.length,deleteCount:0})):a.push(...BT(C,x,X.compare)),this.explicitSegments=x,o=!0}else a.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=d,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(a.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0),this.explicitSegmentsVisible=!1;let{explicitIds:y}=i;if(y!==void 0?this.explicitSegments=y:this.explicitSegmentsVisible||(this.explicitSegments=void 0),r!==i&&(a.push({retainCount:0,deleteCount:(b=r==null?void 0:r.count)!=null?b:0,insertCount:i.count}),o=!0,this.queryResult.value=i),i.explicitIds!==void 0?l=`${i.count} ids`:m?l=`${i.count} listed ids`:i.total>0&&(l=`${i.count}/${i.total} matches`),r!==i||d!==p){let x=l,C=0;t!==void 0&&i.count>0&&(C=YP(t,i,c),x+=` (${C} visible)`),this.selectedMatches=C,this.statusText.value=x}this.prevQuery=e,this.matchStatusTextPrefix=l;let{explicitSegments:v}=this;this.length=(this.explicitSegmentsVisible?v.length:0)+i.count,o&&this.changed.dispatch(a)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}},p_=_e.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),w$=100;function f_(n){gn(n,Math.max(1,n.value.length+.1))}function wC(n,e){let t;if(Number.isInteger(e))t=e.toString();else{let r=e.toString(),i=e.toPrecision(6);t=r.length<i.length?r:i}n.value=t,f_(n)}function T$(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${n}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(n==="range"?"range":"for distribution"),t.addEventListener("input",()=>{f_(t)}),t}function L$(n,e,t){if(n===void 0||n.indices===void 0)return;let r=n.query,{sortBy:i,includeColumns:a}=r;vm(r,t)?(i=i.filter(l=>l.fieldId!==t),a=a.filter(l=>l!==t)):a.push(t),e({...r,sortBy:i,includeColumns:a})}function h_(n,e,t){var d;let r=n==null?void 0:n.query,i=r==null?void 0:r.sortBy;if(i===void 0)return;let{includeColumns:a}=r,l=((d=i.find(p=>p.fieldId===t))==null?void 0:d.order)==="<"?">":"<",c=a.filter(p=>p!==t);for(let p of i)p.fieldId!=="id"&&p.fieldId!=="label"&&p.fieldId!==t&&c.push(p.fieldId);e({...r,sortBy:[{fieldId:t,order:l}],includeColumns:c})}function m_(n,e,t){var a,o;let r=(a=n==null?void 0:n.query)==null?void 0:a.sortBy,i=(o=r==null?void 0:r.find(l=>l.fieldId===t))==null?void 0:o.order;e.textContent=i===">"?"\u25BC":"\u25B2",e.style.visibility=i===void 0?"":"visible",e.title=`Sort by ${t} in ${i==="<"?"descending":"ascending"} order`}var g_=class extends ${constructor(e,t,r){super();this.segmentPropertyMap=e;this.queryResult=t;this.setQuery=r;this.propertyHistograms=[];this.bounds={window:new Ae([]),range:new Ae([])};this.throttledUpdate=this.registerCancellable((0,u_.default)(()=>this.updateHistograms(),100));this.debouncedRender=this.registerCancellable(Be(()=>this.updateHistogramRenderings()));this.debouncedSetQuery=this.registerCancellable((0,mg.default)(()=>this.setQueryFromBounds(),200));let i=e==null?void 0:e.numericalProperties,a=[],o;if(i!==void 0&&i.length>0){o=document.createElement("details");let l=document.createElement("summary");l.textContent=`${i.length} numerical propert${i.length>1?"ies":"y"}`,o.appendChild(l),o.classList.add("neuroglancer-segment-query-result-numerical-list");let c=this.bounds.window.value;for(let d=0,p=i.length;d<p;++d){let m=i[d],y=this.makeNumericalPropertySummary(d,m);a.push(y),o.appendChild(y.element),c[d]=m.bounds}}this.listElement=o,this.properties=a,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){let e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;let t=e.query,r=[],i=this.bounds.range.value,{properties:a}=this;for(let o=0,l=a.length;o<l;++o){let c=a[o].property;r.push({fieldId:c.id,bounds:i[o]})}this.setQuery({...t,numericalConstraints:r})}getBounds(e){let{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){let{property:r}=this.properties[e],i=Ds(r.bounds,t.range);cr(i[0],i[1])>0&&(i=[i[1],i[0]]);let a=Ds(r.bounds,t.window),o=this.getBounds(e),{dataType:l}=this.properties[e].property;ii(l,a,o.window)||(this.bounds.window.value[e]=a,this.bounds.window.changed.dispatch()),ii(l,i,o.range)||(this.bounds.range.value[e]=i,this.bounds.range.changed.dispatch())}setBound(e,t,r,i){let o=this.segmentPropertyMap.numericalProperties[r].bounds;i=Es(o,i);let l=this.getBounds(r),c=hp(l,e,t,i,!0);this.setBounds(r,c)}handleNewQueryResult(){let e=this.queryResult.value,{listElement:t}=this;if(t!==void 0){if((e==null?void 0:e.indices)!==void 0){let{numericalConstraints:r}=e.query,{numericalProperties:i}=this.segmentPropertyMap,a=this.bounds.range.value,o=r.length,l=i.length;a.length=l;for(let c=0;c<l;++c)a[c]=i[c].bounds;for(let c=0;c<o;++c){let d=r[c],p=i.findIndex(m=>m.id===d.fieldId);a[p]=d.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){let e=this.queryResult.value,{listElement:t}=this;t!==void 0&&(jP(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();let{listElement:e}=this;if(e===void 0)return;let{propertyHistograms:t}=this;if(t.length===0){e.style.display="none";return}e.style.display="";let{properties:r}=this;for(let i=0,a=r.length;i<a;++i)this.updateNumericalPropertySummary(i,r[i],t[i])}makeNumericalPropertySummary(e,t){let r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-numerical-plot-container");let i=document.createElement("img");i.classList.add("neuroglancer-segment-query-result-numerical-plot");let a=new cg(i,t.dataType,()=>this.getBounds(e),p=>this.setBounds(e,p)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");let l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{L$(this.queryResult.value,this.setQuery,t.id)});let c=p=>{let m=document.createElement("div");m.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),m.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${p}`);let y=x=>{let C=T$(p,x);return C.addEventListener("change",()=>{if(this.bounds[p].value[e]!==void 0){try{let A=Ua(t.dataType,C.value);this.setBound(p,x,e,A),this.bounds[p].changed.dispatch()}catch{}wC(C,this.bounds[p].value[e][x])}}),C},v=[y(0),y(1)],b;if(p==="range"){b=[document.createElement("div"),document.createElement("div"),document.createElement("div")],b[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),b[1].appendChild(l);let x=document.createElement("span");x.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),x.appendChild(document.createTextNode(t.id)),x.appendChild(o),x.addEventListener("click",()=>{h_(this.queryResult.value,this.setQuery,t.id)}),b[1].appendChild(x);let{description:C}=t;C&&(b[1].title=C),m.appendChild(b[0]),m.appendChild(v[0]);let L=document.createElement("div");L.textContent="\u2264",L.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(L),m.appendChild(b[1]);let A=document.createElement("div");A.textContent="\u2264",A.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(A),m.appendChild(v[1]),m.appendChild(b[2])}else m.appendChild(v[0]),m.appendChild(v[1]);return{container:m,spacers:b,inputs:v}},d={range:c("range"),window:c("window")};return r.appendChild(d.range.container),r.appendChild(i),r.appendChild(d.window.container),{property:t,controller:a,element:r,plotImg:i,boundElements:d,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:o}}updateNumericalPropertySummary(e,t,r){let i=t.bounds.window,a=this.bounds.window.value[e],o=t.bounds.range,l=this.bounds.range.value[e],{property:c}=t,d=this.queryResult.value,p=vm(d==null?void 0:d.query,c.id);if(t.columnCheckbox.checked=p,t.columnCheckbox.title=p?"Remove column from result table":"Add column to result table",m_(d,t.sortIcon,c.id),t.propertyHistogram===r&&ii(c.dataType,i,a)&&ii(c.dataType,o,l))return;let{histogram:m}=r,y="http://www.w3.org/2000/svg",v=document.createElementNS(y,"svg");v.setAttribute("width","1"),v.setAttribute("height","1"),v.setAttribute("preserveAspectRatio","none");let b=document.createElementNS(y,"rect"),x=kr(a,l[0]),C=kr(a,l[1]);b.setAttribute("x",`${x}`),b.setAttribute("y","0"),b.setAttribute("width",`${C-x}`),b.setAttribute("height","1"),b.setAttribute("fill","#4f4f4f"),v.appendChild(b);let L=m.length,A=(B,W,_)=>{let F=document.createElementNS(y,"polyline"),N="",J=0;for(let fe=B;fe<_;++fe)J+=m[fe];if(J===0)return;let re=kr(a,r.window[0]),pe=kr(a,r.window[1]),ye=(fe,Le)=>{let Ge=fe/(L-2);N+=` ${re*(1-Ge)+pe*Ge},${1-Le}`};B!==0&&ye(B,0);let ce=0;for(let fe=B;fe<W;++fe)ce+=m[fe],ye(fe,ce/J);return F.setAttribute("fill","none"),F.setAttribute("stroke-width","1px"),F.setAttribute("points",N),F.setAttribute("vector-effect","non-scaling-stroke"),F};{let B=A(0,L-1,L);B!==void 0&&(B.setAttribute("stroke","cyan"),v.appendChild(B))}if(!ii(c.dataType,c.bounds,l)){let B=Math.floor(Math.max(0,Math.min(1,kr(r.window,l[0])))*(L-2)),W=Math.ceil(Math.max(0,Math.min(1,kr(r.window,l[1])))*(L-2)),_=A(B,W,W);_!==void 0&&(_.setAttribute("stroke","white"),v.appendChild(_))}let D=new XMLSerializer().serializeToString(v);t.plotImg.src=`data:image/svg+xml;base64,${btoa(D)}`,t.propertyHistogram=r;for(let B=0;B<2;++B)i[B]=a[B],wC(t.boundElements.window.inputs[B],a[B]),o[B]=l[B],wC(t.boundElements.range.inputs[B],l[B]);let R=t.boundElements.range.spacers,P=Ds(a,l),E=Ql(c.dataType,a),V=kr(a,P[0])*E,O=kr(a,P[1])*E+(1-E);R[0].style.width=`${V*100}%`,R[2].style.width=`${(1-O)*100}%`}};function k$(n,e){let{tags:t}=n;if(t===void 0||t.length===0)return;let r=n.query,i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-tag-list");for(let{tag:a,count:o}of t){let l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");let c=document.createElement("span");c.classList.add("neuroglancer-segment-query-result-tag-name"),c.textContent=a,i.appendChild(l);let d=r.includeTags.includes(a),p=r.excludeTags.includes(a),m;d?m="Remove tag from required set":p?m="Remove tag from excluded set":m="Add tag to required set",c.addEventListener("click",()=>{e(Sb(r,a,!0,!d&&!p))}),c.title=m;let y=d||p,v=x=>{let C=x?o:n.count-o,L=document.createElement("div");if(L.classList.add("neuroglancer-segment-query-result-tag-toggle"),L.classList.add(`neuroglancer-segment-query-result-tag-${x?"include":"exclude"}`),l.appendChild(L),!y&&C===0)return;let A=x?d:p;L.appendChild(new qn({get value(){return A},set value(D){e(Sb(r,a,x,D))},changed:ff},{text:x?"+":"-",enableTitle:`Add tag to ${x?"required":"exclusion"} set`,disableTitle:`Remove tag from ${x?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};v(!0),v(!1),l.appendChild(c);let b=document.createElement("span");b.classList.add("neuroglancer-segment-query-result-tag-count"),y||(b.textContent=o.toString()),l.appendChild(b)}return i}var TC=class extends an{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Mn(e.displayState.segmentationGroupState.value.graph,(l,c,d)=>{if(l===void 0)return;let p=document.createElement("div");p.className="neuroglancer-segmentation-toolbox",p.appendChild(mx(d,e,{toolJson:fg,label:"Merge",title:"Merge segments"})),p.appendChild(mx(d,e,{toolJson:hg,label:"Split",title:"Split segments"})),c.appendChild(p)})).element);let r=document.createElement("input");r.classList.add("neuroglancer-segment-list-query"),r.addEventListener("focus",()=>{r.select()});let i=this.registerDisposer(new Gt(r,p_));i.allShortcutsAreGlobal=!0;let{segmentQuery:a}=this.layer.displayState,o=this.registerCancellable((0,mg.default)(()=>{a.value=r.value},200));r.autocomplete="off",r.title=p_.describe(),r.spellcheck=!1,r.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(Fr(l=>{r.value=l},a)),this.registerDisposer(Fr(l=>{Date.now()-l<100&&(setTimeout(()=>{r.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(r),t.appendChild(this.registerDisposer(new Mn(e.displayState.segmentPropertyMap,(l,c,d)=>{let p=ce=>{r.focus(),r.select();let fe=qP(l,ce);document.execCommand("insertText",!1,fe),a.value=fe,r.select()},m=d.registerDisposer(new d_(a,l,e.displayState,c)),y=e.displayState.segmentationGroupState.value,v=document.createElement("ul");v.classList.add("neuroglancer-segment-query-errors"),c.appendChild(v);let b=document.createElement("div");b.classList.add("neuroglancer-segment-query-result-statistics");let x=document.createElement("span"),C=document.createElement("input");C.type="checkbox",C.checked=!0,C.title="Deselect all segment IDs",C.addEventListener("change",()=>{y.visibleSegments.clear()});let L=yr({title:"Copy visible segment IDs",onClick:()=>{let ce=Array.from(y.visibleSegments,fe=>fe.clone());ce.sort(X.compare),gr(ce.join(", "))}}),A=document.createElement("span");x.appendChild(L),x.appendChild(C),x.appendChild(A);let D=document.createElement("span"),R=document.createElement("input"),P=yr({onClick:()=>{o(),o.flush(),m.debouncedUpdate.flush();let ce=m.queryResult.value;if(ce===void 0)return;let fe=new Array(ce.count);Hd(l,ce,(Le,Ge)=>{fe[Ge]=Le.toString()}),gr(fe.join(", "))}});R.type="checkbox";let E=()=>{o(),o.flush(),m.debouncedUpdate.flush();let ce=m.queryResult.value;if(ce===void 0)return;let{visibleSegments:fe}=y,{selectedMatches:Le}=m,Ge=Le!==ce.count;if(Ge&&ce.count-Le>w$){if(!_)return _=!0,V.textContent=`Confirm: show ${ce.count-Le} segments?`,!1;_=!1,W()}return Hd(l,ce,ze=>{fe.set(ze,Ge)}),!0};R.addEventListener("click",ce=>{E()||ce.preventDefault()});let V=document.createElement("span");D.appendChild(P),D.appendChild(R),D.appendChild(V),x.classList.add("neuroglancer-segment-list-status"),D.classList.add("neuroglancer-segment-list-status"),c.appendChild(b);let O=document.createElement("div");O.classList.add("neuroglancer-segment-query-result-statistics-separator"),c.appendChild(O),c.appendChild(D),c.appendChild(x);let B=-1,W=()=>{let ce=y.visibleSegments.size;B!==ce&&(B=ce,A.textContent=`${ce} visible in total`,C.checked=ce>0,C.style.visibility=ce?"visible":"hidden",L.style.visibility=ce?"visible":"hidden"),V.textContent=m.statusText.value;let{numMatches:fe,selectedMatches:Le}=m;P.style.visibility=fe?"visible":"hidden",P.title=`Copy ${fe} segment ID(s)`,R.style.visibility=fe?"visible":"hidden",Le===0?(R.checked=!1,R.indeterminate=!1,R.title=`Show ${fe} segment ID(s)`):Le===fe?(R.checked=!0,R.indeterminate=!1,R.title=`Hide ${Le} segment ID(s)`):(R.checked=!0,R.indeterminate=!0,R.title=`Show ${fe-Le} segment ID(s)`)};W(),m.statusText.changed.add(W),d.registerDisposer(y.visibleSegments.changed.add(W));let _=!1;d.registerEventListener(r,"input",()=>{o(),_&&(_=!1,W())}),d.registerDisposer(le(r,"cancel",()=>{r.focus(),r.select(),document.execCommand("delete"),r.blur(),r.value="",a.value="",_=!1,W()})),d.registerDisposer(le(r,"toggle-listed",E)),d.registerDisposer(le(r,"hide-all",()=>{y.visibleSegments.clear()})),d.registerDisposer(le(r,"hide-listed",()=>{o(),o.flush(),m.debouncedUpdate.flush();let{visibleSegments:ce}=y;if(a.value==="")ce.clear();else{let fe=m.queryResult.value;if(fe===void 0)return;Hd(l,fe,Le=>{ce.delete(Le)})}}));let F=d.registerDisposer(new ll({source:m,horizontalScroll:!0})),N=d.registerCancellable(Be(()=>{m.updateRenderedItems(F)})),{displayState:J}=this.layer;d.registerDisposer(J.segmentSelectionState.changed.add(N)),d.registerDisposer(y.visibleSegments.changed.add(N)),d.registerDisposer(J.segmentColorHash.changed.add(N)),d.registerDisposer(J.segmentStatedColors.changed.add(N)),d.registerDisposer(J.segmentDefaultColor.changed.add(N)),F.element.classList.add("neuroglancer-segment-list"),d.registerDisposer(e.bindSegmentListWidth(F.element)),d.registerDisposer(new yn(F.element,yc()));let re=d.registerDisposer(new g_(l,m.queryResult,p));{let{listElement:ce}=re;ce!==void 0&&b.appendChild(ce)}let pe,ye=ce=>{let fe=ce==null?void 0:ce.errors;if(Me(v),fe!==void 0)for(let Le of fe){let Ge=document.createElement("li");Ge.textContent=Le.message,v.appendChild(Ge)}};Fr(ce=>{if(m.segmentWidgetFactory=new HS(m.segmentationDisplayState,m.parentElement,Le=>vm(ce==null?void 0:ce.query,Le.id)),F.scrollToTop(),Me(F.header),l!==void 0){let Le=m.segmentWidgetFactory.getHeader();Le.container.classList.add("neuroglancer-segment-list-header");for(let Ge of Le.propertyLabels){let{label:ze,sortIcon:tt,id:ge}=Ge;ze.addEventListener("click",()=>{h_(m.queryResult.value,p,ge)}),m_(ce,tt,ge)}F.header.appendChild(Le.container)}if(ye(ce),O.style.display="none",pe==null||pe.remove(),ce===void 0)return;let{query:fe}=ce;fe.errors!==void 0||fe.ids!==void 0||(pe=k$(ce,p),pe!==void 0&&b.appendChild(pe),(re.properties.length>0||pe!==void 0)&&(O.style.display=""))},m.queryResult),c.appendChild(F.element)})).element)}};var y_=rt(Dt());var gg=class extends ${constructor(e){super();this.group=e;this.element=document.createElement("div");this.topRow=document.createElement("div");this.label=document.createElement("label");this.selectElement=document.createElement("select");this.linkedLayers=document.createElement("div");this.unlinkButton=document.createElement("button");let{element:t,label:r,topRow:i,selectElement:a,linkedLayers:o,unlinkButton:l}=this;i.appendChild(r),i.appendChild(a),i.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(i),t.appendChild(o),this.updateView();let c=(0,y_.default)(()=>this.updateView(),0);this.registerEventListener(a,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){let e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var l;let{selectElement:e,group:t}=this,{predicate:r}=t;Me(e);let i=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=i?"":"none";let{linkedLayers:a}=this,o=t.linkedLayers.size!==0;if(a.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",e.style.display="none",Me(a);for(let c of t.linkedLayers){let d=document.createElement("div");d.classList.add("neuroglancer-linked-layer-widget-layer");let p=Fh({title:"Unlink layer",onClick:()=>{this.group.getGroup(c).isolate()}});d.appendChild(p),d.appendChild(document.createTextNode(c.managedLayer.name)),a.appendChild(d)}}else{e.style.display="";let c=document.createElement("option");e.appendChild(c);let d=0;for(let p of this.group.layerManager.managedLayers){let m=p.layer;if(m!==null&&m!==t.layer&&r(m)){++d;let y=document.createElement("option"),{name:v}=p;y.textContent=v,y.value=v,e.appendChild(y)}}e.value=(l=t.toJSON())!=null?l:"",this.element.style.display=d===0?"none":""}}};function v_(n){return new so({fragmentMain:n.displayState.skeletonRenderingOptions.shader,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState})}var LC=class extends an{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{let i=this.registerDisposer(new gg(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{let i=this.registerDisposer(new gg(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(let i of EC)t.appendChild(Vc(this,e,this.visibility,i));let r=this.registerDisposer(new Mn(e.hasSkeletonsLayer,(i,a,o)=>{if(!i)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(rs({title:"Show larger editor view",onClick:()=>{new S_(this.layer)}})),l.appendChild(ts({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),a.appendChild(l);let d=o.registerDisposer(v_(this.layer));a.appendChild(d.element),a.appendChild(o.registerDisposer(new lo(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:kC})).element),d.textEditor.refresh()},this.visibility));t.appendChild(r.element)}},S_=class extends Wi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(v_(this.layer));this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};var yl=class extends $a{constructor(){super(...arguments);this.hashTable=new mc;this.changed=new We}get value(){return this}static makeWithCounterpart(e){let t=new yl;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:r}=this;r&&r.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[Symbol.iterator](){return this.hashTable.entries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){this.clear();for(let[t,r]of e)this.set(t,r)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,r]of this.hashTable.entries())e[t.toString()]=r.toString();return e}};yl=xt([Io("Uint64Map")],yl);Tt("Uint64Map.set",function(n){let e=this.get(n.id);e.set_(n.key,n.value)&&e.changed.dispatch()});Tt("Uint64Map.delete",function(n){let e=this.get(n.id);e.delete_(n.key)&&e.changed.dispatch()});Tt("Uint64Map.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var ls=class extends $a{constructor(){super(...arguments);this.hashTable=new Mh;this.changed=new We}get value(){return this}static makeWithCounterpart(e){let t=new ls;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}add_(e){return this.hashTable.add(e)}add(e){if(this.add_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.add",{id:this.rpcId,value:e}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.delete",{id:this.rpcId,value:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=new Array;for(let t of this)e.push(t.toString());return e.sort(),e}assignFrom(e){this.clear();for(let t of e)this.add(t)}};ls=xt([Io("Uint64Set")],ls);Tt("Uint64Set.add",function(n){let e=this.get(n.id);e.add_(n.value)&&e.changed.dispatch()});Tt("Uint64Set.delete",function(n){let e=this.get(n.id);e.delete_(n.value)&&e.changed.dispatch()});Tt("Uint64Set.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var b_='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="rotateIconTitle"><path d="M22 12l-3 3-3-3"></path><path d="M2 12l3-3 3 3"></path><path d="M19.016 14v-1.95A7.05 7.05 0 0 0 8 6.22"></path><path d="M16.016 17.845A7.05 7.05 0 0 1 5 12.015V10"></path><path stroke-linecap="round" d="M5 10V9"></path><path stroke-linecap="round" d="M19 15v-1"></path></svg>';var yp=class extends ${constructor(e){super();this.model=e;this.element=document.createElement("input");this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:t}=this;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){Ye(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!=null?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}};function yg(n,e){e?n.displayState.segmentDefaultColor.value=K.fromValues(1,0,0):n.displayState.segmentDefaultColor.value=void 0}function x_(){let n=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:r})=>{let i=document.createElement("input");i.type="radio",i.addEventListener("change",()=>{yg(e,!i.checked)}),r.prepend(i);let a=document.createElement("div");a.classList.add("neuroglancer-segmentation-color-seed-control");let o=t.registerDisposer(new yp(e.displayState.segmentColorHash));a.appendChild(o.element);let l=je({svg:b_,title:"Randomize",onClick:()=>n(e)});return a.appendChild(l),t.registerDisposer(Fr(c=>{let d=c===void 0;a.style.visibility=d?"":"hidden",i.checked=d},e.displayState.segmentDefaultColor)),{controlElement:a,control:o}},activateTool:e=>{let{layer:t}=e.tool;yg(t,!1),n(t)}}}function C_(){let n=dg(e=>e.displayState.segmentDefaultColor);return{...n,makeControl:(e,t,r)=>{let i=n.makeControl(e,t,r),{controlElement:a}=i,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{yg(e,o.checked),o.checked&&a.click()}),r.labelTextContainer.prepend(o),t.registerDisposer(Fr(l=>{let c=l!==void 0;a.style.visibility=c?"":"hidden",o.checked=c},e.displayState.segmentDefaultColor)),i},activateTool:(e,t)=>{yg(e.tool.layer,!0),n.activateTool(e,t)}}}var DC="selectedAlpha",PC="notSelectedAlpha",IC="objectAlpha",AC="saturation",MC="hideSegmentZero",RC="baseSegmentColoring",_C="ignoreNullVisibleSet",E$="mesh",D$="skeletons",w_="segments",vg="equivalences",VC="colorSeed",T_="segmentColors",OC="meshRenderScale",NC="crossSectionRenderScale",Sg="skeletonRendering",P$="skeletonShader",L_="segmentQuery",BC="meshSilhouetteRendering",k_="linkedSegmentationGroup",E_="linkedSegmentationColorGroup",FC="segmentDefaultColor",D_="anchorSegment",kC="skeletonShaderControl",P_=class extends ${constructor(e){super();this.layer=e;this.specificationChanged=new We;this.localGraph=new bC;this.visibleSegments=this.registerDisposer(ls.makeWithCounterpart(this.layer.manager.rpc));this.segmentPropertyMap=new Ae(void 0);this.graph=new Ae(void 0);this.segmentEquivalences=this.registerDisposer(ka.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(qt(e=>e!==void 0&&e.highBitRepresentative,[this.graph]))));this.localSegmentEquivalences=!1;this.maxIdLength=new Ae(1);this.hideSegmentZero=new mt(!0,!0);this.segmentQuery=new ct("",ne);this.temporaryVisibleSegments=this.layer.registerDisposer(ls.makeWithCounterpart(this.layer.manager.rpc));this.temporarySegmentEquivalences=this.layer.registerDisposer(ka.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.highBitRepresentative));this.useTemporaryVisibleSegments=this.layer.registerDisposer(Lt.make(this.layer.manager.rpc,!1));this.useTemporarySegmentEquivalences=this.layer.registerDisposer(Lt.make(this.layer.manager.rpc,!1));let{specificationChanged:t}=this;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){de(e,MC,t=>this.hideSegmentZero.restoreState(t)),de(e,vg,t=>{this.localGraph.restoreState(t)}),de(e,w_,t=>{let{segmentEquivalences:r,visibleSegments:i}=this;be(t,a=>{let o=X.parseString(String(a),10);i.add(r.get(o))})}),de(e,L_,t=>this.segmentQuery.restoreState(t))}toJSON(){let e={};e[MC]=this.hideSegmentZero.toJSON();let{visibleSegments:t}=this;t.size>0&&(e[w_]=t.toJSON());let{segmentEquivalences:r}=this;return this.localSegmentEquivalences&&r.size>0&&(e[vg]=r.toJSON()),e[L_]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}},I_=class extends ${constructor(e){super();this.layer=e;this.specificationChanged=new We;this.segmentColorHash=kd.getDefault();this.segmentStatedColors=this.registerDisposer(new yl);this.segmentDefaultColor=new nv;let{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch)}restoreState(e){de(e,VC,t=>this.segmentColorHash.restoreState(t)),de(e,FC,t=>this.segmentDefaultColor.restoreState(t)),de(e,T_,t=>{let r=Fa(t,i=>ra(String(i)));for(let[i,a]of r){let o=X.parseString(String(i)),l=new X(Uu(a));this.segmentStatedColors.set(o,l)}})}toJSON(){let e={};e[VC]=this.segmentColorHash.toJSON(),e[FC]=this.segmentDefaultColor.toJSON();let{segmentStatedColors:t}=this;if(t.size>0){let r=e[T_]={};for(let[i,a]of t)r[i.toString()]=pn(Ba(a.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.segmentDefaultColor.value=e.segmentDefaultColor.value}},UC=class extends ${constructor(e,t){super();this.linkedGroup=e;this.propertyName=t;this.value}get changed(){return this.linkedGroup.root.changed}get value(){let e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;let t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){let{curGroupState:r}=this;r!==void 0&&(t.assignFrom(r),r.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)==null||e.dispose()}},A_=class{constructor(e){this.layer=e;this.segmentSelectionState=new WS;this.selectedAlpha=pl(.5);this.saturation=pl(1);this.notSelectedAlpha=pl(0);this.silhouetteRendering=new ct(0,Df,0);this.objectAlpha=pl(1);this.ignoreNullVisibleSet=new mt(!0,!0);this.skeletonRenderingOptions=new QS;this.shaderError=sa();this.renderScaleHistogram=new ga;this.renderScaleTarget=Mi(1);this.selectSegment=this.layer.selectSegment;this.transparentPickEnabled=this.layer.pick;this.baseSegmentColoring=new mt(!1,!1);this.filterBySegmentLabel=this.layer.filterBySegmentLabel;this.moveToSegment=e=>{this.layer.moveToSegment(e)};this.linkedSegmentationGroup=this.layer.registerDisposer(new $m(this.layer.manager.rootLayers,this.layer,e=>e instanceof On,e=>e.displayState.linkedSegmentationGroup));this.linkedSegmentationColorGroup=this.layer.registerDisposer(new $m(this.layer.manager.rootLayers,this.layer,e=>e instanceof On,e=>e.displayState.linkedSegmentationColorGroup));this.originalSegmentationGroupState=this.layer.registerDisposer(new P_(this.layer));this.originalSegmentationColorGroupState=this.layer.registerDisposer(new I_(this.layer));e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new UC(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new UC(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new Jl(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new Vu(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new Vu(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.segmentDefaultColor=this.layer.registerDisposer(new Vu(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.segmentQuery=this.layer.registerDisposer(new Jl(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new Jl(this.segmentationGroupState,t=>t.segmentPropertyMap))}},I$=_c(mi),On=class extends I${constructor(e){super(e);this.sliceViewRenderScaleHistogram=new ga;this.sliceViewRenderScaleTarget=Mi(1);this.segmentQueryFocusTime=new Ae(Number.NEGATIVE_INFINITY);this.selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=e.clone(),!0),t)};this.filterBySegmentLabel=e=>{let t=Go(this.displayState,e),{label:r}=t;!r||this.filterSegments(r)};this.filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer};this.displayState=new A_(this);this.anchorSegment=new ct(void 0,e=>e===void 0?void 0:X.parseString(e));this.has2dLayer=this.registerDisposer(Un(e=>e.some(t=>t instanceof pg),{changed:this.layersChanged,value:this.renderLayers}));this.has3dLayer=this.registerDisposer(Un(e=>e.some(t=>t instanceof zh||t instanceof Rd||t instanceof Od||t instanceof Jh),{changed:this.layersChanged,value:this.renderLayers}));this.hasSkeletonsLayer=this.registerDisposer(Un(e=>e.some(t=>t instanceof Od),{changed:this.layersChanged,value:this.renderLayers}));this.registerDisposer(Na((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(Na((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new LC(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new TC(this)}),this.tabs.default="rendering"}bindSegmentListWidth(e){return zo(this.displayState,e)}get volumeOptions(){return{volumeType:ot.SEGMENTATION}}activateDataSubsources(e){let t=[],r=this.displayState.linkedSegmentationGroup.root.value===this,i;for(let a of e){if(this.addStaticAnnotations(a))continue;let{volume:o,mesh:l,segmentPropertyMap:c,segmentationGraph:d,local:p}=a.subsourceEntry.subsource;if(o instanceof Ft){switch(o.dataType){case z.FLOAT32:a.deactivate("Data type not compatible with segmentation layer");continue}a.activate(()=>a.addRenderLayer(new pg(o,{...this.displayState,transform:a.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else l!==void 0?a.activate(()=>{let m={...this.displayState,transform:a.getRenderLayerTransform()};if(l instanceof Yr)a.addRenderLayer(new zh(this.manager.chunkManager,l,m));else if(l instanceof eo)a.addRenderLayer(new Rd(this.manager.chunkManager,l,m));else{let y=new ZS(this.manager.chunkManager,l,m);a.addRenderLayer(new Od(y.addRef())),a.addRenderLayer(new Jh(y))}},this.displayState.segmentationGroupState.value):c!==void 0?r?(a.activate(()=>{}),t.push(c)):a.deactivate("Not supported on non-root linked segmentation layers"):d!==void 0?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=d,a.activate(m=>{this.graphConnection=m.registerDisposer(d.connect(this.displayState.segmentationGroupState.value)),m.registerDisposer(()=>{this.graphConnection=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):p===oi.equivalences?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=this.displayState.originalSegmentationGroupState.localGraph,a.activate(m=>{this.graphConnection=m.registerDisposer(i.connect(this.displayState.segmentationGroupState.value)),m.registerDisposer(()=>{this.graphConnection=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):a.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=zP(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=i}getLegacyDataSourceSpecifications(e,t,r,i){let a=super.getLegacyDataSourceSpecifications(e,t,r,i),o=de(t,E$,c=>c===null?null:ne(c)),l=de(t,D$,c=>c===null?null:ne(c));if(o!==void 0||l!==void 0)for(let c of a)c.enableDefaultSubsources=!1,c.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&a.push(al(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),l!=null&&a.push(al(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[vg]!==void 0&&i.find(c=>c.url===xh)===void 0&&a.push({url:xh,enableDefaultSubsources:!0,transform:{outputSpace:ki,sourceRank:0,transform:void 0,inputSpace:ki},subsources:new Map}),a}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[DC]),this.displayState.saturation.restoreState(e[AC]),this.displayState.notSelectedAlpha.restoreState(e[PC]),this.displayState.objectAlpha.restoreState(e[IC]),this.displayState.baseSegmentColoring.restoreState(e[RC]),this.displayState.silhouetteRendering.restoreState(e[BC]),this.displayState.ignoreNullVisibleSet.restoreState(e[_C]);let{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[Sg]);let r=e[P$];r!==void 0&&t.shader.restoreState(r),this.displayState.renderScaleTarget.restoreState(e[OC]),this.anchorSegment.restoreState(e[D_]),this.sliceViewRenderScaleTarget.restoreState(e[NC]);let i=de(e,k_,ne);i!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(i);let a=de(e,E_,o=>o===!1?void 0:ne(o),i);a!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(a),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var i;let e=super.toJSON();e[DC]=this.displayState.selectedAlpha.toJSON(),e[PC]=this.displayState.notSelectedAlpha.toJSON(),e[AC]=this.displayState.saturation.toJSON(),e[IC]=this.displayState.objectAlpha.toJSON(),e[RC]=this.displayState.baseSegmentColoring.toJSON(),e[_C]=this.displayState.ignoreNullVisibleSet.toJSON(),e[BC]=this.displayState.silhouetteRendering.toJSON(),e[D_]=this.anchorSegment.toJSON(),e[Sg]=this.displayState.skeletonRenderingOptions.toJSON(),e[OC]=this.displayState.renderScaleTarget.toJSON(),e[NC]=this.sliceViewRenderScaleTarget.toJSON();let{linkedSegmentationGroup:t,linkedSegmentationColorGroup:r}=this.displayState;return e[k_]=t.toJSON(),r.root.value!==t.root.value&&(e[E_]=(i=r.toJSON())!=null?i:!1),e[vg]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),r.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return e==null?e:GS(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;let{segmentSelectionState:r}=this.displayState;if(r.hasSelectedSegment){let i=r.selectedSegment,{visibleSegments:a}=this.displayState.segmentationGroupState.value,o=!a.has(i);(o||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=o),t.defer(()=>{t.segmentationToggleSegmentState===o&&a.set(i,o)})}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);let r=new X,{value:i}=e;typeof i=="number"&&(i=i.toString()),typeof i!="string"||!r.tryParseString(i)?e.value=void 0:e.value=r}selectionStateToJson(e,t){let r=super.selectionStateToJson(e,t),{value:i}=e;return i instanceof Vi?t?r.value={key:i.key.toString(),value:i.value?i.value.toString():void 0,label:i.label}:r.value=(i.value||i.key).toString():i instanceof X&&(r.value=i.toString()),r}displaySegmentationSelection(e,t,r){let{value:i}=e,a;if((typeof i=="number"||typeof i=="string")&&(a=new X,!a.tryParseString(i.toString())))return!1;if(i instanceof X)a=i.clone();else if(i instanceof Vi)a=i.key.clone();else return!1;let{displayState:o}=this,l=Go(o,a),{segmentEquivalences:c,segmentPropertyMap:{value:d}}=this.displayState.segmentationGroupState.value,p=c.get(a),m=Id(this.displayState,l);if(Ho(o,r,r.redraw),r.registerDisposer(zo(o,m)),m.classList.add("neuroglancer-selection-details-segment"),t.appendChild(m),d!==void 0){let{inlineProperties:y}=d.segmentPropertyMap;if(y!==void 0){let v=d.getSegmentInlineIndex(p);if(v!==-1){for(let b of y.properties)if(b.type!=="label"){if(b.type==="description"){let x=b.values[v];if(!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-description"),C.textContent=x,t.appendChild(C)}else if(b.type==="number"||b.type==="string"){let x=b.values[v];if(b.type==="number"?isNaN(x):!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-property");let L=document.createElement("div");L.classList.add("neuroglancer-selection-details-segment-property-name"),L.textContent=b.id,b.description&&(L.title=b.description);let A=document.createElement("div");A.classList.add("neuroglancer-selection-details-segment-property-value"),A.textContent=x.toString(),C.appendChild(L),C.appendChild(A),t.appendChild(C)}}}}}return!0}displaySelectionState(e,t,r){let i=this.displaySegmentationSelection(e,t,r);return super.displaySelectionState(e,t,r)&&(i=!0),i}moveToSegment(e){for(let t of this.renderLayers){if(!(t instanceof Rd))continue;let r=t.getObjectPosition(e);if(r!==void 0){this.setLayerPosition(t.displayState.transform.value,r);return}}Ee.showTemporaryMessage(`No position information loaded for segment ${e}`)}};On.type="segmentation",On.typeAbbreviation="seg",On.supportsPickOption=!0;var A$=10;function M_(n){return[{label:`Skeleton mode (${n})`,toolJson:`${Sg}.mode${n}`,isValid:e=>e.hasSkeletonsLayer,...sg(e=>e.displayState.skeletonRenderingOptions[`params${n}`].mode)},{label:`Line width (${n})`,toolJson:`${Sg}.lineWidth${n}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${n})`,title:`Skeleton line width (${n})`,...Gi(e=>({value:e.displayState.skeletonRenderingOptions[`params${n}`].lineWidth,options:{min:1,max:40,step:1}}))}]}var EC=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:VC,...x_()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:FC,...C_()},{label:"Saturation",toolJson:AC,title:"Saturation of segment colors",...Gi(n=>({value:n.displayState.saturation}))},{label:"Opacity (on)",toolJson:DC,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...Gi(n=>({value:n.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:PC,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...Gi(n=>({value:n.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:NC,isValid:n=>n.has2dLayer,...Oc(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:OC,isValid:n=>n.has3dLayer,...Oc(n=>({histogram:n.displayState.renderScaleHistogram,target:n.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:IC,isValid:n=>n.has3dLayer,title:"Opacity of meshes and skeletons",...Gi(n=>({value:n.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:BC,isValid:n=>n.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...Gi(n=>({value:n.displayState.silhouetteRendering,options:{min:0,max:A$,step:.1}}))},{label:"Hide segment ID 0",toolJson:MC,title:"Disallow selection and display of segment id 0",...ns(n=>n.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:RC,title:"Color base segments individually",...ns(n=>n.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:_C,...ns(n=>n.displayState.ignoreNullVisibleSet)},...M_("2d"),...M_("3d")];for(let n of EC)og(On,n);Ui(On);jm(ot.SEGMENTATION,On);Xo(n=>{if(n.mesh!==void 0)return{layerConstructor:On,priority:1}});os(On,n=>({shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState}),kC);c_();var R_="shader",__="shaderControls",Bc=class extends mi{constructor(e){super(e);this.managedLayer=e;this.displayState=new Db;this.vertexAttributes=new Ae(void 0);this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new B_(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[R_]),this.displayState.shaderControlState.restoreState(e[__])}activateDataSubsources(e){let t=!1;for(let r of e){let{subsourceEntry:i}=r,{subsource:a}=i,{singleMesh:o}=a;if(o!==void 0){if(t){r.deactivate("Only one single-mesh source supported");continue}t=!0,r.activate(l=>{r.addRenderLayer(new Ab(o,this.displayState,r.getRenderLayerTransform())),this.vertexAttributes.value=o.info.vertexAttributes,l.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}r.deactivate("Not compatible with image layer")}}toJSON(){let e=super.toJSON();return e[R_]=this.displayState.fragmentMain.toJSON(),e[__]=this.displayState.shaderControlState.toJSON(),e}};Bc.type="mesh",Bc.typeAbbreviation="mesh";function V_(n){return new so({fragmentMain:n.displayState.fragmentMain,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.shaderControlState})}var O_=class extends ${constructor(e){super();this.attributes=e;this.element=document.createElement("div");this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){let{element:e}=this,t=this.attributes.value;if(t===void 0){Me(e);return}let r=Ib(t.map(a=>a.name)),i=t.length;for(let a=0;a<i;++a){let o=t[a],l=document.createElement("div");l.className="neuroglancer-single-mesh-attribute";let c=document.createElement("div");c.className="neuroglancer-single-mesh-attribute-type",c.textContent=Pb(o);let d=document.createElement("div");if(d.className="neuroglancer-single-mesh-attribute-name",d.textContent=r[a],l.appendChild(c),l.appendChild(d),o.min!==void 0&&o.max!==void 0){let p=document.createElement("neuroglancer-single-mesh-attribute-minmax");p.className="neuroglancer-single-mesh-attribute-range",p.textContent=`[${o.min.toPrecision(6)}, ${o.max.toPrecision(6)}]`,l.appendChild(p)}e.appendChild(l)}}disposed(){Ye(this.element)}};function N_(n){return new O_(n.vertexAttributes)}var B_=class extends an{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(N_(this.layer));this.codeWidget=this.registerDisposer(V_(this.layer));let{element:t}=this;t.classList.add("neuroglancer-single-mesh-dropdown");let r=document.createElement("div");r.className="neuroglancer-single-mesh-dropdown-top-row";let i=document.createElement("div");i.style.flex="1",r.appendChild(i),r.appendChild(rs({title:"Show larger editor view",onClick:()=>{new F_(this.layer)}})),r.appendChild(ts({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(r),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new lo(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}},F_=class extends Wi{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(N_(this.layer));this.codeWidget=this.registerDisposer(V_(this.layer));this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};Ui(Bc);Xo(n=>{if(n.singleMesh!==void 0)return{layerConstructor:Bc,priority:2}});os(Bc,n=>({shaderControlState:n.displayState.shaderControlState}));var U_=rt(Dt());var WC=class extends ${constructor(e){super();this.ref=e;this.element=document.createElement("label");this.selectElement=document.createElement("select");this.registerDisposer(e);let{element:t,selectElement:r}=this;t.appendChild(r),this.updateView(),this.registerEventListener(r,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,U_.default)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){let{selectElement:e,ref:t}=this,{filter:r}=t;Me(e);let i=document.createElement("option");e.appendChild(i);for(let a of this.ref.layerManager.managedLayers)if(r(a)){let o=document.createElement("option"),{name:l}=a;o.textContent=l,o.value=l,e.appendChild(o)}e.value=t.layerName||""}};var M$="points",GC="annotations",W_="annotationProperties",G_="annotationRelationships",z_="crossSectionAnnotationSpacing",H_="projectionAnnotationSpacing",$_="shader",j_="shaderControls";function R$(n,e){e!==void 0&&be(e,(t,r)=>{n.add({type:Re.POINT,id:""+r,point:vk(t),properties:[]})})}function _$(n){let e=n.layer;return e===null||e instanceof On}function V$(n){if(n===void 0)return null;let e=n.layer;return e===null||!(e instanceof On)?null:e.displayState}var J_="linkedSegmentationLayer",q_="filterBySegmentation",Y_="ignoreNullSegmentFilter",K_=class extends ${constructor(e,t,r){super();this.layerManager=e;this.annotationStates=t;this.annotationDisplayState=r;this.changed=new ae;this.curGeneration=-1;this.wasLoading=void 0;this.map=new Map;this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){let e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;let{map:r}=this,i=!1;for(let a of this.annotationStates.relationships){let o=r.get(a);o===void 0&&(o=this.addRelationship(a),i=!0),o.seenGeneration=e}if(!t)for(let[a,o]of r)o.seenGeneration!==e&&(r.delete(a),i=!0);i&&this.changed.dispatch()}addRelationship(e){let t=this.annotationDisplayState.relationshipStates.get(e),r=new Cx(this.layerManager.addRef(),_$);r.registerDisposer(r.changed.add(()=>{t.segmentationState.value=r.layerName===void 0?void 0:V$(r.layer)}));let{showMatches:i}=t,a={layerRef:r,showMatches:i,seenGeneration:-1};return r.changed.add(this.changed.dispatch),i.changed.add(this.changed.dispatch),this.map.set(e,a),a}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(let e of this.map.values())e.showMatches.reset()}toJSON(){let{map:e}=this;if(e.size===0)return{};let t,r=[];for(let[i,a]of e){a.showMatches.value&&r.push(i);let{layerName:o}=a.layerRef;o!==void 0&&((t=t||{})[i]=o)}return r.sort(),{[J_]:t,[q_]:r.length===0?void 0:r}}restoreState(e){let{isLoading:t}=this.annotationStates;de(e,J_,r=>{typeof r=="string"&&(r={segments:r}),Z(r);for(let i of Object.keys(r)){let a=ne(r[i]),o=this.map.get(i);if(o===void 0){if(!t)continue;o=this.addRelationship(i)}o.layerRef.layerName=a}for(let[i,a]of this.map)Object.prototype.hasOwnProperty.call(r,i)||(a.layerRef.layerName=void 0)}),de(e,q_,r=>{typeof r=="boolean"&&(r=r===!0?["segments"]:[]);for(let i of Zt(r)){let a=this.map.get(i);if(a===void 0){if(!t)continue;a=this.addRelationship(i)}a.showMatches.value=!0}})}disposed(){let{map:e}=this;for(let t of e.values())this.unbind(t);e.clear(),super.disposed()}},X_=class extends ${constructor(e,t){super();this.relationship=e;this.state=t;this.element=document.createElement("label");this.seenGeneration=-1;let{element:r}=this,i=this.registerDisposer(new pr(t.showMatches)),a=new WC(t.layerRef);r.appendChild(i.element),r.appendChild(document.createTextNode(e)),r.appendChild(a.element)}},Q_=class extends ${constructor(e){super();this.linkedSegmentationLayers=e;this.widgets=new Map;this.element=document.createElement("div");this.element.style.display="contents";let t=this.registerCancellable(Be(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){let{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,r=t.changed.count,{widgets:i}=this;function*a(){for(let o of t.relationships){let l=i.get(o);l===void 0&&(l=new X_(o,e.get(o))),l.seenGeneration=r,yield l.element}}for(let[o,l]of i)l.seenGeneration!==r&&(l.dispose(),i.delete(o));In(this.element,a.call(this))}disposed(){super.disposed();for(let e of this.widgets.values())e.dispose()}},O$=_c(mi),cs=class extends O${constructor(e){super(e);this.annotationProperties=new Ae(void 0);this.localAnnotationsJson=void 0;this.pointAnnotationsJson=void 0;this.linkedSegmentationLayers=this.registerDisposer(new K_(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState));this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new t2(this)}),this.tabs.default="annotations"}disposed(){let{localAnnotations:e}=this;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[GC],this.localAnnotationProperties=de(e,W_,Mf),this.localAnnotationRelationships=de(e,G_,Zt,["segments"]),this.pointAnnotationsJson=e[M$],this.annotationCrossSectionRenderScaleTarget.restoreState(e[z_]),this.annotationProjectionRenderScaleTarget.restoreState(e[H_]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[Y_]),this.annotationDisplayState.shader.restoreState(e[$_]),this.annotationDisplayState.shaderControls.restoreState(e[j_])}getLegacyDataSourceSpecifications(e,t,r,i){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,r,i);let a=de(t,"voxelSize",l=>$e(new Float64Array(3),l,c=>dt(c)/1e9)),o=["m","m","m"];if(a!==void 0){let l=Ve({rank:3,units:o,scales:a,names:["x","y","z"]});r===void 0?r={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:r={...r,inputSpace:l}}return[{url:SS,transform:r,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){var a;let t=!1,r;for(let o of e){let{subsourceEntry:l}=o,{local:c}=l.subsource,d=m=>r!==void 0&&Dn(m)!==Dn(r)?(o.deactivate("Annotation properties are not compatible"),!1):(r=m,!0);if(c===oi.annotations){if(t){o.deactivate("Only one local annotations source per layer is supported");continue}if(t=!0,!d((a=this.localAnnotationProperties)!=null?a:[]))continue;o.activate(m=>{var b;let y=this.localAnnotations=new gv(o.loadedDataSource.transform,(b=this.localAnnotationProperties)!=null?b:[],this.localAnnotationRelationships);try{y.restoreState(this.localAnnotationsJson)}catch{}m.registerDisposer(()=>{y.dispose(),this.localAnnotations=void 0}),m.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{R$(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;let v=new Mc({localPosition:this.localPosition,transform:m.registerDisposer(Qf(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,o.loadedDataSource.transform,void 0)),source:y.addRef(),displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:jn.ANNOTATION});this.addAnnotationLayerState(v,o)});continue}let{annotation:p}=l.subsource;if(p!==void 0){if(!d(p.properties))continue;o.activate(()=>{let m=new Mc({localPosition:this.localPosition,transform:o.getRenderLayerTransform(),source:p,displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:jn.ANNOTATION});this.addAnnotationLayerState(m,o)});continue}o.deactivate("Not compatible with annotation layer")}let i=this.annotationProperties.value;Dn(i)!==Dn(r)&&(this.annotationProperties.value=r)}initializeAnnotationLayerViewTab(e){let t=e.registerDisposer(Un(i=>i.some(a=>a.source instanceof Ri),this.annotationStates)),r=e.registerDisposer(new Mn(t,(i,a,o)=>{if(!!i){{let l=o.registerDisposer(new fp(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",a.appendChild(l.element)}{let l=o.registerDisposer(new fp(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",a.appendChild(l.element)}}}));e.element.insertBefore(r.element,e.element.firstChild);{let i=e.registerDisposer(new pr(this.annotationDisplayState.ignoreNullSegmentFilter)),a=document.createElement("label");a.appendChild(document.createTextNode("Ignore null related segment filter")),a.title="Display all annotations if filtering by related segments is enabled but no segments are selected",a.appendChild(i.element),e.element.appendChild(a)}e.element.appendChild(e.registerDisposer(new Q_(this.linkedSegmentationLayers)).element)}toJSON(){let e=super.toJSON();e[z_]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[H_]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[GC]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[GC]=this.localAnnotationsJson),e[W_]=Ik(this.localAnnotationProperties);let{localAnnotationRelationships:t}=this;return e[G_]=t.length===1&&t[0]==="segments"?void 0:t,e[Y_]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[$_]=this.annotationDisplayState.shader.toJSON(),e[j_]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}};cs.type="annotation",cs.typeAbbreviation="ann";function Z_(n){return new so({shaderError:n.annotationDisplayState.shaderError,fragmentMain:n.annotationDisplayState.shader,shaderControlState:n.annotationDisplayState.shaderControls})}var e2=class extends Wi{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(Z_(this.layer));this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},t2=class extends an{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(Z_(this.layer));let{element:t}=this;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new Mn(e.annotationProperties,(a,o)=>{if(a===void 0||a.length===0)return;let l=document.createElement("div");o.appendChild(l),l.classList.add("neuroglancer-annotation-shader-property-list");for(let c of a){let d=document.createElement("div");d.classList.add("neuroglancer-annotation-shader-property");let p=document.createElement("span");p.classList.add("neuroglancer-annotation-shader-property-type"),p.textContent=c.type;let m=document.createElement("span");m.classList.add("neuroglancer-annotation-shader-property-identifier"),m.textContent=`prop_${c.identifier}`,d.appendChild(p),d.appendChild(m);let{description:y}=c;y!==void 0&&(d.title=y),l.appendChild(d)}})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let i=document.createElement("div");i.style.flex="1",i.textContent="Annotation shader:",r.appendChild(i),r.appendChild(rs({title:"Show larger editor view",onClick:()=>{new e2(this.layer)}})),r.appendChild(ts({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),t.appendChild(r),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new lo(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};Ui(cs);Ui(cs,"pointAnnotation");Xo(n=>{if(n.local===oi.annotations)return{layerConstructor:cs,priority:100};if(n.annotation!==void 0)return{layerConstructor:cs,priority:1}});os(cs,n=>({shaderControlState:n.annotationDisplayState.shaderControls}));function n2(n){n.registerEventListener(document,"copy",e=>{if(Ed(e.target))return;let t=document.getSelection();if(t!==null&&t.type==="Range")return;let r=Qs(n.state).value,{clipboardData:i}=e;i!==null&&i.setData("text/plain",JSON.stringify(r,void 0,"  ")),e.preventDefault()})}function N$(n,e){let t=String.raw`^[\[\]{}()\s,]*`;for(let a=0;a<e;++a)a!==0&&(t+=String.raw`[,\s]+`),t+=String.raw`(\d+(?:\.\d+)?)`;t+=String.raw`[\[\]{}()\s,]*$`;let r=n.match(t);if(r===null)return;let i=new Float32Array(e);for(let a=0;a<e;++a){let o=Number(r[a+1]);if(!Number.isFinite(o))return;i[a]=o}return i}function r2(n){n.registerEventListener(document,"paste",e=>{if(Ed(e.target))return;let{clipboardData:t}=e;if(t!==null){let r=t.getData("text/plain"),i=N$(r,n.coordinateSpace.value.rank);i!==void 0&&(n.navigationState.position.value=i)}e.preventDefault()})}function i2(){return bn(document,"contextmenu",n=>{n.preventDefault()})}function a2(){return bn(document,"wheel",n=>{n.ctrlKey&&n.preventDefault()},{passive:!1})}var o2=Symbol("SingleTextureVolumeChunk.textureUnit"),bg=Symbol("SingleTextureVolumeChunk.textureLayout"),vp=class extends ${constructor(e,t){super();this.shaderKey=e;this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",o2)}beginDrawing(e,t){let r=t.textureUnit(o2);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),t[bg]=null}endDrawing(e,t){e.bindTexture(oh[this.shaderSamplerType],null),t[bg]=null}bindChunk(e,t,r,i,a,o,l){let c=r.textureLayout;(t[bg]!==c||l)&&(t[bg]=c,this.setupTextureLayout(e,t,c,i,a,o)),e.bindTexture(oh[this.shaderSamplerType],r.texture)}beginSource(e,t){}},Sp=class extends tb{constructor(e,t){super(e,t);this.texture=null;this.data=t.data}copyToGPU(e){super.copyToGPU(e);let t=this.texture=e.createTexture(),r=oh[this.chunkFormat.shaderSamplerType];e.bindTexture(r,t),this.setTextureData(e),e.bindTexture(r,null)}freeGPUMemory(e){super.freeGPUMemory(e),e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null}};var xg=class extends ${constructor(e,t,r){super();this.chunkDataSize=t;this.textureDims=r;this.textureShape=new Uint32Array(this.textureDims);let i=t.length,a=0;for(let m of t)m!==1&&++a;let o=this.strides=new Uint32Array(i*r),l=r===3?e.max3dTextureSize:e.maxTextureSize,c=0,d=1,{textureShape:p}=this;p.fill(1);for(let m=0;m<i;++m){let y=t[m];if(y===1)continue;let v=y*d,b;v>l||d!==1&&c+a<r?(++c,d=y,b=1):(b=d,d=v),o[r*m+c]=b,p[c]=d}}static get(e,t,r){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${r}`,()=>new xg(e,t,r))}},zC=new Uint32Array(3*5),Cg=class extends vp{constructor(e,t,r,i){super(r,t);this.textureDims=i;ci(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${i}D`,this.textureAccessHelper=new wS("chunkData",i)}static get(e,t,r){let i=`sliceview.UncompressedChunkFormat:${t}:${r}`;return e.memoize.get(i,()=>new Cg(e,t,i,r))}defineShader(e,t){super.defineShader(e,t);let{textureDims:r}=this,i=`ivec${this.textureDims}`,{textureAccessHelper:a}=this,o=(4+t)*r;zC.length<o&&(zC=new Uint32Array(o)),e.addUniform(`highp ${i}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(a.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let c=`
${At(this.dataType)} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ${i} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  offset += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let l=zC,c=o.length,{strides:d}=r,p=i.length,{textureDims:m}=this;for(let v=0;v<m;++v){let b=0;for(let x=0;x<p;++x)b+=i[x]*d[x*m+v];l[v]=b}for(let v=0;v<3;++v){let b=a[v];if(!(b>=p))for(let x=0;x<m;++x)l[(v+1)*m+x]=d[b*m+x]}for(let v=0;v<c;++v){let b=o[v];if(b===-1)l.fill(0,(4+v)*m,(4+v+1)*m);else for(let x=0;x<m;++x)l[(4+v)*m+x]=d[b*m+x]}let y=(4+c)*m;m===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,y):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,y)}getTextureLayout(e,t){return xg.get(e,t,this.textureDims)}setTextureData(e,t,r){let{textureShape:i}=t;(this.textureDims===3?cD:lD)(e,this,r,i[0],i[1],i[2])}},s2=class extends Sp{setTextureData(e){let{source:t}=this,{chunkFormatHandler:r}=t,{chunkFormat:i}=r,a;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=a=r.textureLayout.addRef():this.textureLayout=a=i.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,a,this.data)}getValueAt(e){let{chunkFormat:t}=this,{chunkDataSize:r}=this,i=0,a=1,o=e.length;for(let d=0;d<o;++d)i+=a*e[d],a*=r[d];let l=t.dataType,c=this.data;switch(l){case z.UINT8:case z.INT8:case z.FLOAT32:case z.UINT16:case z.INT16:case z.UINT32:case z.INT32:return c[i];case z.UINT64:{let d=i*2;return new X(c[d],c[d+1])}}}},l2=class extends ${constructor(e,t){super();let r=0;for(let i of t.chunkDataSize)i>1&&++r;this.chunkFormat=this.registerDisposer(Cg.get(e,t.dataType,r>=3?3:2)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize))}getChunk(e,t){return new s2(e,t)}};Kh((n,e)=>e.compressedSegmentationBlockSize==null?new l2(n,e):null);function wg(n,e,t,r,i,a){let o=0,l=0,c=1,d=1;for(let x=0;x<3;++x){let C=i[x],L=r[x],A=Math.floor(C/L),D=C%L;o+=A*c,c*=Math.ceil(t[x]/L),l+=D*d,d*=L}let p=e+o*2,m=n[p],y=n[p+1],v=m&16777215,b=m>>24&255;if(b>0){let C=(e+y&16777215)+Math.floor(l*b/32),L=n[C],A=l*b%32,D=L>>A&(1<<b)-1;v+=a*D}return v}function c2(n,e,t,r,i){let a=wg(n,e,t,r,i,1)+e;return n[a]}function u2(n,e,t,r,i,a){let o=wg(e,t,r,i,a,2)+t;return n.low=e[o],n.high=e[o+1],n}var Tg=class extends ${constructor(e,t){super();this.chunkDataSize=e;this.subchunkSize=t;let r=this.subchunkGridSize=K.create();for(let i=0;i<3;++i)r[i]=Math.ceil(e[i]/t[i])}static get(e,t,r){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${To(t)},${To(r)}`,()=>new Tg(t,r))}},B$=ci(new _i,z.UINT32),HC=new Uint32Array(4*4),Lg=class extends vp{constructor(e,t,r,i){super(i,e);this.subchunkSize=t;this.numChannels=r;this.textureAccessHelper=new Za("chunkData")}static get(e,t,r,i){let a=`sliceview.CompressedSegmentationChunkFormat:${t}:${i}`,o=`${a}:${To(r)}`;return e.memoize.get(o,()=>new Lg(t,r,i,a))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);let r=4*(4+t);HC.length<r&&(HC=new Uint32Array(r));let{textureAccessHelper:i}=this;i.defineShader(e);let a=d=>"compressedSegmentationChunkFormat_"+d;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(QE);let{dataType:o}=this,l=At(o);o===z.UINT64?e.addFragmentCode(Et):e.addFragmentCode(Os),e.addFragmentCode(i.getAccessor(a("readTextureValue"),"uVolumeChunkSampler",z.UINT32,1));let c=`
uint ${a("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${a("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  chunkPositionFull += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${a("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${a("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${a("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${a("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===z.UINT64?"2u":"1u"};
  }
  ${l} result;
`,o===z.UINT64?c+=`
  result.value[0] = ${a("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${a("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${a("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let{subchunkGridSize:l}=r;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);let c=HC,d=o.length;c.fill(0);for(let p=0;p<3;++p){c[p]=i[p];let m=a[p];m!==-1&&(c[4*(p+1)+m]=1)}for(let p=0;p<d;++p){let m=o[p];m!==-1&&(c[4*(4+p)+m]=1)}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(d+4)*4)}setTextureData(e,t,r){Uo(e,B$,r)}getTextureLayout(e,t){return Tg.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);let{subchunkSize:r}=this;e.uniform3i(t.uniform("uSubchunkSize"),r[0],r[1],r[2])}},d2=class extends Sp{setTextureData(e){let{data:t}=this,{chunkFormat:r}=this,i=this.textureLayout=r.getTextureLayout(e,this.chunkDataSize);r.setTextureData(e,i,t)}getValueAt(e){let{chunkDataSize:t,chunkFormat:r}=this,{data:i}=this,a=i[e[3]||0];if(r.dataType===z.UINT64){let o=new X;return u2(o,i,a,t,r.subchunkSize,e),o}else return c2(i,a,t,r.subchunkSize,e)}},p2=class extends ${constructor(e,t){super();let{dataType:r}=t;if(r!==z.UINT64&&r!==z.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${z[r]}`);this.chunkFormat=this.registerDisposer(Lg.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1))}getChunk(e,t){return new d2(e,t)}};Kh((n,e)=>e.compressedSegmentationBlockSize!=null?new p2(n,e):null);var kg='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="controlsAltIconTitle"><circle cx="9" cy="6" r="2"></circle><path d="M4 6H7"></path><path d="M11 6H20"></path><circle cx="9" cy="18" r="2"></circle><path d="M4 18H7"></path><path d="M11 18H20"></path><circle cx="15" cy="12" r="2"></circle><path d="M4 12H13"></path><path d="M17 12L20 12"></path></svg>';var f2='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="layersIconTitle"><path d="M12 4L20 8.00004L12 12L4 8.00004L12 4Z"></path><path d="M20 12L12 16L4 12"></path><path d="M20 16L12 20L4 16"></path></svg>';var h2='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="listIconTitle"><path d="M10 7L18 7M10 12L18 12M10 17L18 17"></path><line x1="7" y1="7" x2="7" y2="7"></line><line x1="7" y1="12" x2="7" y2="12"></line><line x1="7" y1="17" x2="7" y2="17"></line></svg>';var m2='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="settingsIconTitle"><path d="M5.03506429,12.7050339 C5.01187484,12.4731696 5,12.2379716 5,12 C5,11.7620284 5.01187484,11.5268304 5.03506429,11.2949661 L3.20577137,9.23205081 L5.20577137,5.76794919 L7.9069713,6.32070904 C8.28729123,6.0461342 8.69629298,5.80882212 9.12862533,5.61412402 L10,3 L14,3 L14.8713747,5.61412402 C15.303707,5.80882212 15.7127088,6.0461342 16.0930287,6.32070904 L18.7942286,5.76794919 L20.7942286,9.23205081 L18.9649357,11.2949661 C18.9881252,11.5268304 19,11.7620284 19,12 C19,12.2379716 18.9881252,12.4731696 18.9649357,12.7050339 L20.7942286,14.7679492 L18.7942286,18.2320508 L16.0930287,17.679291 C15.7127088,17.9538658 15.303707,18.1911779 14.8713747,18.385876 L14,21 L10,21 L9.12862533,18.385876 C8.69629298,18.1911779 8.28729123,17.9538658 7.9069713,17.679291 L5.20577137,18.2320508 L3.20577137,14.7679492 L5.03506429,12.7050339 Z"></path><circle cx="12" cy="12" r="1"></circle></svg>';var CV=rt(Dt());var P2=rt(Dt());function Xr(n,e){return t=>{t.style.flex=n,e(t)}}function us(n,e){return t=>{t.style.display="flex",t.style.flexDirection=n;for(let r of e){let i=t.ownerDocument.createElement("div");t.appendChild(i),r(i)}}}var F$=ie.create();function Eg(n,e){let t=ie.identity(F$),{globalPosition:r,displayDimensionRenderInfo:{canonicalVoxelFactors:i,displayDimensionIndices:a}}=n;for(let o=0;o<3;++o){let l=a[o];t[12+o]=l===-1?0:r[l],t[5*o]=e/i[o]}return ie.multiply(t,n.viewProjectionMat,t),t}var vl=class extends ${constructor(e){super();this.gl=e;this.vertexBuffer=this.registerDisposer(_t.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(_t.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(GE(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new vl(e))}draw(e,t=!0){let r=this.trivialColorShader,i=this.gl;r.bind(),i.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,e);let a=r.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(a,4);let o=r.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(i.colorMask(!1,!1,!1,!0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.colorMask(!0,!0,!0,!0),i.enable(i.BLEND),i.blendFunc(i.ONE_MINUS_DST_ALPHA,i.DST_ALPHA)),i.lineWidth(1),i.drawArrays(i.LINES,0,6),t&&i.disable(i.BLEND),i.disableVertexAttribArray(a),i.disableVertexAttribArray(o)}};var g2="perspective_view/PerspectiveView";var y2=!1,bp=class{constructor(){this.renderLayers=[null];this.pickData=[null];this.values=[0,0,0];this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,r=1,i=null){return this.register(e,r,t.low,t.high,i)}register(e,t=1,r=0,i=0,a=null){let{renderLayers:o,values:l}=this,c=this.nextPickID;this.nextPickID+=t;let d=o.length;o[d]=e;let p=d*3;return l[p]=c,l[p+1]=r,l[p+2]=i,this.pickData[d]=a,c}setMouseState(e,t){let{renderLayers:r,values:i}=this,a=0,o=r.length-1;for(;a<o;){let y=Math.ceil(a+(o-a)/2);i[y*3]>t?o=y-1:a=y}let l=e.pickedRenderLayer=r[a],c=a*3,d=e.pickedOffset=t-i[c];y2&&console.log(`Looking up pick ID ${t}: renderLayer`,l,`offset=${d}`);let{pickedValue:p}=e;p.low=i[c+1],p.high=i[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferOffset=void 0,e.pickedAnnotationType=void 0;let m=this.pickData[a];l!==null&&(y2&&console.log(`Picked value=${p}, offset=${d}, data=${this.pickData[a]}`),l.updateMouseState(e,p,d,m))}};var v2=rt(Kd());var S2=10,U$=1e3,W$=400,G$=500,z$=Math.PI/20,H$=20,$$=10;function b2(n,e){return Math.sqrt(n*n+e*e)}function x2(n){let[e,t]=n;e.identifier>t.identifier&&([t,e]=[e,t]);let r=e.clientX-t.clientX,i=e.clientY-t.clientY,a=b2(r,i),o=Math.atan2(r,i);return{distance:a,angle:o}}function j$(n,e){let t=Math.PI*2,r=Math.abs(n-e)%t;return Math.min(r,t-r)}var $C=class extends ${constructor(e,t){super();this.target=e;this.eventMap=t;this.prevTouches=new Map;this.moved=!1;this.prevAngle=0;this.rotated=!1;this.prevDistance=0;this.pinched=!1;this.prevCenterX=0;this.prevCenterY=0;this.translated=!1;this.startHold=this.registerCancellable((0,v2.default)((e,t,r,i)=>{let a={event:e,centerX:r,centerY:i};this.dispatch(`touchhold${e.targetTouches.length}`,e,a,t)},U$,{leading:!1,trailing:!0}));this.numPriorTaps=0;this.priorTapNumTouches=0;this.tapStartTime=0;this.tapEndTime=0;this.curTapNumTouches=0;this.registerEventListener(e,"touchstart",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchmove",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchend",r=>{this.handleTouchEvent(r)})}dispatch(e,t,r,i=t.eventPhase){AS(e,t,i,r,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;let t=new Map,{prevTouches:r,prevEvent:i}=this,a=0,o=0;for(let y of e.targetTouches)t.set(y.identifier,y),a+=y.clientX,o+=y.clientY;a/=t.size,o/=t.size;for(let[y,v]of r.entries()){let b=t.get(y);if(b===void 0)r.delete(y);else{let x=b.clientX-v.clientX,C=b.clientY-v.clientY;(Math.abs(x)>=S2||Math.abs(C)>=S2)&&(this.moved=!0)}}if(i===void 0||i.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,a,o),(i===void 0||i.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){let y=Date.now();if(e.targetTouches.length===0&&y-this.tapStartTime<W$){(this.curTapNumTouches!==this.priorTapNumTouches||y-this.tapEndTime>=G$)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=y,this.priorTapNumTouches=this.curTapNumTouches;let v={event:e,centerX:a,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,v)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=a,this.prevCenterY=o,this.translated=!1,t.size===2){let{distance:y,angle:v}=x2(t.values());this.prevDistance=y,this.prevAngle=v,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:l,prevCenterY:c,translated:d}=this,p=a-l,m=o-c;if(d===!1&&b2(p,m)>=$$&&(d=this.translated=!0),d===!0&&(p!==0||m!==0)){this.prevCenterX=a,this.prevCenterY=o;let y={event:e,deltaX:p,deltaY:m,centerX:a,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,y)}if(t.size===2){let{distance:y,angle:v}=x2(t.values()),{pinched:b,rotated:x,prevDistance:C,prevAngle:L}=this;b===!1&&Math.abs(y-C)>=H$&&(this.pinched=b=!0);let A=j$(v,L);if(x===!1&&A>=z$&&(this.rotated=x=!0),b===!0&&y!=C){this.prevDistance=y;let D={event:e,distance:y,prevDistance:C,centerX:a,centerY:o};this.dispatch("touchpinch",e,D)}x===!0&&v!==L&&(this.prevAngle=v,this.dispatch("touchrotate",e,{event:e,centerX:a,centerY:o,angle:v,prevAngle:L}))}}};var jC=K.create(),JC=class{constructor(){this.pickIDs=new bp;this.viewportWidth=0;this.viewportHeight=0;this.invTransform=ie.create();this.frameNumber=-1}},qC=class{constructor(){this.buffer=null;this.glWindowX=0;this.glWindowY=0}},J$=30,on=5,it=1+on*2,Fc=(()=>{let n=on**2,e=(i,a)=>(i-on)**2+(a-on)**2,t=new Uint32Array(it*it),r=0;for(let i=0;i<it;++i)for(let a=0;a<it;++a)e(i,a)>n||(t[r++]=a*it+i);return t=t.subarray(0,r),t.sort((i,a)=>{let o=i%it,l=(i-o)/it,c=a%it,d=(a-c)/it;return e(o,l)-e(c,d)}),t})();function Dg(n,e,t,r,i,a,o){let l=r-on,c=i-on;if(!(l>=0&&c>=0&&l+it<=a&&c+it<=o))for(let d=0;d<it;++d)for(let p=0;p<it;++p){let m=l+p,y=c+d;(m<0||y<0||m>=a||y>=o)&&(n[e+(y*it+m)*t]=0)}}var xp=class extends Bf{constructor(e,t,r){super(e,t,r.visibility);this.viewer=r;this.mouseX=-1;this.mouseY=-1;this.pickRequestPending=!1;this.mouseStateForcer=()=>this.blockOnPickRequest();this.pickingData=[new JC,new JC];this.pickRequests=[new qC,new qC];this.pickBufferContents=new Float32Array(2*4*it*it);this.pickTimerId=-1;this.nextPickRequestTime=0;this.pendingPickRequestTimerId=-1;this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,!!this.pickRequestPending&&this.attemptToIssuePickRequest()};this.inputEventMap=r.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP!="undefined"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new oo(t)),this.registerDisposer(new Gt(t,this.inputEventMap)),this.registerDisposer(new yn(t,this.inputEventMap,i=>{this.onMousemove(i)})),this.registerDisposer(new $C(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",i=>{i.target!==t&&this.onMouseout()},!0),le(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),le(t,"snap",()=>{this.navigationState.pose.snap()}),le(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),le(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),le(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),le(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let i=0;i<3;++i){let a=ik[i];for(let o of[-1,1]){let l=o<0?"-":"+";le(t,`rotate-relative-${a}${l}`,()=>{this.navigationState.pose.rotateRelative(Ur[i],o*.1)});let c=K.create();le(t,`${a}${l}`,()=>{let{navigationState:d}=this,p=c;p[0]=0,p[1]=0,p[2]=0,p[i]=o,d.pose.translateVoxelsRelative(p,!0)})}}le(t,"zoom-via-wheel",i=>{let a=i.detail;this.onMousemove(a,!1),this.zoomByMouse(gl(a))}),le(t,"adjust-depth-range-via-wheel",i=>{let a=i.detail;this.navigationState.depthRange.value*=gl(a)}),le(t,"translate-via-mouse-drag",i=>{An(i.detail,(a,o,l)=>{this.translateByViewportPixels(o,l)})}),le(t,"translate-in-plane-via-touchtranslate",i=>{let{detail:a}=i;this.translateByViewportPixels(a.deltaX,a.deltaY)}),le(t,"translate-z-via-touchtranslate",i=>{let{detail:a}=i,{navigationState:o}=this,l=jC;l[0]=0,l[1]=0,l[2]=a.deltaY+a.deltaX,o.pose.translateVoxelsRelative(l,!0)});for(let i of[1,10])le(t,`z+${i}-via-wheel`,a=>{let o=a.detail,{navigationState:l}=this,c=jC,d=o.deltaY!==0?o.deltaY:o.deltaX;c[0]=0,c[1]=0,c[2]=(d>0?-1:1)*i,l.pose.translateVoxelsRelative(c,!0)});le(t,"move-to-mouse-position",()=>{let{mouseState:i}=this.viewer;i.updateUnconditionally()&&(this.navigationState.position.value=i.position)}),le(t,"snap",()=>this.navigationState.pose.snap()),le(t,"move-annotation",i=>{let{mouseState:a}=this.viewer,o=a.pickedAnnotationId,l=a.pickedAnnotationLayer;if(l!==void 0&&o!==void 0){i.stopPropagation();let c=l.source.getReference(o),d=c.value,p=Oo(d.type),m=a.pickedOffset,{chunkTransform:{value:y}}=l;if(y.error!==void 0)return;let{layerRank:v}=y,b=new Float32Array(v);p.getRepresentativePoint(b,d,a.pickedOffset);let x=lr.set(lr.create(),0,0);a.updateUnconditionally()&&An(i.detail,(C,L,A)=>{lr.add(x,x,[L,A]);let D=new Float32Array(v);zr(D,y.chunkToLayerTransform,v+1,b,v);let R=jC,{displayDimensionIndices:P}=this.navigationState.pose.displayDimensions.value;Yk(R,D,y.modelTransform,P),this.translateDataPointByViewportPixels(R,R,x[0],x[1]),Kk(D,R,y.modelTransform,P);let E=new Float32Array(v);zr(E,y.layerToChunkTransform,v+1,D,v);let V=p.updateViaRepresentativePoint(d,E,m);l.source.update(c,V)},C=>{l.source.commit(c),c.dispose()})}}),le(t,"delete-annotation",()=>{let{mouseState:i}=this.viewer,a=i.pickedAnnotationId,o=i.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&a!==void 0){let l=o.source.getReference(a);try{o.source.delete(l)}finally{l.dispose()}}}),le(t,"zoom-via-touchpinch",i=>{let{detail:a}=i;this.handleMouseMove(a.centerX,a.centerY);let o=a.prevDistance/a.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){let{gl:e}=this;for(let t of this.pickRequests){let{sync:r}=t;r!==null&&e.deleteSync(r),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){let{gl:t}=this,{buffer:r}=e;r===null?(r=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,2*4*4*it*it,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r);let{renderViewport:i}=this,a=this.mouseX-i.visibleLeftFraction*i.logicalWidth,o=i.height-(this.mouseY-i.visibleTopFraction*i.logicalHeight);this.issuePickRequest(a,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=a,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;let{pickRequests:l}=this;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+J$}completePickInternal(e){let{gl:t}=this,{pickBufferContents:r}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,r),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);let{pickingData:i}=this,{frameNumber:a}=e;this.completePickRequest(e.glWindowX,e.glWindowY,r,i[0].frameNumber===a?i[0]:i[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let r=this.context.frameNumber,i=-1;e&&(--r,i=r-1);let{pickRequests:a}=this,{gl:o}=this,l=!1,c=!1,d;for(let m of a){let{sync:y}=m;if(y===null)continue;let{frameNumber:v}=m;if(!c&&v>=r-1){if(t||o.getSyncParameter(y,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(m),c=!0;else if(v!==i){l=!0;continue}}o.deleteSync(y),m.sync=null,d=m}let{pickTimerId:p}=this;l&&p===-1?this.scheduleCheckForPickRequestCompletion():!l&&p!==-1&&(window.clearTimeout(p),this.pickTimerId=-1),!e&&d!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(d)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){let{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);let{pickingData:r}=this;r[0]=r[1];let i=this.context.frameNumber,a=r[1];if(a.frameNumber=i,a.viewportWidth=e,a.viewportHeight=t,a.pickIDs.clear(),!this.drawWithPicking(a)){a.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){let e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:r}=this;return e<t?(r==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;let e=this.context.frameNumber,{gl:t}=this,{pickRequests:r}=this;for(let i of r){let{sync:a}=i;if(a!==null)if(i.frameNumber<e-1)t.deleteSync(a);else continue;this.issuePickRequestInternal(i);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}let r=this.context.frameNumber,i=this.pickingData[1];i.frameNumber!==r||this.renderViewport.width!==i.viewportWidth||this.renderViewport.height!==i.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){let{element:r}=this,i=r.getBoundingClientRect(),a=e-(i.left+r.clientLeft),o=t-(i.top+r.clientTop),{mouseState:l}=this.viewer;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(a,o)}onMousemove(e,t=!0){let{element:r}=this;t&&e.target!==r||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let{element:t}=this;if(e.target!==t||e.targetTouches.length!==1)return;let{clientX:r,clientY:i}=e.targetTouches[0];this.handleMouseMove(r,i)}disposed(){let{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);let{gl:t}=this;this.cancelPickRequests();let{pendingPickRequestTimerId:r}=this;r!==-1&&window.clearTimeout(r);for(let i of this.pickRequests)t.deleteBuffer(i.buffer);super.disposed()}};var q$=[1.5,2,3,5,7.5,10];var C2=class{constructor(){this.allowedSignificands=q$;this.targetLengthInPixels=0;this.physicalSizePerPixel=0;this.prevPhysicalSizePerPixel=0;this.prevTargetLengthInPixels=0;this.prevPhysicalUnit="\0"}update(){let{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;let r=t*e,i=Math.floor(Math.log10(r)),a=10**i,o=r/a,l=1;for(let p of this.allowedSignificands)if(Math.abs(p-o)<Math.abs(l-o))l=p;else break;let c=l*a,d=wv(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${d.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(i-d.exponent),!0}};function Y$(n,e,t,r,i){let a=document.createElement("canvas"),o=a.getContext("2d"),l=i.textHeightInPixels*i.scaleFactor,c=`bold ${l}px ${i.fontName}`;o.font=c,o.fillStyle="white";let d=`${r}${n.physicalLength} ${n.physicalUnit}`,p=o.measureText(d),m=Math.max(n.lengthInPixels,p.width),y=i.barHeightInPixels*i.scaleFactor,v=i.barTopMarginInPixels*i.scaleFactor,b=y+v+l,x=i.paddingInPixels*i.scaleFactor,C=b+2*x,L=m+2*x;return a.width=L,a.height=C,o.font=c,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,L,C),o.fillStyle="white",o.fillText(d,L/2,C-x-y-v),o.fillRect(x,C-x-y,n.lengthInPixels,y),UE(e,t,a),{width:L,height:C}}var w2=class extends ${constructor(e,t=new C2){super();this.gl=e;this.dimensions=t;this.texture=null;this.width=0;this.height=0;this.label="";this.factor=1;this.priorOptions=void 0;this.prevLabel=""}update(e){let{dimensions:t,label:r}=this,{texture:i}=this;if(!t.update()&&i!==null&&e===this.priorOptions&&r==this.prevLabel)return;i===null&&(i=this.texture=this.gl.createTexture());let{width:a,height:o}=Y$(t,this.gl,i,r,e);this.priorOptions=e,this.prevLabel=r,this.width=a,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}},Cp=class extends ${constructor(e){super();this.gl=e;this.scaleBarCopyHelper=this.registerDisposer(ua.get(this.gl));this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new w2(e)))}draw(e,t,r,i,a){let{scaleBars:o}=this,{displayRank:l,displayDimensionIndices:c,canonicalVoxelFactors:d,globalDimensionNames:p,displayDimensionUnits:m,displayDimensionScales:y}=t,{factors:v}=r,b=Math.min(a.maxWidthFraction*e.logicalWidth,a.maxWidthInPixels*a.scaleFactor),x=0;for(let D=0;D<l;++D){let R=c[D],P=m[D],E=v[R],V,O,B;for(V=0;V<x&&(O=o[V],B=O.dimensions,!(B.physicalBaseUnit===P&&O.factor===E));++V);V===x&&(++x,O=o[V],O.label="",B=O.dimensions,O.factor=E,B.physicalBaseUnit=P,B.targetLengthInPixels=b,B.physicalSizePerPixel=y[D]*i/d[D]),O.label+=`${p[R]} `}let{gl:C,scaleBarCopyHelper:L}=this,A=a.bottomPixelOffset*a.scaleFactor;for(let D=x-1;D>=0;--D){let R=o[D];x===1?R.label="":R.label+=": ",R.update(a),C.viewport(a.leftPixelOffset*a.scaleFactor-e.visibleLeftFraction*e.logicalWidth,A-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,R.width,R.height),L.draw(R.texture),A+=R.height+a.marginPixelsBetweenScaleBars*a.scaleFactor}}},K$={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},T2={...K$,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function X$(n){let e={...T2};for(let t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])j(n,t,r=>{r!==void 0&&(e[t]=En(r))});return j(n,"fontName",t=>{t!==void 0&&(e.fontName=ne(t))}),e}var YC=class extends ct{constructor(){super(T2,X$)}};var Qr;(function(i){i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES"})(Qr||(Qr={}));var Q$=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,Z$=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,ej=[Z$,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function KC(n){n.addOutputBuffer("vec4","out_color",0),n.addOutputBuffer("highp vec4","out_z",1),n.addOutputBuffer("highp vec4","out_pickId",2),n.addFragmentCode(Q$)}function tj(n){n.addOutputBuffer("vec4","v4f_fragData0",0),n.addOutputBuffer("vec4","v4f_fragData1",1),n.addFragmentCode(ej)}var co=K.create(),L2=Gn.create(),nj=ie.create();function rj(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}var ij=la(hn),k2=class extends ij{constructor(e){super();this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new Us(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}},wp=class extends xp{constructor(e,t,r){super(e,t,r);this.sliceViews=this.registerDisposer(new fl((e,t,r)=>{e.registerDisposer(r),e.registerDisposer(r.visibility.add(this.visibility))}));this.axesLineHelper=this.registerDisposer(vl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(Ws.get(this.gl,KC));this.offscreenFramebuffer=this.registerDisposer(new Pi(this.gl,{colorBuffers:[new ca(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new ca(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new ca(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new Xv(this.gl)}));this.offscreenCopyHelper=this.registerDisposer(ua.get(this.gl));this.transparencyCopyHelper=this.registerDisposer(ua.get(this.gl,rj,2));this.scaleBars=this.registerDisposer(new Cp(this.gl));this.projectionParameters=this.registerDisposer(new hd({navigationState:this.navigationState,update:(a,o)=>{let{invViewMatrix:l,projectionMat:c,logicalWidth:d,logicalHeight:p}=a,m=d/p,y=Math.PI/4,{relativeDepthRange:v}=o,x=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){let C=Math.max(.1,1-v),L=1+v;ie.ortho(c,-m,m,-1,1,C,L)}else{let C=1/Math.tan(y/2);v/=C;let L=Math.max(.1,1-v),A=1+v;x*=C,ie.perspective(c,y,m,L,A)}Of(a,c),o.pose.toMat4(l,x),ie.scale(l,l,K.set(co,1,-1,-1)),ie.translate(l,l,Ur[2]),Gf(a)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());let i=this.sharedObject=this.registerDisposer(new k2(this));if(i.RPC_TYPE_ID=g2,i.initializeCounterpart(r.rpc,{}),i.visibility.add(this.visibility),this.visibleLayerTracker=Hm(this.viewer.layerManager,Ir,this.viewer.visibleLayerRoles,this),le(t,"rotate-via-mouse-drag",a=>{An(a.detail,(o,l,c)=>{this.navigationState.pose.rotateRelative(Ur[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative(Ur[0],-c/4*Math.PI/180)})}),le(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(Ur[2],o.angle-o.prevAngle)}),le(t,"rotate-out-of-plane-via-touchtranslate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(Ur[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Ur[0],-o.deltaY/4*Math.PI/180)}),r.showSliceViewsCheckbox){let a=this.registerDisposer(new pr(r.showSliceViews));a.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(a.element),this.element.appendChild(o)}this.registerDisposer(r.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){let r=co,{viewProjectionMat:i,invViewProjectionMat:a,logicalWidth:o,logicalHeight:l}=this.projectionParameters.value,{pose:c}=this.viewer.navigationState;c.updateDisplayPosition(d=>{K.transformMat4(r,d,i),r[0]+=-2*e/o,r[1]+=2*t/l,K.transformMat4(d,r,a)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(let[o,l]of this.sliceViews)if((l||this.viewer.showSliceViews.value)&&!o.isReady())return!1;this.ensureBoundsUpdated();let{width:e,height:t}=this.renderViewport;if(e===0||t===0)return!0;let i={projectionParameters:this.projectionParameters.value},{visibleLayers:a}=this.visibleLayerTracker;for(let[o,l]of a)if(!o.isReady(i,l))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;let{offscreenFramebuffer:e,renderViewport:{width:t,height:r}}=this,i=t*r,a=new Float32Array(i*4);try{e.bindSingle(1),this.gl.readPixels(0,0,t,r,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,a)}finally{e.framebuffer.unbind()}let o=new Float32Array(i);for(let l=0;l<i;++l)o[l]=a[l*4];return o}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-on,t-on,0,it,it),r.readPixelFloat32IntoBuffer(2,e-on,t-on,4*4*it*it,it,it)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,Dg(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let o=Fc.length;for(let l=0;l<o;++l){let c=Fc[l],d=r[4*c];if(d===0)continue;let p=c%it,m=(c-p)/it,y=1-d;co[0]=2*(e+p-on)/i.viewportWidth-1,co[1]=2*(t+m-on)/i.viewportHeight-1,co[2]=2*y-1,K.transformMat4(co,co,i.invTransform);let{position:v,unsnappedPosition:b}=a,{value:x}=this.navigationState.position,C=x.length;v.length!==C&&(v=a.position=new Float32Array(C)),b.length!==C&&(b=a.unsnappedPosition=new Float32Array(C)),v.set(x),a.coordinateSpace=this.navigationState.coordinateSpace.value;let L=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:A}=L;for(let R=0,P=A.length;R<P;++R)v[A[R]]=co[R];b.set(v);let D=r[4*it*it+4*c];i.pickIDs.setMouseState(a,D),a.displayDimensions=L,a.setActive(!0);return}a.setActive(!1)}translateDataPointByViewportPixels(e,t,r,i){let a=co,{viewProjectionMat:o,invViewProjectionMat:l,width:c,height:d}=this.projectionParameters.value;return K.transformMat4(a,t,o),a[0]+=2*r/c,a[1]+=-2*i/d,K.transformMat4(e,a,l)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new Pi(this.gl,{colorBuffers:Vs(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;let{width:t,height:r}=this.renderViewport,i=this.viewer.showSliceViews.value;for(let[x,C]of this.sliceViews)(C||i)&&x.updateRendering();let a=this.gl;this.offscreenFramebuffer.bind(t,r),a.disable(a.SCISSOR_TEST),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.stencilMask(4294967295),a.clearStencil(0),a.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);let o=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(o[0],o[1],o[2],0),a.clear(a.DEPTH_BUFFER_BIT),a.clearBufferfv(WebGL2RenderingContext.COLOR,0,[o[0],o[1],o[2],0]),a.clearBufferfv(WebGL2RenderingContext.COLOR,1,Bu),a.clearBufferfv(WebGL2RenderingContext.COLOR,2,Bu),a.enable(a.DEPTH_TEST);let l=this.projectionParameters.value,c=K.create();K.transformQuat(c,Ur[2],this.navigationState.pose.orientation.orientation),K.scale(c,c,-1);let d=.2,p=1-d,m={wireFrame:this.viewer.wireFrame.value,projectionParameters:l,lightDirection:c,ambientLighting:d,directionalLighting:p,pickIDs:e.pickIDs,emitter:KC,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1};ie.copy(e.invTransform,l.invViewProjectionMat);let{visibleLayers:y}=this.visibleLayerTracker,v=!1,b=!1;for(let[x,C]of y)x.isTransparent?v=!0:x.isAnnotation?b=!0:x.draw(m,C);if(this.drawSliceViews(m),b){a.enable(WebGL2RenderingContext.BLEND),a.depthFunc(WebGL2RenderingContext.LEQUAL),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[x,C]of y)x.isAnnotation&&x.draw(m,C);a.depthFunc(WebGL2RenderingContext.LESS),a.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),v){a.depthMask(!1),a.enable(WebGL2RenderingContext.BLEND);let{transparentConfiguration:x}=this;x.bind(t,r),this.gl.clearColor(0,0,0,1),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),m.emitter=tj,a.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),m.emitPickID=!1;for(let[C,L]of y)C.isTransparent&&C.draw(m,L);a.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(0),a.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(x.colorBuffers[0].texture,x.colorBuffers[1].texture),a.depthMask(!0),a.disable(WebGL2RenderingContext.BLEND),a.enable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bind(t,r),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.drawBuffers([a.NONE,a.COLOR_ATTACHMENT1,a.COLOR_ATTACHMENT2]),m.emitter=KC,m.emitPickID=!0,m.emitColor=!1,a.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilMask(2);for(let[C,L]of y)!C.isTransparent||!C.transparentPickEnabled||C.draw(m,L);a.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),a.stencilMask(0);for(let[C,L]of y)!C.isTransparent||C.transparentPickEnabled||C.draw(m,L)}if(a.stencilMask(4294967295),a.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){a.drawBuffers([a.COLOR_ATTACHMENT0]),a.disable(WebGL2RenderingContext.DEPTH_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);let{scaleBars:x}=this,C=this.viewer.scaleBarOptions.value;x.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,C),a.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){let{sliceViewRenderHelper:t}=this,{lightDirection:r,ambientLighting:i,directionalLighting:a,projectionParameters:{viewProjectionMat:o}}=e,l=this.viewer.showSliceViews.value;for(let[c,d]of this.sliceViews){if(!d&&!l)continue;let{width:p,height:m,invViewMatrix:y,viewportNormalInCanonicalCoordinates:v}=c.projectionParameters.value;if(p===0||m===0||!c.valid)continue;let b=Math.abs(K.dot(r,v)),x=i+b*a,C=nj;ie.identity(C),C[0]=p/2,C[5]=-m/2,ie.multiply(C,y,C),ie.multiply(C,o,C);let L=L2,A=this.viewer.crossSectionBackgroundColor.value;L[0]=A[0],L[1]=A[1],L[2]=A[2],L[3]=1,t.draw(c.offscreenFramebuffer.colorBuffers[0].texture,C,Gn.fromValues(x,x,x,1),L2,0,0,1,1)}}drawAxisLines(){let{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,r=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,i=e*r,{gl:a}=this;a.drawBuffers([a.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(Eg(t,i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}};var Uc;(function(r){r[r.COLOR=0]="COLOR",r[r.PICK=1]="PICK",r[r.NUM_TEXTURES=2]="NUM_TEXTURES"})(Uc||(Uc={}));function aj(n){n.addOutputBuffer("vec4","out_fragColor",0),n.addOutputBuffer("highp vec4","out_pickId",1),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function oj(n){n.addOutputBuffer("vec4","out_fragColor",null),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}var Sl=K.create(),sj=K.create(),lj=Gn.create(),Wc=class extends xp{constructor(e,t,r,i){super(e,t,i);this.sliceView=r;this.axesLineHelper=this.registerDisposer(vl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(Ws.get(this.gl,oj));this.colorFactor=Gn.fromValues(1,1,1,1);this.pickIDs=new bp;this.offscreenFramebuffer=this.registerDisposer(new Pi(this.gl,{colorBuffers:[new ca(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new ca(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]}));this.offscreenCopyHelper=this.registerDisposer(ua.get(this.gl));this.scaleBars=this.registerDisposer(new Cp(this.gl));i.wireFrame.changed.add(()=>this.scheduleRedraw()),le(t,"rotate-via-mouse-drag",a=>{let{mouseState:o}=this.viewer;if(o.updateUnconditionally()){let l=Float32Array.from(o.position);An(a.detail,(c,d,p)=>{let{pose:m}=this.navigationState,y=K.transformQuat(Sl,Ur[0],m.orientation.orientation),v=K.transformQuat(sj,Ur[1],m.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(v,-d/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(y,-p/4*Math.PI/180,l)})}}),le(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a,{mouseState:l}=this.viewer;this.handleMouseMove(o.centerX,o.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,l.position)}),this.registerDisposer(r),this.visibleLayerTracker=Hm(this.viewer.layerManager,ya,this.viewer.visibleLayerRoles,this),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.visibility.add(this.visibility)),this.registerDisposer(r.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(i.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(i.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){let{pose:r}=this.viewer.navigationState;r.updateDisplayPosition(i=>{K.set(i,-e,-t,0),K.transformMat4(i,i,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,r,i){let a=this.sliceView.projectionParameters.value;return K.transformMat4(e,t,a.viewMatrix),K.set(e,e[0]+r,e[1]+i,e[2]),K.transformMat4(e,e,a.invViewMatrix),e}isReady(){if(!this.visible)return!1;let{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;let t={projectionParameters:e.projectionParameters.value,sliceView:e};for(let[r,i]of this.visibleLayerTracker.visibleLayers)if(!r.isReady(t,i))return!1;return!0}drawWithPicking(e){let{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();let r=t.projectionParameters.value,{width:i,height:a,invViewProjectionMat:o}=r;ie.copy(e.invTransform,o);let{gl:l}=this;this.offscreenFramebuffer.bind(i,a),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let c=lj,d=this.viewer.crossSectionBackgroundColor.value;c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,xf,this.colorFactor,c,0,0,1,1);let{visibleLayers:p}=this.visibleLayerTracker,{pickIDs:m}=this;m.clear();let y={wireFrame:this.viewer.wireFrame.value,projectionParameters:r,pickIDs:m,emitter:aj,emitColor:!0,emitPickID:!0,sliceView:t};this.offscreenFramebuffer.bind(i,a),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[v,b]of p)v.draw(y,b);if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){let v=Math.min(r.logicalWidth,r.logicalHeight)/4*1.5,{zoomFactor:{value:b}}=this.viewer.navigationState;this.axesLineHelper.draw(ck(Eg(r,v*b)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(r,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-on,t-on,0,it,it)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,Dg(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let{viewportWidth:o,viewportHeight:l}=i,c=Fc.length,{value:d}=this.navigationState.position,p=d.length,m=this.navigationState.pose.displayDimensions.value,{displayRank:y,displayDimensionIndices:v}=m,b=(L,A,D)=>{let R=e+L,P=t+A;Sl[0]=2*R/o-1,Sl[1]=2*P/l-1,Sl[2]=0,K.transformMat4(Sl,Sl,i.invTransform),D.set(d);for(let E=0;E<y;++E)D[v[E]]=Sl[E]},{unsnappedPosition:x}=a;x.length!==p&&(x=a.unsnappedPosition=new Float32Array(p)),a.coordinateSpace=this.navigationState.coordinateSpace.value,a.displayDimensions=m,b(0,0,x);let C=(L,A,D)=>{let{position:R}=a;R.length!==p&&(R=a.position=new Float32Array(p)),b(L-on,A-on,R),this.pickIDs.setMouseState(a,D),a.setActive(!0)};for(let L=0;L<c;++L){let A=Fc[L],D=r[4*L];if(D===0)continue;let R=A%it,P=(A-R)/it;C(R,P,D);return}C(on,on,0)}zoomByMouse(e){let{navigationState:t}=this;if(!t.valid)return;let{sliceView:r}=this,{width:i,height:a,invViewMatrix:o,displayDimensionRenderInfo:{displayDimensionIndices:l,displayRank:c}}=r.projectionParameters.value,{mouseX:d,mouseY:p}=this;d-=i/2,p-=a/2;let m=this.navigationState.position.value;for(let y=0;y<c;++y){let v=l[y],b=o[y]*d+o[4+y]*p;m[v]+=b*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}};var E2=rt(Dt());var cj=["#f00","#0f0","#00f"],D2=_e.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function uj(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${lg(t,1)}p${e}`}return n.toString()}var dj=[n=>n.name,n=>n.scaleFactor],pj=2e3,XC=class extends ${constructor(e,t,r,i="px"){super();this.displayDimensionRenderInfo=e;this.zoom=t;this.depthRange=r;this.displayUnit=i;this.element=document.createElement("div");this.dimensionGridContainer=document.createElement("div");this.depthGridContainer=document.createElement("div");this.defaultCheckbox=document.createElement("input");this.dimensionElements=Array.from(Array(3),(e,t)=>{let r=document.createElement("div");r.classList.add("neuroglancer-display-dimensions-widget-dimension"),r.style.display="contents",le(r,"adjust-via-wheel",d=>{let p=d.detail,{deltaY:m}=p;m!==0&&this.zoomDimension(t,Math.sign(m))});let i=document.createElement("input");i.classList.add("neuroglancer-display-dimensions-widget-name"),i.title="Change display dimensions",i.spellcheck=!1,i.autocomplete="off",i.style.color=cj[t],i.style.gridColumn="1",i.style.gridRow=`${t+1}`,i.addEventListener("focus",()=>{i.select()}),r.appendChild(i);let a=document.createElement("span");a.classList.add("neuroglancer-display-dimensions-widget-scale-factor");let o=document.createElement("input");o.spellcheck=!1,o.title="Change relative scale at which dimension is displayed",o.autocomplete="off",a.style.gridColumn="2",a.style.gridRow=`${t+1}`,o.addEventListener("focus",()=>{o.select()}),a.appendChild(o),r.appendChild(a);let l=document.createElement("span");l.classList.add("neuroglancer-display-dimensions-widget-scale"),l.style.gridColumn="3",l.style.gridRow=`${t+1}`,r.appendChild(l),this.dimensionGridContainer.appendChild(r);let c={name:i,container:r,scaleFactor:o,scale:l,scaleFactorModified:!1};i.addEventListener("input",()=>{gn(i),this.updateNameValidity()}),le(i,"commit",()=>{this.updateNames()}),i.addEventListener("blur",d=>{let{relatedTarget:p}=d;this.dimensionElements.some(m=>m.name===p)||this.updateNames()||this.updateView()}),a.addEventListener("click",d=>{let{target:p}=d;p!==o&&(o.focus(),d.preventDefault())}),o.addEventListener("input",()=>{gn(o),c.scaleFactorModified=!0}),le(o,"commit",()=>{this.updateScaleFactors()}),o.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(let d of dj)le(d(c),"move-up",()=>{t!==0&&d(this.dimensionElements[t-1]).focus()}),le(d(c),"move-down",()=>{t!==2&&d(this.dimensionElements[t+1]).focus()});return c});this.scheduleUpdateView=Be(()=>this.updateView());let{element:a,dimensionGridContainer:o,defaultCheckbox:l}=this,c=document.createElement("label"),d=this.registerCancellable((0,E2.default)(()=>{a.dataset.active="false"},pj)),p=()=>{a.dataset.active="true",d()};this.registerDisposer(t.changed.add(p)),this.registerDisposer(e.relativeDisplayScales.changed.add(p)),this.registerDisposer(r.changed.add(p)),a.classList.add("neuroglancer-display-dimensions-widget"),a.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),a.addEventListener("pointerleave",()=>{let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(c),this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));let m=this.registerDisposer(new Gt(a,D2));m.allShortcutsAreGlobal=!0,this.registerDisposer(new yn(a,D2)),le(o,"cancel",()=>{this.updateView();let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()});let{depthGridContainer:y}=this;y.classList.add("neuroglancer-depth-range-widget-grid"),a.appendChild(y);let v=document.createElement("label"),b=document.createElement("input");b.type="checkbox",v.classList.add("neuroglancer-depth-range-relative-checkbox-label"),b.classList.add("neuroglancer-depth-range-relative-checkbox"),v.appendChild(b),v.appendChild(document.createTextNode("Zoom-relative")),b.addEventListener("change",()=>{let x=b.checked,C=this.depthRange.value;x!==C<0&&(x?C=-C/this.zoom.value:C=-C*this.zoom.value,this.depthRange.value=C)}),v.title="Depth range is multiplied by scale",a.appendChild(v),le(y,"adjust-via-wheel",x=>{let C=x.detail,{deltaY:L}=C;if(L===0)return;let A=this.depthRange.value;this.depthRange.value=A*2**Math.sign(L)}),this.registerDisposer(Wn((x,C,{factors:L})=>{Me(y);let{displayRank:A,globalDimensionNames:D,displayDimensionIndices:R,displayDimensionUnits:P,displayDimensionScales:E,canonicalVoxelFactors:V}=C,O=[],B=()=>{b.checked=this.depthRange.value<0;let F=this.depthRange.value;F<0&&(F*=-this.zoom.value);for(let N of O){let{input:J}=N;J.value=Li(F*N.scale,N.unit,{precision:2,elide1:!1}),gn(J)}},W=F=>{let N=Do(F.input.value);if(N===void 0||N.unit!==F.unit)return!1;let J=N.scale/F.scale;return this.depthRange.value<0&&(J=-J/this.zoom.value),this.depthRange.value=J,!0};for(let F=0;F<A;++F){let N=R[F],J=D[N],re=P[F],pe=L[N],ye=O.find(ce=>ce.unit===re&&ce.factor===pe);if(ye===void 0){let ce=document.createElement("div");ce.title="Visible depth range",ce.style.display="contents",y.appendChild(ce);let fe=document.createElement("span");fe.textContent="\xB1",ce.appendChild(fe);let Le=document.createElement("input");Le.spellcheck=!1,Le.autocomplete="off",Le.addEventListener("focus",()=>{Le.select()}),le(Le,"commit",()=>{W(ye)}),Le.addEventListener("change",()=>{W(ye)||B()}),Le.addEventListener("input",()=>{gn(Le)}),ce.appendChild(Le);let Ge=document.createElement("span");Ge.classList.add("neuroglancer-depth-range-widget-dimension-names"),ce.appendChild(Ge),ye={unit:re,factor:pe,dimensionNames:[],input:Le,label:Ge,scale:E[F]/V[F]},O.push(ye)}ye.dimensionNames.push(J)}for(let F of O)F.dimensionNames.length!==A&&(F.label.textContent=F.dimensionNames.join(" "));x.registerDisposer(le(y,"cancel",()=>{B();let F=document.activeElement;F instanceof HTMLElement&&y.contains(F)&&F.blur()}));let _=x.registerCancellable(Be(B));x.registerDisposer(this.depthRange.changed.add(_)),x.registerDisposer(this.zoom.changed.add(_)),B()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();let{displayDimensions:r}=this,{relativeDisplayScales:i}=this,{displayDimensionIndices:a}=r.value,o=a[e];if(o===-1)return;let{factors:l}=i.value,c=new Float64Array(l);c[o]*=2**-t,i.setFactors(c)}updateNameValidity(){let{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,r=e.map(c=>c.name.value),i=Zu(r),a=this.displayDimensions.coordinateSpace.value,{names:o}=a,l=r.length;for(let c=0;c<l;++c){let d=i[c],p=r[c],m=-1;p.length===0?d=!0:(m=o.indexOf(p),m===-1&&(d=!1));let y=e[c];y.name.dataset.isValid=d.toString(),y.container.dataset.isModified=(m!==t[c]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){let e=this.dimensionElements.map(l=>l.name.value).filter(l=>l.length>0);if(!rc(e))return!1;let{displayDimensions:t}=this.displayDimensionRenderInfo;if(e.length===0)return t.reset(),!0;let r=new Int32Array(3);r.fill(-1);let i=t.coordinateSpace.value,{names:a}=i,o=e.length;for(let l=0;l<o;++l){let c=a.indexOf(e[l]);if(c===-1)return!1;r[l]=c}return Ce(r,t.value.displayDimensionIndices)||t.setDimensionIndices(o,r),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){let{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:r,displayRank:i}=e.value,{factors:a}=t.value,{dimensionElements:o}=this,l=new Float64Array(a);for(let c=0;c<i;++c){let d=o[c];if(!d.scaleFactorModified)continue;let p=Number(d.scaleFactor.value),m=r[c];!Number.isFinite(p)||p<=0||(l[m]=p)}return Ce(l,a)||t.setFactors(l),!0}updateView(){let{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:r,canonicalVoxelFactors:i,displayDimensionUnits:a,displayDimensionScales:o,globalDimensionNames:l}=this.displayDimensionRenderInfo.value,{factors:c}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;let d=this.zoom.value,p=r[0],m=!0;if(p!==-1){let y=a[0],v=c[p];for(let b=1;b<3;++b){let x=r[b];if(x!==-1&&(a[b]!==y||c[x]!==v)){m=!1;break}}}for(let y=0;y<3;++y){let v=r[y],b=e[y];if(delete b.name.dataset.isValid,b.container.dataset.isModified=(v===-1).toString(),v===-1)b.name.value="",b.scale.textContent="",b.scaleFactor.value="";else{b.name.value=l[v];let x=o[y]*d/i[y];if(y===0||!m){let C=Li(x,a[y],{precision:2,elide1:!1});b.scale.textContent=`${C}/${this.displayUnit}`}else b.scale.textContent="";b.scaleFactor.value=uj(c[v])}gn(b.name),gn(b.scaleFactor)}}disposed(){Ye(this.element),super.disposed()}};var I2=new Map([["xy",void 0],["xz",Je.rotateX(Je.create(),Je.create(),Math.PI/2)],["yz",Je.rotateY(Je.create(),Je.create(),Math.PI/2)]]),A2="\u25FB",QC=new Map([["4panel","\u25F1"],["3d",A2]]);function fj(n,e){let t;return e===void 0?t=n.navigationState.addRef():t=new Ta(new wa(n.navigationState.pose.position.addRef(),n.navigationState.pose.displayDimensionRenderInfo.addRef(),io.makeRelative(n.navigationState.pose.orientation,e)),n.navigationState.zoomFactor.addRef(),n.navigationState.depthRange.addRef()),new pc(n.chunkManager,n.layerManager,t,n.wireFrame)}function Tp(n,e){return fj(n,I2.get(e))}function hj(n){return new Map([["xy",Tp(n,"xy")],["xz",Tp(n,"xz")],["yz",Tp(n,"yz")]])}function M2(n){return{crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor,selectionDetailsState:n.selectionDetailsState,mouseState:n.mouseState,layerManager:n.layerManager,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,visibleLayerRoles:n.visibleLayerRoles,selectedLayer:n.selectedLayer,visibility:n.visibility,scaleBarOptions:n.scaleBarOptions}}function ZC(n){let{viewer:e}=n;return{...M2(e),navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:n.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc}}function Pg(n){return{...M2(n),navigationState:n.navigationState,inputEventMap:n.inputEventBindings.sliceView}}function Gc(n,e){let{navigationState:t}=e;e.element.appendChild(n.registerDisposer(new XC(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof Wc?"px":"vh")).element)}function zc(n,e,t){let r=document.createElement("div");r.className="neuroglancer-data-panel-layout-controls",n.registerDisposer(()=>Ye(r));for(let i=0;i<2;++i){let a=t[Math.min(t.length-1,i)];n.registerDisposer(le(e.element,i===0?"toggle-layout":"toggle-layout-alternative",o=>{n.container.name=a,o.stopPropagation()}))}for(let i of t){let a=document.createElement("button"),o=document.createElement("div");a.appendChild(o),o.textContent=QC.get(i),a.title=`Switch to ${i} layout.`,a.addEventListener("click",()=>{n.container.name=i}),r.appendChild(a)}e.element.appendChild(r)}function mj(n,e){let t=new pc(n.chunkManager,n.layerManager,e.navigationState.addRef(),n.wireFrame),r=()=>{let{width:{value:i},height:{value:a}}=e;t.projectionParameters.setViewport({width:i,height:a,logicalWidth:i,logicalHeight:a,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(r)),t.registerDisposer(e.height.changed.add(r)),r(),t}function ew(n,e,t){let r=new Map;(()=>{let a=new Set;for(let o of t.values()){if(a.add(o),r.has(o))continue;let l=mj(n,o);e.sliceViews.set(l,!0),r.set(o,l)}for(let[o,l]of r)a.has(o)||e.sliceViews.delete(l)})()}var R2=class extends ${constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=hj(r),{display:o}=r,l={...ZC(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},c={...Pg(r),showScaleBar:r.showScaleBar},d={...Pg(r),showScaleBar:new mt(!1,!1)},p=(y,v,b,x)=>{let C=this.registerDisposer(new Wc(o,v,a.get(y),b));return x&&Gc(this,C),zc(this,C,[y,`${y}-3d`]),C},m=[Xr(1,us("column",[Xr(1,us("row",[Xr(1,y=>{p("xy",y,c,!0)}),Xr(1,y=>{p("xz",y,d,!1)})])),Xr(1,us("row",[Xr(1,y=>{let v=this.registerDisposer(new wp(o,y,l));for(let b of a.values())v.sliceViews.set(b.addRef(),!1);Gc(this,v),ew(r,v,i),zc(this,v,["3d"])}),Xr(1,y=>{p("yz",y,d,!1)})]))]))];us("row",m)(t)}disposed(){Me(this.rootElement),super.disposed()}},_2=class extends ${constructor(e,t,r,i,a,o){super();this.container=e;this.rootElement=t;this.viewer=r;this.direction=i;let l=Tp(r,a),{display:c}=r,d={...ZC(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},p={...Pg(r),showScaleBar:r.showScaleBar};Xr(1,us(i,[Xr(1,m=>{let y=this.registerDisposer(new Wc(c,m,l,p));Gc(this,y),zc(this,y,[a,"4panel"])}),Xr(1,m=>{let y=this.registerDisposer(new wp(c,m,d));y.sliceViews.set(l.addRef(),!1),ew(r,y,o),Gc(this,y),zc(this,y,["3d","4panel"])})]))(t)}disposed(){Me(this.rootElement),super.disposed()}},V2=class extends ${constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=Tp(r,i),o={...Pg(r),showScaleBar:r.showScaleBar};us("row",[Xr(1,l=>{let c=this.registerDisposer(new Wc(r.display,l,a,o));Gc(this,c),zc(this,c,["4panel",`${i}-3d`])})])(t)}disposed(){Me(this.rootElement),super.disposed()}},O2=class extends ${constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a={...ZC(e),showSliceViews:new mt(!1,!1)};us("row",[Xr(1,o=>{let l=this.registerDisposer(new wp(r.display,o,a));ew(r,l,i),Gc(this,l),zc(this,l,["4panel"])})])(t)}disposed(){Me(this.rootElement),super.disposed()}},tw=new Map([["4panel",{factory:(n,e,t,r)=>new R2(n,e,t,r)}],["3d",{factory:(n,e,t,r)=>new O2(n,e,t,r)}]]);for(let n of I2.keys()){tw.set(n,{factory:(t,r,i)=>new V2(t,r,i,n)});let e=`${n}-3d`;QC.set(n,A2),QC.set(e,"\u25EB"),tw.set(e,{factory:(t,r,i,a)=>new _2(t,r,i,"row",n,a)})}function N2(n){let e=tw.get(n);if(e===void 0)throw new Error(`Invalid layout name: ${JSON.stringify(n)}.`);return e}function gj(n){return N2(n),n}var B2=class extends ${constructor(e){super();this.width=new ct(1e3,Rt);this.height=new ct(1e3,Rt);this.changed=new ae;this.position=new Qd(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new Dc(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new Pc(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new Ta(new wa(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){Z(e),nn(e,"width",this.width),nn(e,"height",this.height),nn(e,"position",ol(this.position)),nn(e,"orientation",this.orientation),nn(e,"scale",this.scale),nn(e,"zoom",ol(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}},F2=class extends fl{constructor(e){super((t,r)=>t.registerDisposer(t.registerDisposer(r).changed.add(this.changed.dispatch)));this.parentNavigationState=e;this.registerDisposer(e)}restoreState(e){Z(e);for(let t of Object.keys(e)){let r=new B2(this.parentNavigationState);try{this.set(t,r.addRef()),r.restoreState(e[t])}finally{r.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;let e={};for(let[t,r]of this)e[t]=r.toJSON();return e}},U2=class extends ${constructor(e,t){super();this.changed=new ae;this.orthographicProjection=new mt(!1);this.type=new ct(t,gj),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new F2(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(Z(e),j(e,"type",t=>this.type.restoreState(t)),j(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),j(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){let{type:e,crossSections:t,orthographicProjection:r}=this,i=r.toJSON();return t.size===0&&i===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:i}}},nw=class extends ${constructor(e,t){super();this.viewer=e;this.element=document.createElement("div");this.specification=this.registerDisposer(new U2(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";let r=this.registerCancellable((0,P2.default)(()=>this.updateLayout(),0));this.specification.type.changed.add(r),le(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>r.flush())),r()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let{layout:e}=this;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=N2(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}};var W2=typeof STATE_SERVERS!="undefined"&&Object.keys(STATE_SERVERS).length>0,rw=class extends ${constructor(e){super();this.element=document.createElement("div");this.button=je({text:"Share",title:"Share State"});if(typeof STATE_SERVERS=="undefined")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){let t=document.createElement("select");t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{let r=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(i=>i.url).includes(r)&&(t.value=r)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value});for(let[r,i]of Object.entries(STATE_SERVERS)){let a=document.createElement("option");a.textContent=r,a.value=i.url,a.selected=!!i.default,t.appendChild(a)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{let t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,r=new URL(t).protocol,{url:i,credentialsProvider:a}=Zn(t,Qn);Ee.forPromise(Ni(a,i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())},St).then(o=>{let l=new URL(o);l.protocol=r;let c=`${window.location.origin}/#!${l}`;navigator.clipboard.writeText(c).then(()=>{Ee.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Ee.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}};function yj(n){return n.startsWith("key")?n.substring(3):n.startsWith("digit")||n.startsWith("arrow")?n.substring(5):n}function vj(n){return n.split("+").map(yj).join("+")}var Sj={...ui,side:"left",row:1},iw=class{constructor(){this.location=new Jn(Sj)}get changed(){return this.location.changed}toJSON(){return wi(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},aw=class extends Ar{constructor(e,t,r,i,a){super(e,t.location);this.bindings=r;this.toolBinder=a;this.scroll=document.createElement("div");this.addTitleBar({title:"Help"});let o=document.createElement("div");o.classList.add("neuroglancer-help-body");let{scroll:l}=this;l.classList.add("neuroglancer-help-scroll-container"),o.appendChild(l),this.addBody(o);let c=this.registerCancellable(Be(()=>this.updateView()));this.registerDisposer(a.changed.add(c)),this.registerDisposer(i.layersChanged.add(c)),this.updateView()}updateView(){let{scroll:e,bindings:t,toolBinder:r}=this;Me(e);let i=new Map;function a(p,m){for(let y of p.parents)y.label!==void 0?o(y.label,y):a(y,m);for(let[y,v]of p.bindings.entries()){let b=y.indexOf(":"),x=y.substring(b+1);m.set(x,v.action)}}function o(p,m){if(i.has(m))return;let y={label:p,entries:new Map};a(m,y.entries),i.set(m,y)}for(let[p,m]of t)o(p,m);let l=(p,m)=>{let y=document.createElement("h2");y.textContent=p,e.appendChild(y);for(let[v,b]of m){let x=document.createElement("div");x.className="dt",x.textContent=vj(v);let C=document.createElement("div");C.className="dd",C.textContent=b,e.appendChild(x),e.appendChild(C)}},c=new Map;for(let[p,m]of r.bindings){let y=c.get(m.layer);y===void 0&&(y=[],c.set(m.layer,y)),y.push([`shift+key${p.toLowerCase()}`,m.description])}let d=Array.from(c.entries());d.length>0&&(d[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),d.sort((p,m)=>p[0].managedLayer.nonArchivedLayerIndex-m[0].managedLayer.nonArchivedLayerIndex));for(let[p,m]of d)m.sort(),l(`Tool bindings for layer ${p.managedLayer.nonArchivedLayerIndex+1}: ${p.managedLayer.name}`,m);for(let p of i.values())l(p.label,p.entries)}};var fw=rt(Dt());var X2=rt(Dt());function bj(n,e){n.style.display="block";let{offsetWidth:t,offsetHeight:r}=n,i=document.documentElement.clientWidth,a=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(i-t,e.clientX),l=document.documentElement.scrollTop+Math.min(a-r,e.clientY);n.style.left=o+"px",n.style.top=l+"px"}var ow=class extends ${constructor(e){super();this.element=document.createElement("div");this.parentDisposers=new Map;this.disabledValue=!1;this.opened=new ae;this.closed=new ae;let{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){let{parentDisposers:t}=this;t.has(e)||t.set(e,bn(e,"contextmenu",r=>{this.show(r),r.stopPropagation(),r.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();let{element:t}=this,r=bn(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),i=bn(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),a=()=>{i(),r(),t.style.display="none"};this.opened.dispatch(),bj(t,e),this.menuDisposer=a}unregisterParent(e){let{parentDisposers:t}=this,r=t.get(e);r!==void 0&&(r(),t.delete(e))}disposed(){let{parentDisposers:e}=this;for(let t of e.values())t();e.clear(),Ye(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}};function xj(n){return dk(new TextEncoder().encode(n))}function Cj(n){return new TextDecoder().decode(pk(n))}function wj(n,e){if(!!n.startsWith(e))try{let t=Cj(n.substring(e.length));return JSON.parse(t)}catch{return}}function G2(n,e){return n+xj(JSON.stringify(e))}function z2(n,e){for(let t of n){let r=wj(t,e);if(r!==void 0)return{parameters:r,dragType:t}}}var H2;function Lp(n,e){return n.dataTransfer.dropEffect=e,H2=e,e}function kp(){return H2}function $2(n){return n.draggable=!0,bn(n,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}var j2="neuroglancer-layer\0",gi;function sw(n,e){var i;n.dataTransfer.setData(G2(j2,e.layers.map(a=>({name:a.name,visible:a.visible}))),JSON.stringify({layers:e.layers.map(a=>a.toJSON()),layout:e.layoutSpec})),gi!==void 0&&gi.disposer();let t,r=()=>{e.manager.unregisterDisposer(r);for(let a of e.layers)a.dispose();e.manager.dispose(),gi===t&&(gi=void 0)};gi=t={manager:e.manager.addRef(),layers:e.layers.map(a=>a.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(i=e.isLayerListPanel)!=null?i:!1,disposer:r}}function Hc(n="none"){if(gi!==void 0){if(n==="move"){let e=new Set(gi.layers);gi.manager.layerManager.filter(t=>!e.has(t))}gi.disposer()}}function Ep(n){return z2(n.dataTransfer.types,j2)}function J2(n){if(gi!==void 0&&gi.manager.rootLayers===n.rootLayers)return gi}var lw=class{initializeExternalLayers(e){let{dragType:t}=this;if(t!==void 0)try{let{layers:r,layout:i}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(r)||this.numSourceLayers!==r.length)throw new Error("Invalid layer drop data");this.layoutSpec=i;for(let[a,o]of this.layers)oM(a,r[o])}catch{return!1}return!0}updateArchiveStates(e){let{targetIsLayerListPanel:t}=this,r=e.dataTransfer.dropEffect;for(let i of this.layers.keys()){let a=t;t&&!i.archived&&r!=="copy"&&this.sourceIsLayerListPanel&&(a=!1),(i.archived!==a||a&&i.visible)&&(i.archived=a,a&&(i.visible=!1),i.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}};function cw(n,e,t){let r;n.shiftKey?r="copy":n.ctrlKey&&t?r="move":r=e;let i="",a=o=>{i!==""&&(i+=", "),i+=o};return e!=="none"&&r!==e&&(n.shiftKey?a(`release SHIFT to ${e}`):a(`release CONTROL to ${e}`)),r!=="copy"&&a("hold SHIFT to copy"),r!=="move"&&t&&e!=="move"&&a("hold CONTROL to move"),{dropEffect:r,dropEffectMessage:i}}function q2(n,e,t,r){let i=J2(e),a=!1,o;return i===void 0?o="copy":r?(i.isLayerListPanel||(a=!0),o="link"):i.manager===e&&i.isLayerListPanel===t?(o="move",a=!0):t?o="none":(i.isLayerListPanel||(a=!0),o="link"),cw(n,o,a)}function Y2(n,e,t,r){let i=q2(n,e,t,r);return Lp(n,i.dropEffect),i}function Ig(n,e,t){let{forceCopy:r,newTarget:i,isLayerListPanel:a=!1}=t,o=J2(e);if(!r&&o!==void 0){let c=!i&&o.manager===e&&(o.isLayerListPanel===a||o.isLayerListPanel),d=new lw;return d.manager=e,d.numSourceLayers=o.layers.length,d.sourceManager=o.manager,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=o.isLayerListPanel,d.moveSupported=c,d.layers=new Map,d.forceCopy=!1,d.layoutSpec=o.layoutSpec,c?o.layers.forEach((p,m)=>{d.layers.set(p,m)}):o.layers.forEach((p,m)=>{(i||!e.layerManager.has(p))&&d.layers.set(p.addRef(),m)}),d}let l=Ep(n);if(l!==void 0)try{let c=be(l.parameters,(p,m)=>{let y=j(p,"name",ne),v=j(p,"visible",aa),b=new op(y,e);return a&&(v=!1),b.visible=v,b.archived=a,[b,m]}),d=new lw;return d.numSourceLayers=c.length,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=!1,d.sourceManager=void 0,d.moveSupported=!1,d.forceCopy=o!==void 0,d.manager=e,d.dragType=l.dragType,d.layers=new Map(c),d}catch{}}function uw(n,e){return n.moveSupported?!1:(n.manager.layerManager.filter(t=>!n.layers.has(t)),e!==void 0&&n.layers.has(e))}function $c(n,e,t,r=!1){function i(a,o){let l=n.dropLayers,{dropEffect:c,dropEffectMessage:d}=o?q2(a,n.manager,r,!1):{dropEffect:kp(),dropEffectMessage:""};if(c===void 0)return;Lp(a,c);let p=!0;if(!(l!==void 0&&!l.compatibleWithMethod(c)&&(n.dropLayers=void 0,uw(l,t)))){if(l===void 0){if(l=n.dropLayers=Ig(a,n.manager,{forceCopy:c==="copy",newTarget:!1,isLayerListPanel:r}),l===void 0)return;p=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:c,dropEffectMessage:d};if(p){let{layerManager:m}=n.manager,y=new Set,v=Number.POSITIVE_INFINITY,b=m.managedLayers=m.managedLayers.filter((C,L)=>l.layers.has(C)?(v===Number.POSITIVE_INFINITY&&(v=L),y.add(C),!1):!0),x;t!==void 0?(x=b.indexOf(t),v<=x&&++x):x=b.length;for(let C of l.layers.keys())y.has(C)||l.layers.delete(C);b.splice(x,0,...l.layers.keys()),m.layersChanged.dispatch()}else{let m;t!==void 0&&(m=n.manager.layerManager.managedLayers.indexOf(t));for(let y of l.layers.keys())n.manager.add(y,m)}return{dropLayers:l,dropEffect:c,dropEffectMessage:d}}}e.addEventListener("dragenter",a=>{i(a,!0)!==void 0?a.preventDefault():Xt(n.element,"drop")}),e.addEventListener("drop",a=>{var l;a.preventDefault(),n.dragEnterCount=0,Xt(n.element,"drop");let o=(l=i(a,!1))==null?void 0:l.dropLayers;if(n.dropLayers=void 0,o!==void 0){if(!o.initializeExternalLayers(a)){uw(o);return}o.updateArchiveStates(a),Hc(o.method==="move"?void 0:a.dataTransfer.dropEffect)}}),e.addEventListener("dragover",a=>{let o=i(a,!0);if(o===void 0){Xt(n.element,"drop");return}let{dropLayers:l,dropEffect:c,dropEffectMessage:d}=o,p=l.layers.size,m="",y=l.numSourceLayers===1?"":"s",v=l.numSourceLayers;if(c==="none")m=`Cannot link dragged layer${y} here`;else{let b=v===p?`${v}`:`${p}/${v}`;m=`Drop to ${c} ${b} layer${y}`}d&&(m+=` (${d})`),mr(n.element,"drop",m),a.preventDefault(),a.stopPropagation()})}function Ag(n,e,t,r){e.draggable=!0,e.addEventListener("dragstart",i=>{mr(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),sw(i,{manager:n.manager,layers:[t],layoutSpec:r.getLayoutSpec(),isLayerListPanel:r.isLayerListPanel}),i.stopPropagation()}),e.addEventListener("dragend",()=>{Xt(e,"drag"),Hc()})}function Mg(n){n.element.addEventListener("dragenter",()=>{++n.dragEnterCount}),n.element.addEventListener("dragleave",()=>{if(--n.dragEnterCount!=0)return;Xt(n.element,"drop");let{dropLayers:e}=n;e!==void 0&&(uw(e),n.manager.layerManager.layersChanged.dispatch(),n.dropLayers=void 0)})}var K2=class extends ${constructor(e,t){super();this.layer=e;this.panel=t;this.element=document.createElement("div");this.layerNumberElement=document.createElement("div");this.labelElement=document.createElement("div");this.visibleProgress=document.createElement("div");this.prefetchProgress=document.createElement("div");this.labelElementText=document.createTextNode("");this.valueElement=document.createElement("div");this.maxLength=0;this.prevValueText="";let{element:r,labelElement:i,layerNumberElement:a,valueElement:o,visibleProgress:l,prefetchProgress:c,labelElementText:d}=this;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(l),r.appendChild(c),i.className="neuroglancer-layer-item-label",i.appendChild(d),l.className="neuroglancer-layer-item-visible-progress",c.className="neuroglancer-layer-item-prefetch-progress",a.className="neuroglancer-layer-item-number",o.className="neuroglancer-layer-item-value";let p=document.createElement("div");p.className="neuroglancer-layer-item-value-container";let m=document.createElement("div");m.className="neuroglancer-layer-item-button-container",r.appendChild(a),p.appendChild(o),p.appendChild(m);let y=this.layerVisibleElement=document.createElement("input");y.type="checkbox",y.checked=e.visible,y.title="Show/Hide Channel",this.registerEventListener(y,"click",b=>{e.setVisible(y.checked),b.stopPropagation()}),this.registerEventListener(y,"dblclick",b=>{e.setVisible(y.checked),b.stopPropagation()}),r.appendChild(y),r.appendChild(i),r.appendChild(p);let v=this.registerDisposer(new as(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(v.element),v.element.addEventListener("click",b=>{b.stopPropagation()}),v.element.addEventListener("dblclick",b=>{b.stopPropagation()}),r.addEventListener("click",b=>{t.selectedLayer.toggle(e),t.selectedLayer.visible=!0}),r.addEventListener("contextmenu",b=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,b.stopPropagation(),b.preventDefault()}),Ag(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),$c(this.panel,r,this.layer)}update(){let{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),this.layerVisibleElement.checked=e.visible,t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let r="Click to show side panel";e.supportsPickOption&&(r+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),r+=", drag to move, shift+drag to copy",t.title=r}disposed(){this.element.remove(),super.disposed()}},dw=class extends ${constructor(e,t,r,i,a,o){super();this.display=e;this.manager=t;this.viewerNavigationState=r;this.selectedLayer=i;this.getLayoutSpecForDrag=a;this.showLayerHoverValues=o;this.layerWidgets=new Map;this.element=document.createElement("div");this.layerUpdateNeeded=!0;this.valueUpdateNeeded=!1;this.layerWidgetInsertionPoint=document.createElement("div");this.positionWidget=this.registerDisposer(new as(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner));this.dragEnterCount=0;this.scheduleUpdate=this.registerCancellable(Be(()=>this.update()));this.registerDisposer(i);let{element:l}=this;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let c=je({svg:sl,title:"Click to add layer, control+click/right click/\u2318+click to add local annotation layer."});c.classList.add("neuroglancer-layer-add-button");let d=this.dropZone=document.createElement("div");d.className="neuroglancer-layer-panel-drop-zone";let p=y=>{if(y.ctrlKey||y.metaKey||y.type==="contextmenu"){let v=wx(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(v),this.selectedLayer.layer=v,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(c,"click",p),this.registerEventListener(c,"contextmenu",p),l.appendChild(c),l.appendChild(d),this.registerDisposer($2(c)),l.appendChild(this.positionWidget.element);let m=()=>{let y=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=y===Wt.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(m)),m(),this.update(),this.updateChunkStatistics(),Mg(this),$c(this,d,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(Be(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,Ye(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let[t,r]of this.layerWidgets){let i=t.layer,a="";if(i!==null){let o=e.get(i);if(o!==void 0){let{value:l}=o;l!==void 0&&(a=""+l)}}if(a!==r.prevValueText){if(r.prevValueText=a,a.length>r.maxLength){let o=r.maxLength=a.length;r.valueElement.style.width=`${o}ch`}r.valueElement.textContent=a}}}updateChunkStatistics(){for(let[e,t]of this.layerWidgets){let r=0,i=0,a=0,o=0,l=e.layer;if(l!==null)for(let{layerChunkProgressInfo:c}of l.renderLayers)r+=c.numVisibleChunksNeeded,i+=c.numVisibleChunksAvailable,a+=c.numPrefetchChunksNeeded,o+=c.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${i/Math.max(1,r)*100}%`,t.prefetchProgress.style.width=`${o/Math.max(1,a)*100}%`}}updateLayers(){var i;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let e=this.element,t=new Set,r=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(let a of this.manager.layerManager.managedLayers){if(a.archived&&!((i=this.dropLayers)==null?void 0:i.layers.has(a)))continue;t.add(a);let o=this.layerWidgets.get(a),l=a.nonArchivedLayerIndex;o===void 0&&(o=new K2(a,this),this.layerWidgets.set(a,o)),o.layerNumberElement.textContent=""+(1+l),o.update();let{element:c}=o;c!==r&&e.insertBefore(o.element,r),r=c.nextElementSibling}for(let[a,o]of this.layerWidgets)t.has(a)||(this.layerWidgets.delete(a),o.dispose())}addLayerMenu(){qm(this.manager,this.selectedLayer)}};function Rg(n,e){let t=bn(n,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(gp)!==-1){o.stopPropagation();let l=Z(JSON.parse(o.dataTransfer.getData(gp))),c=j(l,"dimensions",ed),d=j(l,"position",v=>be(v,Ze));if(d.length!==c.length)throw new Error("length mismatch between position and dimensions");let p=d.length,{coordinateSpace:{value:{names:m}},value:y}=e;for(let v=0;v<p;++v){let b=m.indexOf(c[v]);b!==-1&&(y[b]=d[v])}e.changed.dispatch()}}),r=o=>{o.dataTransfer.types.indexOf(gp)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},i=bn(n,"dragenter",r),a=bn(n,"dragover",r);return()=>{i(),a(),t()}}var _g="neuroglancer-layer-group-viewer";function pw(n){return n.dataTransfer.types.indexOf(_g)!==-1}var Ea;function Tj(n){if(Ea&&Ea.viewer.layerSpecification.rootLayers===n.rootLayers)return Ea.viewer}function Q2(n,e){let t=Tj(e),r,i=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?r="copy":(i=!0,r="move"),cw(n,r,i)}var Z2=class extends ${constructor(e){super();this.relativeDisplayScales=new qb(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new Yb(e.navigationState.pose.displayDimensions.addRef()),this.position=new Qd(e.navigationState.position.addRef()),this.crossSectionOrientation=new Dc(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new Zd(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new Pc(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new Om(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new Om(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new Ta(new wa(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new Dc(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new Pc(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new Ta(new wa(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(let e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",ol(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}};function Lj(n,e){let t=new ow(n),r=t.element;r.classList.add("neuroglancer-layer-group-viewer-context-menu");let i=document.createElement("button");i.textContent="Remove layer group",r.appendChild(i),t.registerEventListener(i,"click",()=>{e.layerSpecification.layerManager.clear()});let{viewerNavigationState:a}=e;for(let[o,l]of[["Render scale factors",a.relativeDisplayScales.link],["Render dimensions",a.displayDimensions.link],["Position",a.position.link],["Cross-section orientation",a.crossSectionOrientation.link],["Cross-section zoom",a.crossSectionScale.link],["Cross-section depth range",a.crossSectionDepthRange.link],["3-D projection orientation",a.projectionOrientation.link],["3-D projection zoom",a.projectionScale.link],["3-D projection depth range",a.projectionDepthRange.link]]){let c=t.registerDisposer(new pp(l)),d=document.createElement("label");d.style.display="flex",d.style.flexDirection="row",d.style.whiteSpace="nowrap",d.textContent=o,d.appendChild(c.element),r.appendChild(d)}return t}var jc=class extends ${constructor(e,t,r={}){super();this.element=e;this.viewerState=t;this.state=new $o;this.options={showLayerPanel:new mt(!0),showViewerMenu:!1,showLayerHoverValues:new mt(!0),...r},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new Z2(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof sp?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(i=>i.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new oo(e)),this.layout=this.registerDisposer(new nw(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(Rg(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,X2.default)(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(le(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),nn(e,"crossSectionZoom",ol(this.viewerNavigationState.crossSectionScale)),nn(e,"perspectiveZoom",ol(this.viewerNavigationState.projectionScale)),nn(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){let{options:e}=this,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){let r=this.layerPanel=new dw(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(r.registerDisposer(Lj(r.element,this)),r.element.title="Right click for options, drag to move/copy layer group."):r.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS!="undefined"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{let a=document.createElement("button");a.textContent="Clear segments",a.title='De-select all objects ("x")',a.addEventListener("click",o=>{IS(o,o,{action:"clear-segments"})}),r.element.appendChild(a)}for(let a of["3d","xy","xz","yz"]){let o=document.createElement("button");o.textContent=a,o.title=`Switch to ${a} layout`,o.addEventListener("click",()=>{let l;this.layout.name===a?a!=="3d"?l=`${a}-3d`:l="4panel":l=a,this.layout.name=l}),r.element.appendChild(o)}}r.element.draggable=!0;let i=r.element;i.addEventListener("dragstart",a=>{mr(r.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),sw(a,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});let o=()=>{Ea&&Ea.viewer===this&&(Ea=void 0),this.unregisterDisposer(o)};Ea={viewer:this,disposer:o},this.registerDisposer(o);let l=this.toJSON();delete l.layers,a.dataTransfer.setData(_g,JSON.stringify(l)),r.element.style.backgroundColor="black",setTimeout(()=>{r.element.style.backgroundColor=""},0)}),r.element.addEventListener("dragend",()=>{Xt(i,"drag"),Hc(),Ea!==void 0&&Ea.viewer===this&&Ea.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){Me(this.element);let{layerPanel:e}=this;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}};var eV=Symbol("layoutComponentContainer"),Dp=class extends ${constructor(e,t,r){super();this.viewer=e;this.parent=r;this.changed=new ae;this.element=document.createElement("div");let{element:i}=this;i.style.display="flex",i.style.flex="1",i.style.position="relative",i.style.alignItems="stretch",i[eV]=this,this.setSpecification(t);let a=[],o=c=>{let d=document.createElement("div");d.className="neuroglancer-layout-split-drop-zone";let p;switch(d.style[c]="0",c){case"left":case"right":p="row",d.style.width="10px",d.style.height="100%";break;case"top":case"bottom":p="column",d.style.height="10px",d.style.width="100%";break}d.style.display="none",a.push({element:d,direction:p,orientation:c}),i.appendChild(d),nV(d,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,p==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let l=!1;i.addEventListener("dragenter",c=>{if(!l&&Ep(c)!==void 0){l=!0;for(let{element:d,direction:p,orientation:m}of a){if(r!==void 0&&p===r.direction&&((m==="left"||m==="top")&&r.get(0)!==this||(m==="bottom"||m==="right")&&r.get(r.length-1)!==this))continue;let{component:y}=this;y instanceof Og&&y.direction===p||(d.style.display="block")}}},!0),i.addEventListener("drop",c=>{if(!!l){l=!1;for(let{element:d}of a)d.style.display="none"}},!0),i.addEventListener("dragleave",c=>{let{relatedTarget:d}=c;if(!!l&&!(d instanceof HTMLElement&&this.element.contains(d))){l=!1;for(let{element:p}of a)p.style.display="none"}},!0)}unsetComponent(){let e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof jc){let{layerManager:t}=e,r=e.registerCancellable((0,fw.default)(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&r()})),r()}else if(e instanceof Og){let t=e.registerCancellable((0,fw.default)(()=>{let{length:r}=e;if(r===0&&this.parent!==void 0)this.dispose();else if(r===1){let i=e.get(0).component,a;if(this.parent===void 0&&i instanceof jc){a=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();let o=i.layerManager.managedLayers,l=new Set(o),{layerSpecification:c}=i;c.rootLayers.filter(m=>l.has(m)||m.archived);let d=[],{managedLayers:p}=c.rootLayers;for(let m=0,y=p.length;m<y;++m)l.has(p[m])&&d.push(m);for(let m=0,y=o.length;m<y;++m)p[d[m]]=o[m];c.rootLayers.layersChanged.dispatch()}else a=i.toJSON();this.setSpecification(a)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){return this.component.toJSON()}setSpecification(e){this.setComponent(kj(this,e))}static getFromElement(e){return e[eV]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){let t={type:"viewer"},{parent:r}=this;if(r!==void 0){if(e==="left"&&r.direction==="row"||e==="top"&&r.direction==="column")return{newContainer:r.insertChild(t,this),existingContainer:this};if(e==="right"&&r.direction==="row"||e==="bottom"&&r.direction==="column")return{newContainer:r.insertChild(t),existingContainer:this}}let i,a=this.component;a instanceof Vg?i=a.layerGroupViewer.toJSON():i=a.toJSON();let o,l,c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:c,children:[t,i]},l=0;break;case"right":case"bottom":o={type:c,children:[i,t]},l=1;break}this.setSpecification(o);let d=this.component;return{newContainer:d.get(l),existingContainer:d.get(1-l)}}};function tV(n){return{mouseState:n.mouseState,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,showScaleBar:n.showScaleBar,scaleBarOptions:n.scaleBarOptions,showPerspectiveSliceViews:n.showPerspectiveSliceViews,inputEventBindings:n.inputEventBindings,visibility:n.visibility,selectedLayer:n.selectedLayer,visibleLayerRoles:n.visibleLayerRoles,navigationState:n.navigationState.addRef(),perspectiveNavigationState:n.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor}}var Vg=class extends ${constructor(e,t,r){super();this.element=e;this.layerGroupViewer=this.registerDisposer(new jc(e,{display:r.display,layerSpecification:r.layerSpecification.addRef(),...tV(r)},{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}};function nV(n,e,t,r){n.addEventListener("dragenter",i=>{Ep(i)!==void 0&&n.classList.add("neuroglancer-drag-over")}),n.addEventListener("dragleave",()=>{Xt(n,"drop"),n.classList.remove("neuroglancer-drag-over")}),n.addEventListener("dragover",i=>{let a=(o,l)=>{o.dropEffectMessage&&(l+=` (${o.dropEffectMessage})`),mr(n,"drop",l),i.stopPropagation(),i.preventDefault()};if(pw(i)){let o=Q2(i,e);Lp(i,o.dropEffect),a(o,`Drop to ${o.dropEffect} layer group as new ${r}`);return}if(Ep(i)!==void 0){let o=Y2(i,e,!1,!0);a(o,`Drop to ${o.dropEffect} layer as new ${r}`);return}}),n.addEventListener("drop",i=>{n.classList.remove("neuroglancer-drag-over"),Xt(n,"drop");let a,o;if(pw(i)){i.stopPropagation();try{o=JSON.parse(i.dataTransfer.getData(_g))}catch(d){return}if(a=Ig(i,e,{forceCopy:!1,newTarget:!0}),a===void 0)return}else{if(a=Ig(i,e,{forceCopy:kp()==="copy",newTarget:!0}),a===void 0)return;o=a.layoutSpec}if(!a.initializeExternalLayers(i)){if(!a.moveSupported)for(let d of a.layers.keys())d.dispose();return}i.preventDefault();let l=i.dataTransfer.dropEffect=kp();Hc(l);let c=t();a.updateArchiveStates(i);for(let d of a.layers.keys())c.layerSpecification.add(d);try{c.restoreState(o)}catch{c.layout.reset()}})}var Og=class extends ${constructor(e,t,r,i){super();this.element=e;this.direction=t;this.container=i;this.changed=new ae;e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(let a of r)this.insertChild(a)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){let t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",nV(t,this.viewer.layerSpecification,()=>{let r=t.nextElementSibling,i;return r!==null&&(i=Dp.getFromElement(r)),this.insertChild({type:"viewer",layers:[]},i).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{Ye(t)}),t}get viewer(){return this.container.viewer}get(e){return Dp.getFromElement(this.element.children[e*2+1])}insertChild(e,t){let r=new Dp(this.viewer,e,this),i=this.makeDropPlaceholder(r);r.element.classList.add("neuroglancer-stack-layout-child"),r.registerDisposer(r.changed.add(this.changed.dispatch)),r.registerDisposer(()=>{this.element.removeChild(r.element),this.changed.dispatch()});let a=t!==void 0?t.element:null;return this.element.insertBefore(r.element,a),this.element.insertBefore(i,a),this.changed.dispatch(),r}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Symbol.iterator](){let{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}};function kj(n,e){let t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(n.parent!==void 0)throw new Error(`Invalid layout component specification: ${JSON.stringify(e)}`);return new Vg(t,e,n.viewer)}Z(e);let r=j(e,"type",ne);switch(r){case"row":case"column":return new Og(t,r,j(e,"children",i=>{let a=be(i,o=>o);if(n.parent===void 0&&a.length===0)throw new Error("Stack layout requires at least one child.");return a}),n);case"viewer":{let i=n.viewer,a=new sp(i.layerSpecification.addRef()),o=new jc(t,{display:i.display,layerSpecification:a,...tV(i)},{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(l){throw o.dispose(),l}return o}default:return new Vg(t,e,n.viewer)}}var hw=class extends ${constructor(e,t){super();this.viewer=e;this.defaultSpecification=t;this.container=this.registerDisposer(new Dp(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}};var rV='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeCrossedIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle><path d="M3 21L20 4"></path></svg>';var iV='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle></svg>';var aV='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="cursorIconTitle"><polygon points="7 20 7 4 19 16 12 16 7 21"></polygon></svg>';var Ej=_e.fromObject({escape:{action:"cancel"}}),Ng=class extends ${constructor(e){super();this.layer=e;this.element=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";let r=this.registerDisposer(new Gt(t,Ej));r.allShortcutsAreGlobal=!0,le(t,"cancel",i=>{this.updateView(),t.blur(),i.stopPropagation(),i.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){Fm(this.layer,this.element.value)}},oV=class extends ${constructor(e){super();this.layer=e;this.element=document.createElement("select");this.measureElement=document.createElement("div");let{element:t,measureElement:r}=this;t.classList.add("neuroglancer-layer-side-panel-type"),r.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(r);for(let[i,a]of lp){if(a.type!==i)continue;let o=document.createElement("option");o.textContent=a.typeAbbreviation,o.value=i,t.appendChild(o)}t.addEventListener("change",()=>{let i=t.value,a=lp.get(i);np(this.layer.managedLayer,a)}),this.updateView()}updateView(){let e=this.layer.type,{element:t,measureElement:r}=this;r.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${r.offsetWidth}px`}disposed(){this.measureElement.remove()}},Pp=class extends Ar{constructor(e,t){super(e,t.location);this.panelState=t;let r=this.layer=t.layer,{element:i}=this,{titleBar:a}=this.addTitleBar({});a.classList.add("neuroglancer-layer-side-panel-title"),a.appendChild(this.registerDisposer(new oV(r)).element),a.appendChild(this.registerDisposer(new Ng(r.managedLayer)).element);let o=this.registerDisposer(new qn({get value(){return r.managedLayer.pickEnabled},set value(c){r.managedLayer.pickEnabled=c},changed:r.managedLayer.layerChanged},{svg:aV,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new $n({get value(){return r.managedLayer.supportsPickOption},changed:r.managedLayer.layerChanged},o.element)),a.appendChild(o.element);let l={get value(){return t!==r.panels.panels[0]},set value(c){c?t.pin():t.unpin()},changed:r.manager.root.layerManager.layersChanged};a.appendChild(this.registerDisposer(new qn(l,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(Fr(c=>{i.dataset.neuroglancerLayerPanelPinned=c.toString()},l)),a.appendChild(La({title:"Delete layer",onClick:()=>{ul(this.layer.managedLayer)}})),this.tabView=new ax({makeTab:c=>r.tabs.options.get(c).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new hf({get value(){return t.tabs.map(c=>({id:c,label:r.tabs.options.get(c).label}))},changed:t.tabsChanged})),handleTabElement:(c,d)=>{d.draggable=!0,d.addEventListener("dragstart",p=>{p.stopPropagation(),p.dataTransfer.setData("neuroglancer-side-panel","");let m="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(v=>v!==t&&v.location.visible)&&(m+=`, or move tab to other ${JSON.stringify(r.managedLayer.name)} panel`),mr(d,"drag",m),this.sidePanelManager.startDrag({dropAsNewPanel:v=>{this.panelState.splitOffTab(c,{...lx,...v})},canDropAsTabs:v=>v instanceof Pp&&v.layer===this.layer&&v!==this?1:0,dropAsTab:v=>{this.panelState.moveTabTo(c,v.panelState)}},p)}),d.addEventListener("dragend",p=>{Xt(d,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof Pp&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){let e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var a;let{dragSource:r}=this.sidePanelManager,i=(a=r==null?void 0:r.canDropAsTabs)==null?void 0:a.call(r,this);!i||(e.classList.add(Ks),mr(e,"drop",`Move ${i} ${i===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{Xt(e,"drop"),e.classList.remove(Ks)}),e.addEventListener("dragover",t=>{var i;let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||t.preventDefault()}),e.addEventListener("drop",t=>{var i;Xt(e,"drop");let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||(e.classList.remove(Ks),r.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}},mw=class extends ${constructor(e,t){super();this.sidePanelManager=e;this.selectedLayerState=t;this.layerSidePanels=new Map;this.generation=0;this.layersNeedUpdate=!0;let r=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(r)),this.registerDisposer(t.layerManager.layersChanged.add(r)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)==null?void 0:e.layer)!=null?t:void 0}update(){var a;if(!this.layersNeedUpdate)return;let{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;let{layerSidePanels:r}=this,i=o=>{let l=r.get(o);l===void 0?(l={generation:t,unregister:this.sidePanelManager.registerPanel({location:o.location,makePanel:()=>new Pp(this.sidePanelManager,o)})},r.set(o,l)):l.generation=t};{let o=this.getSelectedUserLayer(),{location:l}=this.selectedLayerState;if(o===void 0||!l.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:l,makePanel:()=>new Ar(this.sidePanelManager,l)}));else{(a=this.placeholderSelectedLayerPanel)==null||a.call(this),this.placeholderSelectedLayerPanel=void 0;let c=o.panels.panels[0];c.location.value=l.value,i(c)}}for(let o of e.managedLayers){let l=o.layer;if(l===null)continue;let{panels:c}=l.panels;for(let d=1,p=c.length;d<p;++d)i(c[d])}for(let[o,l]of r)l.generation!==t&&(l.unregister(),r.delete(o))}disposed(){var e;(e=this.placeholderSelectedLayerPanel)==null||e.call(this);for(let{unregister:t}of this.layerSidePanels.values())t()}};var Dj={...ui,side:"left",row:0},gw=class{constructor(){this.location=new Jn(Dj)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return wi(this.location.toJSON())}},sV=class extends ${constructor(e){super();this.layer=e;this.element=document.createElement("div");let{element:t}=this,r=je({svg:iV,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),i=je({svg:rV,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(i),t.appendChild(r);let a=()=>{let o=this.layer.visible;r.style.display=o?"":"none",i.style.display=o?"none":""};a(),this.registerDisposer(e.layerChanged.add(a))}};function Pj(n){let{selectedLayer:e}=n.manager.root,t=new qn({get value(){return e.layer===n&&e.visible},set value(r){r?(e.layer=n,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:kg});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}var lV=class extends ${constructor(e,t){super();this.panel=e;this.layer=t;this.element=document.createElement("div");this.numberElement=document.createElement("div");this.generation=-1;let{element:r,numberElement:i}=this;r.classList.add("neuroglancer-layer-list-panel-item"),i.classList.add("neuroglancer-layer-list-panel-item-number"),r.appendChild(this.registerDisposer(new pr({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),r.appendChild(i),r.appendChild(this.registerDisposer(new sV(t)).element),r.appendChild(this.registerDisposer(new Ng(t)).element),r.appendChild(this.registerDisposer(Pj(t)).element);let a=La({title:"Delete layer",onClick:()=>{ul(this.layer)}});a.classList.add("neuroglancer-layer-list-panel-item-delete"),r.appendChild(a),Ag(e,r,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),$c(e,r,t,!0),r.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),r.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}},yw=class extends Ar{constructor(e,t,r){super(e,r.location);this.manager=t;this.state=r;this.items=new Map;this.itemContainer=document.createElement("div");this.layerDropZone=document.createElement("div");this.dragEnterCount=0;this.generation=-1;let{itemContainer:i,layerDropZone:a}=this,{titleElement:o}=this.addTitleBar({title:""});this.titleElement=o,i.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(i),a.style.flex="1";let l=this.registerCancellable(Be(()=>this.render()));this.visibility.changed.add(l),this.registerDisposer(this.layerManager.layersChanged.add(l)),this.registerDisposer(this.selectedLayer.changed.add(l)),Mg(this),$c(this,a,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){let e=this,t=this.selectedLayer.layer,r=++this.generation,i=0,a=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){let{items:d}=e,p=0;for(let y of e.layerManager.managedLayers)y.archived||++p;let m=`${(p+1).toString().length}ch`;for(let y of e.layerManager.managedLayers){y.visible?++i:y.archived?++o:++a;let v=d.get(y);v===void 0&&(v=e.registerDisposer(new lV(e,y)),d.set(y,v)),v.generation=r;let{nonArchivedLayerIndex:b}=y;v.numberElement.style.width=m,b===-1?v.numberElement.style.visibility="hidden":(v.numberElement.style.visibility="",v.numberElement.textContent=`${b+1}`),v.element.dataset.selected=(y===t).toString(),v.element.dataset.archived=y.archived.toString(),yield v.element}for(let[y,v]of d)r!==v.generation&&(d.delete(y),e.unregisterDisposer(v),v.dispose());yield e.layerDropZone}In(this.itemContainer,l());let c="Layers";if(i||a||o){c+=" (";let d="";i+a&&(c+=`${i}/${a+i} visible`,d=", "),o&&(c+=`${d}${o} archived`),c+=")"}this.titleElement.textContent=c}},vw=class extends ${constructor(e){super();this.layerManager=e;this.element=document.createElement("div");let t=this.registerCancellable(Be(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0,{managedLayers:t}=this.layerManager;for(let i of t)i.archived&&++e;let{element:r}=this;if(e!==0){let i=t.length;r.textContent=`${i-e}/${i}`}else r.textContent=""}};var $Ae=rt(dV()),jAe=rt(Sw()),JAe=rt(gV()),qAe=rt(SV());var bw=rt(is()),bV=rt(Dt());var Ij=100,xw=class extends Wi{constructor(e){super();this.viewer=e;this.parsedValue=null;this.debouncedValueUpdater=(0,bV.default)(()=>{let e=this.textEditor.getValue();try{let t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(t){this.parsedValue=null,this.applyButton.disabled=!0;let r=0,i=0,a="Unknown parse error";if(t instanceof Error){let o=t.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(o!==null){a=o[1];let l=parseInt(o[2],10),d=e.substring(0,l).split(`
`);r=d.length-1,i=d[d.length-1].length}else a=t.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:a,severity:"error",from:bw.default.Pos(r,i)}]})}},Ij);this.content.classList.add("neuroglancer-state-editor");let t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;let r=this.closeButton=document.createElement("button");r.classList.add("close-button"),r.textContent="Close",this.content.appendChild(r),r.addEventListener("click",()=>this.dispose()),this.textEditor=(0,bw.default)(i=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return JSON.stringify(Qs(this.viewer.state).value,null,"  ")}};var xV=rt(Dt());var Aj={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1},Cw=class{constructor(){this.location=new Jn(Aj)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return wi(this.location.toJSON())}};function Mj(n){let e=new Map;function t(r,i){if(typeof r!="object"){e.set(i,""+r);return}for(let a of Object.keys(r))t(r[a],i+"."+a)}return t(n,""),e}function Rj(n){let e=new Set;e.add(".type");let t=new Set;function r(i,a){for(let o of e)if(n[i].get(o)!==n[a].get(o))return!0;return!1}for(let i=0,a=n.length;i<a;++i){for(let l of n[i].keys())t.add(l);let o=[];for(let l=0;l<i;++l)r(i,l)||o.push(l);for(;o.length>0;){let l=o,c;for(let d of t){if(e.has(d))continue;let p=[];for(let m of o)n[m].get(d)===n[i].get(d)&&p.push(m);if(p.length<l.length&&(l=p,c=d),p.length===0)break}if(c===void 0)break;o=l,e.add(c)}}return Array.from(e)}function _j(n,e){let t={};for(let r of e){let i=n.get(r);if(i!==void 0){if(r==="")return i;t[r]=i}}return JSON.stringify(t)}function Vj(n){return Object.assign({type:n.RPC_TYPE_ID},n.key||{})}function Oj(n){let e=n.map(Mj),t=Rj(e);return e.map(r=>_j(r,t))}var Nj=1e3,ww=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:n=>{let e=0;for(let t=0;t<dh;++t)e+=n[No(t,da.VISIBLE)*fa+pa.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:n=>n[No(Qe.DOWNLOADING,da.VISIBLE)*fa+pa.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:n=>n[No(Qe.SYSTEM_MEMORY,da.VISIBLE)*fa+pa.numChunks]+n[No(Qe.SYSTEM_MEMORY_WORKER,da.VISIBLE)*fa+pa.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:n=>n[No(Qe.GPU_MEMORY,da.VISIBLE)*fa+pa.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:n=>n[No(Qe.FAILED,da.VISIBLE)*fa+pa.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:n=>n[No(Qe.GPU_MEMORY,da.VISIBLE)*fa+pa.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:n=>n[dS(ud.totalTime)]/n[dS(ud.totalChunks)]}],Tw=class extends Ar{constructor(e,t,r){super(e,r.location);this.chunkQueueManager=t;this.displayState=r;this.data=void 0;this.requestDataTimerId=-1;this.dataRequested=!1;this.body=document.createElement("div");this.debouncedUpdateView=this.registerCancellable((0,xV.default)(()=>this.updateView(),0));let{body:i}=this;i.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(i),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;let{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},Nj)})}updateView(){let{data:e}=this;if(e===void 0)return;let t=document.createElement("table"),r=[];for(let[l,c]of e){let d=[l];for(let{getter:p}of ww)d.push(p(c));r.push(d)}let i=Oj(r.map(l=>Vj(l[0]))),a=new Map;i.forEach((l,c)=>{a.set(r[c][0],l)});{let l=document.createElement("thead"),c=document.createElement("tr");l.appendChild(c);let d=m=>{let y=document.createElement("td");y.textContent=m,c.appendChild(y)};d("Name");let p;for(let{label:m}of ww){let y=m.indexOf("/"),v=m;if(y!==-1){if(v=m.substring(0,y),v===p){++c.lastElementChild.colSpan;continue}p=v}d(v)}c=document.createElement("tr"),l.appendChild(c);{let m=document.createElement("td");c.appendChild(m)}for(let{label:m}of ww){let y=m.indexOf("/"),v="";y!==-1&&(v=m.substring(y+1));let b=document.createElement("td");b.textContent=v,c.appendChild(b)}t.appendChild(l)}let o=document.createElement("tbody");for(let[l,...c]of r){let d=document.createElement("tr"),p=m=>{let y=document.createElement("td");y.textContent=m,d.appendChild(y)};p(a.get(l));for(let m of c)p(""+m);o.appendChild(d)}t.appendChild(o),Me(this.body),this.body.appendChild(t)}};var Lw=class extends ${constructor(e,t={}){super();this.model=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");let{validator:r,label:i}=t,{element:a,inputElement:o}=this;r===void 0&&(e instanceof ct?r=e.validator:r=l=>l),this.validator=r,i!==void 0&&(a.textContent=i),a.appendChild(o),a.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){Ye(this.element),super.disposed()}};var Bj={...ui,side:"left",row:2},kw=class{constructor(){this.location=new Jn(Bj)}get changed(){return this.location.changed}toJSON(){return wi(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},Ew=class extends Ar{constructor(e,t,r){super(e,t.location);this.addTitleBar({title:"Settings"});let i=document.createElement("div");i.classList.add("neuroglancer-settings-body");let a=document.createElement("div");a.classList.add("neuroglancer-settings-scroll-container"),i.appendChild(a),this.addBody(i);{let d=this.registerDisposer(new yp(r.title));d.element.placeholder="Title",d.element.classList.add("neuroglancer-settings-title"),a.appendChild(d.element)}let o=(d,p)=>{let m=this.registerDisposer(new Lw(p,{label:d}));m.element.classList.add("neuroglancer-settings-limit-widget"),a.appendChild(m.element)};o("GPU memory limit",r.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",r.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",r.chunkQueueManager.capacities.download.itemLimit);let l=(d,p)=>{let m=document.createElement("label");m.textContent=d;let y=this.registerDisposer(new pr(p));m.appendChild(y.element),a.appendChild(m)};l("Show axis lines",r.showAxisLines),l("Show scale bar",r.showScaleBar),l("Show cross sections in 3-d",r.showPerspectiveSliceViews),l("Show default annotations",r.showDefaultAnnotations),l("Show chunk statistics",r.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",r.wireFrame),l("Enable prefetching",r.chunkQueueManager.enablePrefetch);let c=(d,p)=>{let m=document.createElement("label");m.textContent=d;let y=this.registerDisposer(new hl(p));m.appendChild(y.element),a.appendChild(m)};c("Cross-section background",r.crossSectionBackgroundColor),c("Projection background",r.perspectiveViewBackgroundColor)}};var Dw=class extends ${constructor(e,t){super();this.selectedLayer=e;this.toolBinder=t;this.element=document.createElement("div");this.viewContext=void 0;this.updateView=this.registerCancellable(Be(()=>{let{viewContext:e}=this;e!==void 0&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new $),Me(this.element);let{selectedTool:t}=this;t!==void 0&&this.element.appendChild(this.makeWidget(e,t));let r=Array.from(this.toolBinder.bindings);r.sort(([i],[a])=>Qa(i,a));for(let[,i]of r)this.element.appendChild(this.makeWidget(e,i))}));let{element:r}=this;r.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){let e=this.selectedLayer.layer;if(e===void 0)return;let t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let{unbindPreviousLayer:e}=this;e!==void 0&&e();let t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){let{unbindPreviousLayer:e}=this;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){let r=document.createElement("div");r.title="dblclick \u2192 unbind",t instanceof ao&&(r.title+=", click \u2192 bind key"),r.className="neuroglancer-annotation-tool-status-widget";let i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-layer-number";let{managedLayer:a}=t.layer;a.manager.rootLayers.updateNonArchivedLayerIndices();let o=a.nonArchivedLayerIndex;i.textContent=(o+1).toString();let l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,r.addEventListener("dblclick",()=>{t instanceof rp?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof ao){let c=document.createElement("div");c.className="neuroglancer-annotation-tool-status-widget-key",c.textContent=t.keyBinding,r.appendChild(c),hx(e,r,d=>t.layer.toolBinder.set(d,t.addRef()))}return r.appendChild(i),r.appendChild(l),r}};var wV=class extends ${constructor(e,t,r=""){super();this.gl=e;this.frameNumberCounter=t;let i=r+"chunk_worker.bundle.js";this.worker=new Worker(i),this.chunkQueueManager=this.registerDisposer(new dd(new Wv(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new uc({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new uc({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new uc({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new uc({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new pd(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}};var TV=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],LV=[...TV,"showLayerPanel","showLayerHoverValues"],kV=[...LV,"showUIControls","showPanelBorders"];function Fj(){return Object.fromEntries(kV.map(n=>[n,new mt(!0)]))}function Uj(n,e){for(let t of kV){let r=e[t];r!==void 0&&(n[t].value=r)}}var Wj=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS!="undefined"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0},EV=class extends $o{constructor(e){super();this.viewer=e;this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){let{viewer:t}=this;super.restoreState(e),de(e,"navigation",r=>{Z(r),de(r,"pose",i=>{Z(i),de(i,"position",a=>{Z(a),nn(a,"voxelCoordinates",t.position),de(a,"voxelSize",o=>{let l=$e(new Float64Array(3),o,dt);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=Ve({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),nn(i,"orientation",t.crossSectionOrientation)}),nn(r,"zoomFactor",t.crossSectionScale.legacyJsonView)}),nn(e,"perspectiveOrientation",t.projectionOrientation),nn(e,"perspectiveZoom",t.projectionScale.legacyJsonView),nn(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}},Pw=class extends ${constructor(e,t={}){super();this.display=e;this.title=new ct(void 0,ne);this.coordinateSpace=new Ms;this.position=this.registerDisposer(new Bi(this.coordinateSpace));this.relativeDisplayScales=this.registerDisposer(new _m(this.coordinateSpace));this.displayDimensions=this.registerDisposer(new Vm(this.coordinateSpace));this.displayDimensionRenderInfo=this.registerDisposer(new Zd(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef()));this.crossSectionOrientation=this.registerDisposer(new io);this.crossSectionScale=this.registerDisposer(new Xb(this.displayDimensionRenderInfo.addRef()));this.projectionOrientation=this.registerDisposer(new io);this.crossSectionDepthRange=this.registerDisposer(new ep(-10,this.displayDimensionRenderInfo));this.projectionDepthRange=this.registerDisposer(new ep(-50,this.displayDimensionRenderInfo));this.projectionScale=this.registerDisposer(new Qb(this.displayDimensionRenderInfo.addRef()));this.navigationState=this.registerDisposer(new Ta(new wa(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef()));this.perspectiveNavigationState=this.registerDisposer(new Ta(new wa(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef()));this.mouseState=new yx;this.layerManager=this.registerDisposer(new zm);this.selectedLayer=this.registerDisposer(new xx(this.layerManager.addRef()));this.showAxisLines=new mt(!0,!0);this.wireFrame=new mt(!1,!1);this.showScaleBar=new mt(!0,!0);this.showPerspectiveSliceViews=new mt(!0,!0);this.visibleLayerRoles=O1();this.showDefaultAnnotations=new mt(!0,!0);this.crossSectionBackgroundColor=new Lo(K.fromValues(.5,.5,.5));this.perspectiveViewBackgroundColor=new Lo(K.fromValues(0,0,0));this.scaleBarOptions=new YC;this.partialViewport=new Sv;this.statisticsDisplayState=new Cw;this.helpPanelState=new iw;this.settingsPanelState=new kw;this.layerSelectedValues=this.registerDisposer(new vx(this.layerManager,this.mouseState));this.selectionDetailsState=this.registerDisposer(new bx(this.coordinateSpace,this.layerSelectedValues));this.selectedStateServer=new ct("",ne);this.layerListPanelState=new gw;this.toolBinder=this.registerDisposer(new px);this.resetInitiated=new ae;this.uiControlVisibility={};this.visible=!0;this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))};let{dataContext:r=new wV(e.gl,e,t.bundleRoot),visibility:i=new kt(kt.VISIBLE),inputEventBindings:a={global:new _e,sliceView:new _e,perspectiveView:new _e},element:o=e.makeCanvasOverlayElement(),dataSourceProvider:l=fP({credentialsManager:Qn}),uiConfiguration:c=Fj()}=t;this.visibility=i,this.inputEventBindings=a,this.element=o,this.dataSourceProvider=l,this.uiConfiguration=c,this.registerDisposer(Fr(v=>{this.display.applyWindowedViewportToElement(o,v)},this.partialViewport)),this.registerDisposer(()=>Ye(this.element)),this.dataContext=this.registerDisposer(r),Uj(c,t);let d={...Wj,...t},{resetStateWhenEmpty:p,showLayerDialog:m}=d;for(let v of LV)this.uiControlVisibility[v]=this.makeUiControlVisibilityState(v);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=m,this.resetStateWhenEmpty=p,this.layerSpecification=new Lx(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(jn.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(jn.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));let y=this.registerCancellable((0,CV.default)(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!Ym&&this.showLayerDialog&&this.visibility.visible&&qm(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(y),y(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(Rg(o,this.navigationState.position)),this.state=new EV(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}makeUiControlVisibilityState(e){let t=this.uiConfiguration.showUIControls,r=this.uiConfiguration[e];return this.registerDisposer(Vy((i,a)=>i&&a,t,r))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){let{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){let e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";let t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";let r=this.registerDisposer(new as(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new $n(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element);let i=this.registerDisposer(new dC(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(i.element.style.flex="1",i.element.style.alignSelf="center",this.registerDisposer(new $n(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element),typeof NEUROGLANCER_CREDIT_LINK!="undefined"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(let{url:c,text:d}of l){let p=document.createElement("a");p.style.marginRight="5px",p.href=c,p.textContent=d,p.style.fontFamily="sans-serif",p.style.color="yellow",p.target="_blank",t.appendChild(p)}}let a=this.registerDisposer(new Dw(this.selectedLayer,this.toolBinder));if(t.appendChild(a.element),this.registerDisposer(new $n(this.uiControlVisibility.showAnnotationToolStatus,a.element)),W2){let l=this.registerDisposer(new rw(this));t.appendChild(l.element)}{let{layerListPanelState:l}=this,c=this.registerDisposer(new qn(l.location.watchableVisible,{svg:f2,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new vw(this.layerManager)).element),this.registerDisposer(new $n(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{let{selectionDetailsState:l}=this,c=this.registerDisposer(new qn(l.location.watchableVisible,{svg:h2,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new $n(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{let{selectedLayer:l}=this,c=this.registerDisposer(new qn({get value(){return l.visible},set value(d){l.visible=d},changed:l.location.locationChanged},{svg:kg,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new $n(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{let l=je({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new $n(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{let{helpPanelState:l}=this,c=this.registerDisposer(new qn(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new $n(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{let{settingsPanelState:l}=this,c=this.registerDisposer(new qn(l.location.watchableVisible,{svg:m2,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new $n(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new $n(Vy((...l)=>l.reduce((c,d)=>c||d,!1),...TV.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new hw(this,"4panel")),this.sidePanelManager=this.registerDisposer(new BS(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new yw(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new mw(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new US(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new Tw(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{let{inputEventBindings:l}=this;return new aw(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new Ew(this.sidePanelManager,this.settingsPanelState,this)}));let o=()=>{let l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){let{element:e}=this;this.registerDisposer(new Gt(e,this.inputEventMap)),this.registerDisposer(new oo(e))}bindAction(e,t){this.registerDisposer(le(this.element,e,t))}registerActionListeners(){for(let e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e)});for(let e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){let t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{let e=this.selectedLayer.layer;if(e===void 0){Ee.showTemporaryMessage("The annotate command requires a layer to be selected.");return}let t=e.layer;if(t===null||t.tool.value===void 0){Ee.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e,this.toolInputEventMapBinder)}editJsonState(){new xw(this)}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let{chunkQueueManager:e}=this.dataContext;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}};function DV(n,e=document.getElementById("neuroglancer-container")){try{let t=new bv(e);return new Pw(t,n)}catch(t){throw Ee.showMessage(`Error: ${t.message}`),t}}function PV(n){return i2(),a2(),DV(n)}function IV(n){let e=Be(()=>{var i;let r=(i=n.value)==null?void 0:i.trim();r?document.title=`${r} - neuroglancer`:document.title="neuroglancer"}),t=n.changed.add(e);return e(),e.flush(),()=>{t(),e.cancel()}}var AV=rt(Dt());function Gj(n){return encodeURI(n).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}var Iw=class extends ${constructor(e,t,r={}){super();this.root=e;this.credentialsManager=t;this.parseError=new Ae(void 0);let{updateDelayMilliseconds:i=200,defaultFragment:a="{}"}=r;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());let o=(0,AV.default)(()=>this.setUrlHash(),i);this.registerDisposer(e.changed.add(o)),this.registerDisposer(()=>o.cancel()),this.defaultFragment=a}setUrlHash(){let e=Qs(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let r=Gj(JSON.stringify(e.value));r!==this.prevStateString&&(this.prevStateString=r,decodeURIComponent(r)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+r))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((e===""||e==="#"||e==="#!")&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){let t=e.substring(2),{url:r,credentialsProvider:i}=Zn(t,this.credentialsManager);Ee.forPromise(Ni(i,r,{},St).then(a=>{Z(a),this.root.reset(),this.root.restoreState(a)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);let t=Pf(e);Z(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),e=decodeURIComponent(e),e===this.prevStateString)return;this.prevStateString=e,this.root.reset();let t=Pf(e);Z(t),this.root.restoreState(t)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}};function MV(){let n=window.viewer=PV();vD(n.inputEventBindings);let e=n.registerDisposer(new Iw(n.state,n.dataSourceProvider.credentialsManager,{defaultFragment:typeof NEUROGLANCER_DEFAULT_STATE_FRAGMENT!="undefined"?NEUROGLANCER_DEFAULT_STATE_FRAGMENT:void 0}));return n.registerDisposer(e.parseError.changed.add(()=>{let{value:t}=e.parseError;t!==void 0&&(new Ee().setErrorMessage(`Error parsing state: ${t.message}`),console.log("Error parsing state",t)),e.parseError})),e.updateFromUrlHash(),n.registerDisposer(IV(n.title)),n2(n),r2(n),n}window.addEventListener("DOMContentLoaded",()=>{MV()});})();
/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017-2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
//# sourceMappingURL=main.bundle.js.map
